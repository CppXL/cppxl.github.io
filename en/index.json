[{"uri":"https://www.ch35tnut.site/en/research/","title":"å®‰å…¨ç ”ç©¶","tags":[],"description":"","content":"å®‰å…¨ç ”ç©¶ "},{"uri":"https://www.ch35tnut.site/en/vulnerability/","title":"vulneribility analysis","tags":[],"description":"","content":"æ¼æ´åˆ†æ åºå· æ¼æ´å ç¼–å· ç±»å‹ 1 windows æƒé™æå‡æ¼æ´ CVE-2021-40449 æƒé™æå‡ "},{"uri":"https://www.ch35tnut.site/en/","title":"index","tags":[],"description":"","content":"å­¦ä¹ è®°å½• è®°å½•ä¸€äº›å¹³æ—¶å­¦ä¹ å’Œç”Ÿæ´»çš„æ—¥å¸¸ã€‚\n09-13è‡³09-16\r| 488 days ago\rè¿™å‘¨å†å†™ä¸€ä¸ªåŸºäºrustçš„loaderï¼Œå†™äº†ä¸€åŠå‘ç°åŠ è½½çš„dllå¤ªå¤šäº†ï¼Œå†æƒ³åŠæ³•ç”¨åŠ¨æ€åŠ è½½çš„æ–¹å¼åŠ è½½dllï¼Œæ„Ÿè§‰ç”¨ruståšæœ‰ç‚¹éš¾ã€‚\nç”¨rustçš„å†…è”æ±‡ç¼–è·å–åˆ°äº†kernel32.dllå’Œntdll.dllçš„åŸºå€ï¼Œè¿˜è¦ç»§ç»­å®Œå–„ã€‚\n2022\r09-10è‡³09-12\r2 days | 491 days ago\rä¸­ç§‹èŠ‚ï¼Œåœ¨å®¶æ‘¸äº†å‡ å¤©ğŸŸï¼Œå•¥éƒ½æ²¡å¹²\n2022\r09-05è‡³09-09\r4 days | 496 days ago\rè¿™å‘¨ç¼–è¯‘äº†wireshark 1.8.5ï¼Œé€šè¿‡diff1.8.5å’Œ1.8.6çš„æºç æ‰¾å‡º1.8.5é‡Œé¢çš„æ¼æ´ï¼Œè§\rwireshark 1.8.5ä»£ç å®¡è®¡\n2022\r09-03è‡³09-04\r1 day | 498 days ago\rè¿™ä¸¤å¤©ï¼Œç»™hugoä¸»é¢˜å¢åŠ äº†timelineçš„shortcodeï¼Œè§\rå¢åŠ timelineåŠŸèƒ½\n2022\r08-29è‡³09-02\r4 days | 503 days ago\rå‘¨å†…çœ‹äº†ä¸€ä¸ªå‡ ç™¾è¡Œçš„ä»£ç ï¼Œè§\rnews_serverå®¡è®¡\n2022\r"},{"uri":"https://www.ch35tnut.site/en/dailylife/","title":"lifetime","tags":[],"description":"","content":"Daily Life article "},{"uri":"https://www.ch35tnut.site/en/misc/","title":"æ‚é¡¹","tags":[],"description":"","content":"æ‚é¡¹ æš‚æ— \n"},{"uri":"https://www.ch35tnut.site/en/others/","title":"å…¶ä»–","tags":[],"description":"","content":"å…¶ä»– "},{"uri":"https://www.ch35tnut.site/en/others/add-timeline-shortcode/","title":"ç»™hugo-theme-learnå¢åŠ timelineåŠŸèƒ½","tags":[],"description":"","content":"å‰è¨€ ç°åœ¨ä½¿ç”¨hugo-theme-learnä¸»é¢˜ï¼Œä½†è¿™ä¸ªä¸»é¢˜æ²¡æœ‰æä¾›æ—¶é—´çº¿åŠŸèƒ½ï¼Œä¸ºäº†ç»™é¦–é¡µå¢åŠ æ—¶é—´çº¿åŠŸèƒ½ï¼ŒèŠ±äº†ä¸¤å¤©ç ”ç©¶äº†ä¸€ä¸‹æ€ä¹ˆæ·»åŠ æ—¶é—´çº¿åŠŸèƒ½ã€‚\nä¸ºäº†æ–¹ä¾¿å¢åŠ æ—¶é—´çº¿çš„äº‹ä»¶ï¼Œé‡‡ç”¨è‡ªå®šä¹‰shortcodeçš„æ–¹å¼å¢åŠ æ—¶é—´çº¿ï¼Œä»£ç å¤§éƒ¨åˆ†å‚è€ƒå¼•ç”¨é“¾æ¥é‡Œé¢çš„ï¼Œé­”æ”¹äº†ä¸€ä¸‹ä»¥é€‚åº”è‡ªå·±çš„ä¸»é¢˜ï¼Œå¢åŠ äº†è¿‡å»å¤šå°‘å¤©çš„æ˜¾ç¤ºã€‚\nä»£ç å®ç° åœ¨layout/shortcodesæ–°å¢æ–‡ä»¶ï¼ševent.htmlå’Œtimeline.htmlï¼Œå†…å®¹åˆ†åˆ«å¦‚ä¸‹\nevent.html {{$duration := \u0026#34;\u0026#34;}} {{$to := now }} {{ if ne (.Get \u0026#34;to\u0026#34;) \u0026#34;\u0026#34;}} {{$to = time (.Get \u0026#34;to\u0026#34;) }} {{end}} {{$enabledTime := ne (.Get \u0026#34;from\u0026#34;) \u0026#34;\u0026#34;}} {{if $enabledTime }} {{$from := time (.Get \u0026#34;from\u0026#34;) }} {{ $diff := $to.Sub $from }} {{ $days := div $diff.Hours 24 | math.Round }} {{$tmonths:=mul ($to.Sub $from).Hours 0.00136986301 }} {{$months := mod $tmonths 12 }} {{$years := math.Floor (div $tmonths 12)}} {{$yearStr := \u0026#34;years\u0026#34;}} {{if lt $years 2 }} {{$yearStr = \u0026#34;year\u0026#34;}} {{end}} {{$monthStr := \u0026#34;months\u0026#34;}} {{if lt $months 2 }} {{$monthStr = \u0026#34;month\u0026#34;}} {{end}} {{$daysStr := \u0026#34;days\u0026#34;}} {{ $idays :=int $days }} {{$duration = \u0026#34;\u0026#34;}} {{if gt $years 0 }} {{$duration = printf \u0026#34;%s %.0f %s\u0026#34; $duration $years $yearStr}} {{$idays = sub $idays (mul 365 $years)}} {{end}} {{if gt $months 0 }} {{$duration = printf \u0026#34;%s %d %s\u0026#34; $duration $months $monthStr}} {{$idays = sub $idays (mul 30 $months)}} {{end}} {{$idays = int $idays}} {{if gt $idays 0}} {{if lt $idays 2}} {{$daysStr = \u0026#34;day\u0026#34;}} {{end}} {{$duration = printf \u0026#34;%s %d %s\u0026#34; $duration $idays $daysStr}} {{end}} {{end}} {{ $from := .Get \u0026#34;from\u0026#34; | time }} {{ $to := now }} {{ $diff := $to.Sub $from }} {{ $ago := div $diff.Hours 24 | math.Round }} {{ $measure := cond (eq 1 $ago) \u0026#34;day\u0026#34; \u0026#34;days\u0026#34; }} {{ $seed := \u0026#34;foo\u0026#34; }} {{ $random := delimit (shuffle (split (md5 $seed) \u0026#34;\u0026#34; )) \u0026#34;\u0026#34; }} \u0026lt;div class=\u0026#34;container\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;content\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;title\u0026#34;\u0026gt;{{.Get \u0026#34;title\u0026#34;}}\u0026lt;/div\u0026gt; {{if $enabledTime }} \u0026lt;div class=\u0026#34;moment\u0026#34; {{ if eq .Ordinal 0 }} id=\u0026#34;moment\u0026#34; {{ end }} {{ if ne .Ordinal 0 }}id=\u0026#34;moment-{{ substr $random 0 16}}\u0026#34;{{end}}\u0026gt; {{ if ne .Ordinal 0 }} {{$duration}} {{ end }} | {{ $ago }} {{ $measure}} ago \u0026lt;/div\u0026gt; {{ end }} \u0026lt;div class=\u0026#34;body\u0026#34;\u0026gt; {{.Inner}} \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;date\u0026#34;\u0026gt;{{$to.Year}}\u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; {{ if and (eq (.Ordinal) 0) $enabledTime }} \u0026lt;script\u0026gt; function non0plural(number, name) { if (number == 0) { return \u0026#34;\u0026#34; } if (number \u0026gt; 1) { return number + \u0026#34; \u0026#34; + name + \u0026#34;s\u0026#34; } return number + \u0026#34; \u0026#34; + name } function refresh() { start = dayjs({{.Get \u0026#34;from\u0026#34;}}) now = dayjs() total_days = now.diff(start,\u0026#34;d\u0026#34;,true) total_months = now.diff(start, \u0026#34;M\u0026#34;, true) months = total_months % 12 years = Math.floor((total_months) / 12) // for (var i = 0, els = document.querySelectorAll(`[id^=\u0026#34;moment\u0026#34;]`); i \u0026lt; els.length; i++) { // els[i].innerHTML = non0plural(years, \u0026#34;year\u0026#34;) + \u0026#34; \u0026#34; + non0plural(months.toFixed(8), \u0026#34;month\u0026#34;) // } // å¦‚æœæœˆä»½å¤§äº1åˆ™ if(years\u0026gt;=1){ total_days-=365*years } if(months\u0026gt;=1){ total_days-=30*months } el = document.querySelector(\u0026#34;#moment\u0026#34;); el.innerHTML = years\u0026gt;1? non0plural(years, \u0026#34;year\u0026#34;):\u0026#34;\u0026#34; + \u0026#34; \u0026#34; + months\u0026gt;1? non0plural(months.toFixed(4), \u0026#34;month\u0026#34;):\u0026#34;\u0026#34; + total_days\u0026gt;=1?non0plural(total_days.toFixed(2),\u0026#34;day\u0026#34;):\u0026#34;\u0026#34; el.innerHTML = el.innerHTML + \u0026#34; ago\u0026#34; } window.setInterval(refresh, 100); \u0026lt;/script\u0026gt; {{ end }} timeline.html \u0026lt;style type=\u0026#34;text/css\u0026#34;\u0026gt; .timeline { position: relative; margin: 0 auto; } /* The actual timeline (the vertical ruler) */ .timeline::after { content: \u0026#34;\u0026#34;; position: absolute; width: 6px; background-color: #444; top: 0; bottom: 0; left: 10%; margin-left: -3px; } /* Container around content */ .timeline .container { padding: 10px 10px 10px 40px; margin-top: 10px; position: relative; /* background-color: gray; */ width: 90%; left: 10%; } /* The circles on the timeline */ .timeline .container::after { content: \u0026#34;\u0026#34;; position: absolute; width: 25px; height: 25px; left: -12px; background-color: rgb(106, 215, 229); border: 4px solid #444; top: 0px; border-radius: 50%; z-index: 1; } /* date display */ .timeline .container .date { position: absolute; top: 0px; z-index: 1; left: -15%; font-size: large; } /* Add arrows to the right container (pointing left) */ .timeline .container::before { content: \u0026#34; \u0026#34;; height: 0; position: absolute; top: 30px; width: 0; z-index: 1; left: 26px; border: medium solid #6ad7e5; border-width: 13px 13px 13px 0px; border-color: #6ad7e5 #6ad7e5 transparent transparent; } /* The actual content */ .timeline .content { box-shadow: 0 0 3px 3px #6ad7e5; background-color: white; position: relative; border-radius: 6px; transition: box-shadow 0.3s; } /* small shadow change on hover*/ .timeline .content:hover { box-shadow: 0 0 3px 4px #6ad7e5; } /* card title format */ .timeline .content .title { padding: 5px 30px; font-weight: bold; display: inline-block; } /* time moment format*/ .timeline .content .moment { color: #c41a16; text-align: right; position: absolute; top: 0; right: 0; padding: 5px; } /* body size */ .timeline .content .body { padding: 5px 30px; word-wrap: break-word; /* height: 73px; */ /* max-height: 120px; */ text-overflow: ellipsis; overflow: hidden; } /* responsive for small devices*/ @media screen and (max-width: 600px) { .timeline .container { padding: 10px 10px 0px 40px; left: 5%; width: 95%; } .timeline .container .date { font-size: small; transform: rotate(-90deg); left: -5%; top: 30px; } .timeline .container::after { left: 3px; } .timeline .content .body { padding: 5px 5px; } .timeline .content .moment { position: relative; } } \u0026lt;/style\u0026gt; \u0026lt;div class=\u0026#34;timeline\u0026#34;\u0026gt; {{ .Inner }} \u0026lt;/div\u0026gt; ç”±äºevent.htmlé‡Œé¢å¼•ç”¨äº†dayjsï¼Œè¿™ä¸ªjsä¸åœ¨å½“å‰ä¸»é¢˜å†…ï¼Œå¯ä»¥åœ¨config.tomlæ–°å¢custom_js = [\u0026quot;js/dayjs.min.js\u0026quot;]ï¼Œç„¶åæŠŠdayjs.min.jsæ”¾åœ¨theme\\hugo-theme-learn\\static\\jsç›®å½•å†…ï¼Œå³å¯è§£å†³å¯¼å…¥dayjsçš„é—®é¢˜ã€‚\næ­¤æ—¶å¯ä»¥åœ¨éœ€è¦æ·»åŠ æ—¶é—´çº¿çš„åœ°æ–¹ä½¿ç”¨timelineçš„shortcodeæ·»åŠ ï¼Œä»¥ä¸‹æ˜¯æˆ‘åšå®¢é¦–é¡µçš„æ—¶é—´çº¿ä»£ç ï¼š\n{{\u0026lt; timeline \u0026gt;}} {{% event title=\u0026#34;09-03è‡³09-04\u0026#34; from=\u0026#34;2022-09-03\u0026#34; to=\u0026#34;2022-09-04\u0026#34; %}} è¿™ä¸¤å¤©ï¼Œç»™hugoä¸»é¢˜å¢åŠ äº†timelineçš„shortcodeï¼Œè§[å¢åŠ timelineåŠŸèƒ½](others/add-timeline-shortcode) {{% /event %}} {{% event title=\u0026#34;08-29è‡³09-02\u0026#34; from=\u0026#34;2022-08-29\u0026#34; to=\u0026#34;2022-09-02\u0026#34; %}} å‘¨å†…å®¡è®¡äº†ä»£ç  {{% /event %}} {{\u0026lt; /timeline \u0026gt;}} é™¤äº†è¿™ä¸ªè¿˜é¡ºä¾¿ç»™åšå®¢æ–°å¢äº†åŸºäºGithub issueçš„è¯„è®ºåŠŸèƒ½ï¼Œå‚è€ƒ\rutterancã€‚\nå‚è€ƒ\nhttps://metalblueberry.github.io/post/howto/2021-02-28_hugo_timeline_shortcode/\n"},{"uri":"https://www.ch35tnut.site/en/about/","title":"å…³äºæˆ‘","tags":[],"description":"","content":"å…³äºæˆ‘ 21å¹´æ¯•ä¸šï¼Œç›®å‰åœ¨æŸå®‰å…¨å‚å•†å·¥ä½œï¼Œä¸»è¦ç ”ç©¶äºŒè¿›åˆ¶ã€‚\né»‘å®¢ç²¾ç¥ï¼šOpen, Share, Free\n"},{"uri":"https://www.ch35tnut.site/en/others/how-to-reset-password-administrator-on-windows-server-2019/","title":"åœ¨Windows server 2019ä¸Šé‡ç½®å¯†ç ","tags":[],"description":"","content":"é‡ç½®windows server 2019çš„administratorå¯†ç  ä¹‹å‰åœ¨Vmwareä¸Šçš„Windows server 2019çš„Administratorå¯†ç å¿˜è®°äº†ï¼Œä½¿ç”¨ç½‘ä¸Šçš„æ–¹æ³•æ—¶æ‰¾ä¸åˆ°ç”¨PEå¯åŠ¨ç³»ç»Ÿçš„åŠæ³•ï¼Œæ— å¥ˆåªèƒ½ä½¿ç”¨å…¶ä»–åŠæ³•ã€‚å†™æ­¤æ–‡è®°å½•ä¸€ä¸‹ã€‚\nè®¾ç½®CD/DVD é¦–å…ˆåœ¨è™šæ‹Ÿæœº-è®¾ç½®çš„ç¡¬ä»¶é€‰é¡¹å¡ä¸‹é¢çš„CD/DVDè®¾ç½®ä¸ºä½¿ç”¨ISOæ˜ åƒæ–‡ä»¶å¹¶æ‰¾åˆ°windows server 2019é•œåƒä½ç½®ï¼Œå¦‚ä¸‹å›¾\nä¹‹åé€‰æ‹©è™šæ‹Ÿæœº-ç”µæº-å¼€æœºæ—¶æ‰“å¼€å›ºä»¶å¯åŠ¨è™šæ‹Ÿæœºï¼Œè™šæ‹Ÿæœºå°±ä¼šè¿›å…¥BIOSï¼Œåœ¨BIOSé‡Œé€‰æ‹©CD/DVDå¯åŠ¨ï¼Œå³ä¼šè¿›å…¥ä¸‹å›¾ã€‚\nå‚è€ƒé“¾æ¥\nhttps://www.osradar.com/how-to-reset-password-administrator-on-windows-server-2019/\n"},{"uri":"https://www.ch35tnut.site/en/vulnerability/cve-2021-40449-win32k-eop/","title":"CVE-2021-40449 win32k æƒé™æå‡æ¼æ´åˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"CVE-2021-40449 Win32kææƒæ¼æ´åŠPOCåˆ†æ èƒŒæ™¯ CVE-2021-40449æ˜¯å¡å·´æ–¯åŸºå®éªŒå®¤åœ¨2021å¹´8æœˆä¸‹æ—¬åˆ°9æœˆä¸Šæ—¬åœ¨WindowsæœåŠ¡å™¨ä¸Šæ•è·çš„æ¶æ„æ ·æœ¬åˆ©ç”¨çš„ææƒæ¼æ´ï¼Œè¯¥æ¼æ´å­˜åœ¨äºwin32kfull.sysé©±åŠ¨å†…ï¼Œåˆ©ç”¨è¯¥æ¼æ´å¯ä»¥åœ¨windowsä¸­å®Œæˆä»usersåˆ°systemçš„æƒé™æå‡ã€‚\nåŸºæœ¬æ¦‚å¿µ å†…æ ¸å¯¹è±¡ï¼šå†…æ ¸å¯¹è±¡å³åœ¨å†…æ ¸ç©ºé—´å­˜åœ¨çš„å¯¹è±¡ï¼Œåªèƒ½ç”±å†…æ ¸åˆ†é…ï¼Œå†…æ ¸è®¿é—®ã€‚\nå†…æ ¸å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼šåœ¨æ“ä½œç³»ç»Ÿä¸­ï¼Œå¯èƒ½æœ‰å¤šä¸ªè¿›ç¨‹è®¿é—®åŒä¸€ä¸ªå†…æ ¸å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰è¿›ç¨‹éœ€è¦ä½¿ç”¨è¯¥å¯¹è±¡å†…æ ¸å°±åº”è¯¥é‡Šæ”¾è¯¥å¯¹è±¡ï¼Œæ‰€ä»¥ä¸ºäº†å‡†ç¡®çš„é‡Šæ”¾è¯¥å¯¹è±¡å°±æœ‰äº†å¼•ç”¨è®¡æ•°ã€‚å½“å†…æ ¸å¯¹è±¡è¢«åˆ›å»ºæ—¶ï¼Œå¼•ç”¨è®¡æ•°è¢«æ ‡è®°ä¸º1ï¼Œè°ƒç”¨CloseHandle()æ—¶å†…æ ¸å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å°±-1ï¼Œè¿™å¯ä»¥ç±»æ¯”Java GCçš„å¼•ç”¨è®¡æ•°æ³•ï¼š\nåœ¨å¯¹è±¡ä¸­æ·»åŠ ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨ï¼Œæ¯å½“ä¸€ä¸ªåœ°æ–¹å¼•ç”¨å®ƒæ—¶ï¼Œè®¡æ•°å™¨å°±åŠ ä¸€ï¼›å½“å¼•ç”¨å¤±æ•ˆæ—¶ï¼Œè®¡æ•°å™¨å€¼å°±å‡ä¸€ï¼›ä»»ä½•æ—¶åˆ»è®¡æ•°å™¨ä¸ºé›¶çš„å¯¹è±¡å°±æ˜¯ä¸å¯èƒ½å†è¢«ä½¿ç”¨çš„ã€‚\nå¥æŸ„ï¼šç”±äºå†…æ ¸å¯¹è±¡åªèƒ½ç”±å†…æ ¸åˆ†é…ã€è®¿é—®ã€ä¿®æ”¹ï¼Œå½“ring 3å±‚çš„åº”ç”¨ç¨‹åºæƒ³è¦æ“ä½œè¿™äº›å†…æ ¸å¯¹è±¡çš„æ—¶å€™ï¼Œå¹¶ä¸èƒ½ç›´æ¥æ“æ§å†…æ ¸å¯¹è±¡ã€‚å½“å†…æ ¸å¯¹è±¡åˆ›å»ºå¥½åï¼Œæ“ä½œç³»ç»Ÿä¼šä½¿ç”¨ä¸€ä¸ªå¥æŸ„æ¥æ ‡è¯†è¯¥å¯¹è±¡å¹¶è¿”å›ç»™åº”ç”¨ç¨‹åºï¼Œåº”ç”¨ç¨‹åºé€šè¿‡æ“ä½œç³»ç»Ÿæä¾›çš„ring 3å±‚APIæ¥æ“ä½œå¥æŸ„ï¼Œring3å±‚APIç»è¿‡ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸ã€‚åœ¨å†…æ ¸å¤„å¥æŸ„å¯¹åº”ç€å…·ä½“çš„å†…æ ¸å¯¹è±¡ï¼Œè¿™æ ·ring3å±‚çš„åº”ç”¨ç¨‹åºå°±å¯ä»¥é€šè¿‡æ“ä½œå¥æŸ„æ¥é—´æ¥æ“ä½œå†…æ ¸å¯¹è±¡ã€‚\nå¥æŸ„è¡¨ï¼šå½“ä¸€ä¸ªè¿›ç¨‹åˆå§‹åŒ–çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šç»™è¯¥è¿›ç¨‹åˆ†é…ä¸€ä¸ªå¥æŸ„è¡¨ï¼Œå½“è¿›ç¨‹åˆ›å»ºå†…æ ¸å¯¹è±¡çš„æ—¶å€™ï¼Œå†…æ ¸åˆ›å»ºå¯¹åº”å†…æ ¸å¯¹è±¡ï¼Œå¹¶éå†è¯¥è¿›ç¨‹çš„å¥æŸ„è¡¨ï¼Œåœ¨å¥æŸ„è¡¨çš„ç©ºé—²ä½ç½®è®¾ç½®å†…æ ¸å¯¹è±¡ã€å¯¹è±¡æŒ‡é’ˆç­‰ï¼Œå¹¶è·å–è¯¥ä½ç½®çš„ç´¢å¼•ï¼Œä½œä¸ºè¿›ç¨‹åˆ›å»ºå¯¹è±¡çš„å‡½æ•°çš„è¿”å›å€¼ï¼Œå³ä¸ºå¥æŸ„ã€‚\nhttps://www.cnblogs.com/MisterXu/p/10846918.html\nDCï¼šæ˜¯ä¸€ä¸ªå†…æ ¸å¯¹è±¡ï¼Œå…¨ç§°device contextï¼Œè®¾å¤‡ä¸Šä¸‹æ–‡å¯¹è±¡\nHDCï¼šDCå¯¹è±¡çš„å¥æŸ„ã€‚\né‡Šæ”¾åé‡ç”¨ï¼šæŒ‡ä¸€ä¸ªå†…å­˜ç©ºé—´è¢«æ“ä½œç³»ç»Ÿé‡Šæ”¾åï¼Œå†…å­˜ç©ºé—´å˜ä¸ºç©ºé—²çŠ¶æ€ï¼Œå¦‚æœç”¨æˆ·åœ¨è¿™ä¸€åˆ»ç”³è¯·å†…å­˜ï¼Œæ“ä½œç³»ç»Ÿä¼šä¼˜å…ˆåˆ†é…åˆšé‡Šæ”¾çš„å†…å­˜ï¼Œåˆ™ç”¨æˆ·å¤§æ¦‚ç‡å¯ä»¥ç”³è¯·åˆ°åˆšåˆšé‡Šæ”¾çš„å†…å­˜å¹¶ä¿®æ”¹è¯¥å†…å­˜ç©ºé—´çš„å†…å®¹ã€‚å¦‚æœåœ¨é‡Šæ”¾ç©ºé—´ä¹‹å‰æœ‰æŒ‡é’ˆæŒ‡å‘è¯¥ç©ºé—´ï¼Œåœ¨é‡Šæ”¾ç©ºé—´ä¹‹åæŒ‡é’ˆå¹¶æœªæŒ‰ç…§ç†æƒ³çŠ¶æ€ç½®ä¸ºNULLï¼Œç”±äºé‡Šæ”¾åå¯ä»¥é‡æ–°ç”³è¯·è¯¥å†…å­˜å¹¶ä¿®æ”¹å†…å­˜å†…å®¹ï¼Œåç»­å¦‚æœç»§ç»­ä½¿ç”¨è¯¥æŒ‡é’ˆï¼Œä½†å†…å­˜å†…å†…å®¹å¹¶ä¸æ˜¯é¢„æœŸçš„é‡Šæ”¾ä¹‹å‰çš„å†…å®¹ï¼Œåˆ™ä¼šäº§ç”Ÿéé¢„æœŸè¡Œä¸ºã€‚\negï¼š\n#include \u0026lt;stdio.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; void method(); void badMethod(); // å®šä¹‰å‡½æ•°æŒ‡é’ˆ typedef void (*function)(); class test { public: function p; test() { } }; int main() { // new testå¯¹è±¡ test *t = new test(); test *p = t; t-\u0026gt;p = method; p-\u0026gt;p(); // é‡Šæ”¾tæŒ‡å‘çš„testå¯¹è±¡çš„ç©ºé—´ delete t; test *pt; for (size_t i = 0; i \u0026lt; 10000; i++) { // å ç”¨åˆšé‡Šæ”¾çš„å¯¹è±¡çš„å†…å­˜ç©ºé—´ pt = (test *)malloc(sizeof(test)); // å°†ç”³è¯·çš„ç©ºé—´å½“ä½œtestå¯¹è±¡ï¼Œå¹¶å°†å¯¹è±¡çš„å‡½æ•°æŒ‡é’ˆè®¾ç½®ä¸ºæ¶æ„å‡½æ•°åœ°å€ pt-\u0026gt;p = badMethod; } // è¿™é‡ŒåŸæ„æƒ³è¦è°ƒç”¨methodå‡½æ•°ï¼Œä½†æ˜¯å®é™…è°ƒç”¨äº†badMethodå‡½æ•° printf(\u0026#34;ç¬¬äºŒæ¬¡è°ƒç”¨\\n\u0026#34;); p-\u0026gt;p(); return 0; } void method() { printf(\u0026#34;method\\n\u0026#34;); } void badMethod() { printf(\u0026#34;bad method\\n\u0026#34;); } æ¼æ´å½¢æˆåˆ†æ è¯¥æ¼æ´äº§ç”Ÿäºwin32kfull!GreResetDCInternalå‡½æ•°ä¸­ï¼Œè¯¥å‡½æ•°å†…ä¼šè·å–DCå¯¹è±¡å†…çš„å‡½æ•°æŒ‡é’ˆï¼Œå¹¶æ‰§è¡Œè¯¥å‡½æ•°æŒ‡é’ˆæŒ‡å‘çš„å‡½æ•°ï¼Œä½†å¹¶æœªæ£€æŸ¥DCå¯¹è±¡æ˜¯å¦å¼‚å¸¸ã€‚æ‰€ä»¥å¦‚æœå¯ä»¥åœ¨è°ƒç”¨å‡½æ•°æŒ‡é’ˆä¹‹å‰é‡Šæ”¾DCå¯¹è±¡ï¼Œå¹¶é‡æ–°ç”³è¯·è¯¥å¯¹è±¡çš„å†…å­˜ç©ºé—´ï¼Œé€šè¿‡æ„é€ å†…å­˜å¸ƒå±€ï¼Œä¿®æ”¹åŸDCå¯¹è±¡çš„å‡½æ•°æŒ‡é’ˆæŒ‡å‘å…¶ä»–ä»»æ„å†…æ ¸å‡½æ•°ï¼Œå°±å¯ä»¥åœ¨win32kfull!GreResetDCInternalå†…å®ç°ä»»æ„å†…æ ¸å‡½æ•°è°ƒç”¨ã€‚\næ ¹æ®ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥ç®—å‡ºDCOå¯¹è±¡å’ŒDCå¯¹è±¡çš„å‡½æ•°æŒ‡é’ˆçš„å…³ç³»ï¼šfunction pointer=* (* (DCO +0x30)+0xad0)ï¼Œå…¶ä¸­DCO +0x30å³æŒ‡å‘DCå¯¹è±¡çš„æŒ‡é’ˆ\nv10 = *(_QWORD *)(v8 + 48);\nv15 *= * (void (_fastcall * * )(QWORD, _QWORD))(*v10 + 2768);\n__int64 __usercall GreResetDCInternal@\u0026lt;rax\u0026gt;(HDC a1@\u0026lt;rcx\u0026gt;, __int64 a2@\u0026lt;rdx\u0026gt;, int *a3@\u0026lt;r8\u0026gt;) { __int64 v24; // [rsp+50h] [rbp-20h] __int64 v25; // [rsp+60h] [rbp-10h] DCOBJ::DCOBJ((DCOBJ *)\u0026amp;v25, a1); // åˆ©ç”¨æ„é€ å‡½æ•°ä»HDCåˆ›å»ºDCOBJå¯¹è±¡ v8 = v25; Â·Â·Â·Â·Â·Â·Â·Â·Â·Â· v10 = *(_QWORD *)(v8 + 48);\t// èµ‹å€¼ *(_QWORD *)(v10 + 1736) = 0i64; v24 = v11; Â·Â·Â·Â·Â·Â·Â· v9 = *(_QWORD *)(v25 + 512) != 0i64; v12 = *(_DWORD *)(v25 + 120) \u0026gt; 0; Â·Â·Â·Â·Â·Â·Â· v13 = (HDC)hdcOpenDCW(\u0026amp;qword_1C0141EB0, v26, 0i64, 0i64, *(_QWORD *)(v10 + 2584));// åˆ›å»ºæ–°çš„DCå¯¹è±¡ï¼Œè¿”å›å¯¹åº”çš„HDCå¥æŸ„ if ( v13 ) { *(_QWORD *)(v10 + 2584) = 0i64; DCOBJ::DCOBJ((DCOBJ *)\u0026amp;v24, v13); v14 = (_QWORD *)v24; if ( v24 ) { if ( v12 ) *(_DWORD *)(v24 + 120) = *(_DWORD *)(v24 + 116); v14[308] = *(_QWORD *)(v25 + 2464); *(_QWORD *)(v25 + 2464) = 0i64; v14[309] = *(_QWORD *)(v25 + 2472); *(_QWORD *)(v25 + 2472) = 0i64; v15 = *(void (__fastcall **)(_QWORD, _QWORD))(v10 + 2768); if ( v15 ) v15(*(_QWORD *)(v10 + 1824), *(_QWORD *)(v14[6] + 1824i64));// è°ƒç”¨å‡½æ•°æŒ‡é’ˆæŒ‡å‘çš„å‡½æ•°ï¼Œä¼ å…¥å‚æ•°ä¸ºç”¨æˆ·ä¼ å…¥çš„HDCå¯¹åº”çš„DCå¯¹è±¡å†…çš„å€¼ Â·Â·Â·Â·Â·Â·Â· HmgSwapLockedHandleContents(v3, 0i64, v6, 0i64, v23);// äº¤æ¢æ—§çš„å’Œæ–°çš„HDCå¯¹è±¡ GreReleaseHmgrSemaphore(); Â·Â·Â·Â·Â·Â· bDeleteDCInternal(v6, 1i64, 0i64); // ä¼ å…¥äº†hdcOpenDCWè¿”å›çš„HDCï¼Œä½†HmgSwapLockedHandleContentsäº¤æ¢äº†æ–°æ—§å¥æŸ„å¯¹åº”çš„DCå¯¹è±¡ï¼Œæ­¤æ—¶v6å¥æŸ„å¯¹åº”æ—§DCå¯¹è±¡ã€‚ Â·Â·Â·Â·Â·Â· è°ƒç”¨è¯¥å‡½æ•°æŒ‡é’ˆçš„æ—¶å€™ï¼Œæ‰€ç”¨çš„ä¸¤ä¸ªå‚æ•°ä¹Ÿæ˜¯æºäºç”¨æˆ·ä¼ å…¥çš„HDCå¥æŸ„å¯¹åº”çš„DCå¯¹è±¡ã€‚\nv10 = *(_QWORD *)(v8 + 48);\t_\n_v14[308] = *(_QWORD *)(v25 + 2464);\nv14[309] = *(_QWORD *)(v25 + 2472);\nv15(*(_QWORD *)(v10 + 1824), *(_QWORD *)(v14[6] + 1824i64));\nåœ¨win32kfull!GreResetDCInternalå‡½æ•°çš„ååŠæ®µä¼šè°ƒç”¨win32kbase!DeleteDCInternalå‡½æ•°é‡Šæ”¾ä¼ å…¥è¯¥å‡½æ•°çš„HDCå¥æŸ„æ‰€å¯¹åº”çš„DCå¯¹è±¡ï¼Œåˆ°è¿™é‡Œå°±è¾¾æˆäº†use-after-freeçš„freeæ­¥éª¤ã€‚\nHDC v3; v3=a1; v13 = (HDC)hdcOpenDCW(\u0026amp;qword_1C0141EB0, v26, 0i64, 0i64, *(_QWORD *)(v10 + 2584));// åˆ›å»ºæ–°çš„HDC v6 = v13; if ( v13 ) { *(_QWORD *)(v10 + 2584) = 0i64; DCOBJ::DCOBJ((DCOBJ *)\u0026amp;v24, v13); v14 = (_QWORD *)v24; if ( v24 ) { if ( v12 ) *(_DWORD *)(v24 + 120) = *(_DWORD *)(v24 + 116); v14[308] = *(_QWORD *)(v25 + 2464); *(_QWORD *)(v25 + 2464) = 0i64; v14[309] = *(_QWORD *)(v25 + 2472); *(_QWORD *)(v25 + 2472) = 0i64; v15 = *(void (__fastcall **)(_QWORD, _QWORD))(v10 + 2768); if ( v15 ) v15(*(_QWORD *)(v10 + 1824), *(_QWORD *)(v14[6] + 1824i64)); GreAcquireHmgrSemaphore(); LOBYTE(v23) = 1; HmgSwapLockedHandleContents(v3, 0i64, v6, 0i64, v23);// äº¤æ¢æ—§çš„å’Œæ–°çš„HDCå¯¹è±¡ GreReleaseHmgrSemaphore(); Â·Â·Â·Â·Â·Â·Â· // åˆ é™¤HDCå¥æŸ„å¯¹åº”çš„DCå¯¹è±¡ã€‚ bDeleteDCInternal(v6, 1i64, 0i64); å¦‚æœåœ¨é‡Šæ”¾DCå¯¹è±¡ä¹‹åï¼Œé‡æ–°ç”³è¯·DCå¯¹è±¡ç©ºé—´ï¼Œä¿®æ”¹é‡Œé¢çš„å‡½æ•°æŒ‡é’ˆå†…å®¹ï¼Œå¹¶é€šè¿‡æŸäº›æ­¥éª¤ï¼Œè®©å†…æ ¸æ‰§è¡ŒDCå¯¹è±¡å†…çš„å‡½æ•°æŒ‡é’ˆï¼Œå³å¯è¾¾åˆ°useæ­¥éª¤è®©å†…æ ¸æ‰§è¡Œä»»æ„å†…æ ¸å‡½æ•°ã€‚\næ¼æ´åˆ©ç”¨åˆ†æ POC:\rhttps://github.com/KaLendsi/CVE-2021-40449-Exploit\nPOCä»£ç åˆ†æï¼š\rhttps://github.com/CppXL/cve-2021-40449-poc/blob/master/main.cpp\nè¦åˆ©ç”¨è¯¥æ¼æ´ï¼Œéš¾ç‚¹åœ¨äºfree DCå¯¹è±¡ä¹‹åæ€ä¹ˆä½¿å¾—å†…æ ¸å†æ¬¡è°ƒç”¨DCå¯¹è±¡çš„å‡½æ•°æŒ‡é’ˆï¼Œåœ¨æ­£å¸¸GreResetDCInternalå‡½æ•°æµç¨‹ä¸­ï¼Œæ˜¯å…ˆè°ƒç”¨DCå¯¹è±¡çš„å‡½æ•°æŒ‡é’ˆå†åˆ é™¤è¿™ä¸ªå¯¹è±¡ï¼Œå³æŒ‰ç…§æ­£å¸¸æµç¨‹å³ä¸ä¼šæœ‰use-after-freeçš„æ¡ä»¶ã€‚\nåœ¨ring 3å±‚è°ƒç”¨ResetDCå‡½æ•°ä¼šé€šè¿‡ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸è°ƒç”¨å‡½æ•°NtGdiResetDCï¼Œåœ¨NtGdiResetDCä¼šè°ƒç”¨æ¼æ´å‡½æ•°GreResetDCInternalï¼Œåœ¨GreResetDCInternalä¸­ä¼šè°ƒç”¨DCå¯¹è±¡é‡Œé¢çš„å‡½æ•°æŒ‡é’ˆã€‚è¦åˆ©ç”¨è¯¥æ¼æ´å³è¦åœ¨è°ƒç”¨å‡½æ•°æŒ‡é’ˆä¹‹å‰å®Œæˆä¸‰æ­¥åŠ¨ä½œï¼š1ã€é‡Šæ”¾DCå¯¹è±¡2ã€é‡æ–°ç”³è¯·åŸDCå¯¹è±¡çš„å†…å­˜ç©ºé—´3ã€å®Œæˆå†…å­˜ç©ºé—´çš„å¸ƒå±€ã€‚\nåœ¨å‡½æ•°GreResetDCInternalè°ƒç”¨DCå¯¹è±¡çš„å‡½æ•°æŒ‡é’ˆä¹‹å‰ä¼šè°ƒç”¨win32kbase!hdcOpenDCWå‡½æ•°ã€‚win32kbase!hdcOpenDCWå‡½æ•°ä¼šæ‰§è¡Œæ‰“å°æœºé©±åŠ¨çš„ç”¨æˆ·æ€å›è°ƒå‡½æ•°è¡¨é‡Œé¢çš„å‡½æ•°ï¼Œè¯¥è¡¨é‡Œé¢å­˜æ”¾äº†å‡½æ•°æŒ‡é’ˆï¼Œè¯¥å‡½æ•°æŒ‡é’ˆåŸå…ˆæŒ‡å‘çš„æ˜¯é¢„å®šä¹‰çš„å›è°ƒå‡½æ•°ã€‚åœ¨POCä¸­è¦†ç›–è¿™ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œä½¿å…¶æ‰§è¡ŒPOCå®šä¹‰çš„å›è°ƒå‡½æ•°ã€‚\nåœ¨è‡ªå®šä¹‰å›è°ƒå‡½æ•°ä¸­å†æ¬¡æ‰§è¡ŒResetDCå‡½æ•°å¹¶ä¼ å…¥åŒä¸€HDCå¥æŸ„ï¼Œåˆ™ä¼šå†æ¬¡æ‰§è¡ŒNtGdiResetDCå’ŒGreResetDCInternalå‡½æ•°ï¼Œè€Œåœ¨GreResetDCInternalçš„ååŠæ®µï¼Œä¼šé‡Šæ”¾ä¼ å…¥çš„HDCå¯¹åº”çš„DCå¯¹è±¡å¹¶åˆ›å»ºæ–°çš„DCå¯¹è±¡ã€‚æ­¤æ—¶è¾¾åˆ°äº†freeæ­¥éª¤ã€‚\nåœ¨ç¬¬äºŒæ¬¡ResetDCè°ƒç”¨å®Œæˆåï¼ŒåŸDCå¯¹è±¡å·²è¢«é‡Šæ”¾ï¼Œæ­¤æ—¶å¯ä»¥é‡æ–°ç”³è¯·åŸDCå¯¹è±¡çš„å†…å­˜ç©ºé—´å¹¶å®Œæˆå†…å­˜å¸ƒå±€ï¼Œå°†åŸDCå¯¹è±¡çš„å‡½æ•°æŒ‡é’ˆå’Œå‡½æ•°æŒ‡é’ˆçš„å‚æ•°çš„ä½ç½®è®¾ç½®ä¸ºæƒ³è¦æ‰§è¡Œçš„å†…æ ¸å‡½æ•°çš„åœ°å€åŠå‚æ•°ã€‚åœ¨æ‰§è¡Œå®Œç¬¬ä¸€æ¬¡å›è°ƒä¹‹åï¼ŒGreResetDCInternal å°†è°ƒç”¨åŸDCå¯¹è±¡å†…çš„å‡½æ•°æŒ‡é’ˆï¼Œå³å®Œæˆäº†ä»»æ„å†…æ ¸å‡½æ•°è°ƒç”¨ï¼Œæ­¤æ—¶è¾¾åˆ°äº†useæ­¥éª¤ã€‚\nå®Œæ•´è°ƒç”¨é“¾å¦‚ä¸‹å›¾ï¼š\nå…¶ä¸­æ¼æ´ç›¸å…³çš„ç±»å®šä¹‰å¦‚ä¸‹ï¼Œå‚è€ƒhttps://github.com/ZoloZiak/WinNT4/blob/master/private/ntos/w32/ntgdi/gre/dcobj.hxx#L97\nclass DCLEVEL { public: ... HDC hdcSave; ... } class DC : public OBJECT { public: DHPDEV dhpdev_; PDEV *ppdev_; ... HDC hdcNext_; // HDCé“¾è¡¨æŒ‡é’ˆ HDC hdcPrev_; ... DCLEVEL dclevel ... }; typedef DC *PDC; class XDCOBJ /* dco */ { public: PDC pdc; ... }; typedef XDCOBJ *PXDCOBJ; class DCOBJ : public XDCOBJ /* mdo */ { public: DCOBJ() { pdc = (PDC) NULL; } DCOBJ(HDC hdc) { vLock(hdc); } ~DCOBJ() { vUnlockNoNullSet(); } }; typedef DCOBJ *PDCOBJ; ç±»ä¹‹é—´çš„å…³ç³»å¯ä»¥ç®€åŒ–ä¸ºä¸‹å›¾ï¼š\nè°ƒè¯• freeéƒ¨åˆ† åœ¨freeéƒ¨åˆ†éœ€è¦æŠŠæˆ‘ä»¬æƒ³è¦é‡Šæ”¾çš„å†…å­˜ç©ºé—´é‡Šæ”¾ï¼Œå¹¶è®©åé¢çš„useéƒ¨åˆ†æˆåŠŸç”³è¯·åˆ°è¿™å—å†…å­˜ç©ºé—´ã€‚\nè°ƒè¯•ç¯å¢ƒï¼šè™šæ‹Ÿæœºwindows 10 1607ã€ç‰©ç†æœºwindows 10 2004\nPOC:\rhttps://github.com/KaLendsi/CVE-2021-40449-Exploit\næ–­ç‚¹:\nbp win32kfull!NtGdiResetDC bp win32kfull!NtGdiResetDC+0xc1 \u0026#34;è°ƒç”¨GreResetDCInternalå‡½æ•°\u0026#34; bp win32kfull!GreResetDCInternal+0x3a \u0026#34;è°ƒç”¨DCOBJæ„é€ å‡½æ•°\u0026#34; bp win32kfull!GreResetDCInternal+0x116 \u0026#34;è°ƒç”¨_imp_hdcOpenDCWå‡½æ•°\u0026#34; bp win32kfull!GreResetDCInternal+0x136 \u0026#34;ç¬¬äºŒæ¬¡DCOBJ\u0026#34; bp win32kfull!GreResetDCInternal+0x1b5 \u0026#34;è°ƒç”¨DCå¯¹è±¡å‡½æ•°æŒ‡é’ˆ\u0026#34; bp win32kfull!GreResetDCInternal+0x1d1 \u0026#34;è°ƒç”¨HmgSwapLockedHandleå‡½æ•°\u0026#34; bp win32kfull!GreResetDCInternal+0x20d \u0026#34;è°ƒç”¨_imp_bDeleteDCInternalå‡½æ•°\u0026#34; bp cve_2021_40449!hook_DrvEnablePDEV+0x12a \u0026#34;å¾ªç¯è°ƒç”¨\u0026#34; bp win32kbase!PALMEMOBJ::bCreatePalette \u0026#34;è°ƒç”¨win32kbase!PALMEMOBJ::bCreatePalette\u0026#34; è¿è¡ŒPOCï¼Œæ–­ç‚¹bp win32kfull!NtGdiResetDCè§¦å‘æ­¤æ—¶ä¼ å…¥çš„å¥æŸ„ä¸ºrcx=00000000092105f1\nç¬¬ä¸€æ¬¡è°ƒç”¨win32kfull!GreResetDCInternal æ—¶ä¼ å…¥å„ä¸ªå‚æ•°ä¸ºrcx=00000000092105f1 rdx=0000000000000000 r8=ffffb101aadf2a44 å³ç¬¬ä¸€ä¸ªå¥æŸ„å€¼ä¸º00000000092105f1\nç¬¬ä¸€æ¬¡è°ƒç”¨æ„é€ å‡½æ•°ï¼Œåˆ©ç”¨DCå¯¹è±¡åˆ›å»ºDCOå¯¹è±¡ï¼Œæ­¤æ—¶rbxå­˜æ”¾DCOå¯¹è±¡çš„åœ°å€ï¼Œ\næ ¹æ®æ¼æ´å½¢æˆåˆ†æçš„è®¡ç®—å…¬å¼ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„å¾—åˆ°DCå¯¹è±¡å†…çš„å‡½æ•°æŒ‡é’ˆæŒ‡å‘çš„å‡½æ•°çš„åœ°å€ä¸ºï¼šffffd548a1f10c30\n1: kd\u0026gt; dq rax ffffb101`aadf29c0 ffffd50e`041fd010 00000000`00000001 ffffb101`aadf29d0 00000268`6e766b20 000000d7`97aff680 ffffb101`aadf29e0 00000000`00000000 00000000`092105f1 ffffb101`aadf29f0 00000000`00000000 ffffd50e`041fb030 ffffb101`aadf2a00 ffffb101`aadf2b80 ffffd548`a1f18fe6 ffffb101`aadf2a10 00000000`00000001 00000000`00000000 ffffb101`aadf2a20 ffffb101`aadf2a44 ffffd50e`041fb030 ffffb101`aadf2a30 000000d7`97aff5d0 00000000`00000000 // rbxå­˜æ”¾äº†æ„é€ å‡½æ•°äº§ç”Ÿçš„DCOå¯¹è±¡åœ°å€ 1: kd\u0026gt; dq rbx ffffd50e`041fd010 00000000`092105f1 80000001`00000000 ffffd50e`041fd020 ffffd800`b45ad780 00000268`6e75ea10 ffffd50e`041fd030 00100010`00000000 00000000`00000000 ffffd50e`041fd040 ffffd50e`00052030 00000000`00000000 ffffd50e`041fd050 ffffd800`b56f1260 00000009`1000a01f ffffd50e`041fd060 ffffd50e`041fd3d0 00000000`0088000b ffffd50e`041fd070 ffffd50e`000004f0 ffffd50e`00005d90 ffffd50e`041fd080 00000001`00000000 00000000`00000000 // ffffd50e`041fd010ä¸ºrbxçš„å€¼ï¼Œæ­¤å¤„ffffd50e`041fd010+0x30ä¸ºPDCçš„åœ°å€ï¼ŒPDCæŒ‡å‘DCå¯¹è±¡å³DCå¯¹è±¡åœ°å€ä¸ºffffd50e`00052030 // è®¡ç®—å…¬å¼ *(dcoåœ°å€+0x30)=dcåœ°å€ 1: kd\u0026gt; dq ffffd50e`041fd010+0x30 ffffd50e`041fd040 ffffd50e`00052030 00000000`00000000 ffffd50e`041fd050 ffffd800`b56f1260 00000009`1000a01f ffffd50e`041fd060 ffffd50e`041fd3d0 00000000`0088000b ffffd50e`041fd070 ffffd50e`000004f0 ffffd50e`00005d90 ffffd50e`041fd080 00000001`00000000 00000000`00000000 ffffd50e`041fd090 00000000`00000000 00000000`00000000 ffffd50e`041fd0a0 ffffd50e`00001a10 ffffd50e`00004cb0 ffffd50e`041fd0b0 ffffd50e`000105f0 00000000`00000000 // ffffd50e`00052030+0xad0å¤„ä¸ºDCå¯¹è±¡çš„å‡½æ•°æŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘äº†ä¸€ä¸ªå‡½æ•° // è®¡ç®—å…¬å¼ *(dcåœ°å€ +0xad0)=å‡½æ•°åœ°å€ 1: kd\u0026gt; dq ffffd50e`00052030+0xad0 ffffd50e`00052b00 ffffd548`a1f10c30 ffffd548`a1db18c0 ffffd50e`00052b10 00000000`00000000 00000000`00000000 ffffd50e`00052b20 00000000`00000000 ffffd548`a1f10930 ffffd50e`00052b30 00000000`00000000 ffffd548`a1f11dc0 ffffd50e`00052b40 ffffd548`a1f0e6b0 ffffd548`a1f11b00 ffffd50e`00052b50 00000000`00000000 ffffd548`a1f0cd70 ffffd50e`00052b60 ffffd548`a1f0d1f0 ffffd548`a1f112f0 ffffd50e`00052b70 00000000`00000000 00000000`00000000 // ä»¥ä¸‹ä¸ºå‡½æ•°çš„æ±‡ç¼– 1: kd\u0026gt; u ffffd548`a1f10c30 win32kfull!UMPDDrvResetPDEV: ffffd548`a1f10c30 48895c2418 mov qword ptr [rsp+18h],rbx ffffd548`a1f10c35 4889742420 mov qword ptr [rsp+20h],rsi ffffd548`a1f10c3a 57 push rdi ffffd548`a1f10c3b 4883ec70 sub rsp,70h ffffd548`a1f10c3f 488b05ba440800 mov rax,qword ptr [win32kfull!_security_cookie (ffffd548`a1f95100)] ffffd548`a1f10c46 4833c4 xor rax,rsp ffffd548`a1f10c49 4889442468 mov qword ptr [rsp+68h],rax ffffd548`a1f10c4e 488bf9 mov rdi,rcx ä¹‹åé€šè¿‡hdcOpenDCWå‡½æ•°è°ƒç”¨ç”¨æˆ·æ¨¡å¼çš„å›è°ƒå‡½æ•°ï¼Œåœ¨å›è°ƒå‡½æ•°ä¸­å†æ¬¡è°ƒç”¨ResetDCå‡½æ•°ï¼Œæ­¤æ—¶ä¼ å…¥çš„HDCå’Œç¬¬ä¸€æ¬¡è°ƒç”¨ResetDCçš„æ˜¯åŒä¸€ä¸ªå¥æŸ„ã€‚\nç¬¬äºŒæ¬¡è°ƒç”¨win32kfull!GreResetDCInternal æ—¶ï¼Œä¼ å…¥åŒä¸€ä¸ªHDCå¥æŸ„ï¼Œå³å¯¹åº”åŒä¸€ä¸ªDCå¯¹è±¡ã€‚\n0: kd\u0026gt; t win32kfull!GreResetDCInternal: ffffd548`a1f03e58 488bc4 mov rax,rsp 1: kd\u0026gt; rrcx rcx=00000000092105f1 ç¬¬äºŒæ¬¡è°ƒç”¨DCOBJæ„é€ å‡½æ•°æ—¶ï¼Œç”±äºä¼ å…¥çš„æ˜¯åŒä¸€ä¸ªHDCå¥æŸ„ï¼Œæ‰€ä»¥HDCå¥æŸ„å¼•ç”¨æ¬¡æ•°+1ï¼ŒåŒæ—¶ä¸¤æ¬¡è°ƒç”¨æ„é€ å‡½æ•°æ„é€ çš„å¯¹è±¡å…³è”åˆ°åŒä¸€ä¸ªDCå¯¹è±¡ã€‚\nä¹‹åç¬¬äºŒæ¬¡è°ƒç”¨win32kfull!_imp_hdcOpenDCWå‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°å†…æ‰§è¡Œæ”¿ç­–å›è°ƒå‡½æ•°ï¼Œwin32kfull!imp_hdcOpenDCWè¿”å›ä¸€ä¸ªHDCå¥æŸ„å€¼ä¸º0000000003210041ï¼Œå³åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„DCå¯¹è±¡ã€‚ä¹‹åé€šè¿‡æ–°åˆ›å»ºçš„DCå¯¹è±¡åˆ›å»ºDCOå¯¹è±¡ã€‚\nåœ¨win32kfull!GreResetDCInternalååŠæ®µä¼šè°ƒç”¨win32kfull!_imp_HmgSwapLockedHandleContentsäº¤æ¢ç¬¬ä¸€ä¸ªHDCå¥æŸ„å’Œç¬¬äºŒæ¬¡è°ƒç”¨win32kfull!imp_hdcOpenDCWåˆ›å»ºçš„HDCå¥æŸ„ã€‚\nè°ƒç”¨win32kfull!_imp_HmgSwapLockedHandleContentsä¹‹åä¸¤ä¸ªå¥æŸ„å¯¹åº”çš„DCå†…å®¹ä¸ºå·²ç»å‘ç”Ÿäº†äº¤æ¢\n// ä»¥ä¸‹å†…å®¹ä¸ºæ—§DCå¯¹è±¡ï¼Œä½†æ˜¯å¥æŸ„ä¸ºæ–°å¥æŸ„ 1: kd\u0026gt; dq ffffd50e041fd010 ffffd50e`041fd010 00000000`03210041 80000001`00000000 ...... 1: kd\u0026gt; dq ffffd50e03fee010 // ä»¥ä¸‹å†…å®¹ä¸ºæ–°DCå¯¹è±¡ï¼Œä½†å¥æŸ„ä¸ºæ—§å¥æŸ„ ffffd50e`03fee010 00000000`092105f1 80000002`00000000 ...... ä¹‹åè°ƒç”¨win32kfull!_imp_bDeleteDCInternalä¼ å…¥HDCå¥æŸ„ï¼Œè¯¥å‡½æ•°ä¼šé‡Šæ”¾HDCå¥æŸ„å¯¹åº”çš„DCå¯¹è±¡ï¼Œè€Œæ­¤æ—¶ä¼ å…¥è¯¥å‡½æ•°çš„HDCå¥æŸ„ä¸ºç¬¬äºŒæ¬¡è°ƒç”¨hdcOpenDCWå‡½æ•°è¿”å›çš„å¥æŸ„ï¼Œä½†ä¹‹å‰äº¤æ¢è¿‡æ–°æ—§å¥æŸ„ï¼Œæ‰€ä»¥å®é™…ä¸Šé‡Šæ”¾çš„æ˜¯æ—§HDCå¥æŸ„å¯¹åº”çš„DCå¯¹è±¡ã€‚\nä¹‹å‰è®¡ç®—å‡½æ•°æŒ‡é’ˆçš„æ—¶å€™ï¼Œæˆ‘ä»¬çŸ¥é“DCO +0x30æ˜¯æŒ‡å‘DCå¯¹è±¡çš„æŒ‡é’ˆï¼Œæ‰€ä»¥åœ¨è°ƒç”¨win32kfull!_imp_bDeleteDCInternalå‡½æ•°ä¹‹åï¼ŒåŸDCå¯¹è±¡çš„å†…å­˜ç©ºé—´å·²ç»è¢«é‡Šæ”¾ï¼Œè¾¾æˆäº†use-after-freeçš„ç¬¬ä¸€æ­¥freeã€‚\nfunction pointer=* (* (DCO +0x30)+0xad0)ï¼Œå…¶ä¸­DCO +0x30å³æŒ‡å‘DCå¯¹è±¡çš„æŒ‡é’ˆ\n0: kd\u0026gt; dq ffffd50e041fd010+0x30 // å–DCå¯¹è±¡åœ°å€ ffffd50e`041fd040 ffffd50e`00052030 00000000`00000000 ...... 0: kd\u0026gt; !pool ffffd50e`00052030 // DCå¯¹è±¡çš„å†…å­˜å·²è¢«é‡Šæ”¾ï¼Œå¤§å°ä¸ºe30 Pool page ffffd50e00052030 region is Paged session pool *ffffd50e00052000 size: e30 previous size: 0 (Free ) *GDev Pooltag GDev : Gdi pdev ffffd50e00052e30 size: 10 previous size: e30 (Free) Free ffffd50e00052e40 size: 1c0 previous size: 10 (Allocated) Usqu ä¹‹ååªéœ€è¦ç”³è¯·è¿™å—å†…å­˜ç©ºé—´å¹¶æ„é€ ï¼Œåˆšåˆ é™¤çš„æ—¶å€™ï¼Œè™½ç„¶DCå¯¹è±¡å·²ç»è¢«é‡Šæ”¾ï¼Œä½†å‡½æ•°æŒ‡é’ˆè¿˜æ˜¯æŒ‡å‘æ­£ç¡®çš„å‡½æ•°åœ°å€ï¼Œæ¥ä¸‹æ¥å°±è¦ç”³è¯·ç©ºé—´ï¼Œè¦†ç›–è¿™å—å†…å­˜ç©ºé—´çš„å‡½æ•°æŒ‡é’ˆçš„å€¼å³å¯ã€‚\n0: kd\u0026gt; dq ffffd50e041fd010+0x30\t// å–DCå¯¹è±¡åœ°å€ ffffd50e`041fd040 ffffd50e`00052030 00000000`00000000 0: kd\u0026gt; dq ffffd50e`00052030+0xad0\t// å–DCå¯¹è±¡å†…çš„å‡½æ•°æŒ‡é’ˆ ffffd50e`00052b00 ffffd548`a1f10c30 ffffd548`a1db18c0 0: kd\u0026gt; u ffffd548`a1f10c30 win32kfull!UMPDDrvResetPDEV: ffffd548`a1f10c30 48895c2418 mov qword ptr [rsp+18h],rbx ffffd548`a1f10c35 4889742420 mov qword ptr [rsp+20h],rsi ffffd548`a1f10c3a 57 push rdi ffffd548`a1f10c3b 4883ec70 sub rsp,70h ffffd548`a1f10c3f 488b05ba440800 mov rax,qword ptr [win32kfull!_security_cookie (ffffd548`a1f95100)] ffffd548`a1f10c46 4833c4 xor rax,rsp ffffd548`a1f10c49 4889442468 mov qword ptr [rsp+68h],rax ffffd548`a1f10c4e 488bf9 mov rdi,rcx use éƒ¨åˆ† æ³¨ï¼šæ­¤éƒ¨åˆ†ä¸ºç¬¬äºŒæ¬¡è°ƒè¯•ï¼Œæ‰€ä»¥å¥æŸ„ã€å†…å­˜åœ°å€å’Œå‰éƒ¨åˆ†ä¸ä¸€æ ·ã€‚\nåœ¨pocé‡Œé¢ä¼šè°ƒç”¨CreatePaletteå‡½æ•°ï¼Œè¯¥æ­¤å‡½æ•°ä¼šç”³è¯·å†…æ ¸å †ï¼Œ\nç¬¬ä¸€ä¸ªå¥æŸ„rcx=0000000015213372\n// ç¬¬ä¸€ä¸ªDCOå¯¹è±¡ 0: kd\u0026gt; dq rbx DBGHELP: SharedUserData - virtual symbol module ffff885e`847d2620 00000000`15213372 80000001`00000000 ...... // ç¬¬ä¸€ä¸ªPDC æŒ‡å‘DCå¯¹è±¡ 0: kd\u0026gt; dq ffff885e`847d2620+0x30 ffff885e`847d2650 ffff885e`80063030 00000000`00000000 ...... // ç¬¬ä¸€ä¸ªDCå¯¹è±¡ 0: kd\u0026gt; dq ffff885e`80063030 ffff885e`80063030 00000000`00000000 00000000`00000000 ffff885e`80063040 00000000`00000000 ffff885e`80046010 ffff885e`80063050 00000001`00000001 ffff885e`80063030 ffff885e`80063060 00000000`00000000 00000000`00008180 ffff885e`80063070 ffffb48d`a36b4e50 00000000`00000000 ffff885e`80063080 00000000`00000000 00000000`00000000 ffff885e`80063090 00000000`00000000 00000000`00000000 ffff885e`800630a0 00000000`00000000 00000000`00000000 ç¬¬äºŒä¸ªå¥æŸ„rax=0000000001211b60\n1: kd\u0026gt; dq rdx DBGHELP: SharedUserData - virtual symbol module ffff885e`84121620 00000000`01211b60 80000001`00000000 ...... 1: kd\u0026gt; dq rdx+0x30 ffff885e`84121650 ffff885e`8006b030 00000000`00000000 ...... 1: kd\u0026gt; dq ffff885e`8006b030 ffff885e`8006b030 00000000`00000000 00000000`00000000 ffff885e`8006b040 00000000`00000000 ffff885e`80063030 ffff885e`8006b050 00000001`00000001 ffff885e`8006b030 ffff885e`8006b060 00000000`00000000 00000000`00008180 ffff885e`8006b070 ffffb48d`a317b8b0 00000000`00000000 ffff885e`8006b080 00000000`00000000 00000000`00000000 ffff885e`8006b090 00000000`00000000 00000000`00000000 ffff885e`8006b0a0 00000000`00000000 00000000`00000000 åœ¨DeleteDCInternelè°ƒç”¨ä¹‹åç¬¬ä¸€ä¸ªDCå¯¹è±¡çš„å†…å­˜ç©ºé—´å·²ç»è¢«é‡Šæ”¾\n0: kd\u0026gt; !pool ffff885e`80063030 // æ³¨æ„ï¼Œæ­¤æ—¶DCå¯¹è±¡åœ°å€è·ç¦»å †å¤´åœ°å€ä¸º0x30å¤§å° Pool page ffff885e80063030 region is Paged session pool *ffff885e80063000 size: e30 previous size: 0 (Free ) *GDev Pooltag GDev : Gdi pdev ffff885e80063e30 size: 70 previous size: e30 (Free) Free ffff885e80063ea0 size: b0 previous size: 70 (Free ) Usqm ffff885e80063f50 size: b0 previous size: b0 (Allocated) Usqm æ ¹æ®è°ƒè¯•ï¼Œå¯ä»¥å¾—çŸ¥é‡Šæ”¾çš„DCå¯¹è±¡å†…å­˜å¤§å°ä¸º0xe30ï¼Œæ‰€ä»¥è¦è¦†ç›–å‡½æ•°æŒ‡é’ˆæ—¶ï¼Œæ‰€ç”³è¯·çš„å†…å­˜ä¹Ÿè¦åˆšåˆšå¥½æˆ–è€…æ¥è¿‘è¿™å—å†…å­˜å¤§å°æ‰æœ‰å¯èƒ½ç”³è¯·åˆ°ã€‚åœ¨pocé‡Œé¢ï¼Œä½¿ç”¨CreatePaletteç”³è¯·è¿™å—å†…æ ¸å †ã€‚è¿™ä¸ªå‡½æ•°ä¼šé€šè¿‡ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸å‡½æ•°win32kfull!NtGdiCreatePaletteInternalï¼Œè¯¥å‡½æ•°è°ƒç”¨win32kbase!PALMEMOBJ::bCreatePaletteåˆ›é€ Paletteå¯¹è±¡ï¼Œwin32kbase!PALMEMOBJ::bCreatePaletteä¼šè°ƒç”¨AllocateObjectä¸ºæ–°å¯¹è±¡ç”³è¯·ç©ºé—´ï¼Œæœ€ç»ˆé€šè¿‡è°ƒç”¨ExAllocatePoolWithTagå‡½æ•°åˆ†é…å †ç©ºé—´ï¼Œæ•´ä¸ªè°ƒç”¨æ ˆå¦‚ä¸‹ï¼š\n0: kd\u0026gt; kb # RetAddr : Call Site 00 ffff880c`b95d39f4 : win32kbase!Win32AllocPool 01 ffff880c`b95d0042 : win32kbase!AllocateObject+0xc4 02 ffff880c`b9309ecc : win32kbase!PALMEMOBJ::bCreatePalette+0xb2 03 fffff800`b175a193 : win32kfull!NtGdiCreatePaletteInternal+0xcc 04 00007ffe`a2cb2604 : nt!KiSystemServiceCopyEnd+0x13 05 00007ff7`e44c2fe1 : win32u!NtGdiCreatePaletteInternal+0x14 06 00000000`00000d94 : cve_2021_40449!createPaletteofSize1+0xd1 [C:\\Users\\mimi\\source\\repos\\test\\cve-2021-40449\\main.cpp @ 71] ....... 2e 00007ffe`a2e9b26f : 0x000000d1`a374ef69 2f 00007ffe`a39e1a4a : gdi32full!GdiPrinterThunk+0x21f 30 00007ffe`a61889e4 : USER32!__ClientPrinterThunk+0x3a 31 00007ffe`a2cb6dc4 : ntdll!KiUserCallbackDispatcherContinue 32 00007ffe`a2e7edda : win32u!NtGdiResetDC+0x14 33 00007ffe`a3682371 : gdi32full!ResetDCWInternal+0x17a 34 00007ff7`e44c3296 : GDI32!ResetDCW+0x31 35 00000000`00000000 : cve_2021_40449!main+0x146 [C:\\Users\\mimi\\source\\repos\\test\\cve-2021-40449\\main.cpp @ 685] win32kbase!Win32AllocPoolä»£ç å¦‚ä¸‹ï¼Œæœ€ç»ˆæ˜¯é€šè¿‡è°ƒç”¨ExAllocatePoolWithTagç”³è¯·å †ï¼Œwin32kbase!Win32AllocPoolçš„a1å‚æ•°ä¸ºè¦ç”³è¯·çš„å †å†…å­˜å¤§å°ï¼Œè°ƒè¯•è¿‡ç¨‹ä¸­å¯ä»¥å¾—çŸ¥å…¶è¦ç”³è¯·0xe20å¤§å°çš„å †ï¼ŒåŠ ä¸Šå †å¤´ï¼Œåˆšå¥½æ¥è¿‘åˆšé‡Šæ”¾çš„0xe3å¤§å°çš„å †ç©ºé—´å¤§å°ã€‚\n__int64 __fastcall Win32AllocPool(__int64 a1, unsigned int a2) { unsigned int v2; // ebx __int64 v3; // rdi __int64 result; // rax v2 = a2; v3 = a1; if ( (signed int)IsWin32AllocPoolImplSupported_0() \u0026lt; 0 ) result = 0i64; else result = Win32AllocPoolImpl_0(33i64, v3, v2); return result; } åŒæ—¶åœ¨Pocä»£ç åˆ†æé‡Œé¢åˆ†æäº†DCå¯¹è±¡å‡½æ•°æŒ‡é’ˆå’Œå †å¤´ä¹‹é—´çš„ä½ç½®å…³ç³»ï¼Œæ‰€ä»¥é€šè¿‡æ„é€ ä¼ å…¥CreatePaletteçš„LOGPALETTEç»“æ„å¯ä»¥åˆšåˆšå¥½è¦†ç›–åŸDCå¯¹è±¡å†…çš„å‡½æ•°æŒ‡é’ˆä»¥åŠè¯¥å‡½æ•°æŒ‡é’ˆè¦è°ƒç”¨çš„å‚æ•°ï¼Œå†…å­˜åˆ†å¸ƒå…·ä½“è§https://github.com/CppXL/cve-2021-40449-poc/blob/master/main.cpp é‡Œé¢çš„æ³¨é‡Šã€‚\né€šè¿‡å‡½æ•°æŒ‡é’ˆè°ƒç”¨RtlSetAllBitså‡½æ•°å¹¶ä¼ å…¥RtklBitMapå‹æŒ‡é’ˆï¼Œå…¶ä¸­RtlBitMapçš„bufferæŒ‡å‘POCè¿›ç¨‹è‡ªèº«çš„æƒé™ä½ï¼Œå¦‚ä¸‹å›¾ï¼š\ntypedef struct _RTL_BITMAP { ULONG SizeOfBitMap; ULONG *Buffer; } RTL_BITMAP, *PRTL_BITMAP; 0: kd\u0026gt; dq ffff885e80063000+0x750 // æ­¤å¤„ä¸ºRtlBitMapåœ°å€ ffff885e`80063750 ffffb48d`a3839010 ffffffff`ffffffff ffff885e`80063760 ffffffff`ffffffff ffffffff`ffffffff ffff885e`80063770 ffffffff`ffffffff ffffffff`ffffffff ffff885e`80063780 ffffffff`ffffffff ffffffff`ffffffff ffff885e`80063790 ffffffff`ffffffff ffffffff`ffffffff ffff885e`800637a0 ffffffff`ffffffff ffffffff`ffffffff ffff885e`800637b0 ffffffff`ffffffff ffffffff`ffffffff ffff885e`800637c0 ffffffff`ffffffff ffffffff`ffffffff 0: kd\u0026gt; dq ffffb48d`a3839010\t// æ­¤å¤„å­˜æ”¾äº†RtlBitMapç»“æ„ï¼Œ0x00-0x08ä¸ºsizeï¼Œ0x08-0x10ä¸ºbufferæŒ‡é’ˆï¼ŒæŒ‡å‘äº†è‡ªèº«çš„æƒé™ä½ ffffb48d`a3839010 00000000`00000080 ffffde8f`1fb2e9d0 ffffb48d`a3839020 41414141`41414141 41414141`41414141 ffffb48d`a3839030 00000000`00000000 00000000`00000000 ffffb48d`a3839040 00000000`00000000 00000000`00000000 ffffb48d`a3839050 00000000`00000000 00000000`00000000 ffffb48d`a3839060 00000000`00000000 00000000`00000000 ffffb48d`a3839070 00000000`00000000 00000000`00000000 ffffb48d`a3839080 00000000`00000000 00000000`00000000 0: kd\u0026gt; dq ffffde8f`1fb2e9d0 ffffde8f`1fb2e9d0 00000006`02880000 00000000`00800000 ffffde8f`1fb2e9e0 00000000`00800000 00000000`00000000 ffffde8f`1fb2e9f0 00000000`00000000 00000000`00000000 ffffde8f`1fb2ea00 20010000`00000000 0000000f`00000001 ffffde8f`1fb2ea10 000001e0`00000000 00000000`00001000 ffffde8f`1fb2ea20 00000000`00000000 ffffde8f`1fb2ee18 ffffde8f`1fb2ea30 00000000`00000000 ffffde8f`1f1007f0 ffffde8f`1fb2ea40 ffffde8f`1f1007f0 ffffde8f`1f10080c è°ƒç”¨DCé‡Œé¢çš„å‡½æ•°æŒ‡é’ˆä¹‹å‰ï¼Œè‡ªèº«æƒé™ä½ä¸ºæ­£å¸¸æƒé™ã€‚\nè°ƒç”¨å‡½æ•°æŒ‡é’ˆä¹‹åï¼Œå¯ä»¥çœ‹åˆ°æƒé™ä½å…¨éƒ¨ç½®ä¸ºäº†1\nè¡¥ä¸åˆ†æ åœ¨æ¼æ´åˆ©ç”¨åˆ†æé‡Œé¢åˆ†æè¿‡æ¼æ´å½¢æˆåŸå› æ˜¯å› ä¸ºåœ¨è°ƒç”¨GreResetDCInternalå‡½æ•°æ—¶ï¼Œä½¿ç”¨DCå¯¹è±¡æŒ‡é’ˆçš„æ—¶å€™æ²¡æœ‰æ£€æŸ¥DCå¯¹è±¡æ˜¯å¦å¼‚å¸¸ã€‚è€Œåˆ©ç”¨è¯¥æ¼æ´æ˜¯é€šè¿‡åœ¨è°ƒç”¨å›è°ƒå‡½æ•°æ—¶è°ƒç”¨ResetDCå®ç°çš„ã€‚\næˆ‘ä»¬å†æ¬¡å›é¡¾ä¸€ä¸‹æ¼æ´å‡½æ•°ï¼Œåœ¨è°ƒç”¨hdcOpenDCWä¹Ÿå°±æ˜¯åœ¨è°ƒç”¨å›è°ƒå‡½æ•°ä¹‹å‰ä¼šé€šè¿‡DCOçš„æ„é€ å‡½æ•°ä»DCæ„é€ DCOå¯¹è±¡ï¼Œåœ¨åŸºæœ¬æ¦‚å¿µä¸­çŸ¥é“ï¼Œå†…æ ¸å¯¹è±¡æ¯è¢«å¼•ç”¨ä¸€æ¬¡åˆ™å¯¹è±¡å¼•ç”¨è®¡æ•°å™¨å€¼ä¼šåŠ ä¸€ã€‚è°ƒç”¨æ„é€ å‡½æ•°æ—¶ï¼ŒDCå¯¹è±¡å¼•ç”¨åŠ ä¸€ï¼Œæ­£å¸¸æƒ…å†µä¸‹æ­¤æ—¶DCå¯¹è±¡å¼•ç”¨æ¬¡æ•°è¦ä¸º1ã€‚å¦‚æœåœ¨å›è°ƒå‡½æ•°ä¸­å†æ¬¡è°ƒç”¨ResetDCï¼Œåˆ™ä¼šç¬¬äºŒæ¬¡è°ƒç”¨GreResetDCInternalï¼Œå†æ¬¡è°ƒç”¨DCOçš„æ„é€ å‡½æ•°ï¼ŒDCå¯¹è±¡å¼•ç”¨å†æ¬¡åŠ ä¸€ï¼Œæ­¤æ—¶å¼•ç”¨æ¬¡æ•°ä¸º2ã€‚\næ‰€ä»¥åˆ¤æ–­DCå¯¹è±¡å¼‚å¸¸å¯ä»¥é€šè¿‡åˆ¤æ–­DCå¯¹è±¡çš„å¼•ç”¨æ¬¡æ•°å®ç°ã€‚\n__int64 __usercall GreResetDCInternal@\u0026lt;rax\u0026gt;(HDC a1@\u0026lt;rcx\u0026gt;, __int64 a2@\u0026lt;rdx\u0026gt;, int *a3@\u0026lt;r8\u0026gt;) { __int64 v24; // [rsp+50h] [rbp-20h] __int64 v25; // [rsp+60h] [rbp-10h] DCOBJ::DCOBJ((DCOBJ *)\u0026amp;v25, a1); // åˆ©ç”¨æ„é€ å‡½æ•°ä»HDCåˆ›å»ºDCOBJå¯¹è±¡ v8 = v25; Â·Â·Â·Â·Â·Â·Â·Â·Â·Â· v10 = *(_QWORD *)(v8 + 48);\t// èµ‹å€¼ *(_QWORD *)(v10 + 1736) = 0i64; v24 = v11; Â·Â·Â·Â·Â·Â·Â· v9 = *(_QWORD *)(v25 + 512) != 0i64; v12 = *(_DWORD *)(v25 + 120) \u0026gt; 0; Â·Â·Â·Â·Â·Â·Â· v13 = (HDC)hdcOpenDCW(\u0026amp;qword_1C0141EB0, v26, 0i64, 0i64, *(_QWORD *)(v10 + 2584));// åˆ›å»ºæ–°çš„DCå¯¹è±¡ï¼Œè¿”å›å¯¹åº”çš„HDCå¥æŸ„ if ( v13 ) { *(_QWORD *)(v10 + 2584) = 0i64; DCOBJ::DCOBJ((DCOBJ *)\u0026amp;v24, v13); v14 = (_QWORD *)v24; if ( v24 ) { if ( v12 ) *(_DWORD *)(v24 + 120) = *(_DWORD *)(v24 + 116); v14[308] = *(_QWORD *)(v25 + 2464); *(_QWORD *)(v25 + 2464) = 0i64; v14[309] = *(_QWORD *)(v25 + 2472); *(_QWORD *)(v25 + 2472) = 0i64; v15 = *(void (__fastcall **)(_QWORD, _QWORD))(v10 + 2768); if ( v15 ) v15(*(_QWORD *)(v10 + 1824), *(_QWORD *)(v14[6] + 1824i64));// è°ƒç”¨å‡½æ•°æŒ‡é’ˆæŒ‡å‘çš„å‡½æ•°ï¼Œä¼ å…¥å‚æ•°ä¸ºç”¨æˆ·ä¼ å…¥çš„HDCå¯¹åº”çš„DCå¯¹è±¡å†…çš„å€¼ Â·Â·Â·Â·Â·Â·Â· HmgSwapLockedHandleContents(v3, 0i64, v6, 0i64, v23);// äº¤æ¢æ—§çš„å’Œæ–°çš„HDCå¯¹è±¡ GreReleaseHmgrSemaphore(); Â·Â·Â·Â·Â·Â· bDeleteDCInternal(v6, 1i64, 0i64); // åˆ é™¤äº†hdcOpenDCWåˆ†é…çš„HDCï¼Œä½†å‰é¢ç»è¿‡HmgSwapLockedHandleContentsäº¤æ¢äº†å¥æŸ„ï¼Œå®é™…åˆ é™¤çš„æ˜¯æ—§çš„HDC Â·Â·Â·Â·Â·Â· åœ¨è¡¥ä¸ä¸­ï¼Œå¢åŠ äº†å¯¹DCå¯¹è±¡å¼•ç”¨æ¬¡æ•°è¿›è¡Œåˆ¤æ–­çš„é€»è¾‘ï¼Œå¦‚æœåœ¨GreResetDCInternalå‡½æ•°ä¸­DCå¯¹è±¡å¼•ç”¨æ¬¡æ•°å¤§äº1åˆ™è¡¨æ˜å·²ç»å‘ç”Ÿå¼‚å¸¸ï¼Œè¿›å…¥å¼‚å¸¸é€»è¾‘æŠ›å‡ºé”™è¯¯(å› ä¸ºæŒ‰æ­£å¸¸æµç¨‹æ­¤å¤„DCå¯¹è±¡å¼•ç”¨æ¬¡æ•°åº”ä¸ºä¸åº”è¯¥å¤§äº1)ã€‚\n__int64 __fastcall sub_1C014CB0C(__int64 a1, __int64 a2, int *a3) { ...... int *v30; // [rsp+30h] [rbp-1h] ..... v9 = (__int64)v30; if ( !v30 ) { LABEL_6: EngSetLastError(6i64); LABEL_7: v13 = (__int64)v30; goto LABEL_8; } if ( *((_WORD *)v30 + 6) \u0026gt; 1u ) { if ( *(_DWORD *)\u0026amp;stru_1C032C3F8.Length \u0026gt; 5u \u0026amp;\u0026amp; (unsigned __int8)sub_1C00B5068(\u0026amp;stru_1C032C3F8, 0x400000000000i64) ) { v31 = \u0026amp;v25; v30 = \u0026amp;v26; v29 = \u0026amp;v28; v28 = 0x1000000i64; SysEntryGetDispatchTableValues(v10, (__int64)\u0026amp;unk_1C02F466B, v11, v12); } goto LABEL_6; } å‚è€ƒé“¾æ¥ï¼š\nhttps://www.secrss.com/articles/35266\nhttps://mp.weixin.qq.com/s/AcFS0Yn9SDuYxFnzbBqhkQ\nhttps://bbs.pediy.com/thread-269930.htm\n"},{"uri":"https://www.ch35tnut.site/en/tags/","title":"Tags","tags":[],"description":"","content":""},{"uri":"https://www.ch35tnut.site/en/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/","title":"æ¼æ´åˆ†æ","tags":[],"description":"","content":""},{"uri":"https://www.ch35tnut.site/en/categories/","title":"Categories","tags":[],"description":"","content":""}]